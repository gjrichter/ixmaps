mapSelection=null;Map.Selections=function(){};Map.Selections.prototype=new Map;"string"==typeof thisversion&&map.checkVersion(thisversion)?map.Selections=new Map.Selections:alert("Map.Themes incompatible !");
Map.Selections.prototype.newSelection=function(a,b,g,d){if(null==b)return displayMessage("empty selection",1E3),null;var f=null;null==g&&(g="type:circle");if(f=(f=g.split("style="))&&1<f.length?__getStyleObj(f[1]):__getStyleObj(g)){"activeLayer"==a&&(a=getActiveTheme(),null==a&&map.Themes.activeTheme&&(a=map.Themes.activeTheme.szThemes));if(null==a)return displayMessage("please activate a layer",1E3),null;mapSelection=new MapSelection(a,b,"SELECTION|"+f.type,d);f.buffersize&&(mapSelection.nBufferSize=
f.buffersize)}mapSelection.parent=map.Themes;map.Themes.addTheme(mapSelection);mapSelection.fRealize=!0;executeWithMessage("map.Themes.execute()","please wait ...");return mapSelection};
function MapSelection(a,b,g,d){this.nSelected=this.nCount=0;this.szThemes=a;this.szThemesA=a.split("|");this.szSelectShape=b;this.highLightList=new HighLight;this.szTitle=d?d:"["+b+"] - "+a;this.szTitle=map.Dictionary.getLocalText(this.szTitle);this.szOrigFlag=this.szFlag=g?g:"";this.nRefreshTimeout=0;this.szId="theme"+String(Math.random());this.szShapeType="polygon"}
MapSelection.prototype.initValues=function(){this.nSelectedArea=this.nSelected=this.nThemeItems=this.nTested=this.nCount=this.nNodes=0;map.Themes.activeTheme.szFlag.match(/CHART/)&&!map.Themes.activeTheme.szFlag.match(/MULTIPLE/)&&(this.szThemes="generic");this.themeNodesA=[];if("generic"==this.szThemes){var a=map.Themes.activeTheme;this.themeRootNodesA=a.filterNodesA&&a.filterNodesA!=this.szSelectShape?myclone(a.filterNodesA):myclone(a.indexA);this.nCount=this.nNodes=this.nThemeItems=this.themeRootNodesA.length}else{this.themeRootNodesA=
[];for(a=0;a<this.szThemesA.length;a++){var b=map.Layer.getLayerObj(this.szThemesA[a]);if(b&&b.szSelection&&0!=b.szSelection.length){this.szThemeType=b.szType;this.nThemeItems+=b.nItems;var g=[];b.szFlag.match(/tiled/)?g=map.Tiles.getTileNodes(this.szThemesA[a]):g[0]=SVGDocument.getElementById(this.szThemesA[a]);if(b.nRenderer&1&&b.szRenderer&&b.szRenderer.length)for(k=0;k<g.length;k++)for(b=g[k].childNodes,r=0;r<b.length;r++)1==b.item(r).nodeType&&b.item(r).hasChildNodes()&&(this.themeRootNodesA[this.themeRootNodesA.length]=
b.item(r));else for(k=0;k<g.length;k++)this.themeRootNodesA[this.themeRootNodesA.length]=g[k]}}if(0==this.themeRootNodesA.length)return!1;for(a=0;a<this.themeRootNodesA.length;a++)this.nNodes+=this.themeRootNodesA[a].childNodes.length;this.nCount=this.nNodes}if("queryresult"==this.szSelectShape)return!0;if("object"==typeof this.szSelectShape){this.queryResultA=this.szSelectShape;if("generic"==this.szThemes)for(a=0;a<this.szSelectShape.length;a++)this.themeRootNodesA[a]=this.szSelectShape[a];else for(a=
0;a<this.szSelectShape.length;a++)this.themeRootNodesA[a]=this.szSelectShape[a].node.parentNode;this.nNodes=this.themeRootNodesA.length=this.szSelectShape.length;this.szSelectShape="queryresult";this.szSelectQuery=this.szTitle;this.markGroup||(this.markGroup=map.Dom.newGroup(map.Layer.objectGroup,this.szId+":markgroup"));return!0}if("activeBuffer"==this.szSelectShape){g=map.Themes.activeBuffer;if(null!=g){for(var b=[],a=g.chartGroup,d=a.getElementsByTagName("path"),f=a.getElementsByTagName("circle"),
a=0;a<d.length;a++)b[b.length]=d.item(a);for(a=0;a<f.length;a++)b[b.length]=f.item(a);this.selectCenterA=[];for(a=0;a<b.length;a++)this.selectCenterA[this.selectCenterA.length]=map.Scale.getMapOffset(b[a]);this.selectBufferSize=g.nBufferSize/map.Scale.mapUnitsPPX;this.selectScale=g.nScale;this.markGroup||(this.markGroup=map.Dom.newGroup(map.Layer.objectGroup,this.szId+":markgroup"));return!0}alert("error: no active theme/buffer to select with");return!1}this.selectCenterA=[];b=SVGDocument.getElementById(this.szSelectShape);
if(!b)return!1;b.fu=new Methods(b);if(this.szFlag.match(/circle/)){a=b.fu.getPosition();a.x=Number(b.getAttributeNS(null,"cx"));a.y=Number(b.getAttributeNS(null,"cy"));this.selectionCenter=new point(a.x,a.y);this.selectCenterA[this.selectCenterA.length]=map.Scale.getMapPosition(a.x,a.y);map.Scale.getMapPosition(a.x,a.y);this.selectBufferSize=b.getAttributeNS(null,"r");if(0==this.selectBufferSize)return!1;a=antiZoomAndPanList.getActualMatrix();this.selectBufferSize*=a[0]}else if(this.szFlag.match(/square/)){a=
b.fu.getPosition();a.x=Number(b.getAttributeNS(null,"x"));a.y=Number(b.getAttributeNS(null,"y"));g=Number(b.getAttributeNS(null,"width"));b=Number(b.getAttributeNS(null,"height"));this.selectionCenter=new point(a.x+g/2,a.y+b/2);this.selectCenterA[this.selectCenterA.length]=map.Scale.getMapPosition(a.x+g/2,a.y+b/2);map.Scale.getMapPosition(a.x+g/2,a.y+b/2);this.selectBufferSizeX=g/2;this.selectBufferSizeY=b/2;if(0==this.selectBufferSizeX||0==this.selectBufferSizeY)return!1;a=antiZoomAndPanList.getActualMatrix();
this.selectBufferSizeX*=a[0];this.selectBufferSizeY*=a[0]}this.selectScale=map.Scale.nZoomScale;this.markGroup||(this.markGroup=map.Dom.newGroup(map.Layer.objectGroup,this.szId+":markgroup"));return!0};function __inRange(a,b,g,d){if(a&&b&&g){var f=b.x-a.x;a=b.y-a.y;return d?Math.abs(f)<=g&&Math.abs(a)<=d:Math.sqrt(f*f+a*a)<=g}return!1}
MapSelection.prototype.realize=function(){this.fShowProgressBar=!0;this.initValues()?(this.nSkipCount=this.nDoneCount=0,activeSelection=this,this.mapSleep=new Map.Sleep("activeSelection.selectShapes",100,map.Dictionary.getLocalText("do selection")),this.mapSleep.fShowProgressBar=!0,this.mapSleep.nCount=this.nCount,this.mapSleep.szCancel="activeSelection.cancel()",this.selectShapes()):(this.remove(),displayMessage("Selection could not be done",3E3))};MapSelection.prototype.realizeContinue=function(a){this.selectShapes(a)};
MapSelection.prototype.realizeDone=function(){this.nRefreshTimeout&&setTimeout("map.Themes.refreshTheme('"+this.szId+"')",this.nRefreshTimeout)};MapSelection.prototype.redraw=function(){};MapSelection.prototype.disable=function(){};MapSelection.prototype.cancel=function(){this.fCancel=!0};activeSelection=null;
MapSelection.prototype.nextThemeNode=function(a){if("generic"==this.szThemes||"queryresult"==this.szSelectShape)return this.themeRootNodesA[a];if(0==a)return this.nRootIndex=0,this.actNode=this.themeRootNodesA[this.nRootIndex].firstChild;if(!this.actNode)return null;this.actNode=this.actNode.nextSibling;if(!this.actNode){if(++this.nRootIndex>=this.themeRootNodesA.length)return null;this.actNode=this.themeRootNodesA[this.nRootIndex].firstChild}return this.actNode};
function myclone(a){if(a){var b=a instanceof Array?[]:{};for(i in a)"clone"!=i&&(b[i]=a[i]&&"object"==typeof a[i]?myclone(a[i]):a[i]);return b}return null}
MapSelection.prototype.selectShapes=function(a){if(!a||0==a)if(a=0,this.testA=[],this.itemA=[],this.chartPosA=[],this.exactCountA=[],this.exactSizeA=[],map.Themes.activeTheme&&this.szThemesA[0]+" == "+map.Themes.activeTheme.szThemesA[0]){this.activeTheme=map.Themes.activeTheme;this.nPartsA=myclone(this.activeTheme.nPartsA);this.partsA=myclone(this.activeTheme.partsA);this.origColorScheme=myclone(this.activeTheme.origColorScheme);this.colorScheme=myclone(this.activeTheme.colorScheme);this.szFieldsA=
myclone(this.activeTheme.szFieldsA);this.szLabelA=myclone(this.activeTheme.szLabelA);this.szLegendLabelA=myclone(this.activeTheme.szLegendLabelA);this.szXaxisA=myclone(this.activeTheme.szXaxisA);this.szSymbolsA=myclone(this.activeTheme.szSymbolsA);this.szRanges=this.activeTheme.szRanges;this.szSizeField=this.activeTheme.szSizeField;this.nMeanA=myclone(this.activeTheme.nMeanA);this.nMedianA=myclone(this.activeTheme.nMedianA);this.nDeviationA=myclone(this.activeTheme.nDeviationA);this.nFilterA=myclone(this.activeTheme.nFilterA);
this.nOrigSumA=myclone(this.activeTheme.nOrigSumA);this.szUnit=this.activeTheme.szUnit;this.formatValue=this.activeTheme.formatValue;this.nMin100=this.activeTheme.nMin100;this.nMax100=this.activeTheme.nMax100;this.nClipFrames=this.activeTheme.nClipFrames;this.nActualFrame=this.activeTheme.nActualFrame;this.sortIndexDown=this.activeTheme.sortIndexDown;this.sortIndexUp=this.activeTheme.sortIndexUp;this.shuffleArray=this.activeTheme.shuffleArray;this.removeDefinition=this.activeTheme.removeDefinition;
this.szValuesTextStyle=this.activeTheme.szValuesTextStyle;this.nOrigValuesSumA=[];this.nValuesSumA=[];this.nValuesMinA=[];this.nValuesMaxA=[];this.nExactCount=this.nCount=this.nSum=this.nSum100=0;this.nMin=1E11;this.nMax=0;this.nMinSize=3E8;for(var b=this.nSumSize=this.nMaxSize=0;b<map.Themes.activeTheme.szFieldsA.length;b++)this.nOrigValuesSumA[b]=0,this.nValuesSumA[b]=0,this.nValuesMinA[b]=1E11,this.nValuesMaxA[b]=0;for(var g=0;g<this.partsA.length;g++)this.partsA[g].nCount=0,this.partsA[g].nSum=
0,this.exactSizeA[g]=0}if(this.nNodes){var d,f=null,e=null,h=this.selectBufferSize*this.selectScale,l=null;this.selectBufferSizeX&&(h=this.selectBufferSizeX*this.selectScale,l=this.selectBufferSizeY*this.selectScale);for(g=a;g<this.nNodes;g++){this.mapSleep.nDoneCount=this.nDoneCount;if(this.mapSleep.checkSleep(g,10))return;if("generic"==this.szThemes)if(b=this.nextThemeNode(g),this.nDoneCount++,a=!1,"queryresult"==this.szSelectShape)a=!0;else for(d=0;d<this.selectCenterA.length;d++){if(__inRange(this.activeTheme.getNodePosition(b),
this.selectCenterA[d],h,l)){a=!0;break}}else{f=this.nextThemeNode(g);this.nDoneCount++;if(!f||1!=f.nodeType)continue;if(f.getAttributeNS(null,"id").match(/:paint/))continue;b=map.Tiles.getMasterId(f.getAttributeNS(null,"id"));this.testA&&!this.testA[b]&&(this.testA[b]=f,this.nTested++);a=!1;if("queryresult"==this.szSelectShape)for(this.selectionCenter||(this.selectionCenter=new point(0,0)),d=0;d<this.queryResultA.length;d++){if(this.queryResultA[d].node.parentNode==f){a=!0;(d=f.getAttributeNS(szMapNs,
"center"))&&2<d.length&&(e=d.split(","),e=new point(Number(e[0].split(":")[1]),Number(e[1].split(":")[1])));e||(e=map.Dom.getBox(f),e=new point(e.x,e.y));d=map.Scale.mapCanvasCenter;var c=map.Scale.getMapOffset(f);e.x+=d.x;e.y+=d.y;this.selectionCenter.x+=e.x/this.queryResultA.length;this.selectionCenter.y+=e.y/this.queryResultA.length;break}}else if((d=f.getAttributeNS(szMapNs,"center"))&&2<d.length&&(e=d.split(","),e=new point(Number(e[0].split(":")[1]),Number(e[1].split(":")[1]))),e||(e=map.Dom.getBox(f),
e=new point(e.x,e.y)),e)for(c=map.Scale.getMapOffset(f),e.x+=c.x,e.y+=c.y,map.Scale.rotatePoint(e,-1),d=0;d<this.selectCenterA.length;d++)if(__inRange(e,this.selectCenterA[d],h,l)){a=!0;break}}if(a){if("generic"==this.szThemes)this.itemA[b]=null,this.nSelected++;else{"point"==this.szThemeType&&(this.markGroup?map.Dom.newShape("circle",this.markGroup,e.x,e.y,map.Scale.normalX(1)*map.Scale.nZoomScale,"fill:yellow;stroke:none;"):f&&f.style.setProperty("opacity","0.0"));a=f.getAttributeNS(szMapNs,"area");
if(this.itemA&&this.itemA[b])continue;this.itemA[b]=f;this.nSelected++;this.nSelectedArea+=Number(a)}if(map.Themes.activeTheme)for(a=[],map.Themes.activeTheme.itemA[b]?a.push(map.Themes.activeTheme.itemA[b]):map.Themes.activeTheme.posItemA[b]&&(a=map.Themes.activeTheme.posItemA[b]),d=0;d<a.length;d++)if(c=a[d],1!=c.nValuesA.length||!(isNaN(c.nValuesA[0])||0==c.nValuesA[0]&!map.Themes.activeTheme.szFlag.match(/ZEROISVALUE/))){this.nCount++;for(b=0;b<c.nValuesA.length;b++)isNaN(c.nValuesA[b])||(this.nOrigValuesSumA[b]+=
c.nOrigValuesA[b],this.nValuesSumA[b]+=c.nValuesA[b],this.nValuesMinA[b]=Math.min(this.nValuesMinA[b],c.nValuesA[b]),this.nValuesMaxA[b]=Math.max(this.nValuesMaxA[b],c.nValuesA[b]),this.nMin=Math.min(this.nMin,c.nValuesA[b]),this.nMax=Math.max(this.nMax,c.nValuesA[b]),this.nMinSize=Math.min(this.nMinSize,c.nSize||this.nMinSize),this.nMaxSize=Math.max(this.nMaxSize,c.nSize||this.nMaxSize),this.nSumSize+=c.nSize);c.nValue100&&(this.nSum100+=c.nValue100);if(map.Themes.activeTheme.szFlag.match(/EXACT/))for(v=
0;v<c.nValuesA.length;v++)for(p=0;p<this.partsA.length;p++){if(c.nValuesA[v]==this.partsA[p].min){this.partsA[p].nCount++;this.partsA[p].nSum+=c.nValuesA[v];this.nSum+=c.nValuesA[v];this.nExactCount++;this.exactSizeA[p]+=c.nSize||1;break}}else if(map.Themes.activeTheme.szFlag.match(/SEQUENCE/)||map.Themes.activeTheme.szFlag.match(/CHART/))for(p=0;p<this.partsA.length;p++)this.partsA[p].nCount++,this.partsA[p].nSum+=c.nValuesA[p],this.nSum+=c.nValuesA[p];else if(this.activeTheme.szFlag.match(/CLIP/)&&
this.activeTheme.nClipFrames)this.nSum=this.nClipFrames==c.nValuesA.length?this.nSum+Number(c.nValuesA[this.nActualFrame]):this.nSum+Number(c.nValuesA[0]*(this.nClipFrames-this.nActualFrame)/this.nClipFrames+c.nValuesA[c.nValuesA.length-1]*this.nActualFrame/this.nClipFrames);else for(v=0;v<c.nValuesA.length;v++)for(p=0;p<this.partsA.length;p++)if(c.nValuesA[v]<this.partsA[p].max){this.partsA[p].nCount++;this.partsA[p].nSum+=c.nValuesA[v];this.nSum+=c.nValuesA[v];break}}}if(this.fCancel){this.fShowProgressBar=
!1;this.showInfo(!1);clearMessage();return}}}0==this.nThemeItems&&(this.nThemeItems=this.nTested);if("generic"!=this.szThemes&&"point"!=this.szThemeType)for(var m in this.itemA)if((g=map.Tiles.getTileNodes(m))&&g.length)for(var n in g)this.highLightList.addItem(g[n]),this.highLightList.lock();else this.highLightList.addItem(this.itemA[m]),this.highLightList.lock();this.isVisible=!0;this.realizeDone();this.fShowProgressBar=!1;clearMessage();this.showInfo(!0)};
MapSelection.prototype.showInfo=function(a){if(0==this.nCount)displayMessage("Selection: no values found !",1E3),this.remove();else if(0==this.nSelected)displayMessage("Selection is empty !",1E3),this.remove();else if(!this.widgetNode||this.fRedrawInfo){this.fRedrawInfo=!1;var b=this.szId+":display:widget",g=map.Dictionary.getLocalText("Selection");"undefined"==typeof a||a||(g+=" ("+map.Dictionary.getLocalText("incomplete")+"!)");this.selectionCenter||(this.selectionCenter=map.Scale.mapCanvasCenter);
this.widgetNode?(a=this.widgetNode,a.clear()):a=new InfoContainer(SVGDocument,SVGFixedGroup,b+":movable",this.selectionCenter,new point(-map.Scale.normalX(55),map.Scale.normalY(50)),"fixed|pointer",g);a.frameNode.style.setProperty("fill","#e8e8e8","");g=szTextGridStyle;szTextGridStyle="firstgray";this.widgetNode=a;a.fClipped=!1;var d=a.workspaceNode;a.setOnRemove("map.Themes.removeTheme(evt,'"+this.szId+"')");var f=this.szSelectShape,e=0;if("activeBuffer"==this.szSelectShape){var f=map.Themes.activeBuffer.szTitle,
h=[map.Dictionary.getLocalText("layer"),map.Dictionary.getLocalText("selected by"),map.Dictionary.getLocalText("selected items"),1==this.szThemesA.length?String(map.Layer.listA[this.szThemesA[0]].szLegendName):"(multiple)",String(f),String(this.nSelected)+" / "+String(this.nThemeItems)+"  ("+String(__formatValue(100/this.nThemeItems*this.nSelected,2))+"%)"],l=Array(3);l[0]="font-weight:bold;fill:#ffffff;";l[1]="font-weight:bold;fill:#ffffff;";l[2]="font-weight:bold;fill:#ffffff;";e+=50}else"queryresult"==
this.szSelectShape?(f=this.szThemes,1<this.szThemesA.length?f="(multiple)":"generic"!=this.szThemes&&(f=String(map.Layer.listA[this.szThemesA[0]].szLegendName)),h=[map.Dictionary.getLocalText("layer"),map.Dictionary.getLocalText("selected by"),map.Dictionary.getLocalText("selected items"),f,this.szSelectQuery,String(this.nSelected)+" / "+String(this.nThemeItems)+"  ("+String(__formatValue(100/this.nThemeItems*this.nSelected,2))+"%)"],l=Array(3),l[0]="font-weight:bold;fill:#ffffff;",l[1]="font-weight:bold;fill:#ffffff;",
l[2]="font-weight:bold;fill:#ffffff;",e+=50):(h="generic"==this.szThemes?[map.Dictionary.getLocalText("layer"),map.Dictionary.getLocalText("selected items"),"(generic)",String(this.nSelected)+" / "+String(this.nThemeItems)+"  ("+String(__formatValue(100/this.nThemeItems*this.nSelected,2))+"%)"]:[map.Dictionary.getLocalText("layer"),map.Dictionary.getLocalText("selected items"),1==this.szThemesA.length?String(map.Layer.listA[this.szThemesA[0]].szLegendName):"(multiple)",String(this.nSelected)+" / "+
String(this.nThemeItems)+"  ("+String(__formatValue(100/this.nThemeItems*this.nSelected,2))+"%)"],l=Array(2),l[0]="font-weight:bold;fill:#ffffff;",l[1]="font-weight:bold;fill:#ffffff;",e+=40);var c=map.Dom.newGroup(d,"");c.fu.setPosition(map.Scale.normalY(3),map.Scale.normalY(3));createTextGrid(SVGDocument,c,b+":textgrid",h,2,11,l,"fill:#bbbbbb;");f=[];if(this.activeTheme){h=c=null;e+=14;map.Dom.newText(d,map.Scale.normalX(3),map.Scale.normalY(e),"font-family:arial;font-weight:bold;font-size:"+map.Scale.normalY(11)+
"px;fill:#555555;pointer-events:none",map.Dictionary.getLocalText("Theme")+": "+this.activeTheme.szTitle);e+=8;c=map.Dom.newGroup(d,"");c.fu.setPosition(map.Scale.normalY(3),map.Scale.normalY(e));this.drawDonutText=this.activeTheme.drawDonutText;this.drawTextforOneQuadrant=this.activeTheme.drawTextforOneQuadrant;this.createTextLabel=this.activeTheme.createTextLabel;if(1==this.nValuesSumA.length){this.addItemValues=this.activeTheme.addItemValues;this.szFieldsA=this.activeTheme.szFieldsA;this.fField100=
this.activeTheme.fField100;var m=this.szFlag;this.szFlag=this.activeTheme.szFlag;this.itemA=[];h=[];for(x=0;x<this.nOrigValuesSumA.length;x++)h[x]=this.nOrigValuesSumA[x];this.addItemValues("selection",h,this.nSum100);this.szFlag=m;if(this.activeTheme.szFlag.match(/EXACT/))h=[map.Dictionary.getLocalText("selected items"),String(__formatValue(Number(this.nCount,2)))],l=Array(2),l[0]="font-weight:bold;fill:#7996D7;",l[1]="font-weight:bold;fill:#000000;font-size:240px;",createTextGrid(SVGDocument,c,
b+":textgrid",h,2,11,l),e+=c.fu.getBox().height/map.Scale.normalX(1)+5;else if(this.activeTheme.szAggregation&&this.activeTheme.szAggregation.match(/sum/)||this.activeTheme.szFlag.match(/SUM/)){if(h=[map.Dictionary.getLocalText("value of selection"),map.Dictionary.getLocalText("% of total value")," ",map.Dictionary.getLocalText("min"),map.Dictionary.getLocalText("max"),map.Dictionary.getLocalText("average"),String(__formatValue(Number(this.itemA.selection.nValuesA[0]),2))+" "+this.szUnit,String(__formatValue(Number(this.nValuesSumA[0])/
Number(this.activeTheme.nOrigSumA[0])*100,2))+" %"," ",String(__formatValue(Number(this.nValuesMinA[0]),2))+" "+this.szUnit,String(__formatValue(Number(this.nValuesMaxA[0]),2))+" "+this.szUnit,String(__formatValue(Number(this.nValuesSumA[0])/this.nCount,2))+" "+this.szUnit],l=Array(12),l[0]="font-weight:bold;fill:#7996D7;",l[6]="font-weight:bold;fill:#000000;font-size:240px;",createTextGrid(SVGDocument,c,b+":textgrid",h,2,11,l),e+=c.fu.getBox().height/map.Scale.normalX(1)+5,c=map.Dom.newGroup(d,""),
f.push(c),b=DonutCharts.newChart(SVGDocument,c,map.Scale.normalX(55),map.Scale.normalY(55),0,0),b.setStyle("3D"),b.setRadInner(0),b.setRadOuter(map.Scale.normalX(55)),b.setCenter(map.Scale.normalX(80),map.Scale.normalY(100)),h=Number(this.nValuesSumA[0])/Number(this.activeTheme.nOrigSumA[0])*100,b.addPart(h,map.Scale.normalY(20),"#ddddee",0,this.formatValue(h,2)+"%","selection: "+this.formatValue(h,2)+"% of total value"),b.addPart(100-h,map.Scale.normalY(20),"#f8f8ff",0,this.formatValue(100-h,2)+
"%",this.formatValue(100-h,2)+"%"),b.realize(),map.Dom.newText(c,map.Scale.normalX(80),map.Scale.normalX(82),"font-size:"+map.Scale.normalX(10)/.66+"px;text-anchor:middle;baseline-shift:-60%;fill:darkgrey;stroke:none;pointer-events:none",this.formatValue(h,0)+" % of total"),this.activeTheme.szFlag.match(/BUBBLE/)||this.activeTheme.szFlag.match(/SQUARE/)||this.activeTheme.szFlag.match(/SYMBOL/))this.getOverviewChart=this.activeTheme.getOverviewChart,this.szOverviewChart=this.activeTheme.szOverviewChart,
this.drawChart=this.activeTheme.drawChart,this.getOverviewChart&&(posGroup=map.Dom.newGroup(d,""),c=map.Dom.newGroup(posGroup,""),f.push(posGroup),b=this.szFlag,this.szFlag=this.activeTheme.szFlag,this.nOrigSumA=this.nOrigValuesSumA,this.nMaxA=this.nValuesMaxA,this.nMinA=this.nValuesMinA,this.szAggregation=this.activeTheme.szAggregation,this.getOverviewChart(c),this.szFlag=b,c.fu.scale(1.3,1.3),c.fu.setPosition(map.Scale.normalX(-35),map.Scale.normalY(35)))}else this.fField100?(h=[map.Dictionary.getLocalText("value of selection"),
" ",map.Dictionary.getLocalText("min value"),map.Dictionary.getLocalText("max value"),map.Dictionary.getLocalText("mean value"),String(__formatValue(Number(this.itemA.selection.nValuesA[0]),2))+this.szUnit," ",String(__formatValue(Number(this.nValuesMinA[0]),2))+this.szUnit,String(__formatValue(Number(this.nValuesMaxA[0]),2))+this.szUnit,String(__formatValue(Number(this.nValuesSumA[0])/this.nCount,2))+this.szUnit],l=Array(10),l[0]="font-weight:bold;fill:#7996D7;",l[5]="font-weight:bold;fill:#000000;font-size:240px;"):
this.activeTheme.szFlag.match(/DENSITY/)?(h=[map.Dictionary.getLocalText("value of selection")," ",map.Dictionary.getLocalText("min value"),map.Dictionary.getLocalText("max value"),map.Dictionary.getLocalText("mean value"),String(__formatValue(Number(this.itemA.selection.nValuesA[0]),2))+this.szUnit," ",String(__formatValue(Number(this.nValuesMinA[0]),2))+this.szUnit,String(__formatValue(Number(this.nValuesMaxA[0]),2))+this.szUnit,String(__formatValue(Number(this.nValuesSumA[0])/this.nCount,2))+this.szUnit],
l=Array(10),l[0]="font-weight:bold;fill:#7996D7;",l[5]="font-weight:bold;fill:#000000;font-size:240px;"):(h=[map.Dictionary.getLocalText("mean value"),map.Dictionary.getLocalText(" "),map.Dictionary.getLocalText("min value"),map.Dictionary.getLocalText("max value"),String(__formatValue(Number(this.nValuesSumA[0])/this.nCount,2))+this.szUnit,map.Dictionary.getLocalText(" "),String(__formatValue(Number(this.nValuesMinA[0]),2))+this.szUnit,String(__formatValue(Number(this.nValuesMaxA[0]),2))+this.szUnit],
l=Array(8),l[0]="font-weight:bold;fill:#7996D7;",l[4]="font-weight:bold;fill:#000000;font-size:240px;"),createTextGrid(SVGDocument,c,b+":textgrid",h,2,11,l),e+=c.fu.getBox().height/map.Scale.normalX(1)+5;this.getOverviewChart=this.activeTheme.getOverviewChart;this.szOverviewChart=this.activeTheme.szOverviewChart;if(2<this.activeTheme.colorScheme.length||this.activeTheme.szFlag.match(/EXACT/)||!this.activeTheme.szFlag.match(/CHART/)&&!this.activeTheme.szFlag.match(/DOMINANT/))this.szOverviewChart=
5<this.nOrigSumA.length?"BAR":"PIE|3D";this.szOverviewChart&&(c=map.Dom.newGroup(d,""),f.push(c),this.getOverviewChart(c),this.szOverviewChart.match(/PIE/)&&this.activeTheme.szAggregation.match(/sum/)&&(this.szOverviewChart+="|PERCENTOFVALUE",c=map.Dom.newGroup(d,""),f.push(c),this.getOverviewChart(c)));!this.activeTheme.szFlag.match(/CHART/)||this.activeTheme.szAggregation&&this.activeTheme.szAggregation.match(/sum/)||(this.getOverviewChart=this.activeTheme.getOverviewChart,this.szOverviewChart=
null,this.drawChart=this.activeTheme.drawChart,this.getOverviewChart&&(posGroup=map.Dom.newGroup(d,""),c=map.Dom.newGroup(posGroup,""),f.push(posGroup),b=this.szFlag,this.szFlag=this.activeTheme.szFlag,this.nOrigSumA=this.nOrigValuesSumA,this.nMaxA=this.nValuesMaxA,this.nMinA=this.nValuesMinA,this.nOverrideMax=this.activeTheme.nMax,this.szAggregation=this.activeTheme.szAggregation,this.getOverviewChart(c),this.szFlag=b,this.activeTheme.szFlag.match(/BAR/)?(c.fu.scale(2.5,2.5),c.fu.setPosition(map.Scale.normalX(55),
map.Scale.normalY(65))):(c.fu.scale(1.3,1.3),c.fu.setPosition(map.Scale.normalX(-35),map.Scale.normalY(35))),b=this.szFlag,this.szFlag=this.activeTheme.szFlag,this.szOverviewChart+="|PERCENTOFVALUE|3D",c=map.Dom.newGroup(d,""),f.push(c),this.getOverviewChart(c),this.szFlag=b))}else{if(this.activeTheme.szAggregation.match(/sum/)||this.activeTheme.szFlag.match(/SUM/))m=this.nSum100?this.nSum100:this.activeTheme.szFlag.match(/EXACT/)?this.nExactCount:this.nSum,h=this.activeTheme.nSum100?this.activeTheme.nSum100:
this.activeTheme.szFlag.match(/EXACT/)?this.activeTheme.nExactCount:this.activeTheme.nSum,h=[map.Dictionary.getLocalText("total of selection"),String(__formatValue(m,2))+" ("+String(__formatValue(Number(m)/Number(h)*100,2))+" %)"],l=Array(2),l[0]="font-weight:bold;fill:#7996D7;",l[1]="font-weight:bold;fill:#000000;font-size:240px;",createTextGrid(SVGDocument,c,b+":textgrid",h,2,11,l),e+=c.fu.getBox().height/map.Scale.normalX(1)+5;this.nSum100&&(m=this.nSum100,this.activeTheme.szFlag.match(/DOMINANT/)||
this.activeTheme.szAggregation.match(/sum/)||(m/=this.nSelected),h=this.activeTheme.nSum100,h=[map.Dictionary.getLocalText("total of selection"),String(__formatValue(m,2))+" ("+String(__formatValue(Number(m)/Number(h)*100,2))+" %)"],l=Array(2),l[0]="font-weight:bold;fill:#7996D7;",l[1]="font-weight:bold;fill:#000000;font-size:240px;",createTextGrid(SVGDocument,c,b+":textgrid",h,2,11,l),e+=c.fu.getBox().height/map.Scale.normalX(1)+5);this.drawChart=this.activeTheme.drawChart;this.getOverviewChart=
this.activeTheme.getOverviewChart;this.szOverviewChart=this.activeTheme.szOverviewChart;if(this.activeTheme.szFlag.match(/EXACT/)||!this.activeTheme.szFlag.match(/CHART/)&&!this.activeTheme.szFlag.match(/DOMINANT/))this.szOverviewChart="PIE|3D";this.nOrigSumA=this.nOrigValuesSumA;this.nMaxA=this.nValuesMaxA;this.nMinA=this.nValuesMinA;m=this.szFlag;this.szFlag=this.activeTheme.szFlag;this.szAggregation=this.activeTheme.szAggregation;this.szOverviewChart?(c=map.Dom.newGroup(d,""),f.push(c),this.getOverviewChart(c),
this.szOverviewChart.match(/PIE/)&&this.activeTheme.szAggregation.match(/sum/)&&(this.szOverviewChart+="|PERCENTOFVALUE",c=map.Dom.newGroup(d,""),f.push(c),this.getOverviewChart(c))):(c=map.Dom.newGroup(d,""),this.nMin=this.activeTheme.nMin,this.nMax=this.activeTheme.nMax,d=1.8,this.szFlag.match(/DOMINANT/)&&(d=1.8),this.drawColorSchemeLegend=this.activeTheme.drawColorSchemeLegend,this.nOrigSumA=this.activeTheme.nOrigSumA,this.nSum=this.activeTheme.nSum,this.szField100=this.activeTheme.szField100,
this.drawColorSchemeLegend(c,"test").fu.scale(.9/d,.9/d),h=map.Dom.getBox(c),0<h.width&&0<h.height&&(c.fu.scale(d,d),c.fu.setPosition(map.Scale.normalX(10)-h.x*d,map.Scale.normalY(e)+map.Scale.normalY(5)-h.y*d),map.Dom.newText(c,h.x,h.y+h.height+map.Scale.normalX(6),"font-family:Arial;font-style:italic;font-size:"+map.Scale.normalY(6)+"px;fill:#888888;pointer-events:none",this.activeTheme.fField100||this.activeTheme.szAggregation.match(/sum/)?map.Dictionary.getLocalText("* summary over selected area"):
map.Dictionary.getLocalText("* arithmetic mean over selected area"))))}this.szFlag=m}__formatValue(100/this.nThemeItems*this.nSelected,2);__chartArrayReformat(f,map.Scale.normalX(e),2);a.reformat();szTextGridStyle=g}};
function __chartArrayReformat(a,b,g){for(var d=0,f=0,f=1E3,e=0,h=0,l=0,c=0;c<a.length;c++){var m=a[c];m.fu.scale(.8,.8);var n=m.fu.getBox(),f=Math.min(f,n.x),e=Math.min(e,n.y),h=Math.max(h,n.width)}f=b-e+40;for(c=0;c<a.length;c++)m=a[c],n=m.fu.getBox(),0==c?d=map.Scale.normalX(2)-0:g&&0==c%g&&(f+=map.Scale.normalX(20)+l,d=map.Scale.normalX(2)-n.x,l=0),l=Math.max(l,n.height),m.fu.setPosition(d,f),d+=h-map.Scale.normalX(10)}MapSelection.prototype.markClass=function(a){};
MapSelection.prototype.unmarkClass=function(a){};MapSelection.prototype.remove=function(a){this.parent.removeTheme(a,this.szId)};MapSelection.prototype.removeElements=function(a){this.markGroup&&(this.markGroup.style.setProperty("display","none",""),setTimeout("map.Dom.removeElementById('"+this.markGroup.getAttributeNS(null,"id")+"')",1E4));try{this.mapTool.remove()}catch(b){}this.highLightList.unlock();this.highLightList.removeAll()};MapSelection.prototype.getItemNodes=function(a){return[]};
MapSelection.prototype.getNodeArea=function(a){return this.nSelectedArea?this.nSelectedArea/1E6:1};
