var themeStyleTranslateA=[{style:"opacity",obj:"nOpacity"},{style:"fillopacity",obj:"fillOpacity"},{style:"autoopacity",obj:"autoOpacity"},{style:"shadow",obj:"fOrigShadow"},{style:"blur",obj:"nBlur"},{style:"filter",obj:"szFilter"},{style:"dfilter",obj:"nDeltaFilter"},{style:"filterfield",obj:"szFilterField"},{style:"visible",obj:"fVisible"},{style:"dbtable",obj:"coTable"},{style:"dbtableUrl",obj:"coTableUrl"},{style:"dbtableType",obj:"coTableType"},{style:"dbtableExt",obj:"coTableExt"},{style:"dbtableProcess",
obj:"coTableProcess"},{style:"dbtableQuery",obj:"coTableQuery"},{style:"datacache",obj:"fDataCache"},{style:"itemfield",obj:"szItemField"},{style:"lookupfield",obj:"szSelectionField"},{style:"lookuptoupper",obj:"fSelectionFieldToUpper"},{style:"lookupsuffix",obj:"szSelectionFieldSuffix"},{style:"lookupdigits",obj:"nSelectionFieldDigits"},{style:"lookuptonumber",obj:"fSelectionFieldToNumber"},{style:"lookupfield2",obj:"szSelectionField2"},{style:"showdata",obj:"fShowData"},{style:"datafields",obj:"szDataFieldsA",
type:"array"},{style:"userdraw",obj:"userDraw"},{style:"child",obj:"fChild"},{style:"crsdatum",obj:"szCRSDatum"},{style:"crsutmzone",obj:"szCRSUTMZone"},{style:"server",obj:"szServer"},{style:"ranges",obj:"szRangesA",type:"array"},{style:"rangecentervalue",obj:"nRangeCenterValue"},{style:"symbols",obj:"szSymbolsA",type:"array"},{style:"values",obj:"szValuesA",type:"array",delimiter:"|"},{style:"colorvalues",obj:"szColorValuesA",type:"array",delimiter:"|"},{style:"symbolvalues",obj:"szSymbolValuesA",
type:"array",delimiter:"|"},{style:"label",obj:"szOrigLabelA",type:"array",delimiter:"|"},{style:"valuemap",obj:"valueMap",type:"object"},{style:"xaxis",obj:"szXaxisA",type:"array"},{style:"units",obj:"szUnits"},{style:"labelunits",obj:"szLabelUnits"},{style:"units100",obj:"szUnits100"},{style:"sizevalueunits",obj:"szSizeValueUnits"},{style:"alphavalueunits",obj:"szAlphaValueUnits"},{style:"legendunits",obj:"szLegendUnits"},{style:"weights",obj:"szWeights"},{style:"align",obj:"szAlign"},{style:"offsetx",
obj:"nOffsetX"},{style:"offsety",obj:"nOffsetY"},{style:"refreshtimeout",obj:"nRefreshTimeout"},{style:"normalsizevalue",obj:"nNormalSizeValue"},{style:"normalsizescale",obj:"szNormalSizeScale"},{style:"scale",obj:"nScale"},{style:"rangescale",obj:"nRangeScale"},{style:"sizepow",obj:"nSizePow"},{style:"colorfield",obj:"szColorField"},{style:"symbolfield",obj:"szSymbolField"},{style:"valuefield",obj:"szValueField"},{style:"labelfield",obj:"szLabelField"},{style:"sizefield",obj:"szSizeField"},{style:"timefield",
obj:"szTimeField"},{style:"alphafield",obj:"szAlphaField"},{style:"alphafield100",obj:"szAlphaField100"},{style:"xfield",obj:"szXField"},{style:"yfield",obj:"szYField"},{style:"dopacitypow",obj:"nDopacityPow"},{style:"dopacityramp",obj:"szDopacityRamp"},{style:"dopacityscale",obj:"nDopacityScale"},{style:"brightness",obj:"nBrightness"},{style:"buffersize",obj:"nBufferSize"},{style:"bufferstep",obj:"nBufferSizeStep"},{style:"field100min",obj:"nField100Min"},{style:"fractionscale",obj:"nFractionScale"},
{style:"minvalue",obj:"nMinValue"},{style:"maxvalue",obj:"nMaxValue"},{style:"lowvalue",obj:"nLowValue"},{style:"highvalue",obj:"nHighValue"},{style:"textfont",obj:"szTextFont"},{style:"textcolor",obj:"szTextColor"},{style:"textscale",obj:"nTextScale"},{style:"linecolor",obj:"szLineColor"},{style:"linecolor",obj:"szLineColorA",type:"array"},{style:"linewidth",obj:"nLineWidth"},{style:"markersize",obj:"nMarkerSize"},{style:"gapsize",obj:"nGapSize"},{style:"bordercolor",obj:"szBorderColor"},{style:"borderstyle",
obj:"szBorderStyle"},{style:"borderwidth",obj:"szBorderWidth"},{style:"borderradius",obj:"nBorderRadius"},{style:"boxcolor",obj:"szBoxColor"},{style:"boxopacity",obj:"nBoxOpacity"},{style:"boxmargin",obj:"nBoxMargin"},{style:"textplacement",obj:"szTextPlacement"},{style:"infotitle",obj:"szInfoTitle"},{style:"titlefield",obj:"szTitleField"},{style:"snippetfield",obj:"szSnippetField"},{style:"exclude",obj:"szExcludeA",type:"array"},{style:"nodatacolor",obj:"szNoDataColor"},{style:"titleupper",obj:"szTitleUpper"},
{style:"labelupper",obj:"szLabelUpper"},{style:"valueupper",obj:"szValueUpper"},{style:"valuelower",obj:"szValueLower"},{style:"glowupper",obj:"szGlowUpper"},{style:"glowlower",obj:"szGlowLower"},{style:"chartupper",obj:"szChartUpper"},{style:"chartlower",obj:"szChartLower"},{style:"layerupper",obj:"szLayerUpper"},{style:"layerlower",obj:"szLayerLower"},{style:"featureupper",obj:"szFeatureUpper"},{style:"featurelower",obj:"szFeatureLower"},{style:"boxupper",obj:"szBoxUpper"},{style:"shadowupper",
obj:"szShadowUpper"},{style:"shadowlower",obj:"szShadowLower"},{style:"declutterupper",obj:"szDeclutterUpper"},{style:"valuescale",obj:"nValueScale"},{style:"valuecolor",obj:"szValueColor"},{style:"minvaluesize",obj:"nValueSizeMin"},{style:"valuedecimals",obj:"nValueDecimals"},{style:"fadevaluepow",obj:"szFadeValuePow"},{style:"fadenegative",obj:"nFadeNegative"},{style:"centerpart",obj:"szCenterPart"},{style:"clipframes",obj:"nClipFrames"},{style:"clipframerate",obj:"nClipFrameRate"},{style:"cliplegend",
obj:"nClipColorLegend"},{style:"clipparts",obj:"nClipParts"},{style:"minchartsize",obj:"nChartSizeMin"},{style:"maxcharts",obj:"nMaxCharts"},{style:"showparts",obj:"szShowParts"},{style:"gridx",obj:"nGridX"},{style:"gridwidth",obj:"nGridWidth"},{style:"gridmatrix",obj:"nGridMatrix"},{style:"gridwidthpx",obj:"nGridWidthPx"},{style:"gridoffsetx",obj:"nGridOffsetX"},{style:"gridoffsety",obj:"nGridOffsetY"},{style:"aggregationfield",obj:"szAggregationField"},{style:"aggregationscale",obj:"szAggregationFieldA",
type:"array"},{style:"aggregation",obj:"szAggregation"},{style:"minaggregation",obj:"szMinAggregation"},{style:"aggregationupper",obj:"szAggregationUpper"},{style:"aggregationlower",obj:"szAggregationLower"},{style:"clipupper",obj:"szClipUpper"},{style:"cliplower",obj:"szClipLower"},{style:"dominantfilter",obj:"szDominantFilter"},{style:"dominantdfilter",obj:"nDominantDFilter"},{style:"overviewchart",obj:"szOverviewChart"},{style:"evidence",obj:"evidenceMode"},{style:"markclass",obj:"markedClass"},
{style:"markclasses",obj:"markedClassesA",type:"array"},{style:"name",obj:"szName"},{style:"title",obj:"szTitle"},{style:"snippet",obj:"szSnippet"},{style:"splash",obj:"szSplash"},{style:"description",obj:"szDescription"},{style:"tooltip",obj:"szTooltip"}];
function __maptheme_getOneStyleProperty(c,b,d,a){a=a?a:",";if("undefined"!=typeof c&&null!=c)if(d&&"undefined"!=typeof d){if("array"==d&&c&&c.length&&"object"==typeof c)return c=c.join(a),b+":"+c+";";if("object"==d&&c)return b+":"+JSON.stringify(c)+";"}else return b+":"+String(c)+";";return""}
function __maptheme_getStyleString(c){c=map.Themes.getMapThemeDefinitionObj(c.szId);for(var b="",d=0;d<themeStyleTranslateA.length;d++)b+=__maptheme_getOneStyleProperty(c.style[themeStyleTranslateA[d].style],themeStyleTranslateA[d].style,themeStyleTranslateA[d].type,themeStyleTranslateA[d].delimiter);return b.replace(/\"/gi,'\\"')}
function __maptheme_getStyleObj(c){for(var b={},d=0;d<themeStyleTranslateA.length;d++)null!=c[themeStyleTranslateA[d].obj]&&"undefined"!=c[themeStyleTranslateA[d].obj]&&(b[themeStyleTranslateA[d].style]=c[themeStyleTranslateA[d].obj]);return b}function __isdef(c){return"undefined"!==typeof c&&null!=c}
Map.Themes=function(){this.themesA=[];this.themeNodesA=[];this.themeNodesPosA=[];this.themeNodesBoxA=[];this.themeNodes=0;this.activeBuffer=this.activeTheme=null;this.switchedLayerA=[];this.enableMultiChoropleth=this.enableChartOffset=!1;this.enableSubThemes=!0;this.szChoroplethInfoStyle="";this.nMaxThemeCharts=1E6;this.nMaxShadowCharts=1E3;this.nflushPaintShape=5E3;this.nflushChartDraw=1E3;this.nColorSchemeMaxHeight=120;this.autoHideInfoTools=this.allwaysShowValues=!1;this.themeDataCacheA=[]};
Map.Themes.prototype=new Map;if("string"==typeof thisversion&&map.checkVersion(thisversion)){map.Themes=new Map.Themes;try{HTMLWindow.ixmaps.htmlgui_onInitThemes()}catch(e$$4){}}else alert("Map.Themes incompatible !");Map.Themes.prototype.addTheme=function(c){this.themesA[this.themesA.length]=c;if(!c.szFlag.match(/selection/i))try{HTMLWindow.ixmaps.htmlgui_onNewTheme(c.szId)}catch(b){}};Map.Themes.prototype.getThemeCount=function(){return this.themesA.length};Map.Themes.prototype.getAllThemes=function(){return this.themesA};
Map.Themes.prototype.getThemes=function(){return this.themesA};Map.Themes.prototype.isTheme=function(c){for(var b=0;b<this.themesA.length;b++)if(this.themesA[b].szIdStr&&this.themesA[b].szIdStr==c)return this.themesA[b];return!1};Map.Themes.prototype.isIdle=function(){for(var c=0;c<this.themesA.length;c++)if(!this.themesA[c].fRealizeDone)return!1;return!0};Map.Themes.prototype.isArray=function(c){return"[object Array]"===Object.prototype.toString.call(c)};
Map.Themes.prototype.isObject=function(c){return"[object Object]"===Object.prototype.toString.call(c)};Map.Themes.prototype.toArray=function(c){if(this.isObject(c)){var b=[];for(i in c)b.push(i),b.push(c[i]);return b}return this.isArray(c)?c:String(c).match(/\|/)||String(c).match(/\RGB/)?String(c).split("|"):String(c).split(",")};Map.Themes.prototype.toString=function(c){return this.isArray(c)?c.join("|"):c};
Map.Themes.prototype.newTheme=function(c,b,d,a,f,e){var g=null,g=(g=a.split("style="))&&1<g.length?__getStyleObj(g[1]):__getStyleObj(a);g.label=e&&"undefined"!=e?e.split("|"):g.label||null;g.szTitle=f;return this.newThemeByObj({layer:c,field:b,field100:d,style:g})};
Map.Themes.prototype.newThemeByObj=function(c){if(map.isIdle()){if(this.newThemeObjA&&this.newThemeObjA.length&&(c&&this.newThemeObjA.push(c),c=this.newThemeObjA.shift()),c){var b=JSON.stringify(c);if(this.isTheme(b)&&c.style.type.match(/TOGGLE/))return this.removeTheme(null,this.isTheme(b).szId),null;var d=null,a=c.style;if(!a)return null;var f;this.isArray(a.label)?(d=a.label,f=a.label.join("|")):d=(f=a.label)&&"undefined"!=f?f.split("|"):null;f=[5,"white","blue"];a.colorscheme&&(f=this.toArray(a.colorscheme));
c.layer=this.toString(c.layer);c.field=this.toString(c.field);a.type.match(/\bEXACT\b/)&&!a.type.match(/\bCATEGORICAL\b/)&&(a.type+="|CATEGORICAL");d=new MapTheme(c.layer,c.field,c.field100,a.type,f,a.title,d);d.nOrder=this.getThemeCount();d.szIdStr=b;d.origDef=c;this.parseStyle(d,a);this.allwaysShowValues&&(d.szFlag+="|VALUES");d.parent=this;this.addTheme(d);d.fRealize=!0;d.szFlag.match(/CHOROPLETH||BUFFER/)||d.createChartGroup(map.Layer.objectGroup);if(d.coTable)return this.loadExternalData(d.coTable,
d.nRefreshTimeout,d),d;if(fLoadExternalData){c=c.layer.split("|");for(b=0;b<c.length;b++)this.loadExternalData(c[b],d.nRefreshTimeout,d);return d}map.Event.doDefaultZoom();executeWithMessage("map.Themes.execute()","... processing ...");return d}}else c&&(this.newThemeObjA=this.newThemeObjA||[],this.newThemeObjA.push(c)),setTimeout(function(){map.Themes.newThemeByObj()},100)};
Map.Themes.prototype.parseStyle=function(c,b){if(c&&b){if(__isdef(b.classes)){if(isNaN(Number(c.origColorScheme[0]))){var d=c.origColorScheme[c.origColorScheme.length-1];c.origColorScheme[1]=c.origColorScheme[0];c.origColorScheme[2]=d}c.origColorScheme[0]=Number(b.classes)}__isdef(b.colorstyle)&&"spectrum"==c.origColorScheme[1]&&(c.origColorScheme[2]=b.colorstyle);__isdef(b.dominantdfilter)&&(c.nDominantDFilter=Number(b.dominantdfilter));__isdef(b.dominantfilter)&&(c.szDominantFilter=String(b.dominantfilter));
__isdef(b.filter)&&(c.szFilter=String(b.filter));__isdef(b.filterfield)&&(c.szFilterField=String(b.filterfield));__isdef(b.filtervalue)&&(c.szFilterValue=String(b.filtervalue));__isdef(b.overviewchart)&&(c.szOverviewChart=b.overviewchart);__isdef(b.evidence)&&(c.evidenceMode=b.evidence);__isdef(b.markclass)&&(c.markedClass=b.markclass,c.markedClasses||(c.markedClasses=[],c.markedClasses[c.markedClass]=!0,c.markedClassesA=[c.markedClass]));__isdef(b.markclasses)&&(c.markedClassesA=this.toArray(b.markclasses),
c.markedClasses=[],c.markedClassesA.forEach(function(a,b){a.length&&(c.markedClasses[a]=!0,c.markedClass=a)}));__isdef(b.fillopacity)&&("auto"==b.fillopacity?(c.autoOpacity=!0,c.fillOpacity=0):c.fillOpacity=Number(b.fillopacity));__isdef(b.opacity)&&("auto"==b.opacity?(c.autoOpacity=!0,c.fillOpacity=0):c.nOpacity=Number(b.opacity));__isdef(b.autoopacity)&&(c.autoOpacity=!0,c.fillOpacity=0);__isdef(b.shadow)?c.fShadow=c.fOrigShadow=JSON.parse(b.shadow):c.fShadow=c.fOrigShadow=!1;__isdef(b.maxshadow)&&
(c.nMaxShadowCharts=Number(b.maxshadow));__isdef(b.blur)&&(c.nBlur=Number(b.blur));__isdef(b.dbtable)&&(d=b.dbtable.split(" "),c.coTable=d[0],2==d.length&&(c.coTableType="jsonDB",c.coTableUrl=d[1].split("(")[1].split(")")[0]),3==d.length&&(c.coTableType=d[1],c.coTableUrl=d[2].split("(")[1].split(")")[0]),4==d.length&&(c.coTableType=d[1],c.coTableUrl=d[2].split("(")[1].split(")")[0],c.coTableExt=d[3].split("(")[1].split(")")[0]));__isdef(b.dbtableType)&&(c.coTableType=b.dbtableType);__isdef(b.dbtableUrl)&&
(c.coTableUrl=b.dbtableUrl);__isdef(b.dbtableExt)&&(c.coTableExt=b.dbtableExt);__isdef(b.dbtableProcess)&&(c.coTableProcess=b.dbtableProcess);__isdef(b.dbtableQuery)&&(c.coTableQuery=b.dbtableQuery);__isdef(b.lookupfield)&&(c.szSelectionField=c.szItemField=b.lookupfield);__isdef(b.lookupfield2)&&(c.szSelectionField2=b.lookupfield2);__isdef(b.lookuptoupper)&&(c.fSelectionFieldToUpper=JSON.parse(b.lookuptoupper));__isdef(b.lookupsuffix)&&(c.szSelectionFieldSuffix=b.lookupsuffix);__isdef(b.lookupprefix)&&
(c.szSelectionFieldPrefix=b.lookupprefix);__isdef(b.lookupdigits)&&(c.nSelectionFieldDigits=Number(b.lookupdigits));__isdef(b.lookuptonumber)&&(c.fSelectionFieldToNumber=JSON.parse(b.lookuptonumber));__isdef(b.crsutmzone)&&(c.szCRSUTMZone=b.crsutmzone);__isdef(b.crsdatum)&&(c.szCRSDatum=b.crsdatum);__isdef(b.server)&&(c.szServer=b.server);__isdef(b.itemfield)&&(c.szItemField=b.itemfield);__isdef(b.ranges)&&(c.szRangesA=this.toArray(b.ranges),c.szRanges=this.toString(b.ranges));__isdef(b.symbols)&&
(c.szSymbolsA=this.toArray(b.symbols));if(__isdef(b.values)&&(c.szValuesA=this.toArray(b.values),b.type.match(/CATEGORICAL/)&&c.szValuesA.length))for(d=0;d<c.szValuesA.length;d++)c.getStringValueIndex(c.szValuesA[d],"set");__isdef(b.colorvalues)&&(c.szColorValuesA=this.toArray(b.colorvalues));__isdef(b.symbolvalues)&&(c.szSymbolValuesA=this.toArray(b.symbolvalues));__isdef(b.align)&&(c.szAlign=b.align);__isdef(b.offsetx)&&(c.nOffsetX=Number(b.offsetx)||0);__isdef(b.offsety)&&(c.nOffsetY=Number(b.offsety)||
0);__isdef(b.units)&&(c.szUnits=b.units);__isdef(b.units100)&&(c.szUnits100=b.units100);__isdef(b.sizevalueunits)&&(c.szSizeValueUnits=" "+b.sizevalueunits);__isdef(b.alphavalueunits)&&(c.szAlphaValueUnits=" "+b.alphavalueunits);__isdef(b.legendunits)&&(c.szLegendUnits=" "+b.legendunits);__isdef(b.labelunits)&&(c.szLabelUnits=" "+b.labelunits);__isdef(b.xaxis)&&(c.szXaxisA=this.toArray(b.xaxis));__isdef(b.id)&&(c.szId=unescape(b.id));__isdef(b.name)&&(c.szId=c.szName=unescape(b.name));__isdef(b.title)&&
(c.szTitle=unescape(b.title));__isdef(b.snippet)&&(c.szSnippet=unescape(b.snippet));__isdef(b.splash)&&(c.szSplash=unescape(b.splash));__isdef(b.description)&&(c.szDescription=unescape(b.description));__isdef(b.tooltip)&&(c.szTooltip=unescape(b.tooltip));__isdef(b.label)&&(c.szLabelA=c.szOrigLabelA=this.toArray(b.label));__isdef(b.weights)&&(c.szWeightsA=this.toArray(b.weights),c.szWeights=this.toString(b.weights));__isdef(b.weight)&&(c.szWeightsA=[b.weights],c.szWeights=b.weight);__isdef(b.scale)&&
(c.nScale=Number(b.scale));__isdef(b.colorfield)&&(c.szColorField=b.colorfield);__isdef(b.symbolfield)&&(c.szSymbolField=b.symbolfield);__isdef(b.valuefield)&&(c.szValueField=b.valuefield);__isdef(b.labelfield)&&(c.szLabelField=b.labelfield);__isdef(b.titlefield)&&(c.szTitleField=b.titlefield);__isdef(b.snippetfield)&&(c.szSnippetField=b.snippetfield);__isdef(b.sizefield)&&(c.szSizeField=b.sizefield);__isdef(b.timefield)&&(c.szTimeField=b.timefield);__isdef(b.alphafield)&&(c.szAlphaField=b.alphafield);
__isdef(b.alphafield100)&&(c.szAlphaField100=b.alphafield100);__isdef(b.xfield)&&(c.szXField=b.xfield);__isdef(b.yfield)&&(c.szYField=b.yfield);__isdef(b.refresh)&&(c.nRefreshTimeout=1E3*Number(b.refresh));__isdef(b.refreshtimeout)&&(c.nRefreshTimeout=Number(b.refreshtimeout));__isdef(b.buffersize)&&(c.nBufferSize=b.buffersize);__isdef(b.bufferstep)&&(c.nBufferSizeStep=b.bufferstep);__isdef(b.field100min)&&(c.nField100Min=b.field100min);__isdef(b.fractionscale)&&(c.nFractionScale=b.fractionscale);
__isdef(b.minvalue)&&(c.nMinValue=b.minvalue);__isdef(b.maxvalue)&&(c.nMaxValue=b.maxvalue);__isdef(b.lowvalue)&&(c.nLowValue=b.lowvalue);__isdef(b.highvalue)&&(c.nHighValue=b.highvalue);__isdef(b.showdata)&&(c.fShowData=JSON.parse(b.showdata));__isdef(b.datacache)&&(c.fDataCache=JSON.parse(b.datacache));__isdef(b.editor)&&(c.fEditor=JSON.parse(b.editor));__isdef(b.datafields)&&(c.szDataFieldsA=this.toArray(b.datafields));__isdef(b.textcolor)&&(c.szTextColor=b.textcolor);__isdef(b.textfont)&&(c.szTextFont=
b.textfont);__isdef(b.textscale)&&(c.nTextScale=Number(b.textscale));__isdef(b.linecolor)&&(c.szLineColorA=this.toArray(b.linecolor),c.szLineColor=c.szLineColorA[c.szLineColorA.length-1]);__isdef(b.linewidth)&&(c.nLineWidth=b.linewidth);__isdef(b.markersize)&&(c.nMarkerSize=b.markersize);__isdef(b.gapsize)&&(c.nGapSize=b.gapsize);__isdef(b.bordercolor)&&(c.szBorderColor=b.bordercolor);__isdef(b.borderstyle)&&(c.szBorderStyle=b.borderstyle);__isdef(b.borderwidth)&&(c.szBorderWidth=b.borderwidth);__isdef(b.borderradius)&&
(c.nBorderRadius=Number(b.borderradius));__isdef(b.boxcolor)&&(c.szBoxColor=b.boxcolor);__isdef(b.boxopacity)&&(c.nBoxOpacity=b.boxopacity);__isdef(b.boxmargin)&&(c.nBoxMargin=b.boxmargin);__isdef(b.textplacement)&&(c.szTextPlacement=b.textplacement);__isdef(b.infotitle)&&(c.szInfoTitle=b.infotitle);__isdef(b.exclude)&&(c.szExcludeA=this.toArray(b.exclude));__isdef(b.aggregation)&&(c.szAggregation=b.aggregation);__isdef(b.rangecentervalue)&&(c.nRangeCenterValue=Number(b.rangecentervalue));__isdef(b.rangescale)&&
(c.nRangeScale=b.rangescale);__isdef(b.normalsizevalue)&&(c.nNormalSizeValue=b.normalsizevalue);__isdef(b.normalsizescale)&&(c.szNormalSizeScale=b.normalsizescale,c.nNormalSizeScale=__scanScaleValue(c.szNormalSizeScale));__isdef(b.nodatacolor)&&(c.szNoDataColor=__getSaveColor(b.nodatacolor));__isdef(b.boxupper)&&(c.szBoxUpper=b.boxupper,c.nBoxUpper=__scanScaleValue(c.szBoxUpper));__isdef(b.titleupper)&&(c.szTitleUpper=b.titleupper,c.nTitleUpper=__scanScaleValue(c.szTitleUpper));__isdef(b.labelupper)&&
(c.szLabelUpper=b.labelupper,c.nLabelUpper=__scanScaleValue(c.szLabelUpper));__isdef(b.valueupper)&&(c.szValueUpper=b.valueupper,c.nValueUpper=__scanScaleValue(c.szValueUpper));__isdef(b.valuesupper)&&(c.szValueUpper=b.valuesupper,c.nValueUpper=__scanScaleValue(c.szValueUpper));__isdef(b.valuelower)&&(c.szValueLower=b.valuelower,c.nValueLower=__scanScaleValue(c.szValueLower));__isdef(b.valueslower)&&(c.szValueLower=b.valueslower,c.nValueLower=__scanScaleValue(c.szValueLower));__isdef(b.glowupper)&&
(c.szGlowUpper=b.glowupper,c.nGlowUpper=__scanScaleValue(c.szGlowUpper));__isdef(b.glowlower)&&(c.szGlowLower=b.glowlower,c.nGlowLower=__scanScaleValue(c.szGlowLower));__isdef(b.chartupper)&&(c.szChartUpper=b.chartupper,c.nChartUpper=__scanScaleValue(c.szChartUpper));__isdef(b.chartlower)&&(c.szChartLower=b.chartlower,c.nChartLower=__scanScaleValue(c.szChartLower));__isdef(b.layerupper)&&(c.szLayerUpper=b.layerupper,c.nLayerUpper=__scanScaleValue(c.szLayerUpper));__isdef(b.layerlower)&&(c.szLayerLower=
b.layerlower,c.nLayerLower=__scanScaleValue(c.szLayerLower));__isdef(b.featureupper)&&(c.szFeatureUpper=b.featureupper,c.nFeatureUpper=__scanScaleValue(c.szFeatureUpper));__isdef(b.featurelower)&&(c.szFeatureLower=b.featurelower,c.nFeatureLower=__scanScaleValue(c.szFeatureLower));__isdef(b.shadowupper)&&(c.szShadowUpper=b.shadowupper,c.nShadowUpper=__scanScaleValue(c.szShadowUpper));__isdef(b.shadowlower)&&(c.szShadowLower=b.shadowlower,c.nShadowLower=__scanScaleValue(c.szShadowLower));__isdef(b.declutterupper)&&
(c.szDeclutterUpper=b.declutterupper,c.nDeclutterUpper=__scanScaleValue(c.szDeclutterUpper));__isdef(b.valuecolor)&&(c.szValueColor=b.valuecolor);__isdef(b.valuescale)&&(c.nValueScale=Number(b.valuescale));__isdef(b.clipframes)&&(c.nClipFrames=b.clipframes);__isdef(b.clipframerate)&&(c.nClipFrameRate=b.clipframerate,c.nClipTimeout=1/Number(b.clipframerate)*1E3);__isdef(b.cliplegend)&&(c.nClipColorLegend=Number(b.cliplegend));__isdef(b.clipvaluesize)&&(c.nValueSizeMin=Number(b.clipvaluesize));__isdef(b.minvaluesize)&&
(c.nValueSizeMin=Number(b.minvaluesize));__isdef(b.valuedecimals)&&(c.nValueDecimals=b.valuedecimals);__isdef(b.fadevaluepow)&&(c.szFadeValuePow=b.fadevaluepow);__isdef(b.dopacityscale)&&(c.nDopacityScale=b.dopacityscale);__isdef(b.dopacityramp)&&(c.szDopacityRamp=b.dopacityramp);__isdef(b.dopacitypow)&&(c.nDopacityPow=b.dopacitypow);__isdef(b.fadenegative)&&(c.nFadeNegative=Number(b.fadenegative)||.5);__isdef(b.brightness)&&(c.nBrightness=b.brightness);__isdef(b.clipparts)&&(c.nClipParts=Number(b.clipparts)||
0);__isdef(b.minsize)&&(c.nChartSizeMin=Number(b.minsize)||0);__isdef(b.minchartsize)&&(c.nChartSizeMin=Number(b.minchartsize)||0);__isdef(b.maxcharts)&&(c.nMaxCharts=Math.round(Number(b.maxcharts))||0);__isdef(b.clipsize)&&(c.nChartSizeMin=Number(b.clipsize)||0);__isdef(b.sizepow)&&(c.nSizePow=b.sizepow);__isdef(b.showparts)&&(c.szShowParts=this.toString(b.showparts),c.szShowPartsA=this.toArray(b.showparts));__isdef(b.gridx)&&(c.nGridX=Number(b.gridx)||1);__isdef(b.gridwidth)&&(String(b.gridwidth).match(/px/)&&
(c.nGridWidthPx=parseFloat(b.gridwidth)||50,map.Themes.doChangeThemeStyle(c.szId,"AUTOGRID","add")),c.nGridWidth=Number(b.gridwidth)||0);__isdef(b.gridmatrix)&&(c.nGridMatrix=Number(b.gridmatrix)||20,map.Themes.doChangeThemeStyle(c.szId,"AUTOGRID","add"));__isdef(b.gridwidthpx)&&(c.nGridWidthPx=Number(b.gridwidthpx)||50,map.Themes.doChangeThemeStyle(c.szId,"AUTOGRID","add"));__isdef(b.gridoffsetx)&&(c.nGridOffsetX=Number(b.gridoffsetx)||0);__isdef(b.gridoffsety)&&(c.nGridOffsetY=Number(b.gridoffsety)||
0);__isdef(b.aggregationfield)&&(c.szAggregationField=b.aggregationfield);__isdef(b.aggregationscale)&&(c.szAggregationFieldA=this.toArray(b.aggregationscale));__isdef(b.aggregation)&&(c.szAggregationFieldA=this.toArray(b.aggregation));__isdef(b.minaggregation)&&(c.szMinAggregation=b.minaggregation,c.nMinAggregation=Number(b.minaggregation)||0);__isdef(b.aggregationupper)&&(c.szAggregationUpper=b.aggregationupper,c.nAggregationUpper=__scanScaleValue(c.szAggregationUpper));__isdef(b.aggregationlower)&&
(c.szAggregationLower=b.aggregationlower,c.nAggregationLower=__scanScaleValue(c.szAggregationLower));__isdef(b.clipupper)&&(c.szClipUpper=b.clipupper,c.nClipUpper=__scanScaleValue(c.szClipUpper));__isdef(b.cliplower)&&(c.szClipLower=b.cliplower,c.nClipLower=__scanScaleValue(c.szClipLower));__isdef(b.userdraw)&&(c.userDraw=b.userdraw);__isdef(b.centerpart)&&(c.szCenterPart=this.toString(b.centerpart));__isdef(b.child)&&(c.fChild=!0);__isdef(b.valuemap)&&(c.valueMap=b.valuemap);__isdef(b.visible)&&
(c.fVisible=JSON.parse(b.visible))}};Map.Themes.prototype.getAllThemeDefinitionStrings=function(){for(var c=[],b=0;b<this.themesA.length;b++)c.push(this.getThemeDefinitionString(this.themesA[b]));return c};
var __toRGB=function(c){var b,d,a="0123456789abcdef";b=parseInt(c.substr(1,2),16);d=parseInt(c.substr(3,2),16);a=parseInt(c.substr(5,2),16);return"RGB("+b+","+d+","+a+")"},__getSaveColor=function(c){try{if("#"==c.charAt(0))return __toRGB(c)}catch(b){}return c},__getSaveColorScheme=function(c){for(var b=0;b<c.length;b++)c[b]=__getSaveColor(c[b]);return c.join("|")},__scanScaleValue=function(c){return String(c).match(/:/)?Number(c.split(":")[1]):Number(c)};
Map.Themes.prototype.cleanUpThemeObj=function(c,b){c.field=b.field;c.style.values=b.style.values;c.style.label=b.style.label;c.style.xaxis=b.style.xaxis;var d=c.style,a=null;if(d.colorscheme){var a=d.colorscheme[0],f;for(f in d.colorscheme)if(d.colorscheme[f]!=a){a=null;break}a&&(d.colorscheme.length=1)}if(d.symbols){a=d.symbols[0];for(f in d.symbols)if(d.symbols[f]!=a){a=null;break}a&&(d.symbols.length=1)}d.aggregationscale?(d.aggregationfield=null,d.gridwidth=null,d.gridwidthpx=null):d.aggregationfield?
(d.gridwidth=null,d.gridwidthpx=null):d.gridwidthpx&&(d.gridwidth=null);d.evidence&&"isolate"==d.evidence&&(d.evidence=null);d.aggregation&&(d.aggregation=null);d.type.match(/DOMINANT/)||d.type.match(/PERCENTOFMEAN/)||d.type.match(/OFFSETMEAN/)||d.type.match(/PERCENTOFMEAN/)||d.type.match(/DEVIATION/)||(d.dominantfilter=null,d.dominantdfilter=null);d.itemfield&&d.lookupfield&&d.itemfield==d.lookupfield&&(d.itemfield=null);return c};
Map.Themes.prototype.getThemeDefinitionString=function(c){return'map.Api.newMapTheme("'+c.szThemes+'","'+(c.szFields||"")+'","'+(c.szField100||"")+'","type:'+c.szFlag+";colorscheme:"+__getSaveColorScheme(c.origColorScheme)+";"+__maptheme_getStyleString(c)+';child:true;");'};Map.Themes.prototype.getMapThemeStyleString=function(c){return(c=this.getTheme(c)||this.activeTheme)&&c.colorScheme?"type:"+c.szFlag+";colorscheme:"+c.colorScheme+";"+__maptheme_getStyleString(c)+"":null};
Map.Themes.prototype.getMapThemeDefinitionObj=function(c){c=this.getTheme(c)||this.activeTheme;var b={};b.layer=c.szThemes;b.field=c.szFields||"";b.field100=c.szField100||"";if(c.szFlag.match(/\bWMS|IMAGE\b/)){var d={type:c.szFlag,server:c.szServer,opacity:c.nOpacity,title:c.szTitle,name:c.szName};b.style=d;return b}c.szFlag.match(/\bCATEGORICAL\b/)&&c.colorScheme&&3<c.colorScheme.length&&(!c.szValuesA||!c.szValuesA.length)&&c.szLabelA&&c.szLabelA.length&&100>=c.szLabelA.length&&(c.szValuesA=c.szLabelA.slice(0));
var d={type:c.szFlag,colorscheme:c.origColorScheme},a=__maptheme_getStyleObj(c),f;for(f in a)d[f]=a[f];b.style=d;return this.cleanUpThemeObj(b,c.origDef)};Map.Themes.prototype.getTheme=function(c){if(!c||"string"!=typeof c)return this.activeTheme;c=c.split(":")[0];for(var b=0;b<this.themesA.length;b++)if(this.themesA[b].szId==c||this.themesA[b].szName==c)return this.themesA[b];return!isNaN(Number(c))&&Number(c)<this.themesA.length?this.themesA[Number(c)]:this.activeTheme};
Map.Themes.prototype.getThemeIndex=function(c){for(var b=0;b<this.themesA.length;b++)if(this.themesA[b].szId==c)return b};Map.Themes.prototype.refreshTheme=function(c){if(c=this.getTheme(c))c.szValuesA=null,c.szFlag.match(/RANGES/)||(c.szRangesA=null),c.szExactA=null,c.fRealize=!0,c.fRedraw=!0,!fAllIncluded&&c.coTable?this.loadExternalData(c.coTable,!0,c):(c.animateTimeout&&clearTimeout(c.animateTimeout),executeWithMessage("map.Themes.execute()","... processing ..."))};
Map.Themes.prototype.nextClipFrame=function(c){(c=this.getTheme(c))&&c.realizeNextClipFrame()};Map.Themes.prototype.setClipFrame=function(c,b){var d=c?this.getTheme(c):this.activeTheme;d&&d.setClipFrame(b)};Map.Themes.prototype.pauseClip=function(c){(c=this.getTheme(c))&&c.pauseClip()};Map.Themes.prototype.startClip=function(c){(c=this.getTheme(c))&&c.startClip()};
Map.Themes.prototype.loadExternalData=function(c,b,d){this.coTableExt||(this.coTableExt=[]);if(c){var a=map.Dictionary.getLocalText("... creating theme ...");b&&("undefined"!=eval("typeof("+c+")")&&eval(c+".table = null"),a=map.Dictionary.getLocalText("... refreshing theme ..."));this.__test=null;try{eval("this.__test = "+c+".table")}catch(f){try{eval("this.__test = "+c+"_table")}catch(e){}}var g=d.fEditor||!(d.coTableUrl&&d.coTableExt)||!1;this.themeDataCacheA[c]&&((this.themeDataCacheA[c].coTableUrl||
d.coTableUrl)&&this.themeDataCacheA[c].coTableUrl!=d.coTableUrl||(this.themeDataCacheA[c].coTableExt||d.coTableExt)&&this.themeDataCacheA[c].coTableExt!=d.coTableExt||(g=!0));if(this.__test&&g&&!0===d.fDataCache)this.fWaitforData=!1,d.fWaitingforData=!1,executeWithMessage("map.Themes.execute()",a),d&&d.coTableExt&&(d.coTableExt=this.coTableExt[d.coTable]);else{if(d&&(d.coTableUrl||d.coTableExt||"ext"==d.coTableType))try{this.themeDataCacheA[c]={coTableUrl:d.coTableUrl,coTableExt:d.coTableExt};this.fWaitforData=
!0;d.fWaitingforData=!0;HTMLWindow.ixmaps.htmlgui_loadExternalData(d.coTableUrl,{theme:d,type:d.coTableType,name:d.coTable,ext:d.coTableExt});this.coTableExt[d.coTable]=d.coTableExt;return}catch(l){}fLocalHost?this.loadExternalDataDefault(c,b,a):this.loadExternalDataZipped(c,b,a)}}};
Map.Themes.prototype.loadExternalDataZipped=function(c,b,d){this.fWaitforData=!0;displayMessage(map.Dictionary.getLocalText("... loading data ..."));var a=new JSLoader;a.finishedCallback="map.Themes.loadExternalDataFinish('"+d+"')";a.errorCallback="map.Themes.loadExternalDataDefault('"+c+"',"+b+",'"+d+"')";a.szMessage=map.Dictionary.getLocalText("... loading data ...");a.loadScript(map.mapRoot+c+".js.gz",b)};
Map.Themes.prototype.loadExternalDataDefault=function(c,b,d){this.fWaitforData=!0;displayMessage(map.Dictionary.getLocalText("... loading data ..."));var a=new JSLoader;a.finishedCallback="map.Themes.loadExternalDataFinish('"+d+"')";a.errorCallback="map.Themes.loadExternalDataFinish('"+d+"')";a.szMessage=map.Dictionary.getLocalText("... loading data ...");a.loadScript(map.mapRoot+c+".js",b)};
Map.Themes.prototype.loadExternalDataFinish=function(c){this.fWaitforData=!1;executeWithMessage("map.Themes.execute()",c)};Map.Themes.prototype.setExternalData=function(c,b,d){b&&(this._dataObj=b,eval(d+" = this._dataObj"));this.fWaitforData=!1;c=this.getAllThemes();for(var a in c)c[a].coTable==d&&(c[a].fWaitingforData=!1);this.execute()};
Map.Themes.prototype.activateTheme=function(c,b){var d=this.getTheme(b);d&&(d.fRedraw=!0,executeWithMessage("map.Themes.execute()","... processing ..."));c.stopPropagation();c.preventDefault()};Map.Themes.prototype.showTheme=function(c,b){var d=this.getTheme(b);d&&(d.fShow=!0,executeWithMessage("map.Themes.execute()","... processing ..."));c&&(c.stopPropagation(),c.preventDefault())};
Map.Themes.prototype.hideTheme=function(c,b){var d=this.getTheme(b);d&&(d.fHide=!0,executeWithMessage("map.Themes.execute()","... processing ..."));c&&(c.stopPropagation(),c.preventDefault())};Map.Themes.prototype.toggleTheme=function(c,b){var d=this.getTheme(b);d&&(d.fToggle=!0,executeWithMessage("map.Themes.execute()","... processing ..."));c&&(c.stopPropagation(),c.preventDefault())};
Map.Themes.prototype.removeTheme=function(c,b){for(var d=0;d<this.themesA.length;d++)if(this.themesA[d].szId==b||this.themesA[d].szName==b){var a=this.themesA[d];a.szFlag.match(/LOCKED/)||(a.szFlag.match(/CHART/)&&(a.fToggle=!0),a.fRemove=!0,executeWithMessage("map.Themes.execute()","... processing ..."))}c&&(c.stopPropagation(),c.preventDefault())};
Map.Themes.prototype.removeAll=function(c){for(var b=0;b<this.themesA.length;b++)this.themesA[b].szFlag.match(/LOCKED/)||(this.themesA[b].fRemove=!this.themesA[b].fRealize);setTimeout(function(){map.Themes.execute()},100);c&&(c.stopPropagation(),c.preventDefault())};
Map.Themes.prototype.removeAllCharts=function(c){for(var b=0;b<this.themesA.length;b++)this.themesA[b].szFlag.match(/CHART/)&&!this.themesA[b].szFlag.match(/LOCKED/)&&(this.themesA[b].fRemove=!0);this.fWaitforData=!0;map.Themes.execute();c&&(c.stopPropagation(),c.preventDefault())};
Map.Themes.prototype.removeAllChoropleth=function(c){for(var b=0;b<this.themesA.length;b++)this.themesA[b].szFlag.match(/CHOROPLETH/)&&!this.themesA[b].szFlag.match(/LOCKED/)&&(this.themesA[b].fRemove=!this.themesA[b].fRealize);this.fWaitforData=!0;executeWithMessage("map.Themes.execute()","... processing ...");c&&(c.stopPropagation(),c.preventDefault())};
Map.Themes.prototype.removeAllSelections=function(c){for(var b=0;b<this.themesA.length;b++)this.themesA[b].szFlag.match(/SELECTION/)&&(this.themesA[b].fRemove=!0,executeWithMessage("map.Themes.execute()","... processing ..."));c&&(c.stopPropagation(),c.preventDefault())};Map.Themes.prototype.redrawInfoAll=function(c){for(var b=0;b<this.themesA.length;b++)this.themesA[b].fRedrawInfo=!0;map.Themes.execute();c&&(c.stopPropagation(),c.preventDefault())};
Map.Themes.prototype.reformat=function(c){for(var b=this.minY=this.minX=0;b<this.themesA.length;b++)this.themesA[b].fRepositionInfo=!0,this.themesA[b].fRedrawInfo=!0;map.Themes.execute();c&&(c.stopPropagation(),c.preventDefault())};
Map.Themes.prototype.execute=function(){var c=null,b=null,d=0;if(!map.isIdle())setTimeout(function(){map.Themes.execute()},100);else if(!this.fWaitforData)if(map.Tiles.isLoading())setTimeout(function(){map.Themes.execute()},250),this.fExecuteDelayed=!0;else if(this.fExecuteDelayed)this.fExecuteDelayed=!1,executeWithMessage("map.Themes.execute()"," ... ");else{for(d=0;d<this.themesA.length;d++)(this.themesA[d].fRealize||this.themesA[d].fRedraw||this.themesA[d].fToFront)&&this.themesA[d].szFlag.match(/CHOROPLETH/)&&
!this.themesA[d].szFlag.match(/SUBTHEME/)&&(c=this.themesA[d].szShapeType,b=this.themesA[d].szThemes);if(c&&this.enableMultiChoropleth)for(d=0;d<this.themesA.length;d++)this.themesA[d].szFlag&&this.themesA[d].szFlag.match(/CHOROPLETH/)&&this.themesA[d].szShapeType==c&&(this.themesA[d].disable(),this.themesA[d].isVisible=!1,this.themesA[d].fRedrawInfo=!1);if(c&&!this.enableMultiChoropleth)for(d=0;d<this.themesA.length;d++)!this.themesA[d].szFlag||!this.themesA[d].szFlag.match(/CHOROPLETH/)||this.themesA[d].szShapeType!=
c||this.themesA[d].szThemes!=b||this.themesA[d].fRealize||this.themesA[d].fRedraw||this.themesA[d].fToFront||(this.themesA[d].fRemove=!0);for(d=0;d<this.themesA.length;d++){if(this.themesA[d].fWaitingforData)return;if(this.themesA[d].fShow&&this.themesA[d].fDone){this.themesA[d].toggle(!0);this.themesA[d].fShow=!1;break}if(this.themesA[d].fHide&&this.themesA[d].fDone){this.themesA[d].toggle(!1);this.themesA[d].fHide=!1;break}if(this.themesA[d].fToggle&&this.themesA[d].fDone){this.themesA[d].toggle();
this.themesA[d].fToggle=!1;this.execute();break}if(this.themesA[d].fRemove){1<this.themesA.length&&!this.themesA[d].szFlag.match(/SELECTION/)&&!this.themesA[d].szFlag.match(/CHART/)&&this.activateNextPaint(this.themesA[d]);this.themesA[d].removeElements();this.remove(this.themesA[d]);this.reformat();this.execute();break}if(this.themesA[d].fRealize)this.themesA[d].nChartUpper&&map.Scale.nTrueMapScale*map.Scale.nZoomScale>this.themesA[d].nChartUpper||this.themesA[d].nChartLower&&map.Scale.nTrueMapScale*
map.Scale.nZoomScale<=this.themesA[d].nChartLower?this.themesA[d].chartGroup&&this.themesA[d].chartGroup.style.setProperty("display","none",""):(this.themesA[d].fEnableProgressBar=!0,this.themesA[d].fRealize=!1,this.themesA[d].realize());else if(this.themesA[d].fRedraw)this.themesA[d].fRedraw=!1,this.themesA[d].fActualize=!1,this.themesA[d].checkHiddenLayerState&&this.themesA[d].checkHiddenLayerState()?(this.themesA[d].fRealize=!0,this.themesA[d].fRedraw=!1,this.themesA[d].fReload=!1,this.themesA[d].unpaintMap(),
map.Themes.execute()):(this.themesA[d].fEnableProgressBar=!0,this.themesA[d].szFlag.match(/FEATURES/)||this.themesA[d].unpaintMap(),this.themesA[d].redraw(!1));else if(this.themesA[d].fActualize)this.themesA[d].fActualize=!1,this.themesA[d].checkHiddenLayerState&&this.themesA[d].checkHiddenLayerState()?(this.themesA[d].fRealize=!0,this.themesA[d].fRedraw=!1,this.themesA[d].fReload=!1,this.themesA[d].unpaintMap(),map.Themes.execute()):(this.themesA[d].fEnableProgressBar=!0,this.themesA[d].redraw(!1));
else if(this.themesA[d].fToFront)this.themesA[d].fEnableProgressBar=!1,this.themesA[d].toFront(),this.themesA[d].fToFront=!1;else if(this.themesA[d].fResize)this.themesA[d].resize(this.themesA[d].fResize),this.themesA[d].fResize=!1;else if(this.themesA[d].fOpacity)this.themesA[d].opacity(this.themesA[d].fOpacity),this.themesA[d].fOpacity=!1;else if(this.themesA[d].fBlur)this.themesA[d].blur(this.themesA[d].nBlur),this.themesA[d].fBlur=!1;else if(this.themesA[d].fOffset)this.themesA[d].offset(this.themesA[d].fOffset),
this.themesA[d].fOffset=!1;else if(this.themesA[d].fRedrawInfo)this.themesA[d].widgetNode&&this.themesA[d].showInfo(),this.themesA[d].fRedrawInfo=!1;else if(this.themesA[d].fResort){try{this.themesA[d].sortChartObjects()}catch(a){}this.themesA[d].fResort=!1}else if(this.themesA[d].fDeclutter){try{this.themesA[d].declutterCharts()}catch(f){}this.themesA[d].fDeclutter=!1}}this.executeCallback&&(eval(this.executeCallback),this.executeCallback=null);clearMessage();clearMessage(1E3)}};
Map.Themes.prototype.executeContinue=function(){for(var c=0;c<this.themesA.length;c++)this.themesA[c].fAnalyze?(this.themesA[c].fAnalyze=!1,this.themesA[c].realize_analyze()):this.themesA[c].fDraw?(this.themesA[c].fDraw=!1,this.themesA[c].realize_draw()):this.themesA[c].fContinue?(this.themesA[c].fContinue=!1,this.themesA[c].realizeContinue(this.themesA[c].continueIndex)):this.themesA[c].fContinueLoadAndAggregate&&(this.themesA[c].fContinueLoadAndAggregate=!1,this.themesA[c].loadAndAggregateValuesOfTheme(this.themesA[c].szThemeLayer,
this.themesA[c].continueIndex))};
Map.Themes.prototype.realizeDone=function(c){for(var b=0;b<this.themesA.length;b++)this.themesA[b].szFlag.match(/SELECTION/)&&(this.themesA[b].fRealize=!0);c.fRealizeDone=!0;c.szFlag.match(/BUFFER/)?this.activeBuffer=c:this.activeTheme=c;try{HTMLWindow.ixmaps.htmlgui_setActualTheme(c.szId)}catch(d){}try{HTMLWindow.ixmaps.htmlgui_onDrawTheme(c.szId)}catch(a){}c.szFlag.match(/TEXTONLY/)&&setTimeout(function(){map.Layer.adaptLabel()},10);c.szFlag.match(/ANIMATEPOSITION/)&&(c.animateTimeout&&clearTimeout(c.animateTimeout),
c.animateTimeout=setTimeout(function(){map.Themes.animateChartPosition(null,c.szId)},100));c.userChartDrawError&&c.userChartDrawError==c.nDoneCount&&displayMessage("User draw function error! ",5E3);this.isIdle()&&clearMessage()};
Map.Themes.prototype.showProgressBar=function(){for(var c=0;c<this.themesA.length;c++)(this.themesA[c].fRealize||this.themesA[c].fContinue||this.themesA[c].fAnalyze||this.themesA[c].fDraw)&&2<this.themesA[c].nCount/this.themesA[c].nDoneCount&&this.themesA[c].mapSleep?this.themesA[c].mapSleep.fShowProgressBar=!0:(this.themesA[c].fRealize||this.themesA[c].fContinue||this.themesA[c].fAnalyze||this.themesA[c].fDraw)&&setTimeout(function(){map.Themes.showProgressBar()},1E3)};
Map.Themes.prototype.remove=function(c){c==this.activeTheme&&(this.activeTheme=null);c==this.activeBuffer&&(this.activeBuffer=null);for(var b=0;b<this.themesA.length;b++)if(this.themesA[b]==c){for(;b<this.themesA.length-1;b++)this.themesA[b]=this.themesA[b+1];this.themesA.length--}c.removeValues();delete c};Map.Themes.prototype.cancelExecute=function(){this.activeTheme.fCancel=!0};Map.Themes.prototype.sequence=function(){this.sequenceNr=0;this.sequenceNext()};
Map.Themes.prototype.sequenceNext=function(){this.sequenceNr<this.themesA.length&&(this.themesA[this.sequenceNr].fRedraw=!0,map.Themes.executeCallback="setTimeout('map.Themes.sequenceNext()',500)",map.Themes.execute(),this.sequenceNr++)};
Map.Themes.prototype.activateNextPaint=function(c){c=this.getThemeIndex(c.szId);for(var b=c-1;b!=c;b--){0>b&&(b=this.themesA.length-1);if(b==c)break;if(this.themesA[b].isChecked&&!this.themesA[b].szFlag.match(/CHART/))return this.themesA[b].fRedraw=!0,this.themesA[b].fRedrawInfo=!1,!0}return!1};Map.Themes.prototype.toggleThemeValues=function(c,b){this.toggleValueDisplay(c,this.activeTheme.szId,!this.activeTheme.szFlag.match(/VALUES/))};
Map.Themes.prototype.toggleThemeLegends=function(c,b){SVGThemeGroup.style.setProperty("display",b?"inline":"none","")};Map.Themes.prototype.minimizeThemeLegends=function(c){this.fMinimizedLegends=!0;for(var b=0;b<this.themesA.length;b++)this.minimizeInfo(c,this.themesA[b].szId)};Map.Themes.prototype.changeAllChartScaling=function(c,b){for(var d=0;d<this.themesA.length;d++)this.themesA[d].fResize=999,executeWithMessage("map.Themes.execute()","... processing ...");c.stopPropagation();c.preventDefault()};
Map.Themes.prototype.changeChartScaling=function(c,b,d){if(b=this.getTheme(b))b.fResize=d,executeWithMessage("map.Themes.execute()","... processing ...");c.stopPropagation();c.preventDefault()};Map.Themes.prototype.changeChartOpacity=function(c,b,d){if(b=this.getTheme(b))b.fOpacity=d,executeWithMessage("map.Themes.execute()","... processing ...");c.stopPropagation();c.preventDefault()};
Map.Themes.prototype.changeChartOffset=function(c,b,d){if((c=this.getTheme(b))&&c.leadOffset&&(d=SVGDocument.getElementById(d))){d.fu=new Methods(d);b=d.fu.getPosition();var a=d.fu.getGroupScale();c.fOffset=new point(b.x-c.leadOffset.x,b.y-c.leadOffset.y);d.fu.setPosition(c.leadOffset.x,c.leadOffset.y);c.fOffset.x/=map.Zoom.nZoom/a.x;c.fOffset.y/=map.Zoom.nZoom/a.y;c.offset(c.fOffset);c.fOffset=!1;c.leadOffset=!1}};
Map.Themes.prototype.tellChartOffset=function(c,b,d){(c=this.getTheme(b))&&!c.leadOffset&&this.enableChartOffset&&(d=SVGDocument.getElementById(d))&&(d.fu=new Methods(d),c.leadOffset=d.fu.getPosition())};Map.Themes.prototype.initChartOffset=function(c,b,d){if(this.getTheme(b)){var a=SVGDocument.getElementById(d);a&&(a.origPosition||(a.origPosition=a.fu.getPosition()),a.onMouseMove=function(b){a.actualPosition=a.fu.getPosition();map.Themes.makeChartOffsetPointer(a)},a.widgetObj=new Widget(a,a))}};
Map.Themes.prototype.endChartOffset=function(c,b,d){this.getTheme(b)&&(c=SVGDocument.getElementById(d))&&c.widgetObj.remove()};
Map.Themes.prototype.makeChartOffsetPointer=function(c,b){b=b||1;c.pointerObj?(map.Dom.clearGroup(c.pointerObj),map.Dom.clearGroup(c.pointShObj)):(c.pointerObj=map.Dom.newGroup(c),c.pointShObj=map.Dom.newGroup(c),c.pointerObj.parentNode.insertBefore(c.pointerObj,c.pointerObj.parentNode.firstChild),c.pointShObj.parentNode.insertBefore(c.pointShObj,c.pointShObj.parentNode.firstChild));if(c.origPosition||c.actualPosition){var d=new box(0,0,100,75),a=new point(c.actualPosition.x-c.origPosition.x,c.actualPosition.y-
c.origPosition.y),f=map.Scale.normalX(15),e=map.Scale.normalX(5),g=map.Scale.normalX(10);map.Scale.normalX(5);e=a.y+d.height/2;f=a.x+d.width/2;Math.abs(e)+d.width/2-d.height/2>Math.abs(f)?(d.width/3>g&&(a.x>-d.width/3&&(f-=d.width/3),a.x<-d.width/3*2&&(f+=d.width/3)),0<e?(map.Dom.newShape("path",c.pointShObj,"M"+-a.x+","+-a.y+" l "+(f-map.Scale.normalX(5/b))+","+(a.y+map.Scale.normalX(1/b))+" "+map.Scale.normalX(4/b)+",0 z","fill:black;fill-opacity:0.5"),map.Dom.newShape("path",c.pointerObj,"M"+-a.x+
","+-a.y+" l "+(f-map.Scale.normalX(5/b))+","+(a.y+map.Scale.normalX(1/b))+" "+map.Scale.normalX(3/b)+",0 z","fill:white")):(map.Dom.newShape("path",c.pointShObj,"M"+-a.x+","+-a.y+" l "+(f-map.Scale.normalX(4/b))+","+(a.y+d.height)+" "+map.Scale.normalX(4/b)+",0 z","fill:black;fill-opacity:0.5"),map.Dom.newShape("path",c.pointerObj,"M"+-a.x+","+-a.y+" l "+(f-map.Scale.normalX(4/b))+","+(a.y+d.height)+" "+map.Scale.normalX(3/b)+",0 z","fill:white"))):(d.height/5>g&&(a.y>-d.height/3&&(e-=d.height/3),
a.y<-d.height/3*2&&(e+=d.height/3)),0<f?(map.Dom.newShape("path",c.pointShObj,"M"+-a.x+","+-a.y+" l "+(a.x-d.width)+","+(e-map.Scale.normalX(4/b))+" 0,"+map.Scale.normalX(4/b)+" z","fill:black;fill-opacity:0.5"),map.Dom.newShape("path",c.pointerObj,"M"+-a.x+","+-a.y+" l "+(a.x-d.width)+","+(e-map.Scale.normalX(4/b))+" 0,"+map.Scale.normalX(3/b)+" z","fill:white")):(map.Dom.newShape("path",c.pointShObj,"M"+-a.x+","+-a.y+" l "+(a.x+d.width)+","+(e-map.Scale.normalX(4/b))+" 0,"+map.Scale.normalX(4/b)+
" z","fill:black;fill-opacity:0.5"),map.Dom.newShape("path",c.pointerObj,"M"+-a.x+","+-a.y+" l "+(a.x+d.width)+","+(e-map.Scale.normalX(4/b))+" 0,"+map.Scale.normalX(3/b)+" z","fill:white")))}};
Map.Themes.prototype.animateChartPosition=function(c,b){var d=this.getTheme(b);if(d){var a=d.chartGroup.childNodes;for(i=0;i<a.length;i++){var f=a[i].fu.getPosition(),e=new point(a[i].getAttributeNS(szMapNs,"xEnd"),a[i].getAttributeNS(szMapNs,"yEnd")),g=a[i].getAttributeNS(szMapNs,"dur");dx=(e.x-f.x)/g;dy=(e.y-f.y)/g;a[i].fu.setPosition(f.x+dx,f.y+dy);a[i].setAttributeNS(szMapNs,"dur",--g)}d.animateTimeout&&clearTimeout(d.animateTimeout);d.animateTimeout=setTimeout(function(){map.Themes.animateChartPosition(null,
d.szId)},100)}};
MapTheme.prototype.declutterCharts=function(){if(!(this.szDeclutterUpper&&map.Scale.nTrueMapScale*map.Scale.nZoomScale>this.nDeclutterUpper)){for(var c=this.chartGroup.childNodes,b=0;b<c.length;b++)c[b].actualPosition&&(c[b].fu.setPosition(c[b].origPosition.x,c[b].origPosition.y),c[b].origPosition=null,c[b].actualPosition=null,c[b].pointerObj&&(map.Dom.clearGroup(c[b].pointerObj),map.Dom.clearGroup(c[b].pointShObj)),c[b].pointerObj=null,c[b].pointShObj=null);if(!c[0].actualPosition){var d=c[0].fu.getBox();
map.Zoom.getBox();for(var a=[],b=0;b<c.length;b++){var f=!1,e=c[b].fu.getPosition(),g=c[b].fu.getBox();g.x+=e.x;g.y+=e.y;for(var l in a)for(var n in a[l])if(!(g.y+g.height<a[l][n].box.y-.3*a[l][n].box.height||g.y>a[l][n].box.y+1.3*a[l][n].box.height||g.x+g.width<a[l][n].box.x-a[l][n].box.width||g.x>a[l][n].box.x+2*a[l][n].box.width)){a[l].push({node:c[b],y:c[b].fu.getPosition().x,box:g});f=!0;break}f||a.push([{node:c[b],y:c[b].fu.getPosition().x,box:g}])}for(l=0;l<a.length;l++)if(c=a[l],c.sort(this.sortUpChartObjectsCompare),
1<c.length&&5>c.length){f=c[0].node.fu.getPosition();for(b=0;b<c.length;b++)e=c[b].node.fu.getPosition(),e.y<f.y&&(f.x=e.x,f.y=e.y);f.y-=map.Scale.normalX(50)*map.Scale.nZoomScale;e=c[0].node.fu.getPosition();for(b=0;b<c.length;b++)c[b].node.origPosition=c[b].node.fu.getPosition(),c[b].node.fu.setPosition(e.x+1.2*d.width*b,f.y),c[b].node.actualPosition=new point(e.x+1.2*d.width*b,f.y),g=c[b].node.fu.getScale().x,c[b].node.actualPosition.x=c[b].node.origPosition.x-(c[b].node.origPosition.x-c[b].node.actualPosition.x)/
g,c[b].node.actualPosition.y=c[b].node.origPosition.y-(c[b].node.origPosition.y-c[b].node.actualPosition.y)/g,map.Themes.makeChartOffsetPointer(c[b].node,this.nScale)}}}};
MapTheme.prototype.animateCharts=function(c){var b=this.chartGroup.childNodes;if("scale"==c)for(i=0;i<b.length;i++){var d=b[i].firstChild;d.setAttributeNS(null,"transform","scale(1 1)");map.Dom.constructNode("animateTransform",d,{attributeName:"transform",type:"scale",from:"0 0",to:"1 1",begin:String(.2*Math.random())+"s",dur:"2s",repeatCount:"1"})}if("fire"==c)for(i=0;i<b.length;i++)d=b[i].firstChild,d.setAttributeNS(null,"transform","scale(1 1)"),map.Dom.constructNode("animateTransform",d,{attributeName:"transform",
type:"scale",from:"0 0",to:"1 1",begin:String(1*Math.random())+"s",dur:"0.5s",repeatCount:"3"})};Map.Themes.prototype.toggleValueDisplay=function(c,b,d){if(b=this.getTheme(b)){for(var a="",f=b.szFlag.split("|"),e=0;e<f.length;e++)"VALUES"!=f[e]&&(a+=(a.length?"|":"")+f[e]);d&&(a+="|VALUES");executeWithMessage("map.Themes.doChangeThemeStyle('"+b.szId+"','type:"+a+"')","... processing ...")}c&&(c.stopPropagation(),c.preventDefault())};
Map.Themes.prototype.toggleDopacity=function(c,b,d){if(b=this.getTheme(b)){for(var a="",f=b.szFlag.split("|"),e=0;e<f.length;e++)f[e].match(/DOPACITY/)||(a+=(a.length?"|":"")+f[e]);d&&(a+="|DOPACITYMAX");executeWithMessage("map.Themes.doChangeThemeStyle('"+b.szId+"','type:"+a+"')","... processing ...")}c&&(c.stopPropagation(),c.preventDefault())};
Map.Themes.prototype.changeDopacityAlphaRamp=function(c,b,d){if(b=this.getTheme(b)){var a=b.szFlag;b.nDopacityScale=b.nDopacityScale||1;b.nDopacityScale*=d;executeWithMessage("map.Themes.doChangeThemeStyle('"+b.szId+"','type:"+a+"')","... processing ...")}c&&(c.stopPropagation(),c.preventDefault())};Map.Themes.prototype.toggleChartDisplay=function(c,b,d){if(b=this.getTheme(b))b.fToggle=!0,executeWithMessage("map.Themes.execute()","... processing ...");c.stopPropagation();c.preventDefault()};
Map.Themes.prototype.zoomTo=function(c,b){var d=this.getTheme(b)||this.activeTheme;d&&d.zoomTo()};Map.Themes.prototype.zoomToClass=function(c,b,d,a){setTimeout(function(){map.Themes.doZoomToClass(b,d,a)},100)};
Map.Themes.prototype.markClass=function(c,b,d,a){var f=this.getTheme(b);f&&f.isVisible&&!f.showInfoMore&&("undefined"!=typeof f.markedClass&&f.markedClass==d||"undefined"!=typeof f.markedClasses&&f.markedClasses[d]?this.unmarkClass(c,b,d):(f.fMarkEnable=!0,f.fUnmarkEnable=!1,this.markTimeout&&clearTimeout(this.markTimeout),this.unmarkTimeout&&clearTimeout(this.unmarkTimeout),displayMessage("...",500,!0),this.markTimeout=setTimeout(function(){map.Themes.doMarkClass(b,d,a)},50)))};
Map.Themes.prototype.unmarkClass=function(c,b,d){(c=this.getTheme(b))&&c.isVisible&&!c.showInfoMore&&(displayMessage("...",500,!0),this.unmarkTimeout=setTimeout(function(){map.Themes.doUnmarkClass(b,d)},50),c.fUnmarkEnable=!0,c.fMarkEnable=!1)};Map.Themes.prototype.doZoomToClass=function(c,b,d){(c=this.getTheme(c))&&c.zoomToClass(Number(b),Number(d))};
Map.Themes.prototype.doMarkClass=function(c,b,d){if(c=this.getTheme(c)){c.markedClass=b;c.markedClasses=c.markedClasses||[];c.markedClasses[b]=!0;c.markedClassesA=[];for(var a in c.markedClasses)!0===c.markedClasses[a]&&c.markedClassesA.push(a);c.markClass(Number(b),Number(d));try{HTMLWindow.ixmaps.htmlgui_onDrawTheme(c.szId)}catch(f){}}};
Map.Themes.prototype.doUnmarkClass=function(c,b){var d=this.getTheme(c);if(d){d.markedClass=null;if(d.markedClasses){d.markedClasses[b]=!1;d.markedClassesA=[];for(var a in d.markedClasses)!0===d.markedClasses[a]&&d.markedClassesA.push(a);if(d.markedClassesA.length){displayMessage("...",500,!0);d.fMarkEnable=!0;d.markClass(d.markedClassesA[0],1);d.fMarkEnable=!1;try{HTMLWindow.ixmaps.htmlgui_onDrawTheme(d.szId)}catch(f){}return}delete d.markedClassesA;delete d.markedClasses}d.unmarkClass();try{HTMLWindow.ixmaps.htmlgui_onDrawTheme(d.szId)}catch(e){}}};
Map.Themes.prototype.hideClass=function(c,b,d,a){(c=this.getTheme(b))&&c.isVisible&&c.showClass(Number(d),Number(a),!1)};Map.Themes.prototype.showClass=function(c,b,d,a){(c=this.getTheme(b))&&c.isVisible&&c.showClass(Number(d),Number(a),!0)};Map.Themes.prototype.classesToRanges=function(c,b){var d=this.getTheme(b);d&&d.isVisible&&d.classesToRanges()};
Map.Themes.prototype.filterItems=function(c,b,d,a){(c=b?this.getTheme(b):this.activeTheme)&&c.isVisible&&!c.showInfoMore&&(c.fMarkEnable=!0,c.fUnmarkEnable=!1,this.markTimeout&&clearTimeout(this.markTimeout),this.unmarkTimeout&&clearTimeout(this.unmarkTimeout),this.opt=a,this.markTimeout=setTimeout(function(){map.Themes.doFilterItems(b,d)},500))};Map.Themes.prototype.doFilterItems=function(c,b){executeWithMessage("map.Themes.doFilterItemsGo('"+c+"','"+b+"')","applying filter ...")};
Map.Themes.prototype.doFilterItemsGo=function(c,b){clearMessage();var d=this.getTheme(c?c:null);d&&(d.filterItems(b,this.opt),this.activeTheme=d)};Map.Themes.prototype.selectFilterItems=function(c,b){var d=this.getTheme(b);d&&d.selectFilterItems()};Map.Themes.prototype.highlightItems=function(c,b,d,a){(c=b?this.getTheme(b):this.activeTheme)&&c.isVisible&&(this.highlightTimeout&&clearTimeout(this.highlightTimeout),this.highlightTimeout=setTimeout(function(){map.Themes.doHighlightItems(b,d,a)},500))};
Map.Themes.prototype.doHighlightItems=function(c,b,d){(c=c?this.getTheme(c):this.activeTheme)&&c.highlightItems(b,d)};Map.Themes.prototype.clearHighlightItems=function(c,b){var d=b?this.getTheme(b):this.activeTheme;d&&d.isVisible&&(this.highlightTimeout&&clearTimeout(this.highlightTimeout),d.clearHighlightItems())};
Map.Themes.prototype.setTimeFrame=function(c,b,d,a){(c=this.getTheme(b))&&c.isVisible&&!c.showInfoMore&&(this.markTimeout&&clearTimeout(this.markTimeout),this.unmarkTimeout&&clearTimeout(this.unmarkTimeout),this.markTimeout=setTimeout(function(){map.Themes.doSetTimeFrame(b,d,a)},1))};Map.Themes.prototype.doSetTimeFrame=function(c,b,d){if(null==c){c=this.getThemes();for(var a in c)c[a].setTimeFrame(b,d)}else(a=this.getTheme(c))&&a.setTimeFrame(b,d)};
Map.Themes.prototype.changeThemeStyle=function(c,b,d,a){if(null==b)for(i in themesA=this.getThemes(),themesA)themesA[i].szFlag.match(/FEATURE/)||this.changeThemeStyle(c,themesA[i].szId,d,a);else a.match(/fast|silent|direct/)?map.Themes.doChangeThemeStyle(b,d.replace(/'/g,"\\'"),a):executeWithMessage("map.Themes.doChangeThemeStyle('"+b+"','"+d.replace(/'/g,"\\'")+"','"+a+"')","... processing ..."),c&&(c.stopPropagation(),c.preventDefault())};
function __calcNewValue(c,b,d){c=Number(c)||0;b=Number(b)||0;return d&&d.match(/pow/)?Math.pow(c,b):d&&d.match(/factor/)?c*b:d&&(d.match(/add/)||d.match(/delta/))?c+b:b}function __calcFactor(c,b,d){c=c||0;b=b||0;return d&&d.match(/factor/)?b:d&&d.match(/add/)?(c+b)/c:b/c}
Map.Themes.prototype.doChangeThemeStyle=function(c,b,d){var a=this.getTheme(c);if(a){if(b=__getStyleObj(b)){if(b.type){b.origType=b.type;if(d&&d.match(/add/)){var f=b.type.split("|");this.szTempStyle=a.szFlag;for(var e=0;e<f.length;e++)eval("this.szTempStyle.match(/"+f[e]+"/)")||(this.szTempStyle+="|"+f[e]);b.type=this.szTempStyle}else if(d&&d.match(/remove/)){for(var f=a.szFlag.split("|"),g="",e=0;e<f.length;e++)f[e]!=b.type&&(g+=(g.length?"|":"")+f[e]);b.type=g}else if(d&&d.match(/toggle/)){for(var f=
a.szFlag.split("|"),g="",l=!1,e=0;e<f.length;e++)f[e]!=b.type?g+=(g.length?"|":"")+f[e]:l=!0;b.type=g+(l?"":"|"+b.type)}else a.szFlag.match(/FRACTION/)&&(b.type+="|FRACTION"),a.szFlag.match(/PERMILLE/)&&(b.type+="|PERMILLE"),a.szFlag.match(/CALCVAL/)&&(b.type+="|CALCVAL"),a.szFlag.match(/CALC100/)&&(b.type+="|CALC100"),a.szFlag.match(/PRODUCT/)&&(b.type+="|PRODUCT"),a.szFlag.match(/RELATIVE/)&&(b.type+="|RELATIVE"),a.szFlag.match(/INVERT/)&&(b.type+="|INVERT"),a.szFlag.match(/INVERTSIZE/)&&(b.type+=
"|INVERTSIZE"),a.szFlag.match(/DENSITY/)&&(b.type+="|DENSITY"),a.szFlag.match(/SUM/)&&(b.type+="|SUM"),a.szFlag.match(/CALCMEAN/)&&(b.type+="|CALCMEAN"),a.szFlag.match(/AUTO100/)&&(b.type+="|AUTO100");b.type.match(/LOCKED/)&&(a.fRedrawInfo=!0,map.Themes.execute());if(b.type.match(/CHART/)&&!a.szFlag.match(/CHART/)||b.type.match(/CHOROPLETH/)&&!a.szFlag.match(/CHOROPLETH/))a.unpaintMap(),this.activateNextPaint(a);!b.type.match(/CATEGORICAL/)&&(b.type.match(/EQUIDISTANT/)||b.type.match(/POW2/)||b.type.match(/POW3/)||
b.type.match(/LOG/)||b.type.match(/QUANTILE/))&&(a.szOldRanges=a.szRanges?a.szRanges:a.szOldRanges,a.szRanges=null,a.szOldLabelA=a.szLabelA?a.szLabelA:a.szOldLabelA,a.szLabelA=null,a.fRealize=!0);b.type.match(/RANGES/)&&b.ranges&&(a.szRanges=a.szOldRanges?a.szOldRanges:a.szRanges,a.szRangesA=b.ranges.split(b.ranges.match(/\|/)?"|":","),a.szLabelA=a.szOldLabelA?a.szOldLabelA:a.szLabelA,Number(a.origColorScheme[0])&&a.szRanges&&(a.origColorScheme[0]=a.szRangesA.length-1),a.fRealize=!0);if(b.type.match(/RANGES/)&&
!b.ranges){a.szRangesA=[a.partsA[0].min];for(var n in a.partsA)a.szRangesA.push(a.partsA[n].max)}n=a.szFlag;a.szFlag=b.type;!a.szFlag.match(/CHART/)||a.szFlag.match(/BUFFER/)||n.match(/CHART/)||(a.fShadow=a.fOrigShadow=!0);b.origType.match(/AGGREGATE/)||b.origType.match(/GROUP/)||b.origType.match(/\bRECT\b/)||b.origType.match(/RELOCATE/)?(a.fRealize=!0,a.fRedraw=!1,a.unpaintMap(),a.themeNodesPosA=[]):(a.fRedraw=!0,a.fRedrawInfo=!0);b.type.match(/VALUES/)!=n.match(/VALUES/)&&(a.fRedraw=!0);b.type.match(/DTEXT/)!=
n.match(/DTEXT/)&&a.unlabelMap();b.type.match(/AUTO100/)!=n.match(/AUTO100/)&&(a.fRealize=!0,a.fRedraw=!1,a.unpaintMap());b.type.match(/DIFFERENCE/)!=n.match(/DIFFERENCE/)&&(a.fRealize=!0,a.fRedraw=!1,a.unpaintMap());b.type.match(/NOOUTLIER/)!=n.match(/NOOUTLIER/)&&(a.fRealize=!0,a.fRedraw=!1,a.unpaintMap());b.type.match(/OUTLIER/)!=n.match(/OUTLIER/)&&(a.fRealize=!0,a.fRedraw=!1,a.unpaintMap());b.type.match(/NEGATIVEISNOTVALUE/)!=n.match(/NEGATIVEISNOTVALUE/)&&(a.fNegativeValuePossible=!b.type.match(/NEGATIVEISNOTVALUE/),
a.fRealize=!0,a.fRedraw=!0,a.unpaintMap())}else if(d&&d.match(/remove/)){for(f in b)for(g in themeStyleTranslateA)themeStyleTranslateA[g].style==f&&(a[themeStyleTranslateA[g].obj]=null);a.fReload=!0;a.fRealize=!0;a.unpaintMap();executeWithMessage("map.Themes.execute()","... processing ...");return}__isdef(b.classes)&&(isNaN(Number(a.origColorScheme[0]))&&(a.origColorScheme[3]=a.origColorScheme[a.origColorScheme.length/2],a.origColorScheme[4]="2colors",n=a.origColorScheme[a.origColorScheme.length-
1],a.origColorScheme[1]=a.origColorScheme[0],a.origColorScheme[2]=n),a.origColorScheme[0]=Number(b.classes),a.szFlag.match(/CHART/)&&a.unpaintMap(),a.szOldRanges=a.szRanges,a.szRanges=null,a.fRealize=!0);__isdef(b.ranges)&&(a.szRanges=b.ranges,a.szRangesA=b.ranges.split(b.ranges.match(/\|/)?"|":","),a.fRealize=!0);__isdef(b.colorstyle)&&"spectrum"==a.origColorScheme[1]&&(a.origColorScheme[2]=b.colorstyle,a.szFlag.match(/CHART/)&&a.unpaintMap(),a.fRealize=!0);__isdef(b.colordef)&&(a.origColorScheme=
b.colordef.match(/\|/)?b.colordef.split("|"):b.colordef.split(","),a.colorScheme=a.origColorScheme,a.fRedraw=!0,a.szFlag.match(/CHART/)||(a.fRealize=!0),a.fRedrawInfo=!0,a.showInfo());if(__isdef(b.colorscheme)&&(n=b.colorscheme.match(/\|/)?b.colorscheme.split("|"):b.colorscheme.split(","))&&n.length){isNaN(Number(a.origColorScheme[0]))&&(a.origColorScheme[0]=a.origColorScheme.length);a.origColorScheme.length=1;for(e=0;5>e;e++)a.origColorScheme[e+1]=e<n.length?n[e]:null;try{a.colorScheme=ColorScheme.createColorScheme(a.origColorScheme[1],
a.origColorScheme[2],a.origColorScheme[0],a.origColorScheme[3],a.origColorScheme[4])}catch(k){a.colorScheme=a.defaultColorScheme}a.fRedraw=!0;a.szFlag.match(/CHART/);a.unpaintMap();a.fRedrawInfo=!0;a.showInfo()}if(__isdef(b.colorschemegeneration)&&!isNaN(Number(a.origColorScheme[0]))){switch(b.colorschemegeneration){case "warm":a.origColorScheme[4]="#FFFDD8";break;case "cold":a.origColorScheme[4]="#FFFFFF";break;default:a.origColorScheme[4]=b.colorschemegeneration}a.szFlag.match(/CHART/)&&a.unpaintMap();
try{a.colorScheme=ColorScheme.createColorScheme(a.origColorScheme[1],a.origColorScheme[2],a.origColorScheme[0],a.origColorScheme[3],a.origColorScheme[4])}catch(q){a.colorScheme=a.defaultColorScheme}a.fRedraw=!0;a.fRedrawInfo=!0}__isdef(b.symbols)&&(a.szSymbolsA=b.symbols.split(b.symbols.match(/\|/)?"|":","),a.fRealize=!0);if(__isdef(b.values)){n=this.toArray(b.values);if(n.length)for(e=0;e<n.length;e++)a.getStringValueIndex(n[e],"set");a.szValuesA=[];a.szLabelA=[];for(e in a.nStringToValueA)a.szValuesA.push(e),
a.szLabelA.push(e);a.fRealize=!0}__isdef(b.dominantdfilter)&&(a.nDominantDFilter=Number(b.dominantdfilter),a.fRealize=!0);__isdef(b.dominantfilter)&&(a.szDominantFilter=String(b.dominantfilter),a.fRealize=!0);__isdef(b.filter)&&(d&&d.match(/remove/)?a.szFilter="":a.szFilter=String(b.filter),a.fRealize=!0,a.unpaintMap());__isdef(b.filterfield)&&(a.szFilterField=String(b.filterfield),a.fRealize=!0);__isdef(b.markclasses)&&(a.markedClassesA=this.toArray(b.markclasses),a.markedClasses=[],a.unmarkClass(),
a.markedClassesA.forEach(function(b,c){0<=b&&(a.markedClasses[b]=!0)}),a.markClass());__isdef(b.field100min)&&(a.nField100Min=b.field100min,a.fRealize=!0);__isdef(b.overviewchart)&&!a.szFlag.match(/CHART/)&&(a.szOverviewChart=b.overviewchart,a.fRedrawInfo=!0);__isdef(b.evidence)&&(a.evidenceMode=b.evidence);__isdef(b.aggregation)&&(a.szAggregation=b.aggregation);__isdef(b.opacity)&&(a.fOpacity=__calcNewValue(a.fOpacity,Number(b.opacity),d),a.autoOpacity=!1,a.fRedraw=!0);__isdef(b.fillopacity)&&(a.fillOpacity=
__calcNewValue(a.fillOpacity||(1>Number(b.fillopacity)?1:0),Number(b.fillopacity),d),a.autoOpacity=!1,a.fillOpacity=Math.min(Math.max(a.fillOpacity,.001),1),a.unpaintMap(),a.fRedraw=!0);__isdef(b.shadow)&&(a.fShadow="toggle"==b.shadow?a.fOrigShadow=!a.fOrigShadow:a.fOrigShadow=b.shadow,a.fRedraw=!0);__isdef(b.showdata)&&(a.fShowData="toggle"==b.showdata?!a.fShowData:JSON.parse(b.showdata),a.fRedraw=!0);__isdef(b.blur)&&("toggle"==b.blur?a.nBlur?(a.nOldBlur=a.nBlur,a.nBlur=0):a.nBlur=a.nOldBlur||1:
a.nBlur=__calcNewValue(a.nBlur,Number(b.blur),d),a.fBlur=!0);__isdef(b.scale)&&(a.fResize=__calcFactor(a.nScale,Number(b.scale),d));__isdef(b.dopacityscale)&&(a.nDopacityScale=__calcNewValue(a.nDopacityScale,Number(b.dopacityscale),d),a.fRedraw=!0);__isdef(b.d_dopacityscale)&&(a.nDopacityScale*=Number(b.d_dopacityscale),a.fRedraw=!0);__isdef(b.alphafield)&&(a.szAlphaField=String(b.alphafield),a.fRealize=!0);__isdef(b.alphafield100)&&(a.szAlphaField100=String(b.alphafield100),a.fRealize=!0);__isdef(b.dopacityramp)&&
(a.szDopacityRamp=b.dopacityramp,a.fRealize=!0);__isdef(b.dopacitypow)&&(a.nDopacityPow=__calcNewValue(a.nDopacityPow,Number(b.dopacitypow),d),a.fRealize=!0);__isdef(b.brightness)&&(a.nBrightness=__calcNewValue(a.nBrightness||1,Number(b.brightness),d),a.fRealize=!0);__isdef(b.rangescale)&&(a.nRangeScale=__calcNewValue(a.nRangeScale||1,Number(b.rangescale),d),a.fRedraw=!0);__isdef(b.sizefield)&&(a.szSizeField=String(b.sizefield),a.fRealize=!0);__isdef(b.timefield)&&(a.szTimeField=String(b.timefield),
a.fRealize=!0);__isdef(b.xfield)&&(a.szXField=String(b.xfield),a.fRealize=!0);__isdef(b.yfield)&&(a.szYField=String(b.yfield),a.fRealize=!0);__isdef(b.labelfield)&&(a.szLabelField=String(b.labelfield),a.fRealize=!0);__isdef(b.colorfield)&&(a.szColorField=String(b.colorfield),a.fRealize=!0);__isdef(b.symbolfield)&&(a.szSymbolField=String(b.symbolfield),a.fRealize=!0);__isdef(b.valuefield)&&(a.szValueField=String(b.valuefield),a.fRealize=!0);__isdef(b.normalsizevalue)&&(a.nNormalSizeValue||(a.nNormalSizeValue=
a.szSizeField?a.nMaxSize:a.nMax),a.nNormalSizeValue=__calcNewValue(a.nNormalSizeValue,Number(b.normalsizevalue),d),a.fRedraw=!0);__isdef(b.minvalue)&&(a.nMinValue=__calcNewValue(a.nMinValue||1,Number(b.minvalue),d),a.fRedraw=!0);__isdef(b.valuedecimals)&&(a.nValueDecimals=b.valuedecimals,a.fRedraw=!0);__isdef(b.valuescale)&&(a.nValueScale=__calcNewValue(a.nValueScale,Number(b.valuescale),d),a.fRedraw=!0);__isdef(b.linewidth)&&(a.nLineWidth=__calcNewValue(a.nLineWidth,Number(b.linewidth),d),a.fRedraw=
!0);__isdef(b.markersize)&&(a.nMarkerSize=__calcNewValue(a.nMarkerSize,Number(b.markersize),d),a.fRedraw=!0);__isdef(b.gapsize)&&(a.nGapSize=__calcNewValue(a.nGapSize,Number(b.gapsize),d),a.fRedraw=!0);__isdef(b.offsetx)&&(a.nOffsetX=__calcNewValue(a.nOffsetX,Number(b.offsetx),d),a.fRedraw=!0);__isdef(b.offsety)&&(a.nOffsetY=__calcNewValue(a.nOffsetY,Number(b.offsety),d),a.fRedraw=!0);__isdef(b.linecolor)&&(a.szLineColor=String(b.linecolor),a.fRedraw=!0);__isdef(b.valueupper)&&(a.szValueUpper=b.valueupper,
a.nValueUpper=__scanScaleValue(a.szValueUpper),a.fRedraw=!0);__isdef(b.valuelower)&&(a.szValueLower=b.valuelower,a.nValueLower=__scanScaleValue(a.szValueLower),a.fRedraw=!0);__isdef(b.titleupper)&&(a.szTitleUpper=b.titleupper,a.nTitleUpper=__scanScaleValue(a.szTitleUpper),a.fRedraw=!0);__isdef(b.boxupper)&&(a.szBoxUpper=b.boxupper,a.nBoxUpper=__scanScaleValue(a.szBoxUpper),a.fRedraw=!0);__isdef(b.shadowupper)&&(a.szShadowUpper=b.shadowupper,a.nShadowUpper=__scanScaleValue(a.szShadowUpper),a.fRedraw=
!0);__isdef(b.shadowlower)&&(a.szShadowLower=b.shadowlower,a.nShadowLower=__scanScaleValue(a.szShadowLower),a.fRedraw=!0);__isdef(b.declutterupper)&&(a.szDeclutterUpper=b.declutterupper,a.nDeclutterUpper=__scanScaleValue(a.szdeclutterUpper),a.fRedraw=!0);__isdef(b.aggregationupper)&&(a.szAggregationUpper=b.aggregationupper,a.nAggregationUpper=__scanScaleValue(a.szAggregationUpper),a.fRedraw=!0);__isdef(b.aggregationlower)&&(a.szAggregationLower=b.aggregationlower,a.nAggregationLower=__scanScaleValue(a.szAggregationLower),
a.fRedraw=!0);__isdef(b.clipupper)&&(a.szClipUpper=b.clipupper,a.nClipUpper=__scanScaleValue(a.szClipUpper),a.fRedraw=!0);__isdef(b.cliplower)&&(a.szClipLower=b.cliplower,a.nClipLower=__scanScaleValue(a.szClipLower),a.fRedraw=!0);__isdef(b.minvaluesize)&&(a.nValueSizeMin=__calcNewValue(a.nValueSizeMin,Number(b.minvaluesize),d),a.fRedraw=!0);__isdef(b.clipvaluesize)&&(a.nValueSizeMin=__calcNewValue(a.nValueSizeMin,Number(b.clipvaluesize),d),a.fRedraw=!0);__isdef(b.minsize)&&(a.nChartSizeMin=__calcNewValue(a.nChartSizeMin,
Number(b.minsize),d),a.fRedraw=!0);__isdef(b.minchartsize)&&(a.nChartSizeMin=__calcNewValue(a.nChartSizeMin,Number(b.minchartsize),d),a.fRedraw=!0);__isdef(b.maxcharts)&&(a.nMaxCharts=__calcNewValue(a.nMaxCharts,Number(b.maxcharts),d),a.nMaxCharts=Math.max(1,Math.round(a.nMaxCharts)),a.unpaintMap(),a.fRedraw=!0);__isdef(b.sizepow)&&(a.nSizePow=__calcNewValue(a.nSizePow,Number(b.sizepow),d),a.fRedraw=!0);__isdef(b.clipsize)&&(a.nChartSizeMin=__calcNewValue(a.nChartSizeMin,Number(b.clipsize),d),a.fRedraw=
!0);__isdef(b.clipparts)&&(a.nClipParts=Number(b.clipparts),a.fRedraw=!0);__isdef(b.showparts)&&(a.szShowParts=b.showparts,a.szShowPartsA=b.showparts.split(b.showparts.match(/\|/)?"|":","),map.Themes.unmarkClass(null,c),a.fRedraw=!0);__isdef(b.clipframerate)&&(a.nClipFrameRate=__calcNewValue(a.nClipFrameRate||1,Number(b.clipframerate),d),a.nClipTimeout=1/a.nClipFrameRate*1E3,a.fRedraw=!0);__isdef(b.refresh)&&(a.nRefreshTimeout=1E3*Number(b.refresh),a.fRealize=!0);__isdef(b.refreshtimeout)&&(a.nRefreshTimeout=
Number(b.refreshtimeout),a.fRealize=!0);__isdef(b.gridx)&&(a.nGridX=Number(b.gridx)||7,a.fRedraw=!0);__isdef(b.gridwidth)&&(a.szAggregationField=null,"auto"==b.gridwidth?a.nGridWidthPx=a.nGridWidthPx||50:String(b.gridwidth).match(/px/)?a.nGridWidthPx=__calcNewValue(a.nGridWidthPx||1,Number(b.gridwidth),d):"factor"==d?__isdef(a.nGridWidthPx)?a.nGridWidthPx=__calcNewValue(a.nGridWidthPx||1,Number(b.gridwidth),d):a.nGridWidth=__calcNewValue(a.nGridWidth||1E3,Number(b.gridwidth),d):(a.nGridWidthPx=null,
a.nGridWidth=__calcNewValue(a.nGridWidth||1,Number(b.gridwidth),d)),a.fRealize=!0,a.fRedraw=!0,a.fSuppressAggregationScale=!0,a.themeNodesPosA=[],a.unpaintMap());__isdef(b.gridmatrix)&&(a.szAggregationField=null,a.nGridMatrix=__calcNewValue(a.nGridMatrix||1,Number(b.gridmatrix),d),a.fRealize=!0,a.fRedraw=!0,a.fSuppressAggregationScale=!0,a.unpaintMap(),a.themeNodesPosA=[]);__isdef(b.gridwidthpx)&&(a.szAggregationField=null,a.nGridWidthPx=__calcNewValue(a.nGridWidthPx||50,Number(b.gridwidthpx),d),
a.fRealize=!0,a.fRedraw=!0,a.fSuppressAggregationScale=!0,a.unpaintMap(),a.themeNodesPosA=[]);__isdef(b.gridoffsetx)&&(a.nGridOffsetX=__calcNewValue(a.nGridOffsetX||0,Number(b.gridoffsetx),d),a.fRealize=!0,a.fRedraw=!0,a.fSuppressAggregationScale=!0,a.unpaintMap(),a.themeNodesPosA=[]);__isdef(b.gridoffsety)&&(a.nGridOffsetY=__calcNewValue(a.nGridOffsetY||0,Number(b.gridoffsety),d),a.fRealize=!0,a.fRedraw=!0,a.fSuppressAggregationScale=!0,a.unpaintMap(),a.themeNodesPosA=[]);__isdef(b.aggregationfield)&&
(a.szAggregationField=b.aggregationfield,a.fRealize=!0,a.fRedraw=!0,a.fSuppressAggregationScale=!0,a.unpaintMap(),a.themeNodesPosA=[]);__isdef(b.snippet)&&(a.szSnippet=unescape(b.snippet),a.fRealize=!0);__isdef(b.title)&&(a.szTitle=unescape(b.title),a.fRealize=!0);__isdef(b.units)&&(a.szUnits=unescape(b.units),a.fRealize=!0);__isdef(b.child)&&(a.fChild=!0)}a.fRedrawInfo=!0;map.Themes.execute()}};
Map.Themes.prototype.getThemeLayerList=function(){for(var c=[],b,d=0;d<this.themesA.length;d++)if(this.themesA[d].objThemesA&&!this.themesA[d].fRemove)for(b in this.themesA[d].objThemesA)c[c.length]=b;return c};Map.Themes.prototype.isThemeLayerUsed=function(c){for(var b=this.getThemeLayerList(),d=0;d<b.length;d++)if(c==b[d])return!0;return!1};
Map.Themes.prototype.isNodePartOfAnyTheme=function(c){if(c=map.Layer.getLayerObjOfNode(c))for(var b=map.Themes.getThemeLayerList(),d=0;d<b.length;d++)if(c.szName==b[d])return!0;return!1};Map.Themes.prototype.resetThemeNodesCache=function(){this.themeNodesA=[];this.themeNodes=0};
Map.Themes.prototype.addToThemeNodesCache=function(c){var b=0;c=c.getElementsByTagName("g");for(var d=0;d<c.length;d++){var a=String(map.Tiles.getMasterId(c.item(d).getAttributeNS(null,"id")));a&&(map.Themes.themeNodesA[a]||(map.Themes.themeNodesA[a]=[]),map.Themes.themeNodesA[a].push(c.item(d)),map.Themes.themeNodes++,b++)}};
Map.Themes.prototype.removeFromThemeNodesCache=function(c){var b=0;c=c.getElementsByTagName("g");for(var d=0;d<c.length;d++){var a=String(map.Tiles.getMasterId(c.item(d).getAttributeNS(null,"id")));if(a&&map.Themes.themeNodesA[a]){var f=map.Themes.themeNodesA[a].indexOf(c.item(d));-1<f&&(map.Themes.themeNodesA[a].splice(f,1),b++)}}};Map.Themes.prototype.setActive=function(c){this.activeTheme=c};
Map.Themes.prototype.minimizeInfo=function(c,b){var d=this.getTheme(b);if(d){var a=d.widgetNode.firstChild;if(a){var f=Number(a.getAttributeNS(szMapNs,"titleheight"));0>=f&&(f=420);for(var a=a.childNodes,e=0;e<a.length;e++){var g=a.item(e),l=g.getAttributeNS(null,"id");l.match(/body/)&&g.style.setProperty("display","none","");l.match(/footer/)&&g.style.setProperty("display","none","");l.match(/backgroundrect/)&&(g.setAttributeNS(szMapNs,"maxheight",g.getAttributeNS(null,"height")),g.setAttributeNS(null,
"height",f));l.match(/shadowrect/)&&(g.setAttributeNS(szMapNs,"maxheight",g.getAttributeNS(null,"height")),g.setAttributeNS(null,"height",String(f-100)));l.match(/minimizebutton/)&&g.style.setProperty("display","none","")}d.minimizebutton.nodeObj.style.setProperty("display","none","");d.morebutton.nodeObj.style.setProperty("display","none","");d.addDefinitionToFlag("MINIMIZED")}}};
Map.Themes.prototype.maximizeInfo=function(c,b){var d=this.getTheme(b);if(d){var a=d.widgetNode.firstChild;if(a){for(var a=a.childNodes,f=0;f<a.length;f++){var e=a.item(f),g=e.getAttributeNS(null,"id");g.match(/body/)&&e.style.setProperty("display","inline","");g.match(/footer/)&&e.style.setProperty("display","inline","");g.match(/backgroundrect/)&&e.setAttributeNS(null,"height",e.getAttributeNS(szMapNs,"maxheight"));g.match(/shadowrect/)&&e.setAttributeNS(null,"height",e.getAttributeNS(szMapNs,"maxheight"));
g.match(/minimizebutton/)&&e.style.setProperty("display","inline","")}d.minimizebutton.nodeObj.style.setProperty("display","inline","");d.morebutton.nodeObj.style.setProperty("display","inline","");d.removeDefinitionFromFlag("MINIMIZED")}}};
Map.Themes.prototype.getChartAll=function(c,b,d){for(var a=b.getAttributeNS(null,"id"),f=0,e=0;e<this.themesA.length;e++){var g=map.Dom.newGroup(b,a+":C1");this.getChart(c,g,d,this.themesA[e]);var l=map.Dom.getBox(g);0>l.width&&(l=new box(0,0,0,0));g.fu.setPosition(0,f);f+=l.height+map.Scale.normalY(10);this.themesA[e].szFlag.match(/AGGREGATE/)&&(l=c.split("::")[0]+"::"+this.themesA[e].getNodePosition(c).x+","+this.themesA[e].getNodePosition(c).y,this.getChart(l,g,d,this.themesA[e]),l=map.Dom.getBox(g),
0>l.width&&(l=new box(0,0,0,0)),g.fu.setPosition(0,f),f+=l.height+map.Scale.normalY(10))}};
Map.Themes.prototype.getChart=function(c,b,d,a){a||(a=this.activeTheme);if(!a)return null;c&&":paint"==c.substr(c.length-6,6)&&(c=c.substr(0,c.length-6));if(a.szFlag.match(/CHOROPLETH/)&&a.szFlag.match(/DOMINANT|COMPOSE/)){var f=30;2<a.nOrigSumA.length&&(f=15*a.nOrigSumA.length/Math.log(a.nOrigSumA.length));d=map.Dom.newGroup(b,b.getAttributeNS(null,"id")+":1");if(a.szFlag.match(/PERCENTOFMEAN/)||a.szFlag.match(/PERCENTOFMEDIAN/)||a.szFlag.match(/DEVIATION/)){a.drawChart(d,c,f,"CHART|BAR|VALUES|ZOOM",
c&&a.itemA[c]?a.itemA[c].nDominant:null);var e=map.Dom.getBox(d);0>e.width&&(e=new box(0,0,0,0));d=map.Dom.newGroup(b,b.getAttributeNS(null,"id")+":2");b=a.szUnit;a.szUnit="";a.drawChart(d,c,f,"VALUES|ZOOM");a.szUnit=b;c=map.Dom.getBox(d);b=1<a.nOrigSumA.length?e.width/c.width*1.015:c.width/c.height;d.fu.setPosition(c.x-e.x,e.height+e.y+Math.min(map.Scale.normalY(200),Math.max(map.Scale.normalY(10),-c.y+map.Scale.normalY(6))));d.fu.scale(b,1);a=a.szFlag.match(/PERCENTOFMEDIAN/)?"median":"mean";c=
c.width;map.Dom.newText(d,c,map.Scale.normalY(.9),"font-family:arial;font-size:"+map.Scale.normalY(4)+"px;fill:#808080",map.Dictionary.getLocalText(a));map.Dom.newText(d,c,map.Scale.normalY(5.5),"font-family:arial;font-size:"+map.Scale.normalY(4)+"px;fill:#808080",map.Dictionary.getLocalText("-"));map.Dom.newText(d,c,map.Scale.normalY(-3.7),"font-family:arial;font-size:"+map.Scale.normalY(4)+"px;fill:#808080",map.Dictionary.getLocalText("+"))}else b="CHART|BAR|SPACED|VALUES|ZOOM",a.szFlag.match(/3D/)&&
(b+="|3D"),a.szFlag.match(/\bSORT\b/)&&(b+="|SORT"),a.szFlag.match(/HORZ/)&&(b+="|HORZ|AXIS"),a.drawChart(d,c,f,b,null);return new point(0,map.Scale.normalY(30))}if(a.szFlag.match(/BUFFER/)&&a.szFlag.match(/CHART/))return null;if(a.szFlag.match(/CHOROPLETH/)&&a.itemA[c])return f=a.itemA[c].nValuesA[a.nActualFrame||0],d=__scaleStyleString(map.Scale.tStyle.Summary.szStyle,1),a.szFlag.match(/CATEGORICAL/)&&a.szLabelA&&a.szLabelA.length?f=a.szLabelA[f-1]:(e=10>a.nMax-a.nMin?2:0,f=a.formatValue(f,a.nValueDecimals||
e)+a.szUnit),a.szFlag.match(/\bCLIP\b/)&&a.szXaxisA&&map.Dom.newText(b,-40,-280,__scaleStyleString(map.Scale.tStyle.Summary.szStyle,.8)+";font-weight:normal;fill:#888888",a.szXaxisA[a.nActualFrame]),map.Dom.newText(b,-40,0,d+";font-weight:normal;stroke:#ffffff;stroke-width:20;stroke-opacity:0.3",f),map.Dom.newText(b,-40,0,d+";font-weight:normal;fill:#444444",f),__scaleStyleString(map.Scale.tStyle.Summary.szStyle,.8),!a.szFlag.match(/CATEGORICAL/)&&(a.szChoroplethInfoStyle.match(/HISTOGRAM/)||a.szChoroplethInfoStyle.match(/histogram/)||
a.szChoroplethInfoStyle.match(/CLASSES/)||a.szChoroplethInfoStyle.match(/classes/))&&(f=a.szChoroplethInfoStyle.match(/HISTOGRAM/)||a.szChoroplethInfoStyle.match(/histogram/),d=map.Dom.newGroup(b,b.getAttributeNS(null,"id")+":histogram"),this.getHistogram(c,d,f?"DISTRIBUTION":"CLASSES",a),d.fu.setPosition(0,map.Scale.normalY(4))),new point(0,0);if(a.szFlag.match(/INFOSIZE/))return a.drawChart(b,c,30,d);f=30;a.szFlag.match(/SEQUENCE/)&&(f=25);a.szFlag.match(/BAR/)&&(a.szFlag.match(/STACKED/)?f=300:
2>=a.nOrigSumA.length?f=30:(a.szFlag.match(/\bUP\b/)||a.szFlag.match(/CENTER/)||a.szFlag.match(/SEQUENCE/),f=15*a.nOrigSumA.length/Math.log(a.nOrigSumA.length)));return a.drawChart(b,c,f,d)};
Map.Themes.prototype.getSummary=function(c,b){b||(b=this.activeTheme);if(!b||!c)return null;if(!b.itemA[c]){var d=c.split("::");1<d.length&&(c=d[0]+"::"+String(d[1]).toUpperCase())}if(!b.itemA[c])return null;for(var d=b.itemA[c].nOrigValuesA,a=0,f=0;f<d.length;f++)isNaN(d[f])&&(d[f]=0),a+=d[f];b.szFlag.match(/DIFFERENCE/)&&(a=d[d.length-1]);if(b.itemA[c].nValue100){b.szUnits100=b.szUnits100||"";if(b.szFlag.match(/RELATIVE/)||b.szFlag.match(/DIFFERENCE/))return map.Dictionary.getLocalText("Relative to")+
": "+String(b.formatValue(b.itemA[c].nValue100,b.nValueDecimals||0))+" "+(b.szUnits100||"");if(b.itemA[c].nSize){if(b.szAggregation.match(/sum/))return map.Dictionary.getLocalText("Counted")+": "+String(b.formatValue(b.itemA[c].nSize,b.nValueDecimals||0))+" "+(b.szUnits100||"")}else if(a!=b.itemA[c].nValue100)return String(__formatValue(a,2))+" / "+String(b.formatValue(b.itemA[c].nValue100,b.nValueDecimals||0))+" "+(b.szUnits100||"")}else if(b.itemA[c].nSize){if(b.szFlag.match(/CATEGORICAL/)&&1==
b.itemA[c].nValuesA.length&&b.szValueField)return b.szLabelA[b.itemA[c].nValuesA[0]-1]}else{if(b.itemA[c].nAlpha)return map.Dictionary.getLocalText("Alpha value")+": "+String(b.formatValue(b.itemA[c].nAlpha,b.nValueDecimals||0))+" "+(b.szAlphaValueUnits||"");!b.szFlag.match(/SUM/)||b.szFlag.match(/SEQUENCE/)||b.szFlag.match(/\bCLIP\b/)}return null};
Map.Themes.prototype.getValueComment=function(c,b){b||(b=this.activeTheme);if(!b||!c)return null;if(!b.itemA[c]){var d=c.split("::");1<d.length&&(c=d[0]+"::"+String(d[1]).toUpperCase())}if(!b.itemA[c])return null;for(var d=b.itemA[c].nOrigValuesA,a=0;a<d.length;a++)isNaN(d[a])&&(d[a]=0);b.szFlag.match(/DIFFERENCE/);return b.szFlag.match(/OFFSETMEAN/)?map.Dictionary.getLocalText("value")+": "+String(__formatValue(b.itemA[c].nValuesA[0],2))+" "+map.Dictionary.getLocalText("mean")+": "+String(__formatValue(b.nMeanA[0],
2)):null};Map.Themes.prototype.getTitle=function(c,b){b||(b=this.activeTheme);if(!b||!c)return null;c=String(map.Tiles.getMasterId(c));if(!b.itemA[c]){var d=c.split("::");1<d.length&&(c=d[0]+"::"+String(d[1]).toUpperCase())}return b.itemA[c]?b.itemA[c].szTitle||null:null};Map.Themes.prototype.getLabel=function(c,b){b||(b=this.activeTheme);if(!b||!c)return null;if(!b.itemA[c]){var d=c.split("::");1<d.length&&(c=d[0]+"::"+String(d[1]).toUpperCase())}return b.itemA[c]?b.itemA[c].szLabel||null:null};
Map.Themes.prototype.getTextObjects=function(){for(var c=[],b=0;b<this.themesA.length;b++)if(this.themesA[b].szFlag.match(/TEXTONLY/)&&this.themesA[b].chartGroup)if("undefined"!=typeof this.themesA[b].markedClass&&null!=this.themesA[b].markedClass)for(var d=this.themesA[b].markedClass,a=this.themesA[b].chartGroup.getElementsByTagName("text"),f=0;f<a.length;f++)0<a.item(f).firstChild.nodeValue.length&&Number(a.item(f).getAttributeNS(szMapNs,"class"))==d&&c.push(a.item(f));else for(a=this.themesA[b].chartGroup.getElementsByTagName("text"),
f=0;f<a.length;f++)0<a.item(f).firstChild.nodeValue.length&&c.push(a.item(f));return c};Map.Themes.prototype.getMaxValue=function(c,b){b||(b=this.activeTheme);if(!b||!c)return null;for(var d=0,a=b.itemA[c].nValuesA,f=0;f<a.length;f++)isNaN(a[f])&&(a[f]=0),d=Math.max(d,a[f]);return d};
Map.Themes.prototype.getDataRow=function(c,b){b||(b=this.activeTheme);if(!b||!c)return null;if(!b.itemA[c]){var d=c.split("::");d&&1<d.length&&(c=d[0]+"::"+String(d[1]).toUpperCase())}if(!b.itemA[c])return null;var d=b.objThemesA[b.szThemesA[0]],a=[];if(b.szDataFieldsA)for(var f=0;f<b.szDataFieldsA.length;f++)for(var e=0;e<d.dbFields.length;e++)b.szDataFieldsA[f]==d.dbFields[e].id&&a.push(e);else for(e=0;e<d.dbFields.length;e++)a.push(e);var g=[];if(d.dbRecords){if("undefined"!=typeof b.itemA[c].dbIndexA&&
b.itemA[c].dbIndexA.length){for(var l in b.itemA[c].dbIndexA)for(0<l&&g.push("--------------------"),e=0;e<a.length;e++)g.push(d.dbFields[a[e]].id);for(l in b.itemA[c].dbIndexA)for(0<l&&g.push("--------------------"),f=b.itemA[c].dbIndexA[l],e=0;e<a.length;e++)g.push(d.dbRecords[f][a[e]]);return g}if("undefined"!=typeof b.itemA[c].dbIndex){f=b.itemA[c].dbIndex;for(e=0;e<a.length;e++)g.push(d.dbFields[a[e]].id);for(e=0;e<a.length;e++)g.push(d.dbRecords[f][a[e]]);return g}c=c.split("::")[1];for(f=0;f<
d.dbRecords.length;f++)if(d.dbRecords[f]&&d.dbRecords[f][d.nFieldSelectionIndex]&&String(d.dbRecords[f][d.nFieldSelectionIndex]).toUpperCase()==String(c).toUpperCase()){for(e=0;e<d.dbFields.length;e++)g.push(d.dbFields[e].id);for(e=0;e<d.dbFields.length;e++)g.push(d.dbRecords[f][e]);break}}return g};
Map.Themes.prototype.getFieldIndexArray=function(c){c||(c=this.activeTheme);if(!c||c.szDataFieldsA)return[];c.fieldIndexArray=[];for(var b=0;b<c.objThemesA[c.szThemesA[0]].nFieldIndexA.length;b++)c.fieldIndexArray.push(c.objThemesA[c.szThemesA[0]].nFieldIndexA[b]);0<=c.objThemesA[c.szThemesA[0]].nField100Index&&c.fieldIndexArray.push(c.objThemesA[c.szThemesA[0]].nField100Index);return c.fieldIndexArray};
Map.Themes.prototype.getScatterArray=function(c,b,d){c||(c=this.activeTheme);var a=0,f=c.nMin,e=c.nMax,g=0,l;d.match(/LOG/)?(g=1-f,f=Math.log(f+g),e=Math.log(e+g)):d.match(/POW2/)&&(g=1-f,f=Math.pow(f+g,.5),e=Math.pow(e+g,.5));d.match(/POW3/)&&(g=1-f,f=Math.pow(f+g,1/3),e=Math.pow(e+g,1/3));for(var e=(e-f)/b,n=[],k=0;k<b+1;k++)n[k]=0;for(l in c.itemA)k=c.itemA[l].nValuesA[0],"number"==typeof k&&(d.match(/LOG/)?k=Math.log(k+g):d.match(/POW2/)?k=Math.pow(k+g,.5):d.match(/POW3/)&&(k=Math.pow(k+g,1/3)),
k=Math.max(0,Math.min(b-1,Math.floor((k-f)/e))),n[k]++,a=Math.max(a,n[k]));return n};Map.Themes.prototype.getResolutionQualityOfArray=function(c){for(var b=c.length,d=-1E6,a=0;a<b;a++)d=Math.max(d,c[a]);for(var f=0,a=0;a<b;a++)c[a]>d/10&&f++;return f/b*100};Map.Themes.prototype.getDeviationOfArray=function(c){for(var b=c.length,d=-1E6,a=0,f=0,e=0,e=0;e<b;e++)d=Math.max(d,c[e]),a+=c[e];a/=b;for(e=0;e<b;e++)f+=(c[e]-a)*(c[e]-a);return e=Math.sqrt(f/b)};
Map.Themes.prototype.getHistogram=function(c,b,d,a){if(!b)return null;a||(a=this.activeTheme);if(!a||a.nMin==a.nMax)return null;if(c){if(!a.itemA[c]){var f=c.split("::");1<f.length&&(c=f[0]+"::"+String(f[1]).toUpperCase())}if(!a.itemA[c])return null}this.histGroup=map.Dom.newGroup(b,b.getAttributeNS(null,"id")+":group");this.histFlag=d;this.histTheme=a;b=map.Scale.normalX(70);d=map.Scale.normalY(20);map.Dom.newShape("rect",this.histGroup,0,0,b-map.Scale.normalX(.5),d,"fill:none;stroke:none;");c?setTimeout(function(){map.Themes.makeHistogram(c)},
100):setTimeout(function(){map.Themes.makeHistogram()},100)};
Map.Themes.prototype.makeHistogram=function(c){var b=this.histGroup,d=this.histFlag,a=this.histTheme;if(d.match("CLASSES")){for(var f=map.Scale.normalX(50),e=map.Scale.normalY(5),g=f/a.colorScheme.length,l=0,n=0,k=c?a.itemA[c].nValuesA[0]:0,q=0,h=0;h<a.partsA.length;h++){var g=f/a.nCount*a.partsA[h].nCount,u=map.Dom.newShape("rect",b,l,n,g,e,"fill:"+a.colorScheme[h]+";stroke:black;stroke-width:1;");u&&u.setAttributeNS(szMapNs,"tooltip",a.szLegendLabelA[h]+" ("+a.formatValue(a.partsA[h].nCount)+" "+
map.Dictionary.getLocalText("members")+")");l+=g;k>a.partsA[h].max?q+=g:k>a.partsA[h].min&&(q+=g/(a.partsA[h].max-a.partsA[h].min)*(k-a.partsA[h].min))}map.Dom.newShape("circle",b,q,-map.Scale.normalX(.1),map.Scale.normalX(1),"fill:#444444;stroke:none;")}else if(d.match("DISTRIBUTION")){if(!isFinite(a.nMin)||!isFinite(a.nMax))return b;q=Math.min(140,Math.max(20,a.nCount/5));q=Math.min(500,Math.max(20,a.nCount/5));f=map.Scale.normalX(70);e=map.Scale.normalY(12);d.match("INTERACTIVE")&&(e=map.Scale.normalY(20));
var w=f/q,k=c?a.itemA[c].nValuesA[0]:0,p=0,t=a.nMin,M=a.nMax,D=0,y=this.getScatterArray(a,q,""),h=this.getDeviationOfArray(y),l=this.getScatterArray(a,q,"LOG"),n=this.getDeviationOfArray(l),m=!1,v=(M-t)/q;n&&n<h&&(y=l,D=1-t,t=Math.log(t+D),M=Math.log(M+D),k=Math.log(k+D),v=(M-t)/q,m=!0);for(h=0;h<q;h++)p=Math.max(p,y[h]);l=-20;n=0;a.histogram=new Map.Histogram(a);a.histogram.fDoLog=m;a.histogram.dValue=D;a.histogram.nWidth=f;a.histogram.nMin=t;a.histogram.nMax=M;for(var A=__scaleStyleString(map.Scale.tStyle.Summary.szStyle,
.4),B=0,h=0;h<a.partsA.length;h++){g=(m?f/(M-t)*(Math.min(M,Math.log(a.partsA[h].max+D))-t):f/(M-t)*(Math.min(M,a.partsA[h].max)-t))-l;if(u=map.Dom.newShape("rect",b,l,n,g,e,"fill:"+a.colorScheme[h]+";stroke:black;stroke-width:"+map.Scale.normalX(.2)+";stroke-opacity:0.1"))u.setAttributeNS(szMapNs,"tooltip",a.szLegendLabelA[h]+" ("+a.formatValue(a.partsA[h].nCount)+" "+map.Dictionary.getLocalText("members")+")"),u.setAttributeNS(szMapNs,"onoverstyle","fill:"+a.colorScheme[h]+";stroke:black;stroke-width:"+
map.Scale.normalX(.5)+";"),u.setAttributeNS(null,"onmouseover","map.Themes.markClass(evt,'"+a.szId+"','"+h+"','1')"),u.setAttributeNS(null,"onmouseout","map.Themes.unmarkClass(evt,'"+a.szId+"')");a.histogram.classRectA[h]=u;a.histogram.classRectXA[h]=l;a.histogram.classRectWidthA[h]=g;a.histogram.classRectMaxA[h]=a.partsA[h].max;if(d.match("INTERACTIVE")){var u=map.Dom.newGroup(b,""),x=null;if(0<h){map.Dom.newShape("line",u,l,n-map.Scale.normalY(2),l,n+e,"stroke:black;stroke-width:"+map.Scale.normalX(.5)+
";stroke-opacity:0.5");if(x=map.Dom.newShape("rect",u,l-map.Scale.normalY(1.5),n-map.Scale.normalY(6),map.Scale.normalX(3),map.Scale.normalY(5),"fill:"+a.colorScheme[h]+";stroke:black;styroke-width(1);"))x.setAttributeNS(null,"rx",map.Scale.normalX(2)),x.setAttributeNS(null,"ry",map.Scale.normalY(1.5));x=map.Dom.newText(u,l,n-map.Scale.normalY(7),A+"display:none;font-weight:normal;text-anchor:middle",a.formatValue(a.partsA[h-1].max,1))}B=new Slider(u,new box(-B,0,B+g,0));B.setId(String(h));B.parent=
a.histogram;B.textObj=x;B=g}l+=g}l=w/3;n=0;g=.9;h=this.getResolutionQualityOfArray(y);10>h&&(g=10-h);for(h=0;h<q;h++){M=y[h]/p*e*g;B=m?Math.exp(t+h*v)-D:t+h*v;u=m?Math.exp(t+(h+1)*v)-D:t+(h+1)*v;A="black";M=M&&!isNaN(M)?Math.min(e,Math.max(map.Scale.normalY(.5),M)):0;if(A=map.Dom.newShape("line",b,l,n+e,l,n+e-M,"stroke:"+A+";stroke-width:"+w+";"))A.setAttributeNS(szMapNs,"tooltip",a.formatValue(B,2)+" ... "+a.formatValue(u,2)+a.szUnit+" ("+y[h]+" members)"),A.setAttributeNS(szMapNs,"onoverstyle",
"stroke:yellow;stroke-width:"+Math.max(map.Scale.normalX(1),w)+";");l+=w}map.Dom.newShape("line",b,-map.Scale.normalX(.5),e+1,f-map.Scale.normalX(.5),e+1,"stroke:black;stroke-width:"+map.Scale.normalX(.1)+";");q=-map.Scale.normalX(.5);f-=map.Scale.normalX(.5);l=map.Scale.normalX(2);map.Dom.newShape("line",b,q,e,q,e+l,"stroke:black;stroke-width:"+map.Scale.normalX(.2)+";");map.Dom.newShape("line",b,f,e,f,e+l,"stroke:black;stroke-width:"+map.Scale.normalX(.2)+";");g=__scaleStyleString(map.Scale.tStyle.Summary.szStyle,
.4);n=.4*map.Scale.tStyle.Summary.nFontHeight;y=e+l+.8*n;h=a.formatValue(a.nMin,0);p=a.formatValue(a.nMax,0);map.Dom.newText(b,q-10,y,g+";font-weight:normal;text-anchor:start",h);0>a.nMin&&0<a.nMax&&(q=(0-t)/v*w,map.Dom.newShape("line",b,q,e,q,e+l,"stroke:black;stroke-width:"+map.Scale.normalX(.2)+";"),map.Dom.newText(b,q,y,g+";font-weight:normal;text-anchor:start","0"));M=0;for(h=10;h<a.nMax;h*=10)for(A=1;9>A&&!(h*A>a.nMax||h*A<a.nMin);A++)q=((m?Math.log(h*A+D):h*A)-t)/v*w,B=a.formatValue(h*A,0),
q>M+B.length*n*3/8?(map.Dom.newShape("line",b,q,e,q,e+l,"stroke:black;stroke-width:"+map.Scale.normalX(.2)+";"),map.Dom.newText(b,q,y,g+";font-weight:normal;text-anchor:middle",B),M=q+B.length*n*3/8):map.Dom.newShape("line",b,q,e,q,e+l/2,"stroke:black;stroke-width:"+map.Scale.normalX(.2)+";");f>M+p.length*n*3/8&&map.Dom.newText(b,f,y,g+";font-weight:normal;text-anchor:middle;",p);c&&!d.match("INTERACTIVE")&&(q=(k-t)/v*w,map.Dom.newShape("circle",b,q,-map.Scale.normalX(.1),map.Scale.normalX(1),"fill:#dd0000;stroke:none;"),
map.Dom.newShape("line",b,-10,-5,q-10,-5,"stroke:#000000;stroke-width:"+map.Scale.normalX(.5)+";stroke-opacity:0.3"))}else{f=map.Scale.normalX(70);e=map.Scale.normalY(12);g=f/700;n=l=0;M=a.nMax;c=e/M;w=Math.max(1,Math.ceil(a.nCount/700));d=[];t=0;D=[];for(k in a.itemA)D.push(a.itemA[k].nValuesA[0]);D.sort(a.sortUp);for(k in D)t%w?d[d.length-1]+=D[k]/w:d[d.length]=D[k]/w,t++;d.sort(a.sortUp);for(h=0;h<d.length;h++){k=d[h];M=d[h]*c*.9;A="black";for(w=0;w<a.partsA.length;w++)if(d[h]<a.partsA[w].max){A=
a.colorScheme[w];break}A=map.Dom.newShape("line",b,l,n,l,e,"stroke:"+A+";stroke-width:"+g+";");A.setAttributeNS(szMapNs,"tooltip",a.formatValue(k,2)+a.szUnit);isNaN(M)&&(M=0);A=map.Dom.newShape("line",b,l,n+e,l,n+e-M,"stroke:#000000;stroke-width:"+g+";");A.setAttributeNS(szMapNs,"tooltip",a.formatValue(k,2)+a.szUnit);l+=g}h=a.formatValue(a.nMin,0);p=a.formatValue(a.nMax,0);g=__scaleStyleString(map.Scale.tStyle.Summary.szStyle,.4);map.Dom.newText(b,l+map.Scale.normalX(1),n+e,g+";font-weight:normal;text-anchor:start;stroke-opacity:0.8;",
h);map.Dom.newText(b,l+map.Scale.normalX(1),n+map.Scale.normalY(3.5),g+";font-weight:normal;text-anchor:start;stroke-opacity:0.8;",p);b&&b.fu.scale(f/l,1)}return b};Map.Histogram=function(c){this.mapTheme=c;this.fDoLog=!1;this.dValue=0;this.classRectA=[];this.classRectXA=[];this.classRectWidthA=[];this.classRectMaxA=[]};Map.Histogram.prototype=new Map;Map.Histogram.prototype.onMouseOver=function(c,b,d){d.textObj&&d.textObj.style.setProperty("display","inline","")};
Map.Histogram.prototype.onMouseOut=function(c,b,d){d.textObj&&d.textObj.style.setProperty("display","none","")};
Map.Histogram.prototype.onMouseMove=function(c,b,d){if(c=this.classRectA[Number(b)])c.setAttributeNS(null,"x",this.classRectXA[Number(b)]+d.value.x),c.setAttributeNS(null,"width",this.classRectWidthA[Number(b)]-d.value.x);if(c=this.classRectA[Number(b)-1]){c.setAttributeNS(null,"width",this.classRectWidthA[Number(b)-1]+d.value.x);var a=this.nMin+(this.nMax-this.nMin)/this.nWidth*(this.classRectXA[Number(b)]+d.value.x),a=this.fDoLog?Math.exp(a)-this.dValue:a;this.classRectMaxA[Number(b)-1]=a}d.textObj&&
(d.textObj.firstChild.nodeValue=__formatValue(a,1))};Map.Histogram.prototype.onMouseUp=function(c,b,d){(d=this.classRectA[Number(b)-1])&&(this.classRectWidthA[Number(b)-1]=d.getAttributeNS(null,"width"));b="ranges:"+String(this.nMin);for(d=0;d<this.classRectMaxA.length;d++)b+=","+String(this.classRectMaxA[d]);map.Themes.changeThemeStyle(c,this.mapTheme.szId,b)};Map.Themes.prototype.showErrorInfo=function(c,b){var d=this.getTheme(b);d&&d.showErrorInfo()};Map.Themes.prototype.redraw=function(c){return this.actualize(c)};
Map.Themes.prototype.actualizeActiveTheme=function(c){return this.actualize(c)};
Map.Themes.prototype.actualize=function(c){for(var b=0;b<this.themesA.length;b++)if(this.themesA[b].fDone)if(this.themesA[b].szFlag.match(/WMS/))this.themesA[b].fRealize=!0,executeWithMessage("map.Themes.execute()","...",100);else if(this.themesA[b].szFlag.match(/FEATURES/))this.themesA[b].fActualize=!0;else{if(this.themesA[b].szFlag.match(/CHART/)&&(this.themesA[b].__fClipToGeoBounds&&(this.themesA[b].fRealize=!0),c&&1!=c&&this.themesA[b].szFlag.match(/DYNAMICSCALE/)&&(this.themesA[b].nScale*=Math.sqrt(c),
this.themesA[b].fRealize=!0),c&&1!=c&&this.themesA[b].szFlag.match(/BEZIER/)&&(this.themesA[b].fRedraw=!0),this.themesA[b].szFlag.match(/DECLUTTER/)&&(this.themesA[b].fDeclutter=!0,map.Themes.execute()),c&&1!=c)){if(this.themesA[b].fRealizeDone){if(this.themesA[b].szAggregationFieldA){for(var d=this.themesA[b].nGridWidth,a=this.themesA[b].szAggregationField,f=0;f<this.themesA[b].szAggregationFieldA.length;f++){var e=Number(this.themesA[b].szAggregationFieldA[f].split(":")[1]);e&&map.Scale.nTrueMapScale*
map.Scale.nZoomScale>e&&(isNaN(parseFloat(this.themesA[b].szAggregationFieldA[f+1]))?this.themesA[b].szAggregationField=this.themesA[b].szAggregationFieldA[f+1]:(this.themesA[b].szAggregationFieldA[f+1].match(/px/)?this.themesA[b].nGridWidthPx=parseFloat(this.themesA[b].szAggregationFieldA[f+1]):(this.themesA[b].nGridWidth=parseFloat(this.themesA[b].szAggregationFieldA[f+1]),this.themesA[b].nGridWidthPx=0),this.themesA[b].szAggregationField=null));f++}this.themesA[b].szAggregationField!=a||this.themesA[b].nGridWidth!=
d?(this.themesA[b].fRealize=!0,this.themesA[b].themeNodesPosA=[]):this.themesA[b].fRedraw=!0}this.themesA[b].nGridWidthPx?(d=map.Scale.getDistanceInMeter(1E3,1E3,1E3+map.Scale.normalX(this.themesA[b].nGridWidthPx),1E3),this.themesA[b].nGridWidth=d/map.Scale.nZoomScale,this.themesA[b].fRealize=!0,this.themesA[b].themeNodesPosA=[]):this.themesA[b].nGridMatrix&&(d=map.Zoom.getBox(),d=map.Scale.getDistanceInMeter(1E3,1E3,1E3+d.width,1E3),this.themesA[b].nGridWidth=d/(this.themesA[b].nGridMatrix||20)/
map.Scale.nZoomScale,this.themesA[b].fRealize=!0,this.themesA[b].themeNodesPosA=[])}this.themesA[b].autoOpacity&&(this.themesA[b].fRedraw=!0);if(this.themesA[b].nValueUpper||this.themesA[b].nValueLower||this.themesA[b].nChartUpper||this.themesA[b].nChartLower||this.themesA[b].nBoxUpper||this.themesA[b].nTitleUpper||this.themesA[b].nLabelUpper||this.themesA[b].nMaxCharts)this.themesA[b].fRedraw=!0}this.themesA[b].fRealize?(this.themesA[b].fRedraw=!1,this.themesA[b].fActualize=!1):this.themesA[b].fActualize=
this.themesA[b].fRedraw?!1:!0}map.Themes.execute();return null};Map.Themes.prototype.resortCharts=function(c){var b=!1;if(this.themesA.length){for(var d=0;d<this.themesA.length;d++)this.themesA[d].fDone&&(b=this.themesA[d].fResort=!0);b&&map.Themes.execute()}c&&(c.stopPropagation(),c.preventDefault())};Map.Themes.prototype.clear=function(){this.themesA.length=0};
function ObjTheme(c,b,d,a,f){this.szName=c;this.coTable=d;this.szSelectionField=a;this.szItemField=f;this.nIndex=b;this.nFieldIndexA=[];this.nFieldSelectionIndex=this.nField100Index=-1;this.nFieldSelectionIndexA=[];this.nLabelFieldIndex=this.nValueFieldIndex=this.nFieldItemIndex=-1;this.leadOffset=!1}
ObjTheme.prototype.getFields=function(){this.szFields=this.theme.szFields;this.szFieldsA=this.theme.szFields.split("|");for(var c in this.szFieldsA)this.szFieldsA[c]=this.szFieldsA[c].trim();this.theme.szFieldsA=this.szFieldsA;this.szField100=this.theme.szField100;this.szColorField=this.theme.szColorField;this.szSymbolField=this.theme.szSymbolField;this.szValueField=this.theme.szValueField;this.szLabelField=this.theme.szLabelField;this.szTitleField=this.theme.szTitleField;this.szSnippetField=this.theme.szSnippetField;
this.szSizeField=this.theme.szSizeField;this.szAlphaField=this.theme.szAlphaField;this.szAlphaField100=this.theme.szAlphaField100;this.szXField=this.theme.szXField;this.szYField=this.theme.szYField;this.szTimeField=this.theme.szTimeField;this.szFilterField=this.theme.szFilterField;this.szAggregationField=this.theme.szAggregationField;this.szSelectionFieldsA=(this.theme.szSelectionField||"").split("|");this.nFieldIndexA[0]=-1;this.nFieldSelectionIndexA[0]=-1;this.theme.szSelectionField2&&(this.szSelectionField2=
this.theme.szSelectionField2||null,this.szSelectionFields2A=(this.theme.szSelectionField2||"").split("|"),this.nFieldSelection2IndexA=[-1]);var b;b=this.coTable?this.coTable:this.szName;if(!this.szFields||""===this.szFields)return!0;try{eval("this.dbTable = "+b+".table")}catch(d){try{eval("this.dbTable = "+b+"_table")}catch(a){}}if(this.coTable&&!this.dbTable)return displayMessage("Data not loaded!",1E3,!0),!1;if(this.dbTable){try{eval("this.dbFields = "+b+".fields")}catch(f){try{eval("this.dbFields = "+
b+"_fields")}catch(e){}}try{this.szSelectionField||(this.szSelectionField=map.Layer.getLayerObj(this.szName).szSelection)}catch(g){return alert("no selection field found !!"),!1}for(c=0;c<this.dbTable.fields;c++)if(!this.dbFields||0===this.dbFields.length||!this.dbFields[c])return alert("ERROR: theme '"+this.szName+"' - table '"+b+"' - object 'fields' incorrect !"),!1;if("$table$"==this.szFields){this.szFieldsA=[];for(c=0;c<this.dbFields.length;c++)this.dbFields[c].id!=this.szSelectionField&&"Total"!=
this.dbFields[c].id&&this.szFieldsA.push(this.dbFields[c].id);this.theme.szFields=this.szFieldsA.join("|");this.theme.szFieldsA=this.szFieldsA;this.theme.szLabelA=this.szFieldsA}for(c=0;c<this.dbFields.length;c++){"undefined"!=typeof this.szItemField&&String(this.dbFields[c].id).toLowerCase()==String(this.szItemField).toLowerCase()&&(this.nFieldItemIndex=c);"undefined"!=typeof this.szSelectionField&&String(this.dbFields[c].id).toLowerCase()==String(this.szSelectionField).toLowerCase()&&(this.nFieldSelectionIndex=
c);if("undefined"!=typeof this.szSelectionField2)for(String(this.dbFields[c].id).toLowerCase()==String(this.szSelectionField2).toLowerCase()&&(this.nFieldSelection2Index=c),b=0;b<this.szSelectionFields2A.length;b++)this.dbFields[c].id==this.szSelectionFields2A[b]&&(this.nFieldSelection2IndexA[b]=c);for(b=0;b<this.szSelectionFieldsA.length;b++)this.dbFields[c].id==this.szSelectionFieldsA[b]&&(this.nFieldSelectionIndexA[b]=c);for(b=0;b<this.szFieldsA.length;b++)"!"==this.szFieldsA[b].substr(0,1)?this.dbFields[c].id==
this.szFieldsA[b].substr(1,this.szFieldsA[b].length-1)&&(this.nFieldIndexA[b]=c):this.dbFields[c].id==this.szFieldsA[b]&&(this.nFieldIndexA[b]=c);this.szField100&&this.dbFields[c].id==this.szField100&&(this.nField100Index=c);this.szColorField&&this.dbFields[c].id==this.szColorField&&(this.nColorFieldIndex=c);this.szSymbolField&&this.dbFields[c].id==this.szSymbolField&&(this.nSymbolFieldIndex=c);this.szValueField&&this.dbFields[c].id==this.szValueField&&(this.nValueFieldIndex=c);this.szLabelField&&
this.dbFields[c].id==this.szLabelField&&(this.nLabelFieldIndex=c);this.szTitleField&&this.dbFields[c].id==this.szTitleField&&(this.nTitleFieldIndex=c);this.szSnippetField&&this.dbFields[c].id==this.szSnippetField&&(this.nSnippetFieldIndex=c);this.szSizeField&&this.dbFields[c].id==this.szSizeField&&(this.nSizeFieldIndex=c);this.szTimeField&&this.dbFields[c].id==this.szTimeField&&(this.nTimeFieldIndex=c);this.szXField&&this.dbFields[c].id==this.szXField&&(this.nXFieldIndex=c);this.szYField&&this.dbFields[c].id==
this.szYField&&(this.nYFieldIndex=c);this.szAlphaField&&this.dbFields[c].id==this.szAlphaField&&(this.nAlphaFieldIndex=c);this.szAlphaField100&&this.dbFields[c].id==this.szAlphaField100&&(this.nAlphaField100Index=c);this.szFilterField&&this.dbFields[c].id==this.szFilterField&&(this.nFilterFieldIndex=c);this.szAggregationField&&this.dbFields[c].id==this.szAggregationField&&(this.nAggregationFieldIndex=c)}-1==this.nFieldSelectionIndex&&-1==this.nFieldSelectionIndexA[0]&&(this.szSelectionField&&this.szSelectionField.length?
_ERROR("ERROR on load theme data: selection field '"+this.szSelectionField+"' not found !"):_ERROR("ERROR on load theme data: selection not defined !"));for(b=0;b<this.szFieldsA.length;b++)if("undefined"==typeof this.nFieldIndexA[b])return _ERROR("ERROR on load theme data: value field '"+this.szFieldsA[b]+"' not found !"),!1;this.szField100&&!this.szField100.match(/\$/)&&"undefined"==typeof this.nField100Index&&_ERROR("ERROR on load theme data: 100field '"+this.szField100+"' not found !");this.szColorField&&
!this.szColorField.match(/\$/)&&"undefined"==typeof this.nColorFieldIndex&&_ERROR("ERROR on load theme data: colorfield: '"+this.szColorField+"' not found !");this.szSymbolField&&!this.szSymbolField.match(/\$/)&&"undefined"==typeof this.nSymbolFieldIndex&&_ERROR("ERROR on load theme data: symbolfield: '"+this.szSymbolField+"' not found !");this.szValueField&&!this.szValueField.match(/\$/)&&"undefined"==typeof this.nValueFieldIndex&&_ERROR("ERROR on load theme data: valuefield: '"+this.szValueField+
"' not found !");this.szLabelField&&!this.szLabelField.match(/\$/)&&"undefined"==typeof this.nLabelFieldIndex&&_ERROR("ERROR on load theme data: labelfield '"+this.szLabelField+"' not found !");this.szTitleField&&!this.szTitleField.match(/\$/)&&"undefined"==typeof this.nTitleFieldIndex&&_ERROR("ERROR on load theme data: titlefield '"+this.szTitleField+"' not found !");this.szSnippetField&&!this.szSnippetField.match(/\$/)&&"undefined"==typeof this.nSnippetFieldIndex&&_ERROR("ERROR on load theme data: snippetfield '"+
this.szSnippetField+"' not found !");this.szSizeField&&!this.szSizeField.match(/\$/)&&"undefined"==typeof this.nSizeFieldIndex&&_ERROR("ERROR on load theme data: sizefield '"+this.szSizeField+"' not found !");this.szTimeField&&!this.szTimeField.match(/\$/)&&"undefined"==typeof this.nTimeFieldIndex&&_ERROR("ERROR on load theme data: timefield '"+this.szTimeField+"' not found !");this.szXField&&!this.szXField.match(/\$/)&&"undefined"==typeof this.nXFieldIndex&&_ERROR("ERROR on load theme data: xfield '"+
this.szXField+"' not found !");this.szYField&&!this.szYField.match(/\$/)&&"undefined"==typeof this.nYFieldIndex&&_ERROR("ERROR on load theme data: yfield '"+this.szYField+"' not found !");this.szAlphaField&&!this.szAlphaField.match(/\$/)&&"undefined"==typeof this.nAlphaFieldIndex&&_ERROR("ERROR on load theme data: alphafield '"+this.szAlphaField+"' not found !");this.szAlphaField100&&!this.szAlphaField100.match(/\$/)&&"undefined"==typeof this.nAlphaField100Index&&_ERROR("ERROR on load theme data: alpha100field '"+
this.szAlphaField100+"' not found !");this.szFilterField&&!this.szFilterField.match(/\$/)&&"undefined"==typeof this.nFilterFieldIndex&&_ERROR("ERROR on load theme data: filterfield '"+this.szFilterField+"' not found !");this.szAggregationField&&!this.szAggregationField.match(/\$/)&&"undefined"==typeof this.nAggregationFieldIndex&&_ERROR("ERROR on load theme data: aggregationfield '"+this.szAggregationField+"' not found !");!this.szItemField||this.szItemField==this.szSelectionField||this.szItemField.match(/\$/)||
"undefined"!=typeof this.nFieldItemIndex&&-1!=this.nFieldItemIndex||alert("ERROR on load theme data: itemfield '"+this.szItemField+"' not found !")}else{c=SVGDocument.getElementById(this.szName);null==c&&(b=map.Tiles.getTileNodes(this.szName))&&(c=b[0]);if(!c)return this.szName="",!1;c=c.getAttributeNS(szMapNs,"info");if(null==c||""===c)return this.szName="",!1;var l=c.split("|");for(c=0;c<l.length;c++){for(b=0;b<this.szFieldsA.length;b++)"!"==this.szFieldsA[b].substr(0,1)?l[c]==this.szFieldsA[b].substr(1,
this.szFieldsA[b].length-1)&&(this.nFieldIndexA[b]=c):l[c]==this.szFieldsA[b]&&(this.nFieldIndexA[b]=c);this.szField100&&l[c]==this.szField100&&(this.nField100Index=c);this.szColorField&&l[c]==this.szColorField&&(this.nColorFieldIndex=c);this.szSymbolField&&l[c]==this.szSymbolField&&(this.nSymbolFieldIndex=c);this.szValueField&&l[c]==this.szValueField&&(this.nValueFieldIndex=c);this.szLabelField&&l[c]==this.szLabelField&&(this.nLabelFieldIndex=c);this.szTimeField&&l[c]==this.szTimeField&&(this.nTimeFieldIndex=
c);this.szSizeField&&l[c]==this.szSizeField&&(this.nSizeFieldIndex=c);this.szXField&&l[c]==this.szXField&&(this.nXFieldIndex=c);this.szYField&&l[c]==this.szXField&&(this.nYFieldIndex=c);this.szAlphaField&&l[c]==this.szAlphaField&&(this.nAlphaFieldIndex=c);this.szAlphaField100&&l[c]==this.szAlphaField100&&(this.nAlphaField100Index=c)}}for(b=0;b<this.szFieldsA.length;b++)0>this.nFieldIndexA[b]&&("$item$"!=this.szFieldsA[b]&&"$index$"!=this.szFieldsA[b]&&_ERROR("ERROR on load theme data: '"+this.szFieldsA[b]+
"' not found !"),this.szName="");return!0};
function MapTheme(c,b,d,a,f,e,g){this.fDone=!1;this.nMin=Number.MAX_VALUE;this.nMax=-Number.MAX_VALUE;this.nNoData=this.nCount=this.nSum=0;this.szThemes=c||"";this.szThemesA=c.split("|");this.checkTheme();this.objThemesA=[];this.szFields=b||"$item$";this.szFieldsA=this.szFields.split("|");this.szField100=d||"";this.nFieldsA=[];this.nFields100A=[];this.nFieldsSelectionA=[];this.nMinA=[];this.nMaxA=[];this.nSumA=[];this.nMeanA=[];this.nMedianA=[];this.nDeviationA=[];this.nOrigMinA=[];this.nOrigMaxA=
[];this.nOrigSumA=[];for(d=0;d<this.szFieldsA.length;d++)this.nMinA[d]=Number.MAX_VALUE,this.nMaxA[d]=-Number.MAX_VALUE,this.nSumA[d]=0,this.nOrigMinA[d]=Number.MAX_VALUE,this.nOrigMaxA[d]=-Number.MAX_VALUE,this.nOrigSumA[d]=0,this.nMedianA[d]=0,this.nMeanA[d]=0;this.nMin100=Number.MAX_VALUE;this.nMax100=-Number.MAX_VALUE;this.nSum100=0;this.nMinSize=Number.MAX_VALUE;this.nMaxSize=-Number.MAX_VALUE;this.nSumSize=0;this.nMinAlpha=Number.MAX_VALUE;this.nMaxAlpha=-Number.MAX_VALUE;this.nSumAlpha=0;this.nMinX=
Number.MAX_VALUE;this.nMaxX=-Number.MAX_VALUE;this.nSumX=0;this.nMinY=Number.MAX_VALUE;this.nMaxY=-Number.MAX_VALUE;this.nSumY=0;this.nDominantDFilter=this.szDominantFilter=null;this.nFilterA=[];this.dbTableA=[];this.dbFieldsA=[];this.dbRecordsA=[];if(f)for(d in this.origColorScheme=[],f)this.origColorScheme[d]=f[d];else this.origColorScheme=null;this.defaultColorScheme=["#008888","#00aaaa","#00cccc","#00eeee","#00ffff"];this.szTitle=e?e:c+" ["+b+"]";this.szTitle=map.Dictionary.getLocalText(this.szTitle);
this.szTitle=60<this.szTitle.length?this.szTitle.slice(0,50)+" ...":this.szTitle;this.szUnits="";this.szXaxisA=this.szAlphaValueUnits=this.szSizeValueUnits=null;this.szOrigLabelA=this.szLabelA=g;this.szLegendLabelA=[];this.szLegendStyle="";this.evidenceMode="isolate";this.szAggregation="sum";this.nValuesA=[];this.szExactA=this.szRangesA=this.szValuesA=null;this.itemA=[];this.fDataCache=this.fVisible=!0;this.fEditor=!1;this.fUndefinedValuePossible=this.fNegativeValuePossible=this.fNullIsValue=!0;this.nStringToValue=
1;this.nStringToValueA=[];this.szOrigFlag=this.szFlag=a?a:"CHOROPLETH";this.nValueScale=this.nScale=1;this.nRefreshTimeout=0;this.szId="theme"+String(Math.random());this.szShapeType="polygon";if(c=map.Layer.getLayerObj(this.szThemesA[0]))this.szShapeType=c.szType,"line"==this.szShapeType&&this.szOrigFlag.match(/BUFFER/)&&(this.szShapeType+="+buffer");this.hiddenLayerA=[];this.szFlag.match(/CHART/)||(this.szFlag.match(/PIE/)?this.szOverviewChart="PIE":this.szFlag.match(/DONUT/)&&(this.szOverviewChart=
"DONUT"));this.szFlag.match(/ZEROISNOTVALUE/)&&(this.fNullIsValue=!1);this.szFlag.match(/ZEROISVALUE/)&&(this.fNullIsValue=!0);this.szFlag.match(/NEGATIVEISNOTVALUE/)&&(this.fNegativeValuePossible=!1);this.szFlag.match(/NEGATIVEISVALUE/)&&(this.fNegativeValuePossible=!0);this.szFlag.match(/UNDEFINEDISVALUE/)&&(this.fUndefinedValuePossible=!0);this.szFlag.match(/UNDEFINEDISNOTVALUE/)&&(this.fUndefinedValuePossible=!1);this.szFlag.match(/SUM/)&&(this.szAggregation="sum");this.szFlag.match(/MEAN/)&&
(this.szAggregation="mean");this.szFlag.match(/MAX/)&&(this.szAggregation="max");if(this.szFlag.match(/CHART/)){if(this.szFlag.match(/CATEGORICAL/)||1<this.szFieldsA.length)this.fNullIsValue=!0;this.szFlag.match(/BUFFER/)||(this.fShadow=this.fOrigShadow=!0)}this.szFlag.match(/CATEGORICAL/)&&!this.szFlag.match(/AGGREGATE/)&&(this.fNegativeValuePossible=!1);this.szFlag.match(/CATEGORICAL/)&&!this.szLabelA&&(this.szLabelA=[]);this.fGrayNoMember=this.fSortBeforeDraw=this.fClipCharts=!0;this.nClipTimeout=
1E3;this.paintedShapeNodesA=[];this.szChoroplethInfoStyle=map.Themes.szChoroplethInfoStyle;this.nMaxThemeCharts=map.Themes.nMaxThemeCharts;this.nMaxShadowCharts=map.Themes.nMaxShadowCharts;this.nflushPaintShape=map.Themes.nflushPaintShape;this.nflushChartDraw=map.Themes.nflushChartDraw;this.themeNodesPosA=this.szFlag.match(/AGGREGATE|GROUP/)?[]:map.Themes.themeNodesPosA;this.style={theme:this};this.setProperties=function(a){this.szFields=a.field||a.fields||this.szFields;this.szField100=a.field100||
this.szField100;this.szFieldsA=b.split("|");this.style.setProperties(a)};this.style.setProperties=function(a){map.Themes.parseStyle(this.theme,a)}}MapTheme.prototype.checkTheme=function(){if(!this.szThemesA)return!1;for(var c=0;c<this.szThemesA.length;c++)if("generic"==this.szThemesA[c]||map.Layer.isLoaded(this.szThemesA[c]))return!0;this.ErrorMessage="theme layer not loaded ! zoom in ?";return!1};MapTheme.prototype.def=function(){return map.Themes.getMapThemeDefinitionObj(this.szId)};
MapTheme.prototype.getDefinitionObject=function(){return map.Themes.getMapThemeDefinitionObj(this.szId)};MapTheme.prototype.set=function(c){map.Themes.parseStyle(this,c)};MapTheme.prototype.setDefinitionObject=function(c){map.Themes.parseStyle(this,c)};
MapTheme.prototype.initValues=function(){this.nMin=Number.MAX_VALUE;this.nMax=-Number.MAX_VALUE;for(var c=this.nNoData=this.nCount=this.nSum=0;c<this.szFieldsA.length;c++)this.nMinA[c]=Number.MAX_VALUE,this.nMaxA[c]=-Number.MAX_VALUE,this.nSumA[c]=0,this.nOrigMinA[c]=Number.MAX_VALUE,this.nOrigMaxA[c]=-Number.MAX_VALUE,this.nOrigSumA[c]=0,this.nMedianA[c]=0,this.nMeanA[c]=0,this.nDeviationA[c]=0;this.nMin100=Number.MAX_VALUE;this.nMax100=-Number.MAX_VALUE;this.nSum100=0;this.itemA=[];this.posItemA=
[];this.chartPosA=[];this.exactCountA=[];this.exactSizeA=[];this.quantileA=[];this.szAggregation||(this.szAggregation=this.szField100?"mean":"sum");if(this.szAggregationFieldA&&!this.fSuppressAggregationScale)for(c=0;c<this.szAggregationFieldA.length;c++){var b=Number(this.szAggregationFieldA[c].split(":")[1]);b&&map.Scale.nTrueMapScale*map.Scale.nZoomScale>b&&(isNaN(parseFloat(this.szAggregationFieldA[c+1]))?this.szAggregationField=this.szAggregationFieldA[c+1]:(this.szAggregationFieldA[c+1].match(/px/)?
this.nGridWidthPx=parseFloat(this.szAggregationFieldA[c+1]):(this.nGridWidth=parseFloat(this.szAggregationFieldA[c+1]),this.nGridWidthPx=0),this.szAggregationField=null));c++}this.fSuppressAggregationScale=!1;this.nWrongRecordLengthCount=0;this.missedA=[];this.coTable&&"genericTable"!=this.coTable||!this.loadTableFromMap()||(this.coTable="genericTable")};
MapTheme.prototype.removeValues=function(){this.missedA=this.quantileA=this.exactSizeA=this.exactCountA=this.chartPosA=this.posItemA=this.itemA=null};
MapTheme.prototype.getMeanMedianQuantile=function(){if(!this.quantileA||!this.quantileA.length)for(var c=0;c<this.nMaxA.length;c++){var b=[],d=0,a;for(a in this.itemA)b.push(this.itemA[a].nValuesA[c]),d+=this.itemA[a].nValuesA[c];this.szFieldsA[c]&&"$item$"!=this.szFieldsA[c]&&b.sort(this.sortUp);var f=Math.round(b.length/2);this.nMedianA[c]=b[f];this.nMeanA[c]=d/b.length;this.quantileA[c]=b}};
MapTheme.prototype.realize=function(){_LOG("theme realize start - "+this.szId);if(this.szFlag.match(/WMS/)){this.chartGroup||(this.chartGroup=map.Dom.newGroup(map.Layer.layerNode,this.szThemesA[0]),map.Layer.listA[this.szThemesA[0]]=new Map.Layer.Item(null),map.Layer.listA[this.szThemesA[0]].szName=this.szThemesA[0],this.isChecked=this.fDone=!0);var c=map.Zoom.getBoundsOfMapInGeoBounds(),b=map.Scale.viewBox.width/map.Zoom.nZoomX,d=map.Scale.viewBox.height/map.Zoom.nZoomY,a=map.Scale.bBox.width/20,
f=map.Scale.bBox.height/20;this.nLayerLower&&map.Scale.nTrueMapScale*map.Scale.nZoomScale<=this.nLayerLower?this.clearWMS():this.nLayerUpper&&map.Scale.nTrueMapScale*map.Scale.nZoomScale>this.nLayerUpper?this.clearWMS():(map.Dom.constructNode("image",this.chartGroup,{"xlink:href":this.szServer+"?f=image&transparent=true&bbox="+c[0].x+","+c[0].y+","+c[1].x+","+c[1].y+"&bboxSR=4326&size="+a+","+f+"",x:-map.Scale.mapCenter.x/map.Zoom.nZoomX-b/2,y:-map.Scale.mapCenter.y/map.Zoom.nZoomY-d/2,style:"width:"+
b+";height:"+d+";opacity:"+(this.nOpacity||.8)+";pointer-events:none;",onload:'map.Themes.getTheme("'+this.szId+'").cleanWMS();'}),this.fDone=!0)}else{if(this.szFlag.match(/CHART/)&&(!this.nChartLower||map.Scale.nTrueMapScale*map.Scale.nZoomScale>this.nChartLower)&&(!this.nChartUpper||map.Scale.nTrueMapScale*map.Scale.nZoomScale<=this.nChartUpper))for(c in b=map.Themes.getAllThemes(),b)if(b[c]!=this&&b[c].szFlag.match(/FEATURE/)&&b[c].szThemesA[0]==this.szThemesA[0]&&!b[c].fDone){this.fRealize=!0;
setTimeout("map.Themes.execute()",500);return}b=new Date;this.fShowProgressBar=!0;this.initValues();if(this.getFields())if(this.loadValues())if(this.szFlag.match(/\bPOSITION\b/)){_LOG("start");var b=this.szThemesA[0],d=this.objThemesA[b],a=d.nFieldItemIndex,f=d.nFieldSelectionIndexA[0],e=d.nFieldSelectionIndexA[1];for(c in d.dbRecords)map.Themes.themeNodesPosA[b+"::"+d.dbRecords[c][a]]=map.Scale.getMapPositionOfLatLon(Number(d.dbRecords[c][f].replace(",",".")),Number(d.dbRecords[c][e].replace(",",
".")));_LOG("stop");this.fDraw=this.fAnalyze=!1;this.fDone=!0}else this.fDone=!1,this.timeLoading=new Date-b,(1E3<this.timeLoading||this.szFlag.match(/VERBOSE/))&&!this.szFlag.match(/SILENT/)?executeWithMessage("map.Themes.executeContinue();",this.szFlag.match(/AGGREGATE/)?"aggregating":"parsing data"):map.Themes.executeContinue();else this.fRemove=!0;else this.fRemove=!0}};MapTheme.prototype.cleanWMS=function(){1<this.chartGroup.childNodes.length&&this.chartGroup.removeChild(this.chartGroup.firstChild)};
MapTheme.prototype.clearWMS=function(){map.Dom.clearGroup(this.chartGroup)};MapTheme.prototype.realize_analyze=function(){var c=new Date;(this.fDraw=this.distributeValues())||this.realizeDone();this.timeAggregating=new Date-c;(1E3<this.timeLoading||this.szFlag.match(/VERBOSE/))&&!this.szFlag.match(/SILENT/)?executeWithMessage("map.Themes.executeContinue();","drawing"):map.Themes.executeContinue()};
MapTheme.prototype.realize_draw=function(){var c=map.Layer.getLayerObj(this.szThemesA[0]);c&&(this.szShapeType=c.szType,"line"==this.szShapeType&&this.szOrigFlag.match(/BUFFER/)&&(this.szShapeType+="+buffer"));this.szOrigFlag.match(/FEATURES/)&&this.szOrigFlag.match(/LINES/)&&(this.szShapeType="line");_LOG("theme draw start - "+this.szId);this.timeStart=new Date;this.nActualFrame=this.nMissingRangeCount=this.nZeroValueCount=this.nRealizedCount=this.nSkipCount=this.nDoneCount=0;c=this.szFlag.match(/VERBOSE/)?
"drawing":"";this.mapSleep=new Map.Sleep("map.Themes.executeContinue",this.nflushPaintShape,map.Dictionary.getLocalText(c));this.mapSleep.nCount=this.nCount;this.mapSleep.szCancel="map.Themes.cancelExecute()";this.szFlag.match(/\bCLIP\b/)&&(this.mapSleep=null,this.nClipIncr=1);this.szFlag.match(/FEATURE/)?(this.mapSleep=null,this.unpaintMap(),this.chartMap()):this.szFlag.match(/CHART/)?(this.mapSleep&&(this.mapSleep.initCheckSleep(this.nflushChartDraw,c),this.mapSleep.fShowProgressBar=!0),this.chartMap()):
(this.unlabelMap(),this.paintMap(),this.makeVisible());this.isChecked=!0;!this.szFlag.match(/CHART/)||this.szFlag.match(/BUBBLE/)||this.szFlag.match(/SQUARE/)||this.szFlag.match(/SYMBOL/)||this.szFlag.match(/BAR/)&&this.colorScheme&&this.nOrigSumA&&this.nOrigSumA.length!=this.colorScheme.length?this.isMarkable=!0:this.isMarkable=!1};MapTheme.prototype.realizeContinue=function(c){this.fMakeLabel?this.labelMap(c):this.szFlag.match(/CHART/)?this.chartMap(c):this.paintMap(c)};
MapTheme.prototype.realizeNextClipFrame=function(){if(this.szFlag.match(/\bCLIP\b/)&&!this.fClipPause){var c=this.szId;this.nActualFrame+=this.nClipIncr;this.nActualFrame>=this.nClipFrames?this.szFlag.match(/BACK/)?(this.nClipIncr=-this.nClipIncr,this.clipTimeout=setTimeout(function(){map.Themes.nextClipFrame(c)},1E3)):this.szFlag.match(/LOOP/)?(this.nActualFrame=-1,this.clipTimeout=setTimeout(function(){map.Themes.nextClipFrame(c)},1E3)):(this.nActualFrame=this.nClipFrames-1,this.pauseClip()):0>
this.nActualFrame?this.szFlag.match(/BACK/)?(this.nClipIncr=-this.nClipIncr,this.clipTimeout=setTimeout(function(){map.Themes.nextClipFrame(c)},10)):(this.nActualFrame=0,this.pauseClip()):(this.mapSleep=null,this.szFlag.match(/CHART/)?(this.chartPosA=[],this.posItemA=[],this.fDone=!1,this.fRedraw=!0,this.chartMap()):this.paintMap(),this.fRedrawInfo=!0)}};
MapTheme.prototype.setClipFrame=function(c){this.fClipPause=!0;this.nActualFrame=Math.min(c,this.nClipFrames);this.mapSleep=null;this.szFlag.match(/CHART/)?(this.chartPosA=[],this.posItemA=[],this.fDone=!1,this.chartMap()):this.paintMap();this.fRedrawInfo=!0};
MapTheme.prototype.startClip=function(c){var b=SVGDocument.getElementById(this.szId+":display:widget:clippausebutton:button");b&&b.style.setProperty("display","inline","");(b=SVGDocument.getElementById(this.szId+":display:widget:clipstartbutton:button"))&&b.style.setProperty("display","none","");this.fClipPause=!1;this.nActualFrame=c||this.nActualFrame;this.realizeNextClipFrame()};
MapTheme.prototype.pauseClip=function(){var c=SVGDocument.getElementById(this.szId+":display:widget:clippausebutton:button");c&&c.style.setProperty("display","none","");(c=SVGDocument.getElementById(this.szId+":display:widget:clipstartbutton:button"))&&c.style.setProperty("display","inline","");this.clipTimeout&&clearTimeout(this.clipTimeout);this.fClipPause=!0};
MapTheme.prototype.realizeDone=function(){var c=this.szId;this.nRefreshTimeout&&(this.refreshTimeout&&clearTimeout(this.refreshTimeout),this.refreshTimeout=setTimeout(function(){map.Themes.refreshTheme(c)},this.nRefreshTimeout));if(this.szFlag.match(/\bCLIP\b/)){this.szFlag.match(/\bPAUSE\b/)&&(this.removeDefinitionFromFlag("PAUSE"),this.fClipPause=!0);if(this.szFlag.match(/\bLAST\b/)){this.removeDefinitionFromFlag("LAST");var b=this.nClipFrames-1;setTimeout(function(){map.Themes.setClipFrame(c,b)},
10)}this.clipTimeout&&clearTimeout(this.clipTimeout);this.clipTimeout=setTimeout(function(){map.Themes.nextClipFrame(c)},this.nActualFrame?this.nClipTimeout:1E3)}this.nWrongRecordLengthCount&&fDebug&&displayMessage("Data Error:  "+this.nWrongRecordLengthCount+" items have wrong record length",1E4,"notify");this.fRealize=this.fRedraw=!1;this.fDone=!0;this.timeRealizing=new Date-this.timeStart;_LOG("theme done - "+this.szId);this.szFlag.match(/SHOW/)&&(this.removeDefinitionFromFlag("SHOW"),this.zoomTo());
map.Themes.realizeDone(this)};MapTheme.prototype.beginDraw=function(){};MapTheme.prototype.endDraw=function(){};
MapTheme.prototype.redraw=function(c){if(!this.szFlag.match(/FEATURE/)){this.clipTimeout&&clearTimeout(this.clipTimeout);this.fDataIncomplete&&this.__themeNodes!=map.Themes.themeNodes&&(this.fDataIncomplete=!1,this.initValues(),this.loadValues(),this.distributeValues());if(this.szFlag.match(/CHART/)){if(this.fClipCharts||this.fRedraw)this.nMissingPositionCount=this.nMissingRangeCount=this.nZeroValueCount=this.nRealizedCount=this.nDoneCount=this.nSkipCount=0,this.chartMap()}else if(this.isChecked){if(this.partsA)for(var b=
0;b<this.partsA.length;b++)this.partsA[b].nCount=0,this.partsA[b].nSum=0;this.mapSleep&&this.mapSleep.initCheckSleep(this.nflushPaintShape,"painting map");this.makeVisible();this.paintMap()}c&&this.enable()}};
MapTheme.prototype.toFront=function(){if(this.szFlag.match(/CHART/)){this.chartGroup.parentNode.appendChild(this.chartGroup);var c=getMatrix(this.chartGroup);c&&setMatrix(this.chartGroup,c);this.enable()}else if(this.isChecked){for(c=0;c<this.partsA.length;c++)this.partsA[c].nCount=0,this.partsA[c].nSum=0;this.mapSleep&&this.mapSleep.initCheckSleep(this.nflushPaintShape,"painting map");this.paintMap()}else this.enable()};
MapTheme.prototype.getFields=function(){for(var c=0;c<this.szThemesA.length;c++){var b=this.szThemesA[c];this.objThemesA[b]=new ObjTheme(b,c,this.coTable,this.szSelectionField,this.szItemField);this.objThemesA[b].theme=this;if(!this.objThemesA[b].getFields()){try{HTMLWindow.ixmaps.htmlgui_onErrorTheme(b)}catch(d){}return!1}}return!0};
MapTheme.prototype.addItemValues=function(c,b,d,a,f){if(!this.szFlag.match(/RAW/)||d|a|f){var e;if(this.szExcludeA)for(e=0;e<this.szExcludeA.length;e++)if(c.split("::")[1]==this.szExcludeA[e])return;if(!(this.nField100Min&&d&&d<this.nField100Min)){if(this.nMinValue&&b&&!d){var g=!1;for(e=b.length-1;0<=e;e--)b[e]>=this.nMinValue&&(g=!0);if(!g)return}g=1;if(this.__fDensity||this.__fDensityAlpha)if(g=this.getNodeArea(c),!g&&this.__fTiledLayer){this.fDataIncomplete=!0;return}if(this.szWeights)for(e=0;e<
b.length;e++)b[e]*=this.szWeightsA[e]||this.szWeightsA[0];if(this.__fAuto100){for(e=d=0;e<b.length;e++)d+=b[e]||0;this.fField100=!0}this.itemA[c]={nOrigValuesA:[],nValuesA:b,nValue100:d,nValueSum:0};for(e=0;e<b.length;e++){this.itemA[c].nOrigValuesA[e]=isNaN(b[e])?0:b[e];this.itemA[c].nValueSum+=b[e]||0;if(this.fField100)if(d){var l=b[e];0!==l||this.szFlag.match(/ZEROISVALUE/)?"!"==this.szFieldsA[e].substr(0,1)?(l=d-l,this.itemA[c].nOrigValuesA[e]=l):this.szFlag.match(/CALCVAL/)||this.szFlag.match(/CALC100/)?
(l=d?Math.round(l*d/100):l,this.itemA[c].nOrigValuesA[e]=l):this.szFlag.match(/PRODUCT/)?l=d?l*d:l:this.szFlag.match(/DIFFERENCE/)&&1==b.length&&!this.szFlag.match(/RELATIVE/)?(d=0<e?b[e-1]:this.itemA[c].nValue100,l-=d):(l=d?l/d:1,this.szFlag.match(/FRACTION/)?l*=this.nFractionScale||1:this.szFlag.match(/PERMILLE/)?l*=1E3:(l*=100,0<l&&this.szFlag.match(/RELATIVE/)?l-=100:0<l&&this.szFlag.match(/INVERT/)&&(l=100-l))):l=0;b[e]=l}else b[e]=0;this.__fDensity&&(b[e]=g?b[e]/g:null)}if(this.__fDifference&&
1<b.length){for(e=0;e<b.length;e++)e<b.length-1?(l=b[e],b[e]=b[e+1]-b[e],this.szFlag.match(/RELATIVE/)&&(b[e]*=100/l)):this.szFlag.match(/STACKED/)||(b[e]=0);b.pop()}for(e=0;e<b.length;e++){if(!this.nSumA)return;!isNaN(b[e])&&isFinite(b[e])&&(this.nMin=Math.min(this.nMin,b[e]),this.nMax=Math.max(this.nMax,b[e]),this.nSum+=b[e],this.nMinA[e]=Math.min(this.nMinA[e],b[e]),this.nMaxA[e]=Math.max(this.nMaxA[e],b[e]),this.nSumA[e]+=b[e],this.nOrigMinA[e]=Math.min(this.nOrigMinA[e],this.itemA[c].nOrigValuesA[e]),
this.nOrigMaxA[e]=Math.max(this.nOrigMaxA[e],this.itemA[c].nOrigValuesA[e]),this.nOrigSumA[e]+=this.itemA[c].nOrigValuesA[e]);0>b[e]&&(this.fNegativeValues=!0)}!isNaN(d)&&isFinite(d)&&(this.nMin100=Math.min(this.nMin100,d),this.nMax100=Math.max(this.nMax100,d),this.nSum100+=d);this.szSizeField&&(!isNaN(a)&&isFinite(a)?(this.itemA[c].nSize=a,this.nMinSize=Math.min(this.nMinSize,a),this.nMaxSize=Math.max(this.nMaxSize,a),this.nSumSize+=a):this.itemA[c].nSize=0);this.szAlphaField&&null!=f&&!isNaN(f)&&
isFinite(f)&&(this.__fDensityAlpha&&(f=g?Math.min(f/g,5E4):0),this.itemA[c].nAlpha=f,this.nMinAlpha=Math.min(this.nMinAlpha,f),this.nMaxAlpha=Math.max(this.nMaxAlpha,f),this.nSumAlpha+=f);if(this.__fExact&&this.exactCountA)for(e=0;e<b.length;e++)b[e]&&(this.exactCountA[b[e]-1]?(this.exactCountA[b[e]-1]++,this.exactSizeA[b[e]-1]+=this.itemA[c].nSize||1):(this.exactCountA[b[e]-1]=1,this.exactSizeA[b[e]-1]=this.itemA[c].nSize||1));this.nCount++}}else{this.itemA[c]={nOrigValuesA:[],nValuesA:b,nValue100:d,
nValueSum:0};for(e=0;e<b.length;e++){if(!this.nSumA)return;isNaN(b[e])||(this.nMin=Math.min(this.nMin,b[e]),this.nMax=Math.max(this.nMax,b[e]),this.nSum+=b[e]);0>b[e]&&(this.fNegativeValues=!0);this.__fExact&&this.exactCountA&&b[e]&&(this.exactCountA[b[e]-1]?(this.exactCountA[b[e]-1]++,this.exactSizeA[b[e]-1]+=this.itemA[c].nSize||1):(this.exactCountA[b[e]-1]=1,this.exactSizeA[b[e]-1]=this.itemA[c].nSize||1))}this.nCount++}};
MapTheme.prototype.getStringValueIndex=function(c,b){if(0===c.length||" "==c)if(this.szFlag.match(/UNDEFINEDISVALUE/))c="undefined";else return-1;this.szFlag.match(/IGNORECASE/)&&(c=c.toUpperCase());c=c.trim();"undefined"!=typeof this.nStringToValueA[c]||this.szValuesA&&this.szValuesA.length&&"set"!=b||(this.szLabelA=this.szLabelA||[],this.szExactA=this.szExactA||[],this.nStringToValueA[c]=this.nStringToValue,this.szLabelA[this.nStringToValue-1]=this.szLabelA[this.nStringToValue-1]||c,this.szExactA.push(this.nStringToValue),
this.nStringToValue++);return this.nStringToValueA[c]};MapTheme.prototype.checkHiddenLayerState=function(){for(var c=0;c<this.szThemesA.length;c++)if(map.Layer.isScaleDependentLayer(this.szThemesA[c])&&(this.hiddenLayerA[this.szThemesA[c]]&&map.Layer.isScaleDependentLayerOn(this.szThemesA[c])||!this.hiddenLayerA[this.szThemesA[c]]&&!map.Layer.isScaleDependentLayerOn(this.szThemesA[c])))return!0;return!1};
var __scanValue=function(c){return String(c).match(/,/)?parseFloat(String(c).replace(/\./gi,"").replace(/,/gi,".")):parseFloat(String(c).replace(/ /gi,""))};
MapTheme.prototype.loadValues=function(){this.nMissingLookupCount=0;this.__fExact=this.szFlag.match(/CATEGORICAL/);this.__fMax=this.szFlag.match(/\bMAX\b/);this.__fDifference=this.szFlag.match(/DIFFERENCE/);this.__fFilter=this.szFilter&&this.szFilter.length;this.__fDensity=this.szFlag.match(/DENSITY/);this.__fDensityAlpha=!this.szFlag.match(/CHART/)&&this.szAlphaField100&&this.szAlphaField100.match(/\$density\$/i);this.__fAggregate=this.szFlag.match(/AGGREGATE/);this.__fAuto100=this.szFlag.match(/AUTO100/)&&
!this.szFlag.match(/AGGREGATE/);this.__fTiledLayer=map.Layer.getLayerObj(this.szThemesA[0])?map.Layer.getLayerObj(this.szThemesA[0]).szFlag.match(/tiled/):!1;this.__themeNodes=map.Themes.themeNodes;for(var c=0;c<this.szThemesA.length;c++)if(map.Layer.isScaleDependentLayer(this.szThemesA[c])&&!map.Layer.isScaleDependentLayerOn(this.szThemesA[c]))this.fRealize=this.hiddenLayerA[this.szThemesA[c]]=!0;else if(this.hiddenLayerA[this.szThemesA[c]]=!1,!this.loadValuesOfTheme(this.szThemesA[c]))return!1;
return!0};
MapTheme.prototype.filterValues=function(c){if(this.szFilter.match(/WHERE/)){if(!this.objTheme.filterQueryA){for(var b=this.szFilter.split("WHERE ")[1].split(" "),d=0;d<b.length;d++)if(b[d].length){if('"'==b[d][0]&&'"'!=b[d][b[d].length-1]){do b[d]=b[d]+" "+b[d+1],b.splice(d+1,1);while('"'!=b[d][b[d].length-1])}if("("==b[d][0]&&")"!=b[d][b[d].length-1]){do b[d]=b[d]+" "+b[d+1],b.splice(d+1,1);while(")"!=b[d][b[d].length-1])}}else b.splice(d,1),d--;this.objTheme.filterQueryA=[];var a={};do{var f=0;
3<=b.length&&(a={},a.szFilterField=b[0].replace(/("|)/g,""),a.szFilterOp=b[1],a.szFilterValue=b[2].replace(/("|)/g,""),f=3);"BETWEEN"==a.szFilterOp&&5<=b.length&&"AND"==b[3]&&(a.szFilterValue2=b[4].replace(/("|)/g,""),f=5);if(f){for(d=0;d<this.objTheme.dbFields.length;d++)this.objTheme.dbFields[d].id==a.szFilterField&&(a.nFilterFieldIndex=d),"$"+this.objTheme.dbFields[d].id+"$"==a.szFilterValue&&(a.nFilterValueIndex=d);this.objTheme.filterQueryA.push(a);b.splice(0,f)}else{alert("ixmaps - filter error - incomplete query!\nquery: "+
this.szFilter);break}if(b.length&&"AND"==b[0])b.splice(0,1);else break}while(b.length)}for(var e in this.objTheme.filterQueryA)if(this.__szValue=String(this.objTheme.dbRecords[c][this.objTheme.filterQueryA[e].nFilterFieldIndex]),this.__szFilterOp=this.objTheme.filterQueryA[e].szFilterOp.toUpperCase(),this.__szFilterValue=this.objTheme.filterQueryA[e].szFilterValue,this.__szFilterValue2=this.objTheme.filterQueryA[e].szFilterValue2,null!=this.objTheme.filterQueryA[e].nFilterValueIndex&&(this.__szFilterValue=
String(this.objTheme.dbRecords[c][this.objTheme.filterQueryA[e].nFilterValueIndex])),b=!0,b=__scanValue(this.__szValue),b="="==this.__szFilterOp?this.__szValue==this.__szFilterValue||b==Number(this.__szFilterValue):"!="==this.__szFilterOp?!(this.__szValue==this.__szFilterValue||b==Number(this.__szFilterValue)):"<>"==this.__szFilterOp?!(this.__szValue==this.__szFilterValue||b==Number(this.__szFilterValue)):">"==this.__szFilterOp?b>Number(this.__szFilterValue):"<"==this.__szFilterOp?b<Number(this.__szFilterValue):
">="==this.__szFilterOp?b>=Number(this.__szFilterValue):"<="==this.__szFilterOp?b<=Number(this.__szFilterValue):"LIKE"==this.__szFilterOp?"*"==this.__szFilterValue?this.__szValue.length:eval("this.__szValue.match(/"+this.__szFilterValue.replace(/\//gi,"\\/")+"/i)"):"NOT"==this.__szFilterOp?eval("!this.__szValue.match(/"+this.__szFilterValue.replace(/\//gi,"\\/")+"/i)"):"IN"==this.__szFilterOp?eval("this.__szFilterValue.match(/\\("+this.__szValue.replace(/\//gi,"\\/")+"\\)/)")||eval("this.__szFilterValue.match(/\\("+
this.__szValue.replace(/\//gi,"\\/")+"\\,/)")||eval("this.__szFilterValue.match(/\\,"+this.__szValue.replace(/\//gi,"\\/")+"\\,/)")||eval("this.__szFilterValue.match(/\\,"+this.__szValue.replace(/\//gi,"\\/")+"\\)/)"):"BETWEEN"==this.__szFilterOp?b>=Number(this.__szFilterValue)&&b<=Number(this.__szFilterValue2):eval("this.__szValue.match(/"+this.__szFilterValue.replace(/\//gi,"\\/")+"/i)"),!b)return!1}else if(this.__szValue=this.objTheme.dbRecords[c].join(" "),!eval("this.__szValue.match(/"+this.szFilter+
"/i)"))return!1;return!0};
MapTheme.prototype.getSelectionId=function(c,b){if(!this.fSelection){this.fSelection="lookup";if(this.objTheme.nFieldSelectionIndexA&&1<this.objTheme.nFieldSelectionIndexA.length)this.fSelection=this.szCRSDatum?"UTM":"LatLon",this.nSelection_0=this.objTheme.nFieldSelectionIndexA[0],this.nSelection_1=this.objTheme.nFieldSelectionIndexA[1];else if(0<=this.objTheme.nFieldSelectionIndex){var d=__mpap_decode_utf8(String(this.objTheme.dbRecords[b][this.objTheme.nFieldSelectionIndex]));d.match(/MultiPoint/)?
this.fSelection="MultiPoint":d.match(/Point/i)?this.fSelection="MultiPoint":d.match(/LineString/)?this.fSelection="LineString":d.match(/MultiLineString/)?this.fSelection="MultiLineString":d.match(/Polygon/)?this.fSelection="MultiPolygon":d.match(/MultiPolygon/)&&(this.fSelection="MultiPolygon")}this.objTheme.nFieldSelection2IndexA&&1<this.objTheme.nFieldSelection2IndexA.length?(this.fSelection2=this.szCRSDatum?"UTM":"LatLon",this.nSelection2_0=this.objTheme.nFieldSelection2IndexA[0],this.nSelection2_1=
this.objTheme.nFieldSelection2IndexA[1]):"undefined"!=typeof this.objTheme.nFieldSelection2Index&&(d=__mpap_decode_utf8(String(this.objTheme.dbRecords[b][this.objTheme.nFieldSelection2Index])),d.match(/MultiPoint/)?this.fSelection2="MultiPoint":d.match(/Point/)?this.fSelection2="MultiPoint":this.fSelection2="mapshape")}if("LatLon"==this.fSelection||"UTM"==this.fSelection)return c+"::"+(String(this.objTheme.dbRecords[b][this.nSelection_0]).replace(/,/g,".")+","+String(this.objTheme.dbRecords[b][this.nSelection_1]).replace(/,/g,
"."))+(this.szSelectionFieldSuffix||"").replace(/,/g,".");if("Point"==this.fSelection||"MultiPoint"==this.fSelection){var d=this.objTheme.dbRecords[b][this.objTheme.nFieldSelectionIndex],a=null;return(a=d.match(positionRegExp))?c+"::"+(a[2]+","+a[1])+(this.szSelectionFieldSuffix||""):null}return"LineString"==this.fSelection||"MultiLineString"==this.fSelection||"Polygon"==this.fSelection||"MultiPolygon"==this.fSelection?c+"::"+String(b)+(this.szSelectionFieldSuffix||""):0<=this.objTheme.nFieldSelectionIndex?
(d=__mpap_decode_utf8(String(this.objTheme.dbRecords[b][this.objTheme.nFieldSelectionIndex])),this.nSelectionFieldDigits&&(d=("000000000000000"+d).slice(-this.nSelectionFieldDigits)),this.fSelectionFieldToNumber&&(d=String(Number(d))),this.fSelectionFieldToUpper&&(d=String(d).toUpperCase()),c+"::"+d+(this.szSelectionFieldSuffix||"")):null};
MapTheme.prototype.loadValuesOfTheme=function(c){if(this.szFlag.match(/FAST/)||this.szFlag.match(/VECTOR/)||this.szFlag.match(/BEZIER/)||"undefined"!=typeof this.szSelectionField2||this.szFlag.match(/AGGREGATE/)&&!this.szFlag.match(/COMPATIBLE|PERCENTOFMEAN/))return this.__fAggregateOnLoad=!0,this.loadAndAggregateValuesOfTheme(c);var b,d,a,f,e;this.fNegativeValues=this.fField100=!1;this.szUnit=(this.szUnits?"."==this.szUnits.substr(0,1)?"":" ":"")+(this.szUnits||"");var g=!0;this.objTheme=this.objThemesA[c];
0<this.objTheme.nField100Index&&(this.fField100=!0);if(this.objTheme.dbTable&&c&&c.length){if(this.coTable){try{eval("this.objTheme.dbRecords = "+this.coTable+".records")}catch(l){eval("this.objTheme.dbRecords = "+this.coTable+"_records")}if(!this.objTheme.dbRecords)return displayMessage("Data "+this.coTable+" could not be loaded!",2E3,!0),!1}else try{eval("this.objTheme.dbRecords = "+c+".records")}catch(n){eval("this.objTheme.dbRecords = "+c+"_records")}this.objTheme.nFieldSelectionIndexA.length||
delete this.objTheme.nFieldSelectionIndexA;if("$item$"!=this.szFieldsA[0]&&!this.szFlag.match(/CATEGORICAL/))for(f=Math.min(40,this.objTheme.dbRecords.length),b=0;b<f;b++)if(this.objTheme.dbRecords[b])for(d=0;d<this.szFieldsA.length;d++)if(a=this.objTheme.dbRecords[b][this.objTheme.nFieldIndexA[d]],__scanValue(a)!=parseFloat(a)){this.__fScanValue=!0;b=f;break}for(b=0;b<this.objTheme.dbRecords.length;b++)if(!this.objTheme.dbRecords[b]||this.objTheme.dbRecords[b].length<this.objTheme.dbFields.length)this.nWrongRecordLengthCount++;
else if(!this.__fFilter||this.filterValues(b)){f=[];if("$item$"==this.szFieldsA[0])f[0]=1;else if("$index$"==this.szFieldsA[0])f[0]=b+1;else for(d=0;d<this.szFieldsA.length;d++){a=this.objTheme.dbRecords[b][this.objTheme.nFieldIndexA[d]];this.__fExact?(a=this.valueMap?this.valueMap[String(a)]:a,a=this.getStringValueIndex(String(a))):a=this.__fScanValue?__scanValue(a):parseFloat(a);if(isNaN(a))if(this.fUndefinedValuePossible)a=0;else continue;if(0!==a||this.fNullIsValue)0>a&&!this.fNegativeValuePossible||
(f[d]=a)}f.length=this.szFieldsA.length;e="$item$"==this.szField100?1:0>this.objTheme.nField100Index?0:__scanValue(this.objTheme.dbRecords[b][this.objTheme.nField100Index]);0!==e||this.fNullIsValue||(e=null);0>e&&!this.fNegativeValuePossible&&(e=null);var k=null;if(this.szSizeField&&"$item$"!=this.szSizeField){k=this.objTheme.dbRecords[b][this.objTheme.nSizeFieldIndex];k=this.valueMap?this.valueMap[String(k)]||__scanValue(k):__scanValue(k);k=isFinite(k)&&!isNaN(k)?k:0;if(0===k)continue;if(0>k)continue}else k=
1;var q=null;this.szAlphaField&&(q=__scanValue(this.objTheme.dbRecords[b][this.objTheme.nAlphaFieldIndex]),isNaN(q)&&(q=0));this.szAlphaField100&&this.objTheme.nAlphaField100Index&&(q*=100/__scanValue(this.objTheme.dbRecords[b][this.objTheme.nAlphaField100Index]),isNaN(q)&&(q=0));if(a=d=this.getSelectionId(c,b)){0<=this.objTheme.nFieldItemIndex&&this.objTheme.nFieldItemIndex!=this.objTheme.nFieldSelectionIndex&&(d=__mpap_decode_utf8(String(this.objTheme.dbRecords[b][this.objTheme.nFieldItemIndex])),
this.fSelectionFieldToUpper&&(d=String(d).toUpperCase()),d=c+"::"+d);if(this.itemA[d]){if(this.szFlag.match(/DOT/))continue;d+="*"+Math.random();if(this.itemA[d])continue}this.addItemValues(d,f,e,k,q);this.itemA[d]&&(this.szColorField&&(this.itemA[d].szColor="$index$"==this.szColorField?b+1:__mpap_decode_utf8(this.objTheme.dbRecords[b][this.objTheme.nColorFieldIndex])),this.szSymbolField&&(this.itemA[d].szSymbol="$index$"==this.szSymbolField?b+1:__mpap_decode_utf8(this.objTheme.dbRecords[b][this.objTheme.nSymbolFieldIndex])),
this.szValueField&&(this.itemA[d].szValue="$index$"==this.szValueField?b+1:__mpap_decode_utf8(this.objTheme.dbRecords[b][this.objTheme.nValueFieldIndex])),this.szTimeField&&(this.itemA[d].szTime="$index$"==this.szTimeField?b+1:__mpap_decode_utf8(this.objTheme.dbRecords[b][this.objTheme.nTimeFieldIndex]),isNaN(this.itemA[d].szTime)&&(this.itemA[d].szTime=this.itemA[d].szTime.replace(/ - /g,""))),this.szLabelField&&(this.itemA[d].szLabel="$index$"==this.szLabelField?b+1:__mpap_decode_utf8(this.objTheme.dbRecords[b][this.objTheme.nLabelFieldIndex])),
this.szTitleField&&(this.itemA[d].szTitle=__mpap_decode_utf8(this.objTheme.dbRecords[b][this.objTheme.nTitleFieldIndex])),this.szSnippetField&&(this.itemA[d].szSnippet=__mpap_decode_utf8(this.objTheme.dbRecords[b][this.objTheme.nSnippetFieldIndex])),this.itemA[d].szSelectionId=a?a:d,this.szAggregationField&&(this.itemA[d].szAggregation=__mpap_decode_utf8(this.objTheme.dbRecords[b][this.objTheme.nAggregationFieldIndex])),this.szXField&&(this.itemA[d].nX=__scanValue(this.objTheme.dbRecords[b][this.objTheme.nXFieldIndex]),
isNaN(this.itemA[d].nX)||(this.nMinX=Math.min(this.nMinX,this.itemA[d].nX),this.nMaxX=Math.max(this.nMaxX,this.itemA[d].nX),this.nSumX+=this.itemA[d].nXField)),this.szYField&&(this.itemA[d].nY=__scanValue(this.objTheme.dbRecords[b][this.objTheme.nYFieldIndex]),isNaN(this.itemA[d].nY)||(this.nMinY=Math.min(this.nMinY,this.itemA[d].nY),this.nMaxY=Math.max(this.nMaxY,this.itemA[d].nY),this.nSumY+=this.itemA[d].nYField)),this.itemA[d].dbIndex=b)}else this.nMissingLookupCount++}}else g=!1;if(g)return this.fAnalyze=
!0};
MapTheme.prototype.loadAndAggregateValuesOfTheme=function(c,b){var d,a,f,e,g,l,n,k,q;if(!b){console.log("*** F A S T ***");this.fNegativeValues=this.fField100=!1;this.__fMultiParts=this.szFlag.match(/CATEGORICAL/)&&!(this.szFlag.match(/PIE/)||this.szFlag.match(/BAR/)||this.szFlag.match(/SEQUENCE/)||this.szFlag.match(/PLOT/)||this.szFlag.match(/DOMINANT/)||this.szFlag.match(/COMPOSECOLOR/)||this.szFlag.match(/\bUSER\b/)||this.szFlag.match(/WAFFLE/));this.__fClipToGeoBounds=!1;this.szFlag.match(/CLIPTOGEOBOUNDS/)&&map.Scale.nTrueMapScale*
map.Scale.nZoomScale<(this.nClipUpper||1E9)&&(this.__fClipToGeoBounds=!0);this.szUnit=(this.szUnits?"."==this.szUnits.substr(0,1)?"":" ":"")+(this.szUnits||"");this.objTheme=this.objThemesA[c];0<this.objTheme.nField100Index&&(this.fField100=!0);if(!(this.objTheme.dbTable&&c&&c.length))return!1;if(this.coTable){try{eval("this.objTheme.dbRecords = "+this.coTable+".records")}catch(h){eval("this.objTheme.dbRecords = "+this.coTable+"_records")}if(!this.objTheme.dbRecords)return displayMessage("Data "+
this.coTable+" could not be loaded!",2E3,!0),!1}else try{eval("this.objTheme.dbRecords = "+c+".records")}catch(u){eval("this.objTheme.dbRecords = "+c+"_records")}this.objTheme.nFieldSelectionIndexA.length||delete this.objTheme.nFieldSelectionIndexA;if(this.szFlag.match(/ZOOMTO/)){this.getSelectionId(c,0);for(f=0;f<this.objTheme.dbRecords.length;f++)"UTM"==this.fSelection?D=map.Scale.getMapPositionOfUTM(parseFloat(String(this.objTheme.dbRecords[f][this.nSelection_0]).replace(/\,/g,".")),parseFloat(String(this.objTheme.dbRecords[f][this.nSelection_1]).replace(/\,/g,
".")),this.szCRSDatum,this.szCRSUTMZone):"LatLon"==this.fSelection?D=map.Scale.getMapPositionOfLatLon(parseFloat(String(this.objTheme.dbRecords[f][this.nSelection_0]).replace(/\,/g,".")),parseFloat(String(this.objTheme.dbRecords[f][this.nSelection_1]).replace(/\,/g,"."))):"Point"==this.fSelection||"MultiPoint"==this.fSelection||"LineString"==this.fSelection||"MultiLineString"==this.fSelection?(g=this.objTheme.dbRecords[f][this.objTheme.nFieldSelectionIndex],k=g.match(positionRegExp),D=map.Scale.getMapPositionOfLatLon(parseFloat(k[2]),
parseFloat(k[1]))):(g=this.objTheme.dbRecords[f][this.objTheme.nFieldSelectionIndex],this.fSelectionFieldToUpper&&(g=String(g).toUpperCase()),D=this.getNodePosition(c+"::"+g)),D&&(this.itemA[c+"::"+String(D.x)+","+String(D.y)]={ptPos:D});this.zoomTo();this.itemA=[];this.removeDefinitionFromFlag("ZOOMTO")}this.createChartGroup(map.Layer.objectGroup);if("$item$"!=this.szFieldsA[0]&&!this.szFlag.match(/CATEGORICAL/)){var w=Math.min(40,this.objTheme.dbRecords.length);for(f=0;f<w;f++)if(this.objTheme.dbRecords[f])for(e=
0;e<this.szFieldsA.length;e++){var p=this.objTheme.dbRecords[f][this.objTheme.nFieldIndexA[e]];if(__scanValue(p)!=parseFloat(p)){this.__fScanValue=!0;f=w;break}}}"$item$"==this.szSizeField&&(this.oldSizefield=this.szSizeField,this.szSizeField=null);this.nGridWidthPx&&(this.nGridWidth=f=map.Scale.getDistanceInMeter(1E3,1E3,1E3+map.Scale.normalX(this.nGridWidthPx),1E3));this.nGridMatrix&&(f=map.Zoom.getBox(),f=map.Scale.getDistanceInMeter(1E3,1E3,1E3+f.width,1E3),this.nGridWidth=f/(this.nGridMatrix||
20)/map.Scale.nZoomScale);this.nGridWidthMap=this.nGridWidth?Math.round(map.Scale.getDeltaXofDistanceInMeter(this.nGridWidth)/20)*map.Scale.nZoomScale*20:0;this.nGridWidth&&!this.nGridWidthMap&&(this.nGridWidthMap=this.nGridWidth?map.Scale.getDeltaXofDistanceInMeter(this.nGridWidth)*map.Scale.nZoomScale:0);this.nGridWidthPx||(this.nGridWidthMap=this.nGridWidth?map.Scale.getDeltaXofDistanceInMeter(this.nGridWidth)*map.Scale.nZoomScale:0,f=Math.pow(10,Math.floor(Math.log10(1/map.Scale.nZoomScale))),
this.nGridWidthMap=Math.round(this.nGridWidthMap*f)/f);this.dY=this.dX=0;this.szFlag.match(/FIXGRID/)&&(this.dX=map.Scale.mapCenter.x*map.Scale.nZoomScale,this.dY=map.Scale.mapCenter.y*map.Scale.nZoomScale);this.nGridOffsetX&&(this.dX-=this.nGridWidthMap/100*this.nGridOffsetX);this.nGridOffsetY&&(this.dY+=this.nGridWidthMap/100*this.nGridOffsetY);this.nHexaWidth=1.15*this.nGridWidthMap;this.nHexaHalf=1.15*this.nGridWidthMap/2;this.nHexa4th=this.nGridWidthMap/4;this.getSelectionId(c,0);this.aggregationCount=
0;this.nMin=Number.MAX_VALUE;this.nMax=-Number.MAX_VALUE;this.nMinSize=Number.MAX_VALUE;this.nMaxSize=-Number.MAX_VALUE;this.nSumSize=0;this.nMinAlpha=Number.MAX_VALUE;this.nMaxAlpha=-Number.MAX_VALUE;this.nSumAlpha=0;if(this.__fExact)this.nMinA=[],this.nMaxA=[],this.nSumA=[],this.nOrigMinA=[],this.nOrigMaxA=[],this.nOrigSumA=[],this.nMedianA=[],this.nMeanA=[],this.nCountA=[];else for(a=0;a<this.szFieldsA.length;a++)this.nMinA[a]=Number.MAX_VALUE,this.nMaxA[a]=-Number.MAX_VALUE,this.nSumA[a]=0,this.nOrigMinA[a]=
Number.MAX_VALUE,this.nOrigMaxA[a]=-Number.MAX_VALUE,this.nOrigSumA[a]=0,this.nMedianA[a]=0,this.nMeanA[a]=0;this.nEmptyValuesA=[];for(var t in this.szValuesA)this.nEmptyValuesA.push(0);this.szFlag.match(/DUMP/)&&(this.nChartGroupScale=fObjectScaling?(this.nAutoScale||this.nScale)*map.Layer.nObjectScale*map.Scale.nObjectScaling:(this.nAutoScale||this.nScale)*map.Scale.nFeatureScaling*map.Scale.nObjectScaling,this.chartGroup=map.Dom.newGroup(map.Layer.objectGroup,this.szId+":chartgroup"));if(!this.szWeightsA)for(this.szWeightsA=
[],a=0;a<this.szFieldsA.length;a++)this.szWeightsA.push(1);else if(this.szWeightsA.length&&this.szWeightsA.length!=this.szFieldsA.length)for(f=this.szWeightsA[this.szWeightsA.length-1],a=this.szWeightsA.length;a<this.szFieldsA.length;a++)this.szWeightsA.push(f)}if(this.szAggregationUpper&&map.Scale.nTrueMapScale*map.Scale.nZoomScale>this.nAggregationUpper||this.szAggregationLower&&map.Scale.nTrueMapScale*map.Scale.nZoomScale<this.nAggregationLower)this.__fAggregate=!1;t=map.Zoom.getBoundsOfMapInGeoBounds();
var w=map.Zoom.getBox(),M=2E5<this.objTheme.dbRecords.length;for(f=b||0;f<this.objTheme.dbRecords.length;f++){if(M&&f>(b||0)&&0===f%5E4)return this.fContinueLoadAndAggregate=!0,this.continueIndex=f,this.szThemeLayer=c,displayMessage(__formatValue(f/this.objTheme.dbRecords.length*100,0)+"% "+map.Dictionary.getLocalText("aggregated")),displayProgressBar(f,this.objTheme.dbRecords.length,""),setTimeout(function(){map.Themes.executeContinue()},10),!0;if(!this.objTheme.dbRecords[f]||this.objTheme.dbRecords[f].length<
this.objTheme.dbFields.length)this.nWrongRecordLengthCount++;else if(!this.__fFilter||this.filterValues(f)){if(this.__fClipToGeoBounds&&"LatLon"==this.fSelection&&(g=parseFloat(String(this.objTheme.dbRecords[f][this.nSelection_0]).replace(/\,/g,".")),D=parseFloat(String(this.objTheme.dbRecords[f][this.nSelection_1]).replace(/\,/g,".")),D<t[0].x||D>t[1].x||g<t[0].y||g>t[1].y))continue;var D=null,y=null;"UTM"==this.fSelection?g=(D=map.Scale.getMapPositionOfUTM(parseFloat(String(this.objTheme.dbRecords[f][this.nSelection_0]).replace(/\,/g,
".")),parseFloat(String(this.objTheme.dbRecords[f][this.nSelection_1]).replace(/\,/g,".")),this.szCRSDatum,this.szCRSUTMZone))?String(D.x)+","+String(D.y):"":"LatLon"==this.fSelection?g=(D=map.Scale.getMapPositionOfLatLon(parseFloat(String(this.objTheme.dbRecords[f][this.nSelection_0]).replace(/\,/g,".")),parseFloat(String(this.objTheme.dbRecords[f][this.nSelection_1]).replace(/\,/g,"."))))?String(D.x)+","+String(D.y):"":"Point"==this.fSelection||"MultiPoint"==this.fSelection||"LineString"==this.fSelection||
"MultiLineString"==this.fSelection?(g=this.objTheme.dbRecords[f][this.objTheme.nFieldSelectionIndex],(k=String(g).match(positionRegExp))&&(D=map.Scale.getMapPositionOfLatLon(parseFloat(k[2]),parseFloat(k[1])))):(g=this.objTheme.dbRecords[f][this.objTheme.nFieldSelectionIndex],this.fSelectionFieldToUpper&&(g=String(g).toUpperCase()),this.nSelectionFieldDigits&&(g=("000000000000000"+g).slice(-this.nSelectionFieldDigits)),this.fSelectionFieldToNumber&&(g=String(Number(g))),D=this.getNodePosition(c+"::"+
g));this.szFlag.match(/DUMP/)&&(k=map.Dom.newGroup(this.chartGroup,this.szId+":"+g+":chart"),k.fu.setMatrix([this.nChartGroupScale,0,0,this.nChartGroupScale,D.x,D.y]),map.Dom.newShape("circle",k,0,0,map.Scale.normalX(3),"fill:blue;fill-opacity:0.2;stroke:none;"));if(!D||isNaN(D.x)||isNaN(D.y))this.fDataIncomplete=!0;else{var m=D,v=null;l=null;if(this.fSelection2){if("UTM"==this.fSelection2)l=(v=map.Scale.getMapPositionOfUTM(parseFloat(String(this.objTheme.dbRecords[f][this.nSelection2_0]).replace(/\,/g,
".")),parseFloat(String(this.objTheme.dbRecords[f][this.nSelection2_1]).replace(/\,/g,".")),this.szCRSDatum,this.szCRSUTMZone))?String(v.x)+","+String(v.y):"";else if("LatLon"==this.fSelection2)v=map.Scale.getMapPositionOfLatLon(parseFloat(String(this.objTheme.dbRecords[f][this.nSelection2_0]).replace(/\,/g,".")),parseFloat(String(this.objTheme.dbRecords[f][this.nSelection2_1]).replace(/\,/g,"."))),l=D?String(D.x)+","+String(D.y):"";else if("Point"==this.fSelection||"MultiPoint"==this.fSelection||
"LineString"==this.fSelection||"MultiLineString"==this.fSelection)l=this.objTheme.dbRecords[f][this.objTheme.nFieldSelection2Index],k=g.match(positionRegExp),v=map.Scale.getMapPositionOfLatLon(parseFloat(k[2]),parseFloat(k[1]));else for(l=this.objTheme.dbRecords[f][this.objTheme.nFieldSelection2Index],this.nSelectionFieldDigits&&(l=("000000000000000"+g).slice(-this.nSelectionFieldDigits)),this.fSelectionFieldToUpper&&(l=String(l).toUpperCase()),a=0;a<this.szThemesA.length;a++)v=v||this.getNodePosition(this.szThemesA[a]+
"::"+l);l=__mpap_decode_utf8(String(this.objTheme.dbRecords[f][this.objTheme.nFieldSelection2Index]));this.fSelectionFieldToUpper&&(l=String(l).toUpperCase());n=l;l=c+"::"+l;this.themeNodesPosA[l]=v}if(!this.__fClipToGeoBounds||!(D.x<w.x||D.x>w.x+w.width||D.y<w.y||D.y>w.y+w.height)){var A=!1;a=[];if("$item$"==this.szFieldsA[0])a[0]=1;else if("$index$"==this.szFieldsA[0])a[0]=f+1;else for(e=0;e<this.szFieldsA.length;e++){p=this.objTheme.dbRecords[f][this.objTheme.nFieldIndexA[e]];p=this.valueMap?this.valueMap[String(p)]||
p:p;this.__fExact?(p=this.getStringValueIndex(String(p)),this.exactCountA[p-1]=(this.exactCountA[p-1]||0)+1):p=this.__fScanValue?__scanValue(p)*(this.szWeightsA[e]||1):parseFloat(p)*(this.szWeightsA[e]||1);if(isNaN(p))if(this.fUndefinedValuePossible)p=0;else{A=!0;continue}0!==p||this.fNullIsValue?0>p&&!this.fNegativeValuePossible?A=!0:a[e]=p:A=!0}a.length=this.szFieldsA.length;k=1;k="$item$"==this.szField100?1:0>this.objTheme.nField100Index?0:__scanValue(this.objTheme.dbRecords[f][this.objTheme.nField100Index]);
0!==k||this.fNullIsValue||(k=null);0>k&&!this.fNegativeValuePossible&&(k=null);isNaN(k)&&(k=null);var B=null;if(this.szSizeField&&"$item$"!=this.szSizeField){B=this.objTheme.dbRecords[f][this.objTheme.nSizeFieldIndex];B=this.valueMap?this.valueMap[String(B)]||__scanValue(B):__scanValue(B);B=isFinite(B)&&!isNaN(B)?B:0;if(0===B&&!this.fNullIsValue){A=!0;continue}if(0>B&&!this.fNegativeValuePossible){A=!0;continue}}else B=1;var x=null;this.szAlphaField&&(x=__scanValue(this.objTheme.dbRecords[f][this.objTheme.nAlphaFieldIndex]));
var Fa=null;this.szTitleField&&(Fa=this.objTheme.dbRecords[f][this.objTheme.nTitleFieldIndex]);var ka=null;this.szColorField&&(ka="$index$"==this.szColorField?f+1:__mpap_decode_utf8(this.objTheme.dbRecords[f][this.objTheme.nColorFieldIndex]));var ha=null;this.szTimeField&&(ha="$index$"==this.szTimeField?f+1:__mpap_decode_utf8(this.objTheme.dbRecords[f][this.objTheme.nTimeFieldIndex]),ha=ha.replace(/ - /g," "));e=null;this.szXField&&(e=__scanValue(this.objTheme.dbRecords[f][this.objTheme.nXFieldIndex]));
var fa=null;this.szYField&&(fa=__scanValue(this.objTheme.dbRecords[f][this.objTheme.nYFieldIndex]));var fb=null;this.szValueField&&(fb=this.objTheme.dbRecords[f][this.objTheme.nValueFieldIndex]);if(this.__fAggregate&&this.nGridWidthMap)if(this.szFlag.match(/\bRECT\b/))D=this.dX||this.dY?new point(Math.round((D.x+this.dX)/this.nGridWidthMap)*this.nGridWidthMap-this.dX,Math.round((D.y+this.dY)/this.nGridWidthMap)*this.nGridWidthMap-this.dY):new point(Math.round(D.x/this.nGridWidthMap)*this.nGridWidthMap,
Math.round(D.y/this.nGridWidthMap)*this.nGridWidthMap);else{if(this.szFlag.match(/PLOTY/))var y=Math.round(D.y/this.nGridWidthMap),ba=y%2?this.nHexaHalf:0,y=new point(Math.round((D.x+ba)/this.nHexaWidth)*this.nHexaWidth-ba,y*this.nGridWidthMap);else var y=Math.round(D.x/this.nGridWidthMap),C=y%2?this.nHexaHalf:0,y=new point(y*this.nGridWidthMap,Math.round((D.y+C)/this.nHexaWidth)*this.nHexaWidth-C);if(Math.abs(y.x-D.x)>this.nHexa4th){var ba=[],H=[],C=0===C?this.nHexaHalf:0;y.x>D.x?(ba[0]=new point(y.x-
this.nGridWidthMap,y.y-this.nHexaHalf),ba[1]=new point(y.x-this.nGridWidthMap,y.y+this.nHexaHalf)):(ba[0]=new point(y.x+this.nGridWidthMap,y.y-this.nHexaHalf),ba[1]=new point(y.x+this.nGridWidthMap,y.y+this.nHexaHalf));H[0]=Math.sqrt(Math.pow(ba[0].x-D.x,2)+Math.pow(ba[0].y-D.y,2));H[1]=Math.sqrt(Math.pow(ba[1].x-D.x,2)+Math.pow(ba[1].y-D.y,2));H[3]=Math.sqrt(Math.pow(y.x-D.x,2)+Math.pow(y.y-D.y,2));H[0]<H[3]?y=new point(Math.round(ba[0].x/this.nGridWidthMap)*this.nGridWidthMap,Math.round((ba[0].y+
C)/this.nHexaWidth)*this.nHexaWidth-C):H[1]<H[3]&&(y=new point(Math.round(ba[1].x/this.nGridWidthMap)*this.nGridWidthMap,Math.round((ba[1].y+C)/this.nHexaWidth)*this.nHexaWidth-C))}D=y}this.__fAggregate&&this.nGridWidthMap&&v&&!this.szFlag.match(/\bORIGIN\b/)&&(this.szFlag.match(/\bRECT\b/)?v=this.dX||this.dY?new point(Math.round((v.x+this.dX)/this.nGridWidthMap)*this.nGridWidthMap-this.dX,Math.round((v.y+this.dY)/this.nGridWidthMap)*this.nGridWidthMap-this.dY):new point(Math.round(v.x/this.nGridWidthMap)*
this.nGridWidthMap,Math.round(v.y/this.nGridWidthMap)*this.nGridWidthMap):(this.szFlag.match(/PLOTY/)?(y=Math.round(v.y/this.nGridWidthMap),ba=y%2?this.nHexaHalf:0,y=new point(Math.round((v.x+ba)/this.nHexaWidth)*this.nHexaWidth-ba,y*this.nGridWidthMap)):(y=Math.round(v.x/this.nGridWidthMap),C=y%2?this.nHexaHalf:0,y=new point(y*this.nGridWidthMap,Math.round((v.y+C)/this.nHexaWidth)*this.nHexaWidth-C)),Math.abs(y.x-v.x)>this.nHexa4th&&(ba=[],H=[],C=0===C?this.nHexaHalf:0,y.x>v.x?(ba[0]=new point(y.x-
this.nGridWidthMap,y.y-this.nHexaHalf),ba[1]=new point(y.x-this.nGridWidthMap,y.y+this.nHexaHalf)):(ba[0]=new point(y.x+this.nGridWidthMap,y.y-this.nHexaHalf),ba[1]=new point(y.x+this.nGridWidthMap,y.y+this.nHexaHalf)),H[0]=Math.sqrt(Math.pow(ba[0].x-v.x,2)+Math.pow(ba[0].y-v.y,2)),H[1]=Math.sqrt(Math.pow(ba[1].x-v.x,2)+Math.pow(ba[1].y-v.y,2)),H[3]=Math.sqrt(Math.pow(y.x-v.x,2)+Math.pow(y.y-v.y,2)),H[0]<H[3]?y=new point(Math.round(ba[0].x/this.nGridWidthMap)*this.nGridWidthMap,Math.round((ba[0].y+
C)/this.nHexaWidth)*this.nHexaWidth-C):H[1]<H[3]&&(y=new point(Math.round(ba[1].x/this.nGridWidthMap)*this.nGridWidthMap,Math.round((ba[1].y+C)/this.nHexaWidth)*this.nHexaWidth-C))),v=y),this.themeNodesPosA[l]=v);l=g;this.szAggregationField?(y=__mpap_decode_utf8(this.objTheme.dbRecords[f][this.objTheme.nAggregationFieldIndex]),g=c+"::"+y,"$aggregation$"==this.szTitleField&&(Fa=y)):(g=c+"::"+String(D.x)+","+String(D.y)+(this.__fMultiParts?","+String(p):""),this.themeNodesPosA[g]=D);v&&this.szFlag.match(/VECTOR/)&&
(g+="&"+String(v.x)+","+String(v.y),this.themeNodesPosA[g]=v);if(this.__fAggregate)if(!this.itemA[g]){if(!A){this.aggregationCount++;A=0;if(this.__fMultiParts)A=B;else if(this.__fExact)if(e=a[0]-1,isNaN(e))continue;else a=this.nEmptyValuesA.slice(0),A=a[e]=B,q=this.nEmptyValuesA.slice(0),q[e]=1;else for(e=0;e<this.szFieldsA.length;e++)A=Math.max(A,a[e]||0);this.itemA[g]={nOrigValuesA:[],nValuesA:a,nValue100:k,nValueSum:0,nCount:1,nCountA:q};this.itemA[g].szTitle=Fa;this.itemA[g].szSelectionId=String(l);
this.itemA[g].szSelectionId2=String(n);this.itemA[g].nSize=Math.abs(B||(this.objTheme.nSizeFieldIndex?0:A));this.itemA[g].nAlpha=x||1;this.itemA[g].szColor=ka;this.itemA[g].szTime=ha;this.itemA[g].szValue=fb;this.itemA[g].dbIndexA=[f];this.itemA[g].ptPos=D;this.itemA[g].ptPos2=v;this.itemA[g].ptPosA=[m];this.nCount++}}else{if(!A){A=0;if(this.__fMultiParts)A=B;else if(this.__fExact)if(e=a[0]-1,isNaN(e))continue;else this.itemA[g].nValuesA[e]=this.__fMax?Math.max(this.itemA[g].nValuesA[e]||0,B):(this.itemA[g].nValuesA[e]||
0)+B,this.itemA[g].nCountA[e]=(this.itemA[g].nCountA[e]||0)+1,A=B;else if(this.__fMax&&(B||(this.objTheme.nSizeFieldIndex?0:A)>this.itemA[g].nSize))for(e=0;e<this.szFieldsA.length;e++)this.itemA[g].nValuesA[e]=a[e]||0,A=Math.max(A,a[e]||0);else for(e=0;e<this.szFieldsA.length;e++)this.itemA[g].nValuesA[e]=this.__fMax?Math.max(this.itemA[g].nValuesA[e],a[e]||0):this.itemA[g].nValuesA[e]+(a[e]||0),A=Math.max(A,a[e]||0);this.__fMax?(this.itemA[g].nSize=Math.max(this.itemA[g].nSize,B||(this.objTheme.nSizeFieldIndex?
0:A)),this.itemA[g].nAlpha=Math.max(this.itemA[g].nAlpha,x||1),this.itemA[g].nValue100=Math.max(this.itemA[g].nValue100,k||0),this.itemA[g].ptPosA=[m],this.itemA[g].szTitle=Fa,this.itemA[g].dbIndexA=[f]):(this.itemA[g].nSize+=Math.abs(B||(this.objTheme.nSizeFieldIndex?0:A)),this.itemA[g].nAlpha+=x||1,this.itemA[g].nValue100+=k||0,this.itemA[g].ptPosA.push(m),this.itemA[g].nCount++,this.itemA[g].dbIndexA.push(f),Fa&&Fa==this.itemA[g].szTitle||(this.itemA[g].szTitle=this.szAggregation+" ("+this.itemA[g].nCount+
")",this.itemA[g].szTitle=this.szAggregation+" of "+this.itemA[g].nCount+" items"))}}else this.itemA[g]&&(g+="*"+Math.random()),this.aggregationCount++,this.itemA[g]={nOrigValuesA:[],nValuesA:a,nValue100:k,nValueSum:0},this.itemA[g].szSelectionId=String(c+"::"+l),this.itemA[g].szSelectionId2=String(c+"::"+n),this.itemA[g].nSize=B||0,this.itemA[g].ptPos=D,this.itemA[g].ptPos2=v,this.itemA[g].dbIndexA=[f],this.itemA[g].nX=e,this.itemA[g].nY=fa,this.itemA[g].szColor=ka,this.itemA[g].szTime=ha,this.itemA[g].szValue=
fb,this.nCount++}}}}if(0<=this.objTheme.nField100Index)if(this.fField100=!0,this.szFlag.match(/DIFFERENCE/)&&1==this.itemA[d].nValuesA.length&&!this.szFlag.match(/RELATIVE/))for(d in this.itemA)for(e=0;e<this.itemA[d].nValuesA.length;e++)this.itemA[d].nValuesA[e]-=this.itemA[d].nValue100;else if(this.szFlag.match(/FRACTION/))for(d in this.itemA)for(e=0;e<this.itemA[d].nValuesA.length;e++)this.itemA[d].nValuesA[e]=this.itemA[d].nValuesA[e]/this.itemA[d].nValue100*(this.nFractionScale||1);else if(this.szFlag.match(/PRODUCT/))for(d in this.itemA)for(e=
0;e<this.itemA[d].nValuesA.length;e++)this.itemA[d].nValuesA[e]*=this.itemA[d].nValue100;else if(this.szFlag.match(/CALCVAL/))for(d in this.itemA)for(e=0;e<this.itemA[d].nValuesA.length;e++)this.itemA[d].nValuesA[e]=Math.round(this.itemA[d].nValuesA[e]*this.itemA[d].nValue100/100);else if(this.szFlag.match(/PERMILLE/))for(d in this.itemA)for(e=0;e<this.itemA[d].nValuesA.length;e++)this.itemA[d].nValuesA[e]*=1E3/this.itemA[d].nValue100;else for(d in this.itemA)for(e=0;e<this.itemA[d].nValuesA.length;e++)this.itemA[d].nValue100>
(this.nField100Min||0)?(this.itemA[d].nValuesA[e]*=100/this.itemA[d].nValue100,0<this.itemA[d].nValuesA[e]&&this.szFlag.match(/RELATIVE/)?this.itemA[d].nValuesA[e]-=100:0<this.itemA[d].nValuesA[e]&&this.szFlag.match(/INVERT/)&&(this.itemA[d].nValuesA[e]=100-p)):this.itemA[d].nValuesA[e]=0;else if(this.__fAggregate&&this.szFlag.match(/MEAN/))if(this.__fMultiParts)for(d in this.itemA)this.itemA[d].nSize/=this.itemA[d].nCount;else for(d in this.itemA){if(this.itemA[d].nCountA)for(e=0;e<this.itemA[d].nValuesA.length;e++)this.itemA[d].nValuesA[e]/=
this.itemA[d].nCountA[e]||1;else for(e=0;e<this.itemA[d].nValuesA.length;e++)this.itemA[d].nValuesA[e]/=this.itemA[d].nCount;this.szFlag.match(/SIZESUM/)||(this.itemA[d].nSize/=this.itemA[d].nCount)}if(this.szFlag.match(/DIFFERENCE/))for(d in this.itemA){for(a=0;a<this.itemA[d].nValuesA.length;a++)a<this.itemA[d].nValuesA.length-1?(n=this.itemA[d].nValuesA[a],this.itemA[d].nValuesA[a]=this.itemA[d].nValuesA[a+1]-this.itemA[d].nValuesA[a],this.szFlag.match(/RELATIVE/)&&(this.itemA[d].nValuesA[a]=n>
(this.nField100Min||0)?100/n*this.itemA[d].nValuesA[a]:0)):this.szFlag.match(/STACKED/)||(this.itemA[d].nValuesA[a]=0);this.itemA[d].nValuesA.pop()}if(this.szFlag.match(/AUTO100/))if(this.nGridX)for(d in this.itemA){a=0;do{for(n=k=0;n<this.nGridX;n++)k+=this.itemA[d].nValuesA[a+n]||0;for(n=0;n<this.nGridX;n++)this.itemA[d].nValuesA[a+n]/=k/100;a+=this.nGridX}while(a<this.itemA[d].nValuesA.length)}else for(d in this.itemA){for(a=k=0;a<this.itemA[d].nValuesA.length;a++)k+=this.itemA[d].nValuesA[a]||
0;this.itemA[d].nValue100=k;this.fField100=!0;for(a=0;a<this.itemA[d].nValuesA.length;a++)this.itemA[d].nValuesA[a]/=this.itemA[d].nValue100/100}if(this.szFlag.match(/RELOCATE/)||this.szAggregationField)for(d in this.itemA)if(this.itemA[d].ptPosA){for(n=g=D=0;n<this.itemA[d].ptPosA.length;n++)D+=this.itemA[d].ptPosA[n].x,g+=this.itemA[d].ptPosA[n].y;this.itemA[d].ptPos={x:D/this.itemA[d].nCount,y:g/this.itemA[d].nCount}}if(this.szMinAggregation){q=n=0;for(d in this.itemA)q+=this.itemA[d].nCount,n++;
q/=n;for(d in this.itemA)this.itemA[d].nCount&&this.itemA[d].nCount<(this.nMinAggregation||Math.sqrt(q)-1)&&delete this.itemA[d]}this.nMin=Number.MAX_VALUE;this.nMax=-Number.MAX_VALUE;this.nMinA=[];this.nMaxA=[];if(this.__fExact||this.szSizeField)for(d in this.itemA)isFinite(this.itemA[d].nSize)&&!isNaN(this.itemA[d].nSize)&&(this.nMin=this.nMinSize=Math.min(this.nMinSize,this.itemA[d].nSize),this.nMax=this.nMaxSize=Math.max(this.nMaxSize,this.itemA[d].nSize),this.nSumSize+=this.itemA[d].nSize);else for(d in this.itemA)for(t=
0;t<this.itemA[d].nValuesA.length;t++)isFinite(this.itemA[d].nValuesA[t])&&!isNaN(this.itemA[d].nValuesA[t])&&(this.nMin=Math.min(this.itemA[d].nValuesA[t],this.nMin),this.nMax=Math.max(this.itemA[d].nValuesA[t],this.nMax));for(d in this.itemA)for(t=0;t<this.itemA[d].nValuesA.length;t++)isFinite(this.itemA[d].nValuesA[t])&&!isNaN(this.itemA[d].nValuesA[t])?(this.nMinA[t]=Math.min(this.itemA[d].nValuesA[t],this.nMinA[t]||Number.MAX_VALUE),this.nMaxA[t]=Math.max(this.itemA[d].nValuesA[t],this.nMaxA[t]||
-Number.MAX_VALUE),this.nSumA[t]+=this.itemA[d].nValuesA[t]):(this.nMinA[t]=this.nMinA[t]||Number.MAX_VALUE,this.nMaxA[t]=this.nMaxA[t]||-Number.MAX_VALUE);if(this.szAlphaField)for(d in this.itemA)isFinite(this.itemA[d].nAlpha)&&!isNaN(this.itemA[d].nAlpha)&&(this.nMinAlpha=Math.min(this.nMinAlpha,this.itemA[d].nAlpha),this.nMaxAlpha=Math.max(this.nMaxAlpha,this.itemA[d].nAlpha),this.nSumAlpha+=this.itemA[d].nAlpha);if(this.szSizeField)for(d in this.itemA)isFinite(this.itemA[d].nSize)&&!isNaN(this.itemA[d].nSize)&&
(this.nMinSize=Math.min(this.nMinSize,this.itemA[d].nSize),this.nMaxSize=Math.max(this.nMaxSize,this.itemA[d].nSize),this.nSumSize+=this.itemA[d].nSize);if(this.szXField)for(d in this.itemA)isNaN(this.itemA[d].nX)||(this.nMinX=Math.min(this.nMinX,this.itemA[d].nX),this.nMaxX=Math.max(this.nMaxX,this.itemA[d].nX),this.nSumX+=this.itemA[d].nX);if(this.szYField)for(d in this.itemA)isNaN(this.itemA[d].nY)||(this.nMinY=Math.min(this.nMinY,this.itemA[d].nY),this.nMaxY=Math.max(this.nMaxY,this.itemA[d].nY),
this.nSumY+=this.itemA[d].nY);if(this.szValueField&&this.szSizeField==this.szValueField)for(d in this.itemA)this.itemA[d].szValue=String(this.itemA[d].nSize);this.oldSizefield&&(this.szSizeField=this.oldSizefield,this.oldSizeField=null);return this.fAnalyze=!0};
MapTheme.prototype.loadTableFromMap=function(){var c,b,d,a={table:{fields:0,records:0},fields:[],records:[]},f=SVGDocument.getElementById(this.szThemesA[0]);if(null==f){var e=map.Tiles.getTileNodes(this.szThemesA[0]);e&&(f=e[0])}if(!f)return this.szThemes="",null;f=f.getAttributeNS(szMapNs,"info");if(null==f||""===f)return this.szThemes="",null;f=f.split("|");f.push("FeatureId");for(c in f)a.fields.push({id:f[c]}),a.table.fields++;var f=[],g=[];for(c=0;c<this.szThemesA.length;c++){this.objTheme=this.objThemesA[this.szThemesA[c]];
e=map.Layer.getLayerObj(this.szThemesA[c]);if(null==e)return alert("MapTheme error: no layer like '"+this.szThemesA[c]+"'"),!1;if(e.szFlag.match(/tiled/)){g[0]=map.Scale.canvasNode;g.length=1;this.fDataIncomplete=!map.Tiles.allTilesLoaded();break}else g[g.length]=SVGDocument.getElementById(e.szName)}e=!0;for(b=0;b<g.length;b++){d=g[b].getElementsByTagName("path");var l=g[b].getElementsByTagName("use"),n=g[b].getElementsByTagName("circle");for(c=0;c<d.length;c++)f[f.length]=d.item(c);for(c=0;c<l.length;c++)f[f.length]=
l.item(c);for(c=0;c<n.length;c++)f[f.length]=n.item(c)}if(0===f.length)for(e=!1,b=0;b<g.length;b++)for(d=g[b].getElementsByTagName("g"),c=0;c<d.length;c++)f[f.length]=d.item(c);for(c=0;c<f.length;c++)if(1==f[c].nodeType&&f[c].hasAttributeNS(szMapNs,"info")){d=e?f[c].parentNode.getAttributeNS(null,"id"):f[c].getAttributeNS(null,"id");g=-1;if(d&&0!==d.length)for(l=map.Tiles.getMasterId(d).split(":")[0],b=0;b<this.szThemesA.length;b++)l==this.szThemesA[b]&&(g=b);b=map.Tiles.getMasterId(d);!this.itemA[b]&&
0<=g&&(g=f[c].getAttributeNS(szMapNs,"info").split("|"),g.push(b.split("::")[1]),a.records.push(g),a.table.records++,this.itemA[b]=1)}this.itemA=[];return a};
MapTheme.prototype.aggregateValues=function(){if(!(this.__fAggregateOnLoad||!this.szFlag.match(/AGGREGATE/)&&!this.szFlag.match(/GROUP/)||this.szAggregationUpper&&map.Scale.nTrueMapScale*map.Scale.nZoomScale>this.nAggregationUpper||this.szAggregationLower&&map.Scale.nTrueMapScale*map.Scale.nZoomScale<this.nAggregationLower)){var c=[],b=[],d=[],a=[],f=[],e=null,g=0;this.nTopicsSkipedByZeroExclusion=0;this.nGridWidthPx&&(this.nGridWidth=e=map.Scale.getDistanceInMeter(1E3,1E3,1E3+map.Scale.normalX(this.nGridWidthPx),
1E3));this.nGridMatrix&&(e=map.Zoom.getBox(),e=map.Scale.getDistanceInMeter(1E3,1E3,1E3+e.width,1E3),this.nGridWidth=e/(this.nGridMatrix||20)/map.Scale.nZoomScale);var l=this.nGridWidth?Math.round(map.Scale.getDeltaXofDistanceInMeter(this.nGridWidth)/20)*map.Scale.nZoomScale*20:0,e=function(a){for(var b in a)return b}(this.itemA),n="undefined",k=this.itemA[e].szSelectionId.split("::")[0],q=null,h=1.15*l,u=1.15*l/2,w=l/4;if(this.szAggregationField)for(var p in this.itemA){n="undefined";e=e||p;n=this.itemA[p].szAggregation;
c[n]||(c[n]=[],a[n]=new point(0,0),b[n]=0,d[n]=0,g++);c[n][p]=this.itemA[p];c[n][p].nSize=this.itemA[p].nSize||1;c[n][p].szTitle=this.itemA[p].szTitle||n;d[n]+=c[n][p].nSize;var t=this.getNodePosition(this.itemA[p].szSelectionId);t&&(a[n].x+=t.x,a[n].y+=t.y,b[n]++)}else if(this.nGridWidth)for(p in this.itemA)if(t=this.getNodePosition(this.itemA[p].szSelectionId)){if(this.szFlag.match(/\bRECT\b/))this.szFlag.match(/FIXGRID/)?(q=map.Scale.mapCenter.x*map.Scale.nZoomScale,n=map.Scale.mapCenter.y*map.Scale.nZoomScale,
q=new point(Math.round((t.x+q)/l)*l-q,Math.round((t.y+n)/l)*l-n)):q=new point(Math.round(t.x/l)*l,Math.round(t.y/l)*l);else{if(this.szFlag.match(/PLOTY/))q=Math.round(t.y/l),n=q%2?u:0,q=new point(Math.round((t.x+n)/h)*h-n,q*l);else var q=Math.round(t.x/l),M=q%2?u:0,q=new point(q*l,Math.round((t.y+M)/h)*h-M);if(Math.abs(B-t.x)>w){var n=[],D=[],M=0===M?u:0;B>t.x?(n[0]=new point(q.x-l,q.y-u),n[1]=new point(q.x-l,q.y+u)):(n[0]=new point(q.x+l,q.y-u),n[1]=new point(q.x+l,q.y+u));D[0]=Math.sqrt(Math.pow(n[0].x-
t.x,2)+Math.pow(n[0].y-t.y,2));D[1]=Math.sqrt(Math.pow(n[1].x-t.x,2)+Math.pow(n[1].y-t.y,2));D[3]=Math.sqrt(Math.pow(q.x-t.x,2)+Math.pow(q.y-t.y,2));D[0]<D[3]?q=new point(Math.round(n[0].x/l)*l,Math.round((n[0].y+M)/h)*h-M):D[1]<D[3]&&(q=new point(Math.round(n[1].x/l)*l,Math.round((n[1].y+M)/h)*h-M))}}n=k+"::"+String(q.x)+","+String(q.y);this.themeNodesPosA[p]=q;this.themeNodesPosA[n]=q;c[n]||(c[n]=[],a[n]=new point(0,0),b[n]=0,g++);c[n][p]=this.itemA[p];c[n][p].nSize=this.itemA[p].nSize||1;a[n].x+=
t.x;a[n].y+=t.y;b[n]++}else c[n]||(c[n]=[],a[n]=new point(0,0),b[n]=0,this.fDataIncomplete=fTilesLoaded,g++),c[n][p]=this.itemA[p],c[n][p].nSize=this.itemA[p].nSize||1,b[n]++,this.fDataIncomplete=!0;else for(p in this.itemA)(t=this.getNodePosition(this.itemA[p].szSelectionId))?(n=this.itemA[p].szSelectionId,c[n]||(c[n]=[],a[n]=new point(0,0),b[n]=0,g++),c[n][p]=this.itemA[p],c[n][p].nSize=this.itemA[p].nSize||1,a[n].x+=t.x,a[n].y+=t.y,b[n]++):(c[n]||(c[n]=[],a[n]=new point(0,0),b[n]=0,this.fDataIncomplete=
fTilesLoaded,g++),c[n][p]=this.itemA[p],c[n][p].nSize=this.itemA[p].nSize||1,b[n]++,this.fDataIncomplete=!0);if(this.szFlag.match(/GROUP/)){this.itemA=[];for(var y in c){g=c[y];this.indexA=[];for(p in g)this.indexA.push(p);for(var b=[],m=0;m<this.indexA.length;m++)b.push({a:this.indexA[m],y:g[this.indexA[m]].nValuesA[0]});this.szFlag.match(/\bUP\b/)?b.sort(this.sortDownChartObjectsCompare):b.sort(this.sortUpChartObjectsCompare);for(m in b)g[b[m].a].szSelectionId=y,this.itemA[y+"*"+Math.random()]=
g[b[m].a]}}else{if(this.szFlag.match(/CATEGORICAL/))for(y in this.szSizeField||(this.szSizeField="$aggregation$"),c){g=c[y];f[y]=0;M=[];for(p in g)f[y]++,M[g[p].nValuesA[0]]||(M[g[p].nValuesA[0]]={itemA:[]}),M[g[p].nValuesA[0]].itemA[p]=g[p];c[y]=[];for(m in M)for(p in g=M[m].itemA,k=null,g)null==k?(k=c[y][p]=g[p],k.nCount=1,k.dbIndexA=k.dbIndexA||[],k.nSize=k.nSize||1,k.nAlpha=k.nAlpha||1):(k.nCount+=1,k.nValue100+=g[p].nValue100,k.nSize+=g[p].nSize||1,k.nAlpha+=g[p].nAlpha||1,k.szValue=String(k.nSize),
l&&!this.szAggregationField&&(!k.szTitle||3<k.nCount)&&(k.szTitle="("+k.nCount+")"),k.dbIndexA.push(g[p].dbIndex))}else for(y in c){g=c[y];if(!this.szFlag.match(/SUM/)&&!this.szFlag.match(/ZEROISVALUE/)){l=[];M=0;for(p in g)if(M++,g[p])for(m=0;m<g[p].nValuesA.length;m++)if(0===g[p].nOrigValuesA[m]){l[p]=p;break}if(1<M)for(p in l)delete g[p],this.nTopicsSkipedByZeroExclusion++}c[y]=[];k=null;for(p in g)if(null==k)k=c[y][p]=g[p],k.nCount=1,k.dbIndexA=k.dbIndexA||[],k.nSize=k.nSize||1,k.nAlpha=k.nAlpha||
1;else{for(m=0;m<g[p].nValuesA.length;m++)k.nValuesA[m]+=g[p].nValuesA[m]||0,k.nOrigValuesA[m]+=g[p].nOrigValuesA[m]||0;k.nCount+=1;k.nValue100+=g[p].nValue100;k.nSize+=g[p].nSize||1;k.nAlpha+=g[p].nAlpha||1;k.szValue=String(k.nSize);k.szTitle="("+this.formatValue(k.nCount,0)+")";k.dbIndexA.push(g[p].dbIndex)}}if(this.szAggregationField||this.szFlag.match(/RELOCATE/)){var v=new point(0,0),A=0,m=1E6,l=0;for(y in c)m=Math.min(m,a[y].x/b[y]),A=Math.max(A,a[y].y/b[y]),v.x+=a[y].x*(d[y]||1),v.y+=a[y].y*
(d[y]||1),l+=b[y]*(d[y]||1);v.x/=l;v.y/=l;new point(m,v.y);A=new point(v.x,A)}this.nMin=Number.MAX_VALUE;this.nMax=-Number.MAX_VALUE;this.nMinSize=Number.MAX_VALUE;this.nSumSize=this.nMaxSize=0;this.nMinAlpha=Number.MAX_VALUE;this.nSumAlpha=this.nMaxAlpha=0;this.szFlag.match(/CATEGORICAL/)&&(this.nMinA=[],this.nMaxA=[],this.nSumA=[],this.nOrigMinA=[],this.nOrigMaxA=[],this.nOrigSumA=[],this.nMedianA=[],this.nMeanA=[],this.nCountA=[]);d="[";l=this.nStringToValue-1;for(m=0;m<l;m++)d+="0,";d+="]";this.itemA=
[];l=0;M=Math.max(this.szRangesA?this.szRangesA.length:0,this.szExactA?this.szExactA.length:0)-(this.szFlag.match(/CATEGORICAL/)?0:1);k=this.szFlag.match(/CATEGORICAL/)&&(this.szFlag.match(/PIE/)||this.szFlag.match(/BAR/)||this.szFlag.match(/SEQUENCE/)||this.szFlag.match(/PLOT/)||this.szFlag.match(/DOMINANT/)||this.szFlag.match(/\bUSER\b/)||this.szFlag.match(/WAFFLE/));for(y in c)if(l++,"undefined"!=y){var g=c[y],B;if(k){for(p in g){B=p;break}this.itemA[B]={};m=[];eval("nValuesA = "+d+";");this.itemA[B].szSelectionId=
B;this.itemA[B].szTitle=g[B].szTitle;if(this.szAggregationField||this.szFlag.match(/RELOCATE/))this.szFlag.match(/ALIGN/)?(this.itemA[B].szSelectionId=e,this.szFlag.match(/\bUP\b/)?this.themeNodesPosA[B]=new point(A.x,A.y):this.themeNodesPosA[B]=new point(v.x,v.y)):this.themeNodesPosA[B]=new point(a[y].x/b[y],a[y].y/b[y]);this.itemA[B].dbIndexA=[];u=h=0;for(p in g){m[g[p].nValuesA[0]-1]=g[p].nSize/(this.szFlag.match(/SUM/)?1:g[p].nCount);h+=g[p].nSize;u+=g[p].nCount;this.itemA[B].dbIndexA.push(g[p].dbIndex);
for(var x in g[p].dbIndexA)this.itemA[B].dbIndexA.push(g[p].dbIndexA[x]);delete this.itemA[B].dbIndex}this.itemA[B].nValuesA=this.itemA[B].nOrigValuesA=m;this.itemA[B].nMinA=[];this.itemA[B].nMaxA=[];this.itemA[B].nSize=h/(this.szFlag.match(/SUM/)?1:u);this.itemA[B].nCount=u;this.itemA[B].nAlpha=g[p].nAlpha;this.itemA[B].szTitle=this.nGridWidth&&!this.szAggregationField&&1<f[y]?__formatValue(f[y],0)+" item(s) aggregated":this.itemA[B].szTitle||y;this.itemA[B].szValue=this.itemA[B].szTitle;this.itemA[B].szLabel=
this.itemA[B].szTitle;this.nMin=this.nMinSize=Math.min(this.nMinSize,this.itemA[B].nSize);this.nMax=this.nMaxSize=Math.max(this.nMaxSize,this.itemA[B].nSize);this.nSumSize+=h/(this.szFlag.match(/SUM/)?1:u);this.nMinAlpha=Math.min(this.nMinAlpha,this.itemA[B].nAlpha);this.nMaxAlpha=Math.max(this.nMaxAlpha,this.itemA[B].nAlpha);this.nSumAlpha+=this.itemA[B].nAlpha;if(this.szFlag.match(/AUTO100/)){for(m=u=0;m<this.itemA[B].nValuesA.length;m++)u+=this.itemA[B].nValuesA[m]||0;this.itemA[B].nValue100=u;
this.fField100=!0;for(m=0;m<this.itemA[B].nValuesA.length;m++)this.itemA[B].nValuesA[m]=this.itemA[B].nOrigValuesA[m]/this.itemA[B].nValue100*100}if(this.szFlag.match(/CATEGORICAL/)&&(this.szFlag.match(/CATEGORICAL/)||!this.nNormalSizeValue)){if(!this.nMinA.length)for(m=0;m<this.itemA[B].nValuesA.length;m++)this.nMinA[m]=null,this.nMaxA[m]=null,this.nSumA[m]=0,this.nOrigMinA[m]=null,this.nOrigMaxA[m]=null,this.nOrigSumA[m]=0,this.nMedianA[m]=0,this.nMeanA[m]=0,this.nCountA[m]=0;for(m=0;m<this.itemA[B].nValuesA.length;m++)this.nMinA[m]=
Math.min(this.nMinA[m]||this.itemA[B].nValuesA[m],this.itemA[B].nValuesA[m]),this.nMaxA[m]=Math.max(this.nMaxA[m]||this.itemA[B].nValuesA[m],this.itemA[B].nValuesA[m]),this.nSumA[m]+=this.itemA[B].nValuesA[m],this.nOrigMinA[m]=Math.min(this.nOrigMinA[m]||this.itemA[B].nOrigValuesA[m],this.itemA[B].nOrigValuesA[m]),this.nOrigMaxA[m]=Math.max(this.nOrigMaxA[m]||this.itemA[B].nOrigValuesA[m],this.itemA[B].nOrigValuesA[m]),this.nOrigSumA[m]+=this.itemA[B].nOrigValuesA[m],this.itemA[B].nValuesA[m]&&this.nCountA[m]++}this.nCount=
l*M}else for(p in g)if(g[p]){h=p;this.szAggregationField||(h=y,this.itemA[h]&&(h=h.split("*")[0]+"*"+Math.random()));this.itemA[h]=g[p];g[p].szValue=g[p].szValue||1;this.nMinSize=Math.min(this.nMinSize,this.itemA[h].nSize);this.nMaxSize=Math.max(this.nMaxSize,this.itemA[h].nSize);this.nSumSize+=this.itemA[h].nSize;this.nMinAlpha=Math.min(this.nMinAlpha,this.itemA[h].nAlpha);this.nMaxAlpha=Math.max(this.nMaxAlpha,this.itemA[h].nAlpha);this.nSumAlpha+=this.itemA[h].nAlpha;this.szFlag.match(/SUM/)||
(u=this.szFlag.match(/SUM/)?1:g[p].nCount,this.itemA[h].nSize/=u,this.itemA[h].szValue/=u,this.itemA[h].nValue100/=u);if(this.nGridWidth||this.szAggregationField)for(u=this.szFlag.match(/SUM/)||this.szFlag.match(/CATEGORICAL/)?1:g[p].nCount,this.itemA[h].szSelectionId=p,m=0;m<this.itemA[h].nValuesA.length;m++)this.itemA[h].nValuesA[m]/=u,this.itemA[h].nOrigValuesA[m]/=u,this.itemA[h].nValue100&&(this.itemA[h].nValuesA[m]=this.itemA[h].nOrigValuesA[m]/this.itemA[h].nValue100,this.szFlag.match(/FRACTION/)||
(this.itemA[h].nValuesA[m]*=this.szFlag.match(/PERMILLE/)?1E3:100),this.szFlag.match(/INVERT/)&&(this.itemA[h].nValuesA[m]=100-this.itemA[h].nValuesA[m])),this.nMin=Math.min(this.itemA[h].nValuesA[m]||Number.MAX_VALUE,this.nMin||Number.MAX_VALUE),this.nMax=Math.max(this.itemA[h].nValuesA[m]||-Number.MAX_VALUE,this.nMax||-Number.MAX_VALUE);else this.nMin=Math.min(this.itemA[h].nSize,this.nMin||Number.MAX_VALUE),this.nMax=Math.max(this.itemA[h].nSize,this.nMax||-Number.MAX_VALUE);if(this.szFlag.match(/AUTO100/)){for(m=
u=0;m<this.itemA[h].nValuesA.length;m++)u+=this.itemA[h].nValuesA[m]||0;this.itemA[h].nValue100=u;this.fField100=!0;for(m=0;m<this.itemA[h].nValuesA.length;m++)this.itemA[h].nValuesA[m]=this.itemA[h].nOrigValuesA[m]/this.itemA[h].nValue100*100}if(this.szAggregationField||this.szFlag.match(/RELOCATE/))this.szFlag.match(/ALIGN/)?this.szFlag.match(/\bUP\b/)?this.themeNodesPosA[h]=new point(A.x,A.y):this.themeNodesPosA[h]=new point(v.x,v.y):(this.themeNodesPosA[p]=new point(a[y].x/b[y],a[y].y/b[y]),this.themeNodesPosA[h]=
new point(a[y].x/b[y],a[y].y/b[y]))}}if(this.szMinAggregation){c=u=0;for(p in this.itemA)c+=this.itemA[p].nCount,u++;c/=u;for(p in this.itemA)this.itemA[p].nCount&&this.itemA[p].nCount<(this.nMinAggregation||c/2)&&delete this.itemA[p];this.nMin=Number.MAX_VALUE;this.nMax=-Number.MAX_VALUE;for(p in this.itemA)for(m=0;m<this.itemA[p].nValuesA.length;m++)this.nMin=Math.min(this.itemA[p].nValuesA[m],this.nMin),this.nMax=Math.max(this.itemA[p].nValuesA[m],this.nMax)}this.fSorted=!0}}};
MapTheme.prototype.distributeValues=function(){if(0===this.nCount)return this.szFlag.match(/CATEGORICAL/)&&displayMessage("theme: no matching values !",3E3),!1;if(this.szFlag.match(/OUTLIER/)){var c=this.szFieldsA.length;this.getMeanMedianQuantile();if(this.szFlag.match(/PLOT/)){for(var b in this.itemA){for(var d=[],a=0;a<c;a++)this.itemA[b].nValuesA[a]&&d.push(this.itemA[b].nValuesA[a]);this.nDeviationA[b]=this.parent.getDeviationOfArray(d)}for(b in this.itemA)for(a=0;a<c;a++)Math.abs(this.itemA[b].nValuesA[a]-
this.itemA[b].nValuesA[a-1])>2*this.nDeviationA[b]&&this.szFlag.match(/NOOUTLIER/)&&(this.itemA[b].nValuesA[a]=this.itemA[b].nValuesA[a-1])}else{for(a=0;a<c;a++){d=[];for(b in this.itemA)this.itemA[b].nValuesA[a]&&d.push(this.itemA[b].nValuesA[a]);this.nDeviationA[a]=this.parent.getDeviationOfArray(d)}for(a=0;a<c;a++)for(b in this.itemA)Math.abs(this.itemA[b].nValuesA[a]-this.nMeanA[a])>3*this.nDeviationA[a]?this.szFlag.match(/NOOUTLIER/)&&delete this.itemA[b]:this.szFlag.match(/NOOUTLIER/)||delete this.itemA[b]}this.nMin=
Number.MAX_VALUE;this.nMax=-Number.MAX_VALUE;for(b in this.itemA)for(var f=0;f<this.itemA[b].nValuesA.length;f++)isNaN(this.itemA[b].nValuesA[f])||(this.nMin=Math.min(this.itemA[b].nValuesA[f],this.nMin),this.nMax=Math.max(this.itemA[b].nValuesA[f],this.nMax))}(this.szFlag.match(/AGGREGATE/)||this.szFlag.match(/GROUP/))&&this.aggregateValues();"$aggregation$"==this.szSizeField&&(this.szSizeField=null);if(this.szFlag.match(/CATEGORICAL/)&&(!this.szExactA||!this.szExactA.length)&&(this.szExactA=this.szExactA||
[],this.nStringToValueA))for(b in this.nStringToValueA)this.szExactA.push(this.nStringToValueA[b]);!this.szFlag.match(/CATEGORICAL/)||this.szLabelA&&this.szLabelA.length||!this.szValuesA||(this.szLabelA=this.szValuesA);if(this.szColorField)if(this.colorFieldA=[],this.colorClassA=[],this.colorClassUsedA=[],this.szColorValuesA)for(a in this.szColorValuesA)this.colorFieldA[this.szColorValuesA[a]]=!0;else if(this.szValuesA)for(a in this.szValuesA)this.colorFieldA[this.szValuesA[a]]=!0;else for(b in this.itemA)this.colorFieldA[this.itemA[b].szColor]=
!0;if(this.szSymbolField)if(this.symbolFieldA=[],this.szSymbolValuesA)for(a in this.szSymbolValuesA)this.symbolFieldA[this.szSymbolValuesA[a]]=this.szSymbolsA[a];else for(b in this.itemA)this.symbolFieldA[this.itemA[b].szSymbol]=this.szSymbolsA[a];this.origColorScheme||(this.origColorScheme=this.colorScheme=this.defaultColorScheme);if(isNaN(Number(this.origColorScheme[0])))this.colorScheme=this.origColorScheme.slice(0);else{!this.szFlag.match(/SEQUENCE/)&&!this.szFlag.match(/\bCLIP\b/)&&this.szFieldsA.length>
this.origColorScheme[0]&&(this.origColorScheme[0]=this.szFieldsA.length);this.szFlag.match(/CATEGORICAL/)&&(this.origColorScheme[0]=this.szExactA.length||1);if(this.szColorField){a=0;for(b in this.colorFieldA)a++;this.origColorScheme[0]=a}try{this.colorScheme=ColorScheme.createColorScheme(this.origColorScheme[1],this.origColorScheme[2],this.origColorScheme[0],this.origColorScheme[3],this.origColorScheme[4])}catch(e){this.colorScheme=this.defaultColorScheme}if(this.szFlag.match(/CATEGORICAL/)&&this.szFlag.match(/ORDER/)){c=
this.colorScheme.slice();d=this.szValuesA?this.szValuesA.slice():this.szLabelA.slice();if(this.szColorField)for(b in d=[],this.colorFieldA)d.push(b),this.getStringValueIndex(b,"set");if(d.length&&c.length&&d.length==c.length)for(d.sort(),this.colorScheme=[],a=0;a<d.length;a++)this.colorScheme[this.nStringToValueA[d[a]]-1]=c[a]}}if(this.szColorField){a=0;for(b in this.colorFieldA)this.colorClassA[b]=a,this.colorFieldA[b]=this.colorScheme[a++];for(b in this.itemA)this.itemA[b].nClass=this.colorClassA[this.itemA[b].szColor],
this.itemA[b].szColor=this.colorFieldA[this.itemA[b].szColor]}if(this.szSymbolField)for(b in this.itemA)this.itemA[b].szSymbol=this.symbolFieldA[this.itemA[b].szSymbol];try{eval("var __defineColorScheme = HTMLWindow."+this.colorScheme[0]),__defineColorScheme(this)}catch(g){}if(this.colorScheme[0].match(/function||\=\>/))try{eval("var __defineColorScheme = "+this.colorScheme),__defineColorScheme(this)}catch(l){}try{HTMLWindow.ixmaps.htmlgui_colorScheme(this)}catch(n){}if(this.szFlag.match(/DOMINANT/))for(;this.colorScheme.length<
this.szFieldsA.length;)this.colorScheme[this.colorScheme.length]="#dddddd";if(this.szFieldsA)if(this.colorScheme.length<this.szFieldsA.length&&this.nGridX)for(;this.colorScheme.length<this.nGridX;)this.colorScheme[this.colorScheme.length]=this.colorScheme[this.colorScheme.length-1]||"#dddddd";else if(!this.szFlag.match(/\bCLIP\b/))for(;this.colorScheme.length<this.szFieldsA.length;)this.colorScheme[this.colorScheme.length]=this.colorScheme[this.colorScheme.length-1]||"#dddddd";if(this.szFlag.match(/NORMALIZE/)&&
this.nMax){var k=this.nMax-this.nMin;for(b in this.itemA)this.itemA[b].nValuesA[0]=(this.itemA[b].nValuesA[0]-this.nMin)/k;this.nMin=0;this.nMax=1}if(this.szFlag.match(/HARMONIZE/)&&this.nMax){if(this.nMaxA){this.nRangeA=[];for(f in this.nMaxA)this.nRangeA.push(this.nMaxA[f]-this.nMinA[f]);for(b in this.itemA)for(f in this.itemA[b].nValuesA)this.itemA[b].nValuesA[f]=(this.itemA[b].nValuesA[f]-this.nMinA[f])/this.nRangeA[f];for(f in this.nMaxA)this.nMinA[f]=0,this.nMaxA[f]=1}else{for(b in this.itemA)this.itemA[b].nValuesA[0]/=
this.nMax;this.nMin/=this.nMax;this.nMax/=this.nMax}this.nMin=0;this.nMax=1}if(this.szFlag.match(/INVERTSIZE/)&&this.szSizeField){for(b in this.itemA)this.itemA[b].nSize=this.nMaxSize-this.itemA[b].nSize;this.nNormalSizeValue=this.nNormalSizeValue||this.nMaxSize}this.szFlag.match(/CATEGORICAL/)||this.szFlag.match(/SEQUENCE/)||this.getMeanMedianQuantile();c=this.colorScheme.length;k=this.nMax-this.nMin;f=this.nMin;d=this.nMax;null==this.nRangeCenterValue||isNaN(this.nRangeCenterValue)||(a=Math.max(Math.abs(this.nRangeCenterValue-
f),Math.abs(d-this.nRangeCenterValue)),f=this.nRangeCenterValue-a,d=this.nRangeCenterValue+a,k=d-f);if(this.szFlag.match(/INTEGER/))c>k?c=k:c>k/2?c=Math.floor(k/2):k+=c-k%c;else{var q=1;for(this.szField100&&(q=.01);k>1E3*q;)q*=10;1<q?(f=Math.floor(f/q)*q,d=Math.ceil(d/q)*q):d+=d/1E5;k=d-f}if(this.szFlag.match(/CHART|CHOROPLETH/)&&(isNaN(k)||!isFinite(k)))return _ERROR("ERROR on distributeValues: infinite range !"),displayMessage("ERROR: infinite value range !",3E3),!1;if(this.szColorField)for(b in this.nRangesA=
[],a=0,this.colorFieldA)this.nRangesA.push(a++);else this.nRangesA=this.szRangesA||this.szExactA;if(this.nRangesA&&this.nRangesA.length){q=this.szFlag.match(/CATEGORICAL/)?0:1;this.szFlag.match(/BAR/)&&this.szFlag.match(/SEQUENCE/)&&(q=1);c=this.nRangesA.length-q;if(this.szSymbolsA&&this.szSymbolsA.length)for(;this.szSymbolsA.length<c;)this.szSymbolsA[this.szSymbolsA.length]=this.szSymbolsA[this.szSymbolsA.length-1];if(this.colorScheme&&this.colorScheme.length)for(;this.colorScheme.length<c;)this.colorScheme[this.colorScheme.length]=
this.colorScheme[this.colorScheme.length-1]||"#dddddd";this.partsA=[];for(a=0;a<c;a++)f=Number(this.nRangesA[a]),d=Number(this.nRangesA[a+q])+1E-9,this.partsA[this.partsA.length]={min:f,max:d,color:this.colorScheme[a],nCount:0,nSum:0};if(this.szFlag.match(/CATEGORICAL/)&&this.exactCountA)for(a=0;a<c;a++)this.partsA[a].nCount=this.exactCountA[a];if(this.szFlag.match(/PLOTVAR/)||this.szFlag.match(/DOMINANT/))for(this.getMeanMedianQuantile(),a=0;a<c;a++){d=[];for(b in this.itemA)this.itemA[b].nValuesA[a]&&
d.push(this.itemA[b].nValuesA[a]);this.nDeviationA[a]=this.parent.getDeviationOfArray(d);this.szDominantFilter=this.szDominantFilter||"min";this.nDominantDFilter=this.nDominantDFilter||0;this.szDominantFilter.match(/min/)?this.nFilterA[a]=this.nMinA[a]+(this.nMaxA[a]-this.nMinA[a])/100*this.nDominantDFilter:this.szDominantFilter.match(/max/)?this.nFilterA[a]=this.nMinA[a]+(this.nMaxA[a]-this.nMinA[a])/100*this.nDominantDFilter:this.szDominantFilter.match(/mean/)?this.nFilterA[a]=this.nMeanA[a]+(this.nMaxA[a]-
this.nMeanA[a])/100*this.nDominantDFilter:this.szDominantFilter.match(/median/)&&(this.nFilterA[a]=this.nMedianA[a]+(this.nMaxA[a]-this.nMedianA[a])/100*this.nDominantDFilter)}}else{k/=c;k>q&&(k=Math.floor(k/q)*q);this.nMin==this.nMax&&(c=1);this.partsA=[];for(a=0;a<c;a++)this.partsA[this.partsA.length]={min:f+a*k,max:f+(a+1)*k,color:this.colorScheme[a],nCount:0,nSum:0};this.partsA[this.partsA.length-1].max=d;if(this.szFlag.match(/QUANTILE/)){this.getMeanMedianQuantile();q=Math.round(this.quantileA[0].length/
c);for(a=0;a<this.partsA.length;a++)this.partsA[a].min=this.quantileA[0][a*q],this.partsA[a].max=this.quantileA[0][(a+1)*q];this.partsA[this.partsA.length-1].max=d}if(this.szFlag.match(/LOG/)){f=Math.log(this.nMin?this.nMin:Math.min(.1,this.nMax/10));k=Math.log(this.nMax?this.nMax:.1)-f;k/=c;this.partsA=[];for(a=0;a<c;a++)this.partsA[this.partsA.length]={min:Math.exp(f+a*k),max:Math.exp(f+(a+1)*k),color:this.colorScheme[a],nCount:0,nSum:0};this.partsA[this.partsA.length-1].max=this.nMax}else if(this.szFlag.match(/POW2/)){f=
Math.pow(this.nMin?this.nMin:1,.5);k=Math.pow(this.nMax?this.nMax:1,.5)-Math.pow(this.nMin?this.nMin:1,.5);k/=c;this.partsA=[];for(a=0;a<c;a++)this.partsA[this.partsA.length]={min:Math.pow(f+a*k,2),max:Math.pow(f+(a+1)*k,2),color:this.colorScheme[a],nCount:0,nSum:0};this.partsA[this.partsA.length-1].max=this.nMax}else if(this.szFlag.match(/POW3/)){f=Math.pow(this.nMin?this.nMin:1,1/3);k=Math.pow(this.nMax?this.nMax:1,1/3)-Math.pow(this.nMin?this.nMin:1,1/3);k/=c;this.partsA=[];for(a=0;a<c;a++)this.partsA[this.partsA.length]=
{min:Math.pow(f+a*k,3),max:Math.pow(f+(a+1)*k,3),color:this.colorScheme[a],nCount:0,nSum:0};this.partsA[this.partsA.length-1].max=this.nMax}if(this.szFlag.match(/DOMINANT/)||this.szFlag.match(/OFFSETMEAN/)||this.szFlag.match(/OFFSETMEDIAN/)||this.szFlag.match(/DEVIATION/)||this.szFlag.match(/PLOTVAR/)){this.getMeanMedianQuantile();for(a=0;a<this.szFieldsA.length;a++){q=[];for(b in this.itemA)this.itemA[b].nValuesA[a]&&q.push(this.itemA[b].nValuesA[a]);"$item$"!=this.szFieldsA[a]&&q.sort(this.sortUp);
this.nMedianA[a]=q[Math.round(q.length/2)];this.nSum100?this.szFlag.match(/DIFFERENCE/)?this.nMeanA[a]=this.nSumA[a]/this.nCount:(this.nMeanA[a]=this.nOrigSumA[a]/this.nSum100,this.szFlag.match(/FRACTION/)?this.nMeanA[a]*=this.nFractionScale||1:this.szFlag.match(/PERMILLE/)?this.nMeanA[a]*=1E3:(this.nMeanA[a]*=100,this.szFlag.match(/RELATIVE/)?this.nMeanA[a]-=100:this.szFlag.match(/INVERT/)&&(this.nMeanA[a]=100-this.nMeanA[a]))):this.nMeanA[a]=this.nSumA[a]/this.nCount}for(a=0;a<this.partsA.length;a++)this.szDominantFilter=
this.szDominantFilter||"min",this.nDominantDFilter=this.nDominantDFilter||0,this.szDominantFilter.match(/min/)?this.nFilterA[a]=this.nMinA[a]+(this.nMaxA[a]-this.nMinA[a])/100*this.nDominantDFilter:this.szDominantFilter.match(/max/)?this.nFilterA[a]=this.nMinA[a]+(this.nMaxA[a]-this.nMinA[a])/100*this.nDominantDFilter:this.szDominantFilter.match(/mean/)?this.nFilterA[a]=this.nMeanA[a]+(this.nMaxA[a]-this.nMeanA[a])/100*this.nDominantDFilter:this.szDominantFilter.match(/median/)&&(this.nFilterA[a]=
this.nMedianA[a]+(this.nMaxA[a]-this.nMedianA[a])/100*this.nDominantDFilter);if(this.szFlag.match(/DEVIATION/)||this.szFlag.match(/PLOTVAR/))for(a=0;a<this.szFieldsA.length;a++){d=[];for(b in this.itemA)this.itemA[b].nValuesA[a]&&d.push(this.itemA[b].nValuesA[a]);this.nDeviationA[a]=this.parent.getDeviationOfArray(d)}}}this.partsA[this.partsA.length-1].max+=.001;this.szColorField&&(this.nRangesA=this.szRangesA||this.szExactA);this.szFlag.match(/COMPOSECOLOR/)&&__maptheme_initComposedColor(this.colorScheme.slice(0));
return!0};MapTheme.prototype.sortUp=function(c,b){return c-b};MapTheme.prototype.sortIndexUp=function(c,b){return c.value-b.value};MapTheme.prototype.sortIndexDown=function(c,b){return b.value-c.value};MapTheme.prototype.sortPartsUp=function(c,b){return c.nCount-b.nCount};MapTheme.prototype.sortMeanUp=function(c,b){return c.mean-b.mean};MapTheme.prototype.shuffleArray=function(c,b){for(var d=c.length-1;0<d;d--){var a=Math.floor((b&&b[d]?b[d]:Math.random())*d+1),f=c[d];c[d]=c[a];c[a]=f}};
MapTheme.prototype.getRandomNumberArray=function(c){for(var b=[],d=0;d<c;d++)b.push(Math.random());return b};
var sum_composecolor_intensity=0,mean_composecolor_intensity=0,__maptheme_initComposedColor=function(c){for(var b=mean_composecolor_intensity=sum_composecolor_intensity=0;b<c.length;b++){var d=ColorScheme.getHexaColor(c[b]);mean_composecolor_intensity+=Math.max(Math.max(parseInt(d.substr(1,2),16),parseInt(d.substr(3,2),16)),parseInt(d.substr(5,2),16));sum_composecolor_intensity+=parseInt(d.substr(1,2),16)+parseInt(d.substr(3,2),16)+parseInt(d.substr(5,2),16)}sum_composecolor_intensity/=c.length;mean_composecolor_intensity/=
c.length},__maptheme_getComposedColor_additive=function(c,b,d,a){for(var f=0,e=0,g=0,l=0;l<c.length;l++)var n=ColorScheme.getHexaColor(b[l]),f=f+parseInt(n.substr(1,2),16)*((c[l]||0)/(d||1)),e=e+parseInt(n.substr(3,2),16)*((c[l]||0)/(d||1)),g=g+parseInt(n.substr(5,2),16)*((c[l]||0)/(d||1));c=Math.max(Math.max(f,e),g);f=Math.floor(f/c*(a||mean_composecolor_intensity));e=Math.floor(e/c*(a||mean_composecolor_intensity));g=Math.floor(g/c*(a||mean_composecolor_intensity));return ColorScheme.getHexaColor("rgb("+
f+","+e+","+g+")")},__maptheme_getComposedColor_subtractive=function(c,b,d,a){a=a||Math.min(Math.floor(sum_composecolor_intensity),300)||255;for(var f=0,e=0,g=0,l=0;l<c.length;l++)var n=ColorScheme.getHexaColor(b[l]),f=f+(255-parseInt(n.substr(1,2),16))*((c[l]||0)/(d||1)),e=e+(255-parseInt(n.substr(3,2),16))*((c[l]||0)/(d||1)),g=g+(255-parseInt(n.substr(5,2),16))*((c[l]||0)/(d||1));c=Math.max(Math.max(f,e),g);f=Math.min(255,a-Math.floor(f/c*mean_composecolor_intensity));e=Math.min(255,a-Math.floor(e/
c*mean_composecolor_intensity));g=Math.min(255,a-Math.floor(g/c*mean_composecolor_intensity));return ColorScheme.getHexaColor("rgb("+f+","+e+","+g+")")};
MapTheme.prototype.paintMap=function(c){if(this.nChartUpper&&map.Scale.nTrueMapScale*map.Scale.nZoomScale>this.nChartUpper)this.unpaintMap(),this.fVisible=!1,this.realizeDone();else if(this.nChartLower&&map.Scale.nTrueMapScale*map.Scale.nZoomScale<=this.nChartLower)this.unpaintMap(),this.fVisible=!1,this.realizeDone();else{this.beginDraw();this.mapSleep&&(this.mapSleep.checkSleepMessage="painting map");var b=0,d=0,a=0,f=0,e=0,g=0,l="",n="";map.Dictionary.getLocalText("of mean");map.Dictionary.getLocalText("of median");
var k=!1,q=0,h=a=l=0,f=null;this.fillOpacity=this.fillOpacity?this.fillOpacity:this.nOpacity;this.szStyle="fill-opacity:"+String(this.fillOpacity?this.fillOpacity:fTransparentMap?.6:1);this.autoOpacity&&(q=map.Scale.nTrueMapScale*map.Scale.nZoomScale/map.Scale.nNormalSizeScale,this.szStyle="fill-opacity:"+String(Math.max(.3,Math.min(1,.3+.7/Math.max(1,Math.log(map.Zoom.nZoom/q))))));this.szShapeType.match(/line/)&&(this.szStyle=this.fillOpacity?"stroke-opacity:"+this.fillOpacity+";":"stroke-opacity:1");
if(!c||0===c){c=0;this.indexA=[];for(h in this.itemA)this.indexA[this.indexA.length]=h,this.itemA[h].todo=!0;for(l=0;l<this.partsA.length;l++)this.partsA[l].nCount=0,this.partsA[l].nSum=0;this.nDoneCount=0;this.szFlag.match(/COMPOSECOLOR/)&&__maptheme_initComposedColor(this.colorScheme.slice(0));if(this.parentTheme)for(a=0;a<this.parentTheme.paintedShapeNodesA.length;a++)this.parentTheme.unPaintShape(this.parentTheme.paintedShapeNodesA[a])}for(;c<this.indexA.length;c++){if(this.mapSleep&&(this.mapSleep.nDoneCount=
this.nDoneCount,this.mapSleep.checkSleep(c,10))){this.fContinue=!0;this.continueIndex=c;this.szItemFilter&&this.szItemFilter.length&&this.filterItems(this.szItemFilter,this.itemFilterOpt);return}h=this.indexA[c];this.nDoneCount++;k=!1;q=0;if(this.szFlag.match(/COMPOSECOLOR/)){b=this.szFlag.match(/SUBTRACTIVE/)?__maptheme_getComposedColor_subtractive(this.itemA[h].nValuesA,this.colorScheme,this.nMax,Math.floor(255*this.nBrightness)):__maptheme_getComposedColor_additive(this.itemA[h].nValuesA,this.colorScheme,
this.nMax,Math.floor(255*this.nBrightness));f=this.getItemNodes(h);for(a=0;a<f.length;a++)if(e=this.paintShape(f[a],b,-1,-1),this.szFlag.match(/DOPACITY/)){if(this.szAlphaField)g=0,"undefined"!=typeof this.itemA[h].nAlpha&&(g=1/(this.nDopacityPow||1),g=(this.nDopacityScale||1)/Math.pow(this.nMaxAlpha,g)*Math.pow(this.itemA[h].nAlpha,g));else var g=1/(this.nDopacityPow||1),q=(isNaN(this.itemA[h].nValueSum)?0:this.itemA[h].nValueSum)/(this.itemA[h].nValue100/100||1),u=isNaN(this.nMax)?0:this.nMax,g=
(this.nDopacityScale||1)*Math.pow(q,g)/Math.pow(u,g);e.style.setProperty("fill-opacity",String(g),"")}k=!0}else if(this.szFlag.match(/DOMINANT/)){for(var k=!0,w=-1,l=0;l<this.itemA[h].nValuesA.length;l++)b=this.itemA[h].nValuesA[l],d=100/this.nMeanA[l]*b,a=100/this.nMedianA[l]*b,f=(b-this.nMeanA[l])/this.nDeviationA[l],e=b,this.szFlag.match(/PERCENTOFMEAN/)&&(e=d),this.szFlag.match(/PERCENTOFMEDIAN/)&&(e=a),this.szFlag.match(/DEVIATION/)&&(e=f),b>this.nFilterA[l]&&e>q&&(this.itemA[h].nClass=l,q=e,
w=l);if(0<=w){this.itemA[h].nDominant=w;b=this.itemA[h].nValuesA[w];l=" "+this.szFieldsA[w]+" ";this.szLabelA&&this.szLabelA[w]&&(l=" "+this.szLabelA[w]+" ");if(this.szFlag.match(/PERCENTOFMEAN/)||this.szFlag.match(/DEVIATION/))n=map.Dictionary.getLocalText(" ( mean: ")+this.formatValue(this.nMeanA[w],1)+this.szUnit+")";this.szFlag.match(/PERCENTOFMEDIAN/)&&(n=map.Dictionary.getLocalText(" ( median: ")+this.formatValue(this.nMedianA[w],1)+this.szUnit+")");this.itemA[h].nValue=this.itemA[h].nValuesA[w];
this.itemA[h].szLabel=l;this.itemA[h].szColor=this.colorScheme[w];this.itemA[h].nClass=w;f=this.getItemNodes(h);for(a=0;a<f.length;a++)e=this.paintShape(f[a],this.colorScheme[w],this.itemA[h].nValue,w),e.setAttributeNS(szMapNs,"tooltip",this.formatValue(b,2)+this.szUnit+l+n),this.szFlag.match(/DOPACITY/)&&(g=u=q=0,q=isNaN(this.itemA[h].nValuesA[w])?0:this.itemA[h].nValuesA[w],u=isNaN(this.nMaxA[w])?0:this.nMaxA[w],this.szAlphaField?(g=0,"undefined"!=typeof this.itemA[h].nAlpha&&(g=1/(this.nDopacityPow||
1),g=(this.nDopacityScale||1)/Math.pow(this.nMaxAlpha,g)*Math.pow(this.itemA[h].nAlpha,g))):this.szFlag.match(/DOPACITYLOGMEAN/)?g=Math.log((this.nDopacityScale||1)*(d-100))/Math.log(100):this.szFlag.match(/DOPACITYPOWMEAN/)?(g=1/(this.nDopacityPow||1),g=Math.pow((this.nDopacityScale||1)*(d-100),g)/Math.pow(100,g)):this.szFlag.match(/DOPACITYMEAN/)?(g=1/(this.nDopacityPow||1),g=Math.pow((this.nDopacityScale||1)*(d-100),g)/Math.pow(100,g)):this.szFlag.match(/DOPACITYLOGMAX/)?g=Math.log(q)/Math.log(u):
this.szFlag.match(/DOPACITYPOWMAX/)?(g=1/(this.nDopacityPow||1),g=(this.nDopacityScale||1)*Math.pow(q,g)/Math.pow(u,g)):this.szFlag.match(/DOPACITYMAX/)?(g=1/(this.nDopacityPow||1),g=(this.nDopacityScale||1)*Math.pow(q,g)/Math.pow(u,g)):g=Math.log((this.nDopacityScale||1)*q)/Math.log(u),g=1E-4>g?0:g,g=Math.min(this.nOpacity||.9,g),this.autoOpacity&&(q=map.Scale.nTrueMapScale*map.Scale.nZoomScale/map.Scale.nNormalSizeScale,g*=Math.max(.3,Math.min(1,.3+.7/Math.max(1,Math.log(map.Zoom.nZoom/q))))),e.style.setProperty("fill-opacity",
String(g),""));this.partsA[w].nCount++}else for(f=this.getItemNodes(h),a=0;a<f.length;a++)this.unPaintShape(f[a]),f[a].removeAttributeNS(szMapNs,"tooltip")}else for(b=this.szFlag.match(/\bCLIP\b/)&&this.nClipFrames?this.nClipFrames==this.itemA[h].nValuesA.length?Number(this.itemA[h].nValuesA[this.nActualFrame]):this.itemA[h].nValuesA[0]*(this.nClipFrames-1-this.nActualFrame)/(this.nClipFrames-1)+this.itemA[h].nValuesA[1]*this.nActualFrame/(this.nClipFrames-1):this.itemA[h].nValuesA[0],l=0;l<this.partsA.length;l++)if(b<
this.partsA[l].max){this.itemA[h].nValue=b;this.itemA[h].szColor=this.partsA[l].color;this.itemA[h].nClass=l;if(this.itemA[h].todo){f=this.getItemNodes(h);for(a=0;a<f.length;a++)e=this.paintShape(f[a],this.partsA[l].color,b,l),this.szLabelA&&this.szLabelA[l]&&this.szFlag.match(/CATEGORICAL/)?e.setAttributeNS(szMapNs,"tooltip",this.szLabelA[l]):this.itemA[h].nValue100?e.setAttributeNS(szMapNs,"tooltip",this.formatValue(b,2)+this.szUnit):(e.setAttributeNS(szMapNs,"tooltip",this.formatValue(b,2)+this.szUnit),
e.setAttributeNS(szMapNs,"tooltip",(this.itemA[h].szTitle?this.itemA[h].szTitle:"")+" "+this.formatValue(b,2)+this.szUnit)),this.szFlag.match(/DOPACITY/)&&(this.szAlphaField?(g=0,"undefined"!=typeof this.itemA[h].nAlpha&&(g=1/(this.nDopacityPow||1),g=(this.nDopacityScale||1)/Math.pow(this.nMaxAlpha,g)*Math.pow(this.itemA[h].nAlpha,g))):0>this.nMin&&0<this.nMax?(g=0,this.szFlag.match(/DOPACITYMAX/)?(g=1/(this.nDopacityPow||1),g=Math.pow(Math.abs(b),g)/Math.pow(this.nMedianA[0]-this.nMin,g)*(this.fillOpacity||
1)*(this.nDopacityScale||1)):g=this.szFlag.match(/DOPACITYLOG/)?Math.log(Math.abs(b))/Math.log(this.nMedianA[0]-this.nMin)*.5*(this.fillOpacity||1)*(this.nDopacityScale||1):Math.abs(b)/(this.nMedianA[0]-this.nMin)*.5*(this.fillOpacity||1)*(this.nDopacityScale||1)):this.szFlag.match(/BIPOLAR/)||this.szFlag.match(/DOPACITYMINMAX/)?(g=0,this.szFlag.match(/DOPACITYMAX/)?(g=1/(this.nDopacityPow||1),g=b>=this.nMeanA[0]?Math.pow(Math.abs(b-this.nMeanA[0]),g)/Math.pow(Math.abs(this.nMax-this.nMeanA[0]),g)*
(this.fillOpacity||1)*(this.nDopacityScale||1):Math.pow(Math.abs(this.nMeanA[0]-b),g)/Math.pow(Math.abs(this.nMeanA[0]-this.nMin),g)*(this.fillOpacity||1)*(this.nDopacityScale||1)):this.szFlag.match(/DOPACITYLOG/)?g=b>=this.nMedianA[0]?Math.log(Math.abs(b-this.nMedianA[0]))/Math.log(this.nMax-this.nMedianA[0])*(this.fillOpacity||1)*(this.nDopacityScale||1):Math.log(Math.abs(b-this.nMedianA[0]))/Math.log(this.nMedianA[0]-this.nMin)*(this.fillOpacity||1)*(this.nDopacityScale||1):(g=1/(this.nDopacityPow||
1),g=b>=this.nMedianA[0]?Math.pow(Math.abs(b-this.nMedianA[0]),g)/Math.pow(this.nMax-this.nMedianA[0],g)*(this.fillOpacity||1)*(this.nDopacityScale||1):Math.pow(Math.abs(b-this.nMedianA[0]),g)/Math.pow(this.nMedianA[0]-this.nMin,g)*(this.fillOpacity||1)*(this.nDopacityScale||1))):this.szFlag.match(/DOPACITYMIN/)?(g=1/(this.nDopacityPow||1),g=Math.pow(this.nMax-b,g)/Math.pow(this.nMax-this.nMin,g)*(this.fillOpacity||1)*(this.nDopacityScale||1)):this.szFlag.match(/DOPACITYMAX/)?(g=1/(this.nDopacityPow||
1),g=Math.pow(b-this.nMin,g)/Math.pow(this.nMax-this.nMin,g)*(this.fillOpacity||1)*(this.nDopacityScale||1)):this.szFlag.match(/DOPACITYLOG/)?g=Math.log(b-this.nMin)/Math.log(this.nMedianA[0]-this.nMin)*.5*(this.fillOpacity||1)*(this.nDopacityScale||1):this.szFlag.match(/DOPACITY/)&&(g=(b-this.nMin)/(this.nMedianA[0]-this.nMin)*.5*(this.fillOpacity||1)*(this.nDopacityScale||1)),g=1E-4>g?0:g,g=Math.min(this.nOpacity||.9,g),this.autoOpacity&&(q=map.Scale.nTrueMapScale*map.Scale.nZoomScale/map.Scale.nNormalSizeScale,
g*=Math.max(.3,Math.min(1,.3+.7/Math.max(1,Math.log(map.Zoom.nZoom/q))))),e.style.setProperty("fill-opacity",String(g),""));this.itemA[h].todo=!1}this.partsA[l].nCount++;this.partsA[l].nSum+=b;k=!0;break}if(!k)for(this.itemA[h].szColor=this.szNoDataColor?this.szNoDataColor:"white",f=this.getItemNodes(h),a=0;a<f.length;a++)e=this.paintShape(f[a],this.szNoDataColor?this.szNoDataColor:"white",-1,-1),e.setAttributeNS(szMapNs,"tooltip","no value"),this.szFlag.match(/DOPACITY/),this.nNoData++}this.isVisible=
!0;this.realizeDone();this.fShowProgressBar=!1;this.showInfo();this.endDraw();this.szItemFilter&&this.szItemFilter.length&&this.filterItems(this.szItemFilter,this.itemFilterOpt);this.szFlag.match(/\bCLIP\b/)?this.nClipFrames==this.itemA[h].nValuesA.length?this.szXaxisA&&this.szXaxisA[this.nActualFrame]?displayMessage(this.szXaxisA[this.nActualFrame],3E3,"big"):this.szLabelA&&this.szLabelA[this.nActualFrame]&&displayMessage(this.szLabelA[this.nActualFrame],3E3,"big"):(d=this.szXaxisA||this.szLabelA)&&
(0===this.nActualFrame?displayMessage(d[0],3E3,"big"):this.nActualFrame==this.nClipFrames-1?displayMessage(d[1],3E3,"big"):displayMessage(" ... ",3E3,"big")):this.ErrorMessage?(displayMessage(this.ErrorMessage,1E4,"notify"),this.ErrorMessage=null):clearMessage();this.szFlag.match(/VALUES/)&&(!this.szValueUpper||map.Scale.nTrueMapScale*map.Scale.nZoomScale<=this.nValueUpper)&&(!this.szValueLower||map.Scale.nTrueMapScale*map.Scale.nZoomScale>=this.nValueLower)?(this.mapSleep&&this.mapSleep.initCheckSleep(25),
this.fContinue=this.fMakeLabel=!0,this.nActualFrame=this.nMissingPositionCount=this.nMissingRangeCount=this.nZeroValueCount=this.nRealizedCount=this.nSkipCount=this.nDoneCount=this.continueIndex=0,setTimeout(function(){map.Themes.executeContinue()},1E3)):this.unlabelMap()}};
MapTheme.prototype.unpaintMap=function(){if(this.szFlag.match(/FEATURE/))this.chartGroup&&map.Dom.clearGroup(this.chartGroup);else if(this.szFlag.match(/CHART/)){if(this.chartGroup){if(0===this.chartGroup.childNodes.length&&this.itemA){var c=null,b;for(b in this.itemA)(c=SVGDocument.getElementById(this.szId+":"+b+":chartgroup"))&&c.parentNode.removeChild(c)}this.fAutoScaleLeader&&(map.Themes.autoScale=null);map.Dom.clearGroup(this.chartGroup)}}else{this.beginDraw();for(c=0;c<this.paintedShapeNodesA.length;c++)this.unPaintShape(this.paintedShapeNodesA[c]),
this.paintedShapeNodesA[c].removeAttributeNS(szMapNs,"tooltip");this.paintedShapeNodesA.length=0;this.unlabelMap();this.endDraw();this.isVisible=!1;this.checkVisible();setTimeout(function(){map.Layer.adaptLabel(null)},10)}};
MapTheme.prototype.paintShape=function(c,b,d,a){this.paintedShapeNodesA.push(c);switch(this.szShapeType){case "line":c.setAttributeNS(null,"style","fill:none;stroke:"+b+";"+this.szStyle);break;case "line+buffer":var f=c.getAttributeNS(null,"id");if(!f.match(":paint")){var e=SVGDocument.getElementById(f+":paint");e||(e=c.cloneNode(1E3),c.parentNode.insertBefore(e,c),e.setAttributeNS(null,"id",f+":paint"));c=e}f=4;if(this.nBufferSize)if(this.nBufferSize.match(/\$value\$/)){d=this.nBufferSize.split("$value$");
f="";for(e=0;e<d.length;e++)f+=d[e],e<d.length-1&&(f+="nValue");f=eval(f)}else f=this.nBufferSize.match(/value/)?1E3<100/(this.nMin+1E-9)*(this.nMax-this.nMin)?6+Math.log(d/this.nMax):10*d/(this.nMax-this.nMin):this.nBufferSize;f*=Math.log(1+1/__featureScaling_lastScale);c.setAttributeNS(null,"style","stroke:"+b+";stroke-width:"+map.Scale.normalX(f)*map.Scale.nZoomScale+";"+this.szStyle+";stroke-linecap:butt;");break;default:c.setAttributeNS(null,"style","fill:"+b+";"+this.szStyle)}c.setAttributeNS(szMapNs,
"class",a);return c};MapTheme.prototype.unPaintShape=function(c){if("line+buffer"==this.szShapeType){var b=c.getAttributeNS(null,"id");(b=SVGDocument.getElementById(b+":paint"))&&b.parentNode.removeChild(b)}c.removeAttributeNS(null,"style");c.removeAttributeNS(szMapNs,"class")};
MapTheme.prototype.zoomToClass=function(c,b){var d=0;if(this.szFlag.match(/DOMINANT/))for(var a in this.itemA)this.itemA[a].nClass==c&&d++;else d=this.partsA[c].nCount;if(0===d)displayMessage("No members !");else{var f,e=null;if(this.szFlag.match(/CHART/))for(a=this.chartGroup.childNodes,f=0;f<a.length;f++)if(d=a.item(f),null==d.getAttributeNS(szMapNs,"class")||""===d.getAttributeNS(szMapNs,"class"))for(var d=d.firstChild.childNodes,g=0;g<d.length;g++)d.item(g).getAttributeNS(szMapNs,"class");else d.getAttributeNS(szMapNs,
"class");else if(this.szFlag.match(/DOMINANT/))for(a in this.itemA)if(this.itemA[a].nClass==c&&"highlight"==this.evidenceMode)for(e=this.getItemNodes(a),f=0;f<e.length;f++);else{if(this.itemA[a].nClass!=c&&"highlight"!=this.evidenceMode)for(e=this.getItemNodes(a),f=0;f<e.length;f++);}else{var d=new point(1E5,1E5),g=new point(-1E5,-1E5),l=this.partsA[c].min,n=this.partsA[c].max;for(f=1;f<b;f++)l=Math.min(l,this.partsA[c+f].min),n=Math.max(n,this.partsA[c+f].max);this.szFlag.match(/CATEGORICAL/)&&(l++,
n++);for(a in this.itemA)if(this.itemA[a].nValuesA[0]>l&&this.itemA[a].nValuesA[0]<n)for(e=this.getItemNodes(a),f=0;f<e.length;f++){var k=map.Dom.getBox(e[f]);if(0===k.width||0===k.height){var q=getMatrix(e[f]);k.x+=q[4];k.y+=q[5];k.width=map.Scale.viewBox.width/20;k.height=map.Scale.viewBox.height/20;k.x-=k.width/2;k.y-=k.height/2}q=map.Scale.getMapOffset(e[f]);k.x+=q.x;k.y+=q.y;d.x=Math.min(d.x,k.x);d.y=Math.min(d.y,k.y);g.x=Math.max(g.x,k.x+k.width);g.y=Math.max(g.y,k.y+k.height)}a=new box(d.x,
d.y,g.x-d.x,g.y-d.y);a.scale(1.2);a=map.Zoom.clipArea(a);map.Zoom.setNewArea(a)}}};
MapTheme.prototype.markClass=function(c,b){if(!1!==this.fMarkEnable)if(map.Themes.enableSubThemes&&this.szFlag.match(/DOMINANT|COMPOSE/)&&!this.szFlag.match(/CHART/))this.createSubTheme(c);else if(isNaN(c))displayMessage("no class!");else{var d=this.szItemFilter&&this.szItemFilter.length;if(!this.szFlag.match(/CHART/)||d)this.fUnmarkEnable=!0,this.unmarkClass(),this.fUnmarkEnable=!1;if(!1!==this.fMarkEnable){var a=0;if(this.szFlag.match(/DOMINANT/)&&!this.szFlag.match(/CHART/))for(var f in this.itemA)this.itemA[f].nClass==
c&&a++;else a=1==this.partsA.length&&this.szFlag.match(/DOPACITY/)?99:this.partsA[c]?this.partsA[c].nCount:0;if(500<a&&"highlight"==this.evidenceMode)displayMessage("Sorry ! to many members");else if(0===a)displayMessage("class has no members !",3E3);else{clearMessage();highLightList.removeAll();var a=null,e=(this.fShadow?5:10)/this.nScale;if(this.szFlag.match(/CHART/)){f=this.chartGroup.childNodes;for(var g=[],a=0;a<f.length;a++){var l=f.item(a);if(null==l.getAttributeNS(szMapNs,"class")||""===l.getAttributeNS(szMapNs,
"class"))for(var n=l.getElementsByTagName("g"),k=0;k<n.length;k++)for(var q=n.item(k).childNodes,h=0;h<q.length;h++){var u=q.item(h);if(u.getAttributeNS&&u.getAttributeNS(szMapNs,"class")){if(this.szFlag.match(/SEQUENCE/)&&!this.szFlag.match(/PLOT/)&&"isolate_gray"!=this.evidenceMode){var w=u.getAttributeNS(null,"transform");w&&w.length&&(u.setAttributeNS(szMapNs,"orig-transform",w),u.setAttributeNS(null,"transform",""))}w=Number(u.getAttributeNS(szMapNs,"class"));this.szFlag.match(/BAR/)&&this.szFlag.match(/3D/)&&
!this.szFlag.match(/STACKED/)&&(1<this.szFieldsA.length||this.szFlag.match(/AGGREGATE/)&&this.szFlag.match(/CATEGORICAL/))?!0===this.markedClasses[w]?(u.setAttributeNS(null,"transform","matrix(1 0 0 1 -10 6.6)"),u.style.setProperty("fill-opacity","1","")):(u.setAttributeNS(null,"transform","matrix(1 0 0 1 0 0)"),u.style.setProperty("fill-opacity","0.85","")):!0===this.markedClasses[w]?d||(u.style.setProperty("display","inline",""),u.getAttributeNS(szMapNs,"save-style")&&u.setAttributeNS(null,"style",
u.getAttributeNS(szMapNs,"save-style")),g.push(l)):"isolate_gray"==this.evidenceMode?(u.getAttributeNS(szMapNs,"save-style")||u.setAttributeNS(szMapNs,"save-style",u.getAttributeNS(null,"style")),u.style.setProperty("fill","#bbbbbb",""),"none"!=u.style.getPropertyValue("stroke")&&u.style.setProperty("stroke","#888888",""),w=u.style.getPropertyValue("fill-opacity"),this.szFlag.match(/SEQUENCE/)||this.szFlag.match(/WAFFLE/)?(u.style.setProperty("fill-opacity","0",""),u.style.setProperty("stroke-opacity",
String(.9*w),""),u.style.setProperty("stroke-width",String(e),"")):u.style.setProperty("fill-opacity","0","")):u.style.setProperty("display","none","")}}else w=Number(l.getAttributeNS(szMapNs,"class")),!0===this.markedClasses[w]?d||(this.szFlag.match(/VECTOR/)?(l.firstChild.style.setProperty("stroke","",""),l.firstChild.style.setProperty("stroke-opacity","",""),l.firstChild.style.setProperty("marker-end","",""),l.style.setProperty("display","inline","")):(l.style.setProperty("display","inline",""),
(w=l.getAttributeNS(szMapNs,"fill"))&&l.style.setProperty("fill",w,"")),g.push(l)):"isolate_gray"==this.evidenceMode?this.szFlag.match(/VECTOR/)?(l.firstChild.style.setProperty("stroke","#888888",""),l.firstChild.style.setProperty("stroke-opacity","0.5",""),l.firstChild.style.setProperty("marker-end","none","")):(l.setAttributeNS(szMapNs,"fill",l.style.getPropertyValue("fill")),l.style.setProperty("fill","#bbbbbb",""),l.setAttributeNS(szMapNs,"stroke",l.style.getPropertyValue("fill")),l.style.setProperty("stroke",
"#888888",""),l.setAttributeNS(szMapNs,"fill-opacity",l.style.getPropertyValue("fill-opacity")),l.style.setProperty("fill-opacity","0.05","")):l.style.setProperty("display","none","")}g.forEach(function(a){a.parentNode.appendChild(a)})}else{this.beginDraw();if(this.szFlag.match(/DOMINANT/))for(f in this.itemA)if(this.itemA[f].nClass==c&&"highlight"==this.evidenceMode)for(a=this.getItemNodes(f),d=0;d<a.length;d++)highLightList.addItem(a[d]);else{if(this.itemA[f].nClass!=c&&"highlight"!=this.evidenceMode)for(a=
this.getItemNodes(f),d=0;d<a.length;d++)a[d].setAttributeNS(szMapNs,"themestyle",a[d].getAttributeNS(null,"style")),a[d].style.setProperty("display","none","")}else{d=this.partsA[c].min;e=this.partsA[c].max;for(a=1;a<b;a++)d=Math.min(d,this.partsA[c+a].min),e=Math.max(e,this.partsA[c+a].max);for(f in this.itemA)if(d=!1,this.markedClasses&&this.markedClasses[this.itemA[f].nClass]&&(d=!0),d){if("highlight"==this.evidenceMode)for(a=this.getItemNodes(f),d=0;d<a.length;d++)highLightList.addItem(a[d])}else if("highlight"!=
this.evidenceMode)for(a=this.getItemNodes(f),d=0;d<a.length;d++)if(this.szFlag.match(/BUFFER/))(e=SVGDocument.getElementById(a[d].getAttributeNS(null,"id")+":paint"))&&e.style.setProperty("display","none","");else{a[d].setAttributeNS(szMapNs,"themestyle",a[d].getAttributeNS(null,"style"));a[d].setAttributeNS(null,"style",a[d].getAttributeNS(szMapNs,"origthemestyle"));g=a[d].getAttribute("id");a[d].firstChild&&a[d].firstChild.nextSibling&&(g=a[d].firstChild.nextSibling.getAttribute("id")||g);if(e=
SVGDocument.getElementById(g+"L"))e.setAttributeNS(szMapNs,"display",e.style.getPropertyValue("display")),e.style.setProperty("display","none","");if(e=SVGDocument.getElementById(g+"L:bg"))e.setAttributeNS(szMapNs,"display",e.style.getPropertyValue("display")),e.style.setProperty("display","none","");if(e=SVGDocument.getElementById(g+":::value"))e.setAttributeNS(szMapNs,"display",e.style.getPropertyValue("display")),e.style.setProperty("display","none","");if(e=SVGDocument.getElementById(g+":::value:bg"))e.setAttributeNS(szMapNs,
"display",e.style.getPropertyValue("display")),e.style.setProperty("display","none","")}}this.endDraw();this.fMarkClass=!0}}}}};
MapTheme.prototype.unmarkClass=function(c){if(!1!==this.fUnmarkEnable)if(this.subTheme)this.removeSubTheme();else if(this.szItemFilter&&this.szItemFilter.length)this.fMarkEnable=!0,this.filterItems(this.szItemFilter,this.itemFilterOpt);else if(clearMessage(),this.szFlag.match(/CHART/)){var b=this.chartGroup.childNodes;for(c=0;c<b.length;c++){var d=b.item(c);if(null==d.getAttributeNS(szMapNs,"class")||""===d.getAttributeNS(szMapNs,"class"))for(var d=d.getElementsByTagName("g"),a=0;a<d.length;a++)for(var f=
d.item(a).childNodes,e=0;e<f.length;e++){var g=f.item(e);if(g.getAttributeNS&&g.getAttributeNS(szMapNs,"class")){if(this.szFlag.match(/SEQUENCE/)){var l=g.getAttributeNS(szMapNs,"orig-transform");l&&l.length&&(g.removeAttributeNS(szMapNs,"orig-transform"),g.setAttributeNS(null,"transform",l))}this.szFlag.match(/BAR/)&&this.szFlag.match(/3D/)&&!this.szFlag.match(/STACKED/)&&(g.setAttributeNS(null,"transform","matrix(1 0 0 1 0 0)"),g.style.setProperty("fill-opacity","1",""));g.style&&(g.style.setProperty("display",
"inline",""),g.getAttributeNS(szMapNs,"save-style")&&g.setAttributeNS(null,"style",g.getAttributeNS(szMapNs,"save-style")))}}else this.szFlag.match(/VECTOR/)&&(d.firstChild.style.setProperty("stroke","",""),d.firstChild.style.setProperty("stroke-opacity","",""),d.firstChild.style.setProperty("marker-end","","")),d.style.setProperty("display","inline","")}this.szFlag.match(/TEXTONLY/)&&setTimeout(function(){map.Layer.adaptLabel()},10)}else{this.beginDraw();if("highlight"!=this.evidenceMode)for(b in this.itemA)for(c=
this.getItemNodes(b),d=0;d<c.length;d++)this.szFlag.match(/BUFFER/)?(a=SVGDocument.getElementById(c[d].getAttributeNS(null,"id")+":paint"))&&a.style.setProperty("display","inline",""):(a=c[d].getAttributeNS(szMapNs,"themestyle"))&&a.length&&"null"!=a&&(c[d].setAttributeNS(null,"style",a),c[d].removeAttributeNS(szMapNs,"themestyle"),f=c[d].getAttribute("id"),c[d].firstChild&&c[d].firstChild.nextSibling&&(f=c[d].firstChild.nextSibling.getAttribute("id")||f),(a=SVGDocument.getElementById(f+"L"))&&a.style.setProperty("display",
a.getAttributeNS(szMapNs,"display"),""),(a=SVGDocument.getElementById(f+"L:bg"))&&a.style.setProperty("display",a.getAttributeNS(szMapNs,"display"),""),(a=SVGDocument.getElementById(f+":::value"))&&a.style.setProperty("display",a.getAttributeNS(szMapNs,"display"),""),(a=SVGDocument.getElementById(f+":::value:bg"))&&a.style.setProperty("display",a.getAttributeNS(szMapNs,"display"),""));else highLightList.removeAll();this.endDraw();this.fMarkClass=!1}};
MapTheme.prototype.showClass=function(c,b,d){var a=0;if(this.szFlag.match(/DOMINANT/))for(var f in this.itemA)this.itemA[f].nClass==c&&a++;clearMessage();var e=null,a=d?"inline":"none";if(this.szFlag.match(/CHART/))for(d=this.chartGroup.childNodes,e=0;e<d.length;e++){var g=d.item(e);if(null==g.getAttributeNS(szMapNs,"class")||""===g.getAttributeNS(szMapNs,"class"))for(var g=g.firstChild.childNodes,l=0;l<g.length;l++)b=g.item(l),f=Number(b.getAttributeNS(szMapNs,"class")),f==c&&b.style.setProperty("display",
a,"");else f=Number(g.getAttributeNS(szMapNs,"class")),f==c&&g.style.setProperty("display",a,"")}else{this.beginDraw();if(this.szFlag.match(/DOMINANT/))for(f in this.itemA){if(this.itemA[f].nClass==c)for(e=this.getItemNodes(f),b=0;b<e.length;b++)e[b].setAttributeNS(szMapNs,"themestyle",e[b].getAttributeNS(null,"style")),e[b].style.setProperty("display",a,"")}else{g=this.partsA[c].min;l=this.partsA[c].max;for(e=1;e<b;e++)g=Math.min(g,this.partsA[c+e].min),l=Math.max(l,this.partsA[c+e].max);this.szFlag.match(/CATEGORICAL/)&&
(g++,l++);for(f in this.itemA)if(this.szFlag.match(/CATEGORICAL/)&&this.itemA[f].nValuesA[0]==g||this.itemA[f].nValuesA[0]>g&&this.itemA[f].nValuesA[0]<l)for(e=this.getItemNodes(f),b=0;b<e.length;b++)this.szFlag.match(/BUFFER/)?(c=SVGDocument.getElementById(e[b].getAttributeNS(null,"id")+":paint"))&&c.style.setProperty("display",a,""):d?(c=e[b].getAttributeNS(szMapNs,"themestyle"))&&c.length&&"null"!=c&&(e[b].setAttributeNS(null,"style",c),e[b].removeAttributeNS(szMapNs,"themestyle")):(e[b].setAttributeNS(szMapNs,
"themestyle",e[b].getAttributeNS(null,"style")),e[b].setAttributeNS(null,"style",e[b].getAttributeNS(szMapNs,"origthemestyle")))}this.endDraw()}};
MapTheme.prototype.setTimeFrame=function(c,b){clearMessage();highLightList.removeAll();var d=this.szItemFilter&&this.szItemFilter.length,a=(this.fShadow?5:10)/this.nScale,f=this.chartGroup.childNodes;this.szFlag.match(/CHART/)&&(f=this.chartGroup.parentNode.childNodes);for(var e=[],g=0;g<f.length;g++){var l=f.item(g);if(null==l.getAttributeNS(szMapNs,"time")||""===l.getAttributeNS(szMapNs,"time"))for(var n=l.getElementsByTagName("g"),k=0;k<n.length;k++)for(var q=n.item(k).childNodes,h=0;h<q.length;h++){var u=
q.item(h);if(u.getAttributeNS&&u.getAttributeNS(szMapNs,"time")){var w=Number(u.getAttributeNS(szMapNs,"time"));this.szFlag.match(/BAR/)&&this.szFlag.match(/3D/)&&!this.szFlag.match(/STACKED/)&&(1<this.szFieldsA.length||this.szFlag.match(/AGGREGATE/)&&this.szFlag.match(/CATEGORICAL/))?w>=c&&w<=b?(u.setAttributeNS(null,"transform","matrix(1 0 0 1 -10 6.6)"),u.style.setProperty("fill-opacity","1","")):(u.setAttributeNS(null,"transform","matrix(1 0 0 1 0 0)"),u.style.setProperty("fill-opacity","0.85",
"")):w>=c&&w<=b?d||(u.style.setProperty("display","inline",""),u.getAttributeNS(szMapNs,"save-style")&&u.setAttributeNS(null,"style",u.getAttributeNS(szMapNs,"save-style")),e.push(l)):"isolate_gray"==this.evidenceMode?(u.getAttributeNS(szMapNs,"save-style")||u.setAttributeNS(szMapNs,"save-style",u.getAttributeNS(null,"style")),u.style.setProperty("fill","#bbbbbb",""),"none"!=u.style.getPropertyValue("stroke")&&u.style.setProperty("stroke","#888888",""),w=u.style.getPropertyValue("fill-opacity"),this.szFlag.match(/SEQUENCE/)||
this.szFlag.match(/WAFFLE/)?(u.style.setProperty("fill-opacity","0",""),u.style.setProperty("stroke-opacity",String(.9*w),""),u.style.setProperty("stroke-width",String(a),"")):u.style.setProperty("fill-opacity","0","")):u.style.setProperty("display","none","")}}else if(w=Number(l.getAttributeNS(szMapNs,"time")),w>=c&&w<=b){if(!d){if(this.szFlag.match(/VECTOR/))l.firstChild.style.setProperty("stroke","",""),l.firstChild.style.setProperty("stroke-opacity","",""),l.firstChild.style.setProperty("marker-end",
"",""),l.style.setProperty("display","inline","");else{l.style.setProperty("display","inline","");var p;(p=l.getAttributeNS(szMapNs,"fill"))&&l.style.setProperty("fill",p,"")}e.push(l)}}else"isolate_gray"==this.evidenceMode?this.szFlag.match(/VECTOR/)?(l.firstChild.style.setProperty("stroke","#888888",""),l.firstChild.style.setProperty("stroke-opacity","0.5",""),l.firstChild.style.setProperty("marker-end","none","")):(l.setAttributeNS(szMapNs,"fill",l.style.getPropertyValue("fill")),l.style.setProperty("fill",
"#bbbbbb",""),l.setAttributeNS(szMapNs,"stroke",l.style.getPropertyValue("fill")),l.style.setProperty("stroke","#888888",""),l.setAttributeNS(szMapNs,"fill-opacity",l.style.getPropertyValue("fill-opacity")),l.style.setProperty("fill-opacity","0.05","")):l.style.setProperty("display","none","")}e.forEach(function(a){a.parentNode.appendChild(a)})};
MapTheme.prototype.createSubTheme=function(c){this.subTheme&&this.removeSubTheme();if(null!=c||this.markedClasses&&this.markedClasses.length){var b="";this.coTable&&"undefined"!=typeof this.coTable&&(b+="dbtable:"+this.coTable+";");this.szSelectionField&&"undefined"!=typeof this.szSelectionField&&(b+="lookupfield:"+this.szSelectionField+";");this.szAlphaField&&"undefined"!=typeof this.szAlphaField&&(b+="alphafield:"+this.szAlphaField+";");this.szAlphaField100&&"undefined"!=typeof this.szAlphaField100&&
(b+="alphafield100:"+this.szAlphaField100+";");this.szTitleField&&"undefined"!=typeof this.szTitleField&&(b+="titlefield:"+this.szTitleField+";");this.nDopacityScale&&"undefined"!=typeof this.nDopacityScale&&(b+="dopacityscale:"+this.nDopacityScale+";");this.nDopacityPow&&"undefined"!=typeof this.nDopacityPow&&(b+="dopacitypow:"+this.nDopacityPow+";");var d="lookuptoupper:"+(this.fSelectionFieldToUpper||null)+";",d=d+("lookupsuffix:"+(this.szSelectionFieldSuffix||null)+";"),d=d+("lookupprefix:"+(this.szSelectionFieldPrefix||
null)+";"),d=d+("lookupdigits:"+(Number(this.nSelectionFieldDigits)||null)+";"),d=d+("lookuptonumber:"+(this.fSelectionFieldToNumber||null)+";"),d=d+("lookuptoupper:"+(this.fSelectionFieldToUpper||null)+";"),b=b+d;this.szAggregationField&&"undefined"!=typeof this.szAggregationField&&(b+="aggregationfield:"+this.szAggregationField+";");this.szUnits&&"undefined"!=typeof this.szUnits&&(b+="units:"+this.szUnits+";");var a="";this.szFlag.match(/DOPACITY/)&&(a+="DOPACITYMAX|");this.szFlag.match(/AGGREGATE/)&&
(a+="AGGREGATE|");this.szFlag.match(/GROUP/)&&(a+="GROUP|");this.szFlag.match(/SUM/)&&(a+="SUM|");this.szFlag.match(/ZEROISVALUE/)&&(a+="ZEROISVALUE|");this.szFlag.match(/VALUES/)&&(a+="VALUES|");map.Themes.enableMultiChoropleth=!0;if(this.szFlag.match(/CATEGORICAL/)&&this.szFlag.match(/AGGREGATE/)&&this.szLabelA){for(var f=[],e=[],d=0;d<this.markedClassesA.length;d++)f.push(this.szLabelA[this.markedClassesA[d]]),e.push(this.colorScheme[this.markedClassesA[d]]);this.markedClassesA&&1<this.markedClassesA.length?
(b=this.getDefinitionObject(),b.style.type+="|NOINFO",b.style.values=f,b.style.colorscheme=e,this.subTheme=map.Themes.newThemeByObj(b)):(b+='filter:WHERE "'+this.szFields+'" IN "('+f.join(",")+')";',this.subTheme=map.Themes.newTheme(this.szThemes,this.szFields,this.szField100,"type:CHOROPLETH|CATEGORICAL|NOINFO|NOLEGEND|SUBTHEME|"+a+";colorscheme:7|white|"+this.colorScheme[c]+";"+b,this.szLabelA[c],""),this.subTheme.parentTheme=this)}else if(this.markedClassesA&&1<this.markedClassesA.length){c=this.szFields.split("|");
a=e=f="";for(d=0;d<this.markedClassesA.length;d++)f+=(f.length?"|":"")+c[this.markedClassesA[d]],e+=(e.length?"|":"")+this.colorScheme[this.markedClassesA[d]],a+=(a.length?"|":"")+this.szLabelA[this.markedClassesA[d]];this.subTheme=map.Themes.newTheme(this.szThemes,f,this.szField100,"type:"+this.szFlag+"|NOINFO;colorscheme:"+e+";label:"+a+";"+b)}else c=this.markedClassesA[0]||c,this.subTheme=map.Themes.newTheme(this.szThemes,this.szFields.split("|")[c],this.szField100,"type:CHOROPLETH|LOG|DOPACITY|NOINFO|NOLEGEND|SUBTHEME|"+
a+";colorscheme:7|white|"+this.colorScheme[c]+";"+b+";alphafield:null;alphafield100:null;dopacitypow:1;dopacityscale:2;",this.szLabelA?this.szLabelA[c]:"","");map.Themes.subTheme=this}};MapTheme.prototype.removeSubTheme=function(){map.Themes.enableMultiChoropleth=!1;this.subTheme&&(map.Themes.subTheme=!1,map.Themes.removeTheme(null,this.subTheme.szId),this.subTheme=null,map.Themes.realizeDone(this))};
MapTheme.prototype.isItemInFilter=function(c,b,d,a){if(0===d.length&&("undefined"==typeof a||!a.field))return!0;if("undefined"!=typeof b.dbIndex||"undefined"!=typeof b.dbIndexA)if(b=b.dbIndex||b.dbIndexA[0],d.length){if(this.__szValue=c.dbRecords[b].join(" "),eval("this.__szValue.match(/"+d.replace(/\//gi,"\\/")+"/i)"))return!0}else if(a&&a.field){for(d=0;d<c.dbFields.length;d++)if(c.dbFields[d].id==a.field&&(a.min&&c.dbRecords[b][d]<a.min||a.max&&c.dbRecords[b][d]>a.max||a.txt&&c.dbRecords[b][d]!=
a.txt))return!1;return!0}return!1};
MapTheme.prototype.filterItems=function(c,b){if(!1!==this.fMarkEnable){this.szItemFilter=c;this.itemFilterOpt=b;this.filterNodesA=c.length||b&&b.field?[]:null;for(var d=null,a=0;a<this.szThemesA.length&&(!(d=this.objThemesA[this.szThemesA[a]])||!d.dbRecords);a++);if(d&&d.dbRecords){if(this.szFlag.match(/CHART/))for(var f=this.chartGroup.childNodes,a=0;a<f.length;a++){var e=[],g=f.item(a);e.push(g);for(var l=0;l<e.length;l++){var n=e[l].getAttributeNS(null,"id"),n=n.split(":")[1]+"::"+n.split(":")[3];
this.itemA[n]?this.isItemInFilter(d,this.itemA[n],c,b)?(g.style.setProperty("display","inline",""),this.filterNodesA&&this.filterNodesA.push(n)):g.style.setProperty("display","none",""):g.style.setProperty("display","inline","")}}else{this.beginDraw();for(f in this.itemA)if(this.itemA[f]&&"undefined"!=typeof this.itemA[f].dbIndex)if(this.isItemInFilter(d,this.itemA[f],c,b))for(this.filterNodesA&&this.filterNodesA.push(f),a=this.getItemNodes(f),e=0;e<a.length;e++)this.szFlag.match(/BUFFER/)?(g=SVGDocument.getElementById(a[e].getAttributeNS(null,
"id")+":paint"))&&g.style.setProperty("display","inline",""):(g=a[e].getAttributeNS(szMapNs,"themestyle"))&&g.length&&"null"!=g&&(a[e].setAttributeNS(null,"style",g),a[e].removeAttributeNS(szMapNs,"themestyle"),(g=SVGDocument.getElementById(a[e].firstChild.nextSibling.getAttribute("id")+"L"))&&g.style.setProperty("display",g.getAttributeNS(szMapNs,"display"),""),(g=SVGDocument.getElementById(a[e].firstChild.nextSibling.getAttribute("id")+"L:bg"))&&g.style.setProperty("display",g.getAttributeNS(szMapNs,
"display"),""));else for(a=this.getItemNodes(f),e=0;e<a.length;e++)if(this.szFlag.match(/BUFFER/))(g=SVGDocument.getElementById(a[e].getAttributeNS(null,"id")+":paint"))&&g.style.setProperty("display","none","");else{a[e].getAttributeNS(szMapNs,"themestyle")||a[e].setAttributeNS(szMapNs,"themestyle",a[e].getAttributeNS(null,"style"));a[e].setAttributeNS(null,"style",a[e].getAttributeNS(szMapNs,"origthemestyle"));if(g=SVGDocument.getElementById(a[e].firstChild.nextSibling.getAttribute("id")+"L"))g.setAttributeNS(szMapNs,
"display",g.style.getPropertyValue("display")),g.style.setProperty("display","none","");if(g=SVGDocument.getElementById(a[e].firstChild.nextSibling.getAttribute("id")+"L:bg"))g.setAttributeNS(szMapNs,"display",g.style.getPropertyValue("display")),g.style.setProperty("display","none","")}this.endDraw()}this.fMarkClass=!0}}};MapTheme.prototype.selectFilterItems=function(){map.Selections.newSelection("generic",this.filterNodesA,"type:queryresult",this.szItemFilter)};
MapTheme.prototype.highlightItems=function(c,b){if(""===c)this.clearHighlightItems();else{highLightList.removeAll();var d=this;c.split(b||",").forEach(function(a){if(d.szFlag.match(/CHART/)){var b=SVGDocument.getElementById(d.szId+":"+a+":chartgroup");b||(a=d.szThemesA[0]+"::"+a,b=SVGDocument.getElementById(d.szId+":"+a+":chartgroup"));highLightList.addItem(b.parentNode,"isolate");map.displayInfo(null,b.firstChild,"add|fix")}else{a=d.getItemNodes(a);for(b=0;b<a.length;b++)highLightList.addItem(a[b]);
map.displayInfo(null,a[0].firstChild.nextSibling,"add|fix")}})}};MapTheme.prototype.clearHighlightItems=function(){highLightList.removeAll();map.removeInfo()};
MapTheme.prototype.labelMap=function(c){var b=map.Zoom.getBox(),d=null;this.szValuesTextStyle="font-family:verdana;font-size:"+map.Scale.normalX(11)+"px;pointer-events:none";if(!c||0===c){var a=0;c=0;this.indexA=[];var f=0,e=0;if(this.fClipCharts)for(a in this.itemA){if(e++,this.itemA[a].nValuesA&&0<this.itemA[a].nValuesA.length&&(d=this.getNodePosition(this.itemA[a].szSelectionId)))if(d.x<b.x||d.x>b.x+b.width||d.y<b.y||d.y>b.y+b.height){if(this.nSkipCount++,d=SVGDocument.getElementById(this.szId+
":"+a+":chart"))d.parentNode.removeChild(d),this.chartPosA[this.itemA[a].szSelectionId]=null,this.posItemA[this.itemA[a].szSelectionId]=null}else this.indexA[this.indexA.length]=a,f++}else for(a in this.itemA)this.indexA[this.indexA.length]=a,e++,f++;f>this.nMaxThemeCharts&&(this.indexA.length=0,this.nSkipCount=f);this.mapSleep&&(this.mapSleep.nCount=f);this.fEnableProgressBar=!1}for(;c<this.indexA.length;c++){if(this.fCancel){displayMessage("Canceled by user",1E3,!0);this.fCancel=!1;return}if(this.mapSleep&&
(this.mapSleep.nDoneCount=this.nDoneCount,this.mapSleep.checkSleep(c,10))){this.fContinue=!0;this.continueIndex=c;return}a=this.indexA[c];this.nDoneCount++;if(this.itemA[a].nValuesA&&0<this.itemA[a].nValuesA.length)if(d=this.getNodePosition(this.itemA[a].szSelectionId))if(this.fClipCharts&&!this.szFlag.match(/BUFFER/)&&(d.x<b.x||d.x>b.x+b.width||d.y<b.y||d.y>b.y+b.height))this.nSkipCount++;else for(d=this.getItemNodes(a),f=0;f<d.length;f++)e=this.itemA[a].nValue,!this.szValueField&&this.itemA[a].szLabel&&
(e=this.itemA[a].szLabel),this.labelShape(d[f],this.itemA[a].szColor,e);else this.nMissingPositionCount++}this.fMakeLabel=!1;setTimeout(function(){map.Layer.adaptLabel(null)},10)};MapTheme.prototype.unlabelMap=function(){for(var c in map.Layer.generatedLabelA)map.Dom.removeElementById(c),map.Layer.generatedLabelA[c]=null};
MapTheme.prototype.labelShape=function(c,b,d){if(this.szFlag.match(/VALUES/)&&"undefined"!=d&&"undefined"!=typeof d&&(!this.szFlag.match(/NOZERO/)||0!==d)){var a=c.parentNode.getAttributeNS(null,"id"),f=SVGDocument.getElementById(a+":label");if(f){var e=SVGDocument.getElementById(a+":values:bg");e||(e=map.Dom.newGroup(f.parentNode,a+":values:bg"),map.Layer.generatedLabelA[a+":values:bg"]=e);var g=SVGDocument.getElementById(a+":values");g||(g=map.Dom.newGroup(f.parentNode,a+":values"),map.Layer.generatedLabelA[a+
":values"]=g);try{var l=c.firstChild.nextSibling.getAttributeNS(null,"id").split("#"),n=l[0]+"L"+(l[1]?"#"+l[1]:"")}catch(k){n=c.getAttributeNS(null,"id")+":::value"}if(!SVGDocument.getElementById(n)){f=__maptheme_getChartColors(b);b="string"==typeof d?d:this.formatValue(d,this.nValueDecimals||0)+(this.szUnit.match(/\%/)?"%":"");var a="#ffffff",a=this.szTextColor||f.highColor,l=f.lowColor,q=1,f=Math.max(.3,c.style.getPropertyValue("fill-opacity")||"1");this.szFlag.match(/DTEXT/)&&(q=Math.max(.7,Math.min(1.5,
2/Math.sqrt(this.nMax)*Math.sqrt(d))));d=map.Scale.normalX(11)*map.Scale.nZoomScale*q*map.Scale.nLabelScaling*(this.nLabelScale||1);e=map.Dom.newText(e,0,0,"font-family:verdana;font-weight:normal;font-size:"+d+"px;text-anchor:middle;fill:none;stroke:"+l+";stroke-width:"+map.Scale.normalX(4)*map.Scale.nZoomScale+";stroke-opacity:0.5;pointer-events:none;display:none;stroke-linejoin:bevel;",b);g=map.Dom.newText(g,0,0,"font-family:verdana;font-weight:normal;font-size:"+d+"px;text-anchor:middle;fill:"+
a+";stroke:none;pointer-events:none;display:none;",b);g.setAttributeNS(null,"id",n);e.setAttributeNS(null,"id",n+":bg");this.szFlag.match(/DOPACITY/)&&(g.style.setProperty("fill-opacity",f,""),e.style.setProperty("stroke-opacity",.3*f,""));(n=c.getAttributeNS(szMapNs,"center"))?(c=n.split(","),c=new point(Number(c[0].split(":")[1]),Number(c[1].split(":")[1]))):c=this.getNodePosition(c.getAttributeNS(null,"id"));c&&(g.fu.setPosition(c.x,c.y),e.fu.setPosition(c.x,c.y))}}}};
MapTheme.prototype.zoomTo=function(){var c=new point(1E5,1E5),b=new point(-1E5,-1E5);if(this.szFlag.match(/FEATURE/)){var c=SVGDocument.getElementById(this.szThemesA[0]),d=map.Dom.getBox(c);map.Zoom.setNewArea(d)}else{if(this.szFlag.match(/CHART/))for(var a in this.itemA)(d=this.itemA[a].ptPos||this.getNodePosition(this.itemA[a].szSelectionId))&&d.x&&d.y&&(c.x=Math.min(c.x,d.x),c.y=Math.min(c.y,d.y),b.x=Math.max(b.x,d.x),b.y=Math.max(b.y,d.y));else for(a in this.itemA)for(var f=this.getItemNodes(a),
e=0;e<f.length;e++){d=map.Dom.getBox(f[e]);if(0===d.width||0===d.height){var g=getMatrix(f[e]);d.x+=g[4];d.y+=g[5];d.width=map.Scale.viewBox.width/20;d.height=map.Scale.viewBox.height/20;d.x-=d.width/2;d.y-=d.height/2}g=map.Scale.getMapOffset(f[e]);d.x+=g.x;d.y+=g.y;c.x=Math.min(c.x,d.x);c.y=Math.min(c.y,d.y);b.x=Math.max(b.x,d.x+d.width);b.y=Math.max(b.y,d.y+d.height)}c=new box(c.x,c.y,b.x-c.x,b.y-c.y);c.scale(1);c=map.Zoom.clipArea(c);map.Zoom.setNewArea(c)}};
MapTheme.prototype.createChartGroup=function(c){if(!this.chartGroup){if(this.szFlag.match(/FEATURE/)){if(this.chartGroup=map.Dom.newGroup(map.Layer.layerNode,this.szThemesA[0]),map.Dom.newGroup(map.Layer.layerNode,this.szThemesA[0]+":label"),map.Layer.listA[this.szThemesA[0]]=new Map.Layer.Item(null),map.Layer.listA[this.szThemesA[0]].szName=this.szThemesA[0],map.Layer.listA[this.szThemesA[0]].szHighlight="fill:url(#DiagUp200000000);stroke:black;stroke-width:3;stroke-linecap:round;stroke-linejoin:round;",
map.Layer.listA[this.szThemesA[0]].szSelection=this.szItemField,this.nFeatureLower||this.nFeatureUpper)map.Layer.depListA[this.szThemesA[0]]={},map.Layer.depListA[this.szThemesA[0]].nLower=this.nFeatureLower||0,map.Layer.depListA[this.szThemesA[0]].nUpper=this.nFeatureUpper||1E9,map.Layer.depListA[this.szThemesA[0]].shapeId=this.szThemesA[0],map.Layer.depListA[this.szThemesA[0]].szDisplayAttribute="none",map.Layer.depListA[this.szThemesA[0]].szFeature=this.szThemesA[0],setTimeout("map.Layer.switchScaleDependentLayer(null)",
10)}else this.chartGroup=map.Dom.newGroup(c,this.szId+":chartgroup");this.chartGroup.style.setProperty("opacity",String(this.nOpacity?this.nOpacity:1),"");0==this.fVisible&&this.chartGroup.style.setProperty("display","none","");this.szFlag.match(/SILENT/)&&this.chartGroup.style.setProperty("pointer-events","none","");this.szFlag.match(/VECTOR/)&&antiZoomAndPanList.addGroup(this.chartGroup);this.szFlag.match(/NOSCALE/)&&antiZoomAndPanList.addGroup(this.chartGroup);this.szFlag.match(/AGGREGATE/)&&(this.szFlag.match(/AUTOSIZE/)||
this.szFlag.match(/GRIDSIZE/))&&antiZoomAndPanList.addGroup(this.chartGroup);this.szFlag.match(/GRIDSIZE/)&&!this.szFlag.match(/AGGREGATE/)&&antiZoomAndPanList.addGroup(this.chartGroup);if(this.szFlag.match(/BUFFER/)){this.szFlag.match(/OVERLAY/)&&!this.szShapeType.match(/line/)&&this.chartGroup.style.setProperty("opacity","1","");map.Layer.getLayerObj(this.szThemesA[0]);this.chartGroup.style.setProperty("pointer-events","none","");antiZoomAndPanList.addGroup(this.chartGroup);c=this.colorScheme[0];
var b=this.colorScheme[1]?this.colorScheme[1]:"red";"undefined"!=typeof this.szBorderColor&&(b=this.szBorderColor);var d="stroke-width:0;";if("undefined"!=typeof this.szBorderStyle)switch(this.szBorderStyle){case "dotted":d="stroke-width:"+map.Scale.normalX(1)+";stroke-linecap:round;stroke-dasharray:1,50;";break;case "dashed":d="stroke-width:"+map.Scale.normalX(1)+";stroke-linecap:butt;stroke-dasharray:300,300;";break;case "solid":d="stroke-width:"+map.Scale.normalX(1)+";";break;case "none":d="stroke-width:0;"}if("undefined"!=
typeof this.szBorderWidth)switch(this.szBorderWidth){case "thin":d+="stroke-width:"+map.Scale.normalX(.5)+";";break;case "thick":d+="stroke-width:"+map.Scale.normalX(1.5)+";";break;default:d+="stroke-width:"+map.Scale.normalX(this.szBorderWidth)+";"}this.chartGroup.setAttributeNS(null,"style","fill:"+c+";fill-opacity:"+(this.fillOpacity?this.fillOpacity:this.nOpacity?this.nOpacity:0)+";stroke:"+b+";"+d+";")}}};
MapTheme.prototype.chartMap=function(c){if(this.nChartUpper||this.nChartLower){if(this.nChartUpper&&map.Scale.nTrueMapScale*map.Scale.nZoomScale>this.nChartUpper||this.nChartLower&&map.Scale.nTrueMapScale*map.Scale.nZoomScale<=this.nChartLower){this.chartGroup||this.createChartGroup(map.Layer.objectGroup);this.chartGroup.style.setProperty("display","none","");this.fVisible=!1;this.realizeDone();return}this.chartGroup||this.createChartGroup(map.Layer.objectGroup);this.chartGroup.style.setProperty("display",
"inline","");this.fVisible=!0}this.chartGroup&&!c&&(this.chartPosA=[]);var b=this.nChartSize?this.nChartSize:30,d=map.Zoom.getBox(),a=this.szFlag.match(/AGGREGATE/)&&this.nGridWidth?map.Scale.getDeltaXofDistanceInMeter(this.nGridWidth||0)*map.Scale.nZoomScale:map.Scale.normalX(30)*map.Scale.nZoomScale;d.x-=a/2;d.y-=a/2;d.width+=a;d.height+=a;var f=null,e=8;if(!c||0===c){if(!this.partsA){this.realizeDone();return}var g=0;c=0;this.indexA=[];this.szValuesLineStyle="stroke:white;stroke-width:"+map.Scale.normalX(1.5)+
";opacity:0.5;";this.szValuesLineBgStyle="stroke:#888888;stroke-width:"+map.Scale.normalX(.5)+";opacity:1;";this.szValuesTextStyle="font-family:"+(this.szTextFont||"arial")+";font-size:"+map.Scale.normalX(e)+"px;fill:#777777;pointer-events:none";this.szValuesTextBgStyle="font-family:"+(this.szTextFont||"arial")+";font-size:"+map.Scale.normalX(e)+"px;fill:none;stroke:white;stroke-width:"+map.Scale.normalY(e)/5+";stroke-opacity:0.8;pointer-events:none;stroke-linejoin:bevel;pointer-events:none";var l=
map.Layer.objectGroup;this.chartGroup||this.createChartGroup(l);this.blur(this.nBlur);if(this.autoOpacity){var n=map.Scale.nTrueMapScale*map.Scale.nZoomScale/map.Scale.nNormalSizeScale;this.fillOpacity=1*Math.max(.1,Math.min(1,20/Math.max(1,Math.pow(map.Zoom.nZoom/n,.5))))}this.mapSleep&&(this.mapSleep.checkSleepMessage="creating charts");this.nSizePow||(this.szFlag.match(/LINEAR/)||this.szFlag.match(/SIZEP1/)?this.nSizePow=1:this.szFlag.match(/SIZEP1H/)?this.nSizePow=1.5:this.szFlag.match(/SIZELOG/)?
this.nSizePow=10:this.szFlag.match(/SIZEP10/)?this.nSizePow=10:this.szFlag.match(/SIZEP4/)?this.nSizePow=4:this.szFlag.match(/SIZEP3/)||this.szFlag.match(/SIZEVOLUME/)?this.nSizePow=3:this.nSizePow=2);this.nCharSizeNormal=b;var k=getRotateAttributeValue(map.Scale.canvasNode);if(this.szFlag.match(/\bSORT\b/)&&!this.szFlag.match(/SEQUENCE/)&&!this.szFlag.match(/3D/)){this.indexA=[];for(g in this.itemA)this.indexA[this.indexA.length]=g;for(var q=[],h=0;h<this.indexA.length;h++){var u=this.itemA[this.indexA[h]].nValuesA[this.nActualFrame||
0];this.itemA[this.indexA[h]].nSize?u=this.itemA[this.indexA[h]].nSize:this.szFlag.match(/SIZE/)&&this.itemA[this.indexA[h]].nValueSum&&(u=this.itemA[this.indexA[h]].nValueSum);isNaN(u)||q.push({a:this.indexA[h],y:u})}this.szFlag.match(/\bUP\b/)?q.sort(this.sortDownChartObjectsCompare):q.sort(this.sortUpChartObjectsCompare);if(this.szValueField&&"$index$"==this.szValueField)for(h=0;h<q.length;h++)this.itemA[q[h].a].szValue=String(q.length-h);this.indexA=[]}if(this.szFlag.match(/CHART/)&&!this.szFlag.match(/CATEGORICAL/)){for(var w=
0;w<this.partsA.length;w++)this.partsA[w].nCount=0,this.partsA[w].nSum=0;this.fRedrawInfo=!0;this.szFlag.match(/SEQUENCE/)&&(this.nFadeNegative=this.nFadeNegative||1)}var p=0,t=0,M=0;if(!this.fClipCharts||this.szFlag.match(/BUFFER/)||this.szFlag.match(/\bPOSITION\b/)||this.szFlag.match(/FEATURE/))for(g in this.itemA)this.indexA[this.indexA.length]=g,t++,p++;else{for(h=0;h<this.partsA.length;h++)this.partsA[h].nCount=0,this.partsA[h].nSum=0;for(g in this.itemA)if(t++,this.itemA[g].nValuesA&&0<this.itemA[g].nValuesA.length)if(f=
this.itemA[g].ptPos||this.getNodePosition(this.itemA[g].szSelectionId)){if(!this.szFlag.match(/NOCLIPTOVIEW/)&&(f.x<d.x||f.x>d.x+d.width||f.y<d.y||f.y>d.y+d.height))if(this.szFlag.match(/\b(VECTOR|BEZIER)\b/)){f=this.itemA[g].ptPos2||(this.szLabelA?this.getNodePosition(this.szThemesA[0]+"::"+this.szLabelA[this.itemA[g].nValuesA[0]-1]):null);if(!f)continue;if(f.x<d.x||f.x>d.x+d.width||f.y<d.y||f.y>d.y+d.height){this.nSkipCount++;(D=this.itemA[g].chartNode)&&D.parentNode&&(D.parentNode&&D.parentNode.removeChild(D),
this.itemA[g].chartNode=null,this.chartPosA[this.itemA[g].szSelectionId]=null,this.posItemA[this.itemA[g].szSelectionId]=null);continue}}else{this.nSkipCount++;var D;(D=this.itemA[g].chartNode)&&D.parentNode&&(D.parentNode&&D.parentNode.removeChild(D),this.itemA[g].chartNode=null,this.chartPosA[this.itemA[g].szSelectionId]=null,this.posItemA[this.itemA[g].szSelectionId]=null);continue}this.indexA[this.indexA.length]=g;if(this.szFlag.match(/CHART/))if(this.szFlag.match(/CATEGORICAL/))if(1<this.nMaxA.length)for(h=
0;h<this.partsA.length;h++)this.partsA[h].nCount+=this.itemA[g].nCountA&&this.itemA[g].nCountA[h]&&!isNaN(this.itemA[g].nCountA[h])?this.itemA[g].nCountA[h]:0,this.partsA[h].nSum+=this.itemA[g].nValuesA&&this.itemA[g].nValuesA[h]&&!isNaN(this.itemA[g].nValuesA[h])?this.itemA[g].nValuesA[h]:0;else this.szAlphaField?this.szColorField&&this.partsA[this.itemA[g].nClass]?(this.partsA[this.itemA[g].nClass].nCount++,this.partsA[this.itemA[g].nClass].nSum+=isNaN(this.itemA[g].nAlpha)?isNaN(this.itemA[g].nSize)?
1:this.itemA[g].nSize:this.itemA[g].nAlpha):this.partsA[this.itemA[g].nValuesA[0]-1]&&(this.partsA[this.itemA[g].nValuesA[0]-1].nCount++,this.partsA[this.itemA[g].nValuesA[0]-1].nSum+=isNaN(this.itemA[g].nAlpha)?isNaN(this.itemA[g].nSize)?1:this.itemA[g].nSize:this.itemA[g].nAlpha):this.szColorField&&this.partsA[this.itemA[g].nClass]?(this.partsA[this.itemA[g].nClass].nCount++,this.partsA[this.itemA[g].nClass].nSum+=isNaN(this.itemA[g].nSize)?1:this.itemA[g].nSize):this.partsA[this.itemA[g].nValuesA[0]-
1]&&(this.partsA[this.itemA[g].nValuesA[0]-1].nCount++,this.partsA[this.itemA[g].nValuesA[0]-1].nSum+=isNaN(this.itemA[g].nSize)?1:this.itemA[g].nSize);else if(1<this.nMaxA.length)for(h=0;h<this.partsA.length;h++){if(!this.szFlag.match(/MEAN/)||this.itemA[g].nValuesA[h])this.partsA[h].nCount++,this.partsA[h].nSum+=isNaN(this.itemA[g].nValuesA[h])?0:this.itemA[g].nValuesA[h]}else for(h=0;h<this.partsA.length;h++)this.itemA[g].nValuesA[0]>=this.partsA[h].min&&this.itemA[g].nValuesA[0]<this.partsA[h].max&&
(this.partsA[h].nCount++,this.partsA[h].nSum+=isNaN(this.itemA[g].nValuesA[0])?0:this.itemA[g].nValuesA[0]);p++}else this.missedA[g]=g,M++;if(t==M&&!map.Tiles.allTilesLoaded()){this.fRedraw=this.fDataIncomplete=!0;map.Tiles.switchScaleDependentTiles();setTimeout(function(){map.Themes.execute()},1);return}}if(p>this.nMaxThemeCharts)for(g in this.ErrorMessage="max charts ("+this.nMaxThemeCharts+") exceeded; please zoom in",this.indexA.length=0,this.nSkipCount=p,this.itemA)(D=SVGDocument.getElementById(this.szId+
":"+g+":chart"))&&D.parentNode.removeChild(D);this.fRedrawAllCharts=!1;p>this.nMaxShadowCharts?(this.fShadow&&(this.fRedrawAllCharts=!0),this.fShadow=!1):(this.fOrigShadow&&!this.fShadow&&(this.fRedrawAllCharts=!0),this.fShadow=this.fOrigShadow);this.szShadowUpper&&(map.Scale.nTrueMapScale*map.Scale.nZoomScale>this.nShadowUpper?(this.xOrigShadow=this.xOrigShadow||this.fOrigShadow,this.fShadow=this.fOrigShadow=!1):this.fOrigShadow=this.xOrigShadow||this.fOrigShadow);this.szShadowLower&&(map.Scale.nTrueMapScale*
map.Scale.nZoomScale<this.nShadowLower?(this.xOrigShadow=this.xOrigShadow||this.fOrigShadow,this.fShadow=this.fOrigShadow=!1):this.fOrigShadow=this.xOrigShadow||this.fOrigShadow);this.mapSleep&&(this.mapSleep.nCount=p);this.fSorted=!1;if(this.fSortBeforeDraw&&(this.nMin!=this.nMax||this.szSizeField)&&!this.szFlag.match(/NOSRT/)&&!this.szFlag.match(/DOT/)&&(!this.szFlag.match(/NOSIZE/)||this.szFlag.match(/3D/)||this.szFlag.match(/\bSORT\b/))&&(!this.szFlag.match(/CATEGORICAL/)||this.szFlag.match(/AGGREGATE/)||
this.szSizeField||this.szFlag.match(/\bSORT\b/))){var y=[];if((this.szFlag.match(/3D/)||this.szFlag.match(/PLOT/)||this.szFlag.match(/xxxBOXxxx/)||this.szFlag.match(/POINTER/)&&this.szFlag.match(/BAR/))&&(!this.szFlag.match(/MULTIPLE/)&&!this.szFlag.match(/MULTIGRID/)||this.szFlag.match(/AGGREGATE/)))for(h=0;h<this.indexA.length;h++)(f=this.itemA[this.indexA[h]].ptPos||this.getNodePosition(this.itemA[this.indexA[h]].szSelectionId))?y[h]=k?{a:this.indexA[h],y:f.x*Math.sin(k)+f.y*Math.cos(k)}:{a:this.indexA[h],
y:f.y}:y[h]={a:this.indexA[h],y:0};else if(this.szSizeField||this.szFlag.match(/AGGREGATE/)&&this.szFlag.match(/SUM/))for(h=0;h<this.indexA.length;h++)u=this.itemA[this.indexA[h]].nSize,isNaN(u)||y.push({a:this.indexA[h],y:u});else if(this.szSizeField||this.szFlag.match(/AGGREGATE/)&&this.szFlag.match(/MEAN/))for(h=0;h<this.indexA.length;h++)u=this.itemA[this.indexA[h]].nValuesA[this.nActualFrame||0],isNaN(u)||y.push({a:this.indexA[h],y:u});else if(this.szFlag.match(/SIZE/))for(h=0;h<this.indexA.length;h++)u=
this.itemA[this.indexA[h]].nValueSum,isNaN(u)||y.push({a:this.indexA[h],y:u});else for(h=0;h<this.indexA.length;h++)u=this.itemA[this.indexA[h]].nValuesA[this.nActualFrame||0],isNaN(u)||y.push({a:this.indexA[h],y:u});this.szFlag.match(/\bSORT\b/)&&this.szFlag.match(/\bUP\b/)&&!this.szFlag.match(/SEQUENCE/)&&!this.szFlag.match(/3D/)?y.sort(this.sortDownChartObjectsCompare):y.sort(this.sortUpChartObjectsCompare);for(h=0;h<y.length;h++)this.indexA[h]=y[h].a;this.fSorted=!0}if(this.nMaxCharts&&p>this.nMaxCharts){this.fContinue=
!0;this.continueIndex=p-this.nMaxCharts;this.indexA.slice(p-this.nMaxCharts-1,this.nMaxCharts);map.Themes.executeContinue();return}this.fDone||this.unpaintMap()}this.chart={szColor:this.colorScheme[0],szLineColor:this.colorScheme[1]?this.colorScheme[1]:"none",szTextColor:this.colorScheme[1]?this.colorScheme[1]:"none"};if(2<this.colorScheme.length||this.szFlag.match(/CATEGORICAL/))this.chart.szColor=this.colorScheme[this.colorScheme.length-1],this.chart.szLineColor=this.colorScheme[0];if(this.szFlag.match(/NOLINES/))this.chart.szLineColor=
"none";else if("none"==this.chart.szLineColor){var m=__maptheme_getChartColors("#777777");this.chart.szLineColor=m.textColor}this.nXLen=this.nMaxA.length/(this.nGridX||1);if(this.szFlag.match(/PLOT/)&&(this.szFlag.match(/GRIDSIZE/)||this.szFlag.match(/AUTOSIZE/))){var v=0,A=map.Layer.nDynamicObjectScale,B=this.szFlag.match(/GAP/)?1.2:1,v=this.nGridWidthPx?map.Scale.normalX(this.nGridWidthPx)/B*this.nScale/A:this.nGridWidth?map.Scale.getDeltaXofDistanceInMeter(this.nGridWidth)/B*this.nScale/A:map.Scale.normalX(b/
3);this.nAutoScale=v/map.Scale.normalX((this.itemA[g]?this.itemA[g].nValuesA.length:1)/(this.nGridX||1)*b);this.nGridSize=v}else this.szFlag.match(/GRIDSIZE/)&&(A=map.Layer.nDynamicObjectScale,B=this.szFlag.match(/\bRECT\b/)||!this.szFlag.match(/AGGREGATE/)?this.szFlag.match(/GAP/)?1.15:1:this.szFlag.match(/GAP/)?.8:.75,this.nGridSize=this.nGridWidthPx?map.Scale.normalX(this.nGridWidthPx)/B/A:this.nGridWidth?map.Scale.getDeltaXofDistanceInMeter(this.nGridWidth)/B/A:map.Scale.normalX(b/3));this.szFlag.match(/PLOTXY/)&&
(A=map.Layer.nDynamicObjectScale,B=1.15,this.nChartWidth=this.nGridWidthPx?map.Scale.normalX(this.nGridWidthPx)/B/this.nScale/A:this.nGridWidth?map.Scale.getDeltaXofDistanceInMeter(this.nGridWidth)/B/this.nScale/A:map.Scale.normalX(b/3),this.nChartWidth-=2*map.Scale.normalX(this.nBoxMargin||0),this.nChartHeight=this.nChartWidth-map.Scale.normalY(this.szFlag.match(/TITLE/)?10:0),this.nGridSize=this.nChartWidth,this.nAutoScale=1,this.nRangeX=this.nMaxX-this.nMinX,this.nRangeY=this.nMaxY-this.nMinY);
this.nChartGroupScaleX=this.nChartGroupScale=fObjectScaling?(this.nAutoScale||this.nScale)*map.Layer.nObjectScale*map.Scale.nObjectScaling:(this.nAutoScale||this.nScale)*map.Scale.nFeatureScaling*map.Scale.nObjectScaling;this.nChartGroupScaleY=this.nChartGroupScale/map.Zoom.nZoomY*map.Zoom.nZoomX;this.fGlowInScale=!1;(!this.szGlowUpper||map.Scale.nTrueMapScale*map.Scale.nZoomScale<=this.nGlowUpper)&&(!this.szGlowLower||map.Scale.nTrueMapScale*map.Scale.nZoomScale>=this.nGlowLower)&&(this.fGlowInScale=
!0);this.fDoRedraw=!1;if(1E3>this.indexA.length||this.fRedraw||this.fRedrawAllCharts||this.szFlag.match(/BUFFER/)&&this.szShapeType.match(/line/))this.fDoRedraw=!this.fDone;this.fHideValues=this.szValueUpper&&map.Scale.nTrueMapScale*map.Scale.nZoomScale>this.nValueUpper||this.szValueLower&&map.Scale.nTrueMapScale*map.Scale.nZoomScale<this.nValueLower;if(this.szFlag.match(/\bUSER\b/))try{var x={target:this.chartGroup,theme:this};this.userDraw?(this.opt=x,eval("HTMLWindow.ixmaps."+this.userDraw+"_init(SVGDocument,this.opt);"),
delete this.opt):HTMLWindow.ixmaps.htmlgui_initChart(SVGDocument,x)}catch(Fa){displayMessage("'"+(this.userDraw||"USER chart")+"' undefined!",5E3)}if(this.szFlag.match(/FEATURE/)){this.chartGroup.style.setProperty("fill",this.chart.szColor||"white");this.chartGroup.style.setProperty("fill-opacity",this.fillOpacity||.1);this.chartGroup.style.setProperty("stroke",this.szLineColor||"red");this.chartGroup.style.setProperty("stroke-width",map.Scale.normalX(this.nLineWidth||1)*this.nChartGroupScaleY/(fFeatureScalingDynamic?
1:map.Layer.nDynamicObjectScale));if("undefined"!=typeof this.szBorderStyle)switch(this.szBorderStyle){case "dotted":this.chartGroup.style.setProperty("stroke-dasharray","0.1 0.2");break;case "dashed":this.chartGroup.style.setProperty("stroke-dasharray","0.5 0.2")}this.szFlag.match(/DASH/)&&this.chartGroup.style.setProperty("stroke-dasharray","0.1 0.2");this.chartGroup.style.setProperty("stroke-opacity","1");this.chartGroup.style.setProperty("stroke-linecap","butt");this.chartGroup.style.setProperty("stroke-linejoin",
"round");if(this.szFlag.match(/SILENT/))this.chartGroup.style.setProperty("pointer-events","none","");else{for(var ka="",h=0;h<this.objTheme.dbFields.length-1;h++)ka+=(h?"|":"")+this.objTheme.dbFields[h].id;this.chartGroup.setAttributeNS(szMapNs,"info",ka)}if(!0===this.fShadow&&SVGDocument.getElementById(szShadowFilterShapeId))this.chartGroup.style.setProperty("filter","url(#"+szShadowFilterShapeId+")","");else if(!0===this.fShadow){var ha=map.Dom.newNode("filter",this.chartGroup.parentNode);ha.setAttributeNS(null,
"id",szShadowFilterShapeId);ha.setAttributeNS(null,"x","-1");ha.setAttributeNS(null,"y","-1");ha.setAttributeNS(null,"width","2000%");ha.setAttributeNS(null,"height","2000%");var fa=map.Dom.newNode("feGaussianBlur",ha);fa.setAttributeNS(null,"stdDeviation","0.3");fa.setAttributeNS(null,"result","BlurAlpha");fa=map.Dom.newNode("feOffset",ha);fa.setAttributeNS(null,"in","BlurAlpha");fa.setAttributeNS(null,"dx","0.2");fa.setAttributeNS(null,"dy","0.5");fa.setAttributeNS(null,"result","OffsetBlurAlpha");
fa=map.Dom.newNode("feColorMatrix",ha);fa.setAttributeNS(null,"in","OffsetBlurAlpha");fa.setAttributeNS(null,"type","matrix");fa.setAttributeNS(null,"values","0.1 0.1 0.1 0 0 0.1 0.1 0.1 0 0 0.1 0.1 0.1 0 0 0 0 0 1 0");fa.setAttributeNS(null,"result","matrixOut");var fa=map.Dom.newNode("feMerge",ha),fb=map.Dom.newNode("feMergeNode",fa);fb.setAttributeNS(null,"in","matrixOut");fb=map.Dom.newNode("feMergeNode",fa);fb.setAttributeNS(null,"in","SourceGraphic");this.chartGroup.style.setProperty("filter",
"url(#"+szShadowFilterShapeId+")","")}}for(var v=map.Scale.getDeltaXofDistanceInMeter(this.nGridWidth)/2*20,v=v*map.Scale.nZoomScale*20,ba=c;ba<this.indexA.length;ba++){if(this.fCancel){displayMessage("Canceled by user",1E3,!0);this.fCancel=!1;return}if(this.mapSleep&&(this.mapSleep.nDoneCount=this.nDoneCount,this.mapSleep.checkSleep(ba,10))){this.fContinue=!0;this.continueIndex=ba;this.szItemFilter&&this.szItemFilter.length&&this.filterItems(this.szItemFilter,this.itemFilterOpt);null!=this.markedClass&&
this.markClass(this.markedClass,1);return}var C=null,g=this.indexA[ba];this.nDoneCount++;if(this.itemA[g]&&this.itemA[g].nValuesA&&0!==this.itemA[g].nValuesA.length){var H=this.itemA[g].szSelectionId;if(!this.szFlag.match(/FEATURE/)){if(f=this.itemA[g].ptPos||this.getNodePosition(H))f.x=isNaN(f.x)?0:f.x,f.y=isNaN(f.y)?0:f.y;if(!f||isNaN(f.x)||isNaN(f.y)){this.nMissingPositionCount++;continue}this.fRedraw&&(this.itemA[g].chartNode=this.itemA[g].chartNode||SVGDocument.getElementById(this.szId+":"+g+
":chart"));if(this.itemA[g].chartNode&&this.itemA[g].chartNode.parentNode)if(this.fDoRedraw)this.itemA[g].chartNode.parentNode.removeChild(this.itemA[g].chartNode),this.itemA[g].chartNode=null;else{this.nRealizedCount++;continue}}var na=new point(0,0);if(this.szFlag.match(/FEATURE/))if(C=map.Dom.newGroup(this.chartGroup,g),this.objTheme.dbRecords[this.itemA[g].dbIndex][this.objTheme.nFieldSelectionIndex])if(this.objTheme.dbRecords[this.itemA[g].dbIndex][this.objTheme.nFieldSelectionIndex].match(/coordinates/i)){var pa=
JSON.parse(this.objTheme.dbRecords[this.itemA[g].dbIndex][this.objTheme.nFieldSelectionIndex]);if(pa){if(this.szFlag.match(/SILENT/))C.style.setProperty("pointer-events","none","");else{for(var ka="",ac=this.objTheme.dbRecords[this.itemA[g].dbIndex],h=0;h<ac.length-1;h++)ka+=(h?"|":"")+ac[h];C.setAttributeNS(szMapNs,"info",ka);C.setAttributeNS(szMapNs,"tooltip",g)}if(this.szTimeField){var sb=(new Date(this.itemA[g].szTime)).getTime()||this.itemA[g].szTime;C.setAttributeNS(szMapNs,"time",sb)}if(this.szFlag.match(/CATEGORICAL/))this.chart.szColor=
this.colorScheme[this.itemA[g].nValuesA[0]-1];else if(1<this.partsA.length)for(this.chart.szColor=this.szNoDataColor?this.szNoDataColor:"white",h=0;h<this.partsA.length;h++)this.itemA[g].nValuesA[0]>=this.partsA[h].min&&this.itemA[g].nValuesA[0]<this.partsA[h].max&&(this.chart.szColor=this.colorScheme[h],this.itemA[g].nClass=h,this.partsA[h].nCount++);C.setAttributeNS(null,"style","stroke:"+this.chart.szColor);C.setAttributeNS(szMapNs,"class","undefined"!=typeof this.itemA[g].nClass?this.itemA[g].nClass:
String(this.itemA[g].nValuesA[0]-1));var W=map.Scale.getMapPositionOfLatLon(80,180).x-map.Scale.getMapPositionOfLatLon(80,-180).x;if("Point"==pa.type){map.Layer.listA[this.szThemesA[0]].szType="point";var G=pa.coordinates,N=map.Scale.getMapPositionOfLatLon(G[1],G[0]);C.fu.setMatrix([this.nChartGroupScaleX,0,0,this.nChartGroupScaleY,N.x,N.y]);var Da=map.Dom.newShape("circle",C,0,0,map.Scale.normalX(1),"fill:#dd0000;fill-opacity:0.3;stroke:#dd0000;stroke-opacity:1;stroke-width:1")}if("LineString"==
pa.type){this.chartGroup.style.setProperty("fill","none");map.Layer.listA[this.szThemesA[0]].szType="line";var G=pa.coordinates,N=map.Scale.getMapPositionOfLatLon(G[0][1],G[0][0]),ca="M "+N.x+","+N.y+" l ",ua=new point(N.x,N.y);for(h in G)N=map.Scale.getMapPositionOfLatLon(G[h][1],G[h][0]),Math.abs(N.x-ua.x)>.99*W&&(N=map.Scale.getMapPositionOfLatLon(G[ii][1],G[ii][0]+(0>N.x?360:-360))),ca+=N.x-ua.x+","+(N.y-ua.y)+" ",ua=new point(N.x,N.y);Da=map.Dom.newShape("path",C,ca,"")}if("MultiLineString"==
pa.type){this.chartGroup.style.setProperty("fill","none");map.Layer.listA[this.szThemesA[0]].szType="line";var I=pa.coordinates;for(h in I){G=I[h];ua=null;N=map.Scale.getMapPositionOfLatLon(G[0][1],G[0][0]);ca="M "+N.x+","+N.y+" l ";ua=new point(N.x,N.y);for(ii in G)N=map.Scale.getMapPositionOfLatLon(G[ii][1],G[ii][0]),Math.abs(N.x-ua.x)>.99*W&&(N=map.Scale.getMapPositionOfLatLon(G[ii][1],G[ii][0]+(0>N.x?360:-360))),ca+=N.x-ua.x+","+(N.y-ua.y)+" ",ua=new point(N.x,N.y);Da=map.Dom.newShape("path",
C,ca,"")}}if("Polygon"==pa.type){map.Layer.listA[this.szThemesA[0]].szType="polygon";var I=pa.coordinates,ca="",ia=0,V=0,Ra=0;for(h in I){G=I[h];ua=null;N=map.Scale.getMapPositionOfLatLon(G[0][1],G[0][0]);ca+="M "+N.x+","+N.y+" l ";ua=new point(N.x,N.y);for(ii in G)N=map.Scale.getMapPositionOfLatLon(G[ii][1],G[ii][0]),Math.abs(N.x-ua.x)>.99*W&&(N=map.Scale.getMapPositionOfLatLon(G[ii][1],G[ii][0]+(0>N.x?360:-360))),ia+=N.x,V+=N.y,ca+=N.x-ua.x+","+(N.y-ua.y)+" ",ua=new point(N.x,N.y);ca+=" z";Ra+=
G.length}Da=map.Dom.newShape("path",C,ca,"");C.setAttributeNS(szMapNs,"center","x:"+ia/Ra+",y:"+V/Ra);C.setAttributeNS(szMapNs,"area",this.itemA[g].nSize);C.setAttributeNS(null,"style","fill:"+this.chart.szColor+";fill-opacity:0.5")}if("MultiPolygon"==pa.type){ia=[];V=[];Ra=[];map.Layer.listA[this.szThemesA[0]].szType="polygon";var Ac=pa.coordinates,ra;for(ra in Ac){I=Ac[ra];ca="";ia[ra]=0;V[ra]=0;Ra[ra]=0;for(h in I){G=I[h];ua=null;N=map.Scale.getMapPositionOfLatLon(G[0][1],G[0][0]);ca+="M "+N.x+
","+N.y+" l ";ua=new point(N.x,N.y);for(ii in G)N=map.Scale.getMapPositionOfLatLon(G[ii][1],G[ii][0]),Math.abs(N.x-ua.x)>.99*W&&(N=map.Scale.getMapPositionOfLatLon(G[ii][1],G[ii][0]+(0>N.x?360:-360))),ia[ra]+=N.x,V[ra]+=N.y,ca+=N.x-ua.x+","+(N.y-ua.y)+" ",ua=new point(N.x,N.y);ca+=" z";Ra[ra]+=G.length}Da=map.Dom.newShape("path",C,ca,"")}var nc=0;for(ra in Ra)Ra[ra]>nc&&(C.setAttributeNS(szMapNs,"center","x:"+ia[ra]/Ra[ra]+",y:"+V[ra]/Ra[ra]),C.setAttributeNS(szMapNs,"area",this.itemA[g].nSize),nc=
Ra[ra]);C.setAttributeNS(null,"style","fill:"+this.chart.szColor+";fill-opacity:0.5")}}}else(f=this.itemA[g].ptPos||this.getNodePosition(H))&&C.fu.setMatrix([this.nChartGroupScaleX,0,0,this.nChartGroupScaleY,f.x,f.y]);else(f=this.itemA[g].ptPos||this.getNodePosition(H))&&C.fu.setMatrix([this.nChartGroupScaleX,0,0,this.nChartGroupScaleY,f.x,f.y]);else if(this.szFlag.match(/DOT/)){C=map.Dom.newGroup(this.chartGroup,this.szId+":"+H+":chartgroup");C.fu.setMatrix([this.nChartGroupScaleX,0,0,this.nChartGroupScaleY,
f.x,f.y]);if(this.szFlag.match(/CATEGORICAL/))this.chart.szColor=this.colorScheme[this.itemA[g].nValuesA[0]-1];else if(1<this.partsA.length)for(h=0;h<this.partsA.length;h++)this.itemA[g].nValuesA[0]>=this.partsA[h].min&&this.itemA[g].nValuesA[0]<this.partsA[h].max&&(this.chart.szColor=this.colorScheme[h]);this.itemA[g].chartNode=map.Dom.newShape("circle",C,0,0,map.Scale.normalX(3),"fill:"+this.chart.szColor+";fill-opacity:"+(this.fillOpacity||1)+";stroke:none;")}else if(this.szFlag.match(/\bQUAD\b/)){C=
map.Dom.newGroup(this.chartGroup,this.szId+":"+H+":chart");C.fu.setMatrix([this.nChartGroupScaleX,0,0,this.nChartGroupScaleY,f.x,f.y]);if(this.szFlag.match(/CATEGORICAL/))this.chart.szColor=this.colorScheme[this.itemA[g].nValuesA[0]-1];else if(1<this.partsA.length)for(h=0;h<this.partsA.length;h++)this.itemA[g].nValuesA[0]>=this.partsA[h].min&&this.itemA[g].nValuesA[0]<this.partsA[h].max&&(this.chart.szColor=this.colorScheme[h]);this.itemA[g].chartNode=map.Dom.newShape("rect",C,-v,-v,2*v,2*v,"fill:"+
this.chart.szColor+";stroke:none;")}else if(this.szFlag.match(/\bBEZIER\b/)){if(!(this.nMinValue&&this.itemA[g].nSize<this.nMinValue)){var Ea=this.itemA[g].ptPos,Sa=this.itemA[g].ptPos2||(this.szLabelA?this.getNodePosition(this.szThemesA[0]+"::"+this.szLabelA[this.itemA[g].nValuesA[0]-1]):null);if(Ea&&Sa&&Ea!=Sa){C=this.itemA[g].chartNode=map.Dom.newGroup(this.chartGroup,this.szId+":"+g+(g?":chartgroup":":ochrtgroup"));this.chart.szColor=this.szLineColor||this.itemA[g].szColor||this.colorScheme[this.itemA[g].nValuesA[0]-
1]||this.szNoDataColor;var Ma=1/(this.nSizePow||1),sa=this.nLineWidth||10/Math.pow(this.nNormalSizeValue||this.nMaxSize,Ma)*Math.pow(Math.abs(this.itemA[g].nSize),Ma),ab=Number(this.nGapSize||20),R=sa+(this.szFlag.match(/\bGAP\b/)?ab:3),sa=map.Scale.normalX(sa)*this.nChartGroupScaleY*this.nScale;if(!(0>=sa)){if(this.szFlag.match(/\bREVERSE\b/)||0>this.itemA[g].nSize)var za=Ea,Ea=Sa,Sa=za;var P=Math.sqrt((Sa.y-Ea.y)*(Sa.y-Ea.y)+(Sa.x-Ea.x)*(Sa.x-Ea.x)),ia=Sa.x-Ea.x,V=Sa.y-Ea.y,P=Math.sqrt(ia*ia+V*
V);this.szFlag.match(/\bDYNAMICWIDTH\b/)&&(sa*=Math.max(1,Math.log10(P)));if(!(0>=P)){var tb=this.nRangeScale;this.szFlag.match(/\bRANDOM\b/)&&(tb-=.66*this.nRangeScale*Math.random());if(this.szFlag.match(/\bSHORT\b/))var n=V/P*(tb||5)*100*this.nChartGroupScaleY,qa=ia/P*(tb||5)*100*this.nChartGroupScaleY;else this.szFlag.match(/\bLONG\b/)?(n=V/5E4*Math.max(P,500)*(tb||5),qa=ia/5E4*Math.max(P,500)*(tb||5)):(n=V/50*(tb||5),qa=ia/50*(tb||5));this.szFlag.match(/\bPOINTER|ARROW\b/)&&(ia-=ia/P*map.Scale.normalX(R)*
this.nChartGroupScaleY*this.nScale*(this.nMarkerSize||1),V-=V/P*map.Scale.normalX(R)*this.nChartGroupScaleY*this.nScale*(this.nMarkerSize||1));var F=0,Ob=0;this.szFlag.match(/\bGAP\b/)&&(ia+=n/500*R,V-=qa/500*R,F=ia/P*ab*20*this.nChartGroupScaleY,Ob=V/P*ab*20*this.nChartGroupScaleY);ca="M"+F+","+Ob+" C"+(ia/4+n)+","+(V/4-qa)+" "+(ia/2+n)+","+(V/2-qa)+" "+ia+","+V+"";Da=map.Dom.newShape("path",C,ca,"stroke-linecap:butt;fill:none;stroke:"+this.chart.szColor+";stroke-width:"+sa+";stroke-opacity:"+(this.fillOpacity||
.3)+";");if(this.szFlag.match(/DOPACITYMIN/)){var Ma=1/(this.nDopacityPow||1),Aa=Math.pow(this.nMax-this.itemA[g].nSize,Ma)/Math.pow(this.nMax-this.nMin,Ma)*(this.fillOpacity||1)*(this.nDopacityScale||1);Da.style.setProperty("stroke-opacity",String(Aa),"")}else this.szFlag.match(/DOPACITY/)&&(Ma=1/(this.nDopacityPow||1),Aa=Math.pow(this.itemA[g].nSize-this.nMin,Ma)/Math.pow(this.nMax-this.nMin,Ma)*(this.fillOpacity||1)*(this.nDopacityScale||1),Da.style.setProperty("stroke-opacity",String(Aa),""));
if(this.szFlag.match(/\bDASH\b/)){var Ta=1E3*this.nChartGroupScaleY,gb=100*this.nChartGroupScaleY+sa;Da.style.setProperty("stroke-dasharray",String(Ta)+" "+String(gb));Da.style.setProperty("stroke-dashoffset","0");Da.style.setProperty("stroke-linecap","round");var Eb=Math.random()*Ta,Fb=Eb+Ta+gb,va=Eb;map.Dom.constructNode("animate",Da,{attributeType:"XML",attributeName:"stroke-dashoffset",from:String(Fb),to:String(va),dur:"2s",repeatCount:"indefinite"})}if(this.szFlag.match(/\bGRADIENT\b|\bFADEIN\b/)){var Ua=
this.szLineColorA?this.szLineColorA[0]:this.chart.szColor,bc=this.szFlag.match(/\bFADEIN\b/)?.2:2,Pb="Gradient"+Math.random();if(Math.abs(V)>Math.abs(ia)){var Va=map.Dom.constructNode("linearGradient",C,{id:Pb,x1:"0%",y1:"0%",x2:"0%",y2:"100%"});map.Dom.constructNode("stop",Va,{offset:"0","stop-color":0>V?this.chart.szColor:Ua,"stop-opacity":0>V?"2":bc});map.Dom.constructNode("stop",Va,{offset:"1","stop-color":0>V?Ua:this.chart.szColor,"stop-opacity":0>V?bc:"2"})}else Va=map.Dom.constructNode("linearGradient",
C,{id:Pb}),map.Dom.constructNode("stop",Va,{offset:"0","stop-color":0>ia?this.chart.szColor:Ua,"stop-opacity":0>ia?"2":bc}),map.Dom.constructNode("stop",Va,{offset:"1","stop-color":0>ia?Ua:this.chart.szColor,"stop-opacity":0>ia?bc:"2"});Da.style.setProperty("stroke","");Da.style.setProperty("fill","none");Da.setAttributeNS(null,"stroke","url(#"+Pb+")")}if(this.szFlag.match(/\bPOINTER|ARROW\b/)){var Bc="ArrowMarker"+Math.random(),ea=map.Dom.newNode("defs",C),Oa=Math.min(5,2.5+100/(sa/this.nChartGroupScale))*
(this.nMarkerSize||1),oc=map.Dom.constructNode("marker",ea,{id:Bc,markerWidth:Oa,markerHeight:Oa,refX:Oa/1.7,refY:Oa/2,orient:"auto",markerUnits:"strokeWidth"}),ub=map.Dom.constructNode("path",oc,{d:"M0,"+Oa+" L"+Oa+","+Oa/2+" L0,0 Z",style:"fill:"+this.chart.szColor+";opacity:"+2*(this.fillOpacity||.3)+";stroke:none;stroke-width:0.03"});Da.setAttributeNS(null,"marker-end","url(#"+Bc+")");this.szFlag.match(/DOPACITYMIN/)?(Ma=1/(this.nDopacityPow||1),Aa=Math.pow(this.nMax-this.itemA[g].nSize,Ma)/Math.pow(this.nMax-
this.nMin,Ma)*(this.fillOpacity||1)*(this.nDopacityScale||1),ub.style.setProperty("opacity",String(Aa),"")):this.szFlag.match(/DOPACITY/)&&(Ma=1/(this.nDopacityPow||1),Aa=Math.pow(this.itemA[g].nSize-this.nMin,Ma)/Math.pow(this.nMax-this.nMin,Ma)*(this.fillOpacity||1)*(this.nDopacityScale||1),ub.style.setProperty("opacity",String(Aa),""))}if(this.szFlag.match(/\bVALUES\b/)&&!this.fHideValues){var Q="VectorPath"+Math.random();0>ia?(ca="M"+ia+","+V+" C"+(ia/2+n)+","+(V/2-qa)+" "+(ia/4+n)+","+(V/4-qa)+
" "+F+","+Ob+"",map.Dom.newShape("path",C,ca,"fill:none;stroke:none").setAttributeNS(null,"id",Q)):Da.setAttributeNS(null,"id",Q);var e=Math.min(P,Math.sqrt(this.itemA[g].nSize)/Math.sqrt(this.nNormalSizeValue||this.nMaxSize)*this.nValueScale),e=24*map.Scale.normalX(e)*this.nChartGroupScaleY*this.nScale,ta=this.formatValue(this.itemA[g].nSize,this.nValueDecimals||(1>this.itemA[g].nSize?2:0),"ROUND")+this.szUnit;map.Dom.newTextOnPath(C,Q,ta,"font-family:arial;font-size:"+e+"px;fill:"+this.chart.szColor+
";stroke:#ffffff;stroke-width:"+sa/10+"px;baseline-shift:-35%","40%")}C.setAttributeNS(szMapNs,"class","undefined"!=typeof this.itemA[g].nClass?this.itemA[g].nClass:String(this.itemA[g].nValuesA[0]-1));C.setAttributeNS(szMapNs,"tooltip",this.formatValue(this.itemA[g].nSize,this.nValueDecimals||(1>this.itemA[g].nSize?2:0),"ROUND")+this.szUnit);this.szTimeField&&(sb=(new Date(this.itemA[g].szTime)).getTime()||this.itemA[g].szTime,C.setAttributeNS(szMapNs,"time",sb));C.fu.setMatrix([1,0,0,1,Ea.x,Ea.y])}}}}}else if(this.szFlag.match(/\bVECTOR\b/))this.nMinValue&&
this.itemA[g].nSize<this.nMinValue||(Ea=this.itemA[g].ptPos,Sa=this.itemA[g].ptPos2||(this.szLabelA?this.getNodePosition(this.szThemesA[0]+"::"+this.szLabelA[this.itemA[g].nValuesA[0]-1]):null),Ea&&Sa&&(C=this.itemA[g].chartNode=map.Dom.newGroup(this.chartGroup,this.szId+":"+g+(g?":chartgroup":":ochrtgroup")),this.chart.szColor=this.szLineColor||this.colorScheme[this.itemA[g].nValuesA[0]-1],sa=this.nLineWidth||2/(this.nNormalSizeValue||1)/this.nMaxSize*this.itemA[g].nSize,Da=map.Dom.newShape("line",
C,0,0,Sa.x-Ea.x,Sa.y-Ea.y,"stroke:"+this.chart.szColor+";stroke-width:"+map.Scale.normalX((sa||.1)*this.nChartGroupScaleY)+";stroke-opacity:"+(this.fillOpacity||.3)+";"),this.szFlag.match(/\bDASH\b/)&&(Ta=1E3*this.nChartGroupScaleY,gb=300*this.nChartGroupScaleY,Da.style.setProperty("stroke-dasharray",String(Ta)+" "+String(gb)),Da.style.setProperty("stroke-dashoffset","0"),Eb=Math.random()*Ta,Fb=Eb+Ta+gb,va=Eb,map.Dom.constructNode("animate",Da,{attributeType:"XML",attributeName:"stroke-dashoffset",
from:String(Fb),to:String(va),dur:"1s",repeatCount:"indefinite"})),this.szFlag.match(/\bPOINTER|ARROW\b/)&&(ea=map.Dom.newNode("defs",C),oc=map.Dom.constructNode("marker",ea,{id:this.szId+":"+H+":chartgroup:ArrowMarker",markerWidth:"4",markerHeight:"4",refX:"4",refY:"2",orient:"auto",markerUnits:"strokeWidth"}),ub=map.Dom.constructNode("path",oc,{d:"M0,4 L4,2 L0,0 Z",style:"fill:"+this.chart.szColor+";opacity:"+2*(this.fillOpacity||.3)+";stroke:white;stroke-width:0.1"}),Da.setAttributeNS(null,"marker-end",
"url(#"+this.szId+":"+H+":chartgroup:ArrowMarker)")),C.setAttributeNS(szMapNs,"class","undefined"!=typeof this.itemA[g].nClass?this.itemA[g].nClass:String(this.itemA[g].nValuesA[0]-1)),C.setAttributeNS(szMapNs,"tooltip",this.formatValue(this.itemA[g].nSize,this.nValueDecimals||(1>this.itemA[g].nSize?2:0),"ROUND")+this.szUnit),C.fu.setMatrix([1,0,0,1,Ea.x,Ea.y])));else{C=null;if(H)if(C=SVGDocument.getElementById(this.szId+":"+H+":chart"))C.fu=new Methods(C);else if(C=map.Dom.newGroup(this.chartGroup,
this.szId+":"+H+":chart"),this.szFlag.match(/BOX/)){var Pa="#bbbbbb";"undefined"!=typeof this.szBorderColor&&(Pa=this.szBorderColor);var Ja="stroke-width:"+map.Scale.normalX(.5)+";stroke-opacity:0.3;";if("undefined"!=typeof this.szBorderStyle)switch(this.szBorderStyle){case "dotted":Ja="stroke-width:"+map.Scale.normalX(1)+";stroke-linecap:round;stroke-dasharray:1,50;";break;case "dashed":Ja="stroke-width:"+map.Scale.normalX(1)+";stroke-linecap:butt;stroke-dasharray:30,30;";break;case "solid":Ja="stroke-width:"+
map.Scale.normalX(1)+";";break;case "none":Ja="stroke-width:0;"}if("undefined"!=typeof this.szBorderWidth)switch(this.szBorderWidth){case "thin":Ja+="stroke-width:"+map.Scale.normalX(.3)+";";break;case "thick":Ja+="stroke-width:"+map.Scale.normalX(1.5)+";"}var Wa=map.Dom.newShape("rect",C,0,0,1,1,"fill:"+(this.szBoxColor||"white")+";fill-opacity:"+(this.nBoxOpacity||1)+";stroke:"+Pa+";"+Ja);Wa.setAttributeNS(null,"id",this.szId+":"+H+":chart:box");Wa.style.setProperty("pointer-events","none","");
switch(this.szSymbolBoxStyle){case "frame":this.boxShape.setAttributeNS(null,"fill-opacity",0);break;case "field":this.boxShape.setAttributeNS(null,"fill-opacity",1)}}this.itemA[g].chartNode=C;C.setAttributeNS(szMapNs,"value",String(this.itemA[g].nValuesA[0]));var na=this.drawChart(C,g,b,this.szFlag+"|SILENT"),cc=this.nScale;this.nScale=this.nAutoScale||this.nScale;var J=1;"auto"==this.nMaxValue&&(J=1/Math.pow(this.nMax,1/3)*Math.pow(this.nMaxValuePlot,1/3),map.Themes.autoScale||(this.fAutoScaleLeader=
!0,map.Themes.autoScale=[]),J=map.Themes.autoScale[g]=map.Themes.autoScale[g]||J);na&&f&&C&&(this.szFlag.match(/PLOT/)&&this.nGridSize&&this.nAutoScale&&(na.x+=this.nGridSize/2/this.nAutoScale*J,na.y-=this.nGridSize/2/this.nAutoScale*J),this.szFlag.match(/NOSCALE/)?C.fu.setMatrix([this.nScale,0,0,this.nScale,f.x-na.x*this.nScale,f.y-na.y*this.nScale]):C.fu.setMatrix([this.nChartGroupScaleX*J,0,0,this.nChartGroupScaleY*J,f.x-na.x*map.Layer.nObjectScale*this.nScale,f.y-na.y*map.Layer.nObjectScale*this.nScale]),
this.itemA[g].ptPos&&this.itemA[g].ptPos2&&(C.setAttributeNS(szMapNs,"xEnd",this.itemA[g].ptPos2.x),C.setAttributeNS(szMapNs,"yEnd",this.itemA[g].ptPos2.y),C.setAttributeNS(szMapNs,"dur",10)));this.nScale=cc;if(na){H=H.split("*")[0];if((this.szFlag.match(/MULTIPLE/)||this.szFlag.match(/ALIGN/))&&C.lastChild.firstChild){var L=map.Dom.getBox(C.lastChild),bb=this.szFlag.match(/\bUP\b/)?L.height:L.width;if(this.chartPosA[H]){this.chartPosA[H]+=this.szFlag.match(/TEXTONLY/)?5:.5*bb;var Ga=C.lastChild.fu.getPosition(),
U=bb*(this.nGridX||10);this.szFlag.match(/\bUP\b/)?C.lastChild.fu.setPosition(Ga.x+L.width*Math.floor(this.chartPosA[H]/U),Ga.y-L.y-L.height/2-this.chartPosA[H]%U):C.lastChild.fu.setPosition(Ga.x+this.chartPosA[H]%U,Ga.y-L.height*Math.floor(this.chartPosA[H]/U));this.chartPosA[H]+=this.szFlag.match(/TEXTONLY/)?bb:.5*bb}else this.chartPosA[H]=this.szFlag.match(/TEXTONLY/)?bb:-L.y;this.posItemA&&(this.posItemA[H]||(this.posItemA[H]=[]),this.posItemA[H].push(this.itemA[g]))}else if((this.szFlag.match(/MULTIFIX/)||
this.szFlag.match(/MULTIGRID/))&&C.lastChild){var bb=1,jb=map.Scale.normalX(this.nCharSizeNormal*(this.nRangeScale||1)),nb=map.Scale.normalX(this.nCharSizeNormal*(this.nRangeScale||1));if(f=this.getNodePosition(H)){H=String(f.x)+String(f.y);if(this.chartPosA[H]){var Ga=C.lastChild.fu.getPosition(),Ba=this.chartPosA[H],U=this.nGridX||7;this.szFlag.match(/\bUP\b/)?C.lastChild.fu.setPosition(Ga.x+jb*Math.floor(Ba/U),Ga.y-Ba%U*nb):C.lastChild.fu.setPosition(Ga.x+Ba%U*jb,Ga.y-nb*Math.floor(Ba/U));this.chartPosA[H]+=
bb}else this.chartPosA[H]=bb;this.posItemA&&(this.posItemA[H]||(this.posItemA[H]=[]),this.posItemA[H].push(this.itemA[g]));this.itemA[g].labelGroup&&Ba%U!=U-1&&this.itemA[g].labelGroup.style.setProperty("display","none","")}}else if((this.szFlag.match(/MULTISQUARE/)||this.szFlag.match(/MULTIQUAD/))&&C.lastChild&&(bb=1,jb=map.Scale.normalX(this.nCharSizeNormal*(this.nRangeScale||1)),nb=map.Scale.normalX(this.nCharSizeNormal*(this.nRangeScale||1)),f=this.getNodePosition(H))){H=String(f.x)+String(f.y);
if(this.chartPosA[H]){var Ga=C.lastChild.fu.getPosition(),Ba=this.chartPosA[H],cb=Math.floor(Math.sqrt(Ba));cb<(this.nGridX||1E7)?(U=Ba-cb*cb,ia=U<=cb?U:cb,V=U<=cb?cb:cb-(U-cb),C.lastChild.fu.setPosition(Ga.x+ia*jb,Ga.y-V*nb)):(Ga=C.lastChild.fu.getPosition(),Ba=this.chartPosA[H],U=this.nGridX||7,this.szFlag.match(/\bUP\b/)?C.lastChild.fu.setPosition(Ga.x+jb*Math.floor(Ba/U),Ga.y-Ba%U*nb):C.lastChild.fu.setPosition(Ga.x+Ba%U*jb,Ga.y-nb*Math.floor(Ba/U)));this.chartPosA[H]+=bb}else this.chartPosA[H]=
bb;this.posItemA&&(this.posItemA[H]||(this.posItemA[H]=[]),this.posItemA[H].push(this.itemA[g]));this.itemA[g].labelGroup&&Ba%U!=U-1&&this.itemA[g].labelGroup.style.setProperty("display","none","")}if(this.szFlag.match(/TEXTONLY/)&&fCheckLabelOverlap){var zb=SVGDocument.getElementById(this.szId+":"+g+":text");zb&&new Map.Label.Item(zb)}k&&setRotate(C,-Number(k));!0===this.fShadow&&SVGDocument.getElementById(szShadowFilterId)?C.style.setProperty("filter","url(#"+szShadowFilterId+")",""):!0===this.fShadow&&
(ha=map.Dom.newNode("filter",this.chartGroup.parentNode),ha.setAttributeNS(null,"id",szShadowFilterId),ha.setAttributeNS(null,"filterUnits","objectBoundingBox"),ha.setAttributeNS(null,"x","-50%"),ha.setAttributeNS(null,"y","-50%"),ha.setAttributeNS(null,"width","200%"),ha.setAttributeNS(null,"height","200%"),fa=map.Dom.newNode("feGaussianBlur",ha),fa.setAttributeNS(null,"stdDeviation","10"),fa.setAttributeNS(null,"result","BlurAlpha"),fa=map.Dom.newNode("feOffset",ha),fa.setAttributeNS(null,"in",
"BlurAlpha"),fa.setAttributeNS(null,"dx","10"),fa.setAttributeNS(null,"dy","10"),fa.setAttributeNS(null,"result","OffsetBlurAlpha"),fa=map.Dom.newNode("feColorMatrix",ha),fa.setAttributeNS(null,"in","OffsetBlurAlpha"),fa.setAttributeNS(null,"type","matrix"),fa.setAttributeNS(null,"values","0.1 0.1 0.1 0 0 0.1 0.1 0.1 0 0 0.1 0.1 0.1 0 0 0 0 0 1 0"),fa.setAttributeNS(null,"result","matrixOut"),fa=map.Dom.newNode("feMerge",ha),fb=map.Dom.newNode("feMergeNode",fa),fb.setAttributeNS(null,"in","matrixOut"),
fb=map.Dom.newNode("feMergeNode",fa),fb.setAttributeNS(null,"in","SourceGraphic"),L=map.Dom.getBox(C.lastChild),L.width&&L.height&&C.style.setProperty("filter","url(#"+szShadowFilterId+")",""))}}}}if(this.szFlag.match(/BOX/))if(this.nBoxUpper&&map.Scale.nTrueMapScale*map.Scale.nZoomScale>this.nBoxUpper){var la=SVGDocument.getElementById(this.szId+":"+ra+":chart:box");la&&la.parentNode.removeChild(la)}else for(ba=0;ba<this.indexA.length;ba++)if(g=this.indexA[ba],this.itemA[g].fDone&&(ra=this.itemA[g].szSelectionId,
C=SVGDocument.getElementById(this.szId+":"+ra+":chart"),D=SVGDocument.getElementById(this.szId+":"+ra+":chartgroup"),la=SVGDocument.getElementById(this.szId+":"+ra+":chart:box"),C&&la&&!la.getAttributeNS(szMapNs,"boxed"))){this.szFlag.match(/\bPLOT\b/)&&D&&D.style.setProperty("display","none");var L=map.Dom.getBox(C),Xa=map.Scale.normalX(this.nBoxMargin||2),Xa=Math.min(2*Xa,Xa*(L.width/map.Scale.normalX(b)));if(this.szFlag.match(/CIRCULAR/)){var Qb=Math.max(L.width,L.height)/2*1.1+Xa,dc=map.Dom.newShape("circle",
la.parentNode,L.x+L.width/2,L.y+L.height/2,Qb,"fill:"+(this.szBoxColor||"#eeeeee")+";stroke:"+(this.szBorderColor||"#dddddd")+";fill-opacity:"+(this.nBoxOpacity||1));la.parentNode.insertBefore(dc,la.parentNode.firstChild);la.parentNode.removeChild(la);L.x-=(2*Qb-L.width)/2;L.y-=(2*Qb-L.height)/2;L.height=L.width=2*Qb}if(this.szFlag.match(/TITLE/)&&this.szTitleField&&(!this.nTitleUpper||map.Scale.nTrueMapScale*map.Scale.nZoomScale<=this.nTitleUpper)){e=map.Scale.normalX(5);this.szFlag.match(/DTEXT/)&&
(e=Math.max(map.Scale.normalX(.9),Math.min(L.width/5,map.Scale.normalX(14/this.nScale))));this.szFlag.match(/GRIDSIZE/)&&(e=Math.max(L.width/10,map.Scale.normalX(6)));var e=e*(this.nTextScale||this.nValueScale||1),vb=this.itemA[g].szTitle;try{vb=HTMLWindow.ixmaps.htmlgui_onInfoTitle(this.itemA[g].szTitle,this.itemA[g])}catch(Cc){}var ec=this.szTextColor||"#888888",kb=this.szFlag.match(/BOTTOMTITLE/)?L.y+L.height+1*e:L.y-.7*e;this.szFlag.match(/BAR/)&&!this.szFlag.match(/BOTTOMTITLE/)&&(kb=this.nMaxValue?
-this.nMaxValue*b/this.nScale:kb);var hb=null,Gb=null;this.szAlign&&this.szAlign.match(/right/)?(Gb=map.Dom.newText(C,L.x+L.width,kb,"font-family:arial;font-size:"+e+"px;text-anchor:end;fill:none;stroke:white;stroke-width:"+e/7+"px;opacity:0.5;pointer-events:none;",String(vb||" ")),hb=map.Dom.newText(C,L.x+L.width,kb,"font-family:arial;font-size:"+e+"px;text-anchor:end;fill:"+ec+";stroke:none;pointer-events:none;",String(vb||" "))):this.szFlag.match(/CIRCULAR/)?(Gb=map.Dom.newText(C,L.x+L.width/2,
kb,"font-family:arial;font-size:"+e+"px;text-anchor:middle;fill:none;stroke:white;stroke-width:"+e/7+"px;opacity:0.5;pointer-events:none;",String(vb||" ")),hb=map.Dom.newText(C,L.x+L.width/2,kb,"font-family:arial;font-size:"+e+"px;text-anchor:middle;fill:"+ec+";stroke:none;pointer-events:none;",String(vb||" "))):(Gb=map.Dom.newText(C,L.x,kb,"font-family:arial;font-size:"+e+"px;text-anchor:start;fill:none;stroke:white;stroke-width:"+e/7+"px;opacity:0.5;pointer-events:none;",String(vb||" ")),hb=map.Dom.newText(C,
L.x,kb,"font-family:arial;font-size:"+e+"px;text-anchor:start;fill:"+ec+";stroke:none;pointer-events:none;",String(vb||" ")));map.Dom.wrapText(Gb,L.width);var pc=map.Dom.wrapText(hb,L.width);this.szFlag.match(/BOTTOMTITLE/)||(Gb.fu.setPosition(hb.fu.getPosition().x,hb.fu.getPosition().y-1*e*(pc-1)),hb.fu.setPosition(hb.fu.getPosition().x,hb.fu.getPosition().y-1*e*(pc-1)));if(this.szFlag.match(/CLIPPEDTITLE/)){var Rb=L.height;L.height+=1.8*e;L.y-=L.height-Rb;map.Dom.setClipRect(hb,new box(L.x,L.y-
10*e,L.width-e/3,20*e))}else L=map.Dom.getBox(C),L.y+=.1*e,L.height-=.1*e;this.szTimeField&&(sb=(new Date(this.itemA[g].szTime)).getTime()||this.itemA[g].szTime,hb.setAttributeNS(szMapNs,"time",sb))}if(this.szFlag.match(/\bPLOTX\b/))Rb=L.height,L.height=map.Scale.normalX(b),L.y=-map.Scale.normalX(b/2),L.width=this.nMax*map.Scale.normalX(1.1*b)/this.nMax*5*(this.nRangeScale||1);else if(this.szFlag.match(/\bPLOTY\b/)){var Rb=L.height,Dc=L.width;L.width=map.Scale.normalX(b);L.height=this.nMax*map.Scale.normalX(1.1*
b)/this.nMax*5*(this.nRangeScale||1);L.x-=(L.width-Dc)/2;L.y-=(L.height-Rb)/2}var fc=L.height+2*Xa;0<=L.width+2*Xa&&0<=fc&&(la.setAttributeNS(null,"x",L.x-Xa),la.setAttributeNS(null,"y",L.y-Xa),la.setAttributeNS(null,"width",L.width+2*Xa),la.setAttributeNS(null,"height",L.height+2*Xa));(this.szFlag.match(/AUTOSIZE/)||this.szFlag.match(/GRIDSIZE/))&&L.width>L.height&&(la.setAttributeNS(null,"y",L.y-Xa-(L.width-L.height)),la.setAttributeNS(null,"height",L.width+2*Xa));if("undefined"!=typeof this.nBorderRadius&&
!isNaN(this.nBorderRadius)){var Sb=Math.min(map.Scale.normalX(this.nBorderRadius),map.Scale.normalX(this.nBorderRadius*(L.width/map.Scale.normalX(b))));la.setAttributeNS(null,"rx",Sb);la.setAttributeNS(null,"ry",Sb)}var gc=map.Scale.normalX(.2*(this.szBorderWidth||1)*(L.width/map.Scale.normalX(b)));la.style.setProperty("stroke-width",gc);la.setAttributeNS(szMapNs,"boxed","1");this.szFlag.match(/\bPLOT\b/)&&D&&D.style.setProperty("display","inline");this.szTimeField&&(console.log("---------!"),console.log("timestamp!"),
sb=(new Date(this.itemA[g].szTime)).getTime()||this.itemA[g].szTime,la.setAttributeNS(szMapNs,"time",sb))}this.szFlag.match(/FEATURE/)&&map.Themes.addToThemeNodesCache(this.chartGroup);this.szItemFilter&&this.szItemFilter.length&&this.filterItems(this.szItemFilter,this.itemFilterOpt);null!=this.markedClass&&this.markClass(this.markedClass,1);this.isVisible=!0;this.realizeDone();this.fShowProgressBar=!1;displayProgressBar(1,1,"",1,"",1);this.showInfo();this.szFlag.match(/SHOWSTATISTIC/)&&this.showErrorInfo();
if(this.szFlag.match(/\bCLIP\b/))if(this.nClipFrames==this.itemA[g].nValuesA.length)this.szXaxisA&&this.szXaxisA[this.nActualFrame]?displayMessage(this.szXaxisA[this.nActualFrame],3E3,"big"):this.szLabelA&&this.szLabelA[this.nActualFrame]&&displayMessage(this.szLabelA[this.nActualFrame],3E3,"big");else{var db=this.szXaxisA||this.szLabelA;db&&(0===this.nActualFrame?displayMessage(db[0],3E3,"big"):this.nActualFrame==this.nClipFrames-1?displayMessage(db[1],3E3,"big"):displayMessage(" ... ",3E3,"big"))}else this.ErrorMessage?
(displayMessage(this.ErrorMessage,1E4,"notify"),this.ErrorMessage=null):clearMessage();this.fSorted||(this.fResort=!0,map.Themes.execute());this.szFlag.match(/DECLUTTER/)&&this.declutterCharts();this.szFlag.match(/\bANIMATESCALE\b/)&&this.animateCharts("scale");this.szFlag.match(/\bANIMATESCALEXX\b/)&&this.animateCharts("fire")};
MapTheme.prototype.sortChartObjects=function(){if(!(!this.chartGroup||this.szFlag.match(/NOSRT/)||this.szFlag.match(/NOSIZE/)&&!this.szFlag.match(/3D/)||this.szFlag.match(/CATEGORICAL/)&&!this.szFlag.match(/AGGREGATE/)&&!this.szSizeField)){var c=null,b=[],d=this.chartGroup.childNodes;if(this.szFlag.match(/BUBBLE/)||this.szFlag.match(/SQUARE/)||this.szFlag.match(/BUFFER/)||this.szFlag.match(/TEXTONLY/))for(var a=0;a<d.length;a++)c=d.item(a),b[a]={node:c,y:Math.abs(Number(c.getAttributeNS(szMapNs,"value")))};
else for(var f=getRotateAttributeValue(map.Scale.canvasNode)/180*Math.PI,a=0;a<d.length;a++)c=d.item(a),b[a]=f?{node:c,y:getTranslate(c).x*Math.sin(f)+getTranslate(c).y*Math.cos(f)}:{node:c,y:getTranslate(c).y};this.szFlag.match(/\bSORT\b/)&&this.szFlag.match(/\bUP\b/)&&!this.szFlag.match(/SEQUENCE/)?b.sort(this.sortDownChartObjectsCompare):b.sort(this.sortUpChartObjectsCompare);for(a=0;a<b.length;a++)b[a].node.parentNode.appendChild(b[a].node);var e;(e=getMatrix(this.chartGroup))&&setMatrix(this.chartGroup,
e)}};MapTheme.prototype.sortUpChartObjectsCompare=function(c,b){return c.y-b.y};MapTheme.prototype.sortDownChartObjectsCompare=function(c,b){return b.y-c.y};
MapTheme.prototype.getChartSize=function(c,b,d,a){if(d.match(/NOSIZE/))return Math.max(5,b/4);a=Math.abs(a);var f=Math.max(5,b/2),e=this.nMax-this.nMin;this.nNormalSizeValue&&(e=this.nMaxSize=this.nNormalSizeValue);var g=this.itemA[c].nValue100;d.match(/SIZE/)&&!d.match(/NORMSIZE/)&&this.szSizeField&&c&&this.itemA[c]?f=d.match(/LINEAR/)||d.match(/SIZEP1/)?f/this.nMaxSize*this.itemA[c].nSize:d.match(/SIZELOG/)?Math.max(1,f/Math.log(this.nMaxSize)*Math.log(this.itemA[c].nSize)):d.match(/SIZEP4/)?f/
Math.pow(this.nMaxSize,.25)*Math.pow(this.itemA[c].nSize,.25):d.match(/3D/)||d.match(/SIZEP3/)||d.match(/SIZEVOLUME/)?f/Math.pow(this.nMaxSize,1/3)*Math.pow(this.itemA[c].nSize,1/3):f/Math.sqrt(this.nMaxSize)*Math.sqrt(this.itemA[c].nSize):d.match(/SIZE/)&&!d.match(/NORMSIZE/)&&(f=d.match(/LINEAR/)||d.match(/SIZEP1/)?f/e*a:d.match(/SIZELOG/)?Math.max(1,f/Math.log(e)*Math.log(a)):d.match(/SIZEP4/)?f/Math.pow(e,.25)*Math.pow(a,.25):d.match(/3D/)||d.match(/SIZEP3/)||d.match(/SIZEVOLUME/)?f/Math.pow(e,
1/3)*Math.pow(a,1/3):f/Math.sqrt(e)*Math.sqrt(a));map.Scale.normalX(10);d.match(/HEIGHT/)&&!d.match(/NORMSIZE/)&&(d.match(/SIZE/)?this.szSizeField&&c&&this.itemA[c]?Math.pow(10/e*this.itemA[c].nSize,1/3):Math.pow(10/e*a,1/3):g&&this.nMax100&&this.nMin100&&d.match(/FRACTION/));d.match(/ZOOM/)&&(this.origSize=f*=map.Scale.nObjectScaling,f=b/10+1*f/(Math.log(Math.abs(e))*Math.log(Math.abs(a))||1),f=Math.min(f,b),f=Math.max(f,b/5));return Math.abs(f)};
MapTheme.prototype.checkChartSize=function(c,b,d,a){return this.nChartSizeMin&&!d.match(/ZOOM/)&&this.getChartSize(c,b,d,a)/map.Layer.nObjectScale<this.nChartSizeMin?!1:!0};MapTheme.prototype.getChart=function(c,b,d,a,f){this.fRealizeDone||this.realize();return this.drawChart(c,b,d,a,f)};
MapTheme.prototype.drawChart=function(c,b,d,a,f){var e=null,g=0,l=0;this.szChartFlag=a;if(b){if(!this.itemA[b])return null;this.itemA[b].fDone=!1;var e=this.itemA[b].nValuesA,g=this.itemA[b].nValue100,l=Math.max(this.nMax,Math.abs(this.nMin)),n=0;if(!this.szFlag.match(/BUFFER/))for(var k=0;k<e.length;k++)isNaN(e[k])&&(e[k]=0),n+=e[k];if(this.szFlag.match(/MORPH/)&&this.szFlag.match(/\bCLIP\b/)&&this.nClipFrames){for(var e=[],q=this.itemA[b].nValuesA,k=0;k<q.length/2;k++){var h=q[k]*(this.nClipFrames-
1-this.nActualFrame)/(this.nClipFrames-1)+q[k+q.length/2]*this.nActualFrame/(this.nClipFrames-1);e[k]=h}for(k=n=0;k<e.length;k++)isNaN(e[k])&&(e[k]=0),n+=e[k]}if(a.match(/NOPE/))return new point(0,0);if(a.match(/DOT/)){var u=1,h=e[0];if(a.match(/CATEGORICAL/))this.chart.szColor=this.colorScheme[h];else if(2<this.colorScheme.length||this.szRanges&&this.szRanges.length)for(ub=!1,k=0;k<this.partsA.length;k++)if(h<this.partsA[k].max){this.chart.szColor=this.colorScheme[k];var w=__maptheme_getChartColors(v);
a.match(/NOLINES/)?this.chart.szLineColor="none":this.chart.szLineColor=w.textColor;a.match(/RANGE/)&&!a.match(/RANGES/)&&(u=map.Scale.normalX(2+5*(k+1)/this.partsA.length));Q=k;ub=!0;break}x=map.Dom.newShape("circle",c,0,0,map.Scale.normalX(3),"fill:"+this.chart.szColor+";stroke:none;");return new point(0,0)}}else{e=[];n=0;a=a||this.szFlag+"|XAXIS";if(this.szOrigFlag.match(/CATEGORICAL/))if(this.szOrigFlag.match(/SUM/))for(k=0;k<this.colorScheme.length;k++)this.partsA[k]&&(e[k]=this.partsA[k].nSum,
l=Math.max(l,this.partsA[k].nSum),n+=e[k]);else if(this.szOrigFlag.match(/COUNT/))for(k=0;k<this.colorScheme.length;k++)e[k]=100*this.partsA[k].nSum,l=Math.max(l,100*this.partsA[k].nSum),n+=e[k];else for(k=0;k<this.colorScheme.length;k++)e[k]=this.nOrigSumA[k]||this.exactCountA[k]||1,l=Math.max(l,this.nOrigSumA[k]||this.exactCountA[k]||1);else if(this.szOrigFlag.match(/COUNT/))for(k=0;k<this.colorScheme.length;k++)e[k]=this.partsA[k].nCount,l=Math.max(l,this.partsA[k].nCount),n+=e[k];else for(k=0;k<
this.colorScheme.length;k++)e[k]=this.partsA[k].nSum,l=Math.max(l,this.partsA[k].nSum),n+=e[k];if(g=this.nSum100){l=0;n=g;for(k=e.length-1;0<=k;k--)this.szFlag.match(/DIFFERENCE/)?g=0<k?e[k-1]:this.nSum100:this.szFlag.match(/CALCVAL/)||this.szFlag.match(/CALC100/)?e[k]=e[k]:this.szFlag.match(/PRODUCT/)?e[k]=e[k]:(e[k]/=g,l=Math.max(l,e[k]),this.szFlag.match(/PERMILLE/)?e[k]*=1E3:this.szFlag.match(/FRACTION/)||(e[k]*=100),this.szFlag.match(/RELATIVE/)&&(e[k]-=100),this.szFlag.match(/INVERT/)&&(e[k]=
100-e[k]));if(this.szFlag.match(/STACKED/)){if(l=100,this.szFlag.match(/NORMSIZE/)||a.match(/NORMSIZE/))for(k=l=0;k<e.length;k++)l+=e[k]}else l*=100,l+=l/10,l=this.nMax}else{if(this.szFlag.match(/DIFFERENCE/))for(k=e.length-1;0<=k;k--)0<k?e[k]-=e[k-1]:this.szFlag.match(/STACKED/)||(e[k]=0);if(b&&this.szAggregation&&this.szAggregation.match(/mean/)){for(k=0;k<e.length;k++)e[k]/=this.nCount;l=this.szFlag.match(/MENUSIZE/)?l/this.nCount:this.nMax}if(this.szFlag.match(/MEAN/))for(k=0;k<e.length;k++)e[k]/=
this.partsA[k].nCount;if(this.szFlag.match(/STACKED/)&&(this.szFlag.match(/NORMSIZE/)||a.match(/NORMSIZE/)||this.szFlag.match(/MENUSIZE/)||a.match(/MENUSIZE/)))for(k=l=0;k<e.length;k++)l+=e[k]}}if(this.nChartSizeMin&&!a.match(/ZOOM/)){if(u=b?this.getChartSize(b,d,a,n):1,u/map.Layer.nObjectScale<this.nChartSizeMin)return null}else if(!this.szFlag.match(/MULTIFIX|MULTIGRID|MULTIQUAD/)&&(u=b?this.getChartSize(b,d,a,n):1,isNaN(u)||0===u))return null;var p=new point(0,0);if(!a)a=this.szFlag;else if(!a.match(/CHART/)&&
a.match(/VALUES/)||a.match(/NORMSIZE/)||a.match(/MENUSIZE/))a=this.szFlag+"|"+a;a.match(/DOMINANT|COMPOSE/)&&!a.match(/CHART/)&&(a=a.match(/PERCENTOFMEAN/)?"BAR|OFFSETMEAN|POINTER|VALUES|ZOOM":a.match(/PERCENTOFMEDIAN/)?"BAR|OFFSETMEDIAN|POINTER|VALUES|ZOOM":a.match(/DEVIATION/)?"BAR|DEVIATION|POINTER|VALUES|ZOOM":"BAR|XAXIS|HORZ|SORT|VALUES|ZOOM");a.match(/ZOOM/)&&a.match(/BAR/)&&a.match(/POINTER/)&&1<e.length&&(a=this.removeDefinition(a,"SIZE")+"|COMPRESSMAX");if(1==e.length&&0===e[0]&&!a.match(/ZEROISVALUE/)&&
!a.match(/CATEGORICAL/))return this.nZeroValueCount++,null;a.match(/VALUES/)&&(this.fHideValues=!1,a.match(/ZOOM/)||(this.fHideValues=this.szValueUpper&&map.Scale.nTrueMapScale*map.Scale.nZoomScale>this.nValueUpper||this.szValueLower&&map.Scale.nTrueMapScale*map.Scale.nZoomScale<this.nValueLower),a.match(/ZOOM/)&&a.match(/PIE/)&&25<e.length&&(a=this.removeDefinition(a,"VALUES")));var t=map.Dom.newGroup(c,this.szId+":"+b+(b?":chartgroup":":ochrtgroup")),M=null,D=null;a.match(/MOVABLE/)&&(t.setAttributeNS(null,
"id",t.getAttributeNS(null,"id")+":movable"),t.setAttributeNS(null,"onmousedown",'map.Themes.initChartOffset(evt,"'+this.szId+'","'+this.szId+":"+b+':chartgroup:movable")'),t.setAttributeNS(null,"onmouseup",'map.Themes.endChartOffset(evt,"'+this.szId+'","'+this.szId+":"+b+':chartgroup:movable")'));if(a.match(/CHOROPLETH/)){var y=map.Scale.normalX(d/2),m=2*y/3,v=this.colorScheme[0],A=this.colorScheme[1]?this.colorScheme[1]:"none",B=map.Scale.normalX(.1)*map.Scale.nFeatureScaling*map.Scale.nObjectScaling,
x=map.Dom.constructNode("use",t,{"xlink:href":"#choropleth_icon"});x.fu.scale(2,2);d=2*m/map.Scale.normalX(1);p.x=0;p.y=m+map.Scale.normalY(5)}if(a.match(/BLANK/))return null;if(a.match(/\bUSER\b/))try{m=map.Scale.normalX(d);a.match(/GRIDSIZE/)&&(m=this.nGridSize);var Fa=this.objThemesA[this.szThemesA[0]],ka={target:t,theme:this,item:this.itemA[b],values:e,maxSize:m,flag:a,mark:f,dbRecord:Fa.dbRecords?Fa.dbRecords[this.itemA[b].dbIndex]:null};this.ptNullUser=null;this.userDraw?(this.opt=ka,eval("this.ptNullUser = HTMLWindow.ixmaps."+
this.userDraw+"(SVGDocument,this.opt);"),delete this.opt):this.ptNullUser=HTMLWindow.ixmaps.htmlgui_drawChart(SVGDocument,ka);if(this.ptNullUser)return t.fu.setPosition(t.fu.getPosition().x-this.ptNullUser.x,t.fu.getPosition().y-this.ptNullUser.y),this.ptNullUser.x=0,this.ptNullUser.y=0,this.ptNullUser;this.userChartDrawError=(this.userChartDrawError||0)+1}catch(ha){}if(a.match(/PIE/)){if(0===n&&!a.match(/AUTOCOMPLETE/))return null;if(a.match(/\bSORT\b/)){this.sortedIndex=[];for(k=0;k<e.length;k++)this.sortedIndex[k]=
{index:k,value:e[k]};this.sortedIndex.sort(this.sortIndexDown)}else this.sortedIndex=null;if(a.match(/\bREVERSE\b/))for(this.sortedIndex=[],k=0;k<e.length;k++)this.sortedIndex[k]={index:e.length-k,value:e[k]};this.nCenterValue=0;if(a.match(/CENTER/)){for(var fa=this.nCenter=0,fb=-Number.MAX_VALUE,ba=Number.MAX_VALUE,C=0;C<(this.nClipParts||e.length);C++){var H=this.sortedIndex?this.sortedIndex[C].index:C,fa=fa+(e[H]||0);e[H]<ba&&(ba=e[H],this.nCenterMin=H);e[H]>fb&&(fb=e[H],this.nCenterMax=H)}this.szCenterPart=
this.szCenterPart||"max","first"==this.szCenterPart?this.nCenter=0:"last"==this.szCenterPart?this.nCenter=e.length-1:"min"==this.szCenterPart?this.nCenter=this.nCenterMin:"max"==this.szCenterPart?this.nCenter=this.nCenterMax:Number(this.szCenterPart)&&(this.nCenter=Number(this.szCenterPart));this.nCenterValue=e[this.nCenter];this.nCenterSize=this.nCenterValue/fa*100}var na=0,u=Math.max(5,d/2),pa=this.nMax-this.nMin,ac=this.nMax100-this.nMin100;this.nNormalSizeValue&&(pa=ac=this.nNormalSizeValue);
a.match(/GRIDSIZE/)&&!a.match(/NORMSIZE/)?u=this.nGridSize/d*(a.match(/\bRECT\b/)?.72:.6):a.match(/SIZE/)&&!a.match(/NORMSIZE/)&&this.szSizeField&&b&&this.itemA[b]?u=a.match(/SIZELOG/)?Math.max(1,u/Math.log(this.nMaxSize)*Math.log(this.itemA[b].nSize)):a.match(/SIZEP4/)?u/Math.pow(this.nMaxSize,.25)*Math.pow(this.itemA[b].nSize,.25):a.match(/3D/)||a.match(/SIZEP3/)||a.match(/SIZEVOLUME/)?u/Math.pow(this.nMaxSize,1/3)*Math.pow(this.itemA[b].nSize,1/3):u/Math.sqrt(this.nMaxSize)*Math.sqrt(this.itemA[b].nSize):
a.match(/SIZE/)&&!a.match(/NORMSIZE/)&&(u=a.match(/SIZELOG/)?Math.max(1,u/Math.log(pa)*Math.log(n)):a.match(/SIZEP4/)?u/Math.pow(pa,.25)*Math.pow(n,.25):a.match(/3D/)||a.match(/SIZEP3/)||a.match(/SIZEVOLUME/)?u/Math.pow(pa,1/3)*Math.pow(n,1/3):u/Math.sqrt(pa)*Math.sqrt(n));na=map.Scale.normalX(10);a.match(/HEIGHT/)&&!a.match(/NORMSIZE/)&&(na=a.match(/SIZE/)?this.szSizeField&&b&&this.itemA[b]?na*Math.pow(10/pa*this.itemA[b].nSize,1/3)*3:na*Math.pow(10/pa*n,1/3)*3:g&&this.nMax100&&this.nMin100&&!a.match(/FRACTION/)?
10*na/ac*g:10*na/pa*n);a.match(/ZOOM/)&&(this.origSize=u*=map.Scale.nObjectScaling,u=d/10+3*u/Math.log(pa)*Math.log(n)*map.Layer.nDynamicObjectScale,u=Math.min(u,1.2*d),u=Math.max(u,d/2));for(var sb=[],W=0;W<(this.nGridX||1);W++){var G=DonutCharts.newChart(SVGDocument,t,0,0,map.Scale.normalX(u),0);G.ident=W;p.x=0;p.y=map.Scale.normalY(u)+map.Scale.normalY(5);G.setStyle("flat");G.setLine("#555566");G.setLineWidth(map.Scale.normalX(this.nLineWidth||.1));a.match(/NOLINES/)&&G.setLine("none");a.match(/WHITELINES/)&&
G.setLine("white");this.szLineColor&&G.setLine(this.szLineColor);if(a.match(/3D/)){G.setStyle("3D");var N=.5;a.match(/P3/)?N=1/3:a.match(/P4/)&&(N=.25);a.match(/SIZE/)&&!a.match(/NORMSIZE/)&&this.szSizeField&&b&&this.itemA[b]?na=na/Math.pow(this.nMaxSize,N)*Math.pow(this.itemA[b].nSize,N):a.match(/SIZE/)&&!a.match(/NORMSIZE/)&&(na=na/Math.pow(pa,N)*Math.pow(n,N));a.match(/ZOOM/)&&(na*=map.Scale.nObjectScaling,na=na/this.origSize*u);p.y*=.7}a.match(/VOLUME/)&&G.addStyle("VOLUME");if(a.match(/DONUT/))a.match(/3D/)?
G.setRadInner(map.Scale.normalX(.5*u)):a.match(/XTHIN/)?G.setRadInner(map.Scale.normalX(.95*u)):a.match(/THIN/)?G.setRadInner(map.Scale.normalX(.66*u)):a.match(/THICK/)?G.setRadInner(map.Scale.normalX(.25*u)):G.setRadInner(map.Scale.normalX(.42*u));else if(a.match(/CENTER/)){var Da=Math.sqrt(Math.pow(map.Scale.normalX(u),2)/100*this.nCenterSize);G.setRadInner(Da)}a.match(/STARBURST/)&&(G.addStyle("STARBURST"),p.y*=.8);if(a.match(/XLFLOWER/)||a.match(/XLRAYS/))G.addStyle("XLRAYS"),p.y*=.8;else if(a.match(/LFLOWER/)||
a.match(/LRAYS/))G.addStyle("LRAYS"),p.y*=.8;else if(a.match(/XSFLOWER/)||a.match(/XSRAYS/))G.addStyle("XSRAYS"),p.y*=.8;else if(a.match(/SFLOWER/)||a.match(/SRAYS/))G.addStyle("SRAYS"),p.y*=.8;else if(a.match(/FLOWER/)||a.match(/RAYS/))G.addStyle("RAYS"),p.y*=.8;a.match(/SILENT/)&&G.addStyle("SILENT");a.match(/AUTOCOMPLETE/)&&(G.addStyle("AUTOCOMPLETE"),G.szNoDataColor=this.szNoDataColor||"#eeeeee");a.match(/BIGTOTOP/)&&G.addStyle("BIGTOTOP");a.match(/NOROTATE/)&&G.addStyle("NOROTATE");a.match(/ROTATE/)&&
G.addStyle("ROTATE");a.match(/SYMMETRIC/)&&G.addStyle("SYMMETRIC");a.match(/HALFPLUS20/)&&(G.addStyle("HALFPLUS20"),G.addStyle("NOROTATE"));a.match(/HALFMINUS20/)&&(G.addStyle("HALFMINUS20"),G.addStyle("NOROTATE"));a.match(/HALFPLUS10/)&&(G.addStyle("HALFPLUS10"),G.addStyle("NOROTATE"));a.match(/HALFMINUS10/)&&(G.addStyle("HALFMINUS10"),G.addStyle("NOROTATE"));a.match(/HALF/)&&(G.addStyle("HALF"),G.addStyle("NOROTATE"));a.match(/DIRECTION/)&&G.addStyle("DIRECTION");a.match(/DIRECTED/)&&G.addStyle("DIRECTED");
a.match(/POLAR/)&&W==(this.nGridX||1)-1&&G.addStyle("POLAR");var ca=0,ua=0,I=0;if(a.match(/DONUT/))for(k=0;k<e.length;k++)e[k]>e[ca]&&(ca=k),e[k]<e[ua]&&(ua=k);if(a.match(/STARBURST/)){for(k=0;k<e.length;k++)e[k]=Math.max(e[k],0),I=Math.max(I,this.nMaxA[k]);a.match(/\bSIZE\b/)||G.setNormalSizeValue(this.nNormalSizeValue||this.nMaxValue||I);G.setMaxValue(this.nMaxValue||I)}a.match(/BOW/)&&(G.nBow=1.3);a.match(/SBOW/)&&(G.nBow=1.2);a.match(/XSBOW/)&&(G.nBow=1.1);a.match(/LBOW/)&&(G.nBow=1.5);a.match(/XLBOW/)&&
(G.nBow=1.8);sb.push(G)}for(k=0;k<(this.nClipParts?Math.min(this.nClipParts,e.length):e.length);k++){var ia=k%(this.nGridX||1),G=sb[ia],V="",H=k;this.sortedIndex&&(H=this.sortedIndex[H].index);if(!a.match(/CENTER/)||a.match(/DONUT/)||H!=this.nCenter){V=this.szLabelA&&this.szLabelA[H]?" '"+this.szLabelA[H]+"'":" '"+this.szFieldsA[H]+"'";v=b?this.itemA[b].szColor||this.colorScheme[H]:this.colorScheme[H];v=b?this.itemA[b].szColor||this.colorScheme[H%(this.nGridX||1E5)]:this.colorScheme[H%(this.nGridX||
1E6)];if(a.match(/CLASSES/)||1==e.length)for(va=0;va<this.partsA.length;va++)if(a.match(/CATEGORICAL/)&&e[H]==this.partsA[va].min||!a.match(/CATEGORICAL/)&&e[H]<this.partsA[va].max){v=this.colorScheme[va];c.setAttributeNS(szMapNs,"class",String(va));break}var Ra=(a.match(/AUTOCOMPLETE/)&&!this.szUnit.match(/%/)?" % ":"")+this.szUnit;if(this.szShowParts){var Ac=v,v="none";for(C in this.szShowPartsA)this.szShowPartsA[C]==H&&(v=Ac)}if(0<e[H]||0===e[H]&&!a.match(/ZEROISNOTVALUE/)){if(a.match(/COUNT/)&&
this.itemA[b].nCountA)var ra=G.addPart(e[H],na,v,0,this.formatValue(this.itemA[b].nCountA[H],this.nValueDecimals||(1>this.itemA[b].nCountA[H]?2:0),"ROUND")+Ra,V);else 0==ia&&(hc=0),ra=G.addPart(e[H]+(a.match(/STACKED/)?hc:0),na,v,0,(this.szAggregation&&this.szAggregation.match(/sum/),this.formatValue(e[H],this.nValueDecimals||(1>e[H]?2:0),"ROUND")+Ra),V),hc+=e[H];ra.nClass=H;if(a.match(/DIRECTION|DIRECTED/)){var nc=this.itemA[b].ptPos,Ea=this.getNodePosition(this.szThemesA[0]+"::"+this.szLabelA[H]);
if(nc&&Ea){var Sa=Math.atan2(nc.y-Ea.y,Ea.x-nc.x)*(180/Math.PI);ra.nAngle=(450-Sa)%360}}}"none"==this.colorScheme[k]&&G.setLine(this.szLineColor||"black")}}2>G.partsA.length&&b&&1==this.itemA[b].nCount&&(G.nRadInner=0);for(W=(this.nGridX||1)-1;0<=W;W--)sb[W].realize();if(a.match(/CENTER/)&&!a.match(/DONUT/)){var m=Math.sqrt(Math.pow(map.Scale.normalX(u),2)/100*this.nCenterSize),v=this.colorScheme[this.nCenter],Ma=map.Dom.newShape("circle",t,0,0,.9*m,"fill:"+v+";");Ma&&(Ma.setAttributeNS(szMapNs,"class",
String(this.nCenter)),Ma.setAttributeNS(szMapNs,"tooltip",this.szLabelA?this.szLabelA[this.nCenter]+": "+e[this.nCenter]+this.szUnit+"":e[this.nCenter]+this.szUnit));if(a.match(/GLOW/)&&!a.match(/ZOOM/)&&(!this.szGlowUpper||map.Scale.nTrueMapScale*map.Scale.nZoomScale<=this.nGlowUpper)&&(!this.szGlowLower||map.Scale.nTrueMapScale*map.Scale.nZoomScale>=this.nGlowLower)){var sa=map.Dom.newShape("circle",t,0,0,6*m,"fill:"+v+";stroke:none;fill-opacity:0.05;pointer-events:none;");sa&&sa.setAttributeNS(szMapNs,
"class",String(ma));var ab=map.Dom.newShape("circle",t,0,0,2*m,"fill:"+v+";stroke:none;fill-opacity:0.1;pointer-events:none;");ab&&ab.setAttributeNS(szMapNs,"class",String(ma))}if(a.match(/CENTERVALUE/)||a.match(/ZOOM/)||a.match(/VALUES/)&&!this.fHideValues){var R=this.formatValue(this.nCenterValue,this.nValueDecimals||0,"ROUND")+(5>=this.szUnit.length?this.szUnit:""),w=__maptheme_getChartColors(v),za=w.textColor,P=String(Math.min(.8*m,3.3/R.length*m)*this.nValueScale),tb=map.Dom.newText(t,0,.33*
P,"font-family:arial;font-size:"+P+"px;font-weight:bold;text-anchor:middle;fill:"+za+";opacity:"+String(this.nOpacity?this.nOpacity:1)+";stroke:none;pointer-events:none",R);tb&&tb.setAttributeNS(szMapNs,"class",String(this.nCenter))}}else if(a.match(/CENTERVALUE/)){var R=String(this.itemA[b].nCount||this.itemA[b].nSize),za=this.szValueColor||this.szTextColor||"#888888",m=map.Scale.normalX(u),P=String(Math.min(.5*m,2/R.length*m)),qa=this.nValueSizeMin?P/map.Scale.normalX(5):1;map.Dom.newText(t,0,.35*
P,"font-family:arial;font-size:"+P+"px;text-anchor:middle;fill:none;stroke:black;stroke-width:"+P/40+";stroke-opacity:0.5;pointer-events:none;stroke-linejoin:bevel;",R);var F=map.Dom.newText(t,0,.35*P,"font-family:arial;font-size:"+P+"px;text-anchor:middle;fill:"+za+";opacity:"+qa+";stroke:none;pointer-events:none",R)}!a.match(/VALUES/)||a.match(/STACKED/)||!a.match(/ZOOM/)&&this.fHideValues||(P=Math.min(.8*u,3.4/(G.partsA[0]?G.partsA[0].szText.length:1)*u),1<e.length||a.match(/NOINLINETEXT/)||a.match(/ZOOM/)&&
6>P?(P=a.match(/ZOOM/)||a.match(/NORMSIZE/)?map.Scale.normalX(8):map.Scale.normalX(5*(this.nValueScale||1)),this.drawDonutText(G,P)):(R=G.partsA[0]?G.partsA[0].szText:"",w=__maptheme_getChartColors(v),za=this.szValueColor||this.szTextColor||w.textColor,m=map.Scale.normalX(u),P=String(Math.min(.8*m,3.4/R.length*m)),qa=this.nValueSizeMin?P/map.Scale.normalX(5):1,a.match(/VOLUME/)&&(na=G.donutPartsA[0].nHeight),a.match(/3D/)||(na=.6*m),F=map.Dom.newText(t,0,-na+m/2+.45*P,"font-family:arial;font-size:"+
P+"px;text-anchor:middle;fill:"+za+";opacity:"+qa+";stroke:none;pointer-events:none",R),a.match(/3D/)&&(F.fu.setPosition(0,-m/2+P*(a.match(/VOLUME/)?.5:.25)),F.fu.scale(1,.5))));this.fillOpacity&&t.setAttributeNS(null,"fill-opacity",String(this.fillOpacity));this.nOpacity&&(t.setAttributeNS(null,"fill-opacity",String(this.nOpacity)),t.setAttributeNS(null,"stroke-opacity",String(this.nOpacity)));if(a.match(/FADEDEVIATION/)){var Ob=(e[0]-this.nMeanA[0])/this.nDeviationA[0];10<Ob&&(qa=Math.pow(10,.5)/
Math.pow(Ob,.5),t.setAttributeNS(null,"opacity",String(qa)))}else a.match(/LIMITDEVIATION/)&&(Ob=(e[0]-this.nMeanA[0])/this.nDeviationA[0],10<Ob&&t.setAttributeNS(null,"opacity","0"));a.match(/ZOOM/)&&a.match(/STARBURST/);if(1==e.length&&a.match(/CATEGORICAL/))G.donutPartsA[0]&&(G.donutPartsA[0].objNode.setAttributeNS(szMapNs,"class",c.getAttributeNS(szMapNs,"class")),G.donutPartsA[0].textNode&&G.donutPartsA[0].textNode.setAttributeNS(szMapNs,"class",c.getAttributeNS(szMapNs,"class")));else for(k=
0;k<G.donutPartsA.length;k++)G.donutPartsA[k]&&(G.donutPartsA[k].objNode.setAttributeNS(szMapNs,"class",String(G.partsA[k].nClass)),G.donutPartsA[k].textNode&&G.donutPartsA[k].textNode.setAttributeNS(szMapNs,"class",String(G.partsA[k].nClass)));this.nRealizedCount++}else if(a.match(/WAFFLE/)){var Aa=map.Scale.normalX(d);if(a.match(/GRIDSIZE/))Aa=1.05*this.nGridSize;else if(a.match(/AUTOSIZE/))var Ta=map.Layer.nDynamicObjectScale,gb=a.match(/\bRECT\b/)?a.match(/GAP/)?2.3:2:a.match(/GAP/)?1.7:1.6,I=
Math.max(Tb,this.nMax),Aa=this.nGridWidthPx?map.Scale.normalX(this.nGridWidthPx)/gb/Ta:this.nGridWidth?map.Scale.getDeltaXofDistanceInMeter(this.nGridWidth)/gb/Ta:y,Aa=Aa/Math.sqrt(this.nMaxSize)*Math.sqrt(this.itemA[b].nSize);Aa*=.97;x=map.Dom.newShape("rect",t,-(Aa/2)+10,-(Aa/2)+10,Aa-20,Aa-20,"fill:"+(this.szBoxColor||"back")+";stroke:"+(this.szBorderColor||"none")+";stroke-width:"+(this.szBorderWidth||2)+";fill-opacity:"+(this.nBoxOpacity||.05)+";opacity:1;");Aa*=.9;if(a.match(/\bSORT\b/)){this.sortedIndex=
[];for(k=0;k<e.length;k++)this.sortedIndex[k]={index:k,value:e[k]};this.sortedIndex.sort(this.sortIndexDown)}else this.sortedIndex=null;var l=Math.max(this.nMax,Math.abs(this.nMin)),Eb=this.nGridX||(a.match(/WAFFLE100/)?10:Math.max(5,Math.round(Math.sqrt(l))));a.match(/AUTO100/)&&(Eb=10);var Fb=Aa/(1.1*Eb),va=-Aa/2,Ua=Aa/2,bc=0,Pb=1E5;a.match(/WAFFLE100/)&&(Pb=100);for(k=0;k<e.length;k++){var Va=this.sortedIndex?this.sortedIndex[k].index:k;e[Va]=Math.round(e[Va]);if(e[Va])for(var Bc=Math.min(e[Va],
Pb),Pb=Pb-e[Va],ea=0;ea<Bc;ea++)x=map.Dom.newShape("rect",t,va,Ua-Fb,Fb,Fb,"fill:"+this.colorScheme[Va]+";stroke:null;fill-opacity:"+(this.fillOpacity||1)+";opacity:"+(this.nOpacity||1)+";"),x.setAttributeNS(szMapNs,"class",String(Va)),x.setAttributeNS(szMapNs,"tooltip",this.szLabelA?this.szLabelA[Va]+": "+e[Va]+this.szUnit+"":e[Va]+this.szUnit),va+=1.1*Fb,++bc>=Eb&&(va=-Aa/2,Ua-=1.1*Fb,bc=0)}this.nRealizedCount++}else if(a.match(/BUBBLE/)||a.match(/SQUARE/)||a.match(/LABEL/)){y=map.Scale.normalX(d/
2);a.match(/AUTOSIZE/)&&(Ta=map.Layer.nDynamicObjectScale,gb=a.match(/\bRECT\b/)?a.match(/GAP/)?2.3:2:a.match(/GAP/)?1.7:1.6,I=Math.max(Tb,this.nMax),y=this.nGridWidthPx?map.Scale.normalX(this.nGridWidthPx)/gb/Ta:this.nGridWidth?map.Scale.getDeltaXofDistanceInMeter(this.nGridWidth)/gb/Ta:y);I=Math.max(this.nMax,this.nMaxA[0]);this.nNormalSizeValue&&(this.nMaxSize=I=this.nNormalSizeValue);h=e[0];if(this.szFlag.match(/\bCLIP\b/)&&!this.szFlag.match(/MORPH/)&&this.nClipFrames&&(this.nClipFrames==e.length?
(h=Number(e[this.nActualFrame]),I=this.nNormalSizeValue||this.nMaxA[this.nActualFrame]):h=e[0]*(this.nClipFrames-1-this.nActualFrame)/(this.nClipFrames-1)+e[e.length-1]*this.nActualFrame/(this.nClipFrames-1),0===h&&!a.match(/ZEROISVALUE/))||a.match(/INVERTSIZE/)&&0===I-e[0]&&!a.match(/ZEROISVALUE/))return null;var Oa=b&&this.itemA[b]&&this.szSizeField?this.itemA[b].nSize||0:h,oc=b&&this.itemA[b]&&this.szSizeField?this.nMaxSize:I;if(0===Oa&&!a.match(/NOSIZE/)||this.nMinValue&&Oa<this.nMinValue)return null;
var m=a.match(/MENUSIZE/)?map.Scale.normalX(d/2.5):a.match(/CATEGORICAL/)&&!this.szSizeField?y/3/(this.nNormalSizeValue||1):a.match(/NOSIZE/)?y/2:a.match(/FIXSIZE/)?y/2/(this.nNormalSizeValue||1):a.match(/NORMSIZE/)?2*y/3/(a.match(/CATEGORICAL/)?1:Math.log(oc)*Math.log(Math.abs(Oa))):a.match(/SUM/)&&!b?2*y/3:y/Math.pow(oc,1/this.nSizePow)*Math.pow(Math.abs(Oa),1/this.nSizePow),ub=!0,Q=null,ta=x=null,Pa=F=ab=sa=null,Ja=null,v=this.colorScheme[0],A=this.colorScheme[1]?this.colorScheme[1]:"none",za=
this.colorScheme[1]?this.colorScheme[1]:"white";if(2<this.colorScheme.length||a.match(/CATEGORICAL/))v=this.colorScheme[this.colorScheme.length-1],A=this.colorScheme[0];a.match(/NOLINES/)?A="none":"none"==A&&(w=__maptheme_getChartColors(v),A=w.lowColor);if(a.match(/CATEGORICAL/))Q=h-1,v=this.colorScheme[Q]||this.colorScheme[0],w=__maptheme_getChartColors(v),za=w.textColor,A=a.match(/NOLINES/)?"none":w.lowColor,a.match(/RANGE/)&&!a.match(/RANGES/)&&(m=map.Scale.normalX(2+5*(k+1)/this.partsA.length)),
ub=!0;else if(this.szFlag.match(/COMPOSECOLOR/))this.szFlag.match(/SUBTRACTIVE/)?this.itemA[b].szColor=__maptheme_getComposedColor_subtractive(this.itemA[b].nValuesA,this.colorScheme,this.nMax,Math.floor(255*this.nBrightness)):this.itemA[b].szColor=__maptheme_getComposedColor_additive(this.itemA[b].nValuesA,this.colorScheme,this.nMax,Math.floor(255*this.nBrightness));else if(2<this.colorScheme.length||this.szRanges&&this.szRanges.length)if(ub=!1,this.szFlag.match(/DOMINANT/)){for(var Wa=0,cc=0,J=
-1,k=0;k<this.itemA[b].nValuesA.length;k++){var h=this.itemA[b].nValuesA[k],L=100/this.nMeanA[k]*h,bb=100/this.nMedianA[k]*h,Ga=(h-this.nMeanA[k])/this.nDeviationA[k],Wa=h;this.szFlag.match(/PERCENTOFMEAN/)&&(Wa=L);this.szFlag.match(/PERCENTOFMEDIAN/)&&(Wa=bb);this.szFlag.match(/DEVIATION/)&&(Wa=Ga);h>this.nFilterA[k]&&Wa>cc&&(this.itemA[b].nClass=k,cc=Wa,J=k)}0<=J&&(this.itemA[b].nDominant=J,h=this.itemA[b].nValuesA[J],V=" "+this.szFieldsA[J]+" ",this.szLabelA&&this.szLabelA[J]&&(V=" "+this.szLabelA[J]+
" "),this.itemA[b].nValue=this.itemA[b].nValuesA[J],this.itemA[b].szLabel=V,v=this.colorScheme[J],w=__maptheme_getChartColors(v),za=w.textColor,A=a.match(/NOLINES/)?"none":w.lowColor,Q=J,ub=!0)}else for(k=0;k<this.partsA.length;k++)if(h>=this.partsA[k].min&&h<this.partsA[k].max){v=this.colorScheme[k];w=__maptheme_getChartColors(v);za=w.textColor;A=a.match(/NOLINES/)?"none":w.lowColor;a.match(/RANGE/)&&!a.match(/RANGES/)&&(m=map.Scale.normalX(2+5*(k+1)/this.partsA.length));Q=k;ub=!0;break}this.itemA[b]&&
(this.itemA[b].szColor=v);za=this.szValueColor||this.szTextColor||za;A=this.szLineColor||A;if(ub){B=this.nLineWidth||.1;B=a.match(/OUTLINE/)?map.Scale.normalX(Math.min(1,1/y*m)):map.Scale.normalX(B/Math.sqrt(y)*Math.sqrt(m));if(a.match(/BUBBLE/)){var U=null;"$item$"==this.szTimeField?U=(new Date(this.szFieldsA[J].split(" ")[0])).getTime():b&&(U=(new Date(this.itemA[b].szTime)).getTime());if(a.match(/GLOW/)&&!a.match(/ZOOM/)&&this.fGlowInScale){if(x=map.Dom.newShape("circle",t,0,0,6*m,"fill:"+v+";stroke:none;fill-opacity:0.05;pointer-events:none;"))x.setAttributeNS(szMapNs,
"class",String(Q)),x.setAttributeNS(szMapNs,"time",U);if(x=map.Dom.newShape("circle",t,0,0,2*m,"fill:"+v+";stroke:none;fill-opacity:0.1;pointer-events:none;"))x.setAttributeNS(szMapNs,"class",String(Q)),x.setAttributeNS(szMapNs,"time",U)}else a.match(/AURA/)&&!a.match(/ZOOM/)&&this.fGlowInScale&&(x=map.Dom.newShape("circle",t,0,0,1.3*m,"fill:"+(this.szLineColor||v)+";stroke:none;fill-opacity:0.3;"))&&(x.setAttributeNS(szMapNs,"class",String(Q)),x.setAttributeNS(szMapNs,"time",U));x=map.Dom.newShape("circle",
t,0,0,m,"fill:"+v+";stroke:"+A+";stroke-width:"+B+";")}else if(a.match(/SQUARE/))x=map.Dom.newShape("rect",t,-m,-m,2*m,2*m,"fill:"+v+";stroke:"+A+";stroke-width:"+B+";");else if(a.match(/TEXTONLY/))x=map.Dom.newShape("rect",t,-m,-8,2.05*m,8,"fill:none;stroke:none;");else if(a.match(/LABEL/)){R=this.formatValue(h,this.nValueDecimals||(1>h||1>=I?1:0),"ROUND")+(5>=this.szUnit.length?this.szUnit:"");0===h&&(this.szFlag.match(/DIFFERENCE/)||this.szFlag.match(/RELATIVE/)||this.szFlag.match(/SIGN/))?R="+-"+
R:0<h&&(this.szFlag.match(/DIFFERENCE/)||this.szFlag.match(/RELATIVE/)||this.szFlag.match(/SIGN/))&&(R="+"+R);var jb=Math.min(.8*m,3.4/R.length*m);if(!this.fShadow&&this.fOrigShadow&&m>map.Scale.normalX(5)){if(x=map.Dom.newShape("rect",t,-m+.02*m,.83*-jb+.02*m,2.05*m,1.6*jb,"fill:#000000;stroke:none;opacity:"+.4*(this.fillOpacity?this.fillOpacity:1)))x.setAttributeNS(null,"rx",map.Scale.normalX(2*m/y)),x.setAttributeNS(null,"ry",map.Scale.normalX(2*m/y));if(x=map.Dom.newShape("rect",t,-m+.03*m,.83*
-jb+.03*m,2.05*m,1.6*jb,"fill:"+v+";stroke:none;opacity:"+.2*(this.fillOpacity?this.fillOpacity:1)))x.setAttributeNS(null,"rx",map.Scale.normalX(2*m/y)),x.setAttributeNS(null,"ry",map.Scale.normalX(2*m/y))}if(x=map.Dom.newShape("rect",t,-m,.83*-jb,2.05*m,1.6*jb,"fill:"+v+";stroke:"+A+";stroke-width:"+B+";"))x.setAttributeNS(null,"rx",map.Scale.normalX(2*m/y)),x.setAttributeNS(null,"ry",map.Scale.normalX(2*m/y))}if(x){a.match(/SILENT/)||(a.match(/CATEGORICAL/)&&this.szLabelA&&this.szLabelA[h-1]?x.setAttributeNS(szMapNs,
"tooltip",this.szLabelA[h-1]+" "+this.szTitle+""):x.setAttributeNS(szMapNs,"tooltip",this.formatValue(h,2)+this.szUnit+" "+this.szTitle+""));F=null;if(a.match(/VALUES/)&&!this.fHideValues)if(R=null,this.szValueField&&"$title$"==this.szValueField?R=this.itemA[b].szTitle:this.szValueField&&this.itemA[b].szValue?(R=this.formatValue(__scanValue(this.itemA[b].szValue),this.nValueDecimals||(1>this.itemA[b].szValue?1:0),"ROUND")+(5>=this.szUnit.length?this.szUnit:""),0===h&&(this.szFlag.match(/DIFFERENCE/)||
this.szFlag.match(/RELATIVE/)||this.szFlag.match(/\bSIGN\b/))?R="+/-"+R:0<h&&(this.szFlag.match(/DIFFERENCE/)||this.szFlag.match(/RELATIVE/)||this.szFlag.match(/\bSIGN\b/))&&(R="+"+R)):this.szValueField&&this.szValueField==this.szSizeField&&Oa?(R=this.formatValue(__scanValue(Oa),this.nValueDecimals||(1>Oa?1:0),"ROUND")+(5>=this.szUnit.length?this.szUnit:""),0===Oa&&(this.szFlag.match(/DIFFERENCE/)||this.szFlag.match(/RELATIVE/)||this.szFlag.match(/\bSIGN\b/))?R="+/-"+R:0<Oa&&(this.szFlag.match(/DIFFERENCE/)||
this.szFlag.match(/RELATIVE/)||this.szFlag.match(/\bSIGN\b/))&&(R="+"+R)):a.match(/CATEGORICAL/)&&this.szLabelA?R=this.szLabelA[h-1]||"?":(R=this.formatValue(h,this.nValueDecimals||(1>h||1>=I?1:0),"ROUND")+(5>=this.szUnit.length?this.szUnit:""),0===h&&(this.szFlag.match(/DIFFERENCE/)||this.szFlag.match(/RELATIVE/)||this.szFlag.match(/\bSIGN\b/))?R="+/-"+R:0<h&&(this.szFlag.match(/DIFFERENCE/)||this.szFlag.match(/RELATIVE/)||this.szFlag.match(/\bSIGN\b/))&&(R="+"+R)),P=String(Math.min(.8*m,3.3/R.length*
m)*this.nValueScale),a.match(/TEXTONLY/)){w=__maptheme_getChartColors(v);za=w.textColor;P=.8*m*this.nValueScale;if(this.nValueSizeMin&&!a.match(/ZOOM/)&&P*map.Layer.nDynamicObjectScale<map.Scale.normalX(this.nValueSizeMin))return null;var nb=this.szTextFont||"arial",Pa=map.Dom.newText(t,0,.33*P,"font-family:"+nb+";font-size:"+P+"px;font-weight:normal;text-anchor:middle;fill:none;stroke:"+v+";stroke-width:"+P/7+";stroke-opacity:0.5;pointer-events:none;stroke-linejoin:bevel;",R);Pa.setAttributeNS(null,
"id",this.szId+":"+b+":text:bg");F=map.Dom.newText(t,0,.33*P,"font-family:"+nb+";font-size:"+P+"px;font-weight:normal;text-anchor:middle;fill:"+(this.szValueColor||this.szTextColor||"#000000")+";opacity:"+qa+";stroke:none;",R);F.setAttributeNS(null,"id",this.szId+":"+b+":text");x.parentNode.removeChild(x)}else if(a.match(/LABEL/)||P>map.Scale.normalX(1))qa=this.nValueSizeMin?P/map.Scale.normalX(5):1,F=map.Dom.newText(t,0,.33*P,"font-family:"+(this.szTextFont||"arial")+";font-size:"+P+"px;font-weight:bold;text-anchor:middle;fill:"+
za+";opacity:"+qa+";stroke:none;pointer-events:none",R);if(a.match(/DTEXT/)&&b&&!a.match(/ZOOM/)){var Ba=Math.pow(Math.abs(m),1/3)/Math.pow(y,1/3);x.style.setProperty("fill-opacity",String(Ba),"");x.style.setProperty("stroke-opacity",String(Ba),"");F&&F.style.setProperty("fill-opacity",String(Ba),"")}else x.style.setProperty("fill-opacity",String(this.fillOpacity?this.fillOpacity:1),""),a.match(/OUTLINE/)||this.szLineColor?x.style.setProperty("stroke-opacity","1",""):x.style.setProperty("stroke-opacity",
String(this.fillOpacity&&.5>this.fillOpacity?1:.3),"")}null!=Q&&(x&&(x.setAttributeNS(szMapNs,"value",String(h)),x.setAttributeNS(szMapNs,"class",String(Q))),F&&(F.setAttributeNS(szMapNs,"value",String(h)),F.setAttributeNS(szMapNs,"class",String(Q))),Pa&&(Pa.setAttributeNS(szMapNs,"value",String(h)),Pa.setAttributeNS(szMapNs,"class",String(Q))));this.szTimeField&&(U=null,U="$item$"==this.szTimeField?(new Date(this.szFieldsA[J].split(" ")[0])).getTime():(new Date(this.itemA[b].szTime)).getTime(),x&&
x.setAttributeNS(szMapNs,"time",U),F&&F.setAttributeNS(szMapNs,"time",U),Pa&&Pa.setAttributeNS(szMapNs,"time",U));d=2*m/map.Scale.normalX(1);p.x=0;p.y=a.match(/TEXTONLY/)?m:m+map.Scale.normalY(5);this.nRealizedCount++}else return this.nMissingRangeCount++,null}else if(a.match(/SYMBOL/)){if("undefined"!=typeof this.szSymbolBoxStyle){A="#dddddd";"undefined"!=typeof this.szBorderColor&&(A=this.szBorderColor);var cb="stroke-width:0;";if("undefined"!=typeof this.szBorderStyle)switch(this.szBorderStyle){case "dotted":cb=
"stroke-width:"+map.Scale.normalX(1)+";stroke-linecap:round;stroke-dasharray:1,50;";break;case "dashed":cb="stroke-width:"+map.Scale.normalX(1)+";stroke-linecap:butt;stroke-dasharray:30,30;";break;case "solid":cb="stroke-width:"+map.Scale.normalX(1)+";";break;case "none":cb="stroke-width:0;"}var zb=map.Dom.newShape("rect",t,0,0,1,1,"fill:white;stroke:"+A+";"+cb);switch(this.szSymbolBoxStyle){case "frame":zb.setAttributeNS(null,"fill-opacity",0);break;case "field":zb.setAttributeNS(null,"fill-opacity",
1)}}if(!this.szSymbolsA)for(this.szSymbolsA=[],k=0;k<e.length;k++)this.szSymbolsA.push("circle");else if(this.szSymbolsA.length<e.length)for(k=this.szSymbolsA.length;k<e.length;k++)this.szSymbolsA.push(this.szSymbolsA[this.szSymbolsA.length-1]);var la=null;a.match(/VALUES|AXIS/)&&(la=map.Dom.newGroup(t,this.szId+":"+b+":textgroup"));this.initAngle=0;if(a.match(/\bSORT\b/))if(a.match(/\bBYMEAN\b/)){this.sortedIndex=[];for(k=this.sortedMax=0;k<e.length;k++)this.sortedIndex[k]={index:k,value:e[k],tvalue:e[k],
mean:this.nMeanA[k]},this.sortedMax=Math.max(this.sortedMax,e[k]);this.sortedIndex.sort(this.sortMeanUp);this.initAngle=0}else if(a.match(/\bBYMEDIAN\b/)){this.sortedIndex=[];for(k=this.sortedMax=0;k<e.length;k++)this.sortedIndex[k]={index:k,value:e[k],tvalue:e[k],mean:this.nMedianA[k]},this.sortedMax=Math.max(this.sortedMax,e[k]);this.sortedIndex.sort(this.sortMeanUp);this.initAngle=0}else if(a.match(/\bUP\b/)){this.sortedIndex=[];for(k=this.sortedMax=0;k<e.length;k++)this.sortedIndex[k]={index:k,
value:e[k],tvalue:e[k]},this.sortedMax=Math.max(this.sortedMax,e[k]);this.sortedIndex.sort(this.sortIndexUp);this.initAngle=0}else if(a.match(/\bDOWN\b/)){this.sortedIndex=[];for(k=this.sortedMax=0;k<e.length;k++)this.sortedIndex[k]={index:k,value:e[k],tvalue:e[k]},this.sortedMax=Math.max(this.sortedMax,e[k]);this.sortedIndex.sort(this.sortIndexDown);this.initAngle=0}else{if(a.match(/\bRANDOM\b/)){this.sortedIndex=[];this.sortedMax=0;if(this.nClipParts&&this.nClipParts<e.length){for(var Xa=[],k=0;k<
e.length;k++)Xa[k]={index:k,value:e[k],tvalue:e[k]};Xa.sort(this.sortIndexDown);for(k=0;k<this.nClipParts;k++){var Qb=Xa[k].index;this.sortedIndex[k]={index:Qb,value:e[Qb],tvalue:e[Qb]};this.sortedMax=Math.max(this.sortedMax,e[k])}}else for(k=0;k<e.length;k++)this.sortedIndex[k]={index:k,value:e[k],tvalue:e[k]},this.sortedMax=Math.max(this.sortedMax,e[k]);b?(this.itemA[b].randomA||(this.itemA[b].randomA=this.getRandomNumberArray(e.length+1)),this.shuffleArray(this.sortedIndex,this.itemA[b].randomA),
this.initAngle=Math.floor(360*this.itemA[b].randomA[0])):this.initAngle=0}}else this.sortedIndex=null;if(a.match(/RINGS/)){if(this.sortedIndex)for(var dc=0,k=0;k<this.sortedIndex.length;k++)this.sortedIndex[k].value&&(this.sortedIndex[k].value+=dc,dc=this.sortedIndex[k].value);else for(dc=0,this.sortedIndex=[],k=0;k<e.length;k++)this.sortedIndex[k]={index:k,value:e[k],tvalue:e[k]},this.sortedIndex[k].value&&(this.sortedIndex[k].value+=dc,dc=this.sortedIndex[k].value);this.sortedIndex.sort(this.sortIndexDown)}if(a.match(/\bSMOOTH\b/)&&
!a.match(/\bZOOM\b/))for(var vb=e.slice(),k=e.length-2;1<=k;k--){e[k]=vb[k];e[k]+=vb[k+1];for(r=1;2>r;r++)e[k]+=vb[k-r];e[k]/=3}if(a.match(/\bLINREG\b/)){for(var Cc=0,ec=0,k=0;k<e.length;k++)Cc+=k,ec+=e[k];for(var kb=Cc/e.length,hb=ec/e.length,Gb=0,pc=0,k=0;k<e.length;k++)va=k,Ua=e[k],Gb+=(va-kb)*(Ua-hb),pc+=(va-kb)*(va-kb);var Rb=Gb/pc,Dc=hb-Rb*kb}var fc=null,Sb=null,gc=null,Q=0,db="",jd=0,lb=0,Na=0,ob=0,Tb=-Number.MAX_VALUE,Qc=Number.MAX_VALUE,wb=0,Rc=0,kd=0,Hb=!1,pb=0,ca=e.length;this.nClipParts&&
this.nClipParts<e.length&&(a.match(/\bUP\b/)?pb=e.length-this.nClipParts:ca=this.nClipParts);if(this.szFlag.match(/DOMINANT/)){for(var cc=Wa=0,Ec=-1,k=0;k<this.itemA[b].nValuesA.length;k++)h=this.itemA[b].nValuesA[k],L=100/this.nMeanA[k]*h,bb=100/this.nMedianA[k]*h,Ga=(h-(this.nMeanA[k]||0))/this.nDeviationA[k],Wa=h,this.szFlag.match(/PERCENTOFMEAN/)&&(Wa=L),this.szFlag.match(/PERCENTOFMEDIAN/)&&(Wa=bb),this.szFlag.match(/DEVIATION/)&&(Wa=Ga),h>(this.nFilterA[k]||0)&&Wa>cc&&(this.itemA[b].nClass=
k,cc=Wa,Ec=k);0<=Ec&&(pb=this.itemA[b].nDominant=Ec,ca=pb+1,Q=Ec)}else this.szFlag.match(/COMPOSECOLOR/)&&(this.szFlag.match(/SUBTRACTIVE/)?this.itemA[b].szColor=__maptheme_getComposedColor_subtractive(this.itemA[b].nValuesA,this.colorScheme,this.nMax,Math.floor(255*this.nBrightness)):this.itemA[b].szColor=__maptheme_getComposedColor_additive(this.itemA[b].nValuesA,this.colorScheme,this.nMax,Math.floor(255*this.nBrightness)));this.szFlag.match(/\bCLIP\b/)&&(ca=pb+1);for(k=pb;k<ca;k++)Rc+=0!==e[k],
Tb=Math.max(Tb||this.nMaxA[k],this.nMaxA[k]),Qc=Math.min(Qc||this.nMinA[k],this.nMinA[k]),wb=Math.max(wb,e[k]);if(this.szFlag.match(/STACKED/)&&this.nGridX)for(k=pb;k<ca;){for(var hc=0,ea=0;ea<this.nGridX;ea++)hc+=e[k++];wb=Math.max(wb,hc)}for(var Cd=Math.max(Tb,this.nMax),ld=this.formatValue(Cd,this.nValueDecimals||"")+(5>=this.szUnit.length?this.szUnit:""),Sc=0,k=pb;k<ca;k++){var J=k,h=e[J],Ha=e[J];a.match(/COUNT/)&&this.itemA[b].nCountA&&(Ha=this.itemA[b].nCountA[J]);this.sortedIndex&&(h=this.sortedIndex[J].value,
Ha=this.sortedIndex[J].tvalue,J=this.sortedIndex[J].index);this.szValueField&&this.itemA[b]&&"$title$"==this.szValueField?Ha=this.itemA[b].szTitle:this.szValueField&&this.itemA[b]&&this.itemA[b].szValue&&(Ha=isNaN(this.itemA[b].szValue)?this.itemA[b].szValue:__scanValue(this.itemA[b].szValue));if(this.szShowParts){var uc=!0;for(C in this.szShowPartsA)this.szShowPartsA[C]==J%(this.nGridX||1E6)&&(uc=!1);if(uc)continue}if(!a.match(/ZOOM/)||!this.markedClasses||this.markedClasses[J]){Q=J;this.nGridX&&
a.match(/PLOT/)&&(Q%=this.nGridX);a.match(/STACKED/)&&(0==Q&&(Sc=0),Sc=Ha+=Sc);if((a.match(/ZOOM/)||a.match(/NORMSIZE/))&&this.szLabelA)var Ya=this.formatValue(Ha,1>Ha?2:0),db=Ya+this.szUnit,db=db+(" "+this.szLabelA[J%(this.nGridX||1E7)]);else Ya=this.formatValue(Ha,2),db=" "+Ya+this.szUnit;U=null;this.szTimeField&&(U="$item$"==this.szTimeField?(new Date(this.szFieldsA[J].split(" ")[0])).getTime():(new Date(this.itemA[b].szTime)).getTime());if(!a.match(/CATEGORICAL/)||a.match(/AGGREGATE/)||a.match(/GROUP/)){y=
map.Scale.normalX(d/2);I=this.nNormalSizeValue||Tb;a.match(/MENUSIZE/)?I=5*wb:!this.nNormalSizeValue||a.match(/SEQUENCE/)&&this.szSizeField||(this.nMaxSize=I=this.nNormalSizeValue);wb&&a.match(/ZOOM/)&&a.match(/SEQUENCE/)&&(I=wb/2+wb/2*Math.pow(I,.5)/Math.pow(wb,.5));if(a.match(/INVERTSIZE/)&&0===I-h&&!a.match(/ZEROISVALUE/))return null;this.szFlag.match(/\bCLIP\b/)&&!this.szFlag.match(/MORPH/)&&this.nClipFrames&&(Ha=h=this.nClipFrames==e.length?Number(e[this.nActualFrame]):e[J]*(this.nClipFrames-
1-this.nActualFrame)/(this.nClipFrames-1)+e[e.length-1]*this.nActualFrame/(this.nClipFrames-1));if(h||a.match(/PLOT|NOSIZE/)){m=0;a.match(/AUTOSIZE/)&&(Ta=map.Layer.nDynamicObjectScale,gb=a.match(/\bRECT\b/)?a.match(/GAP/)?2.3:2:a.match(/GAP/)?1.6:1.5,I=Math.max(Tb,this.nMax),y=this.nGridWidthPx?map.Scale.normalX(this.nGridWidthPx)/gb/Ta:this.nGridWidth?map.Scale.getDeltaXofDistanceInMeter(this.nGridWidth)/gb/Ta:y);m=a.match(/GRIDSIZE/)&&!a.match(/PLOT/)?this.nGridSize/2:a.match(/NOSIZE/)?map.Scale.normalX(d/
3):a.match(/FIXSIZE/)?map.Scale.normalX(d/3)/(this.nNormalSizeValue||1):y/Math.pow(I,1/this.nSizePow)*Math.pow(h,1/this.nSizePow);a.match(/SEQUENCE/)?a.match(/MENUSIZE/)||a.match(/SUM/)&&!b?m*=this.szField100?1:2:a.match(/ZOOM/)&&!a.match(/PLOT/)?m*=2:a.match(/AGGREGATE/)&&a.match(/CATEGORICAL/)||!this.szSizeField||!b||!this.itemA[b]||(m=m/Math.pow(this.nMaxSize,1/this.nSizePow)*Math.pow(this.itemA[b].nSize,1/this.nSizePow)):a.match(/MENUSIZE/)||a.match(/SUM/)&&!b?m=1.5*y:a.match(/ZOOM/)&&!a.match(/PLOT/)?
m=Math.max(m,2*y/3):a.match(/NOSIZE/)?m=y/5:(!a.match(/GRIDSIZE/)&&this.szSizeField&&b&&this.itemA[b]&&(m=y/Math.pow(this.nMaxSize,1/this.nSizePow)*Math.pow(this.itemA[b].nSize,1/this.nSizePow)),a.match(/PLOTXY/)&&(m/=5));if(isNaN(m)||!m){if(!a.match(/STAR|STACKED|PLOT/))continue;m=1}Z=this.szSymbolsA[J];if(this.nRangesA&&this.nRangesA.length)for(ea=0;ea<this.nRangesA.length;ea++)if(h==this.nRangesA[ea]||Number(h)==Number(this.nRangesA[ea])){Z=this.szSymbolsA[ea]||this.szSymbolsA[0]||"circle";break}Z=
this.itemA[b].szSymbol||Z;a.match(/SEQUENCE/)&&(Z=this.szSymbolsA[J]);if(b&&this.itemA[b].szColor)v=this.itemA[b].szColor,Q=this.itemA[b].nClass,this.colorClassUsedA&&(this.colorClassUsedA[Q]=!0);else if((a.match(/SEQUENCE/)||a.match(/DOMINANT/))&&this.colorScheme.length==this.partsA.length)v=this.colorScheme[J%(this.nGridX||1E4)],A=this.colorScheme[J];else if(v=this.colorScheme[0],A=this.colorScheme[1]?this.colorScheme[1]:"none",2<this.colorScheme.length&&(v=this.colorScheme[this.colorScheme.length-
1],A=this.colorScheme[0]),a.match(/NOLINES/)?A="none":"none"==A&&(w=__maptheme_getChartColors(v),A=w.textColor),2<this.colorScheme.length||this.szRanges&&this.szRanges.length){for(ea=0;ea<this.partsA.length;ea++)if(a.match(/CATEGORICAL/)&&h==this.partsA[ea].min||!a.match(/CATEGORICAL/)&&h<this.partsA[ea].max){v=this.colorScheme[ea];w=__maptheme_getChartColors(v);A=w.textColor;a.match(/RANGE/)&&!a.match(/RANGES/)&&(m=map.Scale.normalX(2+5*(ea+1)/this.partsA.length));Q=ea;break}else if(this.szRanges&&
this.szRanges.length&&h<this.partsA[ea].min){v=this.colorScheme[ea-1];w=__maptheme_getChartColors(v);A=w.textColor;Q=ea-1;break}a.match(/NOLINES/)&&(A="none")}A=A||v;this.nSymbolScale=m/map.Scale.normalX(d);if("circle"==Z||"square"==Z||"roundrect"==Z||"carot"==Z||"diamond"==Z||"triangle"==Z||"hexagon"==Z||"empty"==Z||"label"==Z||"cross"==Z){A=this.szLineColor||A;B=(this.nLineWidth||1)*map.Scale.normalX(Math.min(2*m/y,.2));switch(Z){case "empty":x=map.Dom.newShape("circle",t,0,0,m,"fill:#888888;fill-opacity:0;stroke:#888888;stroke-width:"+
B+";");break;case "circle":!this.fShadow&&this.fOrigShadow&&(ta=map.Dom.newShape("circle",t,map.Scale.normalX(.5)+.02*m,map.Scale.normalX(.5)+.02*m,1.02*m,"fill:#000000;stroke:none;opacity:"+.6*(this.fillOpacity?this.fillOpacity:1)));ab=sa=null;if(!a.match(/GLOW/)||this.sortedIndex&&k!=pb||a.match(/ZOOM/)||this.szGlowUpper&&!(map.Scale.nTrueMapScale*map.Scale.nZoomScale<=this.nGlowUpper)||this.szGlowLower&&!(map.Scale.nTrueMapScale*map.Scale.nZoomScale>=this.nGlowLower))a.match(/AURA/)&&k==pb&&!a.match(/ZOOM/)&&
(!this.szGlowUpper||map.Scale.nTrueMapScale*map.Scale.nZoomScale<=this.nGlowUpper)&(!this.szGlowLower||map.Scale.nTrueMapScale*map.Scale.nZoomScale>=this.nGlowLower)&&(sa=map.Dom.newShape("circle",t,0,0,1.3*m,"fill:"+(this.szLineColor||v)+";stroke:none;fill-opacity:0.3;"))&&(sa.setAttributeNS(szMapNs,"class",String(Q)),sa.setAttributeNS(szMapNs,"time",String(U)));else{if(sa=map.Dom.newShape("circle",t,0,0,6*m,"fill:"+v+";stroke:none;fill-opacity:0.05;pointer-events:none;"))sa.setAttributeNS(szMapNs,
"class",String(Q)),sa.setAttributeNS(szMapNs,"time",U);if(ab=map.Dom.newShape("circle",t,0,0,2*m,"fill:"+v+";stroke:none;fill-opacity:0.1;pointer-events:none;"))ab.setAttributeNS(szMapNs,"class",String(Q)),ab.setAttributeNS(szMapNs,"time",String(U))}x=map.Dom.newShape("circle",t,0,0,m,"fill:"+v+";stroke:"+A+";stroke-width:"+B+";");break;case "square":x=map.Dom.newShape("rect",t,-m,-m,2*m,2*m,"fill:"+v+";stroke:"+A+";stroke-width:"+B+";");break;case "roundrect":x=map.Dom.newShape("rect",t,-m,-m,2*
m,2*m,"fill:"+v+";stroke:"+A+";stroke-width:"+B+";");x.setAttributeNS(null,"rx",.3*m);break;case "cross":x=map.Dom.newShape("rect",t,1.6*-m,.4*-m,3.2*m,.8*m,"fill:"+v+";stroke:"+A+";stroke-width:"+map.Scale.nFeatureScaling*map.Scale.nObjectScaling+";");x=map.Dom.newShape("rect",t,.4*-m,1.6*-m,.8*m,3.2*m,"fill:"+v+";stroke:"+A+";stroke-width:"+map.Scale.nFeatureScaling*map.Scale.nObjectScaling+";");break;case "carot":case "diamond":(x=map.Dom.newShape("rect",t,-m,-m,2*m,2*m,"fill:"+v+";stroke:"+A+
";stroke-width:"+B+";"))&&x.setAttributeNS(null,"transform","rotate(45)");break;case "triangle":x=map.Dom.newShape("path",t,"M 0,"+m+" l"+1.2*m+",-"+2*m+" -"+2.4*m+",0 "+1.2*m+","+2*m+"z","fill:"+v+";stroke:"+A+";stroke-width:"+B+";");break;case "hexagon":Za=m/2;Ka=m*Math.sin(60/180*Math.PI);vc=m;x=map.Dom.newShape("path",t,"M -"+m+",0 l "+Za+",-"+Ka+" "+vc+",0 "+Za+","+Ka+" -"+Za+","+Ka+" -"+vc+",0 -"+Za+",-"+Ka+" z","fill:"+v+";stroke:"+A+";stroke-width:"+B+";");break;case "label":if(R=this.formatValue(Ha,
this.nValueDecimals||(1>Ha||1>=I?1:0),"ROUND")+(5>=this.szUnit.length?this.szUnit:""),a.match(/TEXTONLY/)){za=__maptheme_getChartColors(v).textColor;P=String(Math.max(Math.min(.8*m,map.Scale.normalX(500)),map.Scale.normalX(2)));if(this.nValueSizeMin&&!a.match(/ZOOM/)&&P*map.Layer.nDynamicObjectScale<map.Scale.normalX(this.nValueSizeMin)){x=map.Dom.newShape("rect",t,0,0,0,0,"fill:none;");ta=map.Dom.newShape("rect",t,0,0,0,0,"fill:none;");break}nb=this.szTextFont||"arial";ta=map.Dom.newText(t,0,0,"font-family:"+
nb+";font-size:"+P+"px;font-weight:bold;text-anchor:middle;fill:none;stroke:"+v+";stroke-width:"+P/7+";stroke-opacity:0.5;pointer-events:none;stroke-linejoin:bevel;",R);ta.setAttributeNS(null,"id",this.szId+":"+b+":text:bg");x=map.Dom.newText(t,0,0,"font-family:"+nb+";font-size:"+P+"px;font-weight:bold;text-anchor:middle;fill:"+(this.szValueColor||this.szTextColor||"#000000")+";opacity:"+qa+";stroke:none;",R);x.setAttributeNS(null,"id",this.szId+":"+b+":text")}else{P=String(Math.max(1,Math.min(.8*
m,3.4/R.length*m)));if(this.nValueSizeMin&&!a.match(/ZOOM/)&&P*map.Layer.nDynamicObjectScale<map.Scale.normalX(this.nValueSizeMin)){x=map.Dom.newShape("rect",t,0,0,0,0,"fill:none;");break}Tc=1.6*P;if(x=map.Dom.newShape("rect",t,-m,.83*-P,2.05*m,1.6*P,"fill:"+v+";stroke:"+A+";stroke-width:"+B+";"))x.setAttributeNS(null,"rx",map.Scale.normalX(2*m/y)),x.setAttributeNS(null,"ry",map.Scale.normalX(2*m/y))}}x&&(a.match(/OUTLINE/)?(x.style.setProperty("stroke-width",String(map.Scale.normalX(.5))),x.style.setProperty("stroke-opacity",
"1"),x.style.setProperty("fill-opacity","0.7")):a.match(/RANDOM/)?(x.style.setProperty("stroke-opacity",String(this.nOpacity?this.nOpacity:1),""),x.style.setProperty("fill-opacity",String(this.fillOpacity?this.fillOpacity:this.nOpacity?this.nOpacity:1),""),a.match(/DOPACITY/)&&(N=1/(this.nDopacityPow||1),qa=Math.pow(h,N)/Math.pow(this.sortedMax,N)*(this.nOpacity||1)*(this.nDopacityScale||1),x.style.setProperty("fill-opacity",String(qa),""))):a.match(/\bSORT\b/)&&a.match(/DOPACITY/)?(x.style.setProperty("stroke-opacity",
String(this.nOpacity?this.nOpacity:1),""),N=1/(this.nDopacityPow||1),qa=Math.pow(h,N)/Math.pow(this.sortedMax,N)*(this.nOpacity||1)*(this.nDopacityScale||1),x.style.setProperty("fill-opacity",String(qa),"")):a.match(/DOPACITY/)&&this.szAlphaField?b&&"undefined"!=typeof this.itemA[b].nAlpha&&(N=1/(this.nDopacityPow||1),qa=(this.nDopacityScale||1)/Math.pow(this.nMaxAlpha,N)*Math.pow(this.itemA[b].nAlpha,N),x.style.setProperty("fill-opacity",String(qa),"")):a.match(/DOPACITY/)?(N=1/(this.nDopacityPow||
1),qa=Math.pow(h-this.nMin,N)/Math.pow(this.nMax-this.nMin,N)*(this.fillOpacity||1)*(this.nDopacityScale||1),x.style.setProperty("fill-opacity",String(qa),""),a.match(/CATEGORICAL/)||(Q=Math.min(6,Math.ceil((h-this.nMin)/(this.nMax-this.nMin)*7)),x.setAttributeNS(szMapNs,"class",String(Q)),t.setAttributeNS(szMapNs,"class",String(Q)),c.setAttributeNS(szMapNs,"class",String(Q)))):x.style.setProperty("fill-opacity",String(this.fillOpacity?this.fillOpacity:this.nOpacity?this.nOpacity:1),""),this.chartGroup&&
this.chartGroup.style.setProperty("opacity","1",""),x.setAttributeNS(szMapNs,"tooltip",db),x.setAttributeNS(szMapNs,"time",U))}else Z.match(/.svg|.png|.jpeg/)?(x=map.Dom.constructNode("image",t,{"xlink:href":Z}),x.setAttributeNS(null,"x",String(map.Scale.normalX(-d/2))),x.setAttributeNS(null,"y",String(map.Scale.normalY(-d/2))),x.setAttributeNS(null,"width",String(map.Scale.normalX(d))),x.setAttributeNS(null,"height",String(map.Scale.normalY(d)))):x=map.Dom.constructNode("use",t,{"xlink:href":"#"+
Z+":antizoomandpan"}),map.Dom.newShape("circle",t,0,0,.5*m,"fill:white;stroke:none;opacity:0"),x.fu.scale(m/y,m/y),x.setAttributeNS(null,"style","fill:"+v+";stroke:"+A);if(x&&a.match(/VALUES/)&&!a.match(/TEXTONLY/)&&!this.fHideValues)if(F=null,R=Ha,isNaN(Ha)||(R=this.formatValue(Ha,this.nValueDecimals||"")+(5>=this.szUnit.length?this.szUnit:"")),w=__maptheme_getChartColors(v),za=this.szValueColor||this.szTextColor||w.textColor,Uc=Math.max((Ha.length||0)+1,ld.length),P=String(Math.min(1*y,("hexagon"==
Z?2.7:3.2)/Uc*y)),P=m/y*P*this.nValueScale,a.match(/ZOOM/)&&a.match(/LINES/)&&!a.match(/INLINETEXT/)&&(null==this.nGridX||1>=this.nGridX||a.match(/STACKED/))){var za="black",D=D||map.Dom.newGroup(c,this.szId+":"+b+":textchartontop"),P=4+.5*e.length/(this.nGridX?2*this.nGridX:1),md=Math.log(e.length)/3,F=this.createTextLabel(SVGDocument,D,"",R,P*md*this.nValueScale,"","rgba(255,255,255,0)",w.lowColor,"GLOW");F.setAttributeNS(null,"opacity","0.9");D.fu.setPosition(3*-map.Scale.normalX(P*md),-map.Scale.normalY(8/
(this.nGridX||1)))}else if("circle"==Z||"square"==Z||"roundrect"==Z||"triangle"==Z||"hexagon"==Z||"label"==Z||"empty"==Z)if(a.match(/CENTERVALUES/))0===Q&&(F=map.Dom.newText(t,0,.33*P,"font-family:"+(this.szTextFont||"arial")+";font-size:"+P+"px;text-anchor:middle;fill:"+za+";stroke:none;pointer-events:none",R));else if((a.match(/\bCENTER\b/)||a.match(/\bTOP\b/)||a.match(/\bBOTTOM\b/))&&!a.match(/\bDOMINANT\b/)){if(h){var S=6;this.szChartFlag+="|VALUEBACKGROUND";var M=M||map.Dom.newGroup(c,this.szId+
":"+b+":chartontop"),ob=ob?ob:m,Vc=-map.Scale.normalX(1),Wc=-map.Scale.normalX(1.33*S)*(Rc-kd-1),F=this.createTextLabel(SVGDocument,M,"",R,S,"",this.colorScheme[J%(this.nGridX||1E4)],this.szTextColor);F.fu.setPosition(Vc,Wc);if(b&&(a.match(/ZOOM/)||a.match(/NORMSIZE/))&&this.szLabelA){var nd=F.fu.getBox().width,Pa=map.Dom.newText(M,0,0,this.szValuesTextBgStyle,this.szLabelA[J]);Pa.fu.setPosition(Vc+nd+map.Scale.normalX(6),Wc-map.Scale.normalX(-1));Pa.fu.scale(.6,.6);F=map.Dom.newText(M,0,0,this.szValuesTextStyle+
";fill:#000;fill-opacity:0.8",this.szLabelA[J]);F.fu.setPosition(Vc+nd+map.Scale.normalX(6),Wc-map.Scale.normalX(-1));F.fu.scale(.6,.6)}F.setAttributeNS(szMapNs,"class",String(Q%(this.nGridX||1E6)));F=null;kd++}}else if(this.szValueField&&a.match(/2VALUES/))var F=map.Dom.newText(t,0,.2*-P,"font-family:"+(this.szTextFont||"arial")+";font-size:"+P+"px;text-anchor:middle;fill:"+za+";stroke:none;pointer-events:none",R),od=Math.min(.8*P,120),Ya=this.formatValue(h,this.nValueDecimals||0)+this.szUnit,Ja=
map.Dom.newText(t,0,P-.2*od,"font-family:"+(this.szTextFont||"arial")+";font-size:"+od+"px;text-anchor:middle;fill:"+za+";stroke:none;pointer-events:none",Ya);else F=map.Dom.newText(t,0,.33*P,"font-family:"+(this.szTextFont||"arial")+";font-size:"+P+"px;text-anchor:middle;fill:"+za+";stroke:none;pointer-events:none",R);else P=Math.max(.8*m,1)*this.nValueScale,M=M||map.Dom.newGroup(c,this.szId+":"+b+":chartontop"),F=this.createTextLabel(SVGDocument,M,"",R,P/map.Scale.normalX(1),"","rgba(255,255,255,0.3)",
w.lowColor,"GLOW"),F.fu.setPosition(map.Scale.normalX(0)+lb,map.Scale.normalY(0)+Na);if(x&&(x.setAttributeNS(szMapNs,"class",String(Q%(this.nGridX||1E6))),x.setAttributeNS(szMapNs,"time",U),F&&(F.setAttributeNS(szMapNs,"class",String(Q%(this.nGridX||1E6))),F.setAttributeNS(szMapNs,"time",U),F.setAttributeNS(szMapNs,"tooltip",db)),Ja&&(Ja.setAttributeNS(szMapNs,"class",String(Q%(this.nGridX||1E6))),Ja.setAttributeNS(szMapNs,"time",U)),ta&&(ta.setAttributeNS(szMapNs,"class",String(Q%(this.nGridX||1E6))),
ta.setAttributeNS(szMapNs,"time",U)),!a.match(/CENTER/))){var Ia=null;if(a.match(/STAR/)){if(0===k&&(fc=x,Sb=F,gc=Ja,ob=m,a.match(/EXPAND/)&&a.match(/\bSORT\b/)&&a.match(/\bUP\b/)&&(ob=a.match(/LINEAR/)||a.match(/SIZEP1/)?(a.match(/EXPANDMAX/)?2:.5)*y/I*this.sortedIndex[e.length-1].value:(a.match(/EXPANDMAX/)?2:.5)*y/Math.sqrt(I)*Math.sqrt(this.sortedIndex[e.length-1].value)),a.match(/ZOOM/)&&a.match(/STAR/)&&a.match(/\bUP\b/)?ob*=2:a.match(/COMPRESS/)&&(ob*=a.match(/COMPRESSMAX/)?.25:.5)),(0<k||
a.match(/\bUP\b/))&&m){var Dd=this.nClipParts&&this.nClipParts<this.partsA.length?this.nClipParts:this.partsA.length,Xc=m,pd=ob+m,Ed=Math.sqrt(Math.pow(pd,2)-Math.pow(Xc,2)),Fc=90-Math.asin(Xc*Ed/pd/Xc)/Math.PI*180,Ub=ob+m;a.match(/\bUP\b/)&&(5<k&&(Fc/=1+m/y*2),Ub=ob*(1+Dd/5));a.match(/ZOOM/)||(Ub=this.nRangeScale?Ub*this.nRangeScale:a.match(/EXPANDMAX/)?2*Ub:a.match(/EXPAND/)?1.5*Ub:Ub);this.initAngle+=Fc;lb=Math.cos(this.initAngle/180*Math.PI)*Ub;Na=Math.sin(this.initAngle/180*Math.PI)*Ub;this.initAngle+=
Fc;Ia=new point(map.Scale.normalX(0)+lb,map.Scale.normalY(0)+Na)}}else if(a.match(/RANDOM/)){var Gc=a.match(/EXPANDMAX/)?2*m:a.match(/EXPAND/)?1.5*m:m;a.match(/ZOOM/)&&(y*=2,Gc*=2);lb=Math.cos(this.initAngle+360/this.partsA.length*k/180*Math.PI)*Math.min(y,Gc);Na=Math.sin(this.initAngle+360/this.partsA.length*k/180*Math.PI)*Math.min(y,Gc);Ia=new point(map.Scale.normalX(0)+lb,map.Scale.normalY(0)+Na)}else a.match(/HORZ/)?(lb+=m,Ia=new point(map.Scale.normalX(0)+lb,map.Scale.normalY(0)+Na),lb+=m):a.match(/BOTTOM/)?
Ia=new point(map.Scale.normalX(0),-m):a.match(/TOP/)?Ia=new point(.3*-m,.7*m-y):a.match(/CONE/)?Ia=new point(map.Scale.normalY(.33*k),-map.Scale.normalY(1*k)):a.match(/BASE/)&&(Ia=new point(map.Scale.normalX(0),Na-m),Na-=m*(a.match(/VALUES/)?1.25:1));Ia?(x.fu.setPosition(Ia.x,Ia.y),ta&&ta.fu.setPosition(Ia.x,Ia.y),sa&&sa.fu.setPosition(Ia.x,Ia.y),ab&&ab.fu.setPosition(Ia.x,Ia.y),F&&F.fu.setPosition(Ia.x,Ia.y),Ja&&Ja.fu.setPosition(Ia.x,Ia.y)):Ja&&Ja.fu.setPosition(0,0);if(a.match(/PLOT/)){0!==h||
a.match(/STACKED/)||(x.parentNode.removeChild(x),ta&&ta.parentNode.removeChild(ta),F&&F.parentNode.removeChild(F));var E=map.Scale.normalX(d)*(a.match(/LINES/),1),Y=k*E;this.nGridX&&(Y=a.match(/PLOTVAR/)?Math.floor(k%this.nGridX)*E:Math.floor(k/this.nGridX)*E);var oa=0,I=Tb||this.nMax,I=Math.max(wb,I),I=this.nMaxValuePlot="undefined"!==typeof this.nMaxValue?this.nMaxValue:I,oa=this.nMinValuePlot="undefined"!==typeof this.nMinValue?this.nMinValue:Math.min(this.nMin,Qc);"auto"==this.nMaxValue&&(I=this.nMaxValuePlot=
wb);if("inherit"==this.nMaxValue){this.nMaxValuePlot=this.nMinValuePlot=null;for(var wc=0;wc<this.parent.themesA.length;wc++)this.parent.themesA[wc]!=this&&this.parent.themesA[wc].nMaxValuePlot&&(I=this.parent.themesA[wc].nMaxValuePlot)}K=map.Scale.normalX(d)/(I-oa)*(this.nGridX||e.length-1)*(this.nRangeScale||1);if(!Hb){var Fd=this.szId+":"+this.itemA[b].szSelectionId+":chartgrid",ja=null;if(!ja||a.match(/ZOOM/))M=M||map.Dom.newGroup(c,this.szId+":"+b+":chartontop"),ja=map.Dom.newGroup(M,Fd)}if(a.match(/PLOTXY/))Hb||
(Hb=!0,a.match(/BOX/)&&a.match(/\bGRID\b/)&&!ja.childNodes.length&&(map.Dom.newShape("line",ja,0,0,this.nChartWidth+100,0,"stroke:#888888;stroke-width:"+map.Scale.normalX(.3)+";"),map.Dom.newShape("line",ja,0,0,0,-this.nChartHeight-100,"stroke:#888888;stroke-width:"+map.Scale.normalX(.3)+";"),map.Dom.newText(ja,10,80,"font-family:arial;font-size:80px;text-anchor:start;fill:#444444;stroke:none;pointer-events:none;",String(this.nMinX)),map.Dom.newText(ja,this.nChartWidth+100,80,"font-family:arial;font-size:80px;text-anchor:end;fill:#444444;stroke:none;pointer-events:none;",
String(this.nMaxX)),map.Dom.newText(ja,-10,10,"font-family:arial;font-size:80px;text-anchor:end;fill:#444444;stroke:none;pointer-events:none;",String(this.nMinY)),map.Dom.newText(ja,-10,-this.nChartHeight-100+80,"font-family:arial;font-size:80px;text-anchor:end;fill:#444444;stroke:none;pointer-events:none;",String(this.nMaxY)))),va=50+(this.itemA[b].nX-this.nMinX)*this.nChartWidth/this.nRangeX,Ua=-100-(this.itemA[b].nY-this.nMinY)*this.nChartHeight/this.nRangeY,x.fu.setPosition(va,Ua),ta&&ta.fu.setPosition(va,
Ua),sa&&sa.fu.setPosition(va,Ua),ab&&ab.fu.setPosition(va,Ua),F&&F.fu.setPosition(va,Ua);else if(a.match(/PLOTYX/))x.fu.setPosition((I+Math.abs(I-h))*K,Y),ta&&ta.fu.setPosition((I+Math.abs(I-h))*K,Y),F&&F.fu.setPosition((I+Math.abs(I-h))*K,Y);else if(a.match(/PLOTY/)){x.fu.setPosition(0,(-I+Math.abs(I-h))*K);ta&&ta.fu.setPosition(0,(-I+Math.abs(I-h))*K);F&&F.fu.setPosition(0,(-I+Math.abs(I-h))*K);var ga=1,ga=I/5,ga=10*Math.ceil(ga/(10*Math.floor(Math.log(ga))))*Math.floor(Math.log(ga))||1,I=Math.ceil(I/
ga)*ga;if(!Hb&&(Hb=!0,a.match(/BOX/)&&a.match(/\bGRID\b/)))for(W=map.Scale.normalX(d)/2;W<I*K;W+=K*ga)map.Dom.newShape("line",ja,-20,-W,20,-W,"stroke:#444444;stroke-width:"+map.Scale.normalX(1)+";")}else if(a.match(/PLOTX/)){if(x.fu.setPosition((I-Math.abs(I-h))*K,0),ta&&ta.fu.setPosition((I-Math.abs(I-h))*K,0),F&&F.fu.setPosition((I-Math.abs(I-h))*K,0),ga=1,ga=I/5,ga=10*Math.ceil(ga/(10*Math.floor(Math.log(ga))))*Math.floor(Math.log(ga))||1,I=Math.ceil(I/ga)*ga,!Hb&&(Hb=!0,a.match(/BOX/)&&a.match(/\bGRID\b/)))for(W=
map.Scale.normalX(d);W<I*K+map.Scale.normalX(d);W+=K*ga)map.Dom.newShape("line",ja,W,-20,W,20,"stroke:#444444;stroke-width:"+map.Scale.normalX(1)+";")}else{ga=1;ga=Math.ceil(I-oa)/5;.5>ga&&(ga=Math.ceil(I-oa)/10);if(1<ga)var qd=Math.pow(10,Math.floor(Math.log10(ga))),ga=Math.ceil(ga/qd)*qd||1;I=Math.ceil(I/ga)*ga;for(oa=Math.floor(oa/ga)*ga;5>(I-oa)/ga;)ga/=2;5<(I-oa)/ga&&(ga*=2);if(!Hb){Hb=!0;this.plot_last_last_position=[];this.plot_last_position=[];this.plot_last_value=[];this.plot_last_stacked_value=
[];this.plot_last_shape=[];this.plot_last_mean=[];this.plot_last_areaValue=[];this.plot_area_points=[];this.plot_area_shapes=[];this.plot_area_shapes[0]=map.Dom.newShape("path",t,"M0,0","fill:"+v+";fill-opacity:"+(this.fillOpacity||1)+";stroke:none");var Ab=e.length/(this.nGridX||1),qb=map.Scale.normalX(Math.max(e.length/(this.nGridX||1),3)),qb=qb*(a.match(/ZOOM/),1),xb=map.Dom.newGroup(t,"");xb.parentNode.insertBefore(xb,t.firstChild);if(a.match(/BOX/)&&a.match(/\bGRID\b/)&&!(!a.match(/ZOOM/)&&this.nBoxUpper&&
map.Scale.nTrueMapScale*map.Scale.nZoomScale>this.nBoxUpper)){if(!a.match(/ZOOM/)){var qc=-E/(a.match(/LINES/)?3:1),yb=E*(this.nGridX?e.length/this.nGridX-1:e.length-1);map.Dom.newShape("rect",t,0,-(I-oa)*K,yb,(I-oa)*K,"fill:#ffffff;fill-opacity:0;stroke:none;pointer-events:none")}for(var Yc=.8,Gd=0,W=0;W<=(I-oa)*K;W+=K*ga){var Hc=this.formatValue(Math.round(a.match(/INVERT/)?I-W/K+oa:100*(W/K+oa))/100,2);5<I&&(Hc=String(Math.round(a.match(/INVERT/)?I-W/K+oa:W/K+oa)));var rb=W;a.match(/LOG/)&&(rb=
100*Math.pow(10,Gd++),rb>I&&(W=I*K),Hc=this.formatValue(rb,0),rb=Math.log10(rb)*I/Math.ceil(Math.log10(I))*K);qc=-E/(a.match(/LINES/)?5:1);yb=E*(this.nGridX?e.length/this.nGridX-1:e.length-1);a.match(/PLOTVAR/)&&1<e.length/this.nGridX&&(yb=E*this.nGridX);if(a.match(/GRADIENT/)&&0!==W)var rd=yb+(a.match(/LINES/),0),O=map.Dom.newShape("path",t,"M0,"+-W+" L "+rd+","+-W+" "+rd+","+(-W+K*ga)+" 0,"+(-W+K*ga)+" z","fill:#d8d8dd;fill-opacity:"+Yc+";stroke:none;"),Yc=Yc-.3;rb===-oa*K?map.Dom.newShape("line",
ja,qc,-rb,yb,-rb,"stroke:#444444;stroke-opacity:1;stroke-width:"+map.Scale.normalX(.05*Ab)+";"):map.Dom.newShape("line",ja,qc,-rb,yb,-rb,"stroke:#888888;stroke-opacity:0.4;stroke-width:"+map.Scale.normalX(.05*Ab)+";stroke-dasharray:"+6*Ab+" "+3*Ab+";");a.match(/RIGHT/)?map.Dom.newText(ja,yb+map.Scale.normalX(15),-rb+.3*qb,"font-family:arial;font-size:"+qb+"px;text-anchor:start;fill:"+(a.match(/\bCOLOR\b/)?v:"#888888")+";stroke:none;pointer-events:none;",Hc):map.Dom.newText(ja,1.1*qc,-rb+.3*qb,"font-family:arial;font-size:"+
qb+"px;text-anchor:end;fill:"+(a.match(/\bCOLOR\b/)?v:"#888888")+";stroke:none;pointer-events:none;",Hc);this.nPlotHeight=W}a.match(/ZOOM/)&&(this.nLowValue&&(map.Dom.newShape("line",ja,qc,-(this.nLowValue-oa)*K,yb,-(this.nLowValue-oa)*K,"stroke:#dd0000;stroke-opacity:0.4;stroke-width:"+map.Scale.normalX(.1*Ab)+";stroke-dasharray:"+6*Ab+" "+3*Ab+";"),a.match(/ZOOM/)&&map.Dom.newText(ja,1.06*yb,-(this.nLowValue-oa)*K+.3*qb,"font-family:arial;font-size:"+qb+"px;text-anchor:end;fill:#888888;stroke:none;pointer-events:none;",
this.nLowValue)),this.nHighValue&&(map.Dom.newShape("line",ja,qc,-(this.nHighValue-oa)*K,yb,-(this.nHighValue-oa)*K,"stroke:#dd0000;stroke-opacity:0.4;stroke-width:"+map.Scale.normalX(.1*Ab)+";stroke-dasharray:"+6*Ab+" "+3*Ab+";"),a.match(/ZOOM/)&&map.Dom.newText(ja,1.06*yb,-(this.nHighValue-oa)*K+.3*qb,"font-family:arial;font-size:"+qb+"px;text-anchor:end;fill:#888888;stroke:none;pointer-events:none;",this.nHighValue)));map.Dom.newShape("line",ja,Y,0,Y,-(I-oa)*K,"stroke:#aaaaaa;stroke-width:"+map.Scale.normalX(.1)+
";");if(this.szXaxisA&&this.szXaxisA.length)for(W=0;W<this.szXaxisA.length;W++)if(this.szXaxisA[W].length&&" "!=this.szXaxisA[W]||0==W||W==this.szXaxisA.length-1)map.Dom.newShape("line",ja,E*W,100,E*W,-(I-oa)*K,"stroke:#888888;stroke-opacity:0.4;stroke-width:"+map.Scale.normalX(.05*this.szXaxisA.length)+";stroke-dasharray:"+6*this.szXaxisA.length+" "+3*this.szXaxisA.length+";"),map.Dom.newText(ja,E*W,1.5*qb,"font-family:arial;font-size:"+qb+"px;text-anchor:middle;fill:#888888;stroke:none;pointer-events:none;",
this.szXaxisA[W])}a.match(/NOCLIP/)||map.Dom.setClipRect(t,{x:-100,y:-(I-oa)*K,width:100+ca/(this.nGridX||1)*E,height:100+(I-oa)*K})}var Bb=this.nGridX?Math.floor(k/this.nGridX)+1:1,aa=this.nGridX?k%this.nGridX:1;a.match(/LOG/)&&h&&(h=Math.log10(h)*I/Math.ceil(Math.log10(I)));var wa=a.match(/INVERT/)?I-h:h,wa=wa-oa,wa=wa+(a.match(/STACKED/)?this.plot_last_stacked_value[Bb]||0:0);x.fu.setPosition(Y,-wa*K);ta&&ta.fu.setPosition(Y,-wa*K);if(F&&F.parentNode){if(10<this.nXLen){var sd=Math.floor(k/(this.nGridX||
1));0!=sd&&sd!=this.nXLen-1&&F.parentNode.removeChild(F)}F&&F.parentNode&&(a.match(/\bINLINETEXT\b/)?F.fu.setPosition(Y,-wa*K):a.match(/\bSTACKED\b/)?F.parentNode.removeChild(F):a.match(/LINES/)&&(null==this.nGridX||1>=this.nGridX)?(F.fu.setPosition(Y-map.Scale.normalX(d*this.nGridX||1),-wa*K),F.fu.scale(2.5,2.5)):(F.fu.scale(1.5*this.nValueScale,1.5*this.nValueScale),F.fu.setPosition(Y-map.Scale.normalX(d/7),-wa*K)))}if(a.match(/LINES/)){var O=null;if(a.match(/ZEROISVALUE/)&&!a.match(/ZEROISNOTVALUE/)&&
this.plot_last_position[aa]&&(h||this.plot_last_position[aa].y)||h&&this.plot_last_position[aa]&&this.plot_last_position[aa].y)if(a.match(/AREA/)){if(O=map.Dom.newShape("path",xb,"M"+(this.plot_last_position[aa].x-2)+","+this.plot_last_position[aa].y+"L"+Y+","+-wa*K+" "+Y+","+(-wa+h)*K+" "+(this.plot_last_position[aa].x-2)+","+((this.plot_last_last_position[aa-1]?this.plot_last_last_position[aa-1].y:0)+oa*K)+" z","fill:"+v+";fill-opacity:"+(this.fillOpacity||1)+";")){O.setAttributeNS(szMapNs,"value",
String(h));O.setAttributeNS(szMapNs,"class",String(Q%(this.nGridX||1E6)));var Zc=25>this.nXLen?this.formatValue(this.plot_last_areaValue[aa],this.nValueDecimals||2)+" ... "+this.formatValue(h,this.nValueDecimals||2):this.formatValue(h,this.nValueDecimals||2);O.setAttributeNS(szMapNs,"tooltip",Zc+this.szUnit+" "+(this.szLabelA?this.szLabelA[J%(this.nGridX||1E6)]:""));O.setAttributeNS(szMapNs,"time",String(U));if(this.szFlag.match(/\bFADE\b/)){var td="Gradient"+Math.random(),ud=map.Dom.constructNode("linearGradient",
t,{id:td,gradientTransform:"rotate(90)"});map.Dom.constructNode("stop",ud,{offset:"0","stop-color":v,"stop-opacity":"1"});map.Dom.constructNode("stop",ud,{offset:"1","stop-color":v,"stop-opacity":"0.1"});O.style.setProperty("fill","url(#"+td+")")}}var Hd=1==k||k==ca-1||2==Bb||Bb==ca/(this.nGridX||1)?"but":"round";if(O=map.Dom.newShape("line",xb,this.plot_last_position[aa].x,this.plot_last_position[aa].y,Y,-wa*K,"stroke:"+v+";stroke-width:"+map.Scale.normalX(a.match(/STACKED/)?1:this.nLineWidth||3)+
";stroke-linecap:"+Hd+";"))O.setAttributeNS(szMapNs,"value",String(h)),O.setAttributeNS(szMapNs,"tooltip",this.formatValue(h,this.nValueDecimals||2)+this.szUnit+" "+(this.szLabelA?this.szLabelA[Q%(this.nGridX||1E6)]:""))}else{O=map.Dom.newShape("line",xb,this.plot_last_position[aa].x,this.plot_last_position[aa].y,Y,-wa*K,"stroke:"+(this.szLineColor||v)+";stroke-width:"+map.Scale.normalX(this.nLineWidth||3)+";stroke-linecap:round;");Zc=25>this.nXLen?this.formatValue(this.plot_last_areaValue[aa],this.nValueDecimals||
2)+" ... "+this.formatValue(h,this.nValueDecimals||2):this.formatValue(h,this.nValueDecimals||2);O&&(O.setAttributeNS(szMapNs,"value",String(h)),O.setAttributeNS(szMapNs,"class",String(Q%(this.nGridX||1E6))),O.setAttributeNS(szMapNs,"tooltip",Zc+this.szUnit+" "+(this.szLabelA?this.szLabelA[Q%(this.nGridX||1E6)]:"")),O.setAttributeNS(szMapNs,"time",String(U)));try{t.insertBefore(O,this.plot_last_shape[aa])}catch(Rd){}}a.match(/LOLLIPOP/)&&h&&(O=map.Dom.newShape("line",xb,Y,oa*K,Y,-wa*K,"stroke:"+v+
";stroke-width:"+map.Scale.normalX(3)+";stroke-linecap:butt;"))&&(O.setAttributeNS(szMapNs,"value",String(h)),O.setAttributeNS(szMapNs,"class",String(Q%(this.nGridX||1E6))),O.setAttributeNS(szMapNs,"time",String(U)));a.match(/LASTPOP/)&&h&&k>=ca-(this.nGridX||1)&&(O=map.Dom.newShape("circle",xb,Y,-wa*K,map.Scale.normalX((this.nLineWidth||5)*(this.nMarkerSize||1.5)),"fill:"+v+";stroke:"+A+";stroke-width:"+B+";"))&&(O.setAttributeNS(szMapNs,"value",String(h)),O.setAttributeNS(szMapNs,"time",String(U)));
if(O&&this.szFlag.match(/\bLASTARROW\b/)&&k>=ca-(this.nGridX||1)){var vd="ArrowMarker"+Math.random(),Id=map.Dom.newNode("defs",xb),ic=Math.min(5,2.5+100/((this.nLineWidth||1)/this.nChartGroupScale))*(this.nMarkerSize||3),Jd=map.Dom.constructNode("marker",Id,{id:vd,markerWidth:ic,markerHeight:ic,refX:ic/1.7,refY:ic/2,orient:"auto",markerUnits:"strokeWidth"});map.Dom.constructNode("path",Jd,{d:"M0,"+ic+" L"+ic+","+ic/2+" L0,0 Z",style:"fill:"+v+";opacity:1;stroke:none;stroke-width:0.03"});O.setAttributeNS(null,
"marker-end","url(#"+vd+")")}a.match(/\bLASTVALUE\b/)&&!a.match(/\bZOOM\b/)&&h&&k>=ca-(this.nGridX||1)&&(F=this.createTextLabel(SVGDocument,t,"",h,3/this.nScale*this.nValueScale,"","rgba(255,255,255,0)",this.szTextColor||"#444444","GLOW"),F.fu.setPosition(Y-2E3,-wa*K-1E3));if(a.match(/PLOTVAR/)){var La=a.match(/MEDIAN/)?this.nMedianA[J]:this.nMeanA[J],La=La-oa;this.plot_last_mean[aa]&&((O=map.Dom.newShape("path",ja,"M"+this.plot_last_mean[aa].x+","+(this.plot_last_mean[aa].y-this.nDeviationA[J-1]*
K)+" L "+Y+","+(-La-this.nDeviationA[J])*K+" "+Y+","+(-La+this.nDeviationA[J])*K+" "+this.plot_last_mean[aa].x+","+(this.plot_last_mean[aa].y+this.nDeviationA[J-1]*K)+" z","fill:#d8d8dd;fill-opacity:0.2;stroke:none;"))&&O.setAttributeNS(szMapNs,"tooltip","standard deviation"),(O=map.Dom.newShape("line",t,this.plot_last_mean[aa].x,this.plot_last_mean[aa].y,Y,-La*K,"stroke:#888888;stroke-width:"+map.Scale.normalX(2)+";stroke-linecap:round;stroke-dasharray:10 80;"))&&O.setAttributeNS(szMapNs,"tooltip",
"mean"));this.plot_last_mean[aa]=new point(Y,-La*K)}this.plot_last_last_position[aa]=a.match(/STACKED/)?this.plot_last_position[aa]||new point(0,0):new point(0,0);this.plot_last_position[aa]=0<=wa?new point(Y,-wa*K):new point(Y,0);this.plot_last_shape[aa]=x;this.plot_last_areaValue[aa]=h;this.plot_area_points.push(new point(Y,-wa*K))}else if(a.match(/LOLLIPOP/)&&h){if(O=map.Dom.newShape("line",xb,Y,oa*K,Y,-wa*K,"stroke:"+v+";stroke-width:"+map.Scale.normalX(3)+";stroke-linecap:butt;"))O.setAttributeNS(szMapNs,
"value",String(h)),O.setAttributeNS(szMapNs,"class",String(Q%(this.nGridX||1E6))),O.setAttributeNS(szMapNs,"time",String(U))}else if(a.match(/LASTPOP/)&&h){if(O=map.Dom.newShape("line",xb,Y,0,Y,-wa*K,"stroke:"+v+";stroke-width:"+map.Scale.normalX(3)+";stroke-linecap:round;"))O.setAttributeNS(szMapNs,"value",String(h)),O.setAttributeNS(szMapNs,"class",String(Q%(this.nGridX||1E6))),O.setAttributeNS(szMapNs,"time",String(U))}else if(1<e.length/this.nGridX)if(a.match(/PLOTVAR/)){x.style.setProperty("fill-opacity",
Bb==e.length/this.nGridX?"1":"0.2","");x.style.setProperty("stroke-width",Bb==e.length/this.nGridX?"0":"3","");O=null;if(this.plot_last_position[aa])if(a.match(/PLOTVAR/)){if(O=map.Dom.newShape("line",t,this.plot_last_position[aa].x,this.plot_last_position[aa].y,Y,-wa*K,"stroke:"+v+";stroke-width:"+map.Scale.normalX(2)+";"))O.setAttributeNS(szMapNs,"value",String(h)),O.setAttributeNS(szMapNs,"class",String(Q%(this.nGridX||1E6))),O.setAttributeNS(szMapNs,"time",String(U)),O.parentNode.insertBefore(O,
O.parentNode.firstChild);if(O=map.Dom.newShape("line",t,this.plot_last_position[aa].x-40,this.plot_last_position[aa].y,this.plot_last_position[aa].x+40,this.plot_last_position[aa].y,"stroke:"+v+";stroke-width:"+map.Scale.normalX(this.nLineWidth||3)+";"))O.setAttributeNS(szMapNs,"value",String(h)),O.setAttributeNS(szMapNs,"class",String(Q%(this.nGridX||1E6))),O.setAttributeNS(szMapNs,"time",String(U)),O.parentNode.insertBefore(O,O.parentNode.firstChild);if(O=map.Dom.newShape("line",t,Y,0,Y,-this.nPlotHeight,
"stroke:#dddddd;stroke-width:"+map.Scale.normalX(.25)+";"))O.setAttributeNS(szMapNs,"value",String(h)),O.setAttributeNS(szMapNs,"class",String(Q%(this.nGridX||1E6))),O.setAttributeNS(szMapNs,"time",String(U)),O.parentNode.insertBefore(O,O.parentNode.firstChild)}else if(O=map.Dom.newShape("line",t,this.plot_last_position[aa].x,this.plot_last_position[aa].y,Y,-wa*K,"stroke:"+v+";stroke-width:"+map.Scale.normalX(this.nLineWidth||3)+";"))O.setAttributeNS(szMapNs,"value",String(h)),O.setAttributeNS(szMapNs,
"class",String(Q%(this.nGridX||1E6))),O.setAttributeNS(szMapNs,"time",String(U)),t.insertBefore(O,this.plot_last_shape[aa]);this.plot_last_last_position[aa]=this.plot_last_position[aa]||new point(0,0);this.plot_last_position[aa]=new point(Y,-wa*K);this.plot_last_shape[aa]=x}else a.match(/BOX/)&&map.Dom.newShape("line",ja,Y,0,Y,-this.nPlotHeight,"stroke:#dddddd;stroke-width:"+map.Scale.normalX(.25)+";");else if(a.match(/PLOTVAR/)){O=null;La=a.match(/MEDIAN/)?this.nMedianA[J]:this.nMeanA[J];La-=oa;
if(O=map.Dom.newShape("line",ja,Y,-(La-this.nDeviationA[J])*K,Y,-(La+this.nDeviationA[J])*K,"stroke:#444444;stroke-width:"+map.Scale.normalX(1)+";"))O.setAttributeNS(szMapNs,"value",String(h)),O.setAttributeNS(szMapNs,"class",String(Q%(this.nGridX||1E6))),O.setAttributeNS(szMapNs,"time",String(U));if(O=map.Dom.newShape("line",ja,Y-40,-La*K,Y+40,-La*K,"stroke:#444444;stroke-width:"+map.Scale.normalX(2)+";"))O.setAttributeNS(szMapNs,"value",String(h)),O.setAttributeNS(szMapNs,"class",String(Q%(this.nGridX||
1E6))),O.setAttributeNS(szMapNs,"time",String(U));if(O=map.Dom.newShape("line",ja,Y-80,-(La-this.nDeviationA[J])*K,Y+80,-(La-this.nDeviationA[J])*K,"stroke:#444444;stroke-width:"+map.Scale.normalX(1)+";"))O.setAttributeNS(szMapNs,"value",String(h)),O.setAttributeNS(szMapNs,"class",String(Q%(this.nGridX||1E6))),O.setAttributeNS(szMapNs,"time",String(U));if(O=map.Dom.newShape("line",ja,Y-80,-(La+this.nDeviationA[J])*K,Y+80,-(La+this.nDeviationA[J])*K,"stroke:#444444;stroke-width:"+map.Scale.normalX(1)+
";"))O.setAttributeNS(szMapNs,"value",String(h)),O.setAttributeNS(szMapNs,"class",String(Q%(this.nGridX||1E6))),O.setAttributeNS(szMapNs,"time",String(U));map.Dom.newShape("line",ja,Y,0,Y,-this.nPlotHeight,"stroke:#dddddd;stroke-width:"+map.Scale.normalX(.25)+";");this.plot_last_position[aa]&&(O=map.Dom.newShape("line",ja,this.plot_last_position[aa].x,this.plot_last_position[aa].y,Y,-La*K,"stroke:#888888;stroke-width:"+map.Scale.normalX(1)+";"));this.plot_last_last_position[aa]=this.plot_last_position[aa]||
new point(0,0);this.plot_last_position[aa]=new point(Y,-La*K)}else a.match(/BOX/)&&map.Dom.newShape("line",ja,Y,0,Y,-this.nPlotHeight,"stroke:#aaaaaa;stroke-width:"+map.Scale.normalX(.25)+";");this.plot_last_value[Bb]=h;this.plot_last_stacked_value[Bb]=wa}Na=0}else"label"==Z&&(Na-=Tc/1.95),x.fu.setPosition(map.Scale.normalX(0)+lb,map.Scale.normalY(0)+Na),ta&&ta.fu.setPosition(map.Scale.normalX(0)+lb,map.Scale.normalY(0)+Na),F&&F.fu.setPosition(lb,map.Scale.normalY(0)+Na),Na="label"==Z?Na-Tc/1.95:
Na-m}}}else{var Z="";if(this.nRangesA&&this.nRangesA.length)for(ea=0;ea<this.nRangesA.length;ea++)if(h==this.nRangesA[ea]||Number(h)==Number(this.nRangesA[ea])){Z=this.szSymbolsA[ea]||this.szSymbolsA[0]||"circle";Q=ea;break}Z=this.itemA[b].szSymbol||Z;db=String(h);V=String(h);this.szLabelA&&this.szLabelA[Q]&&(db=this.szLabelA[Q],V=this.szLabelA[Q]);Z.length||0!==J||(Z="empty",db=V="no data",Q=0);if(Z.length){jd++;x=null;Q="undefined"!=typeof this.itemA[b].nClass?this.itemA[b].nClass:Q;v="undefined"!=
typeof this.itemA[b].szColor?this.itemA[b].szColor:this.colorScheme[Q];if(a.match(/NOLINES/))A="none";else if(A=this.itemA[b].szColor||this.colorScheme[Q],"white"==v||"#ffffff"==v)A="gray";A=this.szLineColor||A;m=map.Scale.normalX(d/2);a.match(/FIXSIZE/)?m=map.Scale.normalX(d/2)/(this.nNormalSizeValue||1):a.match(/NOSIZE/)?m=map.Scale.normalX(d/2):b&&this.itemA[b]&&this.itemA[b].nSize&&(m=m/Math.pow(this.nNormalSizeValue||this.nMaxSize,1/this.nSizePow)*Math.pow(this.itemA[b].nSize,1/this.nSizePow));
if("circle"==Z||"square"==Z||"roundrect"==Z||"label"==Z||"carot"==Z||"diamond"==Z||"triangle"==Z||"hexagon"==Z||"cross"==Z||"empty"==Z){y=map.Scale.normalX(d/2);B=(this.nLineWidth||1)*map.Scale.normalX(Math.min(m/y,1));switch(Z){case "empty":x=map.Dom.newShape("circle",t,0,0,m,"fill:#888888;fill-opacity:0;stroke:#888888;stroke-width:"+B+";");break;case "circle":x=map.Dom.newShape("circle",t,0,0,m,"fill:"+v+";stroke:"+A+";stroke-width:"+B+";");break;case "square":x=map.Dom.newShape("rect",t,.8*-m,
.8*-m,1.6*m,1.6*m,"fill:"+v+";stroke:"+A+";stroke-width:"+B+";");break;case "roundrect":x=map.Dom.newShape("rect",t,.8*-m,.8*-m,1.6*m,1.6*m,"fill:"+v+";stroke:"+A+";stroke-width:"+B+";");x.setAttributeNS(null,"rx",.3*m);break;case "cross":var Za=.4*m,Ka=.8*m,x=map.Dom.newShape("path",t,"M 0,-"+(Ka+Za/2)+" l"+Za/2+",0 0,"+Ka+" "+Ka+",0 0,"+Za+" -"+Ka+",0 0,"+Ka+" -"+Za+",0 0,-"+Ka+" -"+Ka+",0 0,-"+Za+" "+Ka+",0 0,-"+Ka+" "+Za/2+",0 z","fill:"+v+";stroke:"+A+";stroke-width:"+B+";");break;case "diamond":case "carot":(x=
map.Dom.newShape("rect",t,.8*-m,.8*-m,1.6*m,1.6*m,"fill:"+v+";stroke:"+A+";stroke-width:"+B+";"))&&x.setAttributeNS(null,"transform","rotate(45)");break;case "triangle":x=map.Dom.newShape("path",t,"M 0,"+m+" l"+1.2*m+",-"+2*m+" -"+2.4*m+",0 "+1.2*m+","+2*m+"z","fill:"+v+";stroke:"+A+";stroke-width:"+B+";");break;case "hexagon":var Za=m/2,Ka=m*Math.sin(60/180*Math.PI),vc=m,x=map.Dom.newShape("path",t,"M -"+m+",0 l "+Za+",-"+Ka+" "+vc+",0 "+Za+","+Ka+" -"+Za+","+Ka+" -"+vc+",0 -"+Za+",-"+Ka+" z","fill:"+
v+";stroke:"+A+";stroke-width:"+B+";");break;case "label":var Tc=.8*m,x=map.Dom.newShape("rect",t,.8*-m,.4*-m,1.6*m,.8*m,"fill:"+v+";stroke:"+A+";stroke-width:"+B+";")}if(!x)continue;if(a.match(/HORZ/)){a.match(/LEFT/)&&(J=-J);a.match(/VALUES/)&&(w=__maptheme_getChartColors(v),A=w.textColor,F=map.Dom.newText(la,0,0,"font-family:"+(this.szTextFont||"arial")+";font-size:"+String(m/2)+"px;text-anchor:start;baseline-shift:-90%;fill:#bbbbbb;stroke:none;pointer-events:none",V),F.fu.setPosition(J*m*2,-m-
map.Scale.normalX(5)),1<e.length&&setRotate(F,-45));if(a.match(/AXIS/)&&this.szXaxisA&&(!this.fHideValues||a.match(/ZOOM/))){var w=__maptheme_getChartColors(v),A=w.textColor,Ic=this.szXaxisA[k],F=map.Dom.newText(la,0,0,"font-family:"+(this.szTextFont||"arial")+";font-size:"+String(m)+"px;text-anchor:start;baseline-shift:-90%;fill:#bbbbbb;stroke:none;pointer-events:none",Ic);F.fu.setPosition(J*m*2+map.Scale.normalX(2),m+map.Scale.normalX(1));1<e.length&&setRotate(F,45)}x.setAttributeNS(szMapNs,"tooltip",
db);x.fu.setPosition(J*m*2,0);a.match(/LEFT/)&&(J=-J)}else{if(a.match(/VALUES/)&&(!this.fHideValues||a.match(/ZOOM/))){var w=__maptheme_getChartColors(v),za=this.szValueColor||this.szTextColor||w.textColor,Uc=Math.max((Ha.length||0)+1,ld.length);a.match(/INLINETEXT/)?(R=this.formatValue(Ha,this.nValueDecimals||(1>Ha||1>=I?1:0),"ROUND")+(5>=this.szUnit.length?this.szUnit:""),P=String(Math.min(1*y,("hexagon"==Z?2.7:3.2)/Uc*y)),P=m/y*P*this.nValueScale,F=map.Dom.newText(t,0,.33*P,"font-family:"+(this.szTextFont||
"arial")+";font-size:"+P+"px;text-anchor:middle;fill:"+za+";stroke:none;pointer-events:none",R)):(w=__maptheme_getChartColors(v),A=w.textColor,R=this.formatValue(Ha,this.nValueDecimals||(1>Ha||1>=I?1:0),"ROUND")+(5>=this.szUnit.length?this.szUnit:""),F=map.Dom.newText(la,0,0,"font-family:"+(this.szTextFont||"arial")+";font-size:"+String(m/2*this.nValueScale)+"px;text-anchor:start;baseline-shift:-45%;fill:#bbbbbb;stroke:none;pointer-events:none",R),F.fu.setPosition(m+map.Scale.normalX(3),-J*(2*m-map.Scale.normalY(0))))}x.setAttributeNS(szMapNs,
"tooltip",db);x.fu.setPosition(0,-J*(2*m-map.Scale.normalY(0)))}a.match(/OUTLINE/)?(x.style.setProperty("stroke-width",String(map.Scale.normalX(.5))),x.style.setProperty("stroke-opacity","1"),x.style.setProperty("fill-opacity","0.7")):a.match(/DOPACITY/)&&this.szAlphaField?b&&"undefined"!=typeof this.itemA[b].nAlpha&&(N=1/(this.nDopacityPow||1),qa=(this.nDopacityScale||1)/Math.pow(this.nMaxAlpha,N)*Math.pow(this.itemA[b].nAlpha,N),x.style.setProperty("fill-opacity",String(qa),"")):x.style.setProperty("fill-opacity",
String(this.fillOpacity?this.fillOpacity:this.nOpacity?this.nOpacity:1),"")}else{Z.match(/.svg|.png|.jpeg/)?(x=map.Dom.constructNode("image",t,{"xlink:href":Z}),x.setAttributeNS(null,"x",String(map.Scale.normalX(-d/2))),x.setAttributeNS(null,"y",String(map.Scale.normalY(-d))),x.setAttributeNS(null,"width",String(map.Scale.normalX(d))),x.setAttributeNS(null,"height",String(map.Scale.normalY(d)))):x=map.Dom.constructNode("use",t,{"xlink:href":"#"+Z+":antizoomandpan"});x.setAttributeNS(null,"style",
"fill:"+v+";stroke:"+A);if(this.szSizeField&&b&&this.itemA[b]){var K=1/Math.sqrt(this.nMaxSize)*Math.sqrt(this.itemA[b].nSize);x.fu.scale(K,K)}x.fu.scale(m/d,m/d);x.fu.setPosition(map.Scale.normalX(0)+J*map.Scale.normalX(20),map.Scale.normalY(0));0<J&&(map.Dom.newText(t,map.Scale.normalX(-9)+J*map.Scale.normalX(20),0,"font-family:"+(this.szTextFont||"arial")+";font-size:360px;text-anchor:middle;baseline-shift:-50%;fill:none;stroke:black;stroke-width:60;pointer-events:none;opacity:0.3;","+"),map.Dom.newText(t,
map.Scale.normalX(-9)+J*map.Scale.normalX(20),0,"font-family:"+(this.szTextFont||"arial")+";font-size:360px;text-anchor:middle;baseline-shift:-50%;fill:white;stroke:none;pointer-events:none;opacity:0.8;","+"));a.match(/VALUES/)&&(w=__maptheme_getChartColors(v),A=w.textColor,F=map.Dom.newText(la,0,0,"font-family:"+(this.szTextFont||"arial")+";font-size:"+String(m/2)+"px;text-anchor:start;baseline-shift:-45%;fill:#bbbbbb;stroke:none;pointer-events:none",V),F.fu.setPosition(m/2+map.Scale.normalX(3),
2*-J*m),a.match(/MULTILINE/)&&this.szSizeField&&b&&this.itemA[b]&&(F=map.Dom.newText(la,0,0,"font-family:"+(this.szTextFont||"arial")+";font-size:"+String(m/2)+"px;text-anchor:start;baseline-shift:-45%;fill:#bbbbbb;stroke:none;pointer-events:none",String(this.itemA[b].nSize)+this.szSizeValueUnits),F.fu.setPosition(m/2+map.Scale.normalX(3),2*-J*m+m/2)))}x.setAttributeNS(szMapNs,"value",String(h));x.setAttributeNS(szMapNs,"class",String(Q));x.setAttributeNS(szMapNs,"time",String(U));this.nRealizedCount++}else this.nMissingRangeCount++}}}la&&
la.parentNode&&la.parentNode.appendChild(la);fc&&fc.parentNode&&fc.parentNode.appendChild(fc);Sb&&Sb.parentNode&&Sb.parentNode.appendChild(Sb);gc&&gc.parentNode&&gc.parentNode.appendChild(gc);if(0&a.match(/AREA/)&&!this.nGridX&&this.plot_area_points&&this.plot_area_points.length){for(var wd=!0,$c=this.plot_area_points.length,C=0;C<$c;C++)0===this.plot_area_points[C].y&&(wd=!1);if(wd||a.match(/ZEROISVALUE/)){for(var Ib="M"+this.plot_area_points[0].x+","+this.plot_area_points[0].y+" L ",C=1;C<$c;C++)Ib+=
this.plot_area_points[C].x+","+this.plot_area_points[C].y+" ";Ib+=this.plot_area_points[$c-1].x+",0 ";Ib+="0,0 ";Ib+="z ";this.plot_area_shapes[0].setAttributeNS(null,"d",Ib)}}if(a.match(/\bLINREG\b/)){var Jb=0,Kb=e.length-1,jc=Rb*Jb+Dc,rc=Rb*Kb+Dc,A=this.szLineColorA?this.szLineColorA[0]:this.chart.szColor;map.Dom.newShape("line",xb,Jb*E,-jc*K,Kb*E,-rc*K,"stroke:"+A+";stroke-width:50;stroke-dasharray:50 50").setAttributeNS(szMapNs,"tooltip","linerar regression")}if("undefined"!=typeof this.szSymbolBoxStyle){var xd=
map.Dom.getBox(t);zb.setAttributeNS(null,"x",-map.Scale.normalX(15));zb.setAttributeNS(null,"y",-map.Scale.normalY(15));zb.setAttributeNS(null,"width",map.Scale.normalX(30*jd));zb.setAttributeNS(null,"height",map.Scale.normalY(30));zb.setAttributeNS(null,"fill-opacity",1)}p.x=map.Scale.normalY(0);p.y=map.Scale.normalY(a.match(/ZOOM/)||a.match(/MENUSIZE/)?20:m/map.Scale.normalY(1)+5)}else if(a.match(/BUFFER/)){I=this.nMaxA[0];h=e[0];m=this.nBufferSize?this.nBufferSize:1E3;this.szShapeType.match(/line/)&&
(m*=this.nScale);m=map.Scale.getDeltaXofDistanceInMeter(m);v=this.colorScheme[0];if(this.szFields&&this.szFields.length&&this.nRangesA&&this.nRangesA.length&&(v=null,this.nRangesA.length==this.colorScheme.length))for(k=0;k<this.nRangesA.length;k++)if(h==this.nRangesA[k]||Number(h)==Number(this.nRangesA[k])){v=this.colorScheme[k];w=__maptheme_getChartColors(v);A="undefined"!=typeof this.szBorderColor?this.szBorderColor:.8>this.fillOpacity?"#888888":w.textColor;break}if(this.szShapeType.match(/dummy||point/))if(v){d=
2*m/map.Scale.normalX(1);p.x=0;p.y=m+map.Scale.normalY(5);this.szFlag.match(/OVERLAY/);x=map.Dom.newShape("circle",t,0,0,m,"");if(this.szFlag.match(/VALUE/))var Vb="font-family:arial;font-size:"+map.Scale.normalX(30)+"px;fill:#222222;fill-opacity:1;stroke:white;stroke-opacity:0.2;stroke-dasharray:none;pointer-events:none;",F=map.Dom.newText(t,m-map.Scale.normalX(20),0,Vb,Map.Scale.prototype.formatDistanceString(this.nBufferSize));this.nRealizedCount++}else return new point(0,0);if(this.szShapeType.match(/line/)){var Jc=
SVGDocument.getElementById(b),ad=Jc.getAttributeNS(null,"id");if(!ad.match(":paint")){var xc=SVGDocument.getElementById(ad+":paint");xc||(xc=Jc.cloneNode(1E3),t.appendChild(xc),xc.setAttributeNS(null,"id",ad+":paint"));Jc=xc;this.nRealizedCount++}var Kd=2*m/map.Scale.normalX(1);Jc.setAttributeNS(null,"style","fill:none;stroke:"+v+";stroke-linejoin:round;stroke-linecap:round;stroke-width:"+map.Scale.normalX(Kd)*map.Scale.nZoomScale+";stroke-opacity:"+String(this.fillOpacity?this.fillOpacity:this.nOpacity?
this.nOpacity:0)+"");return null}}else if(a.match(/BAR/)||a.match(/BARS/)){var T=0,xa=0,Ld=d,$a=1,na=0,u=1,pa=this.nMax-this.nMin,ac=this.nMax100-this.nMin100;this.nNormalSizeValue&&(pa=ac=this.nMaxSize=this.nNormalSizeValue);if(a.match(/SIZE/)&&!a.match(/NORMSIZE/)&&this.szSizeField&&b&&this.itemA[b])$a=a.match(/SIZELOG/)?1/Math.max(1,Math.log(this.nMaxSize)*Math.log(this.itemA[b].nSize)):a.match(/SIZEP4/)?1/Math.pow(this.nMaxSize,.25)*Math.pow(this.itemA[b].nSize,.25):a.match(/3D/)||a.match(/SIZEP3/)||
a.match(/SIZEVOLUME/)?1/Math.pow(this.nMaxSize,1/3)*Math.pow(this.itemA[b].nSize,1/3):1/Math.sqrt(this.nMaxSize)*Math.sqrt(this.itemA[b].nSize);else if(a.match(/SIZE/)&&!a.match(/NORMSIZE/)){var kc=n;a.match(/POINTER/)&&(kc/=e.length);$a=a.match(/SIZELOG/)?1/Math.max(1,Math.log(pa)*Math.log(Math.abs(kc))):a.match(/SIZEP4/)?1/Math.pow(pa,.25)*Math.pow(Math.abs(kc),.25):a.match(/3D/)||a.match(/SIZEP3/)||a.match(/SIZEVOLUME/)?1/Math.pow(pa,1/3)*Math.pow(Math.abs(kc),1/3):1/Math.pow(pa,.5)*Math.pow(Math.abs(kc),
.5)}0===$a&&0!==n&&($a=30/d);d*=$a;var z=map.Scale.normalX(d/e.length*.66);a.match(/STACKED/)&&(z=map.Scale.normalX(d/3),this.nGridX&&!a.match(/MULTI/)&&(z/=2));a.match(/MENUSIZE/)&&1==e.length&&(z=map.Scale.normalX(d/2));S=z<map.Scale.normalX(5)?4*z/5:5*z/5;Ba=1;a.match(/COLUMN/)&&(z*=a.match(/THICK/)?2:a.match(/THIN/)?1:1.5);a.match(/THIN/)&&(z*=.6,S*=.75);a.match(/THICK/)&&(z*=1.5,S*=1.5);a.match(/STACKED/)?S=map.Scale.normalX(5):(a.match(/ZOOM/)||a.match(/NORMSIZE/))&&1==e.length&&(S*=2.5);a.match(/STACKED/)&&
!a.match(/ZOOM/)&&(S*=$a);S*=this.nValueScale||1;Vb="font-family:arial;font-size:"+.95*S+"px;fill:#606060;pointer-events:none;";Vb=map.Scale.tStyle.Values.szStyle+"font-size:"+.95*S+"px";a.match(/NORMSIZE/)||a.match(/MENUSIZE/)||this.szFlag.match(/NORMSIZE/)||this.szFlag.match(/MENUSIZE/)||!this.nNormalSizeValue||this.szField100&&!a.match(/POINTER/)||(l=this.nNormalSizeValue);this.nOverrideMax&&(l=this.nOverrideMax);E=map.Scale.normalX(Ld)/l;if(a.match(/OFFSETMEAN/)||a.match(/OFFSETMEDIAN/)||a.match(/DEVIATION/))E=
map.Scale.normalX(d)/300;a.match(/SIZE/)&&a.match(/SEQUENCE/)&&b&&1<e.length&&!this.szSizeField&&!this.szField100?E=E*e.length/$a:a.match(/SIZE/)&&b&&1<e.length&&!a.match(/EXPAND/)&&(E=this.szField100||a.match(/POINTER/)?E*$a:E/(a.match(/SIZEP4/)?$a*$a:$a));this.nRangeScale&&(E*=this.nRangeScale);a.match(/COMPRESSMAX/)?E/=4:a.match(/COMPRESSMORE/)?E/=3:a.match(/COMPRESS/)?E/=2:a.match(/EXPANDMAX/)?E*=4:a.match(/EXPANDMORE/)?E*=3:a.match(/EXPAND/)&&(E*=2);a.match(/POINTER/)&&!a.match(/NORMSIZE/)&&
(E*=1.2);var bd=map.Dom.newGroup(t,"");if(a.match(/\bSORT\b/)){this.sortedIndex=[];for(k=0;k<e.length;k++)this.sortedIndex[k]={index:k,value:e[k]};this.sortedIndex.sort(a.match(/STACKED/)?this.sortIndexUp:this.sortIndexDown)}else this.sortedIndex=null;pb=0;a.match(/\bUP\b/)&&(pb=e.length-1);var ma=1;a.match(/CENTER/)&&(ma=2);for(var lc=new point(0,0),Kc=null,Cb=null,Lb=null,Mb=null,eb=null,cd=null,Lc=kc=0,Q=null,Md=E,k=this.nClipParts&&this.nClipParts<e.length?e.length-this.nClipParts:0;k<e.length;k++){if(this.szShowParts){uc=
!0;for(C in this.szShowPartsA)this.szShowPartsA[C]==k&&(uc=!1);if(uc)continue}E=Md;J=Math.abs(pb-k);this.sortedIndex&&(J=this.sortedIndex[J].index);h=e[J];this.szFlag.match(/\bCLIP\b/)&&!this.szFlag.match(/MORPH/)&&this.nClipFrames&&(h=this.nClipFrames==e.length?Number(e[this.nActualFrame]):e[0]*(this.nClipFrames-1-this.nActualFrame)/(this.nClipFrames-1)+e[e.length-1]*this.nActualFrame/(this.nClipFrames-1),J=this.nActualFrame,k=e.length);var ib=h;a.match(/INVERT/)&&(0!==h||a.match(/ZEROISVALUE/))&&
(h=this.nMax-h);Ya=this.formatValue(h,this.nValueDecimals||2);a.match(/OFFSETMEAN/)||a.match(/OFFSETMEDIAN/)?(a.match(/OFFSETMEAN/)&&(h*=100/this.nMeanA[J]),a.match(/OFFSETMEDIAN/)&&(h*=100/this.nMedianA[J]),h-=100,ib=h=isFinite(h)&&!isNaN(h)?h:0,l=100,Ya=this.formatValue(h,this.nValueDecimals||2),0<h&&(Ya="+"+Ya)):a.match(/DEVIATION/)&&(h=(h-this.nMeanA[J])/this.nDeviationA[J],ib=h=isFinite(h)&&!isNaN(h)?h:0,h*=100,Ya=this.formatValue(h,this.nValueDecimals||2),0<h&&(Ya="+"+Ya));var ya=this.colorScheme[J]||
this.colorScheme[J%(this.nGridX||1E6)],Q=J%(this.nGridX||1E6);if((a.match(/SEQUENCE|CLIP/)||1==e.length)&&2<=this.colorScheme.length)for(ya=this.colorScheme[this.partsA.length-1],ea=0;ea<this.partsA.length;ea++)if(h<this.partsA[ea].max){ya=this.colorScheme[ea];Q=ea;break}a.match(/LEFT/)&&a.match(/HORZ/)&&(h=-h);0>h&&!a.match(/STACKED/)&&(xa=-h*E,h=-h);a.match(/VOLUME/)&&a.match(/3D/)?(E=1,h=this.szSizeField&&b?z=map.Scale.normalX(d/3*2)*Math.pow(1/this.nMaxSize*this.itemA[b].nSize,1/3):z=map.Scale.normalX(d/
3*2)*Math.pow(1/l*h,1/3)):(a.match(/POINTER/)&&a.match(/SIZE/)&&b&&(z=a.match(/WIDTH/)&&g&&(!(a.match(/DIFFERENCE/)||a.match(/RELATIVE/)||a.match(/FRACTION/))||a.match(/OFFSETMEAN/)||a.match(/OFFSETMEDIAN/)||a.match(/DEVIATION/))?map.Scale.normalX(d)*Math.pow(Math.abs(1/this.nMax100*g),.5):map.Scale.normalX(d)*Math.pow(Math.abs(1/l*h),1/3),S=.6*z,this.nValueSizeMin&&!a.match(/ZOOM/)&&(S=S*map.Layer.nDynamicObjectScale>map.Scale.normalX(this.nValueSizeMin)?S:0),a.match(/ZOOM|XAXIS/)||(Ba=Math.pow(Math.abs(h),
.5)/Math.pow(this.nMax,.5),this.szFadeValuePow&&Number(this.szFadeValuePow)&&(Ba=Math.pow(Math.abs(h),Number(this.szFadeValuePow))/Math.pow(l,Number(this.szFadeValuePow))))),a.match(/DTEXT/)&&b&&!a.match(/ZOOM/)?(S=map.Scale.normalX(d/3*2)*Math.pow(Math.abs(1/l*h),.5)*.75,this.nValueSizeMin&&!a.match(/ZOOM/)&&(S=S*map.Layer.nDynamicObjectScale>map.Scale.normalX(this.nValueSizeMin)?S:0),Ba=Math.pow(Math.abs(h),1/3)/Math.pow(l,1/3)):this.nValueSizeMin&&!a.match(/ZOOM/)&&(S=S*map.Layer.nDynamicObjectScale>
map.Scale.normalX(this.nValueSizeMin)?S:0));h=isFinite(h)&&!isNaN(h)?h:0;if(0===h&&a.match(/NOZERO/))xa=0;else if(0>ib&&a.match(/NONEGATIVE/))xa=0;else if(0<ib&&a.match(/ONLYNEGATIVE/))xa=0;else{var X=map.Dom.newGroup(bd,"");this.szFlag.match(/MENUSIZE/)&&1==e.length&&!a.match(/VOLUME/)&&(z*=.8,h=z/E*1.7,map.Dom.newShape("rect",X,0,-map.Scale.normalY(.75*d),map.Scale.normalX(.5*d),map.Scale.normalY(.75*d),"fill:red;stroke:none;fill-opacity:0"));var Ca=h;if(a.match(/COLUMN/))0<h*E&&(G=DonutCharts.newChart(SVGDocument,
X,T+z/2,0,z/2,0),G.setStyle("3D"),G.addStyle("SILENT"),G.addPart(100,h*E*2-(a.match(/SPACED/)?z/2:z/5),ya,0,(this.szAggregation&&this.szAggregation.match(/sum/),this.formatValue(e[H],this.nValueDecimals||(5>e[H]?1:0),"ROUND")+this.szUnit),this.formatValue(e[H],2)+this.szUnit+V),G.realize());else if(a.match(/3D/)){w=__maptheme_getChartColors(ya);if(a.match(/VOLUME/)&&Cb){var Qa=(h*E-Cb)/15,xa=xa+Qa,v="white",v="#444444",v=cd.borderColor,yd=cd.mainColor,dd=.3;Cb<h*E&&(dd=.2);map.Dom.newShape("line",
X,Lb+eb,Mb-Qa,T,xa-Qa,"stroke:"+v+";stroke-width:"+map.Scale.normalX(.25)+";");map.Dom.newShape("line",X,Lb+eb,Mb-Cb-Qa,T,xa-h*E-Qa,"stroke:"+v+";stroke-width:"+map.Scale.normalX(.25)+";");map.Dom.newShape("line",X,Lb+eb+eb/3,Mb-eb/4-Qa,T+z/3,xa-z/4-Qa,"stroke:"+v+";stroke-width:"+map.Scale.normalX(.25)+";");map.Dom.newShape("line",X,Lb+eb+eb/3,Mb-Cb-eb/4-Qa,T+z/3,xa-h*E-z/4-Qa,"stroke:"+v+";stroke-width:"+map.Scale.normalX(.25)+"");map.Dom.newShape("path",X,"M"+(Lb+eb)+","+(Mb-Qa)+" L "+T+","+(xa-
Qa)+" "+T+","+(xa-h*E-Qa)+" "+(Lb+eb)+","+(Mb-Cb-Qa)+" z","fill:"+yd+";stroke:"+v+";stroke-width:"+map.Scale.normalX(.05)+";fill-opacity:"+dd);Cb-h*E>-z/4&&map.Dom.newShape("path",X,"M"+(Lb+eb)+","+(Mb-Cb-Qa)+" L "+T+","+(xa-h*E-Qa)+" "+(T+z/3)+","+(xa-h*E-z/4-Qa)+" "+(Lb+eb+eb/3)+","+(Mb-Cb-eb/4-Qa)+" z","fill:"+yd+";stroke:"+v+";stroke-width:"+map.Scale.normalX(.05)+";fill-opacity:"+dd)}Cb=h*E;Lb=T;Mb=xa;eb=z;cd=w;if(Ca=this.nFilterA[J]){var yc="fill:#FFFFFF;stroke:gray;stroke-width:"+map.Scale.normalX(.5)+
";fill-opacity:0.1;stroke-opacity:0.1";map.Dom.newShape("path",X,"M"+T+",0 l "+z+",0 "+z/3+","+-z/4+" "+-z+" 0 z",yc);map.Dom.newShape("rect",X,T+z/3,-Ca*E/ma-z/4,z,Ca*E,yc);map.Dom.newShape("path",X,"M"+T+",0 l 0,"+-Ca*E/ma+" "+z/3+","+-z/4+" 0,"+Ca*E+" z",yc);map.Dom.newShape("rect",X,T,-Ca*E/ma,z,Ca*E,yc);map.Dom.newShape("path",X,"M"+(T+z)+",0 l 0,"+-Ca*E/ma+" "+z/3+","+-z/4+" 0,"+Ca*E+" z",yc);w.highColor=ColorScheme.getDerivateColor(ya,.9)}0>=xa||a.match(/LEFT/)||a.match(/VOLUME/)?(h&&(0===
h&&(w=__maptheme_getChartColors("none")),map.Dom.newShape("rect",X,T,-h*E/ma,z,h*E,"fill:"+w.mainColor+";stroke:"+w.borderColor+";stroke-width:"+map.Scale.normalX(.05)+";stroke-opacity:0.3"),map.Dom.newShape("path",X,"M"+(T+z)+",0 l 0,"+-h*E/ma+" "+z/3+","+-z/4+" 0,"+h*E+" z","fill:"+w.lowColor+";stroke:"+w.borderColor+";stroke-width:"+map.Scale.normalX(.05)+""),w.highColor=ColorScheme.getDerivateColor(ya,.9)),map.Dom.newShape("path",X,"M"+T+","+-h*E/ma+" l "+z+",0 "+z/3+","+-z/4+" "+-z+" 0 z","fill:"+
w.highColor+";stroke:"+w.borderColor+";stroke-width:"+map.Scale.normalX(.05)+";stroke-opacity:1")):(map.Dom.newShape("path",X,"M"+T+",0 l "+z+",0 "+z/3+","+-z/4+" "+-z+" 0 z","fill:"+w.highColor+";stroke:"+w.borderColor+";stroke-width:"+map.Scale.normalX(.05)+";fill-opacity:0.2"),map.Dom.newShape("rect",X,T+z/3,-h*E/ma-z/4,z,h*E,"fill:"+w.mainColor+";stroke:"+w.borderColor+";stroke-width:"+map.Scale.normalX(.05)+";fill-opacity:0.4"),map.Dom.newShape("path",X,"M"+T+",0 l 0,"+-h*E/ma+" "+z/3+","+-z/
4+" 0,"+h*E+" z","fill:"+w.lowColor+";stroke:"+w.borderColor+";stroke-width:"+map.Scale.normalX(.05)+";fill-opacity:0.4"),w.highColor=ColorScheme.getDerivateColor(ya,.9),map.Dom.newShape("rect",X,T,-h*E/ma,z,h*E,"fill:"+w.mainColor+";stroke:"+w.borderColor+";stroke-width:"+map.Scale.normalX(.05)+";fill-opacity:0.4"),map.Dom.newShape("path",X,"M"+(T+z)+",0 l 0,"+-h*E/ma+" "+z/3+","+-z/4+" 0,"+h*E+" z","fill:"+w.lowColor+";stroke:"+w.borderColor+";stroke-width:"+map.Scale.normalX(.05)+";fill-opacity:0.4"),
w.highColor=ColorScheme.getDerivateColor(ya,.9));Ca&&(map.Dom.newShape("rect",X,T,-Ca*E/ma,z,Ca*E,"fill:#FFFFFF;stroke:none;stroke-width:"+map.Scale.normalX(.05)+";fill-opacity:0.25"),Ca>h?map.Dom.newShape("path",X,"M"+T+","+-Ca*E/ma+" l "+z+",0 "+z/3+","+-z/4+" "+-z+" 0 z","fill:#8888FF;stroke:#444488;stroke-width:"+map.Scale.normalX(.1)+";fill-opacity:0.2"):map.Dom.newShape("path",X,"M"+T+","+-Ca*E/ma+" l "+z+",0 "+z/3+","+-z/4+" "+-z+" 0 z","fill:#8888FF;stroke:"+w.borderColor+";stroke-width:"+
map.Scale.normalX(.1)+";fill-opacity:0.1;stroke-opacity:0.4"))}else if(a.match(/Border/))map.Dom.newShape("rect",X,T,-h*E/ma,z,h*E,"fill:"+ya+";stroke:none;"),Jb=T+2,Kb=T+z-2,jc=2-h*E/ma,rc=jc+h*E-2,w=__maptheme_getChartColors(ya),map.Dom.newShape("line",X,Jb,jc,Jb,rc,"stroke:white;stroke-width:"+map.Scale.normalX(.001)+";stroke-opacity:1.0"),map.Dom.newShape("line",X,Jb,jc,Kb,jc,"stroke:white;stroke-width:"+map.Scale.normalX(.001)+";stroke-opacity:1.0"),map.Dom.newShape("line",X,Jb,rc,Kb,rc,"stroke:black;stroke-width:"+
map.Scale.normalX(.001)+";stroke-opacity:0.9"),map.Dom.newShape("line",X,Kb,jc,Kb,rc,"stroke:black;stroke-width:"+map.Scale.normalX(.001)+";stroke-opacity:0.9");else if(a.match(/POINTER/)&&h){(a.match(/OFFSETMEAN/)||a.match(/OFFSETMEDIAN/)||a.match(/DEVIATION/))&&1E3<Math.abs(h*E)&&(E=(1E3+(Math.abs(h*E)-1E3)/10+Math.abs(h*E)%1E3)/Math.abs(h));var zc="fill:"+ya+";fill-opacity:"+(this.fillOpacity||1)+";stroke:"+(this.szLineColor||"black")+";stroke-opacity:0.5;stroke-width:"+map.Scale.normalX(this.nLineWidth)*
Math.sqrt($a||1)+"";0>=xa?(!this.fShadow&&this.fOrigShadow&&map.Dom.newShape("path",X,"M"+(T+z/7+10)+","+(-h*E/ma+10)+" l "+-z/7+",0 0,"+-z/15+" "+z/2+","+-z/3+" "+z/2+","+z/3+" 0,"+z/15+" "+-z/7+",0 0,"+h*E+" "+5*-z/7+",0 z","fill:000000;fill-opacity:0.5;stroke:none;"),map.Dom.newShape("path",X,"M"+(T+z/7)+","+-h*E/ma+" l "+-z/7+",0 0,"+-z/15+" "+z/2+","+-z/3+" "+z/2+","+z/3+" 0,"+z/15+" "+-z/7+",0 0,"+h*E+" "+5*-z/7+",0 z",zc)):a.match(/NONEGATIVE/)||(a.match(/LEFT/)||(a.match(/ZOOM/)||a.match(/NORMSIZE/)?
zc="fill:"+ya+";stroke:"+ya+";stroke-width:"+map.Scale.normalX(.25)+";fill-opacity:0.5":2<this.partsA.length?(w=__maptheme_getChartColors(ya),zc="fill:"+ya+";stroke:"+w.lowColor+";stroke-width:"+map.Scale.normalX(.25*this.nLineWidth*$a||.25)+";fill-opacity:"+(this.nFadeNegative||.1)+";stroke-opacity:0.8"):(w=__maptheme_getChartColors(ya),zc="fill:"+ya+";stroke:"+w.highColor+";stroke-width:"+map.Scale.normalX(this.nLineWidth)*Math.sqrt($a||1)+";fill-opacity:"+(this.nFadeNegative||.1)+";stroke-opacity:1")),
map.Dom.newShape("path",X,"M"+(T+z/7)+","+-h*E/ma+" l "+5*z/7+",0 0,"+h*E+" "+z/7+",0 "+-z/2+","+z/4+" "+-z/2+","+-z/4+" "+z/7+",0 z",zc))}else 0>=xa||a.match(/LEFT/)?map.Dom.newShape("rect",X,T,-h*E/ma,z,h*E,"fill:"+ya+";fill-opacity:"+(this.fillOpacity||1)+";stroke:"+(this.szLineColor||"black")+";stroke-width:"+map.Scale.normalX(.25*this.nLineWidth*$a||.2)+";stroke-opacity:"+(this.nLineWidth?1:.1)+""):map.Dom.newShape("rect",X,T,-h*E/ma,z,h*E,"fill:"+ya+";fill-opacity:"+(this.fillOpacity||1)+";stroke:"+
ya+";stroke-width:"+map.Scale.normalX(.25)+";fill-opacity:0.3"),(Ca=this.nFilterA[J])&&(0>=xa||a.match(/LEFT/)?map.Dom.newShape("rect",X,T,-Ca*E/ma,z,Ca*E,"fill:none;stroke:black;stroke-width:"+map.Scale.normalX(.5)+";stroke-opacity:0.1"):map.Dom.newShape("rect",X,T,-Ca*E/ma,z,Ca*E,"fill:none;stroke:"+ya+";stroke-width:"+map.Scale.normalX(.5)+";fill-opacity:0.3"));if(!(!a.match(/VALUES/)&&!this.szXaxisA||0<xa&&a.match(/NONEGATIVE/)||!a.match(/ZOOM/)&&this.fHideValues)){h||(h=0);if(!(!a.match(/AXIS/)||
!this.szLabelA&&!this.szXaxisA||a.match(/STACKED/)&&J%(this.nGridX||1)||a.match(/STACKED/)&&a.match(/HORZ/))){var Bb=J/(this.nGridX||1),Ic=(this.szXaxisA?this.szXaxisA[Bb]:this.szLabelA?this.szLabelA[Bb]:" ")||" ",ed=.5*z;a.match(/\bUP\b/)&&(ed=.6*z);a.match(/\bHORZ\b/)&&(ed=.9*z);var F=map.Dom.newText(X,0,0,Vb+";fill:#666666;text-anchor:end;font-size:"+ed+"px"," "+Ic+" "),da=new point(map.Scale.normalX(.8),z/2+S/5*2);this.fNegativeValues?F.setAttributeNS(null,"transform","translate("+(T+da.y)+","+
(-da.x+.9*S+10)+") rotate(270)"):a.match(/CENTER/)?F.setAttributeNS(null,"transform","translate("+(T+da.y)+","+(map.Scale.normalX(d/2)+.9*S)+") rotate(270)"):a.match(/HORZ/)?F.setAttributeNS(null,"transform","translate("+(T+da.y)+","+(-da.x+.9*S+10)+") rotate(270)"):(F.style.setProperty("text-anchor","end",""),1==e.length?F.setAttributeNS(null,"transform","translate("+(T+(a.match(/VOLUME/)?1.3*z:1.5*da.y))+","+-da.x+") "):1<Ic.length?F.setAttributeNS(null,"transform","translate("+(T+da.y)+","+.8*
S+") rotate(315)"):F.setAttributeNS(null,"transform","translate("+(T+.1*da.y)+","+(-da.x+S)+")"))}if(a.match(/VALUES/)&&0<S&&!(this.nGridX&&2<this.partsA.length/this.nGridX)){R=this.formatValue(ib,this.nValueDecimals||(1>=this.nMax?1:0));a.match(/POINTER/)&&0<ib&&(0>this.nMin||a.match(/OFFSETMEAN/)||a.match(/OFFSETMEDIAN/)||this.szFlag.match(/\bSIGN\b/))&&(R="+"+R);a.match(/VOLUME/)||(R+=this.szUnit?" "+this.szUnit+" ":"");!a.match(/STACKED/)||0===ib||g||this.nGridX||(R=R+" ("+Math.round(ib/n*100)+
"%)");a.match(/STACKED/)&&(S=a.match(/ZOOM/)?map.Scale.normalX(18):map.Scale.normalX(5),S*=this.nValueScale||1);var Mc=R.length*S*4/8,F=this.createTextLabel(SVGDocument,X,"",R,S/map.Scale.normalX(1),null,0<ib&&(a.match(/CTEXT/)||a.match(/VALUEBACKGROUND/))?ya:null,this.szTextColor);F.style.setProperty("opacity",String(Ba),"");var fd=Pa=null;this.szXaxisA&&a.match(/CATEGORICAL/)&&!a.match(/AXIS/)&&(fd=map.Dom.newTSpan(F,"fill:fill:#444444;font-size:"+S+"px"," "+this.szXaxisA[k]));var sc=F.fu.getBox().width,
da=new point(map.Scale.normalX(-4),z/2+.15*S),zd=!0;if(a.match(/DOINLINETEXT/)&&!a.match(/ZOOM/)&&!a.match(/NORMSIZE/)||!a.match(/VALUE/)||a.match(/VOLUME/)&&!a.match(/ZOOM/)||!(a.match(/THIN/)||a.match(/NOINLINETEXT/)||a.match(/DTEXT/)||a.match(/SIZE/)||sc+map.Scale.normalX(1)>h*E/ma||a.match(/STACKED/)||a.match(/NORMSIZE/)||a.match(/ZOOM/))){w=__maptheme_getChartColors(ya);F.removeChild(F.firstChild);F.firstChild.style.setProperty("fill",w.textColor,"");fd&&fd.style.setProperty("fill",w.textColor,
"");Pa&&Pa.parentNode.removeChild(Pa);var Nd=map.Scale.normalX(0),mc=map.Scale.normalY(.5);a.match(/VOLUME/)?(K=h*E/(sc+map.Scale.normalX(2)),F.parentNode.removeChild(F),F=map.Dom.newText(X,T+h*E/2,S*K/4-h*E/2,"font-family:arial;font-size:"+S*K+"px;text-anchor:middle;fill:"+w.textColor+";opacity:"+qa+";stroke:none;pointer-events:none",R)):(K=Math.min(1,h*E/sc),.33>K?F.parentNode.removeChild(F):(0<ib&&(da.x+=Math.max(map.Scale.normalX(1),h*E-(sc+map.Scale.normalX(3))*K)),mc/=K,F.firstChild.style.setProperty("font-size",
String(S*K)),F.firstChild.setAttributeNS(null,"transform","translate("+(T+da.y-mc)+","+(-da.x-Nd)+") rotate(270)\t")));lc.x=Math.max(0,lc.x-h*E)}else if(zd=!1,a.match(/STACKED/))if(0!==h||a.match(/ZEROISVALUE/))if(this.nGridX&&2<e.length/this.nGridX)F.parentNode.removeChild(F);else{da.x=0;a.match(/3D/)&&(da.x+=z/4,da.y+=z/3);var Nc=h*E/(a.match(/SUM/),2);lc.x=Math.max(0,lc.x+(.75*S-Nc));var Oc=new point(lc.x+da.x+Nc-S/3,0),Nb=map.Scale.normalX(.5)*$a,Wb=T+da.y+z/3,Xb=T+da.y+7*z/8,Yb=-da.x-Nc,Zb=-Oc.x-
S/3;if(this.nGridX&&Lc<this.nGridX){da.y-=2*z+F.fu.getBox().width;var Od=Xb,Xb=Wb-(a.match(/3D/)?1.5*z:1.4*z),Wb=Od-(a.match(/3D/)?7*z/4:1.4*z);a.match(/3D/)&&(Yb+=z/5,Zb+=z/5,Oc.x-=z/7);Nb=-Nb}F.setAttributeNS(null,"transform","translate("+(T+da.y+z+Nb-S)+","+(-Oc.x-.25*S)+") ");var gd=map.Dom.newGroup(X,""),hd=map.Dom.newGroup(X,"");map.Dom.newShape("line",gd,Wb,Yb,Wb+Nb,Yb,"stroke-width:"+map.Scale.normalX(.15)+";stroke:white;opacity:0.2;");map.Dom.newShape("line",hd,Wb,Yb,Wb+Nb,Yb,"stroke-width:"+
map.Scale.normalX(.05)+";stroke:#888888;");map.Dom.newShape("line",gd,Wb+Nb,Yb,Xb,Zb,"stroke-width:"+map.Scale.normalX(.15)+";stroke:white;opacity:0.2;stroke-linecap:round;");map.Dom.newShape("line",hd,Wb+Nb,Yb,Xb,Zb,"stroke-width:"+map.Scale.normalX(.05)+";stroke:#888888;");map.Dom.newShape("line",gd,Xb,Zb,Xb+Nb,Zb,"stroke-width:"+map.Scale.normalX(.15)+";stroke:white;opacity:0.2;");map.Dom.newShape("line",hd,Xb,Zb,Xb+Nb,Zb,"stroke-width:"+map.Scale.normalX(.05)+";stroke:#888888;");lc.x=Math.max(0,
lc.x+(2*S/3-(h*E-Nc)))}else F.parentNode.removeChild(F);else{da.x+=z/4;a.match(/3D/)&&(da.x+=z/4,da.y=.3*z+S/2);a.match(/POINTER/)&&0<ib&&(da.x+=.25*z);var $b=h;sc+map.Scale.normalX(1)>(Ca-h)*E/ma&&($b=Math.max(h,Ca),Ca>h&&($b+=z/E*.2,map.Dom.newShape("line",X,T+.6*z,-da.x-h*E/ma+z/3,T+.6*z,-da.x-Ca*E/ma-.4*z,"stroke:white;")));a.match(/VOLUME/)&&($b+=z/5);if(1!=e.length||a.match(/HORZ/)||a.match(/VOLUME/))a.match(/VOLUME/)?F.setAttributeNS(null,"transform","translate("+(T+da.y)+","+(-da.x-$b*E/ma)+
")  scale(0.9,0.9)"):F.setAttributeNS(null,"transform","translate("+(T+da.y)+","+(-10-.25*z-$b*E/ma)+") rotate(270) scale(0.9,0.9)");else{if(a.match(/ZOOM/)||a.match(/NORMSIZE/)){da.y+=a.match(/3D/)?.75*z:.5*z;var Pd=Math.min(0,.55*S-h*E),Ad=S;!a.match(/3D/)&&!a.match(/ZOOM/)||a.match(/SIZE/)||(Ad=0);F.setAttributeNS(null,"transform","translate("+(T+Ad)+","+(Pd-.5*S)+")")}else da.y+=a.match(/3D/)?a.match(/VOLUME/)?.75*z:.6*z:.2*z,F.setAttributeNS(null,"transform","translate("+(T-.8*z)+","+(-$b*E/
ma-.8*S-(a.match(/POINTER/)&&0<ib?.3*z:0))+")");0>ib&&F.style.setProperty("opacity",String(.75*Ba),"")}F.style.setProperty("fill","#404040","")}}}null!=f&&k==f&&(u=2*S,w=__maptheme_getChartColors(ya),map.Dom.newShape("path",X,"M5,0 l 35,-45 -25,0 0,-30 -20,0 0,30 -25,0 35,45","fill:#404040;stroke:white;stroke-width:"+map.Scale.normalX(.2)+"").fu.setPosition(k*(z+1.5)+.5*z,-h*E+(zd?-map.Scale.normalX(3):-sc-map.Scale.normalX(12))));if(a.match(/TRENDLINE/)){mc=Math.min(h*E/2,map.Scale.normalY(1.5));
w=__maptheme_getChartColors(ya);v=w.lowColor;u=S/5;0<k&&(Jb=(k-1)*(z+(a.match(/SPACED/)?z/5:1))+z/2,Kb=k*(z+(a.match(/SPACED/)?z/5:1))+z/2,v="white",v=Kc>h?"#CC3333":Kc<h?"#22BB22":w.lowColor,map.Dom.newShape("line",X,Jb,-Kc*E+mc,Kb,-h*E+mc,"stroke:#666666;stroke-width:"+map.Scale.normalX(1/e.length*1.2)+";opacity:0.8"));var Bd=map.Dom.newShape("circle",X,0,0,u,"fill:"+v+";stroke:none;opacity:0.8");Bd&&Bd.fu.setPosition(k*(z+(a.match(/SPACED/)?z/5:0))+z/2,-h*E+mc)}a.match(/SILENT/)||(this.szFlag.match(/SEQUENCE/)?
X.setAttributeNS(szMapNs,"tooltip",Ya+" ("+(this.szLabelA?this.szLabelA[Q]:"")+") ["+this.szFieldsA[J]+"]"):(V=this.szFieldsA[J],this.szLabelA&&this.szLabelA[J]&&(V=this.szLabelA[J]),Ya+=this.szUnit?" ["+this.szUnit+"]":"",!n||this.nGridX||this.szField100&&this.szFlag.match(/FRACTION/),X.setAttributeNS(szMapNs,"tooltip",Ya+" '"+V+"'")));a.match(/FADEIN/)&&(2==e.length&&0===k?X.style.setProperty("opacity","0.6",""):a.match(/NORMSIZE/)||(N=a.match(/FADEINP4/)?10:3,X.style.setProperty("opacity",String(.1+
.9*Math.pow(k+1,N)/Math.pow(e.length,N)),"")));a.match(/FADENEGATIVE/)&&0>ib&&X.style.setProperty("opacity","0.5","");X.setAttributeNS(szMapNs,"class",String(Q));X.fu.setPosition(0,xa);a.match(/STACKED/)?a.match(/CENTER/)||(xa-=h*E):(xa=0,T+=z,a.match(/VOLUME/)&&a.match(/SPACED/)?T+=z/(2==e.length?2:4):a.match(/SPACED/)?T+=z/5:a.match(/\bUP\b/)||(T+=1));Lc++;a.match(/STACKED/)&&!a.match(/MULTI/)&&this.nGridX&&0===Lc%this.nGridX&&(xa=0,T+=z+z/20);Kc=h}}a.match(/HOR/)&&bd.setAttributeNS(null,"transform",
"rotate(90) translate("+-T+",0)");p.y=0;p.x=0;a.match(/HOR/)?(p.y-=1*z/2,a.match(/3D/)&&(p.y-=1*z/3)):a.match(/STACKED/)?p.x=z/2:a.match(/Up/)||a.match(/HOR/)?p.x=0:p.x=z*Lc/2;a.match(/MENUSIZE/)&&(p.x+=z*(a.match(/HORZ/)?1:0),p.y+=z*(a.match(/HORZ/)?.3:0),p.y+=z*(a.match(/HORZ/)&&a.match(/3D/)?1:a.match(/VOLUME/)?.3:.6));this.nRealizedCount++;var id=map.Dom.newGroup(t,"");id.appendChild(bd);a.match(/ZOOM/)&&(K=240/S/(1<e.length?2:1),id.fu.scale(K,K));id.fu.setPosition(t.fu.getPosition().x-p.x,-p.y);
p.x=0;p.y=0;a.match(/HOR/)&&(p.y=1*z/2)}if(a.match(/EXTEND/)&&HTMLWindow.ixmaps.htmlgui_drawChartAfter)try{Fa=this.objThemesA[this.szThemesA[0]],HTMLWindow.ixmaps.htmlgui_drawChartAfter(SVGDocument,{target:t,theme:this,item:b,values:e,maxSize:d,flag:a,mark:f,dbRecord:Fa.dbRecords?Fa.dbRecords[this.itemA[b].dbIndex]:null})}catch(Sd){}if(!a.match(/NORMSIZE/)){var mb=new point(p.x,p.y);a.match(/PLOT/)?(p.x=map.Scale.normalX(this.nOffsetX||0),p.y=map.Scale.normalY(-this.nOffsetY||0)):(p.x=map.Scale.normalX(this.nOffsetX||
0)*(this.nSymbolScale||1),p.y=map.Scale.normalY(-this.nOffsetY||0)*(this.nSymbolScale||1));this.szAlign&&(a.match(/PLOT/)&&!a.match(/ZOOM/)?(this.szAlign.match(/center/)&&(p.x=map.Scale.normalX(d/2*e.length/(this.nGridX||1)),this.szAlign.match(/top/)||(p.y=-map.Scale.normalX(d/2*e.length/(this.nGridX||1)))),this.szAlign.match(/right/)&&(p.x=map.Scale.normalX(d*e.length/(this.nGridX||1))),this.szAlign.match(/23right/)&&(p.x=map.Scale.normalX(.66*d*e.length/(this.nGridX||1))),this.szAlign.match(/10\%right/)&&
(p.x=map.Scale.normalX(.9*d*e.length/(this.nGridX||1))),this.szAlign.match(/10\%left/)&&(p.x=map.Scale.normalX(.1*d*e.length/(this.nGridX||1))),this.szAlign.match(/23left/)&&(p.x=map.Scale.normalX(.33*d*e.length/(this.nGridX||1)))):this.nGridX&&!a.match(/ZOOM/)?(this.szAlign.match(/center/)&&(p.x=map.Scale.normalX(d/2/this.partsA.length*e.length/(this.nGridX||1))),this.szAlign.match(/right/)&&(p.x=map.Scale.normalX(d/this.partsA.length*e.length/(this.nGridX||1))),this.szAlign.match(/23right/)&&(p.x=
map.Scale.normalX(d/this.partsA.length*.66*e.length/(this.nGridX||1)))):(this.szAlign.match(/center/)&&(p.y=0),this.szAlign.match(/bottom/)&&(p.y=mb.y?mb.y:map.Scale.normalX(d/5)),this.szAlign.match(/above/)&&(p.y=mb.y?mb.y:map.Scale.normalX(d/2)),this.szAlign.match(/2above/)&&(p.y+=map.Scale.normalX(d/2)),this.szAlign.match(/below/)&&(p.y=-(mb.y?mb.y:map.Scale.normalX(d/2))),this.szAlign.match(/2below/)&&(p.y-=map.Scale.normalX(d/2)),this.szAlign.match(/top/)&&(p.y=-(mb.y?mb.y:map.Scale.normalX(d/
2))),this.szAlign.match(/left/)&&(p.x=-(mb.y?mb.y:map.Scale.normalX(d/2))),this.szAlign.match(/2left/)&&(p.x-=map.Scale.normalX(d/2)),this.szAlign.match(/right/)&&(p.x=mb.y?mb.y:map.Scale.normalX(d/2)),this.szAlign.match(/2right/)&&(p.x+=map.Scale.normalX(d/2)),this.szAlign.match(/23right/)&&(p.x=map.Scale.normalX(d/3)),this.szAlign.match(/baseline/)&&(p.y+=map.Scale.normalY(d/5))))}if(b&&this.szLabelField&&!a.match(/NORMSIZE/)&&!a.match(/ZOOM/)&&(!this.nLabelUpper||map.Scale.nTrueMapScale*map.Scale.nZoomScale<=
this.nLabelUpper)){var V=(V=this.itemA[b].szLabel)?isNaN(__scanValue(V))?V+(this.szLabelUnits||""):this.formatValue(__scanValue(V),this.nValueDecimals||2)+(this.szLabelUnits||""):this.szLabelField+"?",S=map.Scale.normalX(5)*(this.nTextScale||1),Vb="opacity:0.7;font-family:arial;font-size:"+S+"px;text-anchor:middle;fill:#000000;pointer-events:none",Qd="opacity:1;fill:white;fill-opacity:0.4;stroke:#000000;stroke-width:"+map.Scale.normalX(1)+"pointer-events:none;",Mc=(V.length+2)*S*.5,Db=map.Dom.newGroup(t,
"");Db.parentNode.append(Db);a.match(/MULTI/)?Vb+=";fill:#444444;text-anchor:start;":Db.setAttributeNS(szMapNs,"class",String(Q));var tc=map.Dom.newShape("rect",Db,-Mc/2,.95*-S,Mc,1.2*S,Qd);tc.setAttributeNS(null,"rx",.2*S);tc.setAttributeNS(null,"ry",.2*S);F=map.Dom.newText(Db,0,0,Vb,V);xd=F.fu.getBox();z=Math.max(xd.width,Mc);tc.setAttributeNS(null,"x",-z/2);tc.setAttributeNS(null,"width",z);a.match(/MULTI/)?(Db.fu.setPosition(map.Scale.normalX(.8*d),.77*S),Db.fu.scale(2,2),tc.parentNode.removeChild(tc)):
Db.fu.setPosition(z/3,S/3+mb.y);this.itemA[b].labelGroup=Db;this.szTimeField&&(U=(new Date(this.itemA[b].szTime)).getTime()||this.itemA[b].szTime,Db.setAttributeNS(szMapNs,"time",U))}if(a.match(/MENU/)){var Pc=t.fu.getBox();t.fu.setPosition(-Pc.x-Pc.width/2,-Pc.y-Pc.height/2-map.Scale.normalY(d/2)-map.Scale.normalY(2))}else a.match(/ZOOM/)||(t.fu.setPosition(t.fu.getPosition().x-p.x,t.fu.getPosition().y-p.y),ja&&ja.fu.setPosition(ja.fu.getPosition().x-p.x,ja.fu.getPosition().y-p.y));p.x=0;p.y=0;b&&
(this.itemA[b].fDone=!0);return p};MapTheme.prototype.getShapes=function(){var c=map.Layer.getLayerObj(this.szThemesA[0]);if(!c||!c.szFlag.match(/tiled/))for(var b in this.itemA)this.parent.themeNodesA[b]||(this.parent.themeNodesA[b]=this.getShapeA(b))};MapTheme.prototype.getItemNodes=function(c){this.parent.themeNodesA[c]&&this.parent.themeNodesA[c].length||(this.parent.themeNodesA[c]=this.getShapeA(c));return this.parent.themeNodesA[c]||[]};
MapTheme.prototype.getShapeA=function(c){c=__mpap_decode_utf8(c);var b=SVGDocument.getElementById(c.trim());if(b)return Array(b);if(c.match(/\,/))for(var d=c.split("::"),a=d[0].split(","),f=0;f<a.length;f++)if(b=SVGDocument.getElementById((a[f]+"::"+d[1]).trim()))return Array(b);this.nMissingLookupCount++;this.missedA[c]=c;return[]};MapTheme.prototype.getPositions=function(){for(var c in this.itemA)this.getNodePosition(this.itemA[c].szSelectionId)};
MapTheme.prototype.getNodePosition=function(c){if("undefined"==typeof c)return null;if(map.Themes.themeNodesPosA[c])return map.Themes.themeNodesPosA[c];var b=this.themeNodesPosA;if(!b[c]){if(c.match(/:clone/))return null;if(c.match(/(-?[0-9\.]+) ?, ?(-?[0-9\.]+)/)){var d=this.getMapPosition(c);b[c]=new point(d.x,d.y);return b[c]}this.parent.themeNodesA[c]||(this.parent.themeNodesA[c]=this.getShapeA(c));d=this.parent.themeNodesA[c][0];if(1<this.parent.themeNodesA[c].length)for(var a=parseFloat(d.getAttributeNS(szMapNs,
"area")),f=1;f<this.parent.themeNodesA[c].length;f++){var e=this.parent.themeNodesA[c][f],g=parseFloat(e.getAttributeNS(szMapNs,"area"));g>a&&(a=g,d=e)}d&&(this.szShapeType.match(/line/)?((a=d.getAttributeNS(szMapNs,"center"))&&2<a.length?(a=a.split(","),a=new box(Number(a[0].split(":")[1]),Number(a[1].split(":")[1]),0,0)):map.Dom.getBox(d),a=map.Dom.getBox(d)):(a=d.getAttributeNS(szMapNs,"center"),!a&&d.parentNode&&(a=d.parentNode.getAttributeNS(szMapNs,"center")),a&&2<a.length?(a=a.split(","),a=
new box(Number(a[0].split(":")[1]),Number(a[1].split(":")[1]),0,0)):a=map.Dom.getBox(d)),f=map.Scale.getMapOffset(d),b[c]=new point(f.x+a.x+a.width/2,f.y+a.y+a.height/2),d=getMatrix(d))&&(b[c].x+=d[4],b[c].y+=d[5])}if(b[c]&&"undefined"!=typeof b[c].x&&"undefined"!=typeof b[c].y)return b[c];this.missedA[c]=c;return null};
MapTheme.prototype.getNodeBox=function(c){if("undefined"==typeof c)return null;if(!this.parent.themeNodesBoxA[c]){if(c.match(/:clone/))return null;this.parent.themeNodesA[c]||(this.parent.themeNodesA[c]=this.getShapeA(c));var b=this.parent.themeNodesA[c][0];if(1<this.parent.themeNodesA[c].length)for(var d=parseFloat(b.getAttributeNS(szMapNs,"area")),a=1;a<this.parent.themeNodesA[c].length;a++){var f=this.parent.themeNodesA[c][a],e=parseFloat(f.getAttributeNS(szMapNs,"area"));e>d&&(d=e,b=f)}b&&(d=
map.Dom.getBox(b),b=map.Scale.getMapOffset(b),this.parent.themeNodesBoxA[c]=new box(b.x+d.x,b.y+d.y,d.width,d.height))}return this.parent.themeNodesBoxA[c]};MapTheme.prototype.getNodeArea=function(c){return(c=this.getItemNodes(c)[0])?Number(c.getAttributeNS(szMapNs,"area"))/1E6:0};var positionRegExp=/(-?[0-9\.]+) ?[, ] ?(-?[0-9\.]+)/;
MapTheme.prototype.getMapPosition=function(c){if(c){var b=null;if(c&&(b=c.match(positionRegExp)))return 180<Math.abs(parseFloat(b[1]))||180<Math.abs(parseFloat(b[2]))?new point(0,0):map.Scale.getMapPositionOfLatLon(parseFloat(b[1]),parseFloat(b[2]))}return new point(0,0)};MapTheme.prototype.onClick=function(c){this.fRemove||(this.widgetNode&&this.enable(),this.fToFront=!0,executeWithMessage("map.Themes.execute()","... processing ..."),map.Themes.onclickInfo(c,this.szId))};
MapTheme.prototype.showErrorInfo=function(){if(0!==this.nMissingPositionCount){var c=this.szId+":errordisplay:widget",b=map.Dictionary.getLocalText("Chart statistic"),b=new InfoContainer(SVGDocument,this.widgetNode,c+":movable",new point(map.Scale.normalX(0),map.Scale.normalX(0)),new point(-map.Scale.normalX(15),map.Scale.normalX(80)),"fixed",b),d=b.workspaceNode,a=[map.Dictionary.getLocalText("total items"),map.Dictionary.getLocalText("charts drawn"),map.Dictionary.getLocalText("missing positions"),
map.Dictionary.getLocalText("missing value match"),map.Dictionary.getLocalText("zero values"),String(this.nCount),String(this.nRealizedCount),String(this.nMissingPositionCount),String(this.nMissingRangeCount),String(this.nZeroValueCount)],d=map.Dom.newGroup(d,"");d.fu.setPosition(0,map.Scale.normalY(3));createTextGrid(SVGDocument,d,c+":textgrid",a,2);b.reformat()}};
MapTheme.prototype.getDataGrid=function(c,b){if(this.szFlag.match(/AGGREGATE/)&&3<this.itemA[c].nCount)return null;var d=map.Themes.getDataRow(c,this);if(d&&d.length){for(var a=0;a<d.length;a++)d[a]=d[a]||"---";var f;(a=new ScrollArea(null,b,null,10,10,10))?(a.reformat(),f=a.workspaceNode):f=b;for(var e=[],g=map.Themes.getFieldIndexArray(this),l=0;l<g.length;l++)e[g[l]]="font-weight:bold;fill:#087BBB",e[g[l+d.length/2]]="font-weight:bold;fill:#087BBB";g=map.Scale.tStyle.Description.nFontHeight/map.Scale.normalX(1);
d=createTextGrid(SVGDocument,f,":textgrid",d,2,g,e);return a?(a.setWidth(Math.min(d.fu.getBox().width/map.Scale.normalX(1)+25,map.Scale.bBox.width/map.Scale.normalY(2.2))),a.setHeight(Math.min(d.fu.getBox().height/map.Scale.normalY(1)+25,map.Scale.bBox.height/map.Scale.normalY(1.5))),a.reformat(),a.hasScrollBars()&&a.setScrollPosition(new point(0,0)),a):d.fu}};function __sortYposUp(c,b){return c.y>b.y?1:-1}function __sortYposDown(c,b){return c.y<b.y?1:-1}
MapTheme.prototype.drawTextforOneQuadrant=function(c,b,d,a,f,e,g,l){var n=c.szStyle.match(/3D/)?2.4*d:1.2*d,k=n/2;l-=n*(b.length-2);for(var q=0;q<b.length;q++){var h=b[q].y/b[q].ly,u=Math.max(k,Math.min(b[q].y,l)),k=u+n;l+=d;var w=1.2*b[q].x,w=g+map.Scale.normalX(2);u>b[q].y&&(h=Math.max(h,u/b[q].y));var p=c.mX+b[q].lx*f,t=c.mY+b[q].ly*e,M=c.mX+b[q].x*f,D=c.mY+b[q].y*e,w=c.mX+w*f,u=c.mY+u*e,y=map.Dom.newGroup(c.frameGroup,"");c.donutPartsA[b[q].index].textNode=y;var m=map.Dom.newGroup(y,""),v=map.Dom.newGroup(y,
"");h&&(map.Dom.newShape("line",m,p,t,M,D,"stroke:white;stroke-width:"+map.Scale.normalX(1.5)+";opacity:0.2;"),map.Dom.newShape("line",v,p,t,M,D,"stroke:#888888;stroke-width:"+map.Scale.normalX(.5)+";opacity:1;"),p=M,t=D);b[q].x<g-map.Scale.normalX(3)&&(map.Dom.newShape("line",m,p,t,c.mX+(g-map.Scale.normalX(3))*f,t,"stroke:white;stroke-width:"+map.Scale.normalX(1.5)+";opacity:0.2;stroke-linecap:round;"),map.Dom.newShape("line",v,p,t,c.mX+(g-map.Scale.normalX(3))*f,t,"stroke:#888888;stroke-width:"+
map.Scale.normalX(.5)+";opacity:1;"),p=c.mX+(g-map.Scale.normalX(3))*f);map.Dom.newShape("line",m,p,t,w,u,"stroke:white;stroke-width:"+map.Scale.normalX(1.5)+";opacity:0.2;stroke-linecap:round;");map.Dom.newShape("line",v,p,t,w,u,"stroke:#888888;stroke-width:"+map.Scale.normalX(.5)+";opacity:1;");p=w;w+=map.Scale.normalX(2)*f;map.Dom.newShape("line",m,p,u,w,u,"stroke:white;stroke-width:"+map.Scale.normalX(1.5)+";opacity:0.2;");map.Dom.newShape("line",v,p,u,w,u,"stroke:#888888;stroke-width:"+map.Scale.normalX(.5)+
";opacity:1;");w+=map.Scale.normalX(1.5)*f;(h=c.partsA[b[q].index]&&c.partsA[b[q].index].szText?c.partsA[b[q].index].szText:null)||(h=c.partsA[b[q].index].szInfo?c.partsA[b[q].index].szInfo:Math.round(10*c.partsA[b[q].index].nInfoValue)/10+" % ");h=this.createTextLabel(SVGDocument,y,"",h,d/map.Scale.normalX(1),a,this.szFlag.match(/VALUEBACKGROUND/)?c.partsA[b[q].index].color:"white",this.szChartFlag.match(/ZOOM/)?null:this.szTextColor);h.fu.setPosition(w-d,u-0*d);h.setAttributeNS(szMapNs,"tooltip",
c.partsA[b[q].index].szInfo);c.szStyle.match(/3D/)&&h.fu.scale(1,2)}};
MapTheme.prototype.drawDonutText=function(c,b){for(var d=0,a=0,f=0,e=[],g=[],l=[],n=[],k=Math.min(50,this.partsA.length),q=0;q<k;q++){var h=c.getTextPosition(q);if(h){if(this.szShowPartsA){var u=!1,w;for(w in this.szShowPartsA)this.szShowPartsA[w]==q&&(u=!0);if(!u)continue}d=Math.max(d,Math.abs(h.y));a=Math.max(a,h.x);f=Math.min(f,h.x);c.szStyle.match(/STARBURST/)?(a=Math.max(a,h.x),f=Math.min(f,h.x)):(a=c.nRadOuter,f=-c.nRadOuter);0<h.x?0<h.y?g[g.length]={index:q,x:h.x,y:h.y,lx:h.lx,ly:h.ly}:e[e.length]=
{index:q,x:h.x,y:-h.y,lx:h.lx,ly:-h.ly}:0<h.y?l[l.length]={index:q,x:-h.x,y:h.y,lx:-h.lx,ly:h.ly}:n[n.length]={index:q,x:-h.x,y:-h.y,lx:-h.lx,ly:-h.ly}}}e.sort(__sortYposUp);g.sort(__sortYposUp);l.sort(__sortYposUp);n.sort(__sortYposUp);b||(b=map.Scale.normalX(12));this.drawTextforOneQuadrant(c,e,b,"text-anchor:start;",1,-1,a,d);this.drawTextforOneQuadrant(c,g,b,"text-anchor:start;",1,1,a,d);this.drawTextforOneQuadrant(c,l,b,"text-anchor:end;",-1,1,-f,d);this.drawTextforOneQuadrant(c,n,b,"text-anchor:end;",
-1,-1,-f,d)};
MapTheme.prototype.createTextLabel=function(c,b,d,a,f,e,g,l,n){var k="#555555",q=!0,h=!0,u=1,w=" "+this.szChartFlag+"|"+this.szFlag;if(w.match(/ZOOM/)||w.match(/MENUSIZE/)||w.match(/NORMSIZE/)||w.match(/INFOSIZE/)||w.match(/AXIS/)||w.match(/SELECTION/))q=g?q:!1,h=!1;w.match(/VALUEBACKGROUND/)&&(q=!0);w.match(/HORZ/)&&(q=!1);isNaN(f)&&(f=14);e||(e="");g&&q?(k=l||ColorScheme.getTextColor(g),u=w.match(/ZOOM/)?.9:.5):(g="#fefeff",k=0>parseFloat(a)?"#ee3333":l);if(c&&b)return c=map.Dom.newGroup(b,d),b=
null,h&&!this.fShadow&&this.fOrigShadow&&(b=map.Dom.newShape("rect",c,1,1,1,1,"fill:#444444;fill-opacity:0.4;stroke:none;")),g=map.Dom.newShape("rect",c,1,1,1,1,"fill:"+g+";fill-opacity:"+u+";stroke:none;stroke-width:"+map.Scale.normalX(.05*f)+""),e=map.Scale.tStyle.Values.szStyle+(this.szTextFont?"font-family:"+this.szTextFont:"")+";font-size:"+map.Scale.normalY(f)+"px;fill:"+k+";fill-opacity:1;"+e,n&&n.match(/\bGLOW\b/)&&map.Dom.newText(c,map.Scale.normalX(f),map.Scale.normalY(.25*f),e+";font-size:"+
map.Scale.normalY(f)+"px;font-weight:normal;fill:none;stroke:white;stroke-width:"+map.Scale.normalY(f)/5+";stroke-opacity:0.8;pointer-events:none;stroke-linejoin:bevel;",a),map.Dom.newText(c,map.Scale.normalX(f),map.Scale.normalY(.25*f),e,a),a=map.Dom.newText(SVGHiddenGroup,map.Scale.normalX(f),map.Scale.normalY(.25*f),e,a),n=a.fu.getBox(),SVGHiddenGroup.removeChild(a),g.setAttributeNS(null,"rx",map.Scale.normalX(.1*f)),g.setAttributeNS(null,"ry",map.Scale.normalX(.1*f)),g.setAttributeNS(null,"x",
n.x-map.Scale.normalX(.3*f)),g.setAttributeNS(null,"y",n.y-map.Scale.normalY(0*f)),g.setAttributeNS(null,"width",n.width+map.Scale.normalX(.7*f)),g.setAttributeNS(null,"height",n.height+.1*map.Scale.normalY(f)),b&&(b.setAttributeNS(null,"rx",map.Scale.normalX(.1*f)),b.setAttributeNS(null,"ry",map.Scale.normalX(.1*f)),b.setAttributeNS(null,"x",n.x-map.Scale.normalX(.3*f)+map.Scale.normalX(.12*f)),b.setAttributeNS(null,"y",n.y+map.Scale.normalY(0*f)+map.Scale.normalY(.12*f)),b.setAttributeNS(null,"width",
n.width+map.Scale.normalX(.7*f)),b.setAttributeNS(null,"height",n.height+.1*map.Scale.normalY(f))),q||(g.style.setProperty("display","none",""),b&&b.style.setProperty("display","none","")),c};
MapTheme.prototype.getOverviewChart=function(c,b){c.fu=new Methods(c);var d=30;this.szChartFlag+="|MENUSIZE";if(this.szOverviewChart&&"NONE"!=this.szOverviewChart&&this.nCount){var d=map.Scale.normalX(100),a=map.Scale.normalY(100),f=map.Scale.normalX(75),e=map.Scale.normalX(50);if("undefined"!=typeof DonutCharts){var g=map.Dom.newGroup(c),d=DonutCharts.newChart(SVGDocument,g,d,a,f,e);this.szOverviewChart.match(/PIE/)&&(d.setStyle("flat"),d.setRadInner(0),d.setRadOuter(map.Scale.normalX(55)),d.setCenter(map.Scale.normalX(80),
map.Scale.normalY(55)));if(this.szOverviewChart.match(/DONUT/)||this.szOverviewChart.match(/3D/))d.setStyle("3D"),d.setCenter(map.Scale.normalX(80),map.Scale.normalY(100));d.setLine("white");d.setLineWidth(map.Scale.normalX(.1));a=map.Scale.normalY(20);for(f=0;f<this.partsA.length;f++){e=this.partsA[f].nCount/this.nCount*100;g=100/this.nSum*this.partsA[f].nSum;this.nRealizedCount&&this.szFlag.match(/CHART/)&&(e=this.partsA[f].nCount/this.nRealizedCount*100);this.nExactCount&&this.exactSizeA&&(e=this.partsA[f].nCount/
this.nExactCount*100,g=this.exactSizeA[f]);this.szOverviewChart.match(/DONUT/)&&(a=map.Scale.normalY(this.partsA[f].nSum/this.nSum*80));var l=String(this.partsA[f].nCount),n=e?String(" = "+this.formatValue(e,1)+" %"):"",k=g?String(", "+this.szLabelA[f]+" => "+this.formatValue(g,1)+""+this.szUnit):"";this.szOverviewChart.match(/PERCENTOFVALUE/)?(e=g,n="",l=this.nExactCount&&this.exactSizeA?String(this.formatValue(e,0)):String(this.formatValue(e,1)+(this.szFlag.match(/CHART/)?this.szUnit:" %"))):this.szOverviewChart.match(/DONUT/)||
(k="");this.szFlag.match(/CATEGORICAL/)?(n+=" ("+this.szLabelA[f]+")",k=""):this.szLegendLabelA&&this.szLegendLabelA.length&&(n+=" ["+this.szLegendLabelA[f]+"])");d.addPart(e,a,this.partsA[f].color,0,l,String(this.partsA[f].nCount)+" member(s)"+n+k,"map.Themes.markClass(evt,'"+this.szId+"','"+f+"')","map.Themes.unmarkClass(evt,'"+this.szId+"')")}d.realize();this.drawDonutText(d);d=map.Dom.getBox(c);if(0<d.width&&0<d.height){k=c.fu.getPosition();g=this.szOverviewChart.match(/PERCENTOFVALUE/)?"*  value / class":
"*  members / class";a=map.Scale.normalY(10);if(this.szOverviewChart.match(/DONUT/)||this.szOverviewChart.match(/3D/))a=map.Scale.normalY(15);map.Dom.newText(c,map.Scale.normalX(80),d.y+d.height+a,map.Scale.tStyle.Note.szStyle+";text-anchor:middle;",g)}}}else{if((this.szFlag.match(/BUBBLE/)||this.szFlag.match(/SQUARE/)||this.szFlag.match(/SYMBOL/))&&(!this.szFlag.match(/CATEGORICAL/)||!this.szFlag.match(/SYMBOL/))){f=this.nMinA[0];l=this.nMaxA[0];this.szSizeField&&(f=this.nMinSize,l=this.nMaxSize);
a=map.Scale.normalX(d/2);e=a/Math.sqrt(l)*Math.sqrt(f);if(this.szFlag.match(/LINEAR/)||this.szFlag.match(/SIZEP1/))e=a/l*f;g=this.szFlag.match(/SUM/)?"sum":"mean";n=5;n=map.Dom.newGroup(c);if(!this.szFlag.match(/CATEGORICAL/)){var q=map.Dom.newGroup(n);this.drawChart(q,null,1.5*d,"VALUES|ZOOM|NORMSIZE");if(this.szFlag.match(/SEQUENCE/)){var h=map.Dom.getBox(q),k=q.fu.getPosition();q.fu.setPosition(h.width/1.5+k.x,-h.height/2+k.y);k=map.Scale.normalX(7*d)/h.height;q.fu.scale(k,k);d*=7}map.Dom.newText(n,
map.Scale.normalX(0),map.Scale.normalY(5),map.Scale.tStyle.Note.szStyle+";text-anchor:left;",map.Dictionary.getLocalText(g));n.fu.setPosition(map.Scale.normalX(20),map.Scale.normalY(d))}this.szFlag.match(/SEQUENCE/)||(g=map.Dom.newGroup(c),n=map.Dom.getBox(n),g.fu.setPosition(n.x+n.width+map.Scale.normalX(.66*d),map.Scale.normalY(-5)),n=0,k="fill:none;stroke:black;stroke-width:"+map.Scale.normalX(.25)+"px",q=map.Dom.newGroup(g),this.szFlag.match(/BUBBLE/)?map.Dom.newShape("circle",q,0,0,a,k):this.szFlag.match(/SQUARE/)&&
map.Dom.newShape("rect",q,-a,-a,2*a,2*a,k),map.Dom.newShape("line",q,0,-a,1.1*a,-a,k),map.Dom.newText(q,1.1*a+map.Scale.normalX(2),-a,"font-family:arial;font-size:"+map.Scale.normalX(10)+"px;text-anchor:left;baseline-shift:-10%;fill:black;stroke:none;pointer-events:none",this.formatValue(l,1)+this.szUnit),q.fu.setPosition(map.Scale.normalX(20),map.Scale.normalY(n+d/2)),0<e&&e!=a&&(l=map.Dom.newGroup(g),this.szFlag.match(/BUBBLE/)?map.Dom.newShape("circle",l,0,0,e,k):this.szFlag.match(/SQUARE/)&&map.Dom.newShape("rect",
l,-e,-e,2*e,2*e,k),map.Dom.newShape("line",l,0,-e,1.1*a,-e,k),map.Dom.newText(l,1.1*a+map.Scale.normalX(2),-e,"font-family:arial;font-size:"+map.Scale.normalX(10)+"px;text-anchor:left;baseline-shift:-60%;fill:black;stroke:none;pointer-events:none",this.formatValue(f,1)+this.szUnit),l.fu.setPosition(map.Scale.normalX(20),map.Scale.normalY(n)+2*a-e)),map.Dom.newText(g,map.Scale.normalX(20),map.Scale.normalY(n+d+15),map.Scale.tStyle.Note.szStyle+";text-anchor:left;",map.Dictionary.getLocalText("min / max size-values")));
c.fu.scale(1,1)}this.szFlag.match(/CHART/)&&this.szFlag.match(/BUFFER/)&&(a=map.Scale.normalX(d/2),f=map.Dom.getBox(c.parentNode),f=0<f.width?f.width/map.Scale.normalX(1)+10:10,q=map.Dom.newGroup(c.parentNode),map.Dom.newShape("circle",q,0,0,a,"fill:none;stroke:black;"),k="fill:none;stroke:black;stroke-width:"+map.Scale.normalX(1)+";",map.Dom.newShape("line",q,0,0,a,0,k),map.Dom.newShape("line",q,0,map.Scale.normalY(-2),0,map.Scale.normalY(2.5),k),map.Dom.newShape("line",q,a,0,a+map.Scale.normalX(-3),
map.Scale.normalY(-3),k),map.Dom.newShape("line",q,a,0,a+map.Scale.normalX(-3),map.Scale.normalY(3),k),map.Dom.newText(q,1.1*a+map.Scale.normalX(2),map.Scale.normalX(-10),"font-family:arial;font-size:"+map.Scale.normalX(10)+"px;text-anchor:left;baseline-shift:-10%;fill:black;stroke:none;pointer-events:none",Map.Scale.prototype.formatDistanceString(this.nBufferSize*this.nScale)),q.fu.setPosition(map.Scale.normalX(d/2+f),map.Scale.normalY(d/2)),a=new Button(c.parentNode,b+":bufferselectbutton","BUTTON",
"#bufferselect_button","map.Selections.newSelection('activeLayer','activeBuffer','type:BUFFER;buffersize:200','test');","","select active layer with this buffer"),a.setPosition(map.Scale.normalX(d+f+10),map.Scale.normalY(d)),a.scale(1.4,1.4),_activeTheme&&map.Dom.newText(c.parentNode,map.Scale.normalX(d+f+20),map.Scale.normalY(d+6),"font-family:arial;font-size:"+map.Scale.normalX(8)+"px;text-anchor:left;baseline-shift:-10%;fill:gray;stroke:none;pointer-events:none","... "+_activeTheme+""));if(!(!this.szFlag.match(/CHART/)||
this.szFlag.match(/BUBBLE/)||this.szFlag.match(/SQUARE/)||this.szFlag.match(/CATEGORICAL/)||this.szFlag.match(/BUFFER/)||this.szFlag.match(/SYMBOL/))){f=map.Dom.getBox(c.parentNode);0>f.width&&(f=new box(0,0,0,0));d=30;this.szFlag.match(/BAR/)&&5<this.nOrigSumA.length&&!this.szFlag.match(/STACKED/)&&(d=15*this.nOrigSumA.length/Math.log(this.nOrigSumA.length));this.drawChart(c,null,d,"VALUES|NORMSIZE"+(this.szFlag.match(/STACKED/)?"|EXPANDMAX":""));d=map.Dom.getBox(c);e=1;e=Math.min(2.5,Math.max(f.height/
d.height,map.Scale.normalX(100)/d.height));c.fu=new Methods(c);c.fu.scale(e,e);a=map.Dom.newGroup(c,"textGroup");a.fu.scale(1/e,1/e);d=c.fu.getBox();this.szFlag.match(/BAR/)?c.fu.setPosition(f.width-d.x+map.Scale.normalX(10),-d.y+Math.max(10,.95*f.height-d.height)):c.fu.setPosition(f.width-d.x+map.Scale.normalX(10),-d.y+Math.max(10,f.height/2-d.height/2));g=" * overall sum";this.szAggregation&&this.szAggregation.match(/mean/)&&(g=" * arithmetic mean");f="middle";if(this.szFlag.match(/RIGHT/)||this.szFlag.match(/STACKED/)||
this.szFlag.match(/CENTER/)||this.szFlag.match(/POINTER/)||2>=this.partsA.length)f="start";map.Dom.newText(a,0,d.height+d.y+map.Scale.normalY(5),map.Scale.tStyle.Note.szStyle+"baseline-shift:-100%;text-anchor:"+f+";",g)}}};
MapTheme.prototype.drawColorSchemeLegend=function(c,b){var d=null,a=map.Scale.nButtonSize?.66*map.Scale.nButtonSize:12,f=map.Scale.nButtonSize||12,e=map.Scale.nButtonSize?1.2*map.Scale.nButtonSize:18,g=e,l="font-family:arial;font-size:"+map.Scale.normalY(a)+"px;fill:#666666;pointer-events:none;",n=1.2*f;this.szFlag.match(/BAR/)&&this.szFlag.match(/\bUP\b/)&&(n=f);var k=1.15*a,q=0*n,h=0;this.szFlag.match(/BAR/)&&(this.szFlag.match(/\bUP\b/)||this.szFlag.match(/STACKED/))&&(h=this.partsA.length-1);
this.showInfoMore||this.szFlag.match(/CATEGORICAL/)||this.szFlag.match(/\bUP\b/)||this.szFlag.match(/SYMBOL/)||this.szLabelA&&!this.szFlag.match(/\bCLIP\b/)||2>=this.partsA.length?this.szLegendStyle="large":this.szLegendStyle="compact";var u=new ScrollArea(null,c,null,10,10,10);u?(u.reformat(),d=u.workspaceNode):d=map.Dom.newGroup(c,b+":legend");for(var w=1,p=0;p<this.partsA.length;p++)this.partsA[p].min&&(this.partsA[p].min.toFixed(0)!=this.partsA[p].min&&(w=Math.min(w,.1)),this.partsA[p].min.toFixed(1)!=
this.partsA[p].min&&(w=Math.min(w,.01)));for(var t=[],p=0;p<this.partsA.length;p++)t[p]={},t[p].i=p,t[p].value=this.partsA[p].nCount;this.szFlag.match(/SYMBOL/)&&this.szFlag.match(/CATEGORICAL/)&&this.szFlag.match(/SORTDOWN/)&&t.sort(this.sortIndexDown);!this.szFlag.match(/POINTER/)&&!this.szFlag.match(/INVERT/)||this.szLegendStyle.match(/compact/)||t.reverse();var M=1;!this.szLabelA&&15<t.length&&(M=Math.floor(t.length/10),f*=1.5);var D=this.showInfoMore&&this.isMarkable?18:10,y=!1;if(this.szFlag.match(/CHART/)&&
1<this.szFieldsA.length&&!this.szFlag.match(/OFFSET/)&&!this.szFlag.match(/DEVIATION/)){for(var m=y=0;m<this.nOrigSumA.length;m++)this.partsA[m]&&"undefined"!=typeof this.partsA[m].nSum&&y++;y=y==this.nOrigSumA.length}for(var v=0;v<t.length;v+=M){var p=t[v].i,A=Math.min(Math.abs(h-p),this.partsA.length-M),B=null,m=null;if(this.szFlag.match(/SYMBOL/)&&this.szFlag.match(/CATEGORICAL/))e=0===this.nSkipCount?3*this.partsA[p].nCount/this.nCount*100:30/this.nCount*10*this.partsA[p].nCount;else if(y){m=
e=0;if(this.szFlag.match(/MORPH/)){for(m=0;m<this.nOrigSumA.length/2;m++)e=Math.max(e,this.nOrigSumA[m]*(this.nClipFrames-1-this.nActualFrame)/(this.nClipFrames-1)+this.nOrigSumA[m+this.nOrigSumA.length/2]*this.nActualFrame/(this.nClipFrames-1));m=(this.nOrigSumA[A]*(this.nClipFrames-1-this.nActualFrame)/(this.nClipFrames-1)+this.nOrigSumA[A+this.nOrigSumA.length/2]*this.nActualFrame/(this.nClipFrames-1))/e}else{for(m=0;m<this.nOrigSumA.length;m++)e=Math.max(e,this.partsA[m].nSum);m=this.partsA[A].nSum/
e}e=60*m}e=isNaN(e)?g:e;if(this.szFlag.match(/BUBBLE/))m=this.szFlag.match(/CATEGORICAL/)||this.szSizeField?f/2:f/4+f/4*(p+1)/this.partsA.length,m=map.Dom.newShape("circle",d,map.Scale.normalX(D+f/2),map.Scale.normalY(q+f/2),map.Scale.normalY(m),"fill:"+this.colorScheme[A]+";stroke:#eeeeee;stroke-width:"+map.Scale.normalX(.1)+";");else if(1<M)for(var m=map.Dom.newGroup(d,""),x=0;x<M;x++)map.Dom.newShape("rect",m,map.Scale.normalX(D),map.Scale.normalY(q+f/M*x),map.Scale.normalX(e),map.Scale.normalY(f/
M),"fill:"+this.colorScheme[A+x]+";stroke:none;");else m=map.Dom.newShape("rect",d,map.Scale.normalX(D),map.Scale.normalY(q),map.Scale.normalX(e),map.Scale.normalY(f),"fill:"+this.colorScheme[A]+";stroke:#eeeeee;stroke-width:"+map.Scale.normalX(.1)+";");if(m){for(var Fa=this.partsA[A].nCount,x=1;x<M;x++)Fa+=this.partsA[A+x].nCount;this.isMarkable&&this.showInfoMore&&(map.Dom.newShape("rect",d,map.Scale.normalX(-5),map.Scale.normalY(q-2),map.Scale.normalX(e),map.Scale.normalY(f+4),"fill:white;stroke:none;opacity:0;").setAttributeNS(null,
"id",this.szId+":widget:background:"+A),x=new Button(d,this.szId+":class:"+A,"CHECKBOX|SELECTED","","map.Themes.showClass(evt,'"+this.szId+"','"+A+"','"+M+"')","map.Themes.hideClass(evt,'"+this.szId+"','"+A+"','"+M+"')","show/hide class"),x.setPosition(map.Scale.normalX(map.Scale.nButtonSize/2-1),map.Scale.normalY(q+map.Scale.nButtonSize/2-1)),x.scale(.75,.75));var B=this.partsA[A].min+(v?w:0),x=this.partsA[A+M-1].max,ka=100<x-B?0:2,B=this.formatValue(B,ka),ka=this.formatValue(x,ka),ha="";this.szFlag.match(/SHOWMEMBERS/)&&
(ha="  ["+Fa+"]");x="";x=B!=ka?B+"..."+ka+(this.szLegendUnits?this.szLegendUnits:"")+this.szUnit+ha:B+(this.szLegendUnits?this.szLegendUnits:"")+this.szUnit+ha;(!this.szFlag.match(/\bCLIP\b/)||this.szFlag.match(/MORPH/))&&this.szLabelA&&this.szLabelA[A]&&(x=this.szLabelA[A]);this.szLegendLabelA[A]=x;if(this.szLegendStyle.match(/compact/))this.fGrayNoMember&&0===Fa&&this.szFlag.match(/CHOROPLETH/)&&this.szFlag.match(/DOMINANT/)&&(m.style.setProperty("fill-opacity","0.03",""),m.style.getPropertyValue("fill"),
m.style.setProperty("stroke-opacity","0.2",""),m.style.setProperty("stroke","black",""),m.style.setProperty("stroke-width",map.Scale.normalX(.3),"")),this.szFlag.match(/CATEGORICAL/)||this.szFlag.match(/DOMINANT/)&&15<x.length||(ha=";font-size:"+map.Scale.normalX(.9*a)+"px;",0===v?(x=0<x.length?B+this.szUnit:x,map.Dom.newText(d,map.Scale.normalX(D+2),map.Scale.normalY(q+k*(M+1.5)),l+ha,x)):v==t.length-M&&(x=0<x.length?ka+this.szUnit:x,map.Dom.newText(d,map.Scale.normalX(D+2),map.Scale.normalY(q+k*
(M+1.5)),l+ha,x)));else if(this.szFlag.match(/SYMBOL/)&&this.szFlag.match(/CATEGORICAL/))B=e+2,ka=String(this.partsA[p].nCount),0===this.nSkipCount&&(ka=String(Math.round(100/this.nCount*this.partsA[p].nCount))+"%"),ha=5*ka.length/7*a,"dynamic"==this.szTextPlacement&&ha<e&&(B-=5*String(this.partsA[p].nCount).length/7*a),map.Dom.newText(d,map.Scale.normalX(D+B),map.Scale.normalY(q+k+1),l,ka),B+=ha,this.szSymbolsA[p]&&this.szSymbolsA[p].match(/symbol/)&&(ka=map.Dom.constructNode("use",d,{"xlink:href":"#"+
this.szSymbolsA[p]+":antizoomandpan"}),ka.setAttributeNS(null,"style","fill:"+this.colorScheme[A]),ka.fu.scale(.5,.5),ka.fu.setPosition(map.Scale.normalX(D+B+10),map.Scale.normalY(q+k-3)),B+=20),B=map.Dom.newText(d,map.Scale.normalX(D+B),map.Scale.normalY(q+k),l,"("+x+")"),B.style.setProperty("fill","#bbbbdd","");else{B=e+4;if(y){ka=this.partsA[A].nSum;this.szFlag.match(/MORPH/)&&(ka=this.nOrigSumA[A]*(this.nClipFrames-1-this.nActualFrame)/(this.nClipFrames-1)+this.nOrigSumA[A+this.nOrigSumA.length/
2]*this.nActualFrame/(this.nClipFrames-1));if(this.szField100&&!this.szFlag.match(/SUM/)||this.szAggregation&&!this.szAggregation.match(/sum/))ka/=this.partsA[A].nCount;x=x+"  ("+this.formatValue(ka,1)+this.szUnit+")"}B=map.Dom.newText(d,map.Scale.normalX(D+B),map.Scale.normalY(q+k),l,x);this.fGrayNoMember&&0===Fa&&this.szFlag.match(/CHOROPLETH/)&&(B.style.setProperty("fill","#bbbbdd",""),m.style.setProperty("opacity","0.1",""))}this.szFlag.match(/BUFFER/)&&m.style.setProperty("fill-opacity",this.fillOpacity?
this.fillOpacity:this.nOpacity?this.nOpacity:0,"");1==this.szFieldsA.length||!this.szFlag.match(/CHART/)||this.szFlag.match(/SYMBOL/)&&this.szFlag.match(/CATEGORICAL/)?(this.szLegendStyle.match(/compact/)?m.setAttributeNS(szMapNs,"tooltip",x+" ("+Fa+" member(s))"):m.setAttributeNS(szMapNs,"tooltip",Fa+" member(s)"),p=m.getAttributeNS(null,"style"),m.setAttributeNS(szMapNs,"onoverstyle",p+";stroke:black;stroke-width:"+map.Scale.normalX(.5)+";"),m.setAttributeNS(null,"onmouseover","map.Themes.markClass(evt,'"+
this.szId+"','"+A+"','"+M+"')"),m.setAttributeNS(null,"onmouseout","map.Themes.unmarkClass(evt,'"+this.szId+"')"),m.setAttributeNS(null,"onclick","map.Themes.zoomToClass(evt,'"+this.szId+"','"+A+"','"+M+"')"),m.setAttributeNS(null,"id",b+":widget:classrect:"+A)):this.szFlag.match(/SYMBOL/)?this.szFlag.match(/CATEGORICAL/)?m.setAttributeNS(szMapNs,"tooltip",this.partsA[p].nCount+" ("+this.formatValue(this.partsA[p].nCount/this.nCount*100,1)+" %)"):this.szFlag.match(/SEQUENCE/)&&m.setAttributeNS(szMapNs,
"tooltip",this.nOrigSumA[p]+" ("+this.formatValue(this.nOrigSumA[p]/this.nSum*100,1)+" %)"):1<this.szFieldsA.length&&!this.szFlag.match(/SEQUENCE/)&&(this.nSum100?m.setAttributeNS(szMapNs,"tooltip",this.formatValue(100/this.nSum100*this.nOrigSumA[A],1)+" %"):this.nSum&&m.setAttributeNS(szMapNs,"tooltip",this.nOrigSumA[A]+" ("+this.formatValue(100/this.nSum*this.nOrigSumA[A],1)+" %)"),m.setAttributeNS(null,"onmouseover","map.Themes.markClass(evt,'"+this.szId+"','"+A+"','"+M+"')"),m.setAttributeNS(null,
"onmouseout","map.Themes.unmarkClass(evt,'"+this.szId+"')"))}this.szLegendStyle.match(/compact/)?D+=e:q+=9*n/10}this.szLegendStyle.match(/compact/)?q+=n*M*2:this.nNoData&&(q+=1.5*n/10,m=map.Dom.newShape("rect",d,0,map.Scale.normalY(q),map.Scale.normalX(e),map.Scale.normalY(f),"fill:"+(this.szNoDataColor?this.szNoDataColor:"#ffffff")+";stroke:#000000;stroke-width:"+map.Scale.normalX(.1)+";"),m.setAttributeNS(szMapNs,"tooltip",this.nNoData+" member(s)"),m.setAttributeNS(null,"onmouseover","map.Themes.markClass(evt,'"+
this.szId+"','"+A+"')"),m.setAttributeNS(null,"onmouseout","map.Themes.unmarkClass(evt,'"+this.szId+"')"),map.Dom.newText(d,map.Scale.normalX(22),map.Scale.normalY(q+k),l,map.Dictionary.getLocalText("no data")),q+=9*n/10);u&&(u.setWidth(-1),u.setHeight(Math.min(q+n,map.Scale.bBox.height/map.Scale.normalY(2.2))),this.nClipColorLegend&&u.setHeight(this.nClipColorLegend),u.reformat(),u.hasScrollBars()&&(d.style.setProperty("display","none",""),map.Dom.newShape("rect",c,0,0,map.Scale.normalX(u.getWidth()),
map.Scale.normalY(u.getHeight()),"fill:none;stroke:none;")));return d};MapTheme.prototype.showInfo=function(){};
MapTheme.prototype.chartButton=function(c,b,d){c=map.Dom.newGroup(c,"chartvari"+String(Math.random()));var a=this.szFlag;"2D"==d&&this.removeDefinitionFromFlag("3D");this.szFlag+="|NORMSIZE|SILENT|MENUSIZE|"+d;this.drawChart(c,null,b);this.szFlag=a;a=map.Dom.getBox(c);this.addChartTypeSign(c,d);d=Math.min(map.Scale.normalX(b)/a.width,map.Scale.normalY(b)/a.height);c.fu.scale(d,d);c.fu.setPosition(map.Scale.normalX(b+10),map.Scale.normalY(b)*d);return c};
MapTheme.prototype.addDefinitionToFlag=function(c){return this.szFlag=this.szFlag+"|"+c};MapTheme.prototype.removeDefinitionFromFlag=function(c){for(var b="",d=this.szFlag.split("|"),a=0;a<d.length;a++)d[a]!=c&&(b+=(b.length?"|":"")+d[a]);return this.szFlag=b};MapTheme.prototype.removeDefinition=function(c,b){for(var d="",a=c.split("|"),f=0;f<a.length;f++)a[f]!=b&&(d+=(d.length?"|":"")+a[f]);return d};
MapTheme.prototype.addChartTypeSign=function(c,b){var d="M0,0 l"+map.Scale.normalX(1.5)+",-"+map.Scale.normalX(1.5)+" 0,"+map.Scale.normalX(3)+" -"+map.Scale.normalX(1.5)+",-"+map.Scale.normalX(1.5)+" M"+map.Scale.normalX(2.5)+",0 l"+map.Scale.normalX(17.5)+",0 M"+map.Scale.normalX(22.5)+",0 l-"+map.Scale.normalX(1.5)+",-"+map.Scale.normalX(1.5)+" 0,"+map.Scale.normalX(3)+" "+map.Scale.normalX(1.5)+",-"+map.Scale.normalX(1.5)+"";if(b.match(/SIZE/)){var a=map.Dom.newGroup(c,"");map.Dom.newShape("path",
a,d,"stroke:white;stroke-width:"+map.Scale.normalX(4)+";stroke-opacity:0.5;stroke-linejoin:miter;stroke-linecap:square;");map.Dom.newShape("path",a,d,"stroke:#666666;stroke-width:"+map.Scale.normalX(1.5)+";stroke-linejoin:miter;stroke-linecap:square;");a.fu.setPosition(-map.Scale.normalX(10),map.Scale.normalX(-5))}b.match(/HEIGHT/)&&(a=map.Dom.newGroup(c,""),map.Dom.newShape("path",a,d,"stroke:white;stroke-width:"+map.Scale.normalX(4)+";stroke-opacity:0.5;stroke-linejoin:miter;stroke-linecap:square;"),
map.Dom.newShape("path",a,d,"stroke:#666666;stroke-width:"+map.Scale.normalX(1.5)+";stroke-linejoin:miter;stroke-linecap:square;"),a.setAttributeNS(null,"transform","translate(0,"+-map.Scale.normalX(25)+") rotate(90)"))};
MapTheme.prototype.getChartTypeMenu=function(c,b,d){if("undefined"==typeof a)var a="CHART|BAR CHART|BAR|3D CHART|BAR|3D|SORT CHART|BAR|HORZ|LEFT|UP CHART|BAR|HORZ|RIGHT|UP CHART|BAR|HORZ|LEFT|UP|COMPRESS CHART|BAR|HORZ|RIGHT|UP|COMPRESS CHART|BAR|HORZ|LEFT|UP|3D CHART|BAR|HORZ|RIGHT|UP|3D CHART|BAR|HORZ|LEFT|UP|COMPRESS|3D CHART|BAR|HORZ|RIGHT|UP|COMPRESS|3D CHART|BAR|HORZ|CENTER|UP CHART|BAR|STACKED CHART|BAR|STACKED|3D CHART|BAR|SORT|3D|COLUMNS|STACKED CHART|BAR|SORT|3D|COLUMNS|STACKED|SIZE CHART|PIE CHART|PIE|SIZE CHART|PIE|3D CHART|PIE|3D|SIZE CHART|PIE|3D|HEIGHT CHART|PIE|3D|VOLUME CHART|PIE|DONUT CHART|PIE|DONUT|SIZE CHART|PIE|DONUT|3D CHART|PIE|DONUT|3D|SIZE CHART|PIE|DONUT|3D|HEIGHT CHART|PIE|DONUT|3D|VOLUME CHART|PIE|STARBURST CHART|PIE|STARBURST|SIZE CHART|PIE|STARBURST|3D CHART|PIE|STARBURST|3D|SIZE CHART|PIE|STARBURST|3D|HEIGHT CHART|PIE|STARBURST|3D|VOLUME CHART|PIE|DONUT|STARBURST CHART|PIE|DONUT|STARBURST|SIZE CHART|PIE|DONUT|STARBURST|3D CHART|PIE|DONUT|STARBURST|3D|SIZE CHART|PIE|DONUT|STARBURST|3D|HEIGHT CHART|PIE|DONUT|STARBURST|3D|VOLUME".split(" ");if("undefined"==
typeof f)var f="CHART|BAR CHART|BAR|VALUES CHART|BAR|3D CHART|BAR|3D|VALUES CHART|BAR|3D|VOLUME CHART|BAR|3D|VOLUME|VALUES CHART|BAR|HORZ|RIGHT|UP CHART|BAR|HORZ|RIGHT|UP|VALUES CHART|BAR|HORZ|RIGHT|UP|3D CHART|BAR|HORZ|RIGHT|UP|VALUES|3D CHART|BAR|POINTER CHART|BAR|POINTER|VALUES CHART|BUBBLE|SURFACE CHART|BUBBLE|SURFACE|VALUES CHART|SQUARE|SURFACE CHART|SQUARE|SURFACE|VALUES".split(" ");if("undefined"==typeof e)var e="CHOROPLETH CHART|BUBBLE CHART|SQUARE CHART|PIE|3D|SIZE CHART|PIE|3D|HEIGHT CHART|PIE|3D|SIZE|HEIGHT CHART|BAR|3D|VOLUME CHART|BAR CHART|BAR|3D CHART|BAR|3D|SIZE CHART|BAR|HORZ|RIGHT|UP CHART|BAR|HORZ|RIGHT|UP|3D CHART|BAR|POINTER CHART|BAR|POINTER|SIZE CHART|BAR|HORZ|RIGHT|UP|POINTER CHART|LABEL".split(" ");
b=this.szOrigFlag;if(1<this.szFieldsA.length||this.szFlag.match(/CATEGORICAL/)&&this.szFlag.match(/AGGREGATE/))e=a;d=d?d/60:3;for(a=0;a<e.length;a++){var f=this.szFlag,g=map.Dom.constructNode("a",c,{});map.Dom.newShape("rect",g,map.Scale.normalX(a%d*60),map.Scale.normalY(60*Math.floor(a/d)),map.Scale.normalX(60),map.Scale.normalY(60),"fill:#f8f8ff;stroke:lightgray;stroke-dasharray:50 50;stroke-width:"+map.Scale.normalX(1)+";");var l=map.Dom.newGroup(g,"szDisplayId:chart:"+String(Math.random()));map.Dom.setClipRect(l,
new box(-map.Scale.normalX(25),-map.Scale.normalX(60),map.Scale.normalX(60),map.Scale.normalX(60)));this.szFlag=e[a]+"|NORMSIZE|SILENT|MENUSIZE";f.match(/CATEGORICAL/)&&(this.szFlag+="|CATEGORICAL");f.match(/GROUP/)&&(this.szFlag+="|GROUP");f.match(/AGGREGATE/)&&(this.szFlag+="|AGGREGATE");f.match(/COMPATIBLE/)&&(this.szFlag+="|COMPATIBLE");f.match(/FAST/)&&(this.szFlag+="|FAST");f.match(/RELOCATE/)&&(this.szFlag+="|RELOCATE");f.match(/DIFFERENCE/)&&(this.szFlag+="|DIFFERENCE");f.match(/FRACTION/)&&
(this.szFlag+="|FRACTION");f.match(/INVERT/)&&(this.szFlag+="|INVERT");f.match(/INVERTSIZE/)&&(this.szFlag+="|INVERTSIZE");f.match(/RELATIVE/)&&(this.szFlag+="|RELATIVE");f.match(/DENSITY/)&&(this.szFlag+="|DENSITY");f.match(/DOPACITYMAX/)?this.szFlag+="|DOPACITYMAX":f.match(/DOPACITYLOGMAX/)?this.szFlag+="|DOPACITYLOGMAX":f.match(/DOPACITYPOWMAX/)?this.szFlag+="|DOPACITYPOWMAX":f.match(/DOPACITYMEAN/)?this.szFlag+="|DOPACITYMEAN":f.match(/DOPACITYLOGMEAN/)?this.szFlag+="|DOPACITYLOGMEAN":f.match(/DOPACITYPOWMEAN/)?
this.szFlag+="|DOPACITYPOWMEAN":f.match(/DOPACITYLOG/)?this.szFlag+="|DOPACITYLOG":f.match(/DOPACITY/)&&(this.szFlag+="|DOPACITY");f.match(/AUTO100/)&&(this.szFlag+="|AUTO100");f.match(/AUTOCOMPLETE/)&&(this.szFlag+="|AUTOCOMPLETE");var n=this.szAggregation,k=this.nClipParts;this.nClipParts=10;var q=this.drawChart(l,null,40);"undefined"===typeof k?delete this.nClipParts:this.nClipParts=k;this.szAggregation=n;if(q){this.szFlag=f;var h=map.Scale.normalX(10);q.x-=map.Scale.normalX(60/d);l.fu.setPosition(h-
q.x+a%d*map.Scale.normalX(60),map.Scale.normalY(40)+h+q.y+Math.floor(a/d)*map.Scale.normalY(60));l.setAttributeNS(null,"clip-path","");h=900/Math.max(l.fu.getBox().width,l.fu.getBox().height);1>h&&l.fu.scale(h,h);h="";b.match(/UNDEFINEDISVALUE/)&&(h+="|UNDEFINEDISVALUE");b.match(/ZEROISVALUE/)&&(h+="|ZEROISVALUE");b.match(/NEGATIVEISVALUE/)&&(h+="|NEGATIVEISVALUE");b.match(/NONEGATIVE/)&&(h+="|NEGATIVEISVALUE");b.match(/GROUP/)&&(h+="|GROUP");b.match(/AGGREGATE/)&&(h+="|AGGREGATE");b.match(/COMPATIBLE/)&&
(h+="|COMPATIBLE");b.match(/FAST/)&&(h+="|FAST");b.match(/\bRECT\b/)&&(h+="|RECT");b.match(/HEX/)&&(h+="|HEX");b.match(/RELOCATE/)&&(h+="|RELOCATE");b.match(/CATEGORICAL/)&&(h+="|CATEGORICAL");b.match(/SUM/)&&(h+="|SUM");b.match(/MEAN/)&&(h+="|MEAN");b.match(/DIFFERENCE/)&&(h+="|DIFFERENCE");b.match(/RELATIVE/)&&(h+="|RELATIVE");b.match(/INVERT/)&&(h+="|INVERT");b.match(/INVERTSIZE/)&&(h+="|INVERTSIZE");b.match(/CALCMEAN/)&&(h+="|CALCMEAN");b.match(/CALC100/)&&(h+="|CALC100");b.match(/PRODUCT/)&&
(h+="|PRODUCT");b.match(/AUTOCOMPLETE/)&&(h+="|AUTOCOMPLETE");b.match(/AUTO100/)&&(h+="|AUTO100");b.match(/QUANTILE/)&&(h+="|QUANTILE");b.match(/DENSITY/)&&(h+="|DENSITY");b.match(/DOPACITY/)&&(h+="|DOPACITY");if(b.match(/VALUES/)||f.match(/VALUES/))h+="|VALUES";b.match(/VALUEBACKGROUND/)&&(h+="|VALUEBACKGROUND");e[a].match(/SIZE/)&&(f.match(/SIZELOG/)?h+="|SIZELOG":f.match(/SIZEP4/)?h+="|SIZEP4":f.match(/SIZEP3/)?h+="|SIZEP3":f.match(/SIZE/)&&(h+="|SIZE"));f.match(/SPACED/)&&(h+="|SPACED");g.setAttributeNS(null,
"onclick","map.Themes.changeThemeStyle(evt,'"+this.szId+"','type:"+e[a]+h+"')");this.addChartTypeSign(l,e[a])}}c=[];for(var u in e)c.push(e[u]+h);return c};MapTheme.prototype.formatValue=function(c,b,d){return isNaN(c)?c:999<this.nMin&&3E3>this.nMax?__formatValue(c,b,d+"|NOBREAKS"):__formatValue(c,b,d)};MapTheme.prototype.remove=function(c){this.parent.removeTheme(c,this.szId)};
MapTheme.prototype.removeElements=function(c){this.widgetNode&&(widgetList.removeWidget(this.widgetNode),this.widgetNode.parentNode.removeChild(this.widgetNode),this.widgetNode=null);this.clipTimeout&&clearTimeout(this.clipTimeout);this.unpaintMap();this.clearWMS();this.szFlag.match(/FEATURE/)&&this.chartGroup&&(c=SVGDocument.getElementById(this.chartGroup.getAttributeNS(null,"id")+":label"),this.chartGroup.parentNode.removeChild(c),this.chartGroup.parentNode.removeChild(this.chartGroup));if(this.onremove)try{eval(this.onremove)}catch(b){}try{HTMLWindow.ixmaps.htmlgui_onRemoveTheme(this.szId)}catch(d){}};
MapTheme.prototype.removeMapThemeStyles=function(c){c=c.split("|");for(var b=SVGRootElement.getElementsByTagName("path"),d=0;d<b.length;d++)if(1==b.item(d).nodeType){var a=b.item(d).parentNode.getAttributeNS(null,"id"),f=!1;if(a&&0!==a.length)for(var a=map.Tiles.getMasterId(a).split(":")[0],e=0;e<c.length;e++)a==c[e]&&(f=!0);f&&b.item(d).parentNode.removeAttributeNS(null,"style")}};
MapTheme.prototype.disable=function(){if(!this.szFlag.match(/CHART/)&&this.widgetNode)for(var c=this.widgetNode.getElementsByTagName("g"),b=0;b<c.length;b++)c.item(b).setAttributeNS(null,"opacity","0.9")};MapTheme.prototype.enable=function(){if(this.widgetNode){for(var c=this.widgetNode.getElementsByTagName("g"),b=0;b<c.length;b++)c.item(b).setAttributeNS(null,"opacity","1.0");this.widgetNode.parentNode.appendChild(this.widgetNode)}map.Themes.setActive(this)};
MapTheme.prototype.makeVisible=function(){for(var c=0;c<this.szThemesA.length;c++)map.Layer.isLayerOn(this.szThemesA[c])||map.Layer.isScaleDependentLayer(this.szThemesA[c])||(map.Themes.switchedLayerA[this.szThemesA[c]]=!0,map.Api.switchMapTheme(this.szThemesA[c],"on")),map.Tiles.switchScaleDependentTiles()};
MapTheme.prototype.checkVisible=function(){for(var c=0;c<this.szThemesA.length;c++)map.Themes.isThemeLayerUsed(this.szThemesA[c])&&this.isVisible||!map.Themes.switchedLayerA[this.szThemesA[c]]||(map.Api.switchMapTheme(this.szThemesA[c],"off"),map.Themes.switchedLayerA[this.szThemesA[c]]=null)};
MapTheme.prototype.resize=function(c){999!=c&&(this.nScale*=c);if(this.szFlag.match(/BUFFER/)&&this.szShapeType.match(/line/))this.fRedrawInfo=this.fRedraw=!0,this.nSkipCount=1,map.Themes.execute();else{map.Layer.changeObjectScaling(null,c,this.chartGroup);this.szFlag.match(/DECLUTTER/)&&this.declutterCharts();if(this.szFlag.match(/BUFFER/))for(var b=this.chartGroup.getElementsByTagName("circle"),d=0;d<b.length;d++){var a=b.item(d).getAttributeNS(null,"style");a&&a.length&&(a=__scaleStyleString(a,
1/c),b.item(d).setAttributeNS(null,"style",a))}this.f=!0;this.showInfo()}};MapTheme.prototype.offset=function(c){var b=this.chartGroup.fu.getPosition();this.chartGroup.fu.setPosition(b.x+c.x,b.y+c.y)};
MapTheme.prototype.opacity=function(c){this.fillOpacity=(this.fillOpacity?this.fillOpacity:1)*c;this.fillOpacity=Math.min(1,this.fillOpacity);this.fillOpacity=Math.max(0,this.fillOpacity);this.nOpacity=(this.nOpacity?this.nOpacity:1)*c;this.nOpacity=Math.min(1,this.nOpacity);this.nOpacity=Math.max(0,this.nOpacity);if(this.chartGroup)for(var b=this.chartGroup.childNodes,d=0;d<b.length;d++)map.Layer.changeNodeOpacity(b.item(d),c);else if(this.szShapeType.match(/line/))for(d=0;d<this.szThemesA.length;d++)map.Layer.changeLayerOpacity(this.szThemesA[d],
c);else for(b in this.itemA)for(var d=this.getItemNodes(b),a=0;a<d.length;a++)map.Layer.changeNodeOpacity(d[a],c,"fill-opacity")};
MapTheme.prototype.blur=function(c){if(this.chartGroup)if(this.nBlur){var b="blur-3",d=SVGDocument.getElementById(b);d?d.firstChild.setAttributeNS(null,"stdDeviation",map.Scale.normalX(c)):(d=map.Dom.newNode("filter",this.chartGroup.parentNode),d.setAttributeNS(null,"id",b),d=map.Dom.newNode("feGaussianBlur",d),d.setAttributeNS(null,"stdDeviation",map.Scale.normalX(c)));this.chartGroup.style.setProperty("filter","url(#"+b+")","")}else this.chartGroup.style.removeProperty("filter");else if(this.szThemesA[0]){var a=
SVGDocument.getElementById("maplayer");a&&(this.nBlur?(b="blur-map",(d=SVGDocument.getElementById(b))?d.firstChild.setAttributeNS(null,"stdDeviation",map.Scale.normalX(c)/map.Zoom.nZoom):(d=map.Dom.newNode("filter",a.parentNode),d.setAttributeNS(null,"id",b),d.setAttributeNS(null,"x",0),d.setAttributeNS(null,"y",0),d.setAttributeNS(null,"width","100%"),d.setAttributeNS(null,"height","100%"),d=map.Dom.newNode("feGaussianBlur",d),d.setAttributeNS(null,"stdDeviation",map.Scale.normalX(c)/map.Zoom.nZoom)),
a.style.setProperty("filter","url(#"+b+")","")):a.style.removeProperty("filter"))}};
MapTheme.prototype.toggle=function(c){this.chartGroup?!0===c||"undefined"==typeof c&&"none"==this.chartGroup.style.getPropertyValue("display")?(this.chartGroup.style.setProperty("display","inline",""),this.chartGroup.display="inline",this.isChecked=!0):(this.chartGroup.style.setProperty("display","none",""),this.chartGroup.display="none",this.isChecked=!1):this.isChecked?(this.unpaintMap(),this.isChecked=!1,map.Themes.activateNextPaint(this)&&(this.fToggle=!1,map.Themes.execute(),this.widgetNode&&
(this.widgetNode.setAttributeNS(null,"opacity","1.0"),this.widgetNode.parentNode.appendChild(this.widgetNode)))):(this.fRedraw=this.isChecked=!0,this.fToggle=!1,map.Themes.execute())};MapTheme.prototype.getHistogram=function(c,b,d){map.Themes.getHistogram(c,b,d,this)};var __maptheme_chartcolors=[];function __maptheme_getChartColors(c){__maptheme_chartcolors[c]||(__maptheme_chartcolors[c]=new ChartColors(c));return __maptheme_chartcolors[c]}
function ChartColors(c){"string"!=typeof c&&(c="#ffffff");this.mainColor=c;this.lowColor=ColorScheme.getDerivateColor(c,.7);this.highColor=ColorScheme.getDerivateColor(c,1.3);this.borderColor=ColorScheme.getBorderColor(c);this.textColor=ColorScheme.getTextColor(c)}function __mpap_hex2dec(c){return parseInt(c,16)}
function __mpap_decode_utf8(c){if("string"==typeof c&&c.match(/&#x/)){var b="";c=c.split("&#x");for(var b=c[0],d=1;d<c.length;d++)b+=String.fromCharCode(__mpap_hex2dec(c[d].substr(0,2))),b+=c[d].substr(3,c[d].length-3);return b}return c};
