var themeStyleTranslateA=[{style:"opacity",obj:"nOpacity"},{style:"fillopacity",obj:"fillOpacity"},{style:"autoopacity",obj:"autoOpacity"},{style:"shadow",obj:"fOrigShadow"},{style:"blur",obj:"nBlur"},{style:"filter",obj:"szFilter"},{style:"dfilter",obj:"nDeltaFilter"},{style:"filterfield",obj:"szFilterField"},{style:"dbtable",obj:"coTable"},{style:"dbtableUrl",obj:"coTableUrl"},{style:"dbtableType",obj:"coTableType"},{style:"dbtableExt",obj:"coTableExt"},{style:"datacache",obj:"fDataCache"},{style:"itemfield",
obj:"szItemField"},{style:"lookupfield",obj:"szSelectionField"},{style:"lookuptoupper",obj:"fSelectionFieldToUpper"},{style:"lookupsuffix",obj:"szSelectionFieldSuffix"},{style:"lookupdigits",obj:"nSelectionFieldDigits"},{style:"lookuptonumber",obj:"fSelectionFieldToNumber"},{style:"lookupfield2",obj:"szSelectionField2"},{style:"showdata",obj:"fShowData"},{style:"datafields",obj:"szDataFieldsA",type:"array"},{style:"userdraw",obj:"userDraw"},{style:"child",obj:"fChild"},{style:"crsdatum",obj:"szCRSDatum"},
{style:"crsutmzone",obj:"szCRSUTMZone"},{style:"ranges",obj:"szRangesA",type:"array"},{style:"rangecentervalue",obj:"nRangeCenterValue"},{style:"symbols",obj:"szSymbolsA",type:"array"},{style:"values",obj:"szValuesA",type:"array",delimiter:"|"},{style:"colorvalues",obj:"szColorValuesA",type:"array",delimiter:"|"},{style:"symbolvalues",obj:"szSymbolValuesA",type:"array",delimiter:"|"},{style:"label",obj:"szOrigLabelA",type:"array",delimiter:"|"},{style:"valuemap",obj:"valueMap",type:"object"},{style:"xaxis",
obj:"szXaxisA",type:"array"},{style:"units",obj:"szUnits"},{style:"labelunits",obj:"szLabelUnits"},{style:"units100",obj:"szUnits100"},{style:"sizevalueunits",obj:"szSizeValueUnits"},{style:"alphavalueunits",obj:"szAlphaValueUnits"},{style:"legendunits",obj:"szLegendUnits"},{style:"weights",obj:"szWeights"},{style:"align",obj:"szAlign"},{style:"refreshtimeout",obj:"nRefreshTimeout"},{style:"normalsizevalue",obj:"nNormalSizeValue"},{style:"normalsizescale",obj:"szNormalSizeScale"},{style:"scale",obj:"nScale"},
{style:"rangescale",obj:"nRangeScale"},{style:"sizepow",obj:"nSizePow"},{style:"colorfield",obj:"szColorField"},{style:"symbolfield",obj:"szSymbolField"},{style:"valuefield",obj:"szValueField"},{style:"labelfield",obj:"szLabelField"},{style:"sizefield",obj:"szSizeField"},{style:"timefield",obj:"szTimeField"},{style:"alphafield",obj:"szAlphaField"},{style:"alphafield100",obj:"szAlphaField100"},{style:"xfield",obj:"szXField"},{style:"yfield",obj:"szYField"},{style:"dopacitypow",obj:"nDopacityPow"},
{style:"dopacityramp",obj:"szDopacityRamp"},{style:"dopacityscale",obj:"nDopacityScale"},{style:"brightness",obj:"nBrightness"},{style:"buffersize",obj:"nBufferSize"},{style:"bufferstep",obj:"nBufferSizeStep"},{style:"field100min",obj:"nField100Min"},{style:"fractionscale",obj:"nFractionScale"},{style:"minvalue",obj:"nMinValue"},{style:"maxvalue",obj:"nMaxValue"},{style:"textfont",obj:"szTextFont"},{style:"textcolor",obj:"szTextColor"},{style:"linecolor",obj:"szLineColor"},{style:"linecolor",obj:"szLineColorA",
type:"array"},{style:"linewidth",obj:"nLineWidth"},{style:"markersize",obj:"nMarkerSize"},{style:"gapsize",obj:"nGapSize"},{style:"bordercolor",obj:"szBorderColor"},{style:"borderstyle",obj:"szBorderStyle"},{style:"borderwidth",obj:"szBorderWidth"},{style:"borderradius",obj:"nBorderRadius"},{style:"boxcolor",obj:"szBoxColor"},{style:"boxopacity",obj:"nBoxOpacity"},{style:"boxmargin",obj:"nBoxMargin"},{style:"textplacement",obj:"szTextPlacement"},{style:"infotitle",obj:"szInfoTitle"},{style:"titlefield",
obj:"szTitleField"},{style:"snippetfield",obj:"szSnippetField"},{style:"exclude",obj:"szExcludeA",type:"array"},{style:"nodatacolor",obj:"szNoDataColor"},{style:"titleupper",obj:"szTitleUpper"},{style:"labelupper",obj:"szLabelUpper"},{style:"valueupper",obj:"szValueUpper"},{style:"glowupper",obj:"szGlowUpper"},{style:"glowlower",obj:"szGlowLower"},{style:"chartupper",obj:"szChartUpper"},{style:"chartlower",obj:"szChartLower"},{style:"boxupper",obj:"szBoxUpper"},{style:"shadowupper",obj:"szShadowUpper"},
{style:"shadowlower",obj:"szShadowLower"},{style:"declutterupper",obj:"szDeclutterUpper"},{style:"valuescale",obj:"nValueScale"},{style:"minvaluesize",obj:"nValueSizeMin"},{style:"valuedecimals",obj:"szValueDecimals"},{style:"fadevaluepow",obj:"szFadeValuePow"},{style:"fadenegative",obj:"nFadeNegative"},{style:"centerpart",obj:"szCenterPart"},{style:"clipframes",obj:"nClipFrames"},{style:"clipframerate",obj:"nClipFrameRate"},{style:"cliplegend",obj:"nClipColorLegend"},{style:"clipparts",obj:"nClipParts"},
{style:"minchartsize",obj:"nChartSizeMin"},{style:"maxcharts",obj:"nMaxCharts"},{style:"showparts",obj:"szShowParts"},{style:"gridx",obj:"nGridX"},{style:"gridwidth",obj:"nGridWidth"},{style:"gridmatrix",obj:"nGridMatrix"},{style:"gridwidthpx",obj:"nGridWidthPx"},{style:"gridoffsetx",obj:"nGridOffsetX"},{style:"gridoffsety",obj:"nGridOffsetY"},{style:"aggregationfield",obj:"szAggregationField"},{style:"aggregationscale",obj:"szAggregationFieldA",type:"array"},{style:"aggregation",obj:"szAggregation"},
{style:"minaggregation",obj:"szMinAggregation"},{style:"aggregationupper",obj:"szAggregationUpper"},{style:"aggregationlower",obj:"szAggregationLower"},{style:"dominantfilter",obj:"szDominantFilter"},{style:"dominantdfilter",obj:"nDominantDFilter"},{style:"overviewchart",obj:"szOverviewChart"},{style:"evidence",obj:"evidenceMode"},{style:"markclass",obj:"markedClass"},{style:"markclasses",obj:"markedClassesA",type:"array"},{style:"name",obj:"szName"},{style:"title",obj:"szTitle"},{style:"snippet",
obj:"szSnippet"},{style:"splash",obj:"szSplash"},{style:"description",obj:"szDescription"}];function __maptheme_getOneStyleProperty(e,b,f,c){c=c?c:",";if("undefined"!=typeof e&&null!=e)if(f&&"undefined"!=typeof f){if("array"==f&&e&&e.length&&"array"==typeof e)return e=e.join(c),b+":"+e+";";if("object"==f&&e)return b+":"+JSON.stringify(e)+";"}else return b+":"+String(e)+";";return""}
function __maptheme_getStyleString(e){e=map.Themes.getMapThemeDefinitionObj(e.szId);for(var b="",f=0;f<themeStyleTranslateA.length;f++)b+=__maptheme_getOneStyleProperty(e.style[themeStyleTranslateA[f].style],themeStyleTranslateA[f].style,themeStyleTranslateA[f].type,themeStyleTranslateA[f].delimiter);return b.replace(/\"/gi,'\\"')}
function __maptheme_getStyleObj(e){for(var b={},f=0;f<themeStyleTranslateA.length;f++)null!=e[themeStyleTranslateA[f].obj]&&"undefined"!=e[themeStyleTranslateA[f].obj]&&(b[themeStyleTranslateA[f].style]=e[themeStyleTranslateA[f].obj]);return b}function __isdef(e){return"undefined"!==typeof e&&null!=e}
Map.Themes=function(){this.themesA=[];this.themeNodesA=[];this.themeNodesPosA=[];this.themeNodesBoxA=[];this.themeNodes=0;this.activeBuffer=this.activeTheme=null;this.switchedLayerA=[];this.enableMultiChoropleth=this.enableChartOffset=!1;this.enableSubThemes=!0;this.szChoroplethInfoStyle="";this.nMaxThemeCharts=1E6;this.nMaxShadowCharts=1E3;this.nflushPaintShape=5E3;this.nflushChartDraw=1E3;this.nColorSchemeMaxHeight=120;this.autoHideInfoTools=this.allwaysShowValues=!1;this.themeDataCacheA=[]};
Map.Themes.prototype=new Map;if("string"==typeof thisversion&&map.checkVersion(thisversion)){map.Themes=new Map.Themes;try{HTMLWindow.ixmaps.htmlgui_onInitThemes()}catch(e$$4){}}else alert("Map.Themes incompatible !");Map.Themes.prototype.addTheme=function(e){this.themesA[this.themesA.length]=e;if(!e.szFlag.match(/selection/i))try{HTMLWindow.ixmaps.htmlgui_onNewTheme(e.szId)}catch(b){}};Map.Themes.prototype.getThemeCount=function(){return this.themesA.length};Map.Themes.prototype.getAllThemes=function(){return this.themesA};
Map.Themes.prototype.isTheme=function(e){for(var b=0;b<this.themesA.length;b++)if(this.themesA[b].szIdStr&&this.themesA[b].szIdStr==e)return this.themesA[b];return!1};Map.Themes.prototype.isIdle=function(){for(var e=0;e<this.themesA.length;e++)if(!this.themesA[e].fRealizeDone)return!1;return!0};Map.Themes.prototype.isArray=function(e){return"[object Array]"===Object.prototype.toString.call(e)};
Map.Themes.prototype.toArray=function(e){return this.isArray(e)?e:String(e).match(/\|/)||String(e).match(/\RGB/)?String(e).split("|"):String(e).split(",")};Map.Themes.prototype.toString=function(e){return this.isArray(e)?e.join("|"):e};Map.Themes.prototype.newTheme=function(e,b,f,c,h,g){var q=null,q=(q=c.split("style="))&&1<q.length?__getStyleObj(q[1]):__getStyleObj(c);q.label=g&&"undefined"!=g?g.split("|"):q.label||null;q.szTitle=h;return this.newThemeByObj({layer:e,field:b,field100:f,style:q})};
Map.Themes.prototype.newThemeByObj=function(e){if(map.isIdle()){if(this.newThemeObjA&&this.newThemeObjA.length&&(e&&this.newThemeObjA.push(e),e=this.newThemeObjA.shift()),e){var b=JSON.stringify(e);if(!e.style.type.match(/FORCE/)&&this.isTheme(b))return this.removeTheme(null,this.isTheme(b).szId),null;var f=null,c=e.style;if(!c)return null;if(this.isArray(c.label))var f=c.label,h=c.label.join("|");else f=(h=c.label)&&"undefined"!=h?h.split("|"):null;h=[5,"white","blue"];c.colorscheme&&(h=this.toArray(c.colorscheme));
e.layer=this.toString(e.layer);e.field=this.toString(e.field);c.type.match(/\bEXACT\b/)&&!c.type.match(/\bCATEGORICAL\b/)&&(c.type+="|CATEGORICAL");f=new MapTheme(e.layer,e.field,e.field100,c.type,h,c.title,f);f.nOrder=this.getThemeCount();f.szIdStr=b;this.parseStyle(f,c);this.allwaysShowValues&&(f.szFlag+="|VALUES");f.parent=this;this.addTheme(f);f.fRealize=!0;if(f.coTable)return this.loadExternalData(f.coTable,f.nRefreshTimeout,f),f;if(fLoadExternalData){e=e.layer.split("|");for(b=0;b<e.length;b++)this.loadExternalData(e[b],
f.nRefreshTimeout,f);return f}map.Event.doDefaultZoom();executeWithMessage("map.Themes.execute()","... processing ...");return f}}else e&&(this.newThemeObjA=this.newThemeObjA||[],this.newThemeObjA.push(e)),setTimeout("map.Themes.newThemeByObj()",100)};
Map.Themes.prototype.parseStyle=function(e,b){if(e&&b){if(__isdef(b.classes)){if(isNaN(Number(e.origColorScheme[0]))){var f=e.origColorScheme[e.origColorScheme.length-1];e.origColorScheme[1]=e.origColorScheme[0];e.origColorScheme[2]=f}e.origColorScheme[0]=Number(b.classes)}__isdef(b.colorstyle)&&"spectrum"==e.origColorScheme[1]&&(e.origColorScheme[2]=b.colorstyle);__isdef(b.dominantdfilter)&&(e.nDominantDFilter=Number(b.dominantdfilter));__isdef(b.dominantfilter)&&(e.szDominantFilter=String(b.dominantfilter));
__isdef(b.filter)&&(e.szFilter=String(b.filter));__isdef(b.filterfield)&&(e.szFilterField=String(b.filterfield));__isdef(b.filtervalue)&&(e.szFilterValue=String(b.filtervalue));__isdef(b.overviewchart)&&(e.szOverviewChart=b.overviewchart);__isdef(b.evidence)&&(e.evidenceMode=b.evidence);__isdef(b.markclass)&&(e.markedClass=b.markclass,e.markedClasses||(e.markedClasses=[],e.markedClasses[e.markedClass]=!0,e.markedClassesA=[e.markedClass]));__isdef(b.markclasses)&&(e.markedClassesA=this.toArray(b.markclasses),
e.markedClasses=[],e.markedClassesA.forEach(function(b,f){b.length&&(e.markedClasses[b]=!0,e.markedClass=b)}));__isdef(b.fillopacity)&&("auto"==b.fillopacity?(e.autoOpacity=!0,e.fillOpacity=0):e.fillOpacity=Number(b.fillopacity));__isdef(b.opacity)&&("auto"==b.opacity?(e.autoOpacity=!0,e.fillOpacity=0):e.nOpacity=Number(b.opacity));__isdef(b.autoopacity)&&(e.autoOpacity=!0,e.fillOpacity=0);__isdef(b.shadow)?e.fShadow=e.fOrigShadow=JSON.parse(b.shadow):e.fShadow=e.fOrigShadow=!1;__isdef(b.maxshadow)&&
(e.nMaxShadowCharts=Number(b.maxshadow));__isdef(b.blur)&&(e.nBlur=Number(b.blur));__isdef(b.dbtable)&&(f=b.dbtable.split(" "),e.coTable=f[0],2==f.length&&(e.coTableType="jsonDB",e.coTableUrl=f[1].split("(")[1].split(")")[0]),3==f.length&&(e.coTableType=f[1],e.coTableUrl=f[2].split("(")[1].split(")")[0]),4==f.length&&(e.coTableType=f[1],e.coTableUrl=f[2].split("(")[1].split(")")[0],e.coTableExt=f[3].split("(")[1].split(")")[0]));__isdef(b.dbtableType)&&(e.coTableType=b.dbtableType);__isdef(b.dbtableUrl)&&
(e.coTableUrl=b.dbtableUrl);__isdef(b.dbtableExt)&&(e.coTableExt=b.dbtableExt);__isdef(b.lookupfield)&&(e.szSelectionField=e.szItemField=b.lookupfield);__isdef(b.lookupfield2)&&(e.szSelectionField2=b.lookupfield2);__isdef(b.lookuptoupper)&&(e.fSelectionFieldToUpper=JSON.parse(b.lookuptoupper));__isdef(b.lookupsuffix)&&(e.szSelectionFieldSuffix=b.lookupsuffix);__isdef(b.lookupprefix)&&(e.szSelectionFieldPrefix=b.lookupprefix);__isdef(b.lookupdigits)&&(e.nSelectionFieldDigits=Number(b.lookupdigits));
__isdef(b.lookuptonumber)&&(e.fSelectionFieldToNumber=JSON.parse(b.lookuptonumber));__isdef(b.crsutmzone)&&(e.szCRSUTMZone=b.crsutmzone);__isdef(b.crsdatum)&&(e.szCRSDatum=b.crsdatum);__isdef(b.itemfield)&&(e.szItemField=b.itemfield);__isdef(b.ranges)&&(e.szRangesA=this.toArray(b.ranges),e.szRanges=this.toString(b.ranges));__isdef(b.symbols)&&(e.szSymbolsA=this.toArray(b.symbols));if(__isdef(b.values)&&(e.szValuesA=this.toArray(b.values),b.type.match(/CATEGORICAL/)&&e.szValuesA.length))for(f=0;f<
e.szValuesA.length;f++)e.getStringValueIndex(e.szValuesA[f],"set");__isdef(b.colorvalues)&&(e.szColorValuesA=this.toArray(b.colorvalues));__isdef(b.symbolvalues)&&(e.szSymbolValuesA=this.toArray(b.symbolvalues));__isdef(b.align)&&(e.szAlign=b.align);__isdef(b.units)&&(e.szUnits=b.units);__isdef(b.units100)&&(e.szUnits100=b.units100);__isdef(b.sizevalueunits)&&(e.szSizeValueUnits=" "+b.sizevalueunits);__isdef(b.alphavalueunits)&&(e.szAlphaValueUnits=" "+b.alphavalueunits);__isdef(b.legendunits)&&(e.szLegendUnits=
" "+b.legendunits);__isdef(b.labelunits)&&(e.szLabelUnits=" "+b.labelunits);__isdef(b.xaxis)&&(e.szXaxisA=this.toArray(b.xaxis));__isdef(b.id)&&(e.szId=unescape(b.id));__isdef(b.name)&&(e.szId=e.szName=unescape(b.name));__isdef(b.title)&&(e.szTitle=unescape(b.title));__isdef(b.snippet)&&(e.szSnippet=unescape(b.snippet));__isdef(b.splash)&&(e.szSplash=unescape(b.splash));__isdef(b.description)&&(e.szDescription=unescape(b.description));__isdef(b.label)&&(e.szLabelA=e.szOrigLabelA=this.toArray(b.label));
__isdef(b.weights)&&(e.szWeightsA=this.toArray(b.weights),e.szWeights=this.toString(b.weights));__isdef(b.weight)&&(e.szWeightsA=[b.weights],e.szWeights=b.weight);__isdef(b.scale)&&(e.nScale=Number(b.scale));__isdef(b.colorfield)&&(e.szColorField=b.colorfield);__isdef(b.symbolfield)&&(e.szSymbolField=b.symbolfield);__isdef(b.valuefield)&&(e.szValueField=b.valuefield);__isdef(b.labelfield)&&(e.szLabelField=b.labelfield);__isdef(b.titlefield)&&(e.szTitleField=b.titlefield);__isdef(b.snippetfield)&&
(e.szSnippetField=b.snippetfield);__isdef(b.sizefield)&&(e.szSizeField=b.sizefield);__isdef(b.timefield)&&(e.szTimeField=b.timefield);__isdef(b.alphafield)&&(e.szAlphaField=b.alphafield);__isdef(b.alphafield100)&&(e.szAlphaField100=b.alphafield100);__isdef(b.xfield)&&(e.szXField=b.xfield);__isdef(b.yfield)&&(e.szYField=b.yfield);__isdef(b.refresh)&&(e.nRefreshTimeout=1E3*Number(b.refresh));__isdef(b.refreshtimeout)&&(e.nRefreshTimeout=Number(b.refreshtimeout));__isdef(b.buffersize)&&(e.nBufferSize=
b.buffersize);__isdef(b.bufferstep)&&(e.nBufferSizeStep=b.bufferstep);__isdef(b.field100min)&&(e.nField100Min=b.field100min);__isdef(b.fractionscale)&&(e.nFractionScale=b.fractionscale);__isdef(b.minvalue)&&(e.nMinValue=b.minvalue);__isdef(b.maxvalue)&&(e.nMaxValue=b.maxvalue);__isdef(b.showdata)&&(e.fShowData=JSON.parse(b.showdata));__isdef(b.datacache)&&(e.fDataCache=JSON.parse(b.datacache));__isdef(b.editor)&&(e.fEditor=JSON.parse(b.editor));__isdef(b.datafields)&&(e.szDataFieldsA=this.toArray(b.datafields));
__isdef(b.textcolor)&&(e.szTextColor=b.textcolor);__isdef(b.textfont)&&(e.szTextFont=b.textfont);__isdef(b.linecolor)&&(e.szLineColorA=this.toArray(b.linecolor),e.szLineColor=e.szLineColorA[e.szLineColorA.length-1]);__isdef(b.linewidth)&&(e.nLineWidth=b.linewidth);__isdef(b.markersize)&&(e.nMarkerSize=b.markersize);__isdef(b.gapsize)&&(e.nGapSize=b.gapsize);__isdef(b.bordercolor)&&(e.szBorderColor=b.bordercolor);__isdef(b.borderstyle)&&(e.szBorderStyle=b.borderstyle);__isdef(b.borderwidth)&&(e.szBorderWidth=
b.borderwidth);__isdef(b.borderradius)&&(e.nBorderRadius=Number(b.borderradius));__isdef(b.boxcolor)&&(e.szBoxColor=b.boxcolor);__isdef(b.boxopacity)&&(e.nBoxOpacity=b.boxopacity);__isdef(b.boxmargin)&&(e.nBoxMargin=b.boxmargin);__isdef(b.textplacement)&&(e.szTextPlacement=b.textplacement);__isdef(b.infotitle)&&(e.szInfoTitle=b.infotitle);__isdef(b.exclude)&&(e.szExcludeA=this.toArray(b.exclude));__isdef(b.aggregation)&&(e.szAggregation=b.aggregation);__isdef(b.rangecentervalue)&&(e.nRangeCenterValue=
Number(b.rangecentervalue));__isdef(b.rangescale)&&(e.nRangeScale=b.rangescale);__isdef(b.normalsizevalue)&&(e.nNormalSizeValue=b.normalsizevalue);__isdef(b.normalsizescale)&&(e.szNormalSizeScale=b.normalsizescale,e.nNormalSizeScale=__scanScaleValue(e.szNormalSizeScale));__isdef(b.nodatacolor)&&(e.szNoDataColor=__getSaveColor(b.nodatacolor));__isdef(b.boxupper)&&(e.szBoxUpper=b.boxupper,e.nBoxUpper=__scanScaleValue(e.szBoxUpper));__isdef(b.titleupper)&&(e.szTitleUpper=b.titleupper,e.nTitleUpper=__scanScaleValue(e.szTitleUpper));
__isdef(b.labelupper)&&(e.szLabelUpper=b.labelupper,e.nLabelUpper=__scanScaleValue(e.szLabelUpper));__isdef(b.valueupper)&&(e.szValueUpper=b.valueupper,e.nValueUpper=__scanScaleValue(e.szValueUpper));__isdef(b.valuesupper)&&(e.szValueUpper=b.valuesupper,e.nValueUpper=__scanScaleValue(e.szValueUpper));__isdef(b.glowupper)&&(e.szGlowUpper=b.glowupper,e.nGlowUpper=__scanScaleValue(e.szGlowUpper));__isdef(b.glowlower)&&(e.szGlowLower=b.glowlower,e.nGlowLower=__scanScaleValue(e.szGlowLower));__isdef(b.chartupper)&&
(e.szChartUpper=b.chartupper,e.nChartUpper=__scanScaleValue(e.szChartUpper));__isdef(b.chartlower)&&(e.szChartLower=b.chartlower,e.nChartLower=__scanScaleValue(e.szChartLower));__isdef(b.shadowupper)&&(e.szShadowUpper=b.shadowupper,e.nShadowUpper=__scanScaleValue(e.szShadowUpper));__isdef(b.shadowlower)&&(e.szShadowLower=b.shadowlower,e.nShadowLower=__scanScaleValue(e.szShadowLower));__isdef(b.declutterupper)&&(e.szDeclutterUpper=b.declutterupper,e.nDeclutterUpper=__scanScaleValue(e.szDeclutterUpper));
__isdef(b.valuescale)&&(e.nValueScale=Number(b.valuescale));__isdef(b.clipframes)&&(e.nClipFrames=b.clipframes);__isdef(b.clipframerate)&&(e.nClipFrameRate=b.clipframerate,e.nClipTimeout=1/Number(b.clipframerate)*1E3);__isdef(b.cliplegend)&&(e.nClipColorLegend=Number(b.cliplegend));__isdef(b.clipvaluesize)&&(e.nValueSizeMin=Number(b.clipvaluesize));__isdef(b.minvaluesize)&&(e.nValueSizeMin=Number(b.minvaluesize));__isdef(b.valuedecimals)&&(e.szValueDecimals=b.valuedecimals);__isdef(b.fadevaluepow)&&
(e.szFadeValuePow=b.fadevaluepow);__isdef(b.dopacityscale)&&(e.nDopacityScale=b.dopacityscale);__isdef(b.dopacityramp)&&(e.szDopacityRamp=b.dopacityramp);__isdef(b.dopacitypow)&&(e.nDopacityPow=b.dopacitypow);__isdef(b.fadenegative)&&(e.nFadeNegative=Number(b.fadenegative)||.5);__isdef(b.brightness)&&(e.nBrightness=b.brightness);__isdef(b.clipparts)&&(e.nClipParts=Number(b.clipparts)||0);__isdef(b.minsize)&&(e.nChartSizeMin=Number(b.minsize)||0);__isdef(b.minchartsize)&&(e.nChartSizeMin=Number(b.minchartsize)||
0);__isdef(b.maxcharts)&&(e.nMaxCharts=Math.round(Number(b.maxcharts))||0);__isdef(b.clipsize)&&(e.nChartSizeMin=Number(b.clipsize)||0);__isdef(b.sizepow)&&(e.nSizePow=b.sizepow);__isdef(b.showparts)&&(e.szShowParts=this.toString(b.showparts),e.szShowPartsA=this.toArray(b.showparts));__isdef(b.gridx)&&(e.nGridX=Number(b.gridx)||1);__isdef(b.gridwidth)&&(String(b.gridwidth).match(/px/)&&(e.nGridWidthPx=parseFloat(b.gridwidth)||50,map.Themes.doChangeThemeStyle(e.szId,"AUTOGRID","add")),e.nGridWidth=
Number(b.gridwidth)||0);__isdef(b.gridmatrix)&&(e.nGridMatrix=Number(b.gridmatrix)||20,map.Themes.doChangeThemeStyle(e.szId,"AUTOGRID","add"));__isdef(b.gridwidthpx)&&(e.nGridWidthPx=Number(b.gridwidthpx)||50,map.Themes.doChangeThemeStyle(e.szId,"AUTOGRID","add"));__isdef(b.gridoffsetx)&&(e.nGridOffsetX=Number(b.gridoffsetx)||0);__isdef(b.gridoffsety)&&(e.nGridOffsetY=Number(b.gridoffsety)||0);__isdef(b.aggregationfield)&&(e.szAggregationField=b.aggregationfield);__isdef(b.aggregationscale)&&(e.szAggregationFieldA=
this.toArray(b.aggregationscale));__isdef(b.minaggregation)&&(e.szMinAggregation=b.minaggregation,e.nMinAggregation=Number(b.minaggregation)||0);__isdef(b.aggregationupper)&&(e.szAggregationUpper=b.aggregationupper,e.nAggregationUpper=__scanScaleValue(e.szAggregationUpper));__isdef(b.aggregationlower)&&(e.szAggregationLower=b.aggregationlower,e.nAggregationLower=__scanScaleValue(e.szAggregationLower));__isdef(b.userdraw)&&(e.userDraw=b.userdraw);__isdef(b.centerpart)&&(e.szCenterPart=this.toString(b.centerpart));
__isdef(b.child)&&(e.fChild=!0);__isdef(b.valuemap)&&(e.valueMap=b.valuemap)}};Map.Themes.prototype.getAllThemeDefinitionStrings=function(){for(var e=[],b=0;b<this.themesA.length;b++)e.push(this.getThemeDefinitionString(this.themesA[b]));return e};__toRGB=function(e){var b,f;b=parseInt(e.substr(1,2),16);f=parseInt(e.substr(3,2),16);e=parseInt(e.substr(5,2),16);return"RGB("+b+","+f+","+e+")"};__getSaveColor=function(e){try{if("#"==e.charAt(0))return __toRGB(e)}catch(b){}return e};
__getSaveColorScheme=function(e){for(var b=0;b<e.length;b++)e[b]=__getSaveColor(e[b]);return e.join("|")};__scanScaleValue=function(e){return String(e).match(/:/)?Number(e.split(":")[1]):Number(e)};
Map.Themes.prototype.cleanUpThemeObj=function(e){var b=e.style;if(b.colorscheme){var f=b.colorscheme[0];for(i in b.colorscheme)if(b.colorscheme[i]!=f){f=null;break}f&&(b.colorscheme.length=1)}if(b.symbols){f=b.symbols[0];for(i in b.symbols)if(b.symbols[i]!=f){f=null;break}f&&(b.symbols.length=1)}b.aggregationfield?(b.aggregationscale=null,b.gridwidth=null,b.gridwidthpx=null):b.aggregationscale?(b.gridwidth=null,b.gridwidthpx=null):b.gridwidthpx&&(b.gridwidth=null);b.evidence&&"isolate"==b.evidence&&
(b.evidence=null);b.aggregation&&(b.aggregation=null);b.type.match(/DOMINANT/)||b.type.match(/PERCENTOFMEAN/)||b.type.match(/OFFSETMEAN/)||b.type.match(/PERCENTOFMEAN/)||b.type.match(/DEVIATION/)||(b.dominantfilter=null,b.dominantdfilter=null);b.itemfield&&b.lookupfield&&b.itemfield==b.lookupfield&&(b.itemfield=null);return e};
Map.Themes.prototype.getThemeDefinitionString=function(e){return'map.Api.newMapTheme("'+e.szThemes+'","'+(e.szFields||"")+'","'+(e.szField100||"")+'","type:'+e.szFlag+";colorscheme:"+__getSaveColorScheme(e.origColorScheme)+";"+__maptheme_getStyleString(e)+';child:true;");'};Map.Themes.prototype.getMapThemeStyleString=function(e){return(e=this.getTheme(e)||this.activeTheme)&&e.colorScheme?"type:"+e.szFlag+";colorscheme:"+e.colorScheme+";"+__maptheme_getStyleString(e)+"":null};
Map.Themes.prototype.getMapThemeDefinitionObj=function(e){var b=this.getTheme(e)||this.activeTheme;e={};e.layer=b.szThemes;e.field=b.szFields||"";e.field100=b.szField100||"";b.szFlag.match(/\bCATEGORICAL\b/)&&b.colorScheme&&3<b.colorScheme.length&&(!b.szValuesA||!b.szValuesA.length)&&b.szLabelA&&b.szLabelA.length&&100>=b.szLabelA.length&&(b.szValuesA=b.szLabelA.slice(0));var f={type:b.szFlag,colorscheme:b.origColorScheme},b=__maptheme_getStyleObj(b);for(a in b)f[a]=b[a];e.style=f;return this.cleanUpThemeObj(e)};
Map.Themes.prototype.getTheme=function(e){if(!e||"string"!=typeof e)return this.activeTheme;e=e.split(":")[0];for(var b=0;b<this.themesA.length;b++)if(this.themesA[b].szId==e||this.themesA[b].szName==e)return this.themesA[b];return this.activeTheme};Map.Themes.prototype.getThemeIndex=function(e){for(var b=0;b<this.themesA.length;b++)if(this.themesA[b].szId==e)return b};
Map.Themes.prototype.refreshTheme=function(e){if(e=this.getTheme(e)){e.fRealize=!0;e.fRedraw=!0;if(!fAllIncluded){if(e.coTable){this.loadExternalData(e.coTable,!0,e);return}if(fLoadExternalData){for(var b=szThemes.split("|"),f=0;f<b.length;f++)this.loadExternalData(b[f],!0,e);return}}executeWithMessage("map.Themes.execute()","... processing ...")}};Map.Themes.prototype.nextClipFrame=function(e){(e=this.getTheme(e))&&e.realizeNextClipFrame()};
Map.Themes.prototype.setClipFrame=function(e,b){var f=e?this.getTheme(e):this.activeTheme;f&&f.setClipFrame(b)};Map.Themes.prototype.pauseClip=function(e){(e=this.getTheme(e))&&e.pauseClip()};Map.Themes.prototype.startClip=function(e){(e=this.getTheme(e))&&e.startClip()};
Map.Themes.prototype.loadExternalData=function(e,b,f){this.coTableExt||(this.coTableExt=[]);if(e){var c=map.Dictionary.getLocalText("... creating theme ...");b&&("undefined"!=eval("typeof("+e+")")&&eval(e+".table = null"),c=map.Dictionary.getLocalText("... refreshing theme ..."));this.__test=null;try{eval("this.__test = "+e+".table")}catch(h){try{eval("this.__test = "+e+"_table")}catch(g){}}var q=f.fEditor||!(f.coTableUrl&&f.coTableExt)||!1;this.themeDataCacheA[e]&&((this.themeDataCacheA[e].coTableUrl||
f.coTableUrl)&&this.themeDataCacheA[e].coTableUrl!=f.coTableUrl||(this.themeDataCacheA[e].coTableExt||f.coTableExt)&&this.themeDataCacheA[e].coTableExt!=f.coTableExt||(q=!0));if(this.__test&&q&&0!=f.fDataCache)this.fWaitforData=!1,f.fWaitingforData=!1,executeWithMessage("map.Themes.execute()",c),f&&f.coTableExt&&(f.coTableExt=this.coTableExt[f.coTable]);else{if(f&&(f.coTableUrl||f.coTableExt))try{this.themeDataCacheA[e]={coTableUrl:f.coTableUrl,coTableExt:f.coTableExt};this.fWaitforData=!0;f.fWaitingforData=
!0;SVGMessageGroup.fu.clear();HTMLWindow.ixmaps.htmlgui_loadExternalData(f.coTableUrl,{theme:f,type:f.coTableType,name:f.coTable,ext:f.coTableExt});this.coTableExt[f.coTable]=f.coTableExt;return}catch(l){}fLocalHost?this.loadExternalDataDefault(e,b,c):this.loadExternalDataZipped(e,b,c)}}};
Map.Themes.prototype.loadExternalDataZipped=function(e,b,f){this.fWaitforData=!0;displayMessage(map.Dictionary.getLocalText("... loading data ..."));var c=new JSLoader;c.finishedCallback="map.Themes.loadExternalDataFinish('"+f+"')";c.errorCallback="map.Themes.loadExternalDataDefault('"+e+"',"+b+",'"+f+"')";c.szMessage=map.Dictionary.getLocalText("... loading data ...");c.loadScript(map.mapRoot+e+".js.gz",b)};
Map.Themes.prototype.loadExternalDataDefault=function(e,b,f){this.fWaitforData=!0;displayMessage(map.Dictionary.getLocalText("... loading data ..."));var c=new JSLoader;c.finishedCallback="map.Themes.loadExternalDataFinish('"+f+"')";c.errorCallback="map.Themes.loadExternalDataFinish('"+f+"')";c.szMessage=map.Dictionary.getLocalText("... loading data ...");c.loadScript(map.mapRoot+e+".js",b)};
Map.Themes.prototype.loadExternalDataFinish=function(e){this.fWaitforData=!1;executeWithMessage("map.Themes.execute()",e)};Map.Themes.prototype.setExternalData=function(e,b,f){b&&(this._dataObj=b,eval(f+" = this._dataObj"));this.fWaitforData=!1;e=this.getAllThemes();for(i in e)e[i].coTable==f&&(e[i].fWaitingforData=!1);this.execute()};
Map.Themes.prototype.activateTheme=function(e,b){var f=this.getTheme(b);f&&(f.fRedraw=!0,executeWithMessage("map.Themes.execute()","... processing ..."));e.stopPropagation();e.preventDefault()};Map.Themes.prototype.showTheme=function(e,b){var f=this.getTheme(b);f&&(f.fShow=!0,executeWithMessage("map.Themes.execute()","... processing ..."));e&&(e.stopPropagation(),e.preventDefault())};
Map.Themes.prototype.hideTheme=function(e,b){var f=this.getTheme(b);f&&(f.fHide=!0,executeWithMessage("map.Themes.execute()","... processing ..."));e&&(e.stopPropagation(),e.preventDefault())};Map.Themes.prototype.toggleTheme=function(e,b){var f=this.getTheme(b);f&&(f.fToggle=!0,executeWithMessage("map.Themes.execute()","... processing ..."));e&&(e.stopPropagation(),e.preventDefault())};
Map.Themes.prototype.removeTheme=function(e,b){var f=this.getTheme(b);if(f){if(f.szFlag.match(/LOCKED/))return;f.szFlag.match(/CHART/)&&(f.fToggle=!0);f.fRemove=!0;executeWithMessage("map.Themes.execute()","... processing ...")}e&&(e.stopPropagation(),e.preventDefault())};
Map.Themes.prototype.removeAll=function(e){for(var b=0;b<this.themesA.length;b++)this.themesA[b].szFlag.match(/LOCKED/)||(this.themesA[b].fRemove=!this.themesA[b].fRealize);setTimeout("map.Themes.execute()",100);e&&(e.stopPropagation(),e.preventDefault())};
Map.Themes.prototype.removeAllCharts=function(e){for(var b=0;b<this.themesA.length;b++)this.themesA[b].szFlag.match(/CHART/)&&!this.themesA[b].szFlag.match(/LOCKED/)&&(this.themesA[b].fRemove=!this.themesA[b].fRealize);this.fWaitforData=!0;map.Themes.execute();e&&(e.stopPropagation(),e.preventDefault())};
Map.Themes.prototype.removeAllChoropleth=function(e){for(var b=0;b<this.themesA.length;b++)this.themesA[b].szFlag.match(/CHOROPLETH/)&&!this.themesA[b].szFlag.match(/LOCKED/)&&(this.themesA[b].fRemove=!this.themesA[b].fRealize);this.fWaitforData=!0;executeWithMessage("map.Themes.execute()","... processing ...");e&&(e.stopPropagation(),e.preventDefault())};
Map.Themes.prototype.removeAllSelections=function(e){for(var b=0;b<this.themesA.length;b++)this.themesA[b].szFlag.match(/SELECTION/)&&(this.themesA[b].fRemove=!0,executeWithMessage("map.Themes.execute()","... processing ..."));e&&(e.stopPropagation(),e.preventDefault())};Map.Themes.prototype.redrawInfoAll=function(e){for(var b=0;b<this.themesA.length;b++)this.themesA[b].fRedrawInfo=!0;map.Themes.execute();e&&(e.stopPropagation(),e.preventDefault())};
Map.Themes.prototype.reformat=function(e){for(var b=this.minY=this.minX=0;b<this.themesA.length;b++)this.themesA[b].fRepositionInfo=!0,this.themesA[b].fRedrawInfo=!0;map.Themes.execute();e&&(e.stopPropagation(),e.preventDefault())};
Map.Themes.prototype.execute=function(){var e=!1,b=0;if(!map.isIdle())setTimeout("map.Themes.execute()",100);else if(!this.fWaitforData)if(map.Tiles.isLoading())setTimeout("map.Themes.execute()",250),this.fExecuteDelayed=!0;else if(this.fExecuteDelayed)this.fExecuteDelayed=!1,executeWithMessage("map.Themes.execute()"," ... ");else{for(b=0;b<this.themesA.length;b++)(this.themesA[b].fRealize||this.themesA[b].fRedraw||this.themesA[b].fToFront)&&this.themesA[b].szFlag.match(/CHOROPLETH/)&&!this.themesA[b].szFlag.match(/SUBTHEME/)&&
(e=this.themesA[b].szShapeType);if(e&&this.enableMultiChoropleth)for(b=0;b<this.themesA.length;b++)this.themesA[b].szFlag&&this.themesA[b].szFlag.match(/CHOROPLETH/)&&this.themesA[b].szShapeType==e&&(this.themesA[b].disable(),this.themesA[b].isVisible=!1,this.themesA[b].fRedrawInfo=!1);if(e&&!this.enableMultiChoropleth)for(b=0;b<this.themesA.length;b++)!this.themesA[b].szFlag||!this.themesA[b].szFlag.match(/CHOROPLETH/)||this.themesA[b].szShapeType!=e||this.themesA[b].fRealize||this.themesA[b].fRedraw||
this.themesA[b].fToFront||(this.themesA[b].fRemove=!0);for(b=0;b<this.themesA.length;b++){if(this.themesA[b].fWaitingforData)return;if(this.themesA[b].fShow){this.themesA[b].toggle(!0);this.themesA[b].fShow=!1;break}if(this.themesA[b].fHide){this.themesA[b].toggle(!1);this.themesA[b].fHide=!1;break}if(this.themesA[b].fToggle){this.themesA[b].toggle();this.themesA[b].fToggle=!1;this.execute();break}if(this.themesA[b].fRemove){1<this.themesA.length&&!this.themesA[b].szFlag.match(/SELECTION/)&&!this.themesA[b].szFlag.match(/CHART/)&&
this.activateNextPaint(this.themesA[b]);this.themesA[b].removeElements();this.remove(this.themesA[b]);this.reformat();this.execute();break}if(this.themesA[b].fRealize)this.themesA[b].fEnableProgressBar=!0,setTimeout("map.Themes.showProgressBar()",5E3),this.themesA[b].fRealize=!1,this.themesA[b].realize();else if(this.themesA[b].fRedraw)this.themesA[b].checkHiddenLayerState&&this.themesA[b].checkHiddenLayerState()?(this.themesA[b].fRealize=!0,this.themesA[b].fRedraw=!1,this.themesA[b].fReload=!1,this.themesA[b].unpaintMap(),
map.Themes.execute()):(this.themesA[b].fEnableProgressBar=!0,this.themesA[b].redraw(!1));else if(this.themesA[b].fActualize)this.themesA[b].fActualize=!1,this.themesA[b].checkHiddenLayerState&&this.themesA[b].checkHiddenLayerState()?(this.themesA[b].fRealize=!0,this.themesA[b].fRedraw=!1,this.themesA[b].fReload=!1,this.themesA[b].unpaintMap(),map.Themes.execute()):(this.themesA[b].fEnableProgressBar=!0,this.themesA[b].redraw(!1));else if(this.themesA[b].fToFront)this.themesA[b].fEnableProgressBar=
!1,this.themesA[b].toFront(),this.themesA[b].fToFront=!1;else if(this.themesA[b].fResize)this.themesA[b].resize(this.themesA[b].fResize),this.themesA[b].fResize=!1;else if(this.themesA[b].fOpacity)this.themesA[b].opacity(this.themesA[b].fOpacity),this.themesA[b].fOpacity=!1;else if(this.themesA[b].fBlur)this.themesA[b].blur(this.themesA[b].nBlur),this.themesA[b].fBlur=!1;else if(this.themesA[b].fOffset)this.themesA[b].offset(this.themesA[b].fOffset),this.themesA[b].fOffset=!1;else if(this.themesA[b].fRedrawInfo)this.themesA[b].widgetNode&&
this.themesA[b].showInfo(),this.themesA[b].fRedrawInfo=!1;else if(this.themesA[b].fResort){try{this.themesA[b].sortChartObjects()}catch(f){}this.themesA[b].fResort=!1}else if(this.themesA[b].fDeclutter){try{this.themesA[b].declutterCharts()}catch(c){}this.themesA[b].fDeclutter=!1}}this.executeCallback&&(eval(this.executeCallback),this.executeCallback=null);clearMessage();clearMessage(1E3)}};
Map.Themes.prototype.executeContinue=function(){for(var e=0;e<this.themesA.length;e++)this.themesA[e].fAnalyze?(this.themesA[e].fAnalyze=!1,this.themesA[e].realize_analyze()):this.themesA[e].fDraw?(this.themesA[e].fDraw=!1,this.themesA[e].realize_draw()):this.themesA[e].fContinue?(this.themesA[e].fContinue=!1,this.themesA[e].realizeContinue(this.themesA[e].continueIndex)):this.themesA[e].fContinueLoadAndAggregate&&(this.themesA[e].fContinueLoadAndAggregate=!1,this.themesA[e].loadAndAggregateValuesOfTheme(this.themesA[e].szThemeLayer,
this.themesA[e].continueIndex))};Map.Themes.prototype.realizeDone=function(e){for(var b=0;b<this.themesA.length;b++)this.themesA[b].szFlag.match(/SELECTION/)&&(this.themesA[b].fRealize=!0);e.fRealizeDone=!0;try{HTMLWindow.ixmaps.htmlgui_onDrawTheme(e.szId)}catch(f){}e.szFlag.match(/TEXTONLY/)&&setTimeout("map.Layer.adaptLabel()",10);e.userChartDrawError&&e.userChartDrawError==e.nDoneCount&&displayMessage("User draw function error! ",5E3);this.isIdle()&&clearMessage()};
Map.Themes.prototype.showProgressBar=function(){for(var e=0;e<this.themesA.length;e++)(this.themesA[e].fRealize||this.themesA[e].fContinue||this.themesA[e].fAnalyze||this.themesA[e].fDraw)&&2<this.themesA[e].nCount/this.themesA[e].nDoneCount&&this.themesA[e].mapSleep?this.themesA[e].mapSleep.fShowProgressBar=!0:(this.themesA[e].fRealize||this.themesA[e].fContinue||this.themesA[e].fAnalyze||this.themesA[e].fDraw)&&setTimeout("map.Themes.showProgressBar()",1E3)};
Map.Themes.prototype.remove=function(e){e==this.activeTheme&&(this.activeTheme=null);e==this.activeBuffer&&(this.activeBuffer=null);for(var b=0;b<this.themesA.length;b++)if(this.themesA[b]==e){for(;b<this.themesA.length-1;b++)this.themesA[b]=this.themesA[b+1];this.themesA.length--}};Map.Themes.prototype.cancelExecute=function(){this.activeTheme.fCancel=!0};Map.Themes.prototype.sequence=function(){this.sequenceNr=0;this.sequenceNext()};
Map.Themes.prototype.sequenceNext=function(){this.sequenceNr<this.themesA.length&&(this.themesA[this.sequenceNr].fRedraw=!0,map.Themes.executeCallback="setTimeout('map.Themes.sequenceNext()',500)",map.Themes.execute(),this.sequenceNr++)};
Map.Themes.prototype.activateNextPaint=function(e){e=this.getThemeIndex(e.szId);for(var b=e-1;b!=e;b--){0>b&&(b=this.themesA.length-1);if(b==e)break;if(this.themesA[b].isChecked&&!this.themesA[b].szFlag.match(/CHART/))return this.themesA[b].fRedraw=!0,this.themesA[b].fRedrawInfo=!1,!0}return!1};Map.Themes.prototype.toggleThemeValues=function(e,b){this.toggleValueDisplay(e,this.activeTheme.szId,!this.activeTheme.szFlag.match(/VALUES/))};
Map.Themes.prototype.toggleThemeLegends=function(e,b){SVGThemeGroup.style.setProperty("display",b?"inline":"none","")};Map.Themes.prototype.minimizeThemeLegends=function(e){this.fMinimizedLegends=!0;for(var b=0;b<this.themesA.length;b++)this.minimizeInfo(e,this.themesA[b].szId)};Map.Themes.prototype.changeAllChartScaling=function(e,b){for(var f=0;f<this.themesA.length;f++)this.themesA[f].fResize=999,executeWithMessage("map.Themes.execute()","... processing ...");e.stopPropagation();e.preventDefault()};
Map.Themes.prototype.changeChartScaling=function(e,b,f){if(b=this.getTheme(b))b.fResize=f,executeWithMessage("map.Themes.execute()","... processing ...");e.stopPropagation();e.preventDefault()};Map.Themes.prototype.changeChartOpacity=function(e,b,f){if(b=this.getTheme(b))b.fOpacity=f,executeWithMessage("map.Themes.execute()","... processing ...");e.stopPropagation();e.preventDefault()};
Map.Themes.prototype.changeChartOffset=function(e,b,f){if((e=this.getTheme(b))&&e.leadOffset&&(f=SVGDocument.getElementById(f))){f.fu=new Methods(f);b=f.fu.getPosition();var c=f.fu.getGroupScale();e.fOffset=new point(b.x-e.leadOffset.x,b.y-e.leadOffset.y);f.fu.setPosition(e.leadOffset.x,e.leadOffset.y);e.fOffset.x/=map.Zoom.nZoom/c.x;e.fOffset.y/=map.Zoom.nZoom/c.y;e.offset(e.fOffset);e.fOffset=!1;e.leadOffset=!1}};
Map.Themes.prototype.tellChartOffset=function(e,b,f){(e=this.getTheme(b))&&!e.leadOffset&&this.enableChartOffset&&(f=SVGDocument.getElementById(f))&&(f.fu=new Methods(f),e.leadOffset=f.fu.getPosition())};Map.Themes.prototype.initChartOffset=function(e,b,f){if(this.getTheme(b)){var c=SVGDocument.getElementById(f);c&&(c.origPosition||(c.origPosition=c.fu.getPosition()),c.onMouseMove=function(b){c.actualPosition=c.fu.getPosition();map.Themes.makeChartOffsetPointer(c)},c.widgetObj=new Widget(c,c))}};
Map.Themes.prototype.endChartOffset=function(e,b,f){this.getTheme(b)&&(e=SVGDocument.getElementById(f))&&e.widgetObj.remove()};
Map.Themes.prototype.makeChartOffsetPointer=function(e,b){b=b||1;e.pointerObj?(map.Dom.clearGroup(e.pointerObj),map.Dom.clearGroup(e.pointShObj)):(e.pointerObj=map.Dom.newGroup(e),e.pointShObj=map.Dom.newGroup(e),e.pointerObj.parentNode.insertBefore(e.pointerObj,e.pointerObj.parentNode.firstChild),e.pointShObj.parentNode.insertBefore(e.pointShObj,e.pointShObj.parentNode.firstChild));if(e.origPosition||e.actualPosition){var f=new box(0,0,100,75),c=new point(e.actualPosition.x-e.origPosition.x,e.actualPosition.y-
e.origPosition.y),h=map.Scale.normalX(15),g=map.Scale.normalX(5),q=map.Scale.normalX(10);map.Scale.normalX(5);g=c.y+f.height/2;h=c.x+f.width/2;Math.abs(g)+f.width/2-f.height/2>Math.abs(h)?(f.width/3>q&&(c.x>-f.width/3&&(h-=f.width/3),c.x<-f.width/3*2&&(h+=f.width/3)),0<g?(map.Dom.newShape("path",e.pointShObj,"M"+-c.x+","+-c.y+" l "+(h-map.Scale.normalX(5/b))+","+(c.y+map.Scale.normalX(1/b))+" "+map.Scale.normalX(4/b)+",0 z","fill:black;fill-opacity:0.5"),map.Dom.newShape("path",e.pointerObj,"M"+-c.x+
","+-c.y+" l "+(h-map.Scale.normalX(5/b))+","+(c.y+map.Scale.normalX(1/b))+" "+map.Scale.normalX(3/b)+",0 z","fill:white")):(map.Dom.newShape("path",e.pointShObj,"M"+-c.x+","+-c.y+" l "+(h-map.Scale.normalX(4/b))+","+(c.y+f.height)+" "+map.Scale.normalX(4/b)+",0 z","fill:black;fill-opacity:0.5"),map.Dom.newShape("path",e.pointerObj,"M"+-c.x+","+-c.y+" l "+(h-map.Scale.normalX(4/b))+","+(c.y+f.height)+" "+map.Scale.normalX(3/b)+",0 z","fill:white"))):(f.height/5>q&&(c.y>-f.height/3&&(g-=f.height/3),
c.y<-f.height/3*2&&(g+=f.height/3)),0<h?(map.Dom.newShape("path",e.pointShObj,"M"+-c.x+","+-c.y+" l "+(c.x-f.width)+","+(g-map.Scale.normalX(4/b))+" 0,"+map.Scale.normalX(4/b)+" z","fill:black;fill-opacity:0.5"),map.Dom.newShape("path",e.pointerObj,"M"+-c.x+","+-c.y+" l "+(c.x-f.width)+","+(g-map.Scale.normalX(4/b))+" 0,"+map.Scale.normalX(3/b)+" z","fill:white")):(map.Dom.newShape("path",e.pointShObj,"M"+-c.x+","+-c.y+" l "+(c.x+f.width)+","+(g-map.Scale.normalX(4/b))+" 0,"+map.Scale.normalX(4/b)+
" z","fill:black;fill-opacity:0.5"),map.Dom.newShape("path",e.pointerObj,"M"+-c.x+","+-c.y+" l "+(c.x+f.width)+","+(g-map.Scale.normalX(4/b))+" 0,"+map.Scale.normalX(3/b)+" z","fill:white")))}};
MapTheme.prototype.declutterCharts=function(){if(!(this.szDeclutterUpper&&map.Scale.nTrueMapScale*map.Scale.nZoomScale>this.nDeclutterUpper)){for(var e=this.chartGroup.childNodes,b=0;b<e.length;b++)e[b].actualPosition&&(e[b].fu.setPosition(e[b].origPosition.x,e[b].origPosition.y),e[b].origPosition=null,e[b].actualPosition=null,e[b].pointerObj&&(map.Dom.clearGroup(e[b].pointerObj),map.Dom.clearGroup(e[b].pointShObj)),e[b].pointerObj=null,e[b].pointShObj=null);if(!e[0].actualPosition){var f=e[0].fu.getBox();
map.Zoom.getBox();for(var c=[],b=0;b<e.length;b++){var h=!1,g=e[b].fu.getPosition(),q=e[b].fu.getBox();q.x+=g.x;q.y+=g.y;for(var l in c)for(var r in c[l])if(!(q.y+q.height<c[l][r].box.y-.3*c[l][r].box.height||q.y>c[l][r].box.y+1.3*c[l][r].box.height||q.x+q.width<c[l][r].box.x-c[l][r].box.width||q.x>c[l][r].box.x+2*c[l][r].box.width)){c[l].push({node:e[b],y:e[b].fu.getPosition().x,box:q});h=!0;break}h||c.push([{node:e[b],y:e[b].fu.getPosition().x,box:q}])}for(l=0;l<c.length;l++)if(e=c[l],e.sort(this.sortUpChartObjectsCompare),
1<e.length&&5>e.length){h=e[0].node.fu.getPosition();for(b=0;b<e.length;b++)g=e[b].node.fu.getPosition(),g.y<h.y&&(h.x=g.x,h.y=g.y);h.y-=map.Scale.normalX(50)*map.Scale.nZoomScale;g=e[0].node.fu.getPosition();for(b=0;b<e.length;b++)e[b].node.origPosition=e[b].node.fu.getPosition(),e[b].node.fu.setPosition(g.x+1.2*f.width*b,h.y),e[b].node.actualPosition=new point(g.x+1.2*f.width*b,h.y),scale=e[b].node.fu.getScale().x,e[b].node.actualPosition.x=e[b].node.origPosition.x-(e[b].node.origPosition.x-e[b].node.actualPosition.x)/
scale,e[b].node.actualPosition.y=e[b].node.origPosition.y-(e[b].node.origPosition.y-e[b].node.actualPosition.y)/scale,map.Themes.makeChartOffsetPointer(e[b].node,this.nScale)}}}};
Map.Themes.prototype.setChartSizeType=function(e,b,f){if(b=this.getTheme(b)){for(var c="",h=b.szFlag.split("|"),g=0;g<h.length;g++)"SIZE"==h[g]||"FIXSIZE"==h[g]||"NOSIZE"==h[g]||"HEIGHT"==h[g]||"3D"==h[g]&&"2D"==f||(c+=(c.length?"|":"")+h[g]);executeWithMessage("map.Themes.doChangeThemeStyle('"+b.szId+"','type:"+(c+("|"+f))+"')","... processing ...")}e.stopPropagation();e.preventDefault()};
Map.Themes.prototype.toggleValueDisplay=function(e,b,f){if(b=this.getTheme(b)){for(var c="",h=b.szFlag.split("|"),g=0;g<h.length;g++)"VALUES"!=h[g]&&(c+=(c.length?"|":"")+h[g]);f&&(c+="|VALUES");executeWithMessage("map.Themes.doChangeThemeStyle('"+b.szId+"','type:"+c+"')","... processing ...")}e&&(e.stopPropagation(),e.preventDefault())};
Map.Themes.prototype.toggleDopacity=function(e,b,f){if(b=this.getTheme(b)){for(var c="",h=b.szFlag.split("|"),g=0;g<h.length;g++)h[g].match(/DOPACITY/)||(c+=(c.length?"|":"")+h[g]);f&&(c+="|DOPACITYMAX");executeWithMessage("map.Themes.doChangeThemeStyle('"+b.szId+"','type:"+c+"')","... processing ...")}e&&(e.stopPropagation(),e.preventDefault())};
Map.Themes.prototype.changeDopacityAlphaRamp=function(e,b,f){if(b=this.getTheme(b)){var c=b.szFlag;b.nDopacityScale=b.nDopacityScale||1;b.nDopacityScale*=f;executeWithMessage("map.Themes.doChangeThemeStyle('"+b.szId+"','type:"+c+"')","... processing ...")}e&&(e.stopPropagation(),e.preventDefault())};Map.Themes.prototype.toggleChartDisplay=function(e,b,f){if(b=this.getTheme(b))b.fToggle=!0,executeWithMessage("map.Themes.execute()","... processing ...");e.stopPropagation();e.preventDefault()};
Map.Themes.prototype.zoomTo=function(e,b){var f=this.getTheme(b)||this.activeTheme;f&&f.zoomTo()};Map.Themes.prototype.zoomToClass=function(e,b,f,c){setTimeout("map.Themes.doZoomToClass('"+b+"','"+f+"','"+c+"')",100)};
Map.Themes.prototype.markClass=function(e,b,f,c){var h=this.getTheme(b);if(h&&h.isVisible&&!h.showInfoMore)if("undefined"!=typeof h.markedClass&&h.markedClass==f||"undefined"!=typeof h.markedClasses&&h.markedClasses[f])this.unmarkClass(e,b,f);else{h.markedClass=f;h.markedClasses=h.markedClasses||[];h.markedClasses[f]=!0;h.markedClassesA=[];for(i in h.markedClasses)1==h.markedClasses[i]&&h.markedClassesA.push(i);h.fMarkEnable=!0;h.fUnmarkEnable=!1;this.markTimeout&&clearTimeout(this.markTimeout);this.unmarkTimeout&&
clearTimeout(this.unmarkTimeout);displayMessage("...",1E3,!0);this.markTimeout=setTimeout("map.Themes.doMarkClass('"+b+"','"+f+"','"+c+"')",50)}};
Map.Themes.prototype.unmarkClass=function(e,b,f){if((e=this.getTheme(b))&&e.isVisible&&!e.showInfoMore){e.markedClass=null;if(e.markedClasses){e.markedClasses[f]=!1;e.markedClassesA=[];for(i in e.markedClasses)1==e.markedClasses[i]&&e.markedClassesA.push(i);if(e.markedClassesA.length){displayMessage("...",1E3,!0);this.markTimeout=setTimeout("map.Themes.doMarkClass('"+b+"','"+e.markedClassesA[0]+"',1)",50);return}delete e.markedClassesA;delete e.markedClasses}displayMessage("...",1E3,!0);this.unmarkTimeout=
setTimeout("map.Themes.doUnmarkClass('"+b+"')",50);e.fUnmarkEnable=!0;e.fMarkEnable=!1}};Map.Themes.prototype.doZoomToClass=function(e,b,f){(e=this.getTheme(e))&&e.zoomToClass(Number(b),Number(f))};Map.Themes.prototype.doMarkClass=function(e,b,f){if(e=this.getTheme(e)){e.markClass(Number(b),Number(f));try{HTMLWindow.ixmaps.htmlgui_onDrawTheme(e.szId)}catch(c){}}};
Map.Themes.prototype.doUnmarkClass=function(e){if(this.subTheme)this.subTheme.removeSubTheme(),this.subTheme=null;else if(e=this.getTheme(e)){e.unmarkClass();try{HTMLWindow.ixmaps.htmlgui_onDrawTheme(e.szId)}catch(b){}}};Map.Themes.prototype.hideClass=function(e,b,f,c){(e=this.getTheme(b))&&e.isVisible&&e.showClass(Number(f),Number(c),!1)};Map.Themes.prototype.showClass=function(e,b,f,c){(e=this.getTheme(b))&&e.isVisible&&e.showClass(Number(f),Number(c),!0)};
Map.Themes.prototype.classesToRanges=function(e,b){var f=this.getTheme(b);f&&f.isVisible&&f.classesToRanges()};Map.Themes.prototype.filterItems=function(e,b,f,c){(e=b?this.getTheme(b):this.activeTheme)&&e.isVisible&&!e.showInfoMore&&(e.fMarkEnable=!0,e.fUnmarkEnable=!1,this.markTimeout&&clearTimeout(this.markTimeout),this.unmarkTimeout&&clearTimeout(this.unmarkTimeout),this.opt=c,this.markTimeout=setTimeout("map.Themes.doFilterItems('"+b+"','"+f+"')",500))};
Map.Themes.prototype.doFilterItems=function(e,b){executeWithMessage("map.Themes.doFilterItemsGo('"+e+"','"+b+"')","applying filter ...")};Map.Themes.prototype.doFilterItemsGo=function(e,b){clearMessage();var f=this.getTheme(e?e:null);f&&(f.filterItems(b,this.opt),this.activeTheme=f)};Map.Themes.prototype.selectFilterItems=function(e,b){var f=this.getTheme(b);f&&f.selectFilterItems()};
Map.Themes.prototype.highlightItems=function(e,b,f,c){(e=b?this.getTheme(b):this.activeTheme)&&e.isVisible&&(this.highlightTimeout&&clearTimeout(this.highlightTimeout),this.highlightTimeout=setTimeout("map.Themes.doHighlightItems('"+b+"','"+f+"','"+c+"')",500))};Map.Themes.prototype.doHighlightItems=function(e,b,f){(e=e?this.getTheme(e):this.activeTheme)&&e.highlightItems(b,f)};
Map.Themes.prototype.clearHighlightItems=function(e,b){var f=b?this.getTheme(b):this.activeTheme;f&&f.isVisible&&(this.highlightTimeout&&clearTimeout(this.highlightTimeout),f.clearHighlightItems())};Map.Themes.prototype.setTimeFrame=function(e,b,f,c){(e=this.getTheme(b))&&e.isVisible&&!e.showInfoMore&&(this.markTimeout&&clearTimeout(this.markTimeout),this.unmarkTimeout&&clearTimeout(this.unmarkTimeout),this.markTimeout=setTimeout("map.Themes.doSetTimeFrame('"+b+"',"+f+","+c+")",1))};
Map.Themes.prototype.doSetTimeFrame=function(e,b,f){(e=this.getTheme(e))&&e.setTimeFrame(b,f)};Map.Themes.prototype.changeThemeStyle=function(e,b,f,c){c.match(/fast||silent||direct/)?map.Themes.doChangeThemeStyle(b,f.replace(/'/g,"\\'"),c):executeWithMessage("map.Themes.doChangeThemeStyle('"+b+"','"+f.replace(/'/g,"\\'")+"','"+c+"')","... processing ...");e&&(e.stopPropagation(),e.preventDefault())};
function __calcNewValue(e,b,f){e=Number(e)||0;b=Number(b)||0;return f&&f.match(/pow/)?Math.pow(e,b):f&&f.match(/factor/)?e*b:f&&(f.match(/add/)||f.match(/delta/))?e+b:b}function __calcFactor(e,b,f){e=e||0;b=b||0;return f&&f.match(/factor/)?b:f&&f.match(/add/)?(e+b)/e:b/e}
Map.Themes.prototype.doChangeThemeStyle=function(e,b,f){var c=this.getTheme(e);if(c){if(b=__getStyleObj(b)){if(b.type){b.origType=b.type;if(f&&f.match(/add/)){var h=b.type.split("|");this.szTempStyle=c.szFlag;for(var g=0;g<h.length;g++)eval("this.szTempStyle.match(/"+h[g]+"/)")||(this.szTempStyle+="|"+h[g]);b.type=this.szTempStyle}else if(f&&f.match(/remove/)){for(var h=c.szFlag.split("|"),q="",g=0;g<h.length;g++)h[g]!=b.type&&(q+=(q.length?"|":"")+h[g]);b.type=q}else if(f&&f.match(/toggle/)){for(var h=
c.szFlag.split("|"),q="",l=!1,g=0;g<h.length;g++)h[g]!=b.type?q+=(q.length?"|":"")+h[g]:l=!0;b.type=q+(l?"":"|"+b.type)}else c.szFlag.match(/FRACTION/)&&(b.type+="|FRACTION"),c.szFlag.match(/PERMILLE/)&&(b.type+="|PERMILLE"),c.szFlag.match(/CALCVAL/)&&(b.type+="|CALCVAL"),c.szFlag.match(/CALC100/)&&(b.type+="|CALC100"),c.szFlag.match(/PRODUCT/)&&(b.type+="|PRODUCT"),c.szFlag.match(/RELATIVE/)&&(b.type+="|RELATIVE"),c.szFlag.match(/INVERT/)&&(b.type+="|INVERT"),c.szFlag.match(/INVERTSIZE/)&&(b.type+=
"|INVERTSIZE"),c.szFlag.match(/DENSITY/)&&(b.type+="|DENSITY"),c.szFlag.match(/SUM/)&&(b.type+="|SUM"),c.szFlag.match(/CALCMEAN/)&&(b.type+="|CALCMEAN"),c.szFlag.match(/AUTO100/)&&(b.type+="|AUTO100");b.type.match(/LOCKED/)&&(c.fRedrawInfo=!0,map.Themes.execute());if(b.type.match(/CHART/)&&!c.szFlag.match(/CHART/)||b.type.match(/CHOROPLETH/)&&!c.szFlag.match(/CHOROPLETH/))c.unpaintMap(),this.activateNextPaint(c);!b.type.match(/CATEGORICAL/)&&(b.type.match(/EQUIDISTANT/)||b.type.match(/POW2/)||b.type.match(/POW3/)||
b.type.match(/LOG/)||b.type.match(/QUANTILE/))&&(c.szOldRanges=c.szRanges?c.szRanges:c.szOldRanges,c.szRanges=null,c.szOldLabelA=c.szLabelA?c.szLabelA:c.szOldLabelA,c.szLabelA=null,c.fRealize=!0);b.type.match(/RANGES/)&&b.ranges&&(c.szRanges=c.szOldRanges?c.szOldRanges:c.szRanges,c.szRangesA=b.ranges.split(b.ranges.match(/\|/)?"|":","),c.szLabelA=c.szOldLabelA?c.szOldLabelA:c.szLabelA,Number(c.origColorScheme[0])&&c.szRanges&&(c.origColorScheme[0]=c.szRangesA.length-1),c.fRealize=!0);if(b.type.match(/RANGES/)&&
!b.ranges)for(a in c.szRangesA=[c.partsA[0].min],c.partsA)c.szRangesA.push(c.partsA[a].max);h=c.szFlag;c.szFlag=b.type;!c.szFlag.match(/CHART/)||c.szFlag.match(/BUFFER/)||h.match(/CHART/)||(c.fShadow=c.fOrigShadow=!0);b.origType.match(/AGGREGATE/)||b.origType.match(/GROUP/)||b.origType.match(/\bRECT\b/)||b.origType.match(/RELOCATE/)?(c.fRealize=!0,c.fRedraw=!1,c.unpaintMap(),c.themeNodesPosA=[]):(c.fRedraw=!0,c.fRedrawInfo=!0);b.type.match(/DTEXT/)!=h.match(/DTEXT/)&&c.unlabelMap();b.type.match(/AUTO100/)!=
h.match(/AUTO100/)&&(c.fRealize=!0,c.fRedraw=!1,c.unpaintMap());b.type.match(/DIFFERENCE/)!=h.match(/DIFFERENCE/)&&(c.fRealize=!0,c.fRedraw=!1,c.unpaintMap());b.type.match(/NOOUTLIER/)!=h.match(/NOOUTLIER/)&&(c.fRealize=!0,c.fRedraw=!1,c.unpaintMap());b.type.match(/OUTLIER/)!=h.match(/OUTLIER/)&&(c.fRealize=!0,c.fRedraw=!1,c.unpaintMap());b.type.match(/NEGATIVEISNOTVALUE/)!=h.match(/NEGATIVEISNOTVALUE/)&&(c.fNegativeValuePossible=!b.type.match(/NEGATIVEISNOTVALUE/),c.fRealize=!0,c.fRedraw=!0)}else if(f&&
f.match(/remove/)){for(p in b)for(s in themeStyleTranslateA)themeStyleTranslateA[s].style==p&&(c[themeStyleTranslateA[s].obj]=null);c.fReload=!0;c.fRealize=!0;c.unpaintMap();executeWithMessage("map.Themes.execute()","... processing ...");return}__isdef(b.classes)&&(isNaN(Number(c.origColorScheme[0]))&&(c.origColorScheme[3]=c.origColorScheme[c.origColorScheme.length/2],c.origColorScheme[4]="2colors",h=c.origColorScheme[c.origColorScheme.length-1],c.origColorScheme[1]=c.origColorScheme[0],c.origColorScheme[2]=
h),c.origColorScheme[0]=Number(b.classes),c.szFlag.match(/CHART/)&&c.unpaintMap(),c.szOldRanges=c.szRanges,c.szRanges=null,c.fRealize=!0);__isdef(b.ranges)&&(c.szRanges=b.ranges,c.szRangesA=b.ranges.split(b.ranges.match(/\|/)?"|":","),c.fRealize=!0);__isdef(b.colorstyle)&&"spectrum"==c.origColorScheme[1]&&(c.origColorScheme[2]=b.colorstyle,c.szFlag.match(/CHART/)&&c.unpaintMap(),c.fRealize=!0);__isdef(b.colordef)&&(c.origColorScheme=b.colordef.match(/\|/)?b.colordef.split("|"):b.colordef.split(","),
c.colorScheme=c.origColorScheme,c.fRedraw=!0,c.szFlag.match(/CHART/)||(c.fRealize=!0),c.fRedrawInfo=!0,c.showInfo());if(__isdef(b.colorscheme)&&(h=b.colorscheme.match(/\|/)?b.colorscheme.split("|"):b.colorscheme.split(","))&&h.length){isNaN(Number(c.origColorScheme[0]))&&(c.origColorScheme[0]=c.origColorScheme.length);c.origColorScheme.length=1;for(g=0;5>g;g++)c.origColorScheme[g+1]=g<h.length?h[g]:null;try{c.colorScheme=ColorScheme.createColorScheme(c.origColorScheme[1],c.origColorScheme[2],c.origColorScheme[0],
c.origColorScheme[3],c.origColorScheme[4])}catch(r){c.colorScheme=c.defaultColorScheme}c.fRedraw=!0;c.szFlag.match(/CHART/)||(c.fRealize=!0);c.fRedrawInfo=!0;c.showInfo()}if(__isdef(b.colorschemegeneration)&&!isNaN(Number(c.origColorScheme[0]))){switch(b.colorschemegeneration){case "warm":c.origColorScheme[4]="#FFFDD8";break;case "cold":c.origColorScheme[4]="#FFFFFF";break;default:c.origColorScheme[4]=b.colorschemegeneration}c.szFlag.match(/CHART/)&&c.unpaintMap();try{c.colorScheme=ColorScheme.createColorScheme(c.origColorScheme[1],
c.origColorScheme[2],c.origColorScheme[0],c.origColorScheme[3],c.origColorScheme[4])}catch(k){c.colorScheme=c.defaultColorScheme}c.fRedraw=!0;c.fRedrawInfo=!0}__isdef(b.symbols)&&(c.szSymbolsA=b.symbols.split(b.symbols.match(/\|/)?"|":","),c.fRealize=!0);if(__isdef(b.values)){h=this.toArray(b.values);if(h.length)for(g=0;g<h.length;g++)c.getStringValueIndex(h[g],"set");c.szValuesA=[];c.szLabelA=[];for(g in c.nStringToValueA)c.szValuesA.push(g),c.szLabelA.push(g);c.fRealize=!0}__isdef(b.dominantdfilter)&&
(c.nDominantDFilter=Number(b.dominantdfilter),c.fRealize=!0);__isdef(b.dominantfilter)&&(c.szDominantFilter=String(b.dominantfilter),c.fRealize=!0);__isdef(b.filter)&&(f&&f.match(/remove/)?c.szFilter="":c.szFilter=String(b.filter),c.fRealize=!0,c.unpaintMap());__isdef(b.filterfield)&&(c.szFilterField=String(b.filterfield),c.fRealize=!0);__isdef(b.markclasses)&&(c.markedClassesA=this.toArray(b.markclasses),c.markedClasses=[],c.unmarkClass(),c.markedClassesA.forEach(function(b,e){0<=b&&(c.markedClasses[b]=
!0,c.markClass(b))}));__isdef(b.field100min)&&(c.nField100Min=b.field100min,c.fRealize=!0);__isdef(b.overviewchart)&&!c.szFlag.match(/CHART/)&&(c.szOverviewChart=b.overviewchart,c.fRedrawInfo=!0);__isdef(b.evidence)&&(c.evidenceMode=b.evidence);__isdef(b.aggregation)&&(c.szAggregation=b.aggregation);__isdef(b.opacity)&&(c.fOpacity=__calcNewValue(c.fOpacity,Number(b.opacity),f));__isdef(b.fillopacity)&&(c.fillOpacity=__calcNewValue(c.fillOpacity||(1>Number(b.fillopacity)?1:0),Number(b.fillopacity),
f),c.fillOpacity=Math.min(Math.max(c.fillOpacity,.001),1),c.fRedraw=!0);__isdef(b.shadow)&&(c.fShadow="toggle"==b.shadow?c.fOrigShadow=!c.fOrigShadow:c.fOrigShadow=b.shadow,c.fRedraw=!0);__isdef(b.showdata)&&(c.fShowData="toggle"==b.showdata?!c.fShowData:JSON.parse(b.showdata),c.fRedraw=!0);__isdef(b.blur)&&("toggle"==b.blur?c.nBlur?(c.nOldBlur=c.nBlur,c.nBlur=0):c.nBlur=c.nOldBlur||1:c.nBlur=__calcNewValue(c.nBlur,Number(b.blur),f),c.fBlur=!0);__isdef(b.scale)&&(c.fResize=__calcFactor(c.nScale,Number(b.scale),
f));__isdef(b.dopacityscale)&&(c.nDopacityScale=__calcNewValue(c.nDopacityScale,Number(b.dopacityscale),f),c.fRedraw=!0);__isdef(b.d_dopacityscale)&&(c.nDopacityScale*=Number(b.d_dopacityscale),c.fRedraw=!0);__isdef(b.alphafield)&&(c.szAlphaField=String(b.alphafield),c.fRealize=!0);__isdef(b.alphafield100)&&(c.szAlphaField100=String(b.alphafield100),c.fRealize=!0);__isdef(b.dopacityramp)&&(c.szDopacityRamp=b.dopacityramp,c.fRealize=!0);__isdef(b.dopacitypow)&&(c.nDopacityPow=__calcNewValue(c.nDopacityPow,
Number(b.dopacitypow),f),c.fRealize=!0);__isdef(b.brightness)&&(c.nBrightness=__calcNewValue(c.nBrightness||1,Number(b.brightness),f),c.fRealize=!0);__isdef(b.rangescale)&&(c.nRangeScale=__calcNewValue(c.nRangeScale||1,Number(b.rangescale),f),c.fRedraw=!0);__isdef(b.sizefield)&&(c.szSizeField=String(b.sizefield),c.fRealize=!0);__isdef(b.timefield)&&(c.szTimeField=String(b.timefield),c.fRealize=!0);__isdef(b.xfield)&&(c.szXField=String(b.xfield),c.fRealize=!0);__isdef(b.yfield)&&(c.szYField=String(b.yfield),
c.fRealize=!0);__isdef(b.labelfield)&&(c.szLabelField=String(b.labelfield),c.fRealize=!0);__isdef(b.colorfield)&&(c.szColorField=String(b.colorfield),c.fRealize=!0);__isdef(b.symbolfield)&&(c.szSymbolField=String(b.symbolfield),c.fRealize=!0);__isdef(b.valuefield)&&(c.szValueField=String(b.valuefield),c.fRealize=!0);__isdef(b.normalsizevalue)&&(c.nNormalSizeValue||(c.nNormalSizeValue=c.szSizeField?c.nMaxSize:c.nMax),c.nNormalSizeValue=__calcNewValue(c.nNormalSizeValue,Number(b.normalsizevalue),f),
c.fRedraw=!0);__isdef(b.minvalue)&&(c.nMinValue=__calcNewValue(c.nMinValue||1,Number(b.minvalue),f),c.fRedraw=!0);__isdef(b.valuedecimals)&&(c.szValueDecimals=b.valuedecimals,c.fRedraw=!0);__isdef(b.valuescale)&&(c.nValueScale=__calcNewValue(c.nValueScale,Number(b.valuescale),f),c.fRedraw=!0);__isdef(b.linewidth)&&(c.nLineWidth=__calcNewValue(c.nLineWidth,Number(b.linewidth),f),c.fRedraw=!0);__isdef(b.markersize)&&(c.nMarkerSize=__calcNewValue(c.nMarkerSize,Number(b.markersize),f),c.fRedraw=!0);__isdef(b.gapsize)&&
(c.nGapSize=__calcNewValue(c.nGapSize,Number(b.gapsize),f),c.fRedraw=!0);__isdef(b.linecolor)&&(c.szLineColor=String(b.linecolor),c.fRedraw=!0);__isdef(b.valueupper)&&(c.szValueUpper=b.valueupper,c.nValueUpper=__scanScaleValue(c.szValueUpper),c.fRedraw=!0);__isdef(b.titleupper)&&(c.szTitleUpper=b.titleupper,c.nTitleUpper=__scanScaleValue(c.szTitleUpper),c.fRedraw=!0);__isdef(b.boxupper)&&(c.szBoxUpper=b.boxupper,c.nBoxUpper=__scanScaleValue(c.szBoxUpper),c.fRedraw=!0);__isdef(b.shadowupper)&&(c.szShadowUpper=
b.shadowupper,c.nShadowUpper=__scanScaleValue(c.szShadowUpper),c.fRedraw=!0);__isdef(b.shadowlower)&&(c.szShadowLower=b.shadowlower,c.nShadowLower=__scanScaleValue(c.szShadowLower),c.fRedraw=!0);__isdef(b.declutterupper)&&(c.szDeclutterUpper=b.declutterupper,c.nDeclutterUpper=__scanScaleValue(c.szdeclutterUpper),c.fRedraw=!0);__isdef(b.aggregationupper)&&(c.szAggregationUpper=b.aggregationupper,c.nAggregationUpper=__scanScaleValue(c.szAggregationUpper),c.fRedraw=!0);__isdef(b.aggregationlower)&&(c.szAggregationLower=
b.aggregationlower,c.nAggregationLower=__scanScaleValue(c.szAggregationLower),c.fRedraw=!0);__isdef(b.minvaluesize)&&(c.nValueSizeMin=__calcNewValue(c.nValueSizeMin,Number(b.minvaluesize),f),c.fRedraw=!0);__isdef(b.clipvaluesize)&&(c.nValueSizeMin=__calcNewValue(c.nValueSizeMin,Number(b.clipvaluesize),f),c.fRedraw=!0);__isdef(b.minsize)&&(c.nChartSizeMin=__calcNewValue(c.nChartSizeMin,Number(b.minsize),f),c.fRedraw=!0);__isdef(b.minchartsize)&&(c.nChartSizeMin=__calcNewValue(c.nChartSizeMin,Number(b.minchartsize),
f),c.fRedraw=!0);__isdef(b.maxcharts)&&(c.nMaxCharts=__calcNewValue(c.nMaxCharts,Number(b.maxcharts),f),c.nMaxCharts=Math.max(1,Math.round(c.nMaxCharts)),c.unpaintMap(),c.fRedraw=!0);__isdef(b.sizepow)&&(c.nSizePow=__calcNewValue(c.nSizePow,Number(b.sizepow),f),c.fRedraw=!0);__isdef(b.clipsize)&&(c.nChartSizeMin=__calcNewValue(c.nChartSizeMin,Number(b.clipsize),f),c.fRedraw=!0);__isdef(b.clipparts)&&(c.nClipParts=Number(b.clipparts),c.fRedraw=!0);__isdef(b.showparts)&&(c.szShowParts=b.showparts,c.szShowPartsA=
b.showparts.split(b.showparts.match(/\|/)?"|":","),map.Themes.unmarkClass(null,e),c.fRedraw=!0);__isdef(b.clipframerate)&&(c.nClipFrameRate=__calcNewValue(c.nClipFrameRate||1,Number(b.clipframerate),f),c.nClipTimeout=1/c.nClipFrameRate*1E3,c.fRedraw=!0);__isdef(b.gridx)&&(c.nGridX=Number(b.gridx)||7,c.fRedraw=!0);__isdef(b.gridwidth)&&(c.szAggregationField=null,"auto"==b.gridwidth?c.nGridWidthPx=c.nGridWidthPx||50:String(b.gridwidth).match(/px/)?c.nGridWidthPx=__calcNewValue(c.nGridWidthPx||1,Number(b.gridwidth),
f):"factor"==f?__isdef(c.nGridWidthPx)?c.nGridWidthPx=__calcNewValue(c.nGridWidthPx||1,Number(b.gridwidth),f):c.nGridWidth=__calcNewValue(c.nGridWidth||1E3,Number(b.gridwidth),f):(c.nGridWidthPx=null,c.nGridWidth=__calcNewValue(c.nGridWidth||1,Number(b.gridwidth),f)),c.fRealize=!0,c.fRedraw=!0,c.fSuppressAggregationScale=!0,c.themeNodesPosA=[],c.unpaintMap());__isdef(b.gridmatrix)&&(c.szAggregationField=null,c.nGridMatrix=__calcNewValue(c.nGridMatrix||1,Number(b.gridmatrix),f),c.fRealize=!0,c.fRedraw=
!0,c.fSuppressAggregationScale=!0,c.unpaintMap(),c.themeNodesPosA=[]);__isdef(b.gridwidthpx)&&(c.szAggregationField=null,c.nGridWidthPx=__calcNewValue(c.nGridWidthPx||50,Number(b.gridwidthpx),f),c.fRealize=!0,c.fRedraw=!0,c.fSuppressAggregationScale=!0,c.unpaintMap(),c.themeNodesPosA=[]);__isdef(b.gridoffsetx)&&(c.nGridOffsetX=__calcNewValue(c.nGridOffsetX||0,Number(b.gridoffsetx),f),c.fRealize=!0,c.fRedraw=!0,c.fSuppressAggregationScale=!0,c.unpaintMap(),c.themeNodesPosA=[]);__isdef(b.gridoffsety)&&
(c.nGridOffsetY=__calcNewValue(c.nGridOffsetY||0,Number(b.gridoffsety),f),c.fRealize=!0,c.fRedraw=!0,c.fSuppressAggregationScale=!0,c.unpaintMap(),c.themeNodesPosA=[]);__isdef(b.aggregationfield)&&(c.szAggregationField=b.aggregationfield,c.fRealize=!0,c.fRedraw=!0,c.fSuppressAggregationScale=!0,c.unpaintMap(),c.themeNodesPosA=[]);__isdef(b.snippet)&&(c.szSnippet=unescape(b.snippet),c.fRealize=!0);__isdef(b.title)&&(c.szTitle=unescape(b.title),c.fRealize=!0);__isdef(b.child)&&(c.fChild=!0)}c.fRedrawInfo=
!0;map.Themes.execute()}};Map.Themes.prototype.getThemeLayerList=function(){for(var e=[],b,f=0;f<this.themesA.length;f++)if(this.themesA[f].objThemesA&&!this.themesA[f].fRemove)for(b in this.themesA[f].objThemesA)e[e.length]=b;return e};Map.Themes.prototype.isThemeLayerUsed=function(e){for(var b=this.getThemeLayerList(),f=0;f<b.length;f++)if(e==b[f])return!0;return!1};
Map.Themes.prototype.isNodePartOfAnyTheme=function(e){if(e=map.Layer.getLayerObjOfNode(e))for(var b=map.Themes.getThemeLayerList(),f=0;f<b.length;f++)if(e.szName==b[f])return!0;return!1};Map.Themes.prototype.resetThemeNodesCache=function(){this.themeNodesA=[];this.themeNodes=0};
Map.Themes.prototype.addToThemeNodesCache=function(e){var b=0;nodeA=e.getElementsByTagName("g");for(n=0;n<nodeA.length;n++)if(e=String(map.Tiles.getMasterId(nodeA.item(n).getAttributeNS(null,"id"))))map.Themes.themeNodesA[e]||(map.Themes.themeNodesA[e]=[]),map.Themes.themeNodesA[e].push(nodeA.item(n)),map.Themes.themeNodes++,b++};
Map.Themes.prototype.removeFromThemeNodesCache=function(e){var b=0;nodeA=e.getElementsByTagName("g");for(n=0;n<nodeA.length;n++)if((e=String(map.Tiles.getMasterId(nodeA.item(n).getAttributeNS(null,"id"))))&&map.Themes.themeNodesA[e]){var f=map.Themes.themeNodesA[e].indexOf(nodeA.item(n));-1<f&&(map.Themes.themeNodesA[e].splice(f,1),b++)}};Map.Themes.prototype.setActive=function(e){this.activeTheme=e};
Map.Themes.prototype.minimizeInfo=function(e,b){var f=this.getTheme(b);if(f){var c=f.widgetNode.firstChild;if(c){var h=Number(c.getAttributeNS(szMapNs,"titleheight"));0>=h&&(h=420);for(var c=c.childNodes,g=0;g<c.length;g++){var q=c.item(g),l=q.getAttributeNS(null,"id");l.match(/body/)&&q.style.setProperty("display","none","");l.match(/footer/)&&q.style.setProperty("display","none","");l.match(/backgroundrect/)&&(q.setAttributeNS(szMapNs,"maxheight",q.getAttributeNS(null,"height")),q.setAttributeNS(null,
"height",h));l.match(/shadowrect/)&&(q.setAttributeNS(szMapNs,"maxheight",q.getAttributeNS(null,"height")),q.setAttributeNS(null,"height",String(h-100)));l.match(/minimizebutton/)&&q.style.setProperty("display","none","")}f.minimizebutton.nodeObj.style.setProperty("display","none","");f.morebutton.nodeObj.style.setProperty("display","none","");f.addDefinitionToFlag("MINIMIZED")}}};
Map.Themes.prototype.maximizeInfo=function(e,b){var f=this.getTheme(b);if(f){var c=f.widgetNode.firstChild;if(c){for(var c=c.childNodes,h=0;h<c.length;h++){var g=c.item(h),q=g.getAttributeNS(null,"id");q.match(/body/)&&g.style.setProperty("display","inline","");q.match(/footer/)&&g.style.setProperty("display","inline","");q.match(/backgroundrect/)&&g.setAttributeNS(null,"height",g.getAttributeNS(szMapNs,"maxheight"));q.match(/shadowrect/)&&g.setAttributeNS(null,"height",g.getAttributeNS(szMapNs,"maxheight"));
q.match(/minimizebutton/)&&g.style.setProperty("display","inline","")}f.minimizebutton.nodeObj.style.setProperty("display","inline","");f.morebutton.nodeObj.style.setProperty("display","inline","");f.removeDefinitionFromFlag("MINIMIZED")}}};
Map.Themes.prototype.getChartAll=function(e,b,f){for(var c=b.getAttributeNS(null,"id"),h=0,g=0;g<this.themesA.length;g++){var q=map.Dom.newGroup(b,c+":C1");this.getChart(e,q,f,this.themesA[g]);var l=map.Dom.getBox(q);0>l.width&&(l=new box(0,0,0,0));q.fu.setPosition(0,h);h+=l.height+map.Scale.normalY(10);this.themesA[g].szFlag.match(/AGGREGATE/)&&(l=e.split("::")[0]+"::"+this.themesA[g].getNodePosition(e).x+","+this.themesA[g].getNodePosition(e).y,this.getChart(l,q,f,this.themesA[g]),l=map.Dom.getBox(q),
0>l.width&&(l=new box(0,0,0,0)),q.fu.setPosition(0,h),h+=l.height+map.Scale.normalY(10))}};
Map.Themes.prototype.getChart=function(e,b,f,c){c||(c=this.activeTheme);if(!c)return null;e&&":paint"==e.substr(e.length-6,6)&&(e=e.substr(0,e.length-6));if(c.szFlag.match(/CHOROPLETH/)&&c.szFlag.match(/DOMINANT|COMPOSE/)){var h=30;2<c.nOrigSumA.length&&(h=15*c.nOrigSumA.length/Math.log(c.nOrigSumA.length));f=map.Dom.newGroup(b,b.getAttributeNS(null,"id")+":1");if(c.szFlag.match(/PERCENTOFMEAN/)||c.szFlag.match(/PERCENTOFMEDIAN/)||c.szFlag.match(/DEVIATION/)){c.drawChart(f,e,h,"CHART|BAR|VALUES|ZOOM",
e&&c.itemA[e]?c.itemA[e].nDominant:null);var g=map.Dom.getBox(f);0>g.width&&(g=new box(0,0,0,0));f=map.Dom.newGroup(b,b.getAttributeNS(null,"id")+":2");b=c.szUnit;c.szUnit="";c.drawChart(f,e,h,"VALUES|ZOOM");c.szUnit=b;e=map.Dom.getBox(f);b=1<c.nOrigSumA.length?g.width/e.width*1.015:e.width/e.height;f.fu.setPosition(e.x-g.x,g.height+g.y+Math.min(map.Scale.normalY(200),Math.max(map.Scale.normalY(10),-e.y+map.Scale.normalY(6))));f.fu.scale(b,1);c=c.szFlag.match(/PERCENTOFMEDIAN/)?"median":"mean";e=
e.width;map.Dom.newText(f,e,map.Scale.normalY(.9),"font-family:arial;font-size:"+map.Scale.normalY(4)+"px;fill:#808080",map.Dictionary.getLocalText(c));map.Dom.newText(f,e,map.Scale.normalY(5.5),"font-family:arial;font-size:"+map.Scale.normalY(4)+"px;fill:#808080",map.Dictionary.getLocalText("-"));map.Dom.newText(f,e,map.Scale.normalY(-3.7),"font-family:arial;font-size:"+map.Scale.normalY(4)+"px;fill:#808080",map.Dictionary.getLocalText("+"))}else b="CHART|BAR|SPACED|VALUES|ZOOM",c.szFlag.match(/3D/)&&
(b+="|3D"),c.szFlag.match(/\bSORT\b/)&&(b+="|SORT"),c.szFlag.match(/HORZ/)&&(b+="|HORZ|AXIS"),c.drawChart(f,e,h,b,null);return new point(0,map.Scale.normalY(30))}if(c.szFlag.match(/BUFFER/)&&c.szFlag.match(/CHART/))return null;if(c.szFlag.match(/CHOROPLETH/)&&c.itemA[e])return h=c.itemA[e].nValuesA[c.nActualFrame||0],f=__scaleStyleString(map.Scale.tStyle.Summary.szStyle,1),c.szFlag.match(/CATEGORICAL/)&&c.szLabelA&&c.szLabelA.length?h=c.szLabelA[h-1]:(g=10>c.nMax-c.nMin?2:0,h=c.formatValue(h,c.szValueDecimals||
g)+c.szUnit),c.szFlag.match(/CLIP/)&&c.szXaxisA&&map.Dom.newText(b,-40,-280,__scaleStyleString(map.Scale.tStyle.Summary.szStyle,.8)+";font-weight:normal;fill:#888888",c.szXaxisA[c.nActualFrame]),map.Dom.newText(b,-40,0,f+";font-weight:normal;fill:#888888",h),f=__scaleStyleString(map.Scale.tStyle.Summary.szStyle,.8),h=c.itemA[e].szTitle,"undefined"!=typeof h&&"undefined"!=h&&map.Dom.newText(b,-40,280,f+";font-weight:normal;fill:#888888",h),!c.szFlag.match(/CATEGORICAL/)&&(c.szChoroplethInfoStyle.match(/HISTOGRAM/)||
c.szChoroplethInfoStyle.match(/histogram/)||c.szChoroplethInfoStyle.match(/CLASSES/)||c.szChoroplethInfoStyle.match(/classes/))&&(h=c.szChoroplethInfoStyle.match(/HISTOGRAM/)||c.szChoroplethInfoStyle.match(/histogram/),f=map.Dom.newGroup(b,b.getAttributeNS(null,"id")+":histogram"),this.getHistogram(e,f,h?"DISTRIBUTION":"CLASSES",c),f.fu.setPosition(0,map.Scale.normalY(4))),new point(0,0);if(c.szFlag.match(/INFOSIZE/))return c.drawChart(b,e,30,f);h=30;c.szFlag.match(/SEQUENCE/)&&(h=25);c.szFlag.match(/BAR/)&&
(c.szFlag.match(/STACKED/)?h=300:2>=c.nOrigSumA.length?h=30:(c.szFlag.match(/\bUP\b/)||c.szFlag.match(/CENTER/)||c.szFlag.match(/SEQUENCE/),h=15*c.nOrigSumA.length/Math.log(c.nOrigSumA.length)));return c.drawChart(b,e,h,f)};
Map.Themes.prototype.getSummary=function(e,b){b||(b=this.activeTheme);if(!b||!e)return null;b.itemA[e]||(aA=e.split("::"),1<aA.length&&(e=aA[0]+"::"+String(aA[1]).toUpperCase()));if(!b.itemA[e])return null;for(var f=b.itemA[e].nOrigValuesA,c=0,h=0;h<f.length;h++)isNaN(f[h])&&(f[h]=0),c+=f[h];b.szFlag.match(/DIFFERENCE/)&&(c=f[f.length-1]);if(b.itemA[e].nValue100){b.szUnits100=b.szUnits100||"";if(b.szFlag.match(/RELATIVE/)||b.szFlag.match(/DIFFERENCE/))return map.Dictionary.getLocalText("Relative to")+
": "+String(b.formatValue(b.itemA[e].nValue100,b.szValueDecimals||0))+" "+(b.szUnits100||"");if(b.itemA[e].nSize){if(b.szAggregation.match(/sum/))return map.Dictionary.getLocalText("Counted")+": "+String(b.formatValue(b.itemA[e].nSize,b.szValueDecimals||0))+" "+(b.szUnits100||"")}else if(c!=b.itemA[e].nValue100)return String(__formatValue(c,2))+" / "+String(b.formatValue(b.itemA[e].nValue100,b.szValueDecimals||0))+" "+(b.szUnits100||"")}else if(b.itemA[e].nSize){if(b.szFlag.match(/CATEGORICAL/)&&
1==b.itemA[e].nValuesA.length&&b.szValueField)return b.szLabelA[b.itemA[e].nValuesA[0]-1]}else{if(b.itemA[e].nAlpha)return map.Dictionary.getLocalText("Alpha value")+": "+String(b.formatValue(b.itemA[e].nAlpha,b.szValueDecimals||0))+" "+(b.szAlphaValueUnits||"");!b.szFlag.match(/SUM/)||b.szFlag.match(/SEQUENCE/)||b.szFlag.match(/\bCLIP\b/)}return null};
Map.Themes.prototype.getValueComment=function(e,b){b||(b=this.activeTheme);if(!b||!e)return null;b.itemA[e]||(aA=e.split("::"),1<aA.length&&(e=aA[0]+"::"+String(aA[1]).toUpperCase()));if(!b.itemA[e])return null;for(var f=b.itemA[e].nOrigValuesA,c=0;c<f.length;c++)isNaN(f[c])&&(f[c]=0);b.szFlag.match(/DIFFERENCE/);return b.szFlag.match(/OFFSETMEAN/)?map.Dictionary.getLocalText("value")+": "+String(__formatValue(b.itemA[e].nValuesA[0],2))+" "+map.Dictionary.getLocalText("mean")+": "+String(__formatValue(b.nMeanA[0],
2)):null};Map.Themes.prototype.getTitle=function(e,b){b||(b=this.activeTheme);if(!b||!e)return null;e=String(map.Tiles.getMasterId(e));b.itemA[e]||(aA=e.split("::"),1<aA.length&&(e=aA[0]+"::"+String(aA[1]).toUpperCase()));return b.itemA[e]?b.itemA[e].szTitle||null:null};Map.Themes.prototype.getLabel=function(e,b){b||(b=this.activeTheme);if(!b||!e)return null;b.itemA[e]||(aA=e.split("::"),1<aA.length&&(e=aA[0]+"::"+String(aA[1]).toUpperCase()));return b.itemA[e]?b.itemA[e].szLabel||null:null};
Map.Themes.prototype.getTextObjects=function(){for(var e=[],b=0;b<this.themesA.length;b++)if(this.themesA[b].szFlag.match(/TEXTONLY/)&&this.themesA[b].chartGroup)if("undefined"!=typeof this.themesA[b].markedClass&&null!=this.themesA[b].markedClass){nClass=this.themesA[b].markedClass;var f=this.themesA[b].chartGroup.getElementsByTagName("text");for(n=0;n<f.length;n++)0<f.item(n).firstChild.nodeValue.length&&Number(f.item(n).getAttributeNS(szMapNs,"class"))==nClass&&e.push(f.item(n))}else for(f=this.themesA[b].chartGroup.getElementsByTagName("text"),
n=0;n<f.length;n++)0<f.item(n).firstChild.nodeValue.length&&e.push(f.item(n));return e};Map.Themes.prototype.getMaxValue=function(e,b){b||(b=this.activeTheme);if(!b||!e)return null;for(var f=0,c=b.itemA[e].nValuesA,h=0;h<c.length;h++)isNaN(c[h])&&(c[h]=0),f=Math.max(f,c[h]);return f};
Map.Themes.prototype.getDataRow=function(e,b){b||(b=this.activeTheme);if(!b||!e)return null;b.itemA[e]||(aA=e.split("::"))&&1<aA.length&&(e=aA[0]+"::"+String(aA[1]).toUpperCase());if(!b.itemA[e])return null;var f=b.objThemesA[b.szThemesA[0]],c=[];if(b.szDataFieldsA)for(var h=0;h<b.szDataFieldsA.length;h++)for(var g=0;g<f.dbFields.length;g++)b.szDataFieldsA[h]==f.dbFields[g].id&&c.push(g);else for(g=0;g<f.dbFields.length;g++)c.push(g);var q=[];if(f.dbRecords){if("undefined"!=typeof b.itemA[e].dbIndexA&&
b.itemA[e].dbIndexA.length){for(d in b.itemA[e].dbIndexA)for(0<d&&q.push("--------------------"),g=0;g<c.length;g++)q.push(f.dbFields[c[g]].id);for(d in b.itemA[e].dbIndexA)for(0<d&&q.push("--------------------"),h=b.itemA[e].dbIndexA[d],g=0;g<c.length;g++)q.push(f.dbRecords[h][c[g]]);return q}if("undefined"!=typeof b.itemA[e].dbIndex){h=b.itemA[e].dbIndex;for(g=0;g<c.length;g++)q.push(f.dbFields[c[g]].id);for(g=0;g<c.length;g++)q.push(f.dbRecords[h][c[g]]);return q}e=e.split("::")[1];for(h=0;h<f.dbRecords.length;h++)if(f.dbRecords[h]&&
f.dbRecords[h][f.nFieldSelectionIndex]&&String(f.dbRecords[h][f.nFieldSelectionIndex]).toUpperCase()==String(e).toUpperCase()){for(g=0;g<f.dbFields.length;g++)q.push(f.dbFields[g].id);for(g=0;g<f.dbFields.length;g++)q.push(f.dbRecords[h][g]);break}}return q};
Map.Themes.prototype.getFieldIndexArray=function(e){e||(e=this.activeTheme);if(!e||e.szDataFieldsA)return[];e.fieldIndexArray=[];for(var b=0;b<e.objThemesA[e.szThemesA[0]].nFieldIndexA.length;b++)e.fieldIndexArray.push(e.objThemesA[e.szThemesA[0]].nFieldIndexA[b]);0<=e.objThemesA[e.szThemesA[0]].nField100Index&&e.fieldIndexArray.push(e.objThemesA[e.szThemesA[0]].nField100Index);return e.fieldIndexArray};
Map.Themes.prototype.getScatterArray=function(e,b,f){e||(e=this.activeTheme);var c=0,h=e.nMin,g=e.nMax,q=0,l;f.match(/LOG/)?(q=1-h,h=Math.log(h+q),g=Math.log(g+q)):f.match(/POW2/)&&(q=1-h,h=Math.pow(h+q,.5),g=Math.pow(g+q,.5));f.match(/POW3/)&&(q=1-h,h=Math.pow(h+q,1/3),g=Math.pow(g+q,1/3));for(var g=(g-h)/b,r=[],k=0;k<b+1;k++)r[k]=0;for(l in e.itemA)k=e.itemA[l].nValuesA[0],"number"==typeof k&&(f.match(/LOG/)?k=Math.log(k+q):f.match(/POW2/)?k=Math.pow(k+q,.5):f.match(/POW3/)&&(k=Math.pow(k+q,1/3)),
nPos=Math.max(0,Math.min(b-1,Math.floor((k-h)/g))),r[nPos]++,c=Math.max(c,r[nPos]));return r};Map.Themes.prototype.getResolutionQualityOfArray=function(e){for(var b=e.length,f=-1E6,c=0;c<b;c++)f=Math.max(f,e[c]);for(c=nCount=0;c<b;c++)e[c]>f/10&&nCount++;return nCount/b*100};Map.Themes.prototype.getDeviationOfArray=function(e){for(var b=e.length,f=-1E6,c=0,h=0,g=0,g=0;g<b;g++)f=Math.max(f,e[g]),c+=e[g];c/=b;for(g=0;g<b;g++)h+=(e[g]-c)*(e[g]-c);return g=Math.sqrt(h/b)};
Map.Themes.prototype.getHistogram=function(e,b,f,c){if(!b)return null;c||(c=this.activeTheme);if(!c||c.nMin==c.nMax||e&&(c.itemA[e]||(aA=e.split("::"),1<aA.length&&(e=aA[0]+"::"+String(aA[1]).toUpperCase())),!c.itemA[e]))return null;this.histGroup=map.Dom.newGroup(b,b.getAttributeNS(null,"id")+":group");this.histFlag=f;this.histTheme=c;b=map.Scale.normalX(70);f=map.Scale.normalY(20);map.Dom.newShape("rect",this.histGroup,0,0,b-map.Scale.normalX(.5),f,"fill:none;stroke:none;");e?setTimeout("map.Themes.makeHistogram('"+
e+"')",100):setTimeout("map.Themes.makeHistogram()",100)};
Map.Themes.prototype.makeHistogram=function(e){var b=this.histGroup,f=this.histFlag,c=this.histTheme;if(f.match("CLASSES")){for(var h=map.Scale.normalX(50),g=map.Scale.normalY(5),q=h/c.colorScheme.length,l=0,r=0,k=e?c.itemA[e].nValuesA[0]:0,w=0,m=0;m<c.partsA.length;m++){var q=h/c.nCount*c.partsA[m].nCount,x=map.Dom.newShape("rect",b,l,r,q,g,"fill:"+c.colorScheme[m]+";stroke:black;stroke-width:1;");x&&x.setAttributeNS(szMapNs,"tooltip",c.szLegendLabelA[m]+" ("+c.formatValue(c.partsA[m].nCount)+" "+
map.Dictionary.getLocalText("members")+")");l+=q;k>c.partsA[m].max?w+=q:k>c.partsA[m].min&&(w+=q/(c.partsA[m].max-c.partsA[m].min)*(k-c.partsA[m].min))}map.Dom.newShape("circle",b,w,-map.Scale.normalX(.1),map.Scale.normalX(1),"fill:#444444;stroke:none;")}else if(f.match("DISTRIBUTION")){if(!isFinite(c.nMin)||!isFinite(c.nMax))return b;w=Math.min(140,Math.max(20,c.nCount/5));w=Math.min(500,Math.max(20,c.nCount/5));h=map.Scale.normalX(70);g=map.Scale.normalY(12);f.match("INTERACTIVE")&&(g=map.Scale.normalY(20));
var v=h/w,k=e?c.itemA[e].nValuesA[0]:0,z=0,y=c.nMin,J=c.nMax,C=0,F=this.getScatterArray(c,w,""),m=this.getDeviationOfArray(F),l=this.getScatterArray(c,w,"LOG"),r=this.getDeviationOfArray(l),u=!1,A=(J-y)/w;r&&r<m&&(F=l,C=1-y,y=Math.log(y+C),J=Math.log(J+C),k=Math.log(k+C),A=(J-y)/w,u=!0);for(m=0;m<w;m++)z=Math.max(z,F[m]);l=-20;r=0;c.histogram=new Map.Histogram(c);c.histogram.fDoLog=u;c.histogram.dValue=C;c.histogram.nWidth=h;c.histogram.nMin=y;c.histogram.nMax=J;for(var E=__scaleStyleString(map.Scale.tStyle.Summary.szStyle,
.4),I=0,m=0;m<c.partsA.length;m++){q=(u?h/(J-y)*(Math.min(J,Math.log(c.partsA[m].max+C))-y):h/(J-y)*(Math.min(J,c.partsA[m].max)-y))-l;if(x=map.Dom.newShape("rect",b,l,r,q,g,"fill:"+c.colorScheme[m]+";stroke:black;stroke-width:"+map.Scale.normalX(.2)+";stroke-opacity:0.1"))x.setAttributeNS(szMapNs,"tooltip",c.szLegendLabelA[m]+" ("+c.formatValue(c.partsA[m].nCount)+" "+map.Dictionary.getLocalText("members")+")"),x.setAttributeNS(szMapNs,"onoverstyle","fill:"+c.colorScheme[m]+";stroke:black;stroke-width:"+
map.Scale.normalX(.5)+";"),x.setAttributeNS(null,"onmouseover","map.Themes.markClass(evt,'"+c.szId+"','"+m+"','1')"),x.setAttributeNS(null,"onmouseout","map.Themes.unmarkClass(evt,'"+c.szId+"')");c.histogram.classRectA[m]=x;c.histogram.classRectXA[m]=l;c.histogram.classRectWidthA[m]=q;c.histogram.classRectMaxA[m]=c.partsA[m].max;if(f.match("INTERACTIVE")){var x=map.Dom.newGroup(b,""),D=null;if(0<m){map.Dom.newShape("line",x,l,r-map.Scale.normalY(2),l,r+g,"stroke:black;stroke-width:"+map.Scale.normalX(.5)+
";stroke-opacity:0.5");if(D=map.Dom.newShape("rect",x,l-map.Scale.normalY(1.5),r-map.Scale.normalY(6),map.Scale.normalX(3),map.Scale.normalY(5),"fill:"+c.colorScheme[m]+";stroke:black;styroke-width(1);"))D.setAttributeNS(null,"rx",map.Scale.normalX(2)),D.setAttributeNS(null,"ry",map.Scale.normalY(1.5));D=map.Dom.newText(x,l,r-map.Scale.normalY(7),E+"display:none;font-weight:normal;text-anchor:middle",c.formatValue(c.partsA[m-1].max,1))}I=new Slider(x,new box(-I,0,I+q,0));I.setId(String(m));I.parent=
c.histogram;I.textObj=D;I=q}l+=q}l=v/3;r=0;nScalingFactor=.9;m=this.getResolutionQualityOfArray(F);10>m&&(nScalingFactor=10-m);for(m=0;m<w;m++){J=F[m]/z*g*nScalingFactor;q=u?Math.exp(y+m*A)-C:y+m*A;I=u?Math.exp(y+(m+1)*A)-C:y+(m+1)*A;E="black";J=J&&!isNaN(J)?Math.min(g,Math.max(map.Scale.normalY(.5),J)):0;if(E=map.Dom.newShape("line",b,l,r+g,l,r+g-J,"stroke:"+E+";stroke-width:"+v+";"))E.setAttributeNS(szMapNs,"tooltip",c.formatValue(q,2)+" ... "+c.formatValue(I,2)+c.szUnit+" ("+F[m]+" members)"),
E.setAttributeNS(szMapNs,"onoverstyle","stroke:yellow;stroke-width:"+Math.max(map.Scale.normalX(1),v)+";");l+=v}map.Dom.newShape("line",b,-map.Scale.normalX(.5),g+1,h-map.Scale.normalX(.5),g+1,"stroke:black;stroke-width:"+map.Scale.normalX(.1)+";");w=-map.Scale.normalX(.5);h-=map.Scale.normalX(.5);l=map.Scale.normalX(2);map.Dom.newShape("line",b,w,g,w,g+l,"stroke:black;stroke-width:"+map.Scale.normalX(.2)+";");map.Dom.newShape("line",b,h,g,h,g+l,"stroke:black;stroke-width:"+map.Scale.normalX(.2)+
";");q=__scaleStyleString(map.Scale.tStyle.Summary.szStyle,.4);r=.4*map.Scale.tStyle.Summary.nFontHeight;F=g+l+.8*r;m=c.formatValue(c.nMin,0);z=c.formatValue(c.nMax,0);map.Dom.newText(b,w-10,F,q+";font-weight:normal;text-anchor:start",m);0>c.nMin&&0<c.nMax&&(w=(0-y)/A*v,map.Dom.newShape("line",b,w,g,w,g+l,"stroke:black;stroke-width:"+map.Scale.normalX(.2)+";"),map.Dom.newText(b,w,F,q+";font-weight:normal;text-anchor:start","0"));J=0;for(m=10;m<c.nMax;m*=10)for(E=1;9>E&&!(m*E>c.nMax||m*E<c.nMin);E++)w=
((u?Math.log(m*E+C):m*E)-y)/A*v,I=c.formatValue(m*E,0),w>J+I.length*r*3/8?(map.Dom.newShape("line",b,w,g,w,g+l,"stroke:black;stroke-width:"+map.Scale.normalX(.2)+";"),map.Dom.newText(b,w,F,q+";font-weight:normal;text-anchor:middle",I),J=w+I.length*r*3/8):map.Dom.newShape("line",b,w,g,w,g+l/2,"stroke:black;stroke-width:"+map.Scale.normalX(.2)+";");h>J+z.length*r*3/8&&map.Dom.newText(b,h,F,q+";font-weight:normal;text-anchor:middle;",z);e&&!f.match("INTERACTIVE")&&(w=(k-y)/A*v,map.Dom.newShape("circle",
b,w,-map.Scale.normalX(.1),map.Scale.normalX(1),"fill:#dd0000;stroke:none;"),map.Dom.newShape("line",b,-10,-5,w-10,-5,"stroke:#000000;stroke-width:"+map.Scale.normalX(.5)+";stroke-opacity:0.3"))}else{h=map.Scale.normalX(70);g=map.Scale.normalY(12);q=h/700;r=l=0;J=c.nMax;e=g/J;v=Math.max(1,Math.ceil(c.nCount/700));f=[];y=0;C=[];for(k in c.itemA)C.push(c.itemA[k].nValuesA[0]);C.sort(c.sortUp);for(k in C)y%v?f[f.length-1]+=C[k]/v:f[f.length]=C[k]/v,y++;f.sort(c.sortUp);for(m=0;m<f.length;m++){k=f[m];
J=f[m]*e*.9;E="black";for(v=0;v<c.partsA.length;v++)if(f[m]<c.partsA[v].max){E=c.colorScheme[v];break}E=map.Dom.newShape("line",b,l,r,l,g,"stroke:"+E+";stroke-width:"+q+";");E.setAttributeNS(szMapNs,"tooltip",c.formatValue(k,2)+c.szUnit);isNaN(J)&&(J=0);E=map.Dom.newShape("line",b,l,r+g,l,r+g-J,"stroke:#000000;stroke-width:"+q+";");E.setAttributeNS(szMapNs,"tooltip",c.formatValue(k,2)+c.szUnit);l+=q}m=c.formatValue(c.nMin,0);z=c.formatValue(c.nMax,0);q=__scaleStyleString(map.Scale.tStyle.Summary.szStyle,
.4);map.Dom.newText(b,l+map.Scale.normalX(1),r+g,q+";font-weight:normal;text-anchor:start;stroke-opacity:0.8;",m);map.Dom.newText(b,l+map.Scale.normalX(1),r+map.Scale.normalY(3.5),q+";font-weight:normal;text-anchor:start;stroke-opacity:0.8;",z);b&&b.fu.scale(h/l,1)}return b};Map.Histogram=function(e){this.mapTheme=e;this.fDoLog=!1;this.dValue=0;this.classRectA=[];this.classRectXA=[];this.classRectWidthA=[];this.classRectMaxA=[]};Map.Histogram.prototype=new Map;
Map.Histogram.prototype.onMouseOver=function(e,b,f){f.textObj&&f.textObj.style.setProperty("display","inline","")};Map.Histogram.prototype.onMouseOut=function(e,b,f){f.textObj&&f.textObj.style.setProperty("display","none","")};
Map.Histogram.prototype.onMouseMove=function(e,b,f){if(e=this.classRectA[Number(b)])e.setAttributeNS(null,"x",this.classRectXA[Number(b)]+f.value.x),e.setAttributeNS(null,"width",this.classRectWidthA[Number(b)]-f.value.x);if(e=this.classRectA[Number(b)-1]){e.setAttributeNS(null,"width",this.classRectWidthA[Number(b)-1]+f.value.x);var c=this.nMin+(this.nMax-this.nMin)/this.nWidth*(this.classRectXA[Number(b)]+f.value.x),c=this.fDoLog?Math.exp(c)-this.dValue:c;this.classRectMaxA[Number(b)-1]=c}f.textObj&&
(f.textObj.firstChild.nodeValue=__formatValue(c,1))};Map.Histogram.prototype.onMouseUp=function(e,b,f){(f=this.classRectA[Number(b)-1])&&(this.classRectWidthA[Number(b)-1]=f.getAttributeNS(null,"width"));b="ranges:"+String(this.nMin);for(f=0;f<this.classRectMaxA.length;f++)b+=","+String(this.classRectMaxA[f]);map.Themes.changeThemeStyle(e,this.mapTheme.szId,b)};Map.Themes.prototype.showErrorInfo=function(e,b){var f=this.getTheme(b);f&&f.showErrorInfo()};
Map.Themes.prototype.actualizeActiveTheme=function(e){for(var b=0;b<this.themesA.length;b++)if(this.themesA[b].fDone)if(this.themesA[b].szFlag.match(/CHART/))if(e&&1!=e&&this.themesA[b].szFlag.match(/DYNAMICSCALE/)&&(this.themesA[b].nScale*=Math.sqrt(e),this.themesA[b].fRealize=!0,this.themesA[b].fRedraw=!1,this.themesA[b].unpaintMap()),e&&1!=e&&this.themesA[b].szFlag.match(/BEZIER/)&&(this.themesA[b].fRedraw=!0),this.themesA[b].szFlag.match(/DECLUTTER/)&&(this.themesA[b].fDeclutter=!0,map.Themes.execute()),
e&&(1!=e||this.themesA[b].szFlag.match(/FIXGRID/))&&(this.themesA[b].nChartSizeMin||this.themesA[b].nValueSizeMin||this.themesA[b].szAggregationFieldA||this.themesA[b].nGridWidth||this.themesA[b].nGridMatrix||this.themesA[b].nGridWidthPx||this.themesA[b].nChartUpper||this.themesA[b].nChartLower||this.themesA[b].nValueUpper||this.themesA[b].nBoxUpper||this.themesA[b].nTitleUpper||this.themesA[b].nLabelUpper))if(this.themesA[b].fRealizeDone&&(this.themesA[b].szFlag.match(/AUTOGRID/)||this.themesA[b].nGridWidthPx||
this.themesA[b].szAggregationFieldA)||this.themesA[b].nMaxCharts){if(this.themesA[b].szAggregationFieldA){for(var f=this.themesA[b].nGridWidth,c=this.themesA[b].szAggregationField,h=0;h<this.themesA[b].szAggregationFieldA.length;h++){var g=Number(this.themesA[b].szAggregationFieldA[h].split(":")[1]);g&&map.Scale.nTrueMapScale*map.Scale.nZoomScale>g&&(isNaN(parseFloat(this.themesA[b].szAggregationFieldA[h+1]))?this.themesA[b].szAggregationField=this.themesA[b].szAggregationFieldA[h+1]:(this.themesA[b].szAggregationFieldA[h+
1].match(/px/)?this.themesA[b].nGridWidthPx=parseFloat(this.themesA[b].szAggregationFieldA[h+1]):(this.themesA[b].nGridWidth=parseFloat(this.themesA[b].szAggregationFieldA[h+1]),this.themesA[b].nGridWidthPx=0),this.themesA[b].szAggregationField=null));h++}this.themesA[b].szAggregationField!=c||this.themesA[b].nGridWidth!=f?(this.themesA[b].fRealize=!0,this.themesA[b].fRedraw=!1,this.themesA[b].unpaintMap(),this.themesA[b].themeNodesPosA=[]):this.themesA[b].fRedraw=!0}this.themesA[b].nGridWidthPx?
(f=map.Scale.getDistanceInMeter(1E3,1E3,1E3+map.Scale.normalX(this.themesA[b].nGridWidthPx),1E3),this.themesA[b].nGridWidth=f/map.Scale.nZoomScale,this.themesA[b].fRealize=!0,this.themesA[b].fRedraw=!1,this.themesA[b].unpaintMap(),this.themesA[b].themeNodesPosA=[]):this.themesA[b].nGridMatrix?(f=map.Zoom.getBox(),f=map.Scale.getDistanceInMeter(1E3,1E3,1E3+f.width,1E3),this.themesA[b].nGridWidth=f/(this.themesA[b].nGridMatrix||20)/map.Scale.nZoomScale,this.themesA[b].fRealize=!0,this.themesA[b].fRedraw=
!1,this.themesA[b].unpaintMap(),this.themesA[b].themeNodesPosA=[]):this.themesA[b].nGridWidth&&(this.themesA[b].fActualize=!0)}else this.themesA[b].nMaxCharts&&this.themesA[b].unpaintMap(),this.themesA[b].fRealizeDone&&1>e&&(this.themesA[b].nChartSizeMin||this.themesA[b].nValueSizeMin)&&this.themesA[b].unpaintMap(),this.themesA[b].fRedraw=!0;else this.themesA[b].fActualize=!0;else this.themesA[b].isChecked&&!this.themesA[b].fMarkClass&&(this.themesA[b].fRedraw=!0);executeWithMessage("map.Themes.execute()",
"...",100);return null};Map.Themes.prototype.resortCharts=function(e){var b=!1;if(this.themesA.length){for(var f=0;f<this.themesA.length;f++)this.themesA[f].fDone&&(b=this.themesA[f].fResort=!0);b&&map.Themes.execute()}e&&(e.stopPropagation(),e.preventDefault())};Map.Themes.prototype.clear=function(){this.themesA.length=0};
function ObjTheme(e,b,f,c,h){this.szName=e;this.coTable=f;this.szSelectionField=c;this.szItemField=h;this.nIndex=b;this.nFieldIndexA=[];this.nFieldSelectionIndex=this.nField100Index=-1;this.nFieldSelectionIndexA=[];this.nLabelFieldIndex=this.nValueFieldIndex=this.nFieldItemIndex=-1;this.leadOffset=!1}
ObjTheme.prototype.getFields=function(){this.szFields=this.theme.szFields;this.szFieldsA=this.theme.szFields.split("|");for(e in this.szFieldsA)this.szFieldsA[e]=this.szFieldsA[e].trim();this.szField100=this.theme.szField100;this.szColorField=this.theme.szColorField;this.szSymbolField=this.theme.szSymbolField;this.szValueField=this.theme.szValueField;this.szLabelField=this.theme.szLabelField;this.szTitleField=this.theme.szTitleField;this.szSnippetField=this.theme.szSnippetField;this.szSizeField=this.theme.szSizeField;
this.szAlphaField=this.theme.szAlphaField;this.szAlphaField100=this.theme.szAlphaField100;this.szXField=this.theme.szXField;this.szYField=this.theme.szYField;this.szTimeField=this.theme.szTimeField;this.szFilterField=this.theme.szFilterField;this.szAggregationField=this.theme.szAggregationField;this.szSelectionFieldsA=(this.theme.szSelectionField||"").split("|");this.nFieldIndexA[0]=-1;this.nFieldSelectionIndexA[0]=-1;this.theme.szSelectionField2&&(this.szSelectionField2=this.theme.szSelectionField2||
null,this.szSelectionFields2A=(this.theme.szSelectionField2||"").split("|"),this.nFieldSelection2IndexA=[-1]);var e,b;b=this.coTable?this.coTable:this.szName;if(!this.szFields||""==this.szFields)return!0;try{eval("this.dbTable = "+b+".table")}catch(f){try{eval("this.dbTable = "+b+"_table")}catch(c){}}if(this.coTable&&!this.dbTable)return displayMessage("Data not loaded!",1E3,!0),!1;if(this.dbTable){try{eval("this.dbFields = "+b+".fields")}catch(h){try{eval("this.dbFields = "+b+"_fields")}catch(g){}}try{this.szSelectionField||
(this.szSelectionField=map.Layer.getLayerObj(this.szName).szSelection)}catch(q){return alert("no selection field found !!"),!1}for(e=0;e<this.dbTable.fields;e++)if(!this.dbFields||0==this.dbFields.length||!this.dbFields[e])return alert("ERROR: theme '"+this.szName+"' - table '"+b+"' - object 'fields' incorrect !"),!1;if("$table$"==this.szFields){this.szFieldsA=[];for(e=0;e<this.dbFields.length;e++)this.dbFields[e].id!=this.szSelectionField&&"Total"!=this.dbFields[e].id&&this.szFieldsA.push(this.dbFields[e].id);
this.theme.szFields=this.szFieldsA.join("|");this.theme.szFieldsA=this.szFieldsA;this.theme.szLabelA=this.szFieldsA}for(e=0;e<this.dbFields.length;e++){"undefined"!=typeof this.szItemField&&String(this.dbFields[e].id).toLowerCase()==String(this.szItemField).toLowerCase()&&(this.nFieldItemIndex=e);"undefined"!=typeof this.szSelectionField&&String(this.dbFields[e].id).toLowerCase()==String(this.szSelectionField).toLowerCase()&&(this.nFieldSelectionIndex=e);if("undefined"!=typeof this.szSelectionField2)for(String(this.dbFields[e].id).toLowerCase()==
String(this.szSelectionField2).toLowerCase()&&(this.nFieldSelection2Index=e),b=0;b<this.szSelectionFields2A.length;b++)this.dbFields[e].id==this.szSelectionFields2A[b]&&(this.nFieldSelection2IndexA[b]=e);for(b=0;b<this.szSelectionFieldsA.length;b++)this.dbFields[e].id==this.szSelectionFieldsA[b]&&(this.nFieldSelectionIndexA[b]=e);for(b=0;b<this.szFieldsA.length;b++)"!"==this.szFieldsA[b].substr(0,1)?this.dbFields[e].id==this.szFieldsA[b].substr(1,this.szFieldsA[b].length-1)&&(this.nFieldIndexA[b]=
e):this.dbFields[e].id==this.szFieldsA[b]&&(this.nFieldIndexA[b]=e);this.szField100&&this.dbFields[e].id==this.szField100&&(this.nField100Index=e);this.szColorField&&this.dbFields[e].id==this.szColorField&&(this.nColorFieldIndex=e);this.szSymbolField&&this.dbFields[e].id==this.szSymbolField&&(this.nSymbolFieldIndex=e);this.szValueField&&this.dbFields[e].id==this.szValueField&&(this.nValueFieldIndex=e);this.szLabelField&&this.dbFields[e].id==this.szLabelField&&(this.nLabelFieldIndex=e);this.szTitleField&&
this.dbFields[e].id==this.szTitleField&&(this.nTitleFieldIndex=e);this.szSnippetField&&this.dbFields[e].id==this.szSnippetField&&(this.nSnippetFieldIndex=e);this.szSizeField&&this.dbFields[e].id==this.szSizeField&&(this.nSizeFieldIndex=e);this.szTimeField&&this.dbFields[e].id==this.szTimeField&&(this.nTimeFieldIndex=e);this.szXField&&this.dbFields[e].id==this.szXField&&(this.nXFieldIndex=e);this.szYField&&this.dbFields[e].id==this.szYField&&(this.nYFieldIndex=e);this.szAlphaField&&this.dbFields[e].id==
this.szAlphaField&&(this.nAlphaFieldIndex=e);this.szAlphaField100&&this.dbFields[e].id==this.szAlphaField100&&(this.nAlphaField100Index=e);this.szFilterField&&this.dbFields[e].id==this.szFilterField&&(this.nFilterFieldIndex=e);this.szAggregationField&&this.dbFields[e].id==this.szAggregationField&&(this.nAggregationFieldIndex=e)}-1==this.nFieldSelectionIndex&&-1==this.nFieldSelectionIndexA[0]&&(this.szSelectionField&&this.szSelectionField.length?alert("ERROR on load theme data: selection field '"+
this.szSelectionField+"' not found !"):alert("ERROR on load theme data: selection not defined !"));for(b=0;b<this.szFieldsA.length;b++)if("undefined"==typeof this.nFieldIndexA[b])return alert("ERROR on load theme data: value field '"+this.szFieldsA[b]+"' not found !"),!1;this.szField100&&!this.szField100.match(/\$/)&&"undefined"==typeof this.nField100Index&&alert("ERROR on load theme data: 100field: '"+this.szField100+"' not found !");this.szColorField&&!this.szColorField.match(/\$/)&&"undefined"==
typeof this.nColorFieldIndex&&alert("ERROR on load theme data: colorfield: '"+this.szColorField+"' not found !");this.szSymbolField&&!this.szSymbolField.match(/\$/)&&"undefined"==typeof this.nSymbolFieldIndex&&alert("ERROR on load theme data: symbolfield: '"+this.szSymbolField+"' not found !");this.szValueField&&!this.szValueField.match(/\$/)&&"undefined"==typeof this.nValueFieldIndex&&alert("ERROR on load theme data: valuefield: '"+this.szValueField+"' not found !");this.szLabelField&&!this.szLabelField.match(/\$/)&&
"undefined"==typeof this.nLabelFieldIndex&&alert("ERROR on load theme data: labelfield: '"+this.szLabelField+"' not found !");this.szTitleField&&!this.szTitleField.match(/\$/)&&"undefined"==typeof this.nTitleFieldIndex&&alert("ERROR on load theme data: titlefield: '"+this.szTitleField+"' not found !");this.szSnippetField&&!this.szSnippetField.match(/\$/)&&"undefined"==typeof this.nSnippetFieldIndex&&alert("ERROR on load theme data: snippetfield: '"+this.szSnippetField+"' not found !");this.szSizeField&&
!this.szSizeField.match(/\$/)&&"undefined"==typeof this.nSizeFieldIndex&&alert("ERROR on load theme data: sizefield: '"+this.szSizeField+"' not found !");this.szTimeField&&!this.szTimeField.match(/\$/)&&"undefined"==typeof this.nTimeFieldIndex&&alert("ERROR on load theme data: timefield: '"+this.szTimeField+"' not found !");this.szXField&&!this.szXField.match(/\$/)&&"undefined"==typeof this.nXFieldIndex&&alert("ERROR on load theme data: xfield: '"+this.szXField+"' not found !");this.szYField&&!this.szYField.match(/\$/)&&
"undefined"==typeof this.nYFieldIndex&&alert("ERROR on load theme data: yfield: '"+this.szYField+"' not found !");this.szAlphaField&&!this.szAlphaField.match(/\$/)&&"undefined"==typeof this.nAlphaFieldIndex&&alert("ERROR on load theme data: alphafield: '"+this.szAlphaField+"' not found !");this.szAlphaField100&&!this.szAlphaField100.match(/\$/)&&"undefined"==typeof this.nAlphaField100Index&&alert("ERROR on load theme data: alpha100field: '"+this.szAlphaField100+"' not found !");this.szFilterField&&
!this.szFilterField.match(/\$/)&&"undefined"==typeof this.nFilterFieldIndex&&alert("ERROR on load theme data: filterfield: '"+this.szFilterField+"' not found !");this.szAggregationField&&!this.szAggregationField.match(/\$/)&&"undefined"==typeof this.nAggregationFieldIndex&&alert("ERROR on load theme data: aggregationfield: '"+this.szAggregationField+"' not found !");!this.szItemField||this.szItemField==this.szSelectionField||this.szItemField.match(/\$/)||"undefined"!=typeof this.nFieldItemIndex&&
-1!=this.nFieldItemIndex||alert("ERROR on load theme data: itemfield: '"+this.szItemField+"' not found !")}else{e=SVGDocument.getElementById(this.szName);null==e&&(b=map.Tiles.getTileNodes(this.szName))&&(e=b[0]);if(!e)return this.szName="",!1;e=e.getAttributeNS(szMapNs,"info");if(null==e||""==e)return this.szName="",!1;var l=e.split("|");for(e=0;e<l.length;e++){for(b=0;b<this.szFieldsA.length;b++)"!"==this.szFieldsA[b].substr(0,1)?l[e]==this.szFieldsA[b].substr(1,this.szFieldsA[b].length-1)&&(this.nFieldIndexA[b]=
e):l[e]==this.szFieldsA[b]&&(this.nFieldIndexA[b]=e);this.szField100&&l[e]==this.szField100&&(this.nField100Index=e);this.szColorField&&l[e]==this.szColorField&&(this.nColorFieldIndex=e);this.szSymbolField&&l[e]==this.szSymbolField&&(this.nSymbolFieldIndex=e);this.szValueField&&l[e]==this.szValueField&&(this.nValueFieldIndex=e);this.szLabelField&&l[e]==this.szLabelField&&(this.nLabelFieldIndex=e);this.szTimeField&&l[e]==this.szTimeField&&(this.nTimeFieldIndex=e);this.szSizeField&&l[e]==this.szSizeField&&
(this.nSizeFieldIndex=e);this.szXField&&l[e]==this.szXField&&(this.nXFieldIndex=e);this.szYField&&l[e]==this.szXField&&(this.nYFieldIndex=e);this.szAlphaField&&l[e]==this.szAlphaField&&(this.nAlphaFieldIndex=e);this.szAlphaField100&&l[e]==this.szAlphaField100&&(this.nAlphaField100Index=e)}}for(b=0;b<this.szFieldsA.length;b++)0>this.nFieldIndexA[b]&&("$item$"!=this.szFieldsA[b]&&"$index$"!=this.szFieldsA[b]&&_ERROR("ERROR on load theme data: '"+this.szFieldsA[b]+"' not found !"),this.szName="");return!0};
function MapTheme(e,b,f,c,h,g,q){this.fDone=!1;this.nMin=Number.MAX_VALUE;this.nMax=-Number.MAX_VALUE;this.nNoData=this.nCount=this.nSum=0;this.szThemes=e;this.szThemesA=e.split("|");this.checkTheme();this.objThemesA=[];this.szFields=b;this.szFieldsA=b.split("|");this.szField100=f;this.nFieldsA=[];this.nFields100A=[];this.nFieldsSelectionA=[];this.nMinA=[];this.nMaxA=[];this.nSumA=[];this.nMeanA=[];this.nMedianA=[];this.nDeviationA=[];this.nOrigMinA=[];this.nOrigMaxA=[];this.nOrigSumA=[];for(f=0;f<
this.szFieldsA.length;f++)this.nMinA[f]=Number.MAX_VALUE,this.nMaxA[f]=-Number.MAX_VALUE,this.nSumA[f]=0,this.nOrigMinA[f]=Number.MAX_VALUE,this.nOrigMaxA[f]=-Number.MAX_VALUE,this.nOrigSumA[f]=0,this.nMedianA[f]=0,this.nMeanA[f]=0;this.nMin100=Number.MAX_VALUE;this.nMax100=-Number.MAX_VALUE;this.nSum100=0;this.nMinSize=Number.MAX_VALUE;this.nMaxSize=-Number.MAX_VALUE;this.nSumSize=0;this.nMinAlpha=Number.MAX_VALUE;this.nMaxAlpha=-Number.MAX_VALUE;this.nSumAlpha=0;this.nMinX=Number.MAX_VALUE;this.nMaxX=
-Number.MAX_VALUE;this.nSumX=0;this.nMinY=Number.MAX_VALUE;this.nMaxY=-Number.MAX_VALUE;this.nSumY=0;this.nDominantDFilter=this.szDominantFilter=null;this.nFilterA=[];this.dbTableA=[];this.dbFieldsA=[];this.dbRecordsA=[];if(h)for(f in this.origColorScheme=[],h)this.origColorScheme[f]=h[f];else this.origColorScheme=null;this.defaultColorScheme=["#008888","#00aaaa","#00cccc","#00eeee","#00ffff"];this.szTitle=g?g:e+" ["+b+"]";this.szTitle=map.Dictionary.getLocalText(this.szTitle);this.szTitle=60<this.szTitle.length?
this.szTitle.slice(0,50)+" ...":this.szTitle;this.szUnits="";this.szXaxisA=this.szAlphaValueUnits=this.szSizeValueUnits=null;this.szOrigLabelA=this.szLabelA=q;this.szLegendLabelA=[];this.szLegendStyle="";this.evidenceMode="isolate";this.szAggregation="mean";this.nValuesA=[];this.szExactA=this.szRangesA=this.szValuesA=null;this.itemA=[];this.fDataCache=!0;this.fEditor=!1;this.fNegativeValuePossible=this.fNullIsValue=!0;this.nStringToValue=1;this.nStringToValueA=[];this.szOrigFlag=this.szFlag=c?c:"CHOROPLETH";
this.nValueScale=this.nScale=1;this.nRefreshTimeout=0;this.szId="theme"+String(Math.random());this.szShapeType="polygon";if(e=map.Layer.getLayerObj(this.szThemesA[0]))this.szShapeType=e.szType,"line"==this.szShapeType&&this.szOrigFlag.match(/BUFFER/)&&(this.szShapeType+="+buffer");this.hiddenLayerA=[];this.szFlag.match(/CHART/)||(this.szFlag.match(/PIE/)?this.szOverviewChart="PIE":this.szFlag.match(/DONUT/)&&(this.szOverviewChart="DONUT"));this.szFlag.match(/ZEROISNOTVALUE/)&&(this.fNullIsValue=!1);
this.szFlag.match(/ZEROISVALUE/)&&(this.fNullIsValue=!0);this.szFlag.match(/NEGATIVEISNOTVALUE/)&&(this.fNegativeValuePossible=!1);this.szFlag.match(/NEGATIVEISVALUE/)&&(this.fNegativeValuePossible=!0);this.szFlag.match(/SUM/)&&(this.szAggregation="sum");if(this.szFlag.match(/CHART/)){if(this.szFlag.match(/CATEGORICAL/)||1<this.szFieldsA.length)this.fNullIsValue=!0;this.szFlag.match(/BUFFER/)||(this.fShadow=this.fOrigShadow=!0)}this.szFlag.match(/CATEGORICAL/)&&!this.szLabelA&&(this.szLabelA=[]);
this.fGrayNoMember=this.fSortBeforeDraw=this.fClipCharts=!0;this.nClipTimeout=1E3;this.paintedShapeNodesA=[];this.szChoroplethInfoStyle=map.Themes.szChoroplethInfoStyle;this.nMaxThemeCharts=map.Themes.nMaxThemeCharts;this.nMaxShadowCharts=map.Themes.nMaxShadowCharts;this.nflushPaintShape=map.Themes.nflushPaintShape;this.nflushChartDraw=map.Themes.nflushChartDraw;this.themeNodesPosA=this.szFlag.match(/AGGREGATE|GROUP/)?[]:map.Themes.themeNodesPosA}
MapTheme.prototype.checkTheme=function(){if(!this.szThemesA)return!1;for(var e=0;e<this.szThemesA.length;e++)if("generic"==this.szThemesA[e]||map.Layer.isLoaded(this.szThemesA[e]))return!0;this.ErrorMessage="theme layer not loaded ! zoom in ?";return!1};MapTheme.prototype.def=function(){return map.Themes.getMapThemeDefinitionObj(this.szId)};MapTheme.prototype.getDefinitionObject=function(){return map.Themes.getMapThemeDefinitionObj(this.szId)};
MapTheme.prototype.initValues=function(){this.nMin=Number.MAX_VALUE;this.nMax=-Number.MAX_VALUE;for(var e=this.nNoData=this.nCount=this.nSum=0;e<this.szFieldsA.length;e++)this.nMinA[e]=Number.MAX_VALUE,this.nMaxA[e]=-Number.MAX_VALUE,this.nSumA[e]=0,this.nOrigMinA[e]=Number.MAX_VALUE,this.nOrigMaxA[e]=-Number.MAX_VALUE,this.nOrigSumA[e]=0,this.nMedianA[e]=0,this.nMeanA[e]=0,this.nDeviationA[e]=0;this.nMin100=Number.MAX_VALUE;this.nMax100=-Number.MAX_VALUE;this.nSum100=0;this.itemA=[];this.posItemA=
[];this.chartPosA=[];this.exactCountA=[];this.exactSizeA=[];this.quantileA=[];this.szAggregation||(this.szAggregation=this.szField100?"mean":"sum");if(this.szAggregationFieldA&&!this.fSuppressAggregationScale)for(e=0;e<this.szAggregationFieldA.length;e++){var b=Number(this.szAggregationFieldA[e].split(":")[1]);b&&map.Scale.nTrueMapScale*map.Scale.nZoomScale>b&&(isNaN(parseFloat(this.szAggregationFieldA[e+1]))?this.szAggregationField=this.szAggregationFieldA[e+1]:(this.szAggregationFieldA[e+1].match(/px/)?
this.nGridWidthPx=parseFloat(this.szAggregationFieldA[e+1]):(this.nGridWidth=parseFloat(this.szAggregationFieldA[e+1]),this.nGridWidthPx=0),this.szAggregationField=null));e++}this.fSuppressAggregationScale=!1;this.nWrongRecordLengthCount=0;this.missedA=[];if(!this.coTable||"genericTable"==this.coTable)if(genericTable=this.loadTableFromMap())this.coTable="genericTable"};
MapTheme.prototype.getMeanMedianQuantile=function(){if(!this.quantileA||!this.quantileA.length)for(var e=0;e<this.szFieldsA.length;e++){var b=[],f=0;for(a in this.itemA)b.push(this.itemA[a].nValuesA[e]),f+=this.itemA[a].nValuesA[e];"$item$"!=this.szFieldsA[e]&&b.sort(this.sortUp);var c=Math.round(b.length/2);this.nMedianA[e]=b[c];this.nMeanA[e]=f/b.length;this.quantileA[e]=b}};
MapTheme.prototype.realize=function(){var e=new Date;this.fShowProgressBar=!0;this.initValues();this.getFields()?this.loadValues()?(this.timeLoading=new Date-e,(1E3<this.timeLoading||this.szFlag.match(/VERBOSE/))&&!this.szFlag.match(/SILENT/)?executeWithMessage("map.Themes.executeContinue();",this.szFlag.match(/AGGREGATE/)?"aggregating":"parsing data"):map.Themes.executeContinue()):this.fRemove=!0:this.fRemove=!0};
MapTheme.prototype.realize_analyze=function(){var e=new Date;this.distributeValues();this.timeAggregating=new Date-e;this.fDraw=!0;(1E3<this.timeLoading||this.szFlag.match(/VERBOSE/))&&!this.szFlag.match(/SILENT/)?executeWithMessage("map.Themes.executeContinue();","drawing"):map.Themes.executeContinue()};
MapTheme.prototype.realize_draw=function(){this.timeStart=new Date;this.nActualFrame=this.nMissingRangeCount=this.nZeroValueCount=this.nRealizedCount=this.nSkipCount=this.nDoneCount=0;var e=this.szFlag.match(/VERBOSE/)?"drawing":"";this.mapSleep=new Map.Sleep("map.Themes.executeContinue",this.nflushPaintShape,map.Dictionary.getLocalText(e));this.mapSleep.nCount=this.nCount;this.mapSleep.szCancel="map.Themes.cancelExecute()";this.szFlag.match(/\bCLIP\b/)&&(this.mapSleep=null,this.nClipIncr=1);this.szFlag.match(/FEATURE/)?
(this.mapSleep=null,this.chartMap()):this.szFlag.match(/CHART/)?(this.mapSleep&&(this.mapSleep.initCheckSleep(this.nflushChartDraw,e),this.mapSleep.fShowProgressBar=!0),this.unpaintMap(),this.chartMap()):(this.unlabelMap(),this.paintMap(),this.makeVisible());this.isChecked=!0;this.szFlag.match(/BUFFER/)?map.Themes.activeBuffer=this:map.Themes.activeTheme=this;try{HTMLWindow.ixmaps.htmlgui_setActualTheme(this.szId)}catch(b){}!this.szFlag.match(/CHART/)||this.szFlag.match(/BUBBLE/)||this.szFlag.match(/SQUARE/)||
this.szFlag.match(/SYMBOL/)||this.szFlag.match(/BAR/)&&this.colorScheme&&this.nOrigSumA&&this.nOrigSumA.length!=this.colorScheme.length?this.isMarkable=!0:this.isMarkable=!1};MapTheme.prototype.realizeContinue=function(e){this.fMakeLabel?this.labelMap(e):this.szFlag.match(/CHART/)?this.chartMap(e):this.paintMap(e)};
MapTheme.prototype.realizeNextClipFrame=function(){this.fClipPause||(this.nActualFrame+=this.nClipIncr,this.nActualFrame>=this.nClipFrames?this.szFlag.match(/BACK/)?(this.nClipIncr=-this.nClipIncr,this.clipTimeout=setTimeout("map.Themes.nextClipFrame('"+this.szId+"')",1E3)):this.szFlag.match(/LOOP/)?(this.nActualFrame=-1,this.clipTimeout=setTimeout("map.Themes.nextClipFrame('"+this.szId+"')",1E3)):(this.nActualFrame=this.nClipFrames-1,this.pauseClip()):0>this.nActualFrame?this.szFlag.match(/BACK/)?
(this.nClipIncr=-this.nClipIncr,this.clipTimeout=setTimeout("map.Themes.nextClipFrame('"+this.szId+"')",10)):(this.nActualFrame=0,this.pauseClip()):(this.mapSleep=null,this.szFlag.match(/CHART/)?(this.chartPosA=[],this.posItemA=[],this.fRedraw=!0,this.chartMap()):this.paintMap(),this.fRedrawInfo=!0))};
MapTheme.prototype.setClipFrame=function(e){this.fClipPause=!0;this.nActualFrame=Math.min(e,this.nClipFrames);this.mapSleep=null;this.szFlag.match(/CHART/)?(this.chartPosA=[],this.posItemA=[],this.unpaintMap(),this.chartMap()):this.paintMap();this.fRedrawInfo=!0};
MapTheme.prototype.startClip=function(e){var b=SVGDocument.getElementById(this.szId+":display:widget:clippausebutton:button");b&&b.style.setProperty("display","inline","");(b=SVGDocument.getElementById(this.szId+":display:widget:clipstartbutton:button"))&&b.style.setProperty("display","none","");this.fClipPause=!1;this.nActualFrame=e||this.nActualFrame;this.realizeNextClipFrame()};
MapTheme.prototype.pauseClip=function(){var e=SVGDocument.getElementById(this.szId+":display:widget:clippausebutton:button");e&&e.style.setProperty("display","none","");(e=SVGDocument.getElementById(this.szId+":display:widget:clipstartbutton:button"))&&e.style.setProperty("display","inline","");this.clipTimeout&&clearTimeout(this.clipTimeout);this.fClipPause=!0};
MapTheme.prototype.realizeDone=function(){this.nRefreshTimeout&&(this.refreshTimeout&&clearTimeout(this.refreshTimeout),this.refreshTimeout=setTimeout("map.Themes.refreshTheme('"+this.szId+"')",this.nRefreshTimeout));this.szFlag.match(/\bCLIP\b/)&&(this.clipTimeout&&clearTimeout(this.clipTimeout),this.clipTimeout=setTimeout("map.Themes.nextClipFrame('"+this.szId+"')",this.nActualFrame?this.nClipTimeout:1E3));this.nWrongRecordLengthCount&&fDebug&&displayMessage("Data Error:  "+this.nWrongRecordLengthCount+
" items have wrong record length",1E4,"notify");this.fRealize=this.fRedraw=!1;this.fDone=!0;this.timeRealizing=new Date-this.timeStart;map.Themes.realizeDone(this)};MapTheme.prototype.beginDraw=function(){};MapTheme.prototype.endDraw=function(){};
MapTheme.prototype.redraw=function(e){if(!this.szFlag.match(/FEATURE/)){this.clipTimeout&&clearTimeout(this.clipTimeout);this.fDataIncomplete&&this.__themeNodes!=map.Themes.themeNodes&&(this.fDataIncomplete=!1,this.initValues(),this.loadValues(),this.distributeValues());if(this.szFlag.match(/CHART/)){if(this.fClipCharts||this.fRedraw)this.nMissingPositionCount=this.nMissingRangeCount=this.nZeroValueCount=this.nRealizedCount=this.nDoneCount=this.nSkipCount=0,this.chartMap()}else if(this.isChecked){if(this.partsA)for(i=
0;i<this.partsA.length;i++)this.partsA[i].nCount=0,this.partsA[i].nSum=0;this.mapSleep&&this.mapSleep.initCheckSleep(this.nflushPaintShape,"painting map");this.makeVisible();this.paintMap()}e&&this.enable()}};
MapTheme.prototype.toFront=function(){if(this.szFlag.match(/CHART/))this.chartGroup.parentNode.appendChild(this.chartGroup),(matrixA=getMatrix(this.chartGroup))&&setMatrix(this.chartGroup,matrixA),this.enable();else if(this.isChecked){for(i=0;i<this.partsA.length;i++)this.partsA[i].nCount=0,this.partsA[i].nSum=0;this.mapSleep&&this.mapSleep.initCheckSleep(this.nflushPaintShape,"painting map");this.paintMap()}else this.enable()};
MapTheme.prototype.getFields=function(){for(var e=0;e<this.szThemesA.length;e++){var b=this.szThemesA[e];this.objThemesA[b]=new ObjTheme(b,e,this.coTable,this.szSelectionField,this.szItemField);this.objThemesA[b].theme=this;if(!this.objThemesA[b].getFields()){try{HTMLWindow.ixmaps.htmlgui_onErrorTheme(b)}catch(f){}return!1}}return!0};
MapTheme.prototype.addItemValues=function(e,b,f,c,h){if(!this.szFlag.match(/RAW/)||f|c|h){var g;if(this.szExcludeA)for(g=0;g<this.szExcludeA.length;g++)if(e.split("::")[1]==this.szExcludeA[g])return;if(!(this.nField100Min&&f&&f<this.nField100Min)){if(this.nMinValue&&b&&!f){var q=!1;for(g=b.length-1;0<=g;g--)b[g]>=this.nMinValue&&(q=!0);if(!q)return}q=1;if(this.__fDensity||this.__fDensityAlpha)if(q=this.getNodeArea(e),!q&&this.__fTiledLayer){this.fDataIncomplete=!0;return}if(this.szWeights)for(g=0;g<
b.length;g++)b[g]*=this.szWeightsA[g]||this.szWeightsA[0];if(this.__fAuto100){for(g=f=0;g<b.length;g++)f+=b[g]||0;this.fField100=!0}this.itemA[e]={nOrigValuesA:[],nValuesA:b,nValue100:f,nValueSum:0};for(g=0;g<b.length;g++){this.itemA[e].nOrigValuesA[g]=isNaN(b[g])?0:b[g];this.itemA[e].nValueSum+=b[g]||0;if(this.fField100)if(f){var l=b[g];0!=l||this.szFlag.match(/ZEROISVALUE/)?"!"==this.szFieldsA[g].substr(0,1)?(l=f-l,this.itemA[e].nOrigValuesA[g]=l):this.szFlag.match(/CALCVAL/)||this.szFlag.match(/CALC100/)?
(l=f?Math.round(l*f/100):l,this.itemA[e].nOrigValuesA[g]=l):this.szFlag.match(/PRODUCT/)?l=f?l*f:l:this.szFlag.match(/DIFFERENCE/)&&1==b.length&&!this.szFlag.match(/RELATIVE/)?(f=0<g?b[g-1]:this.itemA[e].nValue100,l-=f):(l=f?l/f:1,this.szFlag.match(/FRACTION/)?l*=this.nFractionScale||1:this.szFlag.match(/PERMILLE/)?l*=1E3:(l*=100,0<l&&this.szFlag.match(/RELATIVE/)?l-=100:0<l&&this.szFlag.match(/INVERT/)&&(l=100-l))):l=0;b[g]=l}else b[g]=0;this.__fDensity&&(b[g]=q?b[g]/q:null)}if(this.__fDifference&&
1<b.length){for(g=0;g<b.length;g++)g<b.length-1?(l=b[g],b[g]=b[g+1]-b[g],this.szFlag.match(/RELATIVE/)&&(b[g]*=100/l)):this.szFlag.match(/STACKED/)||(b[g]=0);b.pop()}for(g=0;g<b.length;g++){if(!this.nSumA)return;isNaN(b[g])||(this.nMin=Math.min(this.nMin,b[g]),this.nMax=Math.max(this.nMax,b[g]),this.nSum+=b[g],this.nMinA[g]=Math.min(this.nMinA[g],b[g]),this.nMaxA[g]=Math.max(this.nMaxA[g],b[g]),this.nSumA[g]+=b[g],this.nOrigMinA[g]=Math.min(this.nOrigMinA[g],this.itemA[e].nOrigValuesA[g]),this.nOrigMaxA[g]=
Math.max(this.nOrigMaxA[g],this.itemA[e].nOrigValuesA[g]),this.nOrigSumA[g]+=this.itemA[e].nOrigValuesA[g]);0>b[g]&&(this.fNegativeValues=!0)}isNaN(f)||(this.nMin100=Math.min(this.nMin100,f),this.nMax100=Math.max(this.nMax100,f),this.nSum100+=f);c&&this.szSizeField&&!isNaN(c)&&(this.itemA[e].nSize=c,this.nMinSize=this.nMin=Math.min(this.nMinSize,c),this.nMaxSize=this.nMax=Math.max(this.nMaxSize,c),this.nSumSize+=c);this.szAlphaField&&null!=h&&!isNaN(h)&&(this.__fDensityAlpha&&(h=q?Math.min(h/q,5E4):
0),this.itemA[e].nAlpha=h,this.nMinAlpha=Math.min(this.nMinAlpha,h),this.nMaxAlpha=Math.max(this.nMaxAlpha,h),this.nSumAlpha+=h);if(this.__fExact&&this.exactCountA)for(g=0;g<b.length;g++)b[g]&&(this.exactCountA[b[g]-1]?(this.exactCountA[b[g]-1]++,this.exactSizeA[b[g]-1]+=this.itemA[e].nSize||1):(this.exactCountA[b[g]-1]=1,this.exactSizeA[b[g]-1]=this.itemA[e].nSize||1));this.nCount++}}else{this.itemA[e]={nOrigValuesA:[],nValuesA:b,nValue100:f,nValueSum:0};for(g=0;g<b.length;g++){if(!this.nSumA)return;
isNaN(b[g])||(this.nMin=Math.min(this.nMin,b[g]),this.nMax=Math.max(this.nMax,b[g]),this.nSum+=b[g]);0>b[g]&&(this.fNegativeValues=!0);this.__fExact&&this.exactCountA&&b[g]&&(this.exactCountA[b[g]-1]?(this.exactCountA[b[g]-1]++,this.exactSizeA[b[g]-1]+=this.itemA[e].nSize||1):(this.exactCountA[b[g]-1]=1,this.exactSizeA[b[g]-1]=this.itemA[e].nSize||1))}this.nCount++}};
MapTheme.prototype.getStringValueIndex=function(e,b){if(0==e.length||" "==e)if(this.szFlag.match(/UNDEFINEDISVALUE/))e="undefined";else return-1;this.szFlag.match(/IGNORECASE/)&&(e=e.toUpperCase());e=e.trim();"undefined"!=typeof this.nStringToValueA[e]||this.szValuesA&&this.szValuesA.length&&"set"!=b||(this.szLabelA=this.szLabelA||[],this.szExactA=this.szExactA||[],this.nStringToValueA[e]=this.nStringToValue,this.szLabelA[this.nStringToValue-1]=this.szLabelA[this.nStringToValue-1]||e,this.szExactA.push(this.nStringToValue),
this.nStringToValue++);return this.nStringToValueA[e]};MapTheme.prototype.checkHiddenLayerState=function(){for(i=0;i<this.szThemesA.length;i++)if(map.Layer.isScaleDependentLayer(this.szThemesA[i])&&(this.hiddenLayerA[this.szThemesA[i]]&&map.Layer.isScaleDependentLayerOn(this.szThemesA[i])||!this.hiddenLayerA[this.szThemesA[i]]&&!map.Layer.isScaleDependentLayerOn(this.szThemesA[i])))return!0;return!1};
__scanValue=function(e){return String(e).match(/,/)?parseFloat(String(e).replace(/\./gi,"").replace(/,/gi,".")):parseFloat(String(e).replace(/ /gi,""))};
MapTheme.prototype.loadValues=function(){this.nMissingLookupCount=0;this.__fExact=this.szFlag.match(/CATEGORICAL/);this.__fMax=this.szFlag.match(/\bMAX\b/);this.__fDifference=this.szFlag.match(/DIFFERENCE/);this.__fFilter=this.szFilter&&this.szFilter.length;this.__fDensity=this.szFlag.match(/DENSITY/);this.__fDensityAlpha=!this.szFlag.match(/CHART/)&&this.szAlphaField100&&this.szAlphaField100.match(/\$density\$/i);this.__fAggregate=this.szFlag.match(/AGGREGATE/);this.__fAuto100=this.szFlag.match(/AUTO100/)&&
!this.szFlag.match(/AGGREGATE/);this.__fTiledLayer=map.Layer.getLayerObj(this.szThemesA[0])?map.Layer.getLayerObj(this.szThemesA[0]).szFlag.match(/tiled/):!1;this.__themeNodes=map.Themes.themeNodes;for(i=0;i<this.szThemesA.length;i++)if(map.Layer.isScaleDependentLayer(this.szThemesA[i])&&!map.Layer.isScaleDependentLayerOn(this.szThemesA[i]))this.fReload=this.hiddenLayerA[this.szThemesA[i]]=!0;else if(this.hiddenLayerA[this.szThemesA[i]]=!1,!this.loadValuesOfTheme(this.szThemesA[i]))return!1;return!0};
MapTheme.prototype.filterValues=function(e){if(this.szFilter.match(/WHERE/)){if(!this.objTheme.filterQueryA){for(var b=this.szFilter.split("WHERE ")[1].split(" "),f=0;f<b.length;f++)if(b[f].length){if('"'==b[f][0]&&'"'!=b[f][b[f].length-1]){do b[f]=b[f]+" "+b[f+1],b.splice(f+1,1);while('"'!=b[f][b[f].length-1])}}else b.splice(f,1),f--;this.objTheme.filterQueryA=[];var c={};do{var h=0;3<=b.length&&(c={},c.szFilterField=b[0].replace(/("|)/g,""),c.szFilterOp=b[1],c.szFilterValue=b[2].replace(/("|)/g,
""),h=3);"BETWEEN"==c.szFilterOp&&5<=b.length&&"AND"==b[3]&&(c.szFilterValue2=b[4].replace(/("|)/g,""),h=5);if(h){for(f=0;f<this.objTheme.dbFields.length;f++)this.objTheme.dbFields[f].id==c.szFilterField&&(c.nFilterFieldIndex=f),this.objTheme.dbFields[f].id==c.szFilterValue&&(c.nFilterValueIndex=f);this.objTheme.filterQueryA.push(c);b.splice(0,h)}else{alert("ixmaps - filter error - incomplete query!\nquery: "+this.szFilter);break}if(b.length&&"AND"==b[0])b.splice(0,1);else break}while(b.length)}for(i in this.objTheme.filterQueryA)if(this.__szValue=
String(this.objTheme.dbRecords[e][this.objTheme.filterQueryA[i].nFilterFieldIndex]),this.__szFilterOp=this.objTheme.filterQueryA[i].szFilterOp,this.__szFilterValue=this.objTheme.filterQueryA[i].szFilterValue,this.__szFilterValue2=this.objTheme.filterQueryA[i].szFilterValue2,null!=this.objTheme.filterQueryA[i].nFilterValueIndex&&(this.__szFilterValue=String(this.objTheme.dbRecords[e][this.objTheme.filterQueryA[i].nFilterValueIndex])),b=!0,b=__scanValue(this.__szValue),b="="==this.__szFilterOp?this.__szValue==
this.__szFilterValue||b==Number(this.__szFilterValue):"!="==this.__szFilterOp?!(this.__szValue==this.__szFilterValue||b==Number(this.__szFilterValue)):"<>"==this.__szFilterOp?!(this.__szValue==this.__szFilterValue||b==Number(this.__szFilterValue)):">"==this.__szFilterOp?b>Number(this.__szFilterValue):"<"==this.__szFilterOp?b<Number(this.__szFilterValue):">="==this.__szFilterOp?b>=Number(this.__szFilterValue):"<="==this.__szFilterOp?b<=Number(this.__szFilterValue):"LIKE"==this.__szFilterOp?"*"==this.__szFilterValue?
this.__szValue.length:eval("this.__szValue.match(/"+this.__szFilterValue.replace(/\//gi,"\\/")+"/i)"):"NOT"==this.__szFilterOp?eval("!this.__szValue.match(/"+this.__szFilterValue.replace(/\//gi,"\\/")+"/i)"):"IN"==this.__szFilterOp?eval("this.__szFilterValue.match(/\\("+this.__szValue+"\\)/)")||eval("this.__szFilterValue.match(/\\("+this.__szValue+"\\,/)")||eval("this.__szFilterValue.match(/\\,"+this.__szValue+"\\,/)")||eval("this.__szFilterValue.match(/\\,"+this.__szValue+"\\)/)"):"BETWEEN"==this.__szFilterOp?
b>=Number(this.__szFilterValue)&&b<=Number(this.__szFilterValue2):eval("this.__szValue.match(/"+this.__szFilterValue.replace(/\//gi,"\\/")+"/i)"),!b)return!1}else if(this.__szValue=this.objTheme.dbRecords[e].join(" "),!eval("this.__szValue.match(/"+this.szFilter+"/i)"))return!1;return!0};
MapTheme.prototype.getSelectionId=function(e,b){if(!this.fSelection)if(this.fSelection="lookup",this.objTheme.nFieldSelectionIndexA&&1<this.objTheme.nFieldSelectionIndexA.length?(this.fSelection=this.szCRSDatum?"UTM":"LatLon",this.nSelection_0=this.objTheme.nFieldSelectionIndexA[0],this.nSelection_1=this.objTheme.nFieldSelectionIndexA[1]):this.objTheme.nFieldSelectionIndex&&(szId=__mpap_decode_utf8(String(this.objTheme.dbRecords[b][this.objTheme.nFieldSelectionIndex])),szId.match(/MultiPoint/)?this.fSelection=
"MultiPoint":szId.match(/Point/)&&(this.fSelection="MultiPoint")),this.objTheme.nFieldSelection2IndexA&&1<this.objTheme.nFieldSelection2IndexA.length)this.fSelection2=this.szCRSDatum?"UTM":"LatLon",this.nSelection2_0=this.objTheme.nFieldSelection2IndexA[0],this.nSelection2_1=this.objTheme.nFieldSelection2IndexA[1];else if("undefined"!=typeof this.objTheme.nFieldSelection2Index){var f=__mpap_decode_utf8(String(this.objTheme.dbRecords[b][this.objTheme.nFieldSelection2Index]));f.match(/MultiPoint/)?
this.fSelection2="MultiPoint":f.match(/Point/)?this.fSelection2="MultiPoint":this.fSelection2="mapshape"}if("LatLon"==this.fSelection||"UTM"==this.fSelection)return e+"::"+(String(this.objTheme.dbRecords[b][this.nSelection_0]).replace(/,/g,".")+","+String(this.objTheme.dbRecords[b][this.nSelection_1]).replace(/,/g,"."))+(this.szSelectionFieldSuffix||"").replace(/,/g,".");if("MultiPoint"==this.fSelection)return szId=this.objTheme.dbRecords[b][this.objTheme.nFieldSelectionIndex],f=null,(f=szId.match(positionRegExp))?
e+"::"+(f[2]+","+f[1])+(this.szSelectionFieldSuffix||""):null;szId=__mpap_decode_utf8(String(this.objTheme.dbRecords[b][this.objTheme.nFieldSelectionIndex]));this.nSelectionFieldDigits&&(szId=("000000000000000"+szId).slice(-this.nSelectionFieldDigits));this.fSelectionFieldToNumber&&(szId=String(Number(szId)));this.fSelectionFieldToUpper&&(szId=String(szId).toUpperCase());return e+"::"+szId+(this.szSelectionFieldSuffix||"")};
MapTheme.prototype.loadValuesOfTheme=function(e){var b,f,c,h,g;this.fNegativeValues=this.fField100=!1;this.szUnit=(this.szUnits?"."==this.szUnits.substr(0,1)?"":" ":"")+(this.szUnits||"");var q=!0;this.objTheme=this.objThemesA[e];0<this.objTheme.nField100Index&&(this.fField100=!0);if(this.objTheme.dbTable&&e&&e.length){if(this.coTable){try{eval("this.objTheme.dbRecords = "+this.coTable+".records")}catch(l){eval("this.objTheme.dbRecords = "+this.coTable+"_records")}if(!this.objTheme.dbRecords)return displayMessage("Data "+
this.coTable+" could not be loaded!",2E3,!0),!1}else try{eval("this.objTheme.dbRecords = "+e+".records")}catch(r){eval("this.objTheme.dbRecords = "+e+"_records")}this.objTheme.nFieldSelectionIndexA.length||delete this.objTheme.nFieldSelectionIndexA;if("$item$"!=this.szFieldsA[0]&&!this.szFlag.match(/CATEGORICAL/))for(h=Math.min(40,this.objTheme.dbRecords.length),b=0;b<h;b++)if(this.objTheme.dbRecords[b])for(f=0;f<this.szFieldsA.length;f++)if(c=this.objTheme.dbRecords[b][this.objTheme.nFieldIndexA[f]],
__scanValue(c)!=parseFloat(c)){this.__fScanValue=!0;b=h;break}if(this.szFlag.match(/FAST/)||this.szFlag.match(/AGGREGATE/)&&!this.szFlag.match(/COMPATIBLE|PERCENTOFMEAN/))return this.__fAggregateOnLoad=!0,this.unpaintMap(),this.loadAndAggregateValuesOfTheme(e);for(b=0;b<this.objTheme.dbRecords.length;b++)if(!this.objTheme.dbRecords[b]||this.objTheme.dbRecords[b].length<this.objTheme.dbFields.length)this.nWrongRecordLengthCount++;else if(!this.__fFilter||this.filterValues(b)){h=[];if("$item$"==this.szFieldsA[0])h[0]=
1;else if("$index$"==this.szFieldsA[0])h[0]=b+1;else for(f=0;f<this.szFieldsA.length;f++)c=this.objTheme.dbRecords[b][this.objTheme.nFieldIndexA[f]],this.__fExact?(c=this.valueMap?this.valueMap[String(c)]:c,c=this.getStringValueIndex(String(c))):c=this.__fScanValue?__scanValue(c):parseFloat(c),isNaN(c)||0==c&&!this.fNullIsValue||0>c&&!this.fNegativeValuePossible||(h[f]=c);h.length=this.szFieldsA.length;g="$item$"==this.szField100?1:0>this.objTheme.nField100Index?0:__scanValue(this.objTheme.dbRecords[b][this.objTheme.nField100Index]);
0!=g||this.fNullIsValue||(g=null);0>g&&!this.fNegativeValuePossible&&(g=null);var k=null;this.szSizeField&&(k=__scanValue(this.objTheme.dbRecords[b][this.objTheme.nSizeFieldIndex]));var w=null;this.szAlphaField&&(w=__scanValue(this.objTheme.dbRecords[b][this.objTheme.nAlphaFieldIndex]),isNaN(w)&&(w=0));this.szAlphaField100&&this.objTheme.nAlphaField100Index&&(w*=100/__scanValue(this.objTheme.dbRecords[b][this.objTheme.nAlphaField100Index]),isNaN(w)&&(w=0));if(c=f=this.getSelectionId(e,b)){0<=this.objTheme.nFieldItemIndex&&
this.objTheme.nFieldItemIndex!=this.objTheme.nFieldSelectionIndex&&(f=__mpap_decode_utf8(String(this.objTheme.dbRecords[b][this.objTheme.nFieldItemIndex])),this.fSelectionFieldToUpper&&(f=String(f).toUpperCase()),f=e+"::"+f);if(this.itemA[f]){if(this.szFlag.match(/DOT/))continue;f+="*"+Math.random();if(this.itemA[f])continue}this.addItemValues(f,h,g,k,w);this.itemA[f]&&(this.szColorField&&(this.itemA[f].szColor="$index$"==this.szColorField?b+1:__mpap_decode_utf8(this.objTheme.dbRecords[b][this.objTheme.nColorFieldIndex])),
this.szSymbolField&&(this.itemA[f].szSymbol="$index$"==this.szSymbolField?b+1:__mpap_decode_utf8(this.objTheme.dbRecords[b][this.objTheme.nSymbolFieldIndex])),this.szValueField&&(this.itemA[f].szValue="$index$"==this.szValueField?b+1:__mpap_decode_utf8(this.objTheme.dbRecords[b][this.objTheme.nValueFieldIndex])),this.szTimeField&&(this.itemA[f].szTime="$index$"==this.szTimeField?b+1:__mpap_decode_utf8(this.objTheme.dbRecords[b][this.objTheme.nTimeFieldIndex])),this.szLabelField&&(this.itemA[f].szLabel=
"$index$"==this.szLabelField?b+1:__mpap_decode_utf8(this.objTheme.dbRecords[b][this.objTheme.nLabelFieldIndex])),this.szTitleField&&(this.itemA[f].szTitle=__mpap_decode_utf8(this.objTheme.dbRecords[b][this.objTheme.nTitleFieldIndex])),this.szSnippetField&&(this.itemA[f].szSnippet=__mpap_decode_utf8(this.objTheme.dbRecords[b][this.objTheme.nSnippetFieldIndex])),this.itemA[f].szSelectionId=c?c:f,this.szAggregationField&&(this.itemA[f].szAggregation=__mpap_decode_utf8(this.objTheme.dbRecords[b][this.objTheme.nAggregationFieldIndex])),
this.szXField&&(this.itemA[f].nX=__scanValue(this.objTheme.dbRecords[b][this.objTheme.nXFieldIndex]),isNaN(this.itemA[f].nX)||(this.nMinX=Math.min(this.nMinX,this.itemA[f].nX),this.nMaxX=Math.max(this.nMaxX,this.itemA[f].nX),this.nSumX+=this.itemA[f].nXField)),this.szYField&&(this.itemA[f].nY=__scanValue(this.objTheme.dbRecords[b][this.objTheme.nYFieldIndex]),isNaN(this.itemA[f].nY)||(this.nMinY=Math.min(this.nMinY,this.itemA[f].nY),this.nMaxY=Math.max(this.nMaxY,this.itemA[f].nY),this.nSumY+=this.itemA[f].nYField)),
this.itemA[f].dbIndex=b)}else this.nMissingLookupCount++}}else q=!1;if(q)return this.fAnalyze=!0};
MapTheme.prototype.loadAndAggregateValuesOfTheme=function(e,b){var f,c,h,g,q,l,r;if(!b){console.log("*** F A S T ***");this.fNegativeValues=this.fField100=!1;this.__fMultiParts=this.szFlag.match(/CATEGORICAL/)&&!(this.szFlag.match(/PIE/)||this.szFlag.match(/BAR/)||this.szFlag.match(/SEQUENCE/)||this.szFlag.match(/PLOT/)||this.szFlag.match(/DOMINANT/)||this.szFlag.match(/COMPOSECOLOR/)||this.szFlag.match(/USER/)||this.szFlag.match(/WAFFLE/));this.szUnit=(this.szUnits?"."==this.szUnits.substr(0,1)?
"":" ":"")+(this.szUnits||"");this.objTheme=this.objThemesA[e];0<this.objTheme.nField100Index&&(this.fField100=!0);if(!(this.objTheme.dbTable&&e&&e.length))return!1;if(this.coTable){try{eval("this.objTheme.dbRecords = "+this.coTable+".records")}catch(k){eval("this.objTheme.dbRecords = "+this.coTable+"_records")}if(!this.objTheme.dbRecords)return displayMessage("Data "+this.coTable+" could not be loaded!",2E3,!0),!1}else try{eval("this.objTheme.dbRecords = "+e+".records")}catch(w){eval("this.objTheme.dbRecords = "+
e+"_records")}this.objTheme.nFieldSelectionIndexA.length||delete this.objTheme.nFieldSelectionIndexA;if(this.szFlag.match(/ZOOMTO/)){this.getSelectionId(e,0);for(f=0;f<this.objTheme.dbRecords.length;f++){if("UTM"==this.fSelection)x=map.Scale.getMapPositionOfUTM(parseFloat(String(this.objTheme.dbRecords[f][this.nSelection_0]).replace(/\,/g,".")),parseFloat(String(this.objTheme.dbRecords[f][this.nSelection_1]).replace(/\,/g,".")),this.szCRSDatum,this.szCRSUTMZone);else if("LatLon"==this.fSelection)x=
map.Scale.getMapPositionOfLatLon(parseFloat(String(this.objTheme.dbRecords[f][this.nSelection_0]).replace(/\,/g,".")),parseFloat(String(this.objTheme.dbRecords[f][this.nSelection_1]).replace(/\,/g,".")));else if("MultiPoint"==this.fSelection){h=this.objTheme.dbRecords[f][this.objTheme.nFieldSelectionIndex];var m=h.match(positionRegExp),x=map.Scale.getMapPositionOfLatLon(parseFloat(m[2]),parseFloat(m[1]))}else h=this.objTheme.dbRecords[f][this.objTheme.nFieldSelectionIndex],this.fSelectionFieldToUpper&&
(h=String(h).toUpperCase()),x=this.getNodePosition(e+"::"+h);x&&(this.itemA[e+"::"+String(x.x)+","+String(x.y)]={ptPos:x})}this.zoomTo();this.itemA=[];this.removeDefinitionFromFlag("ZOOMTO");var v=map.Themes.getMapThemeDefinitionObj(this.szId);map.Themes.newThemeObjA=map.Themes.newThemeObjA||[];map.Themes.newThemeObjA.push(v);setTimeout("map.Themes.newThemeByObj()",100);return}this.createChartGroup(map.Layer.objectGroup);if("$item$"!=this.szFieldsA[0]&&!this.szFlag.match(/CATEGORICAL/)){var z=Math.min(40,
this.objTheme.dbRecords.length);for(f=0;f<z;f++)if(this.objTheme.dbRecords[f])for(c=0;c<this.szFieldsA.length;c++){var y=this.objTheme.dbRecords[f][this.objTheme.nFieldIndexA[c]];if(__scanValue(y)!=parseFloat(y)){this.__fScanValue=!0;f=z;break}}}"$item$"==this.szSizeField&&(this.oldSizefield=this.szSizeField,this.szSizeField=null);this.nGridWidthPx&&(this.nGridWidth=f=map.Scale.getDistanceInMeter(1E3,1E3,1E3+map.Scale.normalX(this.nGridWidthPx),1E3));this.nGridMatrix&&(f=map.Zoom.getBox(),f=map.Scale.getDistanceInMeter(1E3,
1E3,1E3+f.width,1E3),this.nGridWidth=f/(this.nGridMatrix||20)/map.Scale.nZoomScale);this.nGridWidthMap=this.nGridWidth?Math.round(map.Scale.getDeltaXofDistanceInMeter(this.nGridWidth)/20)*map.Scale.nZoomScale*20:0;this.nGridWidth&&!this.nGridWidthMap&&(this.nGridWidthMap=this.nGridWidth?map.Scale.getDeltaXofDistanceInMeter(this.nGridWidth)*map.Scale.nZoomScale:0);this.dY=this.dX=0;this.szFlag.match(/FIXGRID/)&&(this.dX=map.Scale.mapCenter.x*map.Scale.nZoomScale,this.dY=map.Scale.mapCenter.y*map.Scale.nZoomScale);
this.nGridOffsetX&&(this.dX-=this.nGridWidthMap/100*this.nGridOffsetX);this.nGridOffsetY&&(this.dY+=this.nGridWidthMap/100*this.nGridOffsetY);this.nHexaWidth=1.15*this.nGridWidthMap;this.nHexaHalf=1.15*this.nGridWidthMap/2;this.nHexa4th=this.nGridWidthMap/4;this.getSelectionId(e,0);this.aggregationCount=0;this.nMin=Number.MAX_VALUE;this.nMax=-Number.MAX_VALUE;this.nMinSize=Number.MAX_VALUE;this.nMaxSize=-Number.MAX_VALUE;this.nSumSize=0;this.nMinAlpha=Number.MAX_VALUE;this.nMaxAlpha=-Number.MAX_VALUE;
this.nSumAlpha=0;if(this.__fExact)this.nMinA=[],this.nMaxA=[],this.nSumA=[],this.nOrigMinA=[],this.nOrigMaxA=[],this.nOrigSumA=[],this.nMedianA=[],this.nMeanA=[],this.nCountA=[];else for(f=0;f<this.szFieldsA.length;f++)this.nMinA[f]=Number.MAX_VALUE,this.nMaxA[f]=-Number.MAX_VALUE,this.nSumA[f]=0,this.nOrigMinA[f]=Number.MAX_VALUE,this.nOrigMaxA[f]=-Number.MAX_VALUE,this.nOrigSumA[f]=0,this.nMedianA[f]=0,this.nMeanA[f]=0;this.nEmptyValuesA=[];for(l in this.szValuesA)this.nEmptyValuesA.push(0);this.szFlag.match(/DUMP/)&&
(this.nChartGroupScale=fObjectScaling?(this.nAutoScale||this.nScale)*map.Layer.nObjectScale*map.Scale.nObjectScaling:(this.nAutoScale||this.nScale)*map.Scale.nFeatureScaling*map.Scale.nObjectScaling,this.chartGroup=map.Dom.newGroup(map.Layer.objectGroup,this.szId+":chartgroup"));if(!this.szWeightsA)for(this.szWeightsA=[],f=0;f<this.szFieldsA.length;f++)this.szWeightsA.push(1);else if(this.szWeightsA.length&&this.szWeightsA.length!=this.szFieldsA.length)for(l=this.szWeightsA[this.szWeightsA.length-
1],f=this.szWeightsA.length;f<this.szFieldsA.length;f++)this.szWeightsA.push(l)}if(this.szAggregationUpper&&map.Scale.nTrueMapScale*map.Scale.nZoomScale>this.nAggregationUpper||this.szAggregationLower&&map.Scale.nTrueMapScale*map.Scale.nZoomScale<this.nAggregationLower)this.__fAggregate=!1;z=2E5<this.objTheme.dbRecords.length;for(f=b||0;f<this.objTheme.dbRecords.length;f++){if(z&&f>(b||0)&&!(f%5E4))return this.fContinueLoadAndAggregate=!0,this.continueIndex=f,this.szThemeLayer=e,displayMessage(__formatValue(f/
this.objTheme.dbRecords.length*100,0)+"% aggregated"),displayProgressBar(f,this.objTheme.dbRecords.length,""),setTimeout("map.Themes.executeContinue()",10),!0;if(!this.objTheme.dbRecords[f]||this.objTheme.dbRecords[f].length<this.objTheme.dbFields.length)this.nWrongRecordLengthCount++;else if(!this.__fFilter||this.filterValues(f)){var J=!1,C=[];if("$item$"==this.szFieldsA[0])C[0]=1;else if("$index$"==this.szFieldsA[0])C[0]=f+1;else for(c=0;c<this.szFieldsA.length;c++)y=this.objTheme.dbRecords[f][this.objTheme.nFieldIndexA[c]],
y=this.valueMap?this.valueMap[String(y)]||y:y,this.__fExact?(y=this.getStringValueIndex(String(y)),this.exactCountA[y-1]=(this.exactCountA[y-1]||0)+1):y=this.__fScanValue?__scanValue(y)*(this.szWeightsA[c]||1):parseFloat(y)*(this.szWeightsA[c]||1),isNaN(y)?J=!0:0!=y||this.fNullIsValue?0>y&&!this.fNegativeValuePossible?J=!0:C[c]=y:J=!0;C.length=this.szFieldsA.length;l="$item$"==this.szField100?1:0>this.objTheme.nField100Index?0:__scanValue(this.objTheme.dbRecords[f][this.objTheme.nField100Index]);
0!=l||this.fNullIsValue||(l=null);0>l&&!this.fNegativeValuePossible&&(l=null);var F=null;if(this.szSizeField&&"$item$"!=this.szSizeField){F=this.objTheme.dbRecords[f][this.objTheme.nSizeFieldIndex];F=this.valueMap?this.valueMap[String(F)]||__scanValue(F):__scanValue(F);F=isFinite(F)&&!isNaN(F)?F:0;if(0==F&&!this.fNullIsValue)continue;if(0>F&&!this.fNegativeValuePossible)continue}else F=1;var u=null;this.szAlphaField&&(u=__scanValue(this.objTheme.dbRecords[f][this.objTheme.nAlphaFieldIndex]));var A=
null;this.szTitleField&&(A=this.objTheme.dbRecords[f][this.objTheme.nTitleFieldIndex]);var E=null;this.szColorField&&(E="$index$"==this.szColorField?f+1:__mpap_decode_utf8(this.objTheme.dbRecords[f][this.objTheme.nColorFieldIndex]));var I=null;this.szTimeField&&(I="$index$"==this.szTimeField?f+1:__mpap_decode_utf8(this.objTheme.dbRecords[f][this.objTheme.nTimeFieldIndex]));c=null;this.szXField&&(c=__scanValue(this.objTheme.dbRecords[f][this.objTheme.nXFieldIndex]));var D=null;this.szYField&&(D=__scanValue(this.objTheme.dbRecords[f][this.objTheme.nYFieldIndex]));
var x=null,O=null;"UTM"==this.fSelection?h=(x=map.Scale.getMapPositionOfUTM(parseFloat(String(this.objTheme.dbRecords[f][this.nSelection_0]).replace(/\,/g,".")),parseFloat(String(this.objTheme.dbRecords[f][this.nSelection_1]).replace(/\,/g,".")),this.szCRSDatum,this.szCRSUTMZone))?String(x.x)+","+String(x.y):"":"LatLon"==this.fSelection?h=(x=map.Scale.getMapPositionOfLatLon(parseFloat(String(this.objTheme.dbRecords[f][this.nSelection_0]).replace(/\,/g,".")),parseFloat(String(this.objTheme.dbRecords[f][this.nSelection_1]).replace(/\,/g,
"."))))?String(x.x)+","+String(x.y):"":"MultiPoint"==this.fSelection?(h=this.objTheme.dbRecords[f][this.objTheme.nFieldSelectionIndex],m=h.match(positionRegExp),x=map.Scale.getMapPositionOfLatLon(parseFloat(m[2]),parseFloat(m[1]))):(h=this.objTheme.dbRecords[f][this.objTheme.nFieldSelectionIndex],this.fSelectionFieldToUpper&&(h=String(h).toUpperCase()),this.nSelectionFieldDigits&&(h=("000000000000000"+h).slice(-this.nSelectionFieldDigits)),this.fSelectionFieldToNumber&&(h=String(Number(h))),x=this.getNodePosition(e+
"::"+h));this.szFlag.match(/DUMP/)&&(shapeGroup=map.Dom.newGroup(this.chartGroup,this.szId+":"+h+":chart"),shapeGroup.fu.setMatrix([this.nChartGroupScale,0,0,this.nChartGroupScale,x.x,x.y]),map.Dom.newShape("circle",shapeGroup,0,0,map.Scale.normalX(3),"fill:blue;fill-opacity:0.2;stroke:none;"));if(!x||isNaN(x.x)||isNaN(x.y))this.fDataIncomplete=this.fRedraw=!0;else{var Oa=x;g=m=null;this.fSelection2&&("UTM"==this.fSelection2?m=map.Scale.getMapPositionOfUTM(parseFloat(String(this.objTheme.dbRecords[f][this.nSelection2_0]).replace(/\,/g,
".")),parseFloat(String(this.objTheme.dbRecords[f][this.nSelection2_1]).replace(/\,/g,".")),this.szCRSDatum,this.szCRSUTMZone):"LatLon"==this.fSelection2?m=map.Scale.getMapPositionOfLatLon(parseFloat(String(this.objTheme.dbRecords[f][this.nSelection2_0]).replace(/\,/g,".")),parseFloat(String(this.objTheme.dbRecords[f][this.nSelection2_1]).replace(/\,/g,"."))):"MultiPoint"==this.fSelection?(m=h.match(positionRegExp),m=map.Scale.getMapPositionOfLatLon(parseFloat(m[2]),parseFloat(m[1]))):(g=this.objTheme.dbRecords[f][this.objTheme.nFieldSelection2Index],
this.nSelectionFieldDigits&&(g=("000000000000000"+h).slice(-this.nSelectionFieldDigits)),this.fSelectionFieldToUpper&&(g=String(g).toUpperCase()),m=this.getNodePosition(e+"::"+g)),g=__mpap_decode_utf8(String(this.objTheme.dbRecords[f][this.objTheme.nFieldIndexA[0]])),this.fSelectionFieldToUpper&&(g=String(g).toUpperCase()),q=g,g=e+"::"+g,this.themeNodesPosA[g]=m);if(!m||x.x!=m.x||x.y!=m.y){if(this.nGridWidthMap)if(this.szFlag.match(/\bRECT\b/))x=this.dX||this.dY?new point(Math.round((x.x+this.dX)/
this.nGridWidthMap)*this.nGridWidthMap-this.dX,Math.round((x.y+this.dY)/this.nGridWidthMap)*this.nGridWidthMap-this.dY):new point(Math.round(x.x/this.nGridWidthMap)*this.nGridWidthMap,Math.round(x.y/this.nGridWidthMap)*this.nGridWidthMap);else{if(this.szFlag.match(/PLOTY/))var O=Math.round(x.y/this.nGridWidthMap),ca=O%2?this.nHexaHalf:0,O=new point(Math.round((x.x+ca)/this.nHexaWidth)*this.nHexaWidth-ca,O*this.nGridWidthMap);else var O=Math.round(x.x/this.nGridWidthMap),ra=O%2?this.nHexaHalf:0,O=
new point(O*this.nGridWidthMap,Math.round((x.y+ra)/this.nHexaWidth)*this.nHexaWidth-ra);if(Math.abs(O.x-x.x)>this.nHexa4th){var ca=[],ya=[],ra=0==ra?this.nHexaHalf:0;O.x>x.x?(ca[0]=new point(O.x-this.nGridWidthMap,O.y-this.nHexaHalf),ca[1]=new point(O.x-this.nGridWidthMap,O.y+this.nHexaHalf)):(ca[0]=new point(O.x+this.nGridWidthMap,O.y-this.nHexaHalf),ca[1]=new point(O.x+this.nGridWidthMap,O.y+this.nHexaHalf));ya[0]=Math.sqrt(Math.pow(ca[0].x-x.x,2)+Math.pow(ca[0].y-x.y,2));ya[1]=Math.sqrt(Math.pow(ca[1].x-
x.x,2)+Math.pow(ca[1].y-x.y,2));ya[3]=Math.sqrt(Math.pow(O.x-x.x,2)+Math.pow(O.y-x.y,2));ya[0]<ya[3]?O=new point(Math.round(ca[0].x/this.nGridWidthMap)*this.nGridWidthMap,Math.round((ca[0].y+ra)/this.nHexaWidth)*this.nHexaWidth-ra):ya[1]<ya[3]&&(O=new point(Math.round(ca[1].x/this.nGridWidthMap)*this.nGridWidthMap,Math.round((ca[1].y+ra)/this.nHexaWidth)*this.nHexaWidth-ra))}x=O}this.nGridWidthMap&&m&&!this.szFlag.match(/\bORIGIN\b/)&&(this.szFlag.match(/\bRECT\b/)?m=this.dX||this.dY?new point(Math.round((m.x+
this.dX)/this.nGridWidthMap)*this.nGridWidthMap-this.dX,Math.round((m.y+this.dY)/this.nGridWidthMap)*this.nGridWidthMap-this.dY):new point(Math.round(m.x/this.nGridWidthMap)*this.nGridWidthMap,Math.round(m.y/this.nGridWidthMap)*this.nGridWidthMap):(this.szFlag.match(/PLOTY/)?(O=Math.round(m.y/this.nGridWidthMap),ca=O%2?this.nHexaHalf:0,O=new point(Math.round((m.x+ca)/this.nHexaWidth)*this.nHexaWidth-ca,O*this.nGridWidthMap)):(O=Math.round(m.x/this.nGridWidthMap),ra=O%2?this.nHexaHalf:0,O=new point(O*
this.nGridWidthMap,Math.round((m.y+ra)/this.nHexaWidth)*this.nHexaWidth-ra)),Math.abs(O.x-m.x)>this.nHexa4th&&(ca=[],ya=[],ra=0==ra?this.nHexaHalf:0,O.x>m.x?(ca[0]=new point(O.x-this.nGridWidthMap,O.y-this.nHexaHalf),ca[1]=new point(O.x-this.nGridWidthMap,O.y+this.nHexaHalf)):(ca[0]=new point(O.x+this.nGridWidthMap,O.y-this.nHexaHalf),ca[1]=new point(O.x+this.nGridWidthMap,O.y+this.nHexaHalf)),ya[0]=Math.sqrt(Math.pow(ca[0].x-m.x,2)+Math.pow(ca[0].y-m.y,2)),ya[1]=Math.sqrt(Math.pow(ca[1].x-m.x,2)+
Math.pow(ca[1].y-m.y,2)),ya[3]=Math.sqrt(Math.pow(O.x-m.x,2)+Math.pow(O.y-m.y,2)),ya[0]<ya[3]?O=new point(Math.round(ca[0].x/this.nGridWidthMap)*this.nGridWidthMap,Math.round((ca[0].y+ra)/this.nHexaWidth)*this.nHexaWidth-ra):ya[1]<ya[3]&&(O=new point(Math.round(ca[1].x/this.nGridWidthMap)*this.nGridWidthMap,Math.round((ca[1].y+ra)/this.nHexaWidth)*this.nHexaWidth-ra))),m=O),this.themeNodesPosA[g]=m);g=h;this.szAggregationField?(h=__mpap_decode_utf8(this.objTheme.dbRecords[f][this.objTheme.nAggregationFieldIndex]),
h=e+"::"+h):h=e+"::"+String(x.x)+","+String(x.y)+(this.__fMultiParts?","+String(y):"");m&&this.szFlag.match(/VECTOR/)&&(h+="&"+String(m.x)+","+String(m.y));if(this.__fAggregate)if(!this.itemA[h]){this.aggregationCount++;J=0;if(this.__fMultiParts)J=F;else if(this.__fExact)if(c=C[0]-1,isNaN(c))continue;else C=this.nEmptyValuesA.slice(0),J=C[c]=F,r=this.nEmptyValuesA.slice(0),r[c]=1;else for(c=0;c<this.szFieldsA.length;c++)J=Math.max(J,C[c]||0);this.itemA[h]={nOrigValuesA:[],nValuesA:C,nValue100:l,nValueSum:0,
nCount:1,nCountA:r};this.itemA[h].szTitle=A;this.itemA[h].szSelectionId=String(g);this.itemA[h].szSelectionId2=String(q);this.itemA[h].nSize=F||(this.objTheme.nSizeFieldIndex?0:J);this.itemA[h].nAlpha=u||1;this.itemA[h].szColor=E;this.itemA[h].szTime=I;this.itemA[h].dbIndexA=[f];this.itemA[h].ptPos=x;this.itemA[h].ptPos2=m;this.itemA[h].ptPosA=[Oa];this.nCount++}else{if(!J){J=0;if(this.__fMultiParts)J=F;else if(this.__fExact)if(c=C[0]-1,isNaN(c))continue;else this.itemA[h].nValuesA[c]=this.__fMax?
Math.max(this.itemA[h].nValuesA[c]||0,F):(this.itemA[h].nValuesA[c]||0)+F,this.itemA[h].nCountA[c]=(this.itemA[h].nCountA[c]||0)+1,J=F;else for(c=0;c<this.szFieldsA.length;c++)this.itemA[h].nValuesA[c]+=C[c],J=Math.max(J,C[c]||0);this.itemA[h].nSize+=F||(this.objTheme.nSizeFieldIndex?0:J);this.itemA[h].nAlpha+=u||1;this.itemA[h].nValue100+=l;this.itemA[h].nCount++;this.itemA[h].dbIndexA.push(f);this.itemA[h].ptPosA.push(Oa);A!=this.itemA[h].szTitle&&(this.itemA[h].szTitle="("+this.itemA[h].nCount+
")")}}else this.itemA[h]&&(h+="*"+Math.random()),this.aggregationCount++,this.itemA[h]={nOrigValuesA:[],nValuesA:C,nValue100:l,nValueSum:0},this.itemA[h].szSelectionId=String(g),this.itemA[h].szSelectionId2=String(q),this.itemA[h].nSize=F||0,this.itemA[h].ptPos=x,this.itemA[h].ptPos2=m,this.itemA[h].dbIndexA=[f],this.itemA[h].nX=c,this.itemA[h].nY=D,this.itemA[h].szColor=E,this.itemA[h].szTime=I,this.nCount++}}}}if(0<=this.objTheme.nField100Index)if(this.fField100=!0,this.szFlag.match(/DIFFERENCE/)&&
1==this.itemA[v].nValuesA.length&&!this.szFlag.match(/RELATIVE/))for(v in this.itemA)for(c=0;c<this.itemA[v].nValuesA.length;c++)this.itemA[v].nValuesA[c]-=this.itemA[v].nValue100;else if(this.szFlag.match(/FRACTION/))for(v in this.itemA)for(c=0;c<this.itemA[v].nValuesA.length;c++)this.itemA[v].nValuesA[c]=this.itemA[v].nValuesA[c]/this.itemA[v].nValue100*(this.nFractionScale||1);else if(this.szFlag.match(/PRODUCT/))for(v in this.itemA)for(c=0;c<this.itemA[v].nValuesA.length;c++)this.itemA[v].nValuesA[c]*=
this.itemA[v].nValue100;else if(this.szFlag.match(/CALCVAL/))for(v in this.itemA)for(c=0;c<this.itemA[v].nValuesA.length;c++)this.itemA[v].nValuesA[c]=Math.round(this.itemA[v].nValuesA[c]*this.itemA[v].nValue100/100);else if(this.szFlag.match(/PERMILLE/))for(v in this.itemA)for(c=0;c<this.itemA[v].nValuesA.length;c++)this.itemA[v].nValuesA[c]*=1E3/this.itemA[v].nValue100;else for(v in this.itemA)for(c=0;c<this.itemA[v].nValuesA.length;c++)this.itemA[v].nValue100>(this.nField100Min||0)?(this.itemA[v].nValuesA[c]*=
100/this.itemA[v].nValue100,0<this.itemA[v].nValuesA[c]&&this.szFlag.match(/RELATIVE/)?this.itemA[v].nValuesA[c]-=100:0<this.itemA[v].nValuesA[c]&&this.szFlag.match(/INVERT/)&&(this.itemA[v].nValuesA[c]=100-y)):this.itemA[v].nValuesA[c]=0;else if(this.__fAggregate&&this.szFlag.match(/MEAN/))if(this.__fMultiParts)for(v in this.itemA)this.itemA[v].nSize/=this.itemA[v].nCount;else for(v in this.itemA){if(this.itemA[v].nCountA)for(c=0;c<this.itemA[v].nValuesA.length;c++)this.itemA[v].nValuesA[c]/=this.itemA[v].nCountA[c]||
1;else for(c=0;c<this.itemA[v].nValuesA.length;c++)this.itemA[v].nValuesA[c]/=this.itemA[v].nCount;this.szFlag.match(/SIZESUM/)||(this.itemA[v].nSize/=this.itemA[v].nCount)}if(this.szFlag.match(/DIFFERENCE/))for(v in this.itemA){for(f=0;f<this.itemA[v].nValuesA.length;f++)f<this.itemA[v].nValuesA.length-1?(q=this.itemA[v].nValuesA[f],this.itemA[v].nValuesA[f]=this.itemA[v].nValuesA[f+1]-this.itemA[v].nValuesA[f],this.szFlag.match(/RELATIVE/)&&(this.itemA[v].nValuesA[f]=q>(this.nField100Min||0)?100/
q*this.itemA[v].nValuesA[f]:0)):this.szFlag.match(/STACKED/)||(this.itemA[v].nValuesA[f]=0);this.itemA[v].nValuesA.pop()}if(this.szFlag.match(/AUTO100/))for(v in this.itemA){for(f=l=0;f<this.itemA[v].nValuesA.length;f++)l+=this.itemA[v].nValuesA[f]||0;this.itemA[v].nValue100=l;this.fField100=!0;for(f=0;f<this.itemA[v].nValuesA.length;f++)this.itemA[v].nValuesA[f]/=this.itemA[v].nValue100/100}if(this.szFlag.match(/RELOCATE/)||this.szAggregationField)for(v in this.itemA)if(this.itemA[v].ptPosA){for(p=
r=q=0;p<this.itemA[v].ptPosA.length;p++)q+=this.itemA[v].ptPosA[p].x,r+=this.itemA[v].ptPosA[p].y;this.itemA[v].ptPos={x:q/this.itemA[v].nCount,y:r/this.itemA[v].nCount}}if(this.szMinAggregation){r=q=0;for(v in this.itemA)r+=this.itemA[v].nCount,q++;r/=q;for(v in this.itemA)this.itemA[v].nCount&&this.itemA[v].nCount<(this.nMinAggregation||r/2)&&delete this.itemA[v]}this.nMin=Number.MAX_VALUE;this.nMax=-Number.MAX_VALUE;this.nMinA=[];this.nMaxA=[];if(this.__fExact||this.szSizeField)for(v in this.itemA)isFinite(this.itemA[v].nSize)&&
!isNaN(this.itemA[v].nSize)&&(this.nMin=this.nMinSize=Math.min(this.nMinSize,this.itemA[v].nSize),this.nMax=this.nMaxSize=Math.max(this.nMaxSize,this.itemA[v].nSize),this.nSumSize+=this.itemA[v].nSize);else for(v in this.itemA)for(l=0;l<this.itemA[v].nValuesA.length;l++)isFinite(this.itemA[v].nValuesA[l])&&!isNaN(this.itemA[v].nValuesA[l])&&(this.nMin=Math.min(this.itemA[v].nValuesA[l],this.nMin),this.nMax=Math.max(this.itemA[v].nValuesA[l],this.nMax));for(v in this.itemA)for(l=0;l<this.itemA[v].nValuesA.length;l++)isFinite(this.itemA[v].nValuesA[l])&&
!isNaN(this.itemA[v].nValuesA[l])?(this.nMinA[l]=Math.min(this.itemA[v].nValuesA[l],this.nMinA[l]||Number.MAX_VALUE),this.nMaxA[l]=Math.max(this.itemA[v].nValuesA[l],this.nMaxA[l]||-Number.MAX_VALUE),this.nSumA[l]+=this.itemA[v].nValuesA[l]):(this.nMinA[l]=this.nMinA[l]||Number.MAX_VALUE,this.nMaxA[l]=this.nMaxA[l]||-Number.MAX_VALUE);if(this.szAlphaField)for(v in this.itemA)isFinite(this.itemA[v].nAlpha)&&!isNaN(this.itemA[v].nAlpha)&&(this.nMinAlpha=Math.min(this.nMinAlpha,this.itemA[v].nAlpha),
this.nMaxAlpha=Math.max(this.nMaxAlpha,this.itemA[v].nAlpha),this.nSumAlpha+=this.itemA[v].nAlpha);if(this.szSizeField)for(v in this.itemA)isFinite(this.itemA[v].nSize)&&!isNaN(this.itemA[v].nSize)&&(this.nMinSize=Math.min(this.nMinSize,this.itemA[v].nSize),this.nMaxSize=Math.max(this.nMaxSize,this.itemA[v].nSize),this.nSumSize+=this.itemA[v].nSize);if(this.szXField)for(v in this.itemA)isNaN(this.itemA[v].nX)||(this.nMinX=Math.min(this.nMinX,this.itemA[v].nX),this.nMaxX=Math.max(this.nMaxX,this.itemA[v].nX),
this.nSumX+=this.itemA[v].nX);if(this.szYField)for(v in this.itemA)isNaN(this.itemA[v].nY)||(this.nMinY=Math.min(this.nMinY,this.itemA[v].nY),this.nMaxY=Math.max(this.nMaxY,this.itemA[v].nY),this.nSumY+=this.itemA[v].nY);if(this.szValueField&&this.szSizeField==this.szValueField)for(v in this.itemA)this.itemA[v].szValue=String(this.itemA[v].nSize);this.oldSizefield&&(this.szSizeField=this.oldSizefield,this.oldSizeField=null);return this.fAnalyze=!0};
MapTheme.prototype.loadTableFromMap=function(){var e,b,f,c={table:{fields:0,records:0},fields:[],records:[]},h=SVGDocument.getElementById(this.szThemesA[0]);if(null==h){var g=map.Tiles.getTileNodes(this.szThemesA[0]);g&&(h=g[0])}if(!h)return this.szThemes="",null;h=h.getAttributeNS(szMapNs,"info");if(null==h||""==h)return this.szThemes="",null;h=h.split("|");h.push("FeatureId");for(e in h)c.fields.push({id:h[e]}),c.table.fields++;var h=[],q=[];for(e=0;e<this.szThemesA.length;e++){this.objTheme=this.objThemesA[this.szThemesA[e]];
g=map.Layer.getLayerObj(this.szThemesA[e]);if(null==g)return alert("MapTheme error: no layer like '"+this.szThemesA[e]+"'"),!1;if(g.szFlag.match(/tiled/)){q[0]=map.Scale.canvasNode;q.length=1;this.fDataIncomplete=!map.Tiles.allTilesLoaded();break}else q[q.length]=SVGDocument.getElementById(g.szName)}g=!0;for(b=0;b<q.length;b++){f=q[b].getElementsByTagName("path");var l=q[b].getElementsByTagName("use"),r=q[b].getElementsByTagName("circle");for(e=0;e<f.length;e++)h[h.length]=f.item(e);for(e=0;e<l.length;e++)h[h.length]=
l.item(e);for(e=0;e<r.length;e++)h[h.length]=r.item(e)}if(0==h.length)for(g=!1,b=0;b<q.length;b++)for(f=q[b].getElementsByTagName("g"),e=0;e<f.length;e++)h[h.length]=f.item(e);for(e=0;e<h.length;e++)if(1==h[e].nodeType&&h[e].hasAttributeNS(szMapNs,"info")){f=g?h[e].parentNode.getAttributeNS(null,"id"):h[e].getAttributeNS(null,"id");q=-1;if(f&&0!==f.length)for(l=map.Tiles.getMasterId(f).split(":")[0],b=0;b<this.szThemesA.length;b++)l==this.szThemesA[b]&&(q=b);b=map.Tiles.getMasterId(f);!this.itemA[b]&&
0<=q&&(q=h[e].getAttributeNS(szMapNs,"info").split("|"),q.push(b.split("::")[1]),c.records.push(q),c.table.records++,this.itemA[b]=1)}this.itemA=[];return c};
MapTheme.prototype.aggregateValues=function(){if(!(this.__fAggregateOnLoad||!this.szFlag.match(/AGGREGATE/)&&!this.szFlag.match(/GROUP/)||this.szAggregationUpper&&map.Scale.nTrueMapScale*map.Scale.nZoomScale>this.nAggregationUpper||this.szAggregationLower&&map.Scale.nTrueMapScale*map.Scale.nZoomScale<this.nAggregationLower)){var e=[],b=[],f=[],c=[],h=[],g=null,q=0;this.nTopicsSkipedByZeroExclusion=0;this.nGridWidthPx&&(this.nGridWidth=g=map.Scale.getDistanceInMeter(1E3,1E3,1E3+map.Scale.normalX(this.nGridWidthPx),
1E3));this.nGridMatrix&&(g=map.Zoom.getBox(),g=map.Scale.getDistanceInMeter(1E3,1E3,1E3+g.width,1E3),this.nGridWidth=g/(this.nGridMatrix||20)/map.Scale.nZoomScale);var l=this.nGridWidth?Math.round(map.Scale.getDeltaXofDistanceInMeter(this.nGridWidth)/20)*map.Scale.nZoomScale*20:0,g=function(b){for(elem in b)return elem}(this.itemA),r="undefined",k=this.itemA[g].szSelectionId.split("::")[0],w=null,m=1.15*l,x=1.15*l/2,v=l/4;if(this.szAggregationField)for(a in this.itemA){r="undefined";g=g||a;r=this.itemA[a].szAggregation;
e[r]||(e[r]=[],c[r]=new point(0,0),b[r]=0,f[r]=0,q++);e[r][a]=this.itemA[a];e[r][a].nSize=this.itemA[a].nSize||1;e[r][a].szTitle=this.itemA[a].szTitle||r;f[r]+=e[r][a].nSize;var z=this.getNodePosition(this.itemA[a].szSelectionId);z&&(c[r].x+=z.x,c[r].y+=z.y,b[r]++)}else if(this.nGridWidth)for(a in this.itemA)if(z=this.getNodePosition(this.itemA[a].szSelectionId)){if(this.szFlag.match(/\bRECT\b/))this.szFlag.match(/FIXGRID/)?(w=map.Scale.mapCenter.x*map.Scale.nZoomScale,r=map.Scale.mapCenter.y*map.Scale.nZoomScale,
w=new point(Math.round((z.x+w)/l)*l-w,Math.round((z.y+r)/l)*l-r)):w=new point(Math.round(z.x/l)*l,Math.round(z.y/l)*l);else{if(this.szFlag.match(/PLOTY/))w=Math.round(z.y/l),r=w%2?x:0,w=new point(Math.round((z.x+r)/m)*m-r,w*l);else var w=Math.round(z.x/l),y=w%2?x:0,w=new point(w*l,Math.round((z.y+y)/m)*m-y);if(Math.abs(A-z.x)>v){var r=[],J=[],y=0==y?x:0;A>z.x?(r[0]=new point(w.x-l,w.y-x),r[1]=new point(w.x-l,w.y+x)):(r[0]=new point(w.x+l,w.y-x),r[1]=new point(w.x+l,w.y+x));J[0]=Math.sqrt(Math.pow(r[0].x-
z.x,2)+Math.pow(r[0].y-z.y,2));J[1]=Math.sqrt(Math.pow(r[1].x-z.x,2)+Math.pow(r[1].y-z.y,2));J[3]=Math.sqrt(Math.pow(w.x-z.x,2)+Math.pow(w.y-z.y,2));J[0]<J[3]?w=new point(Math.round(r[0].x/l)*l,Math.round((r[0].y+y)/m)*m-y):J[1]<J[3]&&(w=new point(Math.round(r[1].x/l)*l,Math.round((r[1].y+y)/m)*m-y))}}r=k+"::"+String(w.x)+","+String(w.y);this.themeNodesPosA[a]=w;this.themeNodesPosA[r]=w;e[r]||(e[r]=[],c[r]=new point(0,0),b[r]=0,q++);e[r][a]=this.itemA[a];e[r][a].nSize=this.itemA[a].nSize||1;c[r].x+=
z.x;c[r].y+=z.y;b[r]++}else e[r]||(e[r]=[],c[r]=new point(0,0),b[r]=0,this.fDataIncomplete=fTilesLoaded,q++),e[r][a]=this.itemA[a],e[r][a].nSize=this.itemA[a].nSize||1,b[r]++,this.fDataIncomplete=!0;else for(a in this.itemA)(z=this.getNodePosition(this.itemA[a].szSelectionId))?(r=this.itemA[a].szSelectionId,e[r]||(e[r]=[],c[r]=new point(0,0),b[r]=0,q++),e[r][a]=this.itemA[a],e[r][a].nSize=this.itemA[a].nSize||1,c[r].x+=z.x,c[r].y+=z.y,b[r]++):(e[r]||(e[r]=[],c[r]=new point(0,0),b[r]=0,this.fDataIncomplete=
fTilesLoaded,q++),e[r][a]=this.itemA[a],e[r][a].nSize=this.itemA[a].nSize||1,b[r]++,this.fDataIncomplete=!0);if(this.szFlag.match(/GROUP/))for(t in this.itemA=[],e){q=e[t];this.indexA=[];for(a in q)this.indexA.push(a);for(var b=[],C=0;C<this.indexA.length;C++)b.push({a:this.indexA[C],y:q[this.indexA[C]].nValuesA[0]});this.szFlag.match(/\bUP\b/)?b.sort(this.sortDownChartObjectsCompare):b.sort(this.sortUpChartObjectsCompare);for(C in b)q[b[C].a].szSelectionId=t,this.itemA[t+"*"+Math.random()]=q[b[C].a]}else{if(this.szFlag.match(/CATEGORICAL/))for(t in this.szSizeField||
(this.szSizeField="$aggregation$"),e){q=e[t];h[t]=0;y=[];for(a in q)h[t]++,y[q[a].nValuesA[0]]||(y[q[a].nValuesA[0]]={itemA:[]}),y[q[a].nValuesA[0]].itemA[a]=q[a];e[t]=[];for(C in y)for(a in q=y[C].itemA,k=null,q)null==k?(k=e[t][a]=q[a],k.nCount=1,k.dbIndexA=k.dbIndexA||[],k.nSize=k.nSize||1,k.nAlpha=k.nAlpha||1):(k.nCount+=1,k.nValue100+=q[a].nValue100,k.nSize+=q[a].nSize||1,k.nAlpha+=q[a].nAlpha||1,k.szValue=String(k.nSize),l&&!this.szAggregationField&&(!k.szTitle||3<k.nCount)&&(k.szTitle="("+k.nCount+
")"),k.dbIndexA.push(q[a].dbIndex))}else for(t in e){q=e[t];if(!this.szFlag.match(/SUM/)&&!this.szFlag.match(/ZEROISVALUE/)){l=[];y=0;for(a in q)if(y++,q[a])for(C=0;C<q[a].nValuesA.length;C++)if(0==q[a].nOrigValuesA[C]){l[a]=a;break}if(1<y)for(a in l)delete q[a],this.nTopicsSkipedByZeroExclusion++}e[t]=[];k=null;for(a in q)if(null==k)k=e[t][a]=q[a],k.nCount=1,k.dbIndexA=k.dbIndexA||[],k.nSize=k.nSize||1,k.nAlpha=k.nAlpha||1;else{for(C=0;C<q[a].nValuesA.length;C++)k.nValuesA[C]+=q[a].nValuesA[C]||
0,k.nOrigValuesA[C]+=q[a].nOrigValuesA[C]||0;k.nCount+=1;k.nValue100+=q[a].nValue100;k.nSize+=q[a].nSize||1;k.nAlpha+=q[a].nAlpha||1;k.szValue=String(k.nSize);k.szTitle="("+this.formatValue(k.nCount,0)+")";k.dbIndexA.push(q[a].dbIndex)}}if(this.szAggregationField||this.szFlag.match(/RELOCATE/)){var F=new point(0,0),u=0,C=1E6,l=0;for(t in e)C=Math.min(C,c[t].x/b[t]),u=Math.max(u,c[t].y/b[t]),F.x+=c[t].x*(f[t]||1),F.y+=c[t].y*(f[t]||1),l+=b[t]*(f[t]||1);F.x/=l;F.y/=l;new point(C,F.y);u=new point(F.x,
u)}this.nMin=Number.MAX_VALUE;this.nMax=-Number.MAX_VALUE;this.nMinSize=Number.MAX_VALUE;this.nSumSize=this.nMaxSize=0;this.nMinAlpha=Number.MAX_VALUE;this.nSumAlpha=this.nMaxAlpha=0;this.szFlag.match(/CATEGORICAL/)&&(this.nMinA=[],this.nMaxA=[],this.nSumA=[],this.nOrigMinA=[],this.nOrigMaxA=[],this.nOrigSumA=[],this.nMedianA=[],this.nMeanA=[],this.nCountA=[]);f="[";l=this.nStringToValue-1;for(C=0;C<l;C++)f+="0,";f+="]";this.itemA=[];l=0;y=Math.max(this.szRangesA?this.szRangesA.length:0,this.szExactA?
this.szExactA.length:0)-(this.szFlag.match(/CATEGORICAL/)?0:1);k=this.szFlag.match(/CATEGORICAL/)&&(this.szFlag.match(/PIE/)||this.szFlag.match(/BAR/)||this.szFlag.match(/SEQUENCE/)||this.szFlag.match(/PLOT/)||this.szFlag.match(/DOMINANT/)||this.szFlag.match(/USER/)||this.szFlag.match(/WAFFLE/));for(t in e)if(l++,"undefined"!=t){var q=e[t],A;if(k){for(a in q){A=a;break}this.itemA[A]={};eval("var nValuesA = "+f+";");this.itemA[A].szSelectionId=A;this.itemA[A].szTitle=q[A].szTitle;if(this.szAggregationField||
this.szFlag.match(/RELOCATE/))this.szFlag.match(/ALIGN/)?(this.itemA[A].szSelectionId=g,this.szFlag.match(/\bUP\b/)?this.themeNodesPosA[A]=new point(u.x,u.y):this.themeNodesPosA[A]=new point(F.x,F.y)):this.themeNodesPosA[A]=new point(c[t].x/b[t],c[t].y/b[t]);this.itemA[A].dbIndexA=[];m=C=0;for(a in q){nValuesA[q[a].nValuesA[0]-1]=q[a].nSize/(this.szFlag.match(/SUM/)?1:q[a].nCount);C+=q[a].nSize;m+=q[a].nCount;this.itemA[A].dbIndexA.push(q[a].dbIndex);for(db in q[a].dbIndexA)this.itemA[A].dbIndexA.push(q[a].dbIndexA[db]);
delete this.itemA[A].dbIndex}this.itemA[A].nValuesA=this.itemA[A].nOrigValuesA=nValuesA;this.itemA[A].nMinA=[];this.itemA[A].nMaxA=[];this.itemA[A].nSize=C/(this.szFlag.match(/SUM/)?1:m);this.itemA[A].nCount=m;this.itemA[A].nAlpha=q[a].nAlpha;this.itemA[A].szTitle=this.nGridWidth&&!this.szAggregationField&&1<h[t]?__formatValue(h[t],0)+" item(s) aggregated":this.itemA[A].szTitle||t;this.itemA[A].szValue=this.itemA[A].szTitle;this.itemA[A].szLabel=this.itemA[A].szTitle;this.nMin=this.nMinSize=Math.min(this.nMinSize,
this.itemA[A].nSize);this.nMax=this.nMaxSize=Math.max(this.nMaxSize,this.itemA[A].nSize);this.nSumSize+=C/(this.szFlag.match(/SUM/)?1:m);this.nMinAlpha=Math.min(this.nMinAlpha,this.itemA[A].nAlpha);this.nMaxAlpha=Math.max(this.nMaxAlpha,this.itemA[A].nAlpha);this.nSumAlpha+=this.itemA[A].nAlpha;if(this.szFlag.match(/AUTO100/)){for(C=nValue100=0;C<this.itemA[A].nValuesA.length;C++)nValue100+=this.itemA[A].nValuesA[C]||0;this.itemA[A].nValue100=nValue100;this.fField100=!0;for(C=0;C<this.itemA[A].nValuesA.length;C++)this.itemA[A].nValuesA[C]=
this.itemA[A].nOrigValuesA[C]/this.itemA[A].nValue100*100}if(this.szFlag.match(/CATEGORICAL/)&&(this.szFlag.match(/CATEGORICAL/)||!this.nNormalSizeValue)){if(!this.nMinA.length)for(C=0;C<this.itemA[A].nValuesA.length;C++)this.nMinA[C]=null,this.nMaxA[C]=null,this.nSumA[C]=0,this.nOrigMinA[C]=null,this.nOrigMaxA[C]=null,this.nOrigSumA[C]=0,this.nMedianA[C]=0,this.nMeanA[C]=0,this.nCountA[C]=0;for(C=0;C<this.itemA[A].nValuesA.length;C++)this.nMinA[C]=Math.min(this.nMinA[C]||this.itemA[A].nValuesA[C],
this.itemA[A].nValuesA[C]),this.nMaxA[C]=Math.max(this.nMaxA[C]||this.itemA[A].nValuesA[C],this.itemA[A].nValuesA[C]),this.nSumA[C]+=this.itemA[A].nValuesA[C],this.nOrigMinA[C]=Math.min(this.nOrigMinA[C]||this.itemA[A].nOrigValuesA[C],this.itemA[A].nOrigValuesA[C]),this.nOrigMaxA[C]=Math.max(this.nOrigMaxA[C]||this.itemA[A].nOrigValuesA[C],this.itemA[A].nOrigValuesA[C]),this.nOrigSumA[C]+=this.itemA[A].nOrigValuesA[C],this.itemA[A].nValuesA[C]&&this.nCountA[C]++}this.nCount=l*y}else for(a in q)if(q[a]){m=
a;this.szAggregationField||(m=t,this.itemA[m]&&(m=m.split("*")[0]+"*"+Math.random()));this.itemA[m]=q[a];q[a].szValue=q[a].szValue||1;this.nMinSize=Math.min(this.nMinSize,this.itemA[m].nSize);this.nMaxSize=Math.max(this.nMaxSize,this.itemA[m].nSize);this.nSumSize+=this.itemA[m].nSize;this.nMinAlpha=Math.min(this.nMinAlpha,this.itemA[m].nAlpha);this.nMaxAlpha=Math.max(this.nMaxAlpha,this.itemA[m].nAlpha);this.nSumAlpha+=this.itemA[m].nAlpha;this.szFlag.match(/SUM/)||(x=this.szFlag.match(/SUM/)?1:q[a].nCount,
this.itemA[m].nSize/=x,this.itemA[m].szValue/=x,this.itemA[m].nValue100/=x);if(this.nGridWidth||this.szAggregationField)for(x=this.szFlag.match(/SUM/)||this.szFlag.match(/CATEGORICAL/)?1:q[a].nCount,this.itemA[m].szSelectionId=a,C=0;C<this.itemA[m].nValuesA.length;C++)this.itemA[m].nValuesA[C]/=x,this.itemA[m].nOrigValuesA[C]/=x,this.itemA[m].nValue100&&(this.itemA[m].nValuesA[C]=this.itemA[m].nOrigValuesA[C]/this.itemA[m].nValue100,this.szFlag.match(/FRACTION/)||(this.itemA[m].nValuesA[C]*=this.szFlag.match(/PERMILLE/)?
1E3:100),this.szFlag.match(/INVERT/)&&(this.itemA[m].nValuesA[C]=100-this.itemA[m].nValuesA[C])),this.nMin=Math.min(this.itemA[m].nValuesA[C]||Number.MAX_VALUE,this.nMin||Number.MAX_VALUE),this.nMax=Math.max(this.itemA[m].nValuesA[C]||-Number.MAX_VALUE,this.nMax||-Number.MAX_VALUE);else this.nMin=Math.min(this.itemA[m].nSize,this.nMin||Number.MAX_VALUE),this.nMax=Math.max(this.itemA[m].nSize,this.nMax||-Number.MAX_VALUE);if(this.szFlag.match(/AUTO100/)){for(C=nValue100=0;C<this.itemA[m].nValuesA.length;C++)nValue100+=
this.itemA[m].nValuesA[C]||0;this.itemA[m].nValue100=nValue100;this.fField100=!0;for(C=0;C<this.itemA[m].nValuesA.length;C++)this.itemA[m].nValuesA[C]=this.itemA[m].nOrigValuesA[C]/this.itemA[m].nValue100*100}if(this.szAggregationField||this.szFlag.match(/RELOCATE/))this.szFlag.match(/ALIGN/)?this.szFlag.match(/\bUP\b/)?this.themeNodesPosA[m]=new point(u.x,u.y):this.themeNodesPosA[m]=new point(F.x,F.y):(this.themeNodesPosA[a]=new point(c[t].x/b[t],c[t].y/b[t]),this.themeNodesPosA[m]=new point(c[t].x/
b[t],c[t].y/b[t]))}}if(this.szMinAggregation){e=x=0;for(a in this.itemA)e+=this.itemA[a].nCount,x++;e/=x;for(a in this.itemA)this.itemA[a].nCount&&this.itemA[a].nCount<(this.nMinAggregation||e/2)&&delete this.itemA[a];this.nMin=Number.MAX_VALUE;this.nMax=-Number.MAX_VALUE;for(a in this.itemA)for(C=0;C<this.itemA[a].nValuesA.length;C++)this.nMin=Math.min(this.itemA[a].nValuesA[C],this.nMin),this.nMax=Math.max(this.itemA[a].nValuesA[C],this.nMax)}this.fSorted=!0}}};
MapTheme.prototype.distributeValues=function(){if(0==this.nCount)return!1;if(this.szFlag.match(/OUTLIER/)){var e=this.szFieldsA.length;this.getMeanMedianQuantile();for(var b=0;b<e;b++){var f=[],c;for(c in this.itemA)this.itemA[c].nValuesA[b]&&f.push(this.itemA[c].nValuesA[b]);this.nDeviationA[b]=this.parent.getDeviationOfArray(f)}for(b=0;b<e;b++)for(c in this.itemA)Math.abs(this.itemA[c].nValuesA[b]-this.nMeanA[b])>3*this.nDeviationA[b]?this.szFlag.match(/NOOUTLIER/)&&delete this.itemA[c]:this.szFlag.match(/NOOUTLIER/)||
delete this.itemA[c];this.nMin=Number.MAX_VALUE;this.nMax=-Number.MAX_VALUE;for(c in this.itemA)for(var h=0;h<this.itemA[c].nValuesA.length;h++)this.nMin=Math.min(this.itemA[c].nValuesA[h],this.nMin),this.nMax=Math.max(this.itemA[c].nValuesA[h],this.nMax)}(this.szFlag.match(/AGGREGATE/)||this.szFlag.match(/GROUP/))&&this.aggregateValues();"$aggregation$"==this.szSizeField&&(this.szSizeField=null);if(this.szFlag.match(/CATEGORICAL/)&&(!this.szExactA||!this.szExactA.length)&&(this.szExactA=this.szExactA||
[],this.nStringToValueA))for(c in this.nStringToValueA)this.szExactA.push(this.nStringToValueA[c]);!this.szFlag.match(/CATEGORICAL/)||this.szLabelA&&this.szLabelA.length||!this.szValuesA||(this.szLabelA=this.szValuesA);if(this.szColorField)if(this.colorFieldA=[],this.colorClassA=[],this.colorClassUsedA=[],this.szColorValuesA)for(b in this.szColorValuesA)this.colorFieldA[this.szColorValuesA[b]]=!0;else if(this.szValuesA)for(b in this.szValuesA)this.colorFieldA[this.szValuesA[b]]=!0;else for(c in this.itemA)this.colorFieldA[this.itemA[c].szColor]=
!0;if(this.szSymbolField)if(this.symbolFieldA=[],this.szSymbolValuesA)for(b in this.szSymbolValuesA)this.symbolFieldA[this.szSymbolValuesA[b]]=this.szSymbolsA[b];else for(c in this.itemA)this.symbolFieldA[this.itemA[c].szSymbol]=this.szSymbolsA[b];this.origColorScheme||(this.origColorScheme=this.colorScheme=this.defaultColorScheme);if(isNaN(Number(this.origColorScheme[0])))this.colorScheme=this.origColorScheme.slice(0);else{!this.szFlag.match(/SEQUENCE/)&&!this.szFlag.match(/CLIP/)&&this.szFieldsA.length>
this.origColorScheme[0]&&(this.origColorScheme[0]=this.szFieldsA.length);this.szFlag.match(/CATEGORICAL/)&&(this.origColorScheme[0]=this.szExactA.length||1);if(this.szColorField){b=0;for(c in this.colorFieldA)b++;this.origColorScheme[0]=b}try{this.colorScheme=ColorScheme.createColorScheme(this.origColorScheme[1],this.origColorScheme[2],this.origColorScheme[0],this.origColorScheme[3],this.origColorScheme[4])}catch(g){this.colorScheme=this.defaultColorScheme}if(this.szFlag.match(/CATEGORICAL/)&&this.szFlag.match(/ORDER/)){e=
this.colorScheme.slice();f=this.szValuesA?this.szValuesA.slice():this.szLabelA.slice();if(this.szColorField)for(c in f=[],this.colorFieldA)f.push(c),this.getStringValueIndex(c,"set");if(f.length&&e.length&&f.length==e.length)for(f.sort(),this.colorScheme=[],b=0;b<f.length;b++)this.colorScheme[this.nStringToValueA[f[b]]-1]=e[b]}}if(this.szColorField){b=0;for(c in this.colorFieldA)this.colorClassA[c]=b,this.colorFieldA[c]=this.colorScheme[b++];for(c in this.itemA)this.itemA[c].nClass=this.colorClassA[this.itemA[c].szColor],
this.itemA[c].szColor=this.colorFieldA[this.itemA[c].szColor]}if(this.szSymbolField)for(c in this.itemA)this.itemA[c].szSymbol=this.symbolFieldA[this.itemA[c].szSymbol];if(this.colorScheme[0].match(/user/i))try{HTMLWindow.ixmaps.htmlgui_colorScheme(this)}catch(q){}if(this.szFlag.match(/DOMINANT/))for(;this.colorScheme.length<this.szFieldsA.length;)this.colorScheme[this.colorScheme.length]="#dddddd";if(this.szFieldsA)if(this.colorScheme.length<this.szFieldsA.length&&this.nGridX)for(;this.colorScheme.length<
this.nGridX;)this.colorScheme[this.colorScheme.length]=this.colorScheme[this.colorScheme.length-1]||"#dddddd";else if(!this.szFlag.match(/CLIP/))for(;this.colorScheme.length<this.szFieldsA.length;)this.colorScheme[this.colorScheme.length]=this.colorScheme[this.colorScheme.length-1]||"#dddddd";if(this.szFlag.match(/NORMALIZE/)&&this.nMax){var l=this.nMax-this.nMin;for(c in this.itemA)this.itemA[c].nValuesA[0]=(this.itemA[c].nValuesA[0]-this.nMin)/l;this.nMin=0;this.nMax=1}if(this.szFlag.match(/HARMONIZE/)&&
this.nMax){if(this.nMaxA){this.nRangeA=[];for(h in this.nMaxA)this.nRangeA.push(this.nMaxA[h]-this.nMinA[h]);for(c in this.itemA)for(h in this.itemA[c].nValuesA)this.itemA[c].nValuesA[h]=(this.itemA[c].nValuesA[h]-this.nMinA[h])/this.nRangeA[h];for(h in this.nMaxA)this.nMinA[h]=0,this.nMaxA[h]=1}else{for(c in this.itemA)this.itemA[c].nValuesA[0]/=this.nMax;this.nMin/=this.nMax;this.nMax/=this.nMax}this.nMin=0;this.nMax=1}if(this.szFlag.match(/INVERTSIZE/)&&this.szSizeField){for(c in this.itemA)this.itemA[c].nSize=
this.nMaxSize-this.itemA[c].nSize;this.nNormalSizeValue=this.nNormalSizeValue||this.nMaxSize}this.szFlag.match(/CATEGORICAL/)||this.szFlag.match(/SEQUENCE/)||this.getMeanMedianQuantile();e=this.colorScheme.length;l=this.nMax-this.nMin;h=this.nMin;f=this.nMax;null==this.nRangeCenterValue||isNaN(this.nRangeCenterValue)||(b=Math.max(Math.abs(this.nRangeCenterValue-h),Math.abs(f-this.nRangeCenterValue)),h=this.nRangeCenterValue-b,f=this.nRangeCenterValue+b,l=f-h);if(this.szFlag.match(/INTEGER/))e>l?e=
l:e>l/2?e=Math.floor(l/2):l+=e-l%e;else{var r=1;for(this.szField100&&(r=.01);l>1E3*r;)r*=10;1<r?(h=Math.floor(h/r)*r,f=Math.ceil(f/r)*r):f+=f/1E5;l=f-h}if(this.szColorField)for(c in this.nRangesA=[],b=0,this.colorFieldA)this.nRangesA.push(b++);else this.nRangesA=this.szRangesA||this.szExactA;if(this.nRangesA&&this.nRangesA.length){e=this.nRangesA.length-(this.szFlag.match(/CATEGORICAL/)?0:1);if(this.szSymbolsA&&this.szSymbolsA.length)for(;this.szSymbolsA.length<e;)this.szSymbolsA[this.szSymbolsA.length]=
this.szSymbolsA[this.szSymbolsA.length-1];if(this.colorScheme&&this.colorScheme.length)for(;this.colorScheme.length<e;)this.colorScheme[this.colorScheme.length]=this.colorScheme[this.colorScheme.length-1]||"#dddddd";this.partsA=[];for(b=0;b<e;b++)h=Number(this.nRangesA[b]),f=Number(this.nRangesA[b+(this.szFlag.match(/CATEGORICAL/)?0:1)])+1E-9,this.partsA[this.partsA.length]={min:h,max:f,color:this.colorScheme[b],nCount:0,nSum:0};if(this.szFlag.match(/CATEGORICAL/)&&this.exactCountA)for(b=0;b<e;b++)this.partsA[b].nCount=
this.exactCountA[b];if(this.szFlag.match(/PLOTVAR/)||this.szFlag.match(/DOMINANT/))for(this.getMeanMedianQuantile(),b=0;b<e;b++){f=[];for(c in this.itemA)this.itemA[c].nValuesA[b]&&f.push(this.itemA[c].nValuesA[b]);this.nDeviationA[b]=this.parent.getDeviationOfArray(f);this.szDominantFilter=this.szDominantFilter||"min";this.nDominantDFilter=this.nDominantDFilter||0;this.szDominantFilter.match(/min/)?this.nFilterA[b]=this.nMinA[b]+(this.nMaxA[b]-this.nMinA[b])/100*this.nDominantDFilter:this.szDominantFilter.match(/max/)?
this.nFilterA[b]=this.nMinA[b]+(this.nMaxA[b]-this.nMinA[b])/100*this.nDominantDFilter:this.szDominantFilter.match(/mean/)?this.nFilterA[b]=this.nMeanA[b]+(this.nMaxA[b]-this.nMeanA[b])/100*this.nDominantDFilter:this.szDominantFilter.match(/median/)&&(this.nFilterA[b]=this.nMedianA[b]+(this.nMaxA[b]-this.nMedianA[b])/100*this.nDominantDFilter)}}else{l/=e;l>r&&(l=Math.floor(l/r)*r);this.nMin==this.nMax&&(e=1);this.partsA=[];for(b=0;b<e;b++)this.partsA[this.partsA.length]={min:h+b*l,max:h+(b+1)*l,color:this.colorScheme[b],
nCount:0,nSum:0};this.partsA[this.partsA.length-1].max=f;if(this.szFlag.match(/QUANTILE/)){this.getMeanMedianQuantile();r=Math.round(this.quantileA[0].length/e);for(b=0;b<this.partsA.length;b++)this.partsA[b].min=this.quantileA[0][b*r],this.partsA[b].max=this.quantileA[0][(b+1)*r];this.partsA[this.partsA.length-1].max=f}if(this.szFlag.match(/LOG/)){h=Math.log(this.nMin?this.nMin:Math.min(.1,this.nMax/10));l=Math.log(this.nMax?this.nMax:.1)-h;l/=e;this.partsA=[];for(b=0;b<e;b++)this.partsA[this.partsA.length]=
{min:Math.exp(h+b*l),max:Math.exp(h+(b+1)*l),color:this.colorScheme[b],nCount:0,nSum:0};this.partsA[this.partsA.length-1].max=this.nMax}else if(this.szFlag.match(/POW2/)){h=Math.pow(this.nMin?this.nMin:1,.5);l=Math.pow(this.nMax?this.nMax:1,.5)-Math.pow(this.nMin?this.nMin:1,.5);l/=e;this.partsA=[];for(b=0;b<e;b++)this.partsA[this.partsA.length]={min:Math.pow(h+b*l,2),max:Math.pow(h+(b+1)*l,2),color:this.colorScheme[b],nCount:0,nSum:0};this.partsA[this.partsA.length-1].max=this.nMax}else if(this.szFlag.match(/POW3/)){h=
Math.pow(this.nMin?this.nMin:1,1/3);l=Math.pow(this.nMax?this.nMax:1,1/3)-Math.pow(this.nMin?this.nMin:1,1/3);l/=e;this.partsA=[];for(b=0;b<e;b++)this.partsA[this.partsA.length]={min:Math.pow(h+b*l,3),max:Math.pow(h+(b+1)*l,3),color:this.colorScheme[b],nCount:0,nSum:0};this.partsA[this.partsA.length-1].max=this.nMax}if(this.szFlag.match(/DOMINANT/)||this.szFlag.match(/OFFSETMEAN/)||this.szFlag.match(/OFFSETMEDIAN/)||this.szFlag.match(/DEVIATION/)||this.szFlag.match(/PLOTVAR/)){this.getMeanMedianQuantile();
for(b=0;b<this.szFieldsA.length;b++){r=[];for(c in this.itemA)this.itemA[c].nValuesA[b]&&r.push(this.itemA[c].nValuesA[b]);"$item$"!=this.szFieldsA[b]&&r.sort(this.sortUp);this.nMedianA[b]=r[Math.round(r.length/2)];this.nSum100?this.szFlag.match(/DIFFERENCE/)?this.nMeanA[b]=this.nSumA[b]/this.nCount:(this.nMeanA[b]=this.nOrigSumA[b]/this.nSum100,this.szFlag.match(/FRACTION/)?this.nMeanA[b]*=this.nFractionScale||1:this.szFlag.match(/PERMILLE/)?this.nMeanA[b]*=1E3:(this.nMeanA[b]*=100,this.szFlag.match(/RELATIVE/)?
this.nMeanA[b]-=100:this.szFlag.match(/INVERT/)&&(this.nMeanA[b]=100-this.nMeanA[b]))):this.nMeanA[b]=this.nSumA[b]/this.nCount}for(b=0;b<this.partsA.length;b++)this.szDominantFilter=this.szDominantFilter||"min",this.nDominantDFilter=this.nDominantDFilter||0,this.szDominantFilter.match(/min/)?this.nFilterA[b]=this.nMinA[b]+(this.nMaxA[b]-this.nMinA[b])/100*this.nDominantDFilter:this.szDominantFilter.match(/max/)?this.nFilterA[b]=this.nMinA[b]+(this.nMaxA[b]-this.nMinA[b])/100*this.nDominantDFilter:
this.szDominantFilter.match(/mean/)?this.nFilterA[b]=this.nMeanA[b]+(this.nMaxA[b]-this.nMeanA[b])/100*this.nDominantDFilter:this.szDominantFilter.match(/median/)&&(this.nFilterA[b]=this.nMedianA[b]+(this.nMaxA[b]-this.nMedianA[b])/100*this.nDominantDFilter);if(this.szFlag.match(/DEVIATION/)||this.szFlag.match(/PLOTVAR/))for(b=0;b<this.szFieldsA.length;b++){f=[];for(c in this.itemA)this.itemA[c].nValuesA[b]&&f.push(this.itemA[c].nValuesA[b]);this.nDeviationA[b]=this.parent.getDeviationOfArray(f)}}}this.partsA[this.partsA.length-
1].max+=.001;this.szColorField&&(this.nRangesA=this.szRangesA||this.szExactA);this.szFlag.match(/COMPOSECOLOR/)&&__maptheme_initComposedColor(this.colorScheme.slice(0));return!0};MapTheme.prototype.sortUp=function(e,b){return e-b};MapTheme.prototype.sortIndexUp=function(e,b){return e.value-b.value};MapTheme.prototype.sortIndexDown=function(e,b){return b.value-e.value};MapTheme.prototype.sortPartsUp=function(e,b){return e.nCount-b.nCount};MapTheme.prototype.sortMeanUp=function(e,b){return e.mean-b.mean};
MapTheme.prototype.shuffleArray=function(e,b){for(var f=e.length-1;0<f;f--){var c=Math.floor((b&&b[f]?b[f]:Math.random())*f+1),h=e[f];e[f]=e[c];e[c]=h}};MapTheme.prototype.getRandomNumberArray=function(e){for(var b=[],f=0;f<e;f++)b.push(Math.random());return b};
var sum_composecolor_intensity=0,mean_composecolor_intensity=0,__maptheme_initComposedColor=function(e){for(var b=mean_composecolor_intensity=sum_composecolor_intensity=0;b<e.length;b++){var f=ColorScheme.getHexaColor(e[b]);mean_composecolor_intensity+=Math.max(Math.max(parseInt(f.substr(1,2),16),parseInt(f.substr(3,2),16)),parseInt(f.substr(5,2),16));sum_composecolor_intensity+=parseInt(f.substr(1,2),16)+parseInt(f.substr(3,2),16)+parseInt(f.substr(5,2),16)}sum_composecolor_intensity/=e.length;mean_composecolor_intensity/=
e.length},__maptheme_getComposedColor_additive=function(e,b,f,c){for(var h=0,g=0,q=0,l=0;l<e.length;l++)var r=ColorScheme.getHexaColor(b[l]),h=h+parseInt(r.substr(1,2),16)*((e[l]||0)/(f||1)),g=g+parseInt(r.substr(3,2),16)*((e[l]||0)/(f||1)),q=q+parseInt(r.substr(5,2),16)*((e[l]||0)/(f||1));e=Math.max(Math.max(h,g),q);h=Math.floor(h/e*(c||mean_composecolor_intensity));g=Math.floor(g/e*(c||mean_composecolor_intensity));q=Math.floor(q/e*(c||mean_composecolor_intensity));return ColorScheme.getHexaColor("rgb("+
h+","+g+","+q+")")},__maptheme_getComposedColor_subtractive=function(e,b,f,c){c=c||Math.min(Math.floor(sum_composecolor_intensity),300)||255;for(var h=0,g=0,q=0,l=0;l<e.length;l++)var r=ColorScheme.getHexaColor(b[l]),h=h+(255-parseInt(r.substr(1,2),16))*((e[l]||0)/(f||1)),g=g+(255-parseInt(r.substr(3,2),16))*((e[l]||0)/(f||1)),q=q+(255-parseInt(r.substr(5,2),16))*((e[l]||0)/(f||1));e=Math.max(Math.max(h,g),q);h=Math.min(255,c-Math.floor(h/e*mean_composecolor_intensity));g=Math.min(255,c-Math.floor(g/
e*mean_composecolor_intensity));q=Math.min(255,c-Math.floor(q/e*mean_composecolor_intensity));return ColorScheme.getHexaColor("rgb("+h+","+g+","+q+")")};
MapTheme.prototype.paintMap=function(e){this.beginDraw();this.mapSleep&&(this.mapSleep.checkSleepMessage="painting map");var b=0,f=0,c=0,h=0,g=0,q=0,l="",r="";map.Dictionary.getLocalText("of mean");map.Dictionary.getLocalText("of median");var k=!1,w=0,m=c=l=0,h=null;this.fillOpacity=this.fillOpacity?this.fillOpacity:this.nOpacity;this.szStyle="fill-opacity:"+String(this.fillOpacity?this.fillOpacity:fTransparentMap?.6:1);this.autoOpacity&&(this.szStyle="fill-opacity:"+String(Math.max(.3,Math.min(1,
.3+.7/Math.max(1,Math.log(map.Zoom.nZoom))))));this.szShapeType.match(/line/)&&(this.szStyle=this.fillOpacity?"stroke-opacity:"+this.fillOpacity+";":"stroke-opacity:1");if(!e||0==e){e=0;this.indexA=[];for(m in this.itemA)this.indexA[this.indexA.length]=m,this.itemA[m].todo=!0;this.nDoneCount=0}for(;e<this.indexA.length;e++){if(this.mapSleep&&(this.mapSleep.nDoneCount=this.nDoneCount,this.mapSleep.checkSleep(e,10))){this.fContinue=!0;this.continueIndex=e;this.szItemFilter&&this.szItemFilter.length&&
this.filterItems(this.szItemFilter,this.itemFilterOpt);return}m=this.indexA[e];this.nDoneCount++;k=!1;w=0;if(this.szFlag.match(/COMPOSECOLOR/)){b=this.szFlag.match(/SUBTRACTIVE/)?__maptheme_getComposedColor_subtractive(this.itemA[m].nValuesA,this.colorScheme,this.nMax,Math.floor(255*this.nBrightness)):__maptheme_getComposedColor_additive(this.itemA[m].nValuesA,this.colorScheme,this.nMax,Math.floor(255*this.nBrightness));h=this.getItemNodes(m);for(c=0;c<h.length;c++)if(g=this.paintShape(h[c],b,-1,
-1),this.szFlag.match(/DOPACITY/)){if(this.szAlphaField)q=0,"undefined"!=typeof this.itemA[m].nAlpha&&(q=1/(this.nDopacityPow||1),q=(this.nDopacityScale||1)/Math.pow(this.nMaxAlpha,q)*Math.pow(this.itemA[m].nAlpha,q));else var q=1/(this.nDopacityPow||1),w=(isNaN(this.itemA[m].nValueSum)?0:this.itemA[m].nValueSum)/(this.itemA[m].nValue100/100||1),x=isNaN(this.nMax)?0:this.nMax,q=(this.nDopacityScale||1)*Math.pow(w,q)/Math.pow(x,q);g.style.setProperty("fill-opacity",String(q),"")}k=!0}else if(this.szFlag.match(/DOMINANT/)){k=
!0;nIndex=-1;for(l=0;l<this.itemA[m].nValuesA.length;l++)b=this.itemA[m].nValuesA[l],f=100/this.nMeanA[l]*b,c=100/this.nMedianA[l]*b,h=(b-this.nMeanA[l])/this.nDeviationA[l],g=b,this.szFlag.match(/PERCENTOFMEAN/)&&(g=f),this.szFlag.match(/PERCENTOFMEDIAN/)&&(g=c),this.szFlag.match(/DEVIATION/)&&(g=h),b>this.nFilterA[l]&&g>w&&(this.itemA[m].nClass=l,w=g,nIndex=l);if(0<=nIndex){this.itemA[m].nDominant=nIndex;b=this.itemA[m].nValuesA[nIndex];l=" "+this.szFieldsA[nIndex]+" ";this.szLabelA&&this.szLabelA[nIndex]&&
(l=" "+this.szLabelA[nIndex]+" ");if(this.szFlag.match(/PERCENTOFMEAN/)||this.szFlag.match(/DEVIATION/))r=map.Dictionary.getLocalText(" ( mean: ")+this.formatValue(this.nMeanA[nIndex],1)+this.szUnit+")";this.szFlag.match(/PERCENTOFMEDIAN/)&&(r=map.Dictionary.getLocalText(" ( median: ")+this.formatValue(this.nMedianA[nIndex],1)+this.szUnit+")");this.itemA[m].nValue=this.itemA[m].nValuesA[nIndex];this.itemA[m].szLabel=l;this.itemA[m].szColor=this.colorScheme[nIndex];this.itemA[m].nClass=nIndex;h=this.getItemNodes(m);
for(c=0;c<h.length;c++)g=this.paintShape(h[c],this.colorScheme[nIndex],this.itemA[m].nValue,nIndex),g.setAttributeNS(szMapNs,"tooltip",this.formatValue(b,2)+this.szUnit+l+r),this.szFlag.match(/DOPACITY/)&&(w=isNaN(this.itemA[m].nValuesA[nIndex])?0:this.itemA[m].nValuesA[nIndex],x=isNaN(this.nMaxA[nIndex])?0:this.nMaxA[nIndex],this.szAlphaField?(q=0,"undefined"!=typeof this.itemA[m].nAlpha&&(q=1/(this.nDopacityPow||1),q=(this.nDopacityScale||1)/Math.pow(this.nMaxAlpha,q)*Math.pow(this.itemA[m].nAlpha,
q))):this.szFlag.match(/DOPACITYLOGMEAN/)?q=Math.log((this.nDopacityScale||1)*(f-100))/Math.log(100):this.szFlag.match(/DOPACITYPOWMEAN/)?(q=1/(this.nDopacityPow||1),q=Math.pow((this.nDopacityScale||1)*(f-100),q)/Math.pow(100,q)):this.szFlag.match(/DOPACITYMEAN/)?(q=1/(this.nDopacityPow||1),q=Math.pow((this.nDopacityScale||1)*(f-100),q)/Math.pow(100,q)):this.szFlag.match(/DOPACITYLOGMAX/)?q=Math.log(w)/Math.log(x):this.szFlag.match(/DOPACITYPOWMAX/)?(q=1/(this.nDopacityPow||1),q=(this.nDopacityScale||
1)*Math.pow(w,q)/Math.pow(x,q)):this.szFlag.match(/DOPACITYMAX/)?(q=1/(this.nDopacityPow||1),q=(this.nDopacityScale||1)*Math.pow(w,q)/Math.pow(x,q)):q=Math.log((this.nDopacityScale||1)*w)/Math.log(x),q=1E-4>q?0:q,q=Math.min(this.nOpacity||.9,q),this.autoOpacity&&(q*=Math.max(.3,Math.min(1,.3+.7/Math.max(1,Math.log(map.Zoom.nZoom))))),g.style.setProperty("fill-opacity",String(q),""));this.partsA[nIndex].nCount++}else for(h=this.getItemNodes(m),c=0;c<h.length;c++)this.unPaintShape(h[c]),h[c].removeAttributeNS(szMapNs,
"tooltip")}else for(b=this.szFlag.match(/\bCLIP\b/)&&this.nClipFrames?this.nClipFrames==this.itemA[m].nValuesA.length?Number(this.itemA[m].nValuesA[this.nActualFrame]):this.itemA[m].nValuesA[0]*(this.nClipFrames-1-this.nActualFrame)/(this.nClipFrames-1)+this.itemA[m].nValuesA[1]*this.nActualFrame/(this.nClipFrames-1):this.itemA[m].nValuesA[0],l=0;l<this.partsA.length;l++)if(b<this.partsA[l].max){this.itemA[m].nValue=b;this.itemA[m].szColor=this.partsA[l].color;this.itemA[m].nClass=l;if(this.itemA[m].todo){h=
this.getItemNodes(m);for(c=0;c<h.length;c++)g=this.paintShape(h[c],this.partsA[l].color,b,l),this.szLabelA&&this.szLabelA[l]&&this.szFlag.match(/CATEGORICAL/)?g.setAttributeNS(szMapNs,"tooltip",this.szLabelA[l]):g.setAttributeNS(szMapNs,"tooltip",this.formatValue(b,2)+this.szUnit),this.szFlag.match(/DOPACITY/)&&(this.szAlphaField?(q=0,"undefined"!=typeof this.itemA[m].nAlpha&&(q=1/(this.nDopacityPow||1),q=(this.nDopacityScale||1)/Math.pow(this.nMaxAlpha,q)*Math.pow(this.itemA[m].nAlpha,q))):0>this.nMin&&
0<this.nMax?this.szFlag.match(/DOPACITYMAX/)?(q=1/(this.nDopacityPow||1),q=Math.pow(Math.abs(b),q)/Math.pow(this.nMedianA[0]-this.nMin,q)*(this.fillOpacity||1)*(this.nDopacityScale||1)):q=this.szFlag.match(/DOPACITYLOG/)?Math.log(Math.abs(b))/Math.log(this.nMedianA[0]-this.nMin)*.5*(this.fillOpacity||1)*(this.nDopacityScale||1):Math.abs(b)/(this.nMedianA[0]-this.nMin)*.5*(this.fillOpacity||1)*(this.nDopacityScale||1):this.szFlag.match(/BIPOLAR/)||this.szFlag.match(/DOPACITYMINMAX/)?this.szFlag.match(/DOPACITYMAX/)?
(q=1/(this.nDopacityPow||1),q=b>=this.nMeanA[0]?Math.pow(Math.abs(b-this.nMeanA[0]),q)/Math.pow(Math.abs(this.nMax-this.nMeanA[0]),q)*(this.fillOpacity||1)*(this.nDopacityScale||1):Math.pow(Math.abs(this.nMeanA[0]-b),q)/Math.pow(Math.abs(this.nMeanA[0]-this.nMin),q)*(this.fillOpacity||1)*(this.nDopacityScale||1)):this.szFlag.match(/DOPACITYLOG/)?q=b>=this.nMedianA[0]?Math.log(Math.abs(b-this.nMedianA[0]))/Math.log(this.nMax-this.nMedianA[0])*(this.fillOpacity||1)*(this.nDopacityScale||1):Math.log(Math.abs(b-
this.nMedianA[0]))/Math.log(this.nMedianA[0]-this.nMin)*(this.fillOpacity||1)*(this.nDopacityScale||1):(q=1/(this.nDopacityPow||1),q=b>=this.nMedianA[0]?Math.pow(Math.abs(b-this.nMedianA[0]),q)/Math.pow(this.nMax-this.nMedianA[0],q)*(this.fillOpacity||1)*(this.nDopacityScale||1):Math.pow(Math.abs(b-this.nMedianA[0]),q)/Math.pow(this.nMedianA[0]-this.nMin,q)*(this.fillOpacity||1)*(this.nDopacityScale||1)):this.szFlag.match(/DOPACITYMIN/)?(q=1/(this.nDopacityPow||1),q=Math.pow(this.nMax-b,q)/Math.pow(this.nMax-
this.nMin,q)*(this.fillOpacity||1)*(this.nDopacityScale||1)):this.szFlag.match(/DOPACITYMAX/)?(q=1/(this.nDopacityPow||1),q=Math.pow(b-this.nMin,q)/Math.pow(this.nMax-this.nMin,q)*(this.fillOpacity||1)*(this.nDopacityScale||1)):this.szFlag.match(/DOPACITYLOG/)?q=Math.log(b-this.nMin)/Math.log(this.nMedianA[0]-this.nMin)*.5*(this.fillOpacity||1)*(this.nDopacityScale||1):this.szFlag.match(/DOPACITY/)&&(q=(b-this.nMin)/(this.nMedianA[0]-this.nMin)*.5*(this.fillOpacity||1)*(this.nDopacityScale||1)),q=
1E-4>q?0:q,q=Math.min(this.nOpacity||.9,q),this.autoOpacity&&(q*=Math.max(.3,Math.min(1,.3+.7/Math.max(1,Math.log(map.Zoom.nZoom))))),g.style.setProperty("fill-opacity",String(q),""));this.itemA[m].todo=!1}this.partsA[l].nCount++;this.partsA[l].nSum+=b;k=!0;break}if(!k)for(this.itemA[m].szColor=this.szNoDataColor?this.szNoDataColor:"white",h=this.getItemNodes(m),c=0;c<h.length;c++)g=this.paintShape(h[c],this.szNoDataColor?this.szNoDataColor:"white",-1,-1),g.setAttributeNS(szMapNs,"tooltip","no value"),
this.szFlag.match(/DOPACITY/)&&g.style.setProperty("fill-opacity","0",""),this.nNoData++}this.isVisible=!0;this.realizeDone();this.fShowProgressBar=!1;this.showInfo();this.endDraw();this.szItemFilter&&this.szItemFilter.length&&this.filterItems(this.szItemFilter,this.itemFilterOpt);this.szFlag.match(/\bCLIP\b/)?this.nClipFrames==this.itemA[m].nValuesA.length?this.szXaxisA&&this.szXaxisA[this.nActualFrame]?displayMessage(this.szXaxisA[this.nActualFrame],3E3,"big"):this.szLabelA&&this.szLabelA[this.nActualFrame]&&
displayMessage(this.szLabelA[this.nActualFrame],3E3,"big"):(f=this.szXaxisA||this.szLabelA)&&(0==this.nActualFrame?displayMessage(f[0],3E3,"big"):this.nActualFrame==this.nClipFrames-1?displayMessage(f[1],3E3,"big"):displayMessage(" ... ",3E3,"big")):this.ErrorMessage?(displayMessage(this.ErrorMessage,1E4,"notify"),this.ErrorMessage=null):clearMessage();this.szFlag.match(/VALUES/)&&(!this.szValueUpper||map.Scale.nTrueMapScale*map.Scale.nZoomScale<=this.nValueUpper)?(this.mapSleep&&this.mapSleep.initCheckSleep(25),
this.fContinue=this.fMakeLabel=!0,this.nActualFrame=this.nMissingPositionCount=this.nMissingRangeCount=this.nZeroValueCount=this.nRealizedCount=this.nSkipCount=this.nDoneCount=this.continueIndex=0,setTimeout("map.Themes.executeContinue()",250)):this.unlabelMap()};
MapTheme.prototype.unpaintMap=function(){if(this.szFlag.match(/CHART/)){if(this.chartGroup){if(0==this.chartGroup.childNodes.length&&this.itemA){var e=null;for(a in this.itemA)(e=SVGDocument.getElementById(this.szId+":"+a+":chartgroup"))&&e.parentNode.removeChild(e)}map.Dom.clearGroup(this.chartGroup)}}else{this.beginDraw();for(e=0;e<this.paintedShapeNodesA.length;e++)this.unPaintShape(this.paintedShapeNodesA[e]),this.paintedShapeNodesA[e].removeAttributeNS(szMapNs,"tooltip");this.paintedShapeNodesA.length=
0;this.unlabelMap();this.endDraw();this.isVisible=!1;this.checkVisible();setTimeout("map.Layer.adaptLabel(null)",10)}};
MapTheme.prototype.paintShape=function(e,b,f,c){this.paintedShapeNodesA.push(e);switch(this.szShapeType){case "line":e.setAttributeNS(null,"style","stroke:"+b+";"+this.szStyle);break;case "line+buffer":var h=e.getAttributeNS(null,"id");if(!h.match(":paint")){var g=SVGDocument.getElementById(h+":paint");g||(g=e.cloneNode(1E3),e.parentNode.insertBefore(g,e),g.setAttributeNS(null,"id",h+":paint"));e=g}h=4;if(this.nBufferSize)if(this.nBufferSize.match(/\$value\$/)){f=this.nBufferSize.split("$value$");
h="";for(g=0;g<f.length;g++)h+=f[g],g<f.length-1&&(h+="nValue");h=eval(h)}else h=this.nBufferSize.match(/value/)?1E3<100/(this.nMin+1E-9)*(this.nMax-this.nMin)?6+Math.log(f/this.nMax):10*f/(this.nMax-this.nMin):this.nBufferSize;h*=Math.log(1+1/__featureScaling_lastScale);e.setAttributeNS(null,"style","stroke:"+b+";stroke-width:"+map.Scale.normalX(h)*map.Scale.nZoomScale+";"+this.szStyle+";stroke-linecap:butt;");break;default:e.setAttributeNS(null,"style","fill:"+b+";"+this.szStyle)}e.setAttributeNS(szMapNs,
"class",c);return e};MapTheme.prototype.unPaintShape=function(e){if("line+buffer"==this.szShapeType){var b=e.getAttributeNS(null,"id");(b=SVGDocument.getElementById(b+":paint"))&&b.parentNode.removeChild(b)}e.removeAttributeNS(null,"style");e.removeAttributeNS(szMapNs,"class")};
MapTheme.prototype.zoomToClass=function(e,b){var f=0;if(this.szFlag.match(/DOMINANT/))for(a in this.itemA)this.itemA[a].nClass==e&&f++;else f=this.partsA[e].nCount;if(0==f)displayMessage("No members !");else{var c=null;if(this.szFlag.match(/CHART/))for(var h=this.chartGroup.childNodes,f=0;f<h.length;f++){var g=h.item(f);if(null==g.getAttributeNS(szMapNs,"class")||""==g.getAttributeNS(szMapNs,"class"))for(var g=g.firstChild.childNodes,q=0;q<g.length;q++)g.item(q).getAttributeNS(szMapNs,"class");else g.getAttributeNS(szMapNs,
"class")}else if(this.szFlag.match(/DOMINANT/))for(a in this.itemA)if(this.itemA[a].nClass==e&&"highlight"==this.evidenceMode)for(c=this.getItemNodes(a),f=0;f<c.length;f++);else{if(this.itemA[a].nClass!=e&&"highlight"!=this.evidenceMode)for(c=this.getItemNodes(a),f=0;f<c.length;f++);}else{for(var h=new point(1E5,1E5),g=new point(-1E5,-1E5),q=this.partsA[e].min,l=this.partsA[e].max,f=1;f<b;f++)q=Math.min(q,this.partsA[e+f].min),l=Math.max(l,this.partsA[e+f].max);this.szFlag.match(/CATEGORICAL/)&&(q++,
l++);for(a in this.itemA)if(this.itemA[a].nValuesA[0]>q&&this.itemA[a].nValuesA[0]<l)for(c=this.getItemNodes(a),f=0;f<c.length;f++){bBox=map.Dom.getBox(c[f]);if(0==bBox.width||0==bBox.height){var r=getMatrix(c[f]);bBox.x+=r[4];bBox.y+=r[5];bBox.width=map.Scale.viewBox.width/20;bBox.height=map.Scale.viewBox.height/20;bBox.x-=bBox.width/2;bBox.y-=bBox.height/2}r=map.Scale.getMapOffset(c[f]);bBox.x+=r.x;bBox.y+=r.y;h.x=Math.min(h.x,bBox.x);h.y=Math.min(h.y,bBox.y);g.x=Math.max(g.x,bBox.x+bBox.width);
g.y=Math.max(g.y,bBox.y+bBox.height)}f=new box(h.x,h.y,g.x-h.x,g.y-h.y);f.scale(1.2);f=map.Zoom.clipArea(f);map.Zoom.setNewArea(f)}}};
MapTheme.prototype.markClass=function(e,b){if(0!=this.fMarkEnable)if(map.Themes.enableSubThemes&&this.szFlag.match(/DOMINANT|COMPOSE/)&&!this.szFlag.match(/CHART/))this.createSubTheme(e);else if(isNaN(e))displayMessage("no class!");else{var f=this.szItemFilter&&this.szItemFilter.length;if(!this.szFlag.match(/CHART/)||f)this.fUnmarkEnable=!0,this.unmarkClass(),this.fUnmarkEnable=!1;if(0!=this.fMarkEnable){var c=0;if(this.szFlag.match(/DOMINANT/)&&!this.szFlag.match(/CHART/))for(a in this.itemA)this.itemA[a].nClass==
e&&c++;else c=1==this.partsA.length&&this.szFlag.match(/DOPACITY/)?99:this.partsA[e].nCount;if(500<c&&"highlight"==this.evidenceMode)displayMessage("Sorry ! to many members");else if(0==c)displayMessage("No members !");else{clearMessage();highLightList.removeAll();var c=null,h=(this.fShadow?5:10)/this.nScale;if(this.szFlag.match(/CHART/)){for(var g=this.chartGroup.childNodes,q=[],c=0;c<g.length;c++){var l=g.item(c);if(null==l.getAttributeNS(szMapNs,"class")||""==l.getAttributeNS(szMapNs,"class"))for(var r=
l.getElementsByTagName("g"),k=0;k<r.length;k++)for(var w=r.item(k).childNodes,m=0;m<w.length;m++){var x=w.item(m);if(x.getAttributeNS&&x.getAttributeNS(szMapNs,"class")){if(this.szFlag.match(/SEQUENCE/)&&!this.szFlag.match(/PLOT/)&&"isolate_gray"!=this.evidenceMode){var v=x.getAttributeNS(null,"transform");v&&v.length&&(x.setAttributeNS(szMapNs,"orig-transform",v),x.setAttributeNS(null,"transform",""))}v=Number(x.getAttributeNS(szMapNs,"class"));this.szFlag.match(/BAR/)&&this.szFlag.match(/3D/)&&
!this.szFlag.match(/STACKED/)&&(1<this.szFieldsA.length||this.szFlag.match(/AGGREGATE/)&&this.szFlag.match(/CATEGORICAL/))?1==this.markedClasses[v]?(x.setAttributeNS(null,"transform","matrix(1 0 0 1 -10 6.6)"),x.style.setProperty("fill-opacity","1","")):(x.setAttributeNS(null,"transform","matrix(1 0 0 1 0 0)"),x.style.setProperty("fill-opacity","0.85","")):1==this.markedClasses[v]?f||(x.style.setProperty("display","inline",""),x.getAttributeNS(szMapNs,"save-style")&&x.setAttributeNS(null,"style",
x.getAttributeNS(szMapNs,"save-style")),q.push(l)):"isolate_gray"==this.evidenceMode?(x.getAttributeNS(szMapNs,"save-style")||x.setAttributeNS(szMapNs,"save-style",x.getAttributeNS(null,"style")),x.style.setProperty("fill","#bbbbbb",""),"none"!=x.style.getPropertyValue("stroke")&&x.style.setProperty("stroke","#888888",""),v=x.style.getPropertyValue("fill-opacity"),this.szFlag.match(/SEQUENCE/)||this.szFlag.match(/WAFFLE/)?(x.style.setProperty("fill-opacity","0",""),x.style.setProperty("stroke-opacity",
String(.9*v),""),x.style.setProperty("stroke-width",String(h),"")):x.style.setProperty("fill-opacity","0","")):x.style.setProperty("display","none","")}}else v=Number(l.getAttributeNS(szMapNs,"class")),1==this.markedClasses[v]?f||(this.szFlag.match(/VECTOR/)?(l.firstChild.style.setProperty("stroke","",""),l.firstChild.style.setProperty("stroke-opacity","",""),l.firstChild.style.setProperty("marker-end","",""),l.style.setProperty("display","inline","")):(l.style.setProperty("display","inline",""),
(v=l.getAttributeNS(szMapNs,"fill"))&&l.style.setProperty("fill",v,"")),q.push(l)):"isolate_gray"==this.evidenceMode?this.szFlag.match(/VECTOR/)?(l.firstChild.style.setProperty("stroke","#888888",""),l.firstChild.style.setProperty("stroke-opacity","0.5",""),l.firstChild.style.setProperty("marker-end","none","")):(l.setAttributeNS(szMapNs,"fill",l.style.getPropertyValue("fill")),l.style.setProperty("fill","#bbbbbb",""),l.setAttributeNS(szMapNs,"stroke",l.style.getPropertyValue("fill")),l.style.setProperty("stroke",
"#888888",""),l.setAttributeNS(szMapNs,"fill-opacity",l.style.getPropertyValue("fill-opacity")),l.style.setProperty("fill-opacity","0.05","")):l.style.setProperty("display","none","")}q.forEach(function(b){b.parentNode.appendChild(b)})}else{this.beginDraw();if(this.szFlag.match(/DOMINANT/))for(a in this.itemA)if(this.itemA[a].nClass==e&&"highlight"==this.evidenceMode)for(c=this.getItemNodes(a),f=0;f<c.length;f++)highLightList.addItem(c[f]);else{if(this.itemA[a].nClass!=e&&"highlight"!=this.evidenceMode)for(c=
this.getItemNodes(a),f=0;f<c.length;f++)c[f].setAttributeNS(szMapNs,"themestyle",c[f].getAttributeNS(null,"style")),c[f].style.setProperty("display","none","")}else{f=this.partsA[e].min;h=this.partsA[e].max;for(c=1;c<b;c++)f=Math.min(f,this.partsA[e+c].min),h=Math.max(h,this.partsA[e+c].max);for(a in this.itemA)if(f=!1,this.markedClasses&&this.markedClasses[this.itemA[a].nClass]&&(f=!0),f){if("highlight"==this.evidenceMode)for(c=this.getItemNodes(a),f=0;f<c.length;f++)highLightList.addItem(c[f])}else if("highlight"!=
this.evidenceMode)for(c=this.getItemNodes(a),f=0;f<c.length;f++)if(this.szFlag.match(/BUFFER/))(h=SVGDocument.getElementById(c[f].getAttributeNS(null,"id")+":paint"))&&h.style.setProperty("display","none","");else{c[f].setAttributeNS(szMapNs,"themestyle",c[f].getAttributeNS(null,"style"));c[f].setAttributeNS(null,"style",c[f].getAttributeNS(szMapNs,"origthemestyle"));g=c[f].firstChild.nextSibling.getAttribute("id")||c[f].getAttribute("id");if(h=SVGDocument.getElementById(g+"L"))h.setAttributeNS(szMapNs,
"display",h.style.getPropertyValue("display")),h.style.setProperty("display","none","");if(h=SVGDocument.getElementById(g+"L:bg"))h.setAttributeNS(szMapNs,"display",h.style.getPropertyValue("display")),h.style.setProperty("display","none","");if(h=SVGDocument.getElementById(g+":::value"))h.setAttributeNS(szMapNs,"display",h.style.getPropertyValue("display")),h.style.setProperty("display","none","");if(h=SVGDocument.getElementById(g+":::value:bg"))h.setAttributeNS(szMapNs,"display",h.style.getPropertyValue("display")),
h.style.setProperty("display","none","")}}this.endDraw();this.fMarkClass=!0}}}}};
MapTheme.prototype.unmarkClass=function(e){if(0!=this.fUnmarkEnable)if(this.subTheme)this.removeSubTheme();else if(this.szItemFilter&&this.szItemFilter.length)this.fMarkEnable=!0,this.filterItems(this.szItemFilter,this.itemFilterOpt);else if(clearMessage(),this.szFlag.match(/CHART/)){e=this.chartGroup.childNodes;for(var b=0;b<e.length;b++){var f=e.item(b);if(null==f.getAttributeNS(szMapNs,"class")||""==f.getAttributeNS(szMapNs,"class"))for(var f=f.getElementsByTagName("g"),c=0;c<f.length;c++)for(var h=
f.item(c).childNodes,g=0;g<h.length;g++){var q=h.item(g);if(q.getAttributeNS&&q.getAttributeNS(szMapNs,"class")){if(this.szFlag.match(/SEQUENCE/)){var l=q.getAttributeNS(szMapNs,"orig-transform");l&&l.length&&(q.removeAttributeNS(szMapNs,"orig-transform"),q.setAttributeNS(null,"transform",l))}this.szFlag.match(/BAR/)&&this.szFlag.match(/3D/)&&!this.szFlag.match(/STACKED/)&&(q.setAttributeNS(null,"transform","matrix(1 0 0 1 0 0)"),q.style.setProperty("fill-opacity","1",""));q.style&&(q.style.setProperty("display",
"inline",""),q.getAttributeNS(szMapNs,"save-style")&&q.setAttributeNS(null,"style",q.getAttributeNS(szMapNs,"save-style")))}}else this.szFlag.match(/VECTOR/)&&(f.firstChild.style.setProperty("stroke","",""),f.firstChild.style.setProperty("stroke-opacity","",""),f.firstChild.style.setProperty("marker-end","","")),f.style.setProperty("display","inline","")}this.szFlag.match(/TEXTONLY/)&&setTimeout("map.Layer.adaptLabel()",10)}else{this.beginDraw();if("highlight"!=this.evidenceMode)for(a in this.itemA)for(e=
this.getItemNodes(a),b=0;b<e.length;b++)this.szFlag.match(/BUFFER/)?(f=SVGDocument.getElementById(e[b].getAttributeNS(null,"id")+":paint"))&&f.style.setProperty("display","inline",""):(f=e[b].getAttributeNS(szMapNs,"themestyle"))&&f.length&&"null"!=f&&(e[b].setAttributeNS(null,"style",f),e[b].removeAttributeNS(szMapNs,"themestyle"),c=e[b].firstChild.nextSibling.getAttribute("id")||e[b].getAttribute("id"),(f=SVGDocument.getElementById(c+"L"))&&f.style.setProperty("display",f.getAttributeNS(szMapNs,
"display"),""),(f=SVGDocument.getElementById(c+"L:bg"))&&f.style.setProperty("display",f.getAttributeNS(szMapNs,"display"),""),(f=SVGDocument.getElementById(c+":::value"))&&f.style.setProperty("display",f.getAttributeNS(szMapNs,"display"),""),(f=SVGDocument.getElementById(c+":::value:bg"))&&f.style.setProperty("display",f.getAttributeNS(szMapNs,"display"),""));else highLightList.removeAll();this.endDraw();this.fMarkClass=!1}};
MapTheme.prototype.showClass=function(e,b,f){var c=0;if(this.szFlag.match(/DOMINANT/))for(a in this.itemA)this.itemA[a].nClass==e&&c++;clearMessage();var h=null,c=f?"inline":"none";if(this.szFlag.match(/CHART/))for(f=this.chartGroup.childNodes,h=0;h<f.length;h++){var g=f.item(h);if(null==g.getAttributeNS(szMapNs,"class")||""==g.getAttributeNS(szMapNs,"class"))for(g=g.firstChild.childNodes,b=0;b<g.length;b++){var q=g.item(b),l=Number(q.getAttributeNS(szMapNs,"class"));l==e&&q.style.setProperty("display",
c,"")}else l=Number(g.getAttributeNS(szMapNs,"class")),l==e&&g.style.setProperty("display",c,"")}else{this.beginDraw();if(this.szFlag.match(/DOMINANT/))for(a in this.itemA){if(this.itemA[a].nClass==e)for(h=this.getItemNodes(a),b=0;b<h.length;b++)h[b].setAttributeNS(szMapNs,"themestyle",h[b].getAttributeNS(null,"style")),h[b].style.setProperty("display",c,"")}else{l=this.partsA[e].min;g=this.partsA[e].max;for(h=1;h<b;h++)l=Math.min(l,this.partsA[e+h].min),g=Math.max(g,this.partsA[e+h].max);this.szFlag.match(/CATEGORICAL/)&&
(l++,g++);for(a in this.itemA)if(this.szFlag.match(/CATEGORICAL/)&&this.itemA[a].nValuesA[0]==l||this.itemA[a].nValuesA[0]>l&&this.itemA[a].nValuesA[0]<g)for(h=this.getItemNodes(a),b=0;b<h.length;b++)this.szFlag.match(/BUFFER/)?(e=SVGDocument.getElementById(h[b].getAttributeNS(null,"id")+":paint"))&&e.style.setProperty("display",c,""):f?(e=h[b].getAttributeNS(szMapNs,"themestyle"))&&e.length&&"null"!=e&&(h[b].setAttributeNS(null,"style",e),h[b].removeAttributeNS(szMapNs,"themestyle")):(h[b].setAttributeNS(szMapNs,
"themestyle",h[b].getAttributeNS(null,"style")),h[b].setAttributeNS(null,"style",h[b].getAttributeNS(szMapNs,"origthemestyle")))}this.endDraw()}};
MapTheme.prototype.setTimeFrame=function(e,b){clearMessage();highLightList.removeAll();var f=this.szItemFilter&&this.szItemFilter.length,c=(this.fShadow?5:10)/this.nScale;if(this.szFlag.match(/CHART/)){for(var h=this.chartGroup.childNodes,g=[],q=0;q<h.length;q++){var l=h.item(q);if(null==l.getAttributeNS(szMapNs,"time")||""==l.getAttributeNS(szMapNs,"time"))for(var r=l.getElementsByTagName("g"),k=0;k<r.length;k++)for(var w=r.item(k).childNodes,m=0;m<w.length;m++){var x=w.item(m);if(x.getAttributeNS&&
x.getAttributeNS(szMapNs,"time")){var v=Number(x.getAttributeNS(szMapNs,"time"));if(this.szFlag.match(/BAR/)&&this.szFlag.match(/3D/)&&!this.szFlag.match(/STACKED/)&&(1<this.szFieldsA.length||this.szFlag.match(/AGGREGATE/)&&this.szFlag.match(/CATEGORICAL/)))v>=e&&v<=b?(x.setAttributeNS(null,"transform","matrix(1 0 0 1 -10 6.6)"),x.style.setProperty("fill-opacity","1","")):(x.setAttributeNS(null,"transform","matrix(1 0 0 1 0 0)"),x.style.setProperty("fill-opacity","0.85",""));else if(v>=e&&v<=b)f||
(x.style.setProperty("display","inline",""),x.getAttributeNS(szMapNs,"save-style")&&x.setAttributeNS(null,"style",x.getAttributeNS(szMapNs,"save-style")),g.push(l));else if("isolate_gray"==this.evidenceMode){x.getAttributeNS(szMapNs,"save-style")||x.setAttributeNS(szMapNs,"save-style",x.getAttributeNS(null,"style"));x.style.setProperty("fill","#bbbbbb","");"none"!=x.style.getPropertyValue("stroke")&&x.style.setProperty("stroke","#888888","");var z=x.style.getPropertyValue("fill-opacity");this.szFlag.match(/SEQUENCE/)||
this.szFlag.match(/WAFFLE/)?(x.style.setProperty("fill-opacity","0",""),x.style.setProperty("stroke-opacity",String(.9*z),""),x.style.setProperty("stroke-width",String(c),"")):x.style.setProperty("fill-opacity","0","")}else x.style.setProperty("display","none","")}}else r=Number(l.getAttributeNS(szMapNs,"time")),v>=e&&v<=b?f||(this.szFlag.match(/VECTOR/)?(l.firstChild.style.setProperty("stroke","",""),l.firstChild.style.setProperty("stroke-opacity","",""),l.firstChild.style.setProperty("marker-end",
"",""),l.style.setProperty("display","inline","")):(l.style.setProperty("display","inline",""),(r=l.getAttributeNS(szMapNs,"fill"))&&l.style.setProperty("fill",r,"")),g.push(l)):"isolate_gray"==this.evidenceMode?this.szFlag.match(/VECTOR/)?(l.firstChild.style.setProperty("stroke","#888888",""),l.firstChild.style.setProperty("stroke-opacity","0.5",""),l.firstChild.style.setProperty("marker-end","none","")):(l.setAttributeNS(szMapNs,"fill",l.style.getPropertyValue("fill")),l.style.setProperty("fill",
"#bbbbbb",""),l.setAttributeNS(szMapNs,"stroke",l.style.getPropertyValue("fill")),l.style.setProperty("stroke","#888888",""),l.setAttributeNS(szMapNs,"fill-opacity",l.style.getPropertyValue("fill-opacity")),l.style.setProperty("fill-opacity","0.05","")):l.style.setProperty("display","none","")}g.forEach(function(b){b.parentNode.appendChild(b)})}};
MapTheme.prototype.createSubTheme=function(e){this.subTheme&&this.removeSubTheme();var b="";this.coTable&&"undefined"!=typeof this.coTable&&(b+="dbtable:"+this.coTable+";");this.szSelectionField&&"undefined"!=typeof this.szSelectionField&&(b+="lookupfield:"+this.szSelectionField+";");this.szAlphaField&&"undefined"!=typeof this.szAlphaField&&(b+="alphafield:"+this.szAlphaField+";");this.szAlphaField100&&"undefined"!=typeof this.szAlphaField100&&(b+="alphafield100:"+this.szAlphaField100+";");this.nDopacityScale&&
"undefined"!=typeof this.nDopacityScale&&(b+="dopacityscale:"+this.nDopacityScale+";");this.nDopacityPow&&"undefined"!=typeof this.nDopacityPow&&(b+="dopacitypow:"+this.nDopacityPow+";");var f="lookuptoupper:"+(this.fSelectionFieldToUpper||null)+";",f=f+("lookupsuffix:"+(this.szSelectionFieldSuffix||null)+";"),f=f+("lookupprefix:"+(this.szSelectionFieldPrefix||null)+";"),f=f+("lookupdigits:"+(Number(this.nSelectionFieldDigits)||null)+";"),f=f+("lookuptonumber:"+(this.fSelectionFieldToNumber||null)+
";"),f=f+("lookuptoupper:"+(this.fSelectionFieldToUpper||null)+";"),b=b+f;this.szAggregationField&&"undefined"!=typeof this.szAggregationField&&(b+="aggregationfield:"+this.szAggregationField+";");this.szUnits&&"undefined"!=typeof this.szUnits&&(b+="units:"+this.szUnits+";");var c="";this.szFlag.match(/DOPACITY/)&&(c+="DOPACITYMAX|");this.szFlag.match(/AGGREGATE/)&&(c+="AGGREGATE|");this.szFlag.match(/GROUP/)&&(c+="GROUP|");this.szFlag.match(/SUM/)&&(c+="SUM|");this.szFlag.match(/ZEROISVALUE/)&&(c+=
"ZEROISVALUE|");this.szFlag.match(/VALUES/)&&(c+="VALUES|");map.Themes.enableMultiChoropleth=!0;if(this.szFlag.match(/CATEGORICAL/)&&this.szFlag.match(/AGGREGATE/)&&this.szLabelA){var f=[],h=[];for(i=0;i<this.markedClassesA.length;i++)f.push(this.szLabelA[this.markedClassesA[i]]),h.push(this.colorScheme[this.markedClassesA[i]]);this.markedClassesA&&1<this.markedClassesA.length?(e=this.getDefinitionObject(),e.style.type+="|NOINFO",e.style.values=f,e.style.colorscheme=h,this.subTheme=map.Themes.newThemeByObj(e)):
(b+='filter:WHERE "'+this.szFields+'" IN "('+f.join(",")+')";',this.subTheme=map.Themes.newTheme(this.szThemes,this.szFields,this.szField100,"type:CHOROPLETH|CATEGORICAL|NOINFO|NOLEGEND|SUBTHEME|"+c+";colorscheme:7|white|"+this.colorScheme[e]+";"+b,this.szLabelA[e],""))}else if(this.markedClassesA&&1<this.markedClassesA.length){f=this.szFields.split("|");c=h="";for(i=0;i<this.markedClassesA.length;i++)h+=(h.length?"|":"")+f[this.markedClassesA[i]],c+=(c.length?"|":"")+this.colorScheme[this.markedClassesA[i]];
this.subTheme=map.Themes.newTheme(this.szThemes,h,this.szField100,"type:"+this.szFlag+"|NOINFO;colorscheme:"+c+";"+b,this.szLabelA?this.szLabelA[e]:"","")}else e=this.markedClassesA[0]||e,this.subTheme=map.Themes.newTheme(this.szThemes,this.szFields.split("|")[e],this.szField100,"type:CHOROPLETH|QUANTILE|NOINFO|NOLEGEND|SUBTHEME|"+c+";colorscheme:7|white|"+this.colorScheme[e]+";"+b,this.szLabelA?this.szLabelA[e]:"","");map.Themes.subTheme=this};
MapTheme.prototype.removeSubTheme=function(){map.Themes.enableMultiChoropleth=!1;this.subTheme&&(map.Themes.subTheme=!1,map.Themes.removeTheme(null,this.subTheme.szId),this.subTheme=null,map.Themes.realizeDone(this))};
MapTheme.prototype.isItemInFilter=function(e,b,f,c){if(0==f.length&&("undefined"==typeof c||!c.field))return!0;if("undefined"!=typeof b.dbIndex||"undefined"!=typeof b.dbIndexA)if(b=b.dbIndex||b.dbIndexA[0],f.length){if(this.__szValue=e.dbRecords[b].join(" "),eval("this.__szValue.match(/"+f.replace(/\//gi,"\\/")+"/i)"))return!0}else if(c&&c.field){for(f=0;f<e.dbFields.length;f++)if(e.dbFields[f].id==c.field&&(c.min&&e.dbRecords[b][f]<c.min||c.max&&e.dbRecords[b][f]>c.max||c.txt&&e.dbRecords[b][f]!=
c.txt))return!1;return!0}return!1};
MapTheme.prototype.filterItems=function(e,b){if(0!=this.fMarkEnable){this.szItemFilter=e;this.itemFilterOpt=b;this.filterNodesA=e.length||b&&b.field?[]:null;for(var f=null,c=0;c<this.szThemesA.length&&(!(f=this.objThemesA[this.szThemesA[c]])||!f.dbRecords);c++);if(f&&f.dbRecords){if(this.szFlag.match(/CHART/))for(var h=this.chartGroup.childNodes,c=0;c<h.length;c++){var g=[],q=h.item(c);g.push(q);for(var l=0;l<g.length;l++)szId=g[l].getAttributeNS(null,"id"),szId=szId.split(":")[1]+"::"+szId.split(":")[3],
this.itemA[szId]?this.isItemInFilter(f,this.itemA[szId],e,b)?(q.style.setProperty("display","inline",""),this.filterNodesA&&this.filterNodesA.push(szId)):q.style.setProperty("display","none",""):q.style.setProperty("display","inline","")}else{this.beginDraw();for(a in this.itemA)if(this.itemA[a]&&"undefined"!=typeof this.itemA[a].dbIndex)if(this.isItemInFilter(f,this.itemA[a],e,b))for(this.filterNodesA&&this.filterNodesA.push(a),tilesNodesA=this.getItemNodes(a),j=0;j<tilesNodesA.length;j++)this.szFlag.match(/BUFFER/)?
(c=SVGDocument.getElementById(tilesNodesA[j].getAttributeNS(null,"id")+":paint"))&&c.style.setProperty("display","inline",""):(c=tilesNodesA[j].getAttributeNS(szMapNs,"themestyle"))&&c.length&&"null"!=c&&(tilesNodesA[j].setAttributeNS(null,"style",c),tilesNodesA[j].removeAttributeNS(szMapNs,"themestyle"),(c=SVGDocument.getElementById(tilesNodesA[j].firstChild.nextSibling.getAttribute("id")+"L"))&&c.style.setProperty("display",c.getAttributeNS(szMapNs,"display"),""),(c=SVGDocument.getElementById(tilesNodesA[j].firstChild.nextSibling.getAttribute("id")+
"L:bg"))&&c.style.setProperty("display",c.getAttributeNS(szMapNs,"display"),""));else for(tilesNodesA=this.getItemNodes(a),j=0;j<tilesNodesA.length;j++)if(this.szFlag.match(/BUFFER/))(c=SVGDocument.getElementById(tilesNodesA[j].getAttributeNS(null,"id")+":paint"))&&c.style.setProperty("display","none","");else{tilesNodesA[j].getAttributeNS(szMapNs,"themestyle")||tilesNodesA[j].setAttributeNS(szMapNs,"themestyle",tilesNodesA[j].getAttributeNS(null,"style"));tilesNodesA[j].setAttributeNS(null,"style",
tilesNodesA[j].getAttributeNS(szMapNs,"origthemestyle"));if(c=SVGDocument.getElementById(tilesNodesA[j].firstChild.nextSibling.getAttribute("id")+"L"))c.setAttributeNS(szMapNs,"display",c.style.getPropertyValue("display")),c.style.setProperty("display","none","");if(c=SVGDocument.getElementById(tilesNodesA[j].firstChild.nextSibling.getAttribute("id")+"L:bg"))c.setAttributeNS(szMapNs,"display",c.style.getPropertyValue("display")),c.style.setProperty("display","none","")}this.endDraw()}this.fMarkClass=
!0}}};MapTheme.prototype.selectFilterItems=function(){map.Selections.newSelection("generic",this.filterNodesA,"type:queryresult",this.szItemFilter)};
MapTheme.prototype.highlightItems=function(e,b){if(""==e)this.clearHighlightItems();else{highLightList.removeAll();var f=e.split(b||",");__this=this;f.forEach(function(b){if(__this.szFlag.match(/CHART/)){var e=SVGDocument.getElementById(__this.szId+":"+b+":chartgroup");e||(b=__this.szThemesA[0]+"::"+b,e=SVGDocument.getElementById(__this.szId+":"+b+":chartgroup"));highLightList.addItem(e.parentNode,"isolate");map.displayInfo(null,e.firstChild,"add|fix")}else{tilesNodesA=__this.getItemNodes(b);for(j=
0;j<tilesNodesA.length;j++)highLightList.addItem(tilesNodesA[j]);map.displayInfo(null,tilesNodesA[0].firstChild.nextSibling,"add|fix")}})}};MapTheme.prototype.clearHighlightItems=function(){highLightList.removeAll();map.removeInfo()};
MapTheme.prototype.labelMap=function(e){var b=map.Zoom.getBox(),f=null;this.szValuesTextStyle="font-family:verdana;font-size:"+map.Scale.normalX(11)+"px;pointer-events:none";if(!e||0==e){var c=0;e=0;this.indexA=[];var h=0,g=0;if(this.fClipCharts)for(c in this.itemA){if(g++,this.itemA[c].nValuesA&&0<this.itemA[c].nValuesA.length&&(f=this.getNodePosition(this.itemA[c].szSelectionId)))if(f.x<b.x||f.x>b.x+b.width||f.y<b.y||f.y>b.y+b.height){if(this.nSkipCount++,chartGroup=SVGDocument.getElementById(this.szId+
":"+c+":chart"))chartGroup.parentNode.removeChild(chartGroup),this.chartPosA[this.itemA[c].szSelectionId]=null,this.posItemA[this.itemA[c].szSelectionId]=null}else this.indexA[this.indexA.length]=c,h++}else for(c in this.itemA)this.indexA[this.indexA.length]=c,g++,h++;h>this.nMaxThemeCharts&&(this.indexA.length=0,this.nSkipCount=h);this.mapSleep&&(this.mapSleep.nCount=h);this.fEnableProgressBar=!1}for(;e<this.indexA.length;e++){if(this.fCancel){displayMessage("Canceled by user",1E3,!0);this.fCancel=
!1;return}if(this.mapSleep&&(this.mapSleep.nDoneCount=this.nDoneCount,this.mapSleep.checkSleep(e,10))){this.fContinue=!0;this.continueIndex=e;return}c=this.indexA[e];this.nDoneCount++;if(this.itemA[c].nValuesA&&0<this.itemA[c].nValuesA.length)if(f=this.getNodePosition(this.itemA[c].szSelectionId))if(this.fClipCharts&&!this.szFlag.match(/BUFFER/)&&(f.x<b.x||f.x>b.x+b.width||f.y<b.y||f.y>b.y+b.height))this.nSkipCount++;else for(f=this.getItemNodes(c),j=0;j<f.length;j++)this.labelShape(f[j],this.itemA[c].szColor,
this.itemA[c].szLabel?this.itemA[c].szLabel:this.itemA[c].nValue);else this.nMissingPositionCount++}this.fMakeLabel=!1;setTimeout("map.Layer.adaptLabel(null)",10)};MapTheme.prototype.unlabelMap=function(){for(a in map.Layer.generatedLabelA)map.Dom.removeElementById(a),map.Layer.generatedLabelA[a]=null};
MapTheme.prototype.labelShape=function(e,b,f){if(this.szFlag.match(/VALUES/)&&"undefined"!=f&&"undefined"!=typeof f&&(!this.szFlag.match(/NOZERO/)||0!=f)){var c=e.parentNode.getAttributeNS(null,"id"),h=SVGDocument.getElementById(c+":label");if(h){var g=SVGDocument.getElementById(c+":values:bg");g||(g=map.Dom.newGroup(h.parentNode,c+":values:bg"),map.Layer.generatedLabelA[c+":values:bg"]=g);var q=SVGDocument.getElementById(c+":values");q||(q=map.Dom.newGroup(h.parentNode,c+":values"),map.Layer.generatedLabelA[c+
":values"]=q);try{var l=e.firstChild.nextSibling.getAttributeNS(null,"id").split("#"),r=l[0]+"L"+(l[1]?"#"+l[1]:"")}catch(k){r=e.getAttributeNS(null,"id")+":::value"}if(!SVGDocument.getElementById(r)){h=__maptheme_getChartColors(b);b="string"==typeof f?f:this.formatValue(f,this.szValueDecimals||0)+(this.szUnit.match(/\%/)?"%":"");var c="#ffffff",c=this.szTextColor||h.highColor,l=h.lowColor,w=1,h=Math.max(.3,e.style.getPropertyValue("fill-opacity")||"1");this.szFlag.match(/DTEXT/)&&(w=Math.max(.7,
Math.min(1.5,2/Math.sqrt(this.nMax)*Math.sqrt(f))));f=map.Scale.normalX(11)*map.Scale.nZoomScale*w*map.Scale.nLabelScaling*(this.nLabelScale||1);g=map.Dom.newText(g,0,0,"font-family:verdana;font-weight:normal;font-size:"+f+"px;text-anchor:middle;fill:none;stroke:"+l+";stroke-width:"+map.Scale.normalX(4)*map.Scale.nZoomScale+";stroke-opacity:0.5;pointer-events:none;display:none;stroke-linejoin:bevel;",b);q=map.Dom.newText(q,0,0,"font-family:verdana;font-weight:normal;font-size:"+f+"px;text-anchor:middle;fill:"+
c+";stroke:none;pointer-events:none;display:none;",b);q.setAttributeNS(null,"id",r);g.setAttributeNS(null,"id",r+":bg");this.szFlag.match(/DOPACITY/)&&(q.style.setProperty("fill-opacity",h,""),g.style.setProperty("stroke-opacity",h,""));(r=e.getAttributeNS(szMapNs,"center"))?(e=r.split(","),e=new point(Number(e[0].split(":")[1]),Number(e[1].split(":")[1]))):e=this.getNodePosition(e.getAttributeNS(null,"id"));e&&(q.fu.setPosition(e.x,e.y),g.fu.setPosition(e.x,e.y))}}}};
MapTheme.prototype.zoomTo=function(){var e=new point(1E5,1E5),b=new point(-1E5,-1E5);if(this.szFlag.match(/CHART/))for(a in this.itemA){var f=this.itemA[a].ptPos||this.getNodePosition(this.itemA[a].szSelectionId);f&&f.x&&f.y&&(e.x=Math.min(e.x,f.x),e.y=Math.min(e.y,f.y),b.x=Math.max(b.x,f.x),b.y=Math.max(b.y,f.y))}else for(a in this.itemA)for(tilesNodesA=this.getItemNodes(a),j=0;j<tilesNodesA.length;j++){bBox=map.Dom.getBox(tilesNodesA[j]);if(0==bBox.width||0==bBox.height)f=getMatrix(tilesNodesA[j]),
bBox.x+=f[4],bBox.y+=f[5],bBox.width=map.Scale.viewBox.width/20,bBox.height=map.Scale.viewBox.height/20,bBox.x-=bBox.width/2,bBox.y-=bBox.height/2;f=map.Scale.getMapOffset(tilesNodesA[j]);bBox.x+=f.x;bBox.y+=f.y;e.x=Math.min(e.x,bBox.x);e.y=Math.min(e.y,bBox.y);b.x=Math.max(b.x,bBox.x+bBox.width);b.y=Math.max(b.y,bBox.y+bBox.height)}e=new box(e.x,e.y,b.x-e.x,b.y-e.y);e.scale(1);e=map.Zoom.clipArea(e);map.Zoom.setNewArea(e)};
MapTheme.prototype.createChartGroup=function(e){if(!this.chartGroup&&(this.szFlag.match(/FEATURES/)?this.chartGroup=map.Dom.newGroup(e,this.szId+":featuregroup"):this.chartGroup=map.Dom.newGroup(e,this.szId+":chartgroup"),this.chartGroup.style.setProperty("opacity",String(this.nOpacity?this.nOpacity:1),""),this.szFlag.match(/VECTOR/)&&antiZoomAndPanList.addGroup(this.chartGroup),this.szFlag.match(/NOSCALE/)&&antiZoomAndPanList.addGroup(this.chartGroup),this.szFlag.match(/AGGREGATE/)&&(this.szFlag.match(/AUTOSIZE/)||
this.szFlag.match(/GRIDSIZE/))&&antiZoomAndPanList.addGroup(this.chartGroup),this.szFlag.match(/GRIDSIZE/)&&!this.szFlag.match(/AGGREGATE/)&&antiZoomAndPanList.addGroup(this.chartGroup),this.szFlag.match(/BUFFER/))){this.szFlag.match(/OVERLAY/)&&!this.szShapeType.match(/line/)&&this.chartGroup.style.setProperty("opacity","1","");map.Layer.getLayerObj(this.szThemesA[0]);this.chartGroup.style.setProperty("pointer-events","none","");antiZoomAndPanList.addGroup(this.chartGroup);e=this.colorScheme[0];
var b=this.colorScheme[1]?this.colorScheme[1]:"red";"undefined"!=typeof this.szBorderColor&&(b=this.szBorderColor);var f="stroke-width:0;";if("undefined"!=typeof this.szBorderStyle)switch(this.szBorderStyle){case "dotted":f="stroke-width:"+map.Scale.normalX(1)+";stroke-linecap:round;stroke-dasharray:1,50;";break;case "dashed":f="stroke-width:"+map.Scale.normalX(1)+";stroke-linecap:butt;stroke-dasharray:30,30;";break;case "solid":f="stroke-width:"+map.Scale.normalX(1)+";";break;case "none":f="stroke-width:0;"}if("undefined"!=
typeof this.szBorderWidth)switch(this.szBorderWidth){case "thin":f+="stroke-width:"+map.Scale.normalX(.5)+";";break;case "thick":f+="stroke-width:"+map.Scale.normalX(1.5)+";"}this.chartGroup.setAttributeNS(null,"style","fill:"+e+";fill-opacity:"+(this.fillOpacity?this.fillOpacity:this.nOpacity?this.nOpacity:0)+";stroke:"+b+";"+f+";")}};
MapTheme.prototype.chartMap=function(e){if(!this.nChartUpper||map.Scale.nTrueMapScale*map.Scale.nZoomScale<=this.nChartUpper)if(!this.nChartLower||map.Scale.nTrueMapScale*map.Scale.nZoomScale>this.nChartLower){this.fVisible=!0;this.chartGroup&&this.chartGroup.style.setProperty("display",this.chartGroup.display||"inline","");this.chartGroup&&!e&&(this.chartPosA=[]);var b=this.nChartSize?this.nChartSize:30,f=map.Zoom.getBox(),c=this.szFlag.match(/AGGREGATE/)&&this.nGridWidth?map.Scale.getDeltaXofDistanceInMeter(this.nGridWidth||
0)*map.Scale.nZoomScale:map.Scale.normalX(30)*map.Scale.nZoomScale;f.x-=c/2;f.y-=c/2;f.width+=c;f.height+=c;var c=null,h=8;if(!e||0==e){if(!this.partsA)return;var g=0;e=0;this.indexA=[];this.szValuesLineStyle="stroke:white;stroke-width:"+map.Scale.normalX(1.5)+";opacity:0.5;";this.szValuesLineBgStyle="stroke:#888888;stroke-width:"+map.Scale.normalX(.5)+";opacity:1;";this.szValuesTextStyle="font-family:"+(this.szTextFont||"arial")+";font-size:"+map.Scale.normalX(h)+"px;fill:#777777;pointer-events:none";
var q=map.Layer.objectGroup;this.chartGroup||this.createChartGroup(q);this.blur(this.nBlur);this.autoOpacity&&(this.fillOpacity=1*Math.max(.1,Math.min(1,20/Math.max(1,Math.pow(map.Zoom.nZoom,.5)))));this.mapSleep&&(this.mapSleep.checkSleepMessage="creating charts");q=getRotateAttributeValue(map.Scale.canvasNode);if(this.szFlag.match(/\bSORT\b/)&&!this.szFlag.match(/SEQUENCE/)&&!this.szFlag.match(/3D/)){this.indexA=[];for(g in this.itemA)this.indexA[this.indexA.length]=g;for(var l=[],r=0;r<this.indexA.length;r++)h=
this.itemA[this.indexA[r]].nValuesA[this.nActualFrame||0],this.itemA[this.indexA[r]].nSize?h=this.itemA[this.indexA[r]].nSize:this.szFlag.match(/SIZE/)&&this.itemA[this.indexA[r]].nValueSum&&(h=this.itemA[this.indexA[r]].nValueSum),isNaN(h)||l.push({a:this.indexA[r],y:h});this.szFlag.match(/\bUP\b/)?l.sort(this.sortDownChartObjectsCompare):l.sort(this.sortUpChartObjectsCompare);if(this.szValueField&&"$index$"==this.szValueField)for(r=0;r<l.length;r++)this.itemA[l[r].a].szValue=String(l.length-r);
this.indexA=[]}if(this.szFlag.match(/CHART/)&&!this.szFlag.match(/CATEGORICAL/)){for(s=0;s<this.partsA.length;s++)this.partsA[s].nCount=0,this.partsA[s].nSum=0;this.fRedrawInfo=!0;this.szFlag.match(/SEQUENCE/)&&(this.nFadeNegative=this.nFadeNegative||1)}var k=h=l=0;if(!this.fClipCharts||this.szFlag.match(/BUFFER/)||this.szFlag.match(/POSITION/)||this.szFlag.match(/FEATURE/))for(g in this.itemA){this.indexA[this.indexA.length]=g;if(this.szFlag.match(/CHART/)&&!this.szFlag.match(/CATEGORICAL/))for(r=
0;r<this.partsA.length;r++)this.partsA[r].nCount++,this.partsA[r].nSum+=isNaN(this.itemA[g].nValuesA[r])?0:this.itemA[g].nValuesA[r];h++;l++}else{for(r=0;r<this.partsA.length;r++)this.partsA[r].nCount=0,this.partsA[r].nSum=0;for(g in this.itemA)if(h++,this.itemA[g].nValuesA&&0<this.itemA[g].nValuesA.length)if(c=this.itemA[g].ptPos||this.getNodePosition(this.itemA[g].szSelectionId)){if(!this.szFlag.match(/NOCLIPTOVIEW/)&&(c.x<f.x||c.x>f.x+f.width||c.y<f.y||c.y>f.y+f.height))if(this.szFlag.match(/\b(VECTOR|BEZIER)\b/)){c=
this.itemA[g].ptPos2||(this.szLabelA?this.getNodePosition(this.szThemesA[0]+"::"+this.szLabelA[this.itemA[g].nValuesA[0]-1]):null);if(!c)continue;if(c.x<f.x||c.x>f.x+f.width||c.y<f.y||c.y>f.y+f.height){this.nSkipCount++;(chartGroup=this.itemA[g].chartNode)&&chartGroup.parentNode&&(chartGroup.parentNode&&chartGroup.parentNode.removeChild(chartGroup),this.itemA[g].chartNode=null,this.chartPosA[this.itemA[g].szSelectionId]=null,this.posItemA[this.itemA[g].szSelectionId]=null);continue}}else{this.nSkipCount++;
(chartGroup=this.itemA[g].chartNode)&&chartGroup.parentNode&&(chartGroup.parentNode&&chartGroup.parentNode.removeChild(chartGroup),this.itemA[g].chartNode=null,this.chartPosA[this.itemA[g].szSelectionId]=null,this.posItemA[this.itemA[g].szSelectionId]=null);continue}if(!this.itemA[g].ptPos||!this.itemA[g].ptPos2||this.itemA[g].ptPos.x!=this.itemA[g].ptPos2.x||this.itemA[g].ptPos.y!=this.itemA[g].ptPos2.y){this.indexA[this.indexA.length]=g;if(this.szFlag.match(/CHART/))if(this.szFlag.match(/CATEGORICAL/))if(1<
this.nMaxA.length)for(r=0;r<this.partsA.length;r++)this.partsA[r].nCount++,this.partsA[r].nSum+=this.itemA[g].nValuesA[r]&&!isNaN(this.itemA[g].nValuesA[r])?this.itemA[g].nValuesA[r]:0;else this.szAlphaField?this.szColorField&&this.partsA[this.itemA[g].nClass]?(this.partsA[this.itemA[g].nClass].nCount++,this.partsA[this.itemA[g].nClass].nSum+=isNaN(this.itemA[g].nAlpha)?isNaN(this.itemA[g].nSize)?1:this.itemA[g].nSize:this.itemA[g].nAlpha):this.partsA[this.itemA[g].nValuesA[0]-1]&&(this.partsA[this.itemA[g].nValuesA[0]-
1].nCount++,this.partsA[this.itemA[g].nValuesA[0]-1].nSum+=isNaN(this.itemA[g].nAlpha)?isNaN(this.itemA[g].nSize)?1:this.itemA[g].nSize:this.itemA[g].nAlpha):this.szColorField&&this.partsA[this.itemA[g].nClass]?(this.partsA[this.itemA[g].nClass].nCount++,this.partsA[this.itemA[g].nClass].nSum+=isNaN(this.itemA[g].nSize)?1:this.itemA[g].nSize):this.partsA[this.itemA[g].nValuesA[0]-1]&&(this.partsA[this.itemA[g].nValuesA[0]-1].nCount++,this.partsA[this.itemA[g].nValuesA[0]-1].nSum+=isNaN(this.itemA[g].nSize)?
1:this.itemA[g].nSize);else if(1<this.nMaxA.length)for(r=0;r<this.partsA.length;r++){if(!this.szFlag.match(/MEAN/)||this.itemA[g].nValuesA[r])this.partsA[r].nCount++,this.partsA[r].nSum+=isNaN(this.itemA[g].nValuesA[r])?0:this.itemA[g].nValuesA[r]}else for(r=0;r<this.partsA.length;r++)this.itemA[g].nValuesA[0]>=this.partsA[r].min&&this.itemA[g].nValuesA[0]<this.partsA[r].max&&(this.partsA[r].nCount++,this.partsA[r].nSum+=isNaN(this.itemA[g].nValuesA[0])?0:this.itemA[g].nValuesA[0]);l++}}else this.missedA[g]=
g,k++;if(h==k&&!map.Tiles.allTilesLoaded()){this.fRedraw=this.fDataIncomplete=!0;map.Tiles.switchScaleDependentTiles();setTimeout("map.Themes.execute()",1);return}}if(l>this.nMaxThemeCharts)for(g in this.ErrorMessage="max charts ("+this.nMaxThemeCharts+") exceeded; please zoom in",this.indexA.length=0,this.nSkipCount=l,this.itemA)(chartGroup=SVGDocument.getElementById(this.szId+":"+g+":chart"))&&chartGroup.parentNode.removeChild(chartGroup);this.fRedrawAllCharts=!1;l>this.nMaxShadowCharts?(this.fShadow&&
(this.fRedrawAllCharts=!0),this.fShadow=!1):(this.fOrigShadow&&!this.fShadow&&(this.fRedrawAllCharts=!0),this.fShadow=this.fOrigShadow);this.szShadowUpper&&(map.Scale.nTrueMapScale*map.Scale.nZoomScale>this.nShadowUpper?(this.xOrigShadow=this.xOrigShadow||this.fOrigShadow,this.fShadow=this.fOrigShadow=!1):this.fOrigShadow=this.xOrigShadow||this.fOrigShadow);this.szShadowLower&&(map.Scale.nTrueMapScale*map.Scale.nZoomScale<this.nShadowLower?(this.xOrigShadow=this.xOrigShadow||this.fOrigShadow,this.fShadow=
this.fOrigShadow=!1):this.fOrigShadow=this.xOrigShadow||this.fOrigShadow);this.mapSleep&&(this.mapSleep.nCount=l);this.fSorted=!1;if(this.fSortBeforeDraw&&this.nMin!=this.nMax&&!this.szFlag.match(/NOSRT/)&&!this.szFlag.match(/DOT/)&&(!this.szFlag.match(/NOSIZE/)||this.szFlag.match(/3D/)||this.szFlag.match(/\bSORT\b/))&&(!this.szFlag.match(/CATEGORICAL/)||this.szFlag.match(/AGGREGATE/)||this.szSizeField||this.szFlag.match(/\bSORT\b/))){f=[];if((this.szFlag.match(/3D/)||this.szFlag.match(/BOX/)||this.szFlag.match(/POINTER/)&&
this.szFlag.match(/BAR/))&&(!this.szFlag.match(/MULTIPLE/)&&!this.szFlag.match(/MULTIGRID/)||this.szFlag.match(/AGGREGATE/)))for(r=0;r<this.indexA.length;r++)(c=this.itemA[this.indexA[r]].ptPos||this.getNodePosition(this.itemA[this.indexA[r]].szSelectionId))?f[r]=q?{a:this.indexA[r],y:c.x*Math.sin(q)+c.y*Math.cos(q)}:{a:this.indexA[r],y:c.y}:f[r]={a:this.indexA[r],y:0};else if(this.szSizeField||this.szFlag.match(/AGGREGATE/)&&this.szFlag.match(/SUM/))for(r=0;r<this.indexA.length;r++)h=this.itemA[this.indexA[r]].nSize,
isNaN(h)||f.push({a:this.indexA[r],y:h});else if(this.szSizeField||this.szFlag.match(/AGGREGATE/)&&this.szFlag.match(/MEAN/))for(r=0;r<this.indexA.length;r++)h=this.itemA[this.indexA[r]].nValuesA[this.nActualFrame||0],isNaN(h)||f.push({a:this.indexA[r],y:h});else if(this.szFlag.match(/SIZE/))for(r=0;r<this.indexA.length;r++)h=this.itemA[this.indexA[r]].nValueSum,isNaN(h)||f.push({a:this.indexA[r],y:h});else for(r=0;r<this.indexA.length;r++)h=this.itemA[this.indexA[r]].nValuesA[this.nActualFrame||
0],isNaN(h)||f.push({a:this.indexA[r],y:h});this.szFlag.match(/\bSORT\b/)&&this.szFlag.match(/\bUP\b/)&&!this.szFlag.match(/SEQUENCE/)&&!this.szFlag.match(/3D/)?f.sort(this.sortDownChartObjectsCompare):f.sort(this.sortUpChartObjectsCompare);for(r=0;r<f.length;r++)this.indexA[r]=f[r].a;this.fSorted=!0}if(this.nMaxCharts&&l>this.nMaxCharts){this.fContinue=!0;this.continueIndex=l-this.nMaxCharts;this.indexA.slice(l-this.nMaxCharts-1,this.nMaxCharts);map.Themes.executeContinue();return}}this.chart={szColor:this.colorScheme[0],
szLineColor:this.colorScheme[1]?this.colorScheme[1]:"none",szTextColor:this.colorScheme[1]?this.colorScheme[1]:"none"};if(2<this.colorScheme.length||this.szFlag.match(/CATEGORICAL/))this.chart.szColor=this.colorScheme[this.colorScheme.length-1],this.chart.szLineColor=this.colorScheme[0];this.szFlag.match(/NOLINES/)?this.chart.szLineColor="none":"none"==this.chart.szLineColor&&(f=__maptheme_getChartColors("#777777"),this.chart.szLineColor=f.textColor);this.szFlag.match(/PLOT/)&&(this.szFlag.match(/GRIDSIZE/)||
this.szFlag.match(/AUTOSIZE/))?(f=0,f=map.Layer.nDynamicObjectScale,c=this.szFlag.match(/GAP/)?1.2:1,f=this.nGridWidthPx?map.Scale.normalX(this.nGridWidthPx)/c*this.nScale/f:this.nGridWidth?map.Scale.getDeltaXofDistanceInMeter(this.nGridWidth)/c*this.nScale/f:map.Scale.normalX(b/3),this.nAutoScale=f/map.Scale.normalX((this.itemA[g]?this.itemA[g].nValuesA.length:1)/(this.nGridX||1)*b),this.nGridSize=f):this.szFlag.match(/GRIDSIZE/)&&(f=map.Layer.nDynamicObjectScale,c=this.szFlag.match(/\bRECT\b/)||
!this.szFlag.match(/AGGREGATE/)?this.szFlag.match(/GAP/)?1.15:1:this.szFlag.match(/GAP/)?.8:.75,this.nGridSize=this.nGridWidthPx?map.Scale.normalX(this.nGridWidthPx)/c/f:this.nGridWidth?map.Scale.getDeltaXofDistanceInMeter(this.nGridWidth)/c/f:map.Scale.normalX(b/3));this.szFlag.match(/PLOTXY/)&&(f=map.Layer.nDynamicObjectScale,c=1.15,this.nChartWidth=this.nGridWidthPx?map.Scale.normalX(this.nGridWidthPx)/c/this.nScale/f:this.nGridWidth?map.Scale.getDeltaXofDistanceInMeter(this.nGridWidth)/c/this.nScale/
f:map.Scale.normalX(b/3),this.nChartWidth-=2*map.Scale.normalX(this.nBoxMargin||0),this.nChartHeight=this.nChartWidth-map.Scale.normalY(this.szFlag.match(/TITLE/)?10:0),this.nGridSize=this.nChartWidth,this.nAutoScale=1,this.nRangeX=this.nMaxX-this.nMinX,this.nRangeY=this.nMaxY-this.nMinY);this.nChartGroupScaleX=this.nChartGroupScale=fObjectScaling?(this.nAutoScale||this.nScale)*map.Layer.nObjectScale*map.Scale.nObjectScaling:(this.nAutoScale||this.nScale)*map.Scale.nFeatureScaling*map.Scale.nObjectScaling;
this.nChartGroupScaleY=this.nChartGroupScale/map.Zoom.nZoomY*map.Zoom.nZoomX;this.fGlowInScale=!1;(!this.szGlowUpper||map.Scale.nTrueMapScale*map.Scale.nZoomScale<=this.nGlowUpper)&&(!this.szGlowLower||map.Scale.nTrueMapScale*map.Scale.nZoomScale>=this.nGlowLower)&&(this.fGlowInScale=!0);this.fDoRedraw=!1;if(1E3>this.indexA.length||this.fRedraw||this.fRedrawAllCharts||this.szFlag.match(/BUFFER/)&&this.szShapeType.match(/line/))this.fDoRedraw=!0;this.fHideValues=this.szValueUpper&&map.Scale.nTrueMapScale*
map.Scale.nZoomScale>this.nValueUpper;if(this.szFlag.match(/USER/))try{var w={target:this.chartGroup,theme:this};this.userDraw?(this.opt=w,eval("HTMLWindow.ixmaps."+this.userDraw+"_init(SVGDocument,this.opt);"),delete this.opt):HTMLWindow.ixmaps.htmlgui_initChart(SVGDocument,w)}catch(m){displayMessage("'"+(this.userDraw||"USER chart")+"' undefined!",5E3)}f=map.Scale.getDeltaXofDistanceInMeter(this.nGridWidth)/2*20;for(f=f*map.Scale.nZoomScale*20;e<this.indexA.length;e++){if(this.fCancel){displayMessage("Canceled by user",
1E3,!0);this.fCancel=!1;return}if(this.mapSleep&&(this.mapSleep.nDoneCount=this.nDoneCount,this.mapSleep.checkSleep(e,10))){this.fContinue=!0;this.continueIndex=e;this.szItemFilter&&this.szItemFilter.length&&this.filterItems(this.szItemFilter,this.itemFilterOpt);null!=this.markedClass&&this.markClass(this.markedClass,1);return}w=null;g=this.indexA[e];this.nDoneCount++;if(this.itemA[g]&&this.itemA[g].nValuesA&&0!=this.itemA[g].nValuesA.length){k=this.itemA[g].szSelectionId;if(c=this.itemA[g].ptPos||
this.getNodePosition(k))c.x=isNaN(c.x)?0:c.x,c.y=isNaN(c.y)?0:c.y;if(!c||isNaN(c.x)||isNaN(c.y))this.nMissingPositionCount++;else{this.fRedraw&&(this.itemA[g].chartNode=this.itemA[g].chartNode||SVGDocument.getElementById(this.szId+":"+g+":chart"));if(this.itemA[g].chartNode&&this.itemA[g].chartNode.parentNode)if(this.fDoRedraw)this.itemA[g].chartNode.parentNode.removeChild(this.itemA[g].chartNode),this.itemA[g].chartNode=null;else{this.nRealizedCount++;continue}r=new point(0,0);if(this.szFlag.match(/POSITION|FEATURE/))w=
map.Dom.newGroup(this.chartGroup,g),w.fu.setMatrix([this.nChartGroupScaleX,0,0,this.nChartGroupScaleY,c.x,c.y]);else if(this.szFlag.match(/DOT/)){w=map.Dom.newGroup(this.chartGroup,this.szId+":"+k+":chartgroup");w.fu.setMatrix([this.nChartGroupScaleX,0,0,this.nChartGroupScaleY,c.x,c.y]);if(this.szFlag.match(/CATEGORICAL/))this.chart.szColor=this.colorScheme[this.itemA[g].nValuesA[0]-1];else if(1<this.partsA.length)for(r=0;r<this.partsA.length;r++)this.itemA[g].nValuesA[0]>=this.partsA[r].min&&this.itemA[g].nValuesA[0]<
this.partsA[r].max&&(this.chart.szColor=this.colorScheme[r]);this.itemA[g].chartNode=map.Dom.newShape("circle",w,0,0,map.Scale.normalX(3),"fill:"+this.chart.szColor+";fill-opacity:"+(this.fillOpacity||1)+";stroke:none;")}else if(this.szFlag.match(/\bQUAD\b/)){w=map.Dom.newGroup(this.chartGroup,this.szId+":"+k+":chart");w.fu.setMatrix([this.nChartGroupScaleX,0,0,this.nChartGroupScaleY,c.x,c.y]);if(this.szFlag.match(/CATEGORICAL/))this.chart.szColor=this.colorScheme[this.itemA[g].nValuesA[0]-1];else if(1<
this.partsA.length)for(r=0;r<this.partsA.length;r++)this.itemA[g].nValuesA[0]>=this.partsA[r].min&&this.itemA[g].nValuesA[0]<this.partsA[r].max&&(this.chart.szColor=this.colorScheme[r]);this.itemA[g].chartNode=map.Dom.newShape("rect",w,-f,-f,2*f,2*f,"fill:"+this.chart.szColor+";stroke:none;")}else if(this.szFlag.match(/\bBEZIER\b/)){if(!(this.nMinValue&&this.itemA[g].nSize<this.nMinValue)&&(r=this.itemA[g].ptPos,h=this.itemA[g].ptPos2||(this.szLabelA?this.getNodePosition(this.szThemesA[0]+"::"+this.szLabelA[this.itemA[g].nValuesA[0]-
1]):null),r&&h&&r!=h)){w=this.itemA[g].chartNode=map.Dom.newGroup(this.chartGroup,this.szId+":"+g+(g?":chartgroup":":ochrtgroup"));this.chart.szColor=this.szLineColor||this.itemA[g].szColor||this.colorScheme[this.itemA[g].nValuesA[0]-1];var c=1/(this.nSizePow||1),l=this.nLineWidth||10/Math.pow(this.nNormalSizeValue||this.nMaxSize,c)*Math.pow(Math.abs(this.itemA[g].nSize),c),x=Number(this.nGapSize||20),v=l+(this.szFlag.match(/\bGAP\b/)?x:3),l=map.Scale.normalX(l)*this.nChartGroupScaleY*this.nScale;
if(!(0>=l)){if(this.szFlag.match(/\bREVERSE\b/)||0>this.itemA[g].nSize)c=r,r=h,h=c;k=Math.sqrt((h.y-r.y)*(h.y-r.y)+(h.x-r.x)*(h.x-r.x));c=h.x-r.x;h=h.y-r.y;k=Math.sqrt(c*c+h*h);if(this.szFlag.match(/\bSHORT\b/))var z=h/k*(this.nRangeScale||5)*100*this.nChartGroupScaleY,y=c/k*(this.nRangeScale||5)*100*this.nChartGroupScaleY;else this.szFlag.match(/\bLONG\b/)?(z=h/5E4*Math.max(k,500)*(this.nRangeScale||5),y=c/5E4*Math.max(k,500)*(this.nRangeScale||5)):(z=h/50*(this.nRangeScale||5),y=c/50*(this.nRangeScale||
5));var c=c-c/k*map.Scale.normalX(v)*this.nChartGroupScaleY*this.nScale,h=h-h/k*map.Scale.normalX(v)*this.nChartGroupScaleY*this.nScale,J=0,C=0;this.szFlag.match(/\bGAP\b/)&&(c+=z/500*v,h-=y/500*v,J=c/k*x*20*this.nChartGroupScaleY,C=h/k*x*20*this.nChartGroupScaleY);x="M"+J+","+C+" C"+(c/4+z)+","+(h/4-y)+" "+(c/2+z)+","+(h/2-y)+" "+c+","+h+"";x=map.Dom.newShape("path",w,x,"stroke-linecap:butt;fill:none;stroke:"+this.chart.szColor+";stroke-width:"+l+";stroke-opacity:"+(this.fillOpacity||.3)+";");if(this.szFlag.match(/\bDASH\b/)){var F=
1E3*this.nChartGroupScaleY,u=100*this.nChartGroupScaleY+l;x.style.setProperty("stroke-dasharray",String(F)+" "+String(u));x.style.setProperty("stroke-dashoffset","0");x.style.setProperty("stroke-linecap","round");v=Math.random()*F;F=v+F+u;map.Dom.constructNode("animate",x,{attributeType:"XML",attributeName:"stroke-dashoffset",from:String(F),to:String(v),dur:"2s",repeatCount:"indefinite"})}if(this.szFlag.match(/\bGRADIENT\b|\bFADEIN\b/)){v=this.szLineColorA?this.szLineColorA[0]:this.chart.szColor;
F=this.szFlag.match(/\bFADEIN\b/)?.2:2;u="Gradient"+Math.random();if(Math.abs(h)>Math.abs(c)){var A=map.Dom.constructNode("linearGradient",w,{id:u,x1:"0%",y1:"0%",x2:"0%",y2:"100%"});map.Dom.constructNode("stop",A,{offset:"0","stop-color":0>h?this.chart.szColor:v,"stop-opacity":0>h?"2":F});map.Dom.constructNode("stop",A,{offset:"1","stop-color":0>h?v:this.chart.szColor,"stop-opacity":0>h?F:"2"})}else A=map.Dom.constructNode("linearGradient",w,{id:u}),map.Dom.constructNode("stop",A,{offset:"0","stop-color":0>
c?this.chart.szColor:v,"stop-opacity":0>c?"2":F}),map.Dom.constructNode("stop",A,{offset:"1","stop-color":0>c?v:this.chart.szColor,"stop-opacity":0>c?F:"2"});x.style.setProperty("stroke","");x.style.setProperty("fill","none");x.setAttributeNS(null,"stroke","url(#"+u+")")}this.szFlag.match(/\bPOINTER|ARROW\b/)&&(v="ArrowMarker"+Math.random(),F=map.Dom.newNode("defs",w),u=Math.min(5,2.5+100/(l/this.nChartGroupScale))*(this.nMarkerSize||1),F=map.Dom.constructNode("marker",F,{id:v,markerWidth:u,markerHeight:u,
refX:u/1.5,refY:u/2,orient:"auto",markerUnits:"strokeWidth"}),map.Dom.constructNode("path",F,{d:"M0,"+u+" L"+u+","+u/2+" L0,0 Z",style:"fill:"+this.chart.szColor+";opacity:"+2*(this.fillOpacity||.3)+";stroke:#444444;stroke-width:0.01"}),x.setAttributeNS(null,"marker-end","url(#"+v+")"));this.szFlag.match(/\bVALUES\b/)&&!this.fHideValues&&(v="VectorPath"+Math.random(),0>c?(x="M"+c+","+h+" C"+(c/2+z)+","+(h/2-y)+" "+(c/4+z)+","+(h/4-y)+" "+J+","+C+"",map.Dom.newShape("path",w,x,"fill:none;stroke:none").setAttributeNS(null,
"id",v)):x.setAttributeNS(null,"id",v),h=Math.min(k,Math.sqrt(this.itemA[g].nSize)/Math.sqrt(this.nNormalSizeValue||this.nMaxSize)*this.nValueScale),h=24*map.Scale.normalX(h)*this.nChartGroupScaleY*this.nScale,c=this.formatValue(this.itemA[g].nSize,this.szValueDecimals||(1>this.itemA[g].nSize?2:0),"ROUND")+this.szUnit,map.Dom.newTextOnPath(w,v,c,"font-family:arial;font-size:"+h+"px;fill:"+this.chart.szColor+";stroke:#ffffff;stroke-width:"+l/10+"px;baseline-shift:-35%","40%"));w.setAttributeNS(szMapNs,
"class","undefined"!=typeof this.itemA[g].nClass?this.itemA[g].nClass:String(this.itemA[g].nValuesA[0]-1));w.setAttributeNS(szMapNs,"tooltip",this.formatValue(this.itemA[g].nSize,this.szValueDecimals||(1>this.itemA[g].nSize?2:0),"ROUND")+this.szUnit);w.fu.setMatrix([1,0,0,1,r.x,r.y])}}}else if(this.szFlag.match(/\bVECTOR\b/))this.nMinValue&&this.itemA[g].nSize<this.nMinValue||(r=this.itemA[g].ptPos,h=this.itemA[g].ptPos2||(this.szLabelA?this.getNodePosition(this.szThemesA[0]+"::"+this.szLabelA[this.itemA[g].nValuesA[0]-
1]):null),r&&h&&(w=this.itemA[g].chartNode=map.Dom.newGroup(this.chartGroup,this.szId+":"+g+(g?":chartgroup":":ochrtgroup")),this.chart.szColor=this.szLineColor||this.colorScheme[this.itemA[g].nValuesA[0]-1],l=this.nLineWidth||2/(this.nNormalSizeValue||1)/this.nMaxSize*this.itemA[g].nSize,x=map.Dom.newShape("line",w,0,0,h.x-r.x,h.y-r.y,"stroke:"+this.chart.szColor+";stroke-width:"+map.Scale.normalX((l||.1)*this.nChartGroupScaleY)+";stroke-opacity:"+(this.fillOpacity||.3)+";"),this.szFlag.match(/\bDASH\b/)&&
(F=1E3*this.nChartGroupScaleY,u=300*this.nChartGroupScaleY,x.style.setProperty("stroke-dasharray",String(F)+" "+String(u)),x.style.setProperty("stroke-dashoffset","0"),v=Math.random()*F,F=v+F+u,map.Dom.constructNode("animate",x,{attributeType:"XML",attributeName:"stroke-dashoffset",from:String(F),to:String(v),dur:"1s",repeatCount:"indefinite"})),this.szFlag.match(/\bPOINTER\b/)&&(F=map.Dom.newNode("defs",w),F=map.Dom.constructNode("marker",F,{id:this.szId+":"+k+":chartgroup:ArrowMarker",markerWidth:"4",
markerHeight:"4",refX:"4",refY:"2",orient:"auto",markerUnits:"strokeWidth"}),map.Dom.constructNode("path",F,{d:"M0,4 L4,2 L0,0 Z",style:"fill:"+this.chart.szColor+";opacity:"+2*(this.fillOpacity||.3)+";stroke:white;stroke-width:0.1"}),x.setAttributeNS(null,"marker-end","url(#"+this.szId+":"+k+":chartgroup:ArrowMarker)")),w.setAttributeNS(szMapNs,"class","undefined"!=typeof this.itemA[g].nClass?this.itemA[g].nClass:String(this.itemA[g].nValuesA[0]-1)),w.setAttributeNS(szMapNs,"tooltip",this.formatValue(this.itemA[g].nSize,
this.szValueDecimals||(1>this.itemA[g].nSize?2:0),"ROUND")+this.szUnit),w.fu.setMatrix([1,0,0,1,r.x,r.y])));else{w=null;if(k)if(w=SVGDocument.getElementById(this.szId+":"+k+":chart"))w.fu=new Methods(w);else if(w=map.Dom.newGroup(this.chartGroup,this.szId+":"+k+":chart"),this.szFlag.match(/BOX/)){r="#bbbbbb";"undefined"!=typeof this.szBorderColor&&(r=this.szBorderColor);l="stroke-width:"+map.Scale.normalX(.5)+";stroke-opacity:0.3;";if("undefined"!=typeof this.szBorderStyle)switch(this.szBorderStyle){case "dotted":l=
"stroke-width:"+map.Scale.normalX(1)+";stroke-linecap:round;stroke-dasharray:1,50;";break;case "dashed":l="stroke-width:"+map.Scale.normalX(1)+";stroke-linecap:butt;stroke-dasharray:30,30;";break;case "solid":l="stroke-width:"+map.Scale.normalX(1)+";";break;case "none":l="stroke-width:0;"}if("undefined"!=typeof this.szBorderWidth)switch(this.szBorderWidth){case "thin":l+="stroke-width:"+map.Scale.normalX(.3)+";";break;case "thick":l+="stroke-width:"+map.Scale.normalX(1.5)+";"}newBox=map.Dom.newShape("rect",
w,0,0,1,1,"fill:"+(this.szBoxColor||"white")+";fill-opacity:"+(this.nBoxOpacity||1)+";stroke:"+r+";"+l);newBox.setAttributeNS(null,"id",this.szId+":"+k+":chart:box");switch(this.szSymbolBoxStyle){case "frame":this.boxShape.setAttributeNS(null,"fill-opacity",0);break;case "field":this.boxShape.setAttributeNS(null,"fill-opacity",1)}}this.itemA[g].chartNode=w;w.setAttributeNS(szMapNs,"value",String(this.itemA[g].nValuesA[0]));r=this.drawChart(w,g,b,this.szFlag+"|SILENT");l=this.nScale;this.nScale=this.nAutoScale||
this.nScale;h=1;"auto"==this.nMaxValue&&this.nMaxValuePlot&&(h=h/Math.pow(this.nMax,1/3)*Math.pow(this.nMaxValuePlot,1/3));r&&c&&w&&(this.szFlag.match(/PLOT/)&&this.nGridSize&&this.nAutoScale&&(r.x+=this.nGridSize/this.nAutoScale/2,r.y-=this.nGridSize/this.nAutoScale/2),this.szFlag.match(/NOSCALE/)?w.fu.setMatrix([this.nScale,0,0,this.nScale,c.x-r.x*this.nScale,c.y-r.y*this.nScale]):w.fu.setMatrix([this.nChartGroupScaleX*h,0,0,this.nChartGroupScaleY*h,c.x-r.x*map.Layer.nObjectScale*this.nScale,c.y-
r.y*map.Layer.nObjectScale*this.nScale]));this.nScale=l;if(r){k=k.split("*")[0];if((this.szFlag.match(/MULTIPLE/)||this.szFlag.match(/ALIGN/))&&w.lastChild.firstChild){c=map.Dom.getBox(w.lastChild);r=this.szFlag.match(/\bUP\b/)?c.height:c.width;if(this.chartPosA[k]){this.chartPosA[k]+=this.szFlag.match(/TEXTONLY/)?5:.5*r;var l=w.lastChild.fu.getPosition(),E=r*(this.nGridX||10);this.szFlag.match(/\bUP\b/)?w.lastChild.fu.setPosition(l.x+c.width*Math.floor(this.chartPosA[k]/E),l.y-c.y-c.height/2-this.chartPosA[k]%
E):w.lastChild.fu.setPosition(l.x+this.chartPosA[k]%E,l.y-c.height*Math.floor(this.chartPosA[k]/E));this.chartPosA[k]+=this.szFlag.match(/TEXTONLY/)?r:.5*r}else this.chartPosA[k]=this.szFlag.match(/TEXTONLY/)?r:-c.y;this.posItemA&&(this.posItemA[k]||(this.posItemA[k]=[]),this.posItemA[k].push(this.itemA[g]))}else if((this.szFlag.match(/MULTIFIX/)||this.szFlag.match(/MULTIGRID/))&&w.lastChild){if(r=1,z=map.Scale.normalX(this.nChartSizeDone),y=map.Scale.normalX(this.nChartSizeDone),c=this.getNodePosition(k)){k=
String(c.x)+String(c.y);if(this.chartPosA[k]){var l=w.lastChild.fu.getPosition(),I=this.chartPosA[k],E=this.nGridX||7;this.szFlag.match(/\bUP\b/)?w.lastChild.fu.setPosition(l.x+z*Math.floor(I/E),l.y-I%E*y):w.lastChild.fu.setPosition(l.x+I%E*z,l.y-y*Math.floor(I/E));this.chartPosA[k]+=r}else this.chartPosA[k]=r;this.posItemA&&(this.posItemA[k]||(this.posItemA[k]=[]),this.posItemA[k].push(this.itemA[g]));this.itemA[g].labelGroup&&I%E!=E-1&&this.itemA[g].labelGroup.style.setProperty("display","none",
"")}}else(this.szFlag.match(/MULTISQUARE/)||this.szFlag.match(/MULTIQUAD/))&&w.lastChild&&(r=1,z=map.Scale.normalX(this.nChartSizeDone*(this.nRangeScale||1)),y=map.Scale.normalX(this.nChartSizeDone*(this.nRangeScale||1)),c=this.getNodePosition(k))&&(k=String(c.x)+String(c.y),this.chartPosA[k]?(l=w.lastChild.fu.getPosition(),I=this.chartPosA[k],h=Math.floor(Math.sqrt(I)),h<(this.nGridX||1E7)?(E=I-h*h,c=E<=h?E:h,h=E<=h?h:h-(E-h),w.lastChild.fu.setPosition(l.x+c*z,l.y-h*y)):(l=w.lastChild.fu.getPosition(),
I=this.chartPosA[k],E=this.nGridX||7,this.szFlag.match(/\bUP\b/)?w.lastChild.fu.setPosition(l.x+z*Math.floor(I/E),l.y-I%E*y):w.lastChild.fu.setPosition(l.x+I%E*z,l.y-y*Math.floor(I/E))),this.chartPosA[k]+=r):this.chartPosA[k]=r,this.posItemA&&(this.posItemA[k]||(this.posItemA[k]=[]),this.posItemA[k].push(this.itemA[g])),this.itemA[g].labelGroup&&I%E!=E-1&&this.itemA[g].labelGroup.style.setProperty("display","none",""));this.szFlag.match(/TEXTONLY/)&&fCheckLabelOverlap&&(c=SVGDocument.getElementById(this.szId+
":"+g+":text"))&&new Map.Label.Item(c);q&&setRotate(w,-Number(q));1==this.fShadow&&SVGDocument.getElementById(szShadowFilterId)?w.style.setProperty("filter","url(#"+szShadowFilterId+")",""):1==this.fShadow&&(r=map.Dom.newNode("filter",this.chartGroup.parentNode),r.setAttributeNS(null,"id",szShadowFilterId),r.setAttributeNS(null,"filterUnits","objectBoundingBox"),r.setAttributeNS(null,"x","-50%"),r.setAttributeNS(null,"y","-50%"),r.setAttributeNS(null,"width","200%"),r.setAttributeNS(null,"height",
"200%"),c=map.Dom.newNode("feGaussianBlur",r),c.setAttributeNS(null,"stdDeviation","10"),c.setAttributeNS(null,"result","BlurAlpha"),c=map.Dom.newNode("feOffset",r),c.setAttributeNS(null,"in","BlurAlpha"),c.setAttributeNS(null,"dx","10"),c.setAttributeNS(null,"dy","10"),c.setAttributeNS(null,"result","OffsetBlurAlpha"),c=map.Dom.newNode("feColorMatrix",r),c.setAttributeNS(null,"in","OffsetBlurAlpha"),c.setAttributeNS(null,"type","matrix"),c.setAttributeNS(null,"values","0.1 0.1 0.1 0 0 0.1 0.1 0.1 0 0 0.1 0.1 0.1 0 0 0 0 0 1 0"),
c.setAttributeNS(null,"result","matrixOut"),c=map.Dom.newNode("feMerge",r),r=map.Dom.newNode("feMergeNode",c),r.setAttributeNS(null,"in","matrixOut"),r=map.Dom.newNode("feMergeNode",c),r.setAttributeNS(null,"in","SourceGraphic"),c=map.Dom.getBox(w.lastChild),c.width&&c.height&&w.style.setProperty("filter","url(#"+szShadowFilterId+")",""))}}}}}if(this.szFlag.match(/BOX/))if(this.nBoxUpper&&map.Scale.nTrueMapScale*map.Scale.nZoomScale>this.nBoxUpper)(E=SVGDocument.getElementById(this.szId+":"+D+":chart:box"))&&
E.parentNode.removeChild(E);else for(e=0;e<this.indexA.length;e++)if(g=this.indexA[e],this.itemA[g].fDone){var D=this.itemA[g].szSelectionId,w=SVGDocument.getElementById(this.szId+":"+D+":chart"),E=SVGDocument.getElementById(this.szId+":"+D+":chart:box");if(w&&E&&!E.getAttributeNS(szMapNs,"boxed")){this.szFlag.match(/\bPLOT\b/)&&SVGDocument.getElementById(this.szId+":"+g+":chartgroup").style.setProperty("display","none");c=map.Dom.getBox(w);I=map.Scale.normalX(this.nBoxMargin||2);I=Math.min(2*I,I*
(c.width/map.Scale.normalX(b)));if(this.szFlag.match(/TITLE/)&&this.szTitleField&&(!this.nTitleUpper||map.Scale.nTrueMapScale*map.Scale.nZoomScale<=this.nTitleUpper)){h=Math.max(map.Scale.normalX(.9),Math.min(c.width/6.6,map.Scale.normalX(6/this.nScale)));this.szFlag.match(/GRIDSIZE/)&&(h=Math.max(c.width/10,map.Scale.normalX(6)));D=this.itemA[g].szTitle;try{D=HTMLWindow.ixmaps.htmlgui_onInfoTitle(this.itemA[g].szTitle,this.itemA[g])}catch(O){}q=this.szTextColor||"#888888";D=this.szAlign&&this.szAlign.match(/right/)?
map.Dom.newText(w,c.x+c.width,c.y-.7*h,"font-family:arial;font-size:"+h+"px;text-anchor:end;fill:"+q+";stroke:none;pointer-events:none;",String(D||" ")):map.Dom.newText(w,c.x,c.y-.7*h,"font-family:arial;font-size:"+h+"px;text-anchor:start;fill:"+q+";stroke:none;pointer-events:none;",String(D||" "));q=map.Dom.wrapText(D,c.width);D.fu.setPosition(D.fu.getPosition().x,D.fu.getPosition().y-1*h*(q-1));this.szFlag.match(/CLIPPEDTITLE/)?(q=c.height,c.height+=1.8*h,c.y-=c.height-q,map.Dom.setClipRect(D,new box(c.x,
c.y-10*h,c.width-h/3,20*h))):(c=map.Dom.getBox(w),c.y+=.1*h,c.height-=.1*h)}this.szFlag.match(/\bPLOTX\b/)?(c.height=map.Scale.normalX(b),c.y=-map.Scale.normalX(b/2),c.width=this.nMax*map.Scale.normalX(1.1*b)/this.nMax*5*(this.nRangeScale||1)):this.szFlag.match(/\bPLOTY\b/)&&(q=c.height,D=c.width,c.width=map.Scale.normalX(b),c.height=this.nMax*map.Scale.normalX(1.1*b)/this.nMax*5*(this.nRangeScale||1),c.x-=(c.width-D)/2,c.y-=(c.height-q)/2);D=c.height+2*I;0<=c.width+2*I&&0<=D&&(E.setAttributeNS(null,
"x",c.x-I),E.setAttributeNS(null,"y",c.y-I),E.setAttributeNS(null,"width",c.width+2*I),E.setAttributeNS(null,"height",c.height+2*I));(this.szFlag.match(/AUTOSIZE/)||this.szFlag.match(/GRIDSIZE/))&&c.width>c.height&&(E.setAttributeNS(null,"y",c.y-I-(c.width-c.height)),E.setAttributeNS(null,"height",c.width+2*I));"undefined"==typeof this.nBorderRadius||isNaN(this.nBorderRadius)||(I=Math.min(map.Scale.normalX(this.nBorderRadius),map.Scale.normalX(this.nBorderRadius*(c.width/map.Scale.normalX(b)))),E.setAttributeNS(null,
"rx",I),E.setAttributeNS(null,"ry",I));I=map.Scale.normalX(.2*(this.szBorderWidth||1)*(c.width/map.Scale.normalX(b)));E.style.setProperty("stroke-width",I);E.setAttributeNS(szMapNs,"boxed","1");SVGDocument.getElementById(this.szId+":"+g+":chartgroup").style.setProperty("display","inline")}}this.szItemFilter&&this.szItemFilter.length&&this.filterItems(this.szItemFilter,this.itemFilterOpt);null!=this.markedClass&&this.markClass(this.markedClass,1);this.isVisible=!0;this.realizeDone();this.fShowProgressBar=
!1;displayProgressBar(1,1,"",1,"",1);this.showInfo();this.szFlag.match(/SHOWSTATISTIC/)&&this.showErrorInfo();this.szFlag.match(/\bCLIP\b/)?this.nClipFrames==this.itemA[g].nValuesA.length?this.szXaxisA&&this.szXaxisA[this.nActualFrame]?displayMessage(this.szXaxisA[this.nActualFrame],3E3,"big"):this.szLabelA&&this.szLabelA[this.nActualFrame]&&displayMessage(this.szLabelA[this.nActualFrame],3E3,"big"):(b=this.szXaxisA||this.szLabelA)&&(0==this.nActualFrame?displayMessage(b[0],3E3,"big"):this.nActualFrame==
this.nClipFrames-1?displayMessage(b[1],3E3,"big"):displayMessage(" ... ",3E3,"big")):this.ErrorMessage?(displayMessage(this.ErrorMessage,1E4,"notify"),this.ErrorMessage=null):clearMessage();this.fSorted||(this.fResort=!0,map.Themes.execute());this.szFlag.match(/DECLUTTER/)&&this.declutterCharts()}else this.chartGroup&&this.chartGroup.style.setProperty("display","none",""),this.fVisible=!1,this.realizeDone();else this.chartGroup&&this.chartGroup.style.setProperty("display","none",""),this.fVisible=
!1,this.realizeDone()};
MapTheme.prototype.sortChartObjects=function(){if(!(!this.chartGroup||this.szFlag.match(/NOSRT/)||this.szFlag.match(/NOSIZE/)&&!this.szFlag.match(/3D/)||this.szFlag.match(/CATEGORICAL/)&&!this.szFlag.match(/AGGREGATE/)&&!this.szSizeField)){var e=null,b=[],f=this.chartGroup.childNodes;if(this.szFlag.match(/BUBBLE/)||this.szFlag.match(/SQUARE/)||this.szFlag.match(/BUFFER/)||this.szFlag.match(/TEXTONLY/))for(var c=0;c<f.length;c++)e=f.item(c),b[c]={node:e,y:Math.abs(Number(e.getAttributeNS(szMapNs,"value")))};
else for(var h=getRotateAttributeValue(map.Scale.canvasNode)/180*Math.PI,c=0;c<f.length;c++)e=f.item(c),b[c]=h?{node:e,y:getTranslate(e).x*Math.sin(h)+getTranslate(e).y*Math.cos(h)}:{node:e,y:getTranslate(e).y};this.szFlag.match(/\bSORT\b/)&&this.szFlag.match(/\bUP\b/)&&!this.szFlag.match(/SEQUENCE/)?b.sort(this.sortDownChartObjectsCompare):b.sort(this.sortUpChartObjectsCompare);for(c=0;c<b.length;c++)b[c].node.parentNode.appendChild(b[c].node);(matrixA=getMatrix(this.chartGroup))&&setMatrix(this.chartGroup,
matrixA)}};MapTheme.prototype.sortUpChartObjectsCompare=function(e,b){return e.y-b.y};MapTheme.prototype.sortDownChartObjectsCompare=function(e,b){return b.y-e.y};
MapTheme.prototype.getChartSize=function(e,b,f,c){if(f.match(/NOSIZE/))return Math.max(5,b/4);c=Math.abs(c);var h=Math.max(5,b/2),g=this.nMax-this.nMin;this.nNormalSizeValue&&(g=this.nMaxSize=this.nNormalSizeValue);var q=this.itemA[e].nValue100;f.match(/SIZE/)&&!f.match(/NORMSIZE/)&&this.szSizeField&&e&&this.itemA[e]?h=f.match(/LINEAR/)||f.match(/SIZEP1/)?h/this.nMaxSize*this.itemA[e].nSize:f.match(/SIZELOG/)?Math.max(1,h/Math.log(this.nMaxSize)*Math.log(this.itemA[e].nSize)):f.match(/SIZEP4/)?h/
Math.pow(this.nMaxSize,.25)*Math.pow(this.itemA[e].nSize,.25):f.match(/3D/)||f.match(/SIZEP3/)||f.match(/SIZEVOLUME/)?h/Math.pow(this.nMaxSize,1/3)*Math.pow(this.itemA[e].nSize,1/3):h/Math.sqrt(this.nMaxSize)*Math.sqrt(this.itemA[e].nSize):f.match(/SIZE/)&&!f.match(/NORMSIZE/)&&(h=f.match(/LINEAR/)||f.match(/SIZEP1/)?h/g*c:f.match(/SIZELOG/)?Math.max(1,h/Math.log(g)*Math.log(c)):f.match(/SIZEP4/)?h/Math.pow(g,.25)*Math.pow(c,.25):f.match(/3D/)||f.match(/SIZEP3/)||f.match(/SIZEVOLUME/)?h/Math.pow(g,
1/3)*Math.pow(c,1/3):h/Math.sqrt(g)*Math.sqrt(c));map.Scale.normalX(10);f.match(/HEIGHT/)&&!f.match(/NORMSIZE/)&&(f.match(/SIZE/)?this.szSizeField&&e&&this.itemA[e]?Math.pow(10/g*this.itemA[e].nSize,1/3):Math.pow(10/g*c,1/3):q&&this.nMax100&&this.nMin100&&f.match(/FRACTION/));f.match(/ZOOM/)&&(this.origSize=h*=map.Scale.nObjectScaling,h=b/10+1*h/(Math.log(Math.abs(g))*Math.log(Math.abs(c))||1),h=Math.min(h,b),h=Math.max(h,b/5));return h};
MapTheme.prototype.checkChartSize=function(e,b,f,c){return this.nChartSizeMin&&!f.match(/ZOOM/)&&this.getChartSize(e,b,f,c)/map.Layer.nObjectScale<this.nChartSizeMin?!1:!0};
MapTheme.prototype.drawChart=function(e,b,f,c,h){var g=null,q=0,l=0;this.szChartFlag=c;if(b){if(!this.itemA[b])return null;this.itemA[b].fDone=!1;var g=this.itemA[b].nValuesA,q=this.itemA[b].nValue100,l=Math.max(this.nMax,Math.abs(this.nMin)),r=0;if(!this.szFlag.match(/BUFFER/))for(var k=0;k<g.length;k++)isNaN(g[k])&&(g[k]=0),r+=g[k];if(this.szFlag.match(/MORPH/)&&this.szFlag.match(/\bCLIP\b/)&&this.nClipFrames){for(var g=[],w=this.itemA[b].nValuesA,k=0;k<w.length/2;k++){var m=w[k]*(this.nClipFrames-
1-this.nActualFrame)/(this.nClipFrames-1)+w[k+w.length/2]*this.nActualFrame/(this.nClipFrames-1);g[k]=m}for(k=r=0;k<g.length;k++)isNaN(g[k])&&(g[k]=0),r+=g[k]}if(c.match(/NOPE/))return new point(0,0);if(c.match(/DOT/)){var x=1,m=g[0];if(c.match(/CATEGORICAL/))this.chart.szColor=this.colorScheme[m];else if(2<this.colorScheme.length||this.szRanges&&this.szRanges.length)for(ub=!1,k=0;k<this.partsA.length;k++)if(m<this.partsA[k].max){this.chart.szColor=this.colorScheme[k];var v=__maptheme_getChartColors(A);
c.match(/NOLINES/)?this.chart.szLineColor="none":this.chart.szLineColor=v.textColor;c.match(/RANGE/)&&!c.match(/RANGES/)&&(x=map.Scale.normalX(2+5*(k+1)/this.partsA.length));Q=k;ub=!0;break}D=map.Dom.newShape("circle",e,0,0,map.Scale.normalX(3),"fill:"+this.chart.szColor+";stroke:none;");return new point(0,0)}}else{g=[];r=0;c=c||this.szFlag+"|XAXIS";if(this.szOrigFlag.match(/CATEGORICAL/))if(this.szOrigFlag.match(/SUM/))for(k=0;k<this.colorScheme.length;k++)this.partsA[k]&&(g[k]=this.partsA[k].nSum,
l=Math.max(l,this.partsA[k].nSum),r+=g[k]);else if(this.szOrigFlag.match(/COUNT/))for(k=0;k<this.colorScheme.length;k++)g[k]=100*this.partsA[k].nSum,l=Math.max(l,100*this.partsA[k].nSum),r+=g[k];else for(k=0;k<this.colorScheme.length;k++)g[k]=this.nOrigSumA[k]||this.exactCountA[k]||1,l=Math.max(l,this.nOrigSumA[k]||this.exactCountA[k]||1);else if(this.szOrigFlag.match(/COUNT/))for(k=0;k<this.colorScheme.length;k++)g[k]=this.partsA[k].nCount,l=Math.max(l,this.partsA[k].nCount),r+=g[k];else for(k=0;k<
this.colorScheme.length;k++)g[k]=this.partsA[k].nSum,l=Math.max(l,this.partsA[k].nSum),r+=g[k];if(q=this.nSum100){l=0;r=q;for(k=g.length-1;0<=k;k--)this.szFlag.match(/DIFFERENCE/)?q=0<k?g[k-1]:this.nSum100:this.szFlag.match(/CALCVAL/)||this.szFlag.match(/CALC100/)?g[k]=g[k]:this.szFlag.match(/PRODUCT/)?g[k]=g[k]:(g[k]/=q,l=Math.max(l,g[k]),this.szFlag.match(/PERMILLE/)?g[k]*=1E3:this.szFlag.match(/FRACTION/)||(g[k]*=100),this.szFlag.match(/RELATIVE/)&&(g[k]-=100),this.szFlag.match(/INVERT/)&&(g[k]=
100-g[k]));if(this.szFlag.match(/STACKED/)){if(l=100,this.szFlag.match(/NORMSIZE/)||c.match(/NORMSIZE/))for(k=l=0;k<g.length;k++)l+=g[k]}else l*=100,l+=l/10,l=this.nMax}else{if(this.szFlag.match(/DIFFERENCE/))for(k=g.length-1;0<=k;k--)0<k?g[k]-=g[k-1]:this.szFlag.match(/STACKED/)||(g[k]=0);if(b&&this.szAggregation&&this.szAggregation.match(/mean/)){for(k=0;k<g.length;k++)g[k]/=this.nCount;l=this.szFlag.match(/MENUSIZE/)?l/this.nCount:this.nMax}if(this.szFlag.match(/MEAN/))for(k=0;k<g.length;k++)g[k]/=
this.partsA[k].nCount;if(this.szFlag.match(/STACKED/)&&(this.szFlag.match(/NORMSIZE/)||c.match(/NORMSIZE/)||this.szFlag.match(/MENUSIZE/)||c.match(/MENUSIZE/)))for(k=l=0;k<g.length;k++)l+=g[k]}}x=b?this.getChartSize(b,f,c,r):1;if(this.nChartSizeMin&&!c.match(/ZOOM/)){if(x/map.Layer.nObjectScale<this.nChartSizeMin)return null}else if(!(this.szFlag.match(/MULTIFIX/)||this.szFlag.match(/MULTIGRID/)||this.szFlag.match(/MULTIQUAD/)||!isNaN(x)&&0!=x))return null;var z=new point(0,0);if(!c)c=this.szFlag;
else if(!c.match(/CHART/)&&c.match(/VALUES/)||c.match(/NORMSIZE/)||c.match(/MENUSIZE/))c=this.szFlag+"|"+c;c.match(/DOMINANT|COMPOSE/)&&!c.match(/CHART/)&&(c=c.match(/PERCENTOFMEAN/)?"BAR|OFFSETMEAN|POINTER|VALUES|ZOOM":c.match(/PERCENTOFMEDIAN/)?"BAR|OFFSETMEDIAN|POINTER|VALUES|ZOOM":c.match(/DEVIATION/)?"BAR|DEVIATION|POINTER|VALUES|ZOOM":"BAR|3D|VALUES|ZOOM");c.match(/ZOOM/)&&c.match(/BAR/)&&c.match(/POINTER/)&&1<g.length&&(c=this.removeDefinition(c,"SIZE")+"|COMPRESSMAX");if(1==g.length&&0==g[0]&&
!c.match(/ZEROISVALUE/)&&!c.match(/CATEGORICAL/))return this.nZeroValueCount++,null;c.match(/VALUES/)&&(this.fHideValues=this.szValueUpper&&map.Scale.nTrueMapScale*map.Scale.nZoomScale>this.nValueUpper,c.match(/ZOOM/)&&c.match(/PIE/)&&10<g.length&&(c=this.removeDefinition(c,"VALUES")));var y=map.Dom.newGroup(e,this.szId+":"+b+(b?":chartgroup":":ochrtgroup")),J=null,C=null;c.match(/MOVABLE/)&&(y.setAttributeNS(null,"id",y.getAttributeNS(null,"id")+":movable"),y.setAttributeNS(null,"onmousedown",'map.Themes.initChartOffset(evt,"'+
this.szId+'","'+this.szId+":"+b+':chartgroup:movable")'),y.setAttributeNS(null,"onmouseup",'map.Themes.endChartOffset(evt,"'+this.szId+'","'+this.szId+":"+b+':chartgroup:movable")'));if(c.match(/CHOROPLETH/)){var F=map.Scale.normalX(f/2),u=2*F/3,A=this.colorScheme[0],E=this.colorScheme[1]?this.colorScheme[1]:"none",I=map.Scale.normalX(.1)*map.Scale.nFeatureScaling*map.Scale.nObjectScaling,D=map.Dom.constructNode("use",y,{"xlink:href":"#choropleth_icon"});D.fu.scale(2,2);f=2*u/map.Scale.normalX(1);
z.x=0;z.y=u+map.Scale.normalY(5)}if(c.match(/BLANK/))return null;if(c.match(/USER/))try{u=map.Scale.normalX(f);c.match(/GRIDSIZE/)&&(u=this.nGridSize);var O=this.objThemesA[this.szThemesA[0]],Oa={target:y,theme:this,item:this.itemA[b],values:g,maxSize:u,flag:c,mark:h,dbRecord:O.dbRecords?O.dbRecords[this.itemA[b].dbIndex]:null};this.ptNullUser=null;this.userDraw?(this.opt=Oa,eval("this.ptNullUser = HTMLWindow.ixmaps."+this.userDraw+"(SVGDocument,this.opt);"),delete this.opt):this.ptNullUser=HTMLWindow.ixmaps.htmlgui_drawChart(SVGDocument,
Oa);if(this.ptNullUser)return y.fu.setPosition(y.fu.getPosition().x-ptNullUser.x,y.fu.getPosition().y-ptNullUser.y),this.ptNullUser.x=0,this.ptNullUser.y=0,this.ptNullUser;this.userChartDrawError=(this.userChartDrawError||0)+1}catch(ca){}if(c.match(/PIE/)){if(0==r&&!c.match(/AUTOCOMPLETE/))return null;if(c.match(/\bSORT\b/)){this.sortedIndex=[];for(k=0;k<g.length;k++)this.sortedIndex[k]={index:k,value:g[k]};this.sortedIndex.sort(this.sortIndexDown)}else this.sortedIndex=null;if(c.match(/\bREVERSE\b/))for(this.sortedIndex=
[],k=0;k<g.length;k++)this.sortedIndex[k]={index:g.length-k,value:g[k]};if(c.match(/CENTER/)){for(var ra=this.nCenter=0,ya=-Number.MAX_VALUE,Qc=Number.MAX_VALUE,ua=0;ua<(this.nClipParts||g.length);ua++){var ga=this.sortedIndex?this.sortedIndex[ua].index:ua,ra=ra+g[ga];g[ga]<Qc&&(Qc=g[ga],this.nCenterMin=ga);g[ga]>ya&&(ya=g[ga],this.nCenterMax=ga)}this.szCenterPart=this.szCenterPart||"max","first"==this.szCenterPart?this.nCenter=0:"last"==this.szCenterPart?this.nCenter=g.length-1:"min"==this.szCenterPart?
this.nCenter=this.nCenterMin:"max"==this.szCenterPart?this.nCenter=this.nCenterMax:Number(this.szCenterPart)&&(this.nCenter=Number(this.szCenterPart));this.nCenterValue=g[this.nCenter];this.nCenterSize=this.nCenterValue/ra*100}var va=0,x=Math.max(5,f/2),Da=this.nMax-this.nMin,Xb=this.nMax100-this.nMin100;this.nNormalSizeValue&&(Da=Xb=this.nNormalSizeValue);c.match(/GRIDSIZE/)&&!c.match(/NORMSIZE/)?x=this.nGridSize/f*(c.match(/\bRECT\b/)?.72:.6):c.match(/SIZE/)&&!c.match(/NORMSIZE/)&&this.szSizeField&&
b&&this.itemA[b]?x=c.match(/SIZELOG/)?Math.max(1,x/Math.log(this.nMaxSize)*Math.log(this.itemA[b].nSize)):c.match(/SIZEP4/)?x/Math.pow(this.nMaxSize,.25)*Math.pow(this.itemA[b].nSize,.25):c.match(/3D/)||c.match(/SIZEP3/)||c.match(/SIZEVOLUME/)?x/Math.pow(this.nMaxSize,1/3)*Math.pow(this.itemA[b].nSize,1/3):x/Math.sqrt(this.nMaxSize)*Math.sqrt(this.itemA[b].nSize):c.match(/SIZE/)&&!c.match(/NORMSIZE/)&&(x=c.match(/SIZELOG/)?Math.max(1,x/Math.log(Da)*Math.log(r)):c.match(/SIZEP4/)?x/Math.pow(Da,.25)*
Math.pow(r,.25):c.match(/3D/)||c.match(/SIZEP3/)||c.match(/SIZEVOLUME/)?x/Math.pow(Da,1/3)*Math.pow(r,1/3):x/Math.sqrt(Da)*Math.sqrt(r));va=map.Scale.normalX(10);c.match(/HEIGHT/)&&!c.match(/NORMSIZE/)&&(va=c.match(/SIZE/)?this.szSizeField&&b&&this.itemA[b]?va*Math.pow(10/Da*this.itemA[b].nSize,1/3)*3:va*Math.pow(10/Da*r,1/3)*3:q&&this.nMax100&&this.nMin100&&!c.match(/FRACTION/)?10*va/Xb*q:10*va/Da*r);c.match(/ZOOM/)&&(this.origSize=x*=map.Scale.nObjectScaling,x=f/10+3*x/Math.log(Da)*Math.log(r)*
map.Layer.nDynamicObjectScale,x=Math.min(x,1.2*f),x=Math.max(x,f/2));var S=DonutCharts.newChart(SVGDocument,y,0,0,map.Scale.normalX(x),0);z.x=0;z.y=map.Scale.normalY(x)+map.Scale.normalY(5);S.setStyle("flat");S.setLine("#555566");S.setLineWidth(map.Scale.normalX(this.nLineWidth||.1));c.match(/NOLINES/)&&S.setLine("none");c.match(/WHITELINES/)&&S.setLine("white");this.szLineColor&&S.setLine(this.szLineColor);if(c.match(/3D/)){S.setStyle("3D");var ka=.5;c.match(/P3/)?ka=1/3:c.match(/P4/)&&(ka=.25);
c.match(/SIZE/)&&!c.match(/NORMSIZE/)&&this.szSizeField&&b&&this.itemA[b]?va=va/Math.pow(this.nMaxSize,ka)*Math.pow(this.itemA[b].nSize,ka):c.match(/SIZE/)&&!c.match(/NORMSIZE/)&&(va=va/Math.pow(Da,ka)*Math.pow(r,ka));c.match(/ZOOM/)&&(va*=map.Scale.nObjectScaling,va=va/this.origSize*x);z.y*=.7}c.match(/VOLUME/)&&S.addStyle("VOLUME");if(c.match(/DONUT/))c.match(/3D/)?S.setRadInner(map.Scale.normalX(.5*x)):c.match(/XTHIN/)?S.setRadInner(map.Scale.normalX(.95*x)):c.match(/THIN/)?S.setRadInner(map.Scale.normalX(.66*
x)):c.match(/THICK/)?S.setRadInner(map.Scale.normalX(.25*x)):S.setRadInner(map.Scale.normalX(.42*x));else if(c.match(/CENTER/)){var md=Math.sqrt(Math.pow(map.Scale.normalX(x),2)/100*this.nCenterSize);S.setRadInner(md)}c.match(/STARBURST/)&&(S.addStyle("STARBURST"),z.y*=.8);if(c.match(/XLFLOWER/)||c.match(/XLRAYS/))S.addStyle("XLRAYS"),z.y*=.8;else if(c.match(/LFLOWER/)||c.match(/LRAYS/))S.addStyle("LRAYS"),z.y*=.8;else if(c.match(/XSFLOWER/)||c.match(/XSRAYS/))S.addStyle("XSRAYS"),z.y*=.8;else if(c.match(/SFLOWER/)||
c.match(/SRAYS/))S.addStyle("SRAYS"),z.y*=.8;else if(c.match(/FLOWER/)||c.match(/RAYS/))S.addStyle("RAYS"),z.y*=.8;c.match(/SILENT/)&&S.addStyle("SILENT");c.match(/AUTOCOMPLETE/)&&S.addStyle("AUTOCOMPLETE");c.match(/BIGTOTOP/)&&S.addStyle("BIGTOTOP");c.match(/NOROTATE/)&&S.addStyle("NOROTATE");c.match(/ROTATE/)&&S.addStyle("ROTATE");c.match(/SYMMETRIC/)&&S.addStyle("SYMMETRIC");c.match(/HALF/)&&(S.addStyle("HALF"),S.addStyle("NOROTATE"));c.match(/DIRECTION/)&&S.addStyle("DIRECTION");c.match(/POLAR/)&&
S.addStyle("POLAR");var Pa=0,Rc=0,K=0;if(c.match(/DONUT/))for(k=0;k<g.length;k++)g[k]>g[Pa]&&(Pa=k),g[k]<g[Rc]&&(Rc=k);if(c.match(/STARBURST/)){for(k=0;k<g.length;k++)g[k]=Math.max(g[k],0),K=Math.max(K,this.nMaxA[k]);c.match(/\bSIZE\b/)?S.setMaxValue(this.nMaxValue||K):S.setMaxValue(this.nNormalSizeValue||this.nMaxValue||K)}for(k=0;k<(this.nClipParts?Math.min(this.nClipParts,g.length):g.length);k++){var oa="",ga=k;this.sortedIndex&&(ga=this.sortedIndex[ga].index);if(!c.match(/CENTER/)||c.match(/DONUT/)||
ga!=this.nCenter){oa=this.szLabelA&&this.szLabelA[ga]?"  "+this.szLabelA[ga]:"  "+this.szFieldsA[ga];A=b?this.itemA[b].szColor||this.colorScheme[ga]:this.colorScheme[ga];if(1==g.length)for(Ba=0;Ba<this.partsA.length;Ba++)if(c.match(/CATEGORICAL/)&&g[ga]==this.partsA[Ba].min||!c.match(/CATEGORICAL/)&&g[ga]<this.partsA[Ba].max){A=this.colorScheme[Ba];e.setAttributeNS(szMapNs,"class",String(Ba));break}var nd=(c.match(/AUTOCOMPLETE/)&&!this.szUnit.match(/%/)?" % ":"")+this.szUnit;if(this.szShowParts){var od=
A,A="none";for(ua in this.szShowPartsA)this.szShowPartsA[ua]==ga&&(A=od)}if(0<g[ga]||0==g[ga]&&!c.match(/ZEROISNOTVALUE/)){var Sc=S.addPart(g[ga],va,A,0,(this.szAggregation&&this.szAggregation.match(/sum/),this.formatValue(g[ga],this.szValueDecimals||(1>g[ga]?2:0),"ROUND")+nd),oa);Sc.nClass=ga;if(c.match(/DIRECTION/)){var pc=this.itemA[b].ptPos,qc=this.getNodePosition(this.szThemesA[0]+"::"+this.szLabelA[ga]);if(pc&&qc){var pd=Math.atan2(pc.y-qc.y,qc.x-pc.x)*(180/Math.PI);Sc.nAngle=(450-pd)%360}}}"none"==
this.colorScheme[k]&&S.setLine(this.szLineColor||"black")}}2>S.partsA.length&&1==this.itemA[b].nCount&&(S.nRadInner=0,S.nRadOuter*=.85);S.realize();if(c.match(/CENTER/)&&!c.match(/DONUT/)){var u=Math.sqrt(Math.pow(map.Scale.normalX(x),2)/100*this.nCenterSize),A=this.colorScheme[this.nCenter],rc=map.Dom.newShape("circle",y,0,0,.95*u,"fill:"+A+";");rc&&(rc.setAttributeNS(szMapNs,"class",String(this.nCenter)),rc.setAttributeNS(szMapNs,"tooltip",this.szLabelA?this.szLabelA[this.nCenter]+": "+g[this.nCenter]+
this.szUnit+"":g[this.nCenter]+this.szUnit));if(c.match(/CENTERVALUE/)||c.match(/ZOOM/)||c.match(/VALUES/)&&!this.fHideValues){var V=this.formatValue(this.nCenterValue,this.szValueDecimals||0,"ROUND")+(5>=this.szUnit.length?this.szUnit:""),v=__maptheme_getChartColors(A),pa=v.textColor,T=String(Math.min(.8*u,3.3/V.length*u)*this.nValueScale),Tc=map.Dom.newText(y,0,.33*T,"font-family:arial;font-size:"+T+"px;font-weight:bold;text-anchor:middle;fill:"+pa+";opacity:"+String(this.nOpacity?this.nOpacity:
1)+";stroke:none;pointer-events:none",V);Tc&&Tc.setAttributeNS(szMapNs,"class",String(this.nCenter))}}else if(c.match(/CENTERVALUE/)){var V=String(this.itemA[b].nCount||this.itemA[b].nSize),pa=this.szTextColor||"#888888",u=map.Scale.normalX(x),T=String(Math.min(.5*u,2/V.length*u)),ta=this.nValueSizeMin?T/map.Scale.normalX(5):1;map.Dom.newText(y,0,.35*T,"font-family:arial;font-size:"+T+"px;text-anchor:middle;fill:none;stroke:black;stroke-width:"+T/40+";stroke-opacity:0.5;pointer-events:none;stroke-linejoin:bevel;",
V);var H=map.Dom.newText(y,0,.35*T,"font-family:arial;font-size:"+T+"px;text-anchor:middle;fill:"+pa+";opacity:"+ta+";stroke:none;pointer-events:none",V)}c.match(/VALUES/)&&(c.match(/ZOOM/)||!this.szValueUpper||map.Scale.nTrueMapScale*map.Scale.nZoomScale<=this.nValueUpper)&&(T=Math.min(.8*x,3.4/(S.partsA[0]?S.partsA[0].szText.length:1)*x),1<g.length||c.match(/NOINLINETEXT/)||c.match(/ZOOM/)&&6>T?(T=c.match(/ZOOM/)||c.match(/NORMSIZE/)?map.Scale.normalX(8):map.Scale.normalX(5*(this.nValueScale||1)),
this.drawDonutText(S,T)):(V=S.partsA[0]?S.partsA[0].szText:"",v=__maptheme_getChartColors(A),pa=this.szTextColor||v.textColor,u=map.Scale.normalX(x),T=String(Math.min(.8*u,3.4/V.length*u)),ta=this.nValueSizeMin?T/map.Scale.normalX(5):1,c.match(/VOLUME/)&&(va=S.donutPartsA[0].nHeight),c.match(/3D/)||(va=.6*u),H=map.Dom.newText(y,0,-va+u/2+.45*T,"font-family:arial;font-size:"+T+"px;text-anchor:middle;fill:"+pa+";opacity:"+ta+";stroke:none;pointer-events:none",V),c.match(/3D/)&&(H.fu.setPosition(0,-u/
2+T*(c.match(/VOLUME/)?.5:.25)),H.fu.scale(1,.5))));this.fillOpacity&&y.setAttributeNS(null,"fill-opacity",String(this.fillOpacity));this.nOpacity&&(y.setAttributeNS(null,"fill-opacity",String(this.nOpacity)),y.setAttributeNS(null,"stroke-opacity",String(this.nOpacity)));if(c.match(/FADEDEVIATION/)){var Yb=(g[0]-this.nMeanA[0])/this.nDeviationA[0];10<Yb&&(ta=Math.pow(10,.5)/Math.pow(Yb,.5),y.setAttributeNS(null,"opacity",String(ta)))}else c.match(/LIMITDEVIATION/)&&(Yb=(g[0]-this.nMeanA[0])/this.nDeviationA[0],
10<Yb&&y.setAttributeNS(null,"opacity","0"));c.match(/ZOOM/)&&c.match(/STARBURST/);if(1==g.length&&c.match(/CATEGORICAL/))S.donutPartsA[0]&&(S.donutPartsA[0].objNode.setAttributeNS(szMapNs,"class",e.getAttributeNS(szMapNs,"class")),S.donutPartsA[0].textNode&&S.donutPartsA[0].textNode.setAttributeNS(szMapNs,"class",e.getAttributeNS(szMapNs,"class")));else for(k=0;k<S.donutPartsA.length;k++)S.donutPartsA[k]&&(S.donutPartsA[k].objNode.setAttributeNS(szMapNs,"class",String(S.partsA[k].nClass)),S.donutPartsA[k].textNode&&
S.donutPartsA[k].textNode.setAttributeNS(szMapNs,"class",String(S.partsA[k].nClass)));this.nRealizedCount++}else if(c.match(/WAFFLE/)){var Ea=map.Scale.normalX(f);if(c.match(/GRIDSIZE/))Ea=1.05*this.nGridSize;else if(c.match(/AUTOSIZE/))var jb=map.Layer.nDynamicObjectScale,kb=c.match(/\bRECT\b/)?c.match(/GAP/)?2.3:2:c.match(/GAP/)?1.7:1.6,K=Math.max(lb,this.nMax),Ea=this.nGridWidthPx?map.Scale.normalX(this.nGridWidthPx)/kb/jb:this.nGridWidth?map.Scale.getDeltaXofDistanceInMeter(this.nGridWidth)/kb/
jb:F,Ea=Ea/Math.sqrt(this.nMaxSize)*Math.sqrt(this.itemA[b].nSize);Ea*=.97;D=map.Dom.newShape("rect",y,-(Ea/2)+10,-(Ea/2)+10,Ea-20,Ea-20,"fill:"+(this.szBoxColor||"back")+";stroke:"+(this.szBorderColor||"none")+";stroke-width:"+(this.szBorderWidth||2)+";fill-opacity:"+(this.nBoxOpacity||.05)+";opacity:1;");Ea*=.9;if(c.match(/\bSORT\b/)){this.sortedIndex=[];for(k=0;k<g.length;k++)this.sortedIndex[k]={index:k,value:g[k]};this.sortedIndex.sort(this.sortIndexDown)}else this.sortedIndex=null;var l=Math.max(this.nMax,
Math.abs(this.nMin)),sc=this.nGridX||(c.match(/WAFFLE100/)?10:Math.max(5,Math.round(Math.sqrt(l))));c.match(/AUTO100/)&&(sc=10);var Ib=Ea/(1.1*sc),Ba=-Ea/2,Xa=Ea/2,Uc=0,Zb=1E5;c.match(/WAFFLE100/)&&(Zb=100);for(k=0;k<g.length;k++){var Ta=this.sortedIndex?this.sortedIndex[k].index:k;g[Ta]=Math.round(g[Ta]);if(g[Ta])for(var qd=Math.min(g[Ta],Zb),Zb=Zb-g[Ta],ha=0;ha<qd;ha++)D=map.Dom.newShape("rect",y,Ba,Xa-Ib,Ib,Ib,"fill:"+this.colorScheme[Ta]+";stroke:null;fill-opacity:"+(this.fillOpacity||1)+";opacity:"+
(this.nOpacity||1)+";"),D.setAttributeNS(szMapNs,"class",String(Ta)),D.setAttributeNS(szMapNs,"tooltip",this.szLabelA?this.szLabelA[Ta]+": "+g[Ta]+this.szUnit+"":g[Ta]+this.szUnit),Ba+=1.1*Ib,++Uc>=sc&&(Ba=-Ea/2,Xa-=1.1*Ib,Uc=0)}this.nRealizedCount++}else if(c.match(/BUBBLE/)||c.match(/SQUARE/)||c.match(/LABEL/)){F=map.Scale.normalX(f/2);c.match(/AUTOSIZE/)&&(jb=map.Layer.nDynamicObjectScale,kb=c.match(/\bRECT\b/)?c.match(/GAP/)?2.3:2:c.match(/GAP/)?1.7:1.6,K=Math.max(lb,this.nMax),F=this.nGridWidthPx?
map.Scale.normalX(this.nGridWidthPx)/kb/jb:this.nGridWidth?map.Scale.getDeltaXofDistanceInMeter(this.nGridWidth)/kb/jb:F);K=Math.max(this.nMax,this.nMaxA[0]);this.nNormalSizeValue&&(this.nMaxSize=K=this.nNormalSizeValue);m=g[0];if(this.szFlag.match(/\bCLIP\b/)&&!this.szFlag.match(/MORPH/)&&this.nClipFrames&&(this.nClipFrames==g.length?(m=Number(g[this.nActualFrame]),K=this.nNormalSizeValue||this.nMaxA[this.nActualFrame]):m=g[0]*(this.nClipFrames-1-this.nActualFrame)/(this.nClipFrames-1)+g[g.length-
1]*this.nActualFrame/(this.nClipFrames-1),0==m&&!c.match(/ZEROISVALUE/))||c.match(/INVERTSIZE/)&&0==K-g[0]&&!c.match(/ZEROISVALUE/))return null;var mb=b&&this.itemA[b]&&this.szSizeField?this.itemA[b].nSize||0:m,Ab=b&&this.itemA[b]&&this.szSizeField?this.nMaxSize:K;if(0==mb&&!c.match(/NOSIZE/)||this.nMinValue&&mb<this.nMinValue)return null;var u=c.match(/MENUSIZE/)?map.Scale.normalX(f/2.5):c.match(/LINEAR/)||c.match(/SIZEP1/)?F/Ab*Math.abs(mb):c.match(/SIZEP3/)?F/Math.pow(Ab,1/3)*Math.pow(Math.abs(mb),
1/3):c.match(/SIZEP4/)?F/Math.pow(Ab,.25)*Math.pow(Math.abs(mb),.25):c.match(/SIZELOG/)?Math.max(20,F/Math.log(Ab)*Math.log(Math.abs(mb))):c.match(/CATEGORICAL/)&&!this.szSizeField?F/3/(this.nNormalSizeValue||1):c.match(/NOSIZE/)?F/2:c.match(/FIXSIZE/)?F/2/(this.nNormalSizeValue||1):c.match(/ZOOM/)?3*F/3:c.match(/NORMSIZE/)?2*F/3/(c.match(/CATEGORICAL/)?1:Math.log(Ab)*Math.log(Math.abs(mb))):c.match(/MENUSIZE/)||c.match(/SUM/)&&!b?2*F/3:F/Math.sqrt(Ab)*Math.sqrt(Math.abs(mb)),ub=!0,Q=null,la=D=null,
Ua=null,vb=null,Qa=H=null,Ya=null,A=this.colorScheme[0],E=this.colorScheme[1]?this.colorScheme[1]:"none",pa=this.colorScheme[1]?this.colorScheme[1]:"white";if(2<this.colorScheme.length||c.match(/CATEGORICAL/))A=this.colorScheme[this.colorScheme.length-1],E=this.colorScheme[0];c.match(/NOLINES/)?E="none":"none"==E&&(v=__maptheme_getChartColors(A),E=v.lowColor);if(c.match(/CATEGORICAL/))Q=m-1,A=this.colorScheme[Q]||this.colorScheme[0],v=__maptheme_getChartColors(A),pa=v.textColor,E=c.match(/NOLINES/)?
"none":v.lowColor,c.match(/RANGE/)&&!c.match(/RANGES/)&&(u=map.Scale.normalX(2+5*(k+1)/this.partsA.length)),ub=!0;else if(this.szFlag.match(/COMPOSECOLOR/))this.szFlag.match(/SUBTRACTIVE/)?this.itemA[b].szColor=__maptheme_getComposedColor_subtractive(this.itemA[b].nValuesA,this.colorScheme,this.nMax,Math.floor(255*this.nBrightness)):this.itemA[b].szColor=__maptheme_getComposedColor_additive(this.itemA[b].nValuesA,this.colorScheme,this.nMax,Math.floor(255*this.nBrightness));else if(2<this.colorScheme.length||
this.szRanges&&this.szRanges.length)if(ub=!1,this.szFlag.match(/DOMINANT/)){for(var Ja=0,Jb=0,M=-1,k=0;k<this.itemA[b].nValuesA.length;k++){var m=this.itemA[b].nValuesA[k],tc=100/this.nMeanA[k]*m,uc=100/this.nMedianA[k]*m,vc=(m-this.nMeanA[k])/this.nDeviationA[k],Ja=m;this.szFlag.match(/PERCENTOFMEAN/)&&(Ja=tc);this.szFlag.match(/PERCENTOFMEDIAN/)&&(Ja=uc);this.szFlag.match(/DEVIATION/)&&(Ja=vc);m>this.nFilterA[k]&&Ja>Jb&&(this.itemA[b].nClass=k,Jb=Ja,M=k)}if(0<=M){this.itemA[b].nDominant=M;m=this.itemA[b].nValuesA[M];
oa=" "+this.szFieldsA[M]+" ";this.szLabelA&&this.szLabelA[M]&&(oa=" "+this.szLabelA[M]+" ");if(this.szFlag.match(/PERCENTOFMEAN/)||this.szFlag.match(/DEVIATION/))szRelevanz=map.Dictionary.getLocalText(" ( mean: ")+this.formatValue(this.nMeanA[M],1)+this.szUnit+")";this.szFlag.match(/PERCENTOFMEDIAN/)&&(szRelevanz=map.Dictionary.getLocalText(" ( median: ")+this.formatValue(this.nMedianA[M],1)+this.szUnit+")");this.itemA[b].nValue=this.itemA[b].nValuesA[M];this.itemA[b].szLabel=oa;A=this.colorScheme[M];
v=__maptheme_getChartColors(A);pa=v.textColor;E=c.match(/NOLINES/)?"none":v.lowColor;Q=M;ub=!0}}else for(k=0;k<this.partsA.length;k++)if(m>=this.partsA[k].min&&m<this.partsA[k].max){A=this.colorScheme[k];v=__maptheme_getChartColors(A);pa=v.textColor;E=c.match(/NOLINES/)?"none":v.lowColor;c.match(/RANGE/)&&!c.match(/RANGES/)&&(u=map.Scale.normalX(2+5*(k+1)/this.partsA.length));Q=k;ub=!0;break}this.itemA[b].szColor=A;pa=this.szTextColor||pa;E=this.szLineColor||E;if(ub){I=this.nLineWidth||.1;I=c.match(/OUTLINE/)?
map.Scale.normalX(Math.min(1,1/F*u)):map.Scale.normalX(I/Math.sqrt(F)*Math.sqrt(u));if(c.match(/BUBBLE/)){var da=null,da="$item$"==this.szTimeField?(new Date(this.szFieldsA[M].split(" ")[0])).getTime():(new Date(this.itemA[b].szTime)).getTime();if(c.match(/GLOW/)&&!c.match(/ZOOM/)&&this.fGlowInScale){if(D=map.Dom.newShape("circle",y,0,0,6*u,"fill:"+A+";stroke:none;fill-opacity:0.05;pointer-events:none;"))D.setAttributeNS(szMapNs,"class",String(Q)),D.setAttributeNS(szMapNs,"time",da);if(D=map.Dom.newShape("circle",
y,0,0,2*u,"fill:"+A+";stroke:none;fill-opacity:0.1;pointer-events:none;"))D.setAttributeNS(szMapNs,"class",String(Q)),D.setAttributeNS(szMapNs,"time",da)}else c.match(/AURA/)&&!c.match(/ZOOM/)&&this.fGlowInScale&&(D=map.Dom.newShape("circle",y,0,0,1.3*u,"fill:"+(this.szLineColor||A)+";stroke:none;fill-opacity:0.3;"))&&(D.setAttributeNS(szMapNs,"class",String(Q)),D.setAttributeNS(szMapNs,"time",da));D=map.Dom.newShape("circle",y,0,0,u,"fill:"+A+";stroke:"+E+";stroke-width:"+I+";")}else if(c.match(/SQUARE/))D=
map.Dom.newShape("rect",y,-u,-u,2*u,2*u,"fill:"+A+";stroke:"+E+";stroke-width:"+I+";");else if(c.match(/TEXTONLY/))D=map.Dom.newShape("rect",y,-u,-8,2.05*u,8,"fill:none;stroke:none;");else if(c.match(/LABEL/)){V=this.formatValue(m,this.szValueDecimals||(1>m||1>=K?1:0),"ROUND")+(5>=this.szUnit.length?this.szUnit:"");0==m&&(this.szFlag.match(/DIFFERENCE/)||this.szFlag.match(/RELATIVE/))?V="+-"+V:0<m&&(this.szFlag.match(/DIFFERENCE/)||this.szFlag.match(/RELATIVE/))&&(V="+"+V);var Bb=Math.min(.8*u,3.4/
V.length*u);if(!this.fShadow&&this.fOrigShadow&&u>map.Scale.normalX(5)){if(D=map.Dom.newShape("rect",y,-u+.02*u,.83*-Bb+.02*u,2.05*u,1.6*Bb,"fill:#000000;stroke:none;opacity:"+.4*(this.fillOpacity?this.fillOpacity:1)))D.setAttributeNS(null,"rx",map.Scale.normalX(2*u/F)),D.setAttributeNS(null,"ry",map.Scale.normalX(2*u/F));if(D=map.Dom.newShape("rect",y,-u+.03*u,.83*-Bb+.03*u,2.05*u,1.6*Bb,"fill:"+A+";stroke:none;opacity:"+.2*(this.fillOpacity?this.fillOpacity:1)))D.setAttributeNS(null,"rx",map.Scale.normalX(2*
u/F)),D.setAttributeNS(null,"ry",map.Scale.normalX(2*u/F))}if(D=map.Dom.newShape("rect",y,-u,.83*-Bb,2.05*u,1.6*Bb,"fill:"+A+";stroke:"+E+";stroke-width:"+I+";"))D.setAttributeNS(null,"rx",map.Scale.normalX(2*u/F)),D.setAttributeNS(null,"ry",map.Scale.normalX(2*u/F))}if(D){c.match(/SILENT/)||(c.match(/CATEGORICAL/)&&this.szLabelA&&this.szLabelA[m-1]?D.setAttributeNS(szMapNs,"tooltip",this.szLabelA[m-1]+" "+this.szTitle+""):D.setAttributeNS(szMapNs,"tooltip",this.formatValue(m,2)+this.szUnit+" "+this.szTitle+
""));H=null;if(c.match(/VALUES/)&&(!this.szValueUpper||map.Scale.nTrueMapScale*map.Scale.nZoomScale<=this.nValueUpper))if(V=null,this.szValueField&&this.itemA[b].szValue?V=this.formatValue(__scanValue(this.itemA[b].szValue),this.szValueDecimals||(1>this.itemA[b].szValue?1:0),"ROUND")+(5>=this.szUnit.length?this.szUnit:""):c.match(/CATEGORICAL/)&&this.szLabelA?V=this.szLabelA[m-1]||"?":(V=this.formatValue(m,this.szValueDecimals||(1>m||1>=K?1:0),"ROUND")+(5>=this.szUnit.length?this.szUnit:""),0==m&&
(this.szFlag.match(/DIFFERENCE/)||this.szFlag.match(/RELATIVE/)||this.szFlag.match(/\bSIGN\b/))?V="+/-"+V:0<m&&(this.szFlag.match(/DIFFERENCE/)||this.szFlag.match(/RELATIVE/)||this.szFlag.match(/\bSIGN\b/))&&(V="+"+V)),T=String(Math.min(.8*u,3.3/V.length*u)*this.nValueScale),c.match(/TEXTONLY/)){v=__maptheme_getChartColors(A);pa=v.textColor;T=String(Math.max(Math.min(.8*u,map.Scale.normalX(500)),map.Scale.normalX(2)));if(this.nValueSizeMin&&!c.match(/ZOOM/)&&T*map.Layer.nDynamicObjectScale<map.Scale.normalX(this.nValueSizeMin))return null;
var Kb=this.szTextFont||"arial",Qa=map.Dom.newText(y,0,0,"font-family:"+Kb+";font-size:"+T+"px;font-weight:normal;text-anchor:middle;fill:none;stroke:"+A+";stroke-width:"+T/7+";stroke-opacity:0.5;pointer-events:none;stroke-linejoin:bevel;",V);Qa.setAttributeNS(null,"id",this.szId+":"+b+":text:bg");H=map.Dom.newText(y,0,0,"font-family:"+Kb+";font-size:"+T+"px;font-weight:normal;text-anchor:middle;fill:"+(this.szTextColor||"#000000")+";opacity:"+ta+";stroke:none;",V);H.setAttributeNS(null,"id",this.szId+
":"+b+":text");D.parentNode.removeChild(D)}else if(c.match(/ZOOM/)&&T<map.Scale.normalX(6))pa="black",H=map.Dom.newText(y,u+.1*F,-u/2,this.szValuesTextStyle,V);else if(c.match(/LABEL/)||T>map.Scale.normalX(1))ta=this.nValueSizeMin?T/map.Scale.normalX(5):1,H=map.Dom.newText(y,0,.33*T,"font-family:arial;font-size:"+T+"px;font-weight:bold;text-anchor:middle;fill:"+pa+";opacity:"+ta+";stroke:none;pointer-events:none",V);if(c.match(/DTEXT/)&&b&&!c.match(/ZOOM/)){var Za=Math.pow(Math.abs(u),1/3)/Math.pow(F,
1/3);D.style.setProperty("fill-opacity",String(Za),"");D.style.setProperty("stroke-opacity",String(Za),"");H&&H.style.setProperty("fill-opacity",String(Za),"")}else D.style.setProperty("fill-opacity",String(this.fillOpacity?this.fillOpacity:1),""),c.match(/OUTLINE/)||this.szLineColor?D.style.setProperty("stroke-opacity","1",""):D.style.setProperty("stroke-opacity",String(this.fillOpacity&&.5>this.fillOpacity?1:.3),"")}null!=Q&&(D&&(D.setAttributeNS(szMapNs,"value",String(m)),D.setAttributeNS(szMapNs,
"class",String(Q))),H&&(H.setAttributeNS(szMapNs,"value",String(m)),H.setAttributeNS(szMapNs,"class",String(Q))),Qa&&(Qa.setAttributeNS(szMapNs,"value",String(m)),Qa.setAttributeNS(szMapNs,"class",String(Q))));this.szTimeField&&(da=null,da="$item$"==this.szTimeField?(new Date(this.szFieldsA[M].split(" ")[0])).getTime():(new Date(this.itemA[b].szTime)).getTime(),D&&D.setAttributeNS(szMapNs,"time",da),H&&H.setAttributeNS(szMapNs,"time",da),Qa&&Qa.setAttributeNS(szMapNs,"time",da));f=2*u/map.Scale.normalX(1);
z.x=0;z.y=u+map.Scale.normalY(5);this.nRealizedCount++}else return this.nMissingRangeCount++,null}else if(c.match(/SYMBOL/)){if("undefined"!=typeof this.szSymbolBoxStyle){E="#dddddd";"undefined"!=typeof this.szBorderColor&&(E=this.szBorderColor);var Lb="stroke-width:0;";if("undefined"!=typeof this.szBorderStyle)switch(this.szBorderStyle){case "dotted":Lb="stroke-width:"+map.Scale.normalX(1)+";stroke-linecap:round;stroke-dasharray:1,50;";break;case "dashed":Lb="stroke-width:"+map.Scale.normalX(1)+
";stroke-linecap:butt;stroke-dasharray:30,30;";break;case "solid":Lb="stroke-width:"+map.Scale.normalX(1)+";";break;case "none":Lb="stroke-width:0;"}var wb=map.Dom.newShape("rect",y,0,0,1,1,"fill:white;stroke:"+E+";"+Lb);switch(this.szSymbolBoxStyle){case "frame":wb.setAttributeNS(null,"fill-opacity",0);break;case "field":wb.setAttributeNS(null,"fill-opacity",1)}}if(!this.szSymbolsA)for(this.szSymbolsA=[],k=0;k<g.length;k++)this.szSymbolsA.push("circle");else if(this.szSymbolsA.length<g.length)for(k=
this.szSymbolsA.length;k<g.length;k++)this.szSymbolsA.push(this.szSymbolsA[this.szSymbolsA.length-1]);var $a=null;c.match(/VALUES/)&&($a=map.Dom.newGroup(y,this.szId+":"+b+":textgroup"));this.initAngle=0;if(c.match(/\bSORT\b/))if(c.match(/\bBYMEAN\b/)){this.sortedIndex=[];for(k=this.sortedMax=0;k<g.length;k++)this.sortedIndex[k]={index:k,value:g[k],tvalue:g[k],mean:this.nMeanA[k]},this.sortedMax=Math.max(this.sortedMax,g[k]);this.sortedIndex.sort(this.sortMeanUp);this.initAngle=0}else if(c.match(/\bBYMEDIAN\b/)){this.sortedIndex=
[];for(k=this.sortedMax=0;k<g.length;k++)this.sortedIndex[k]={index:k,value:g[k],tvalue:g[k],mean:this.nMedianA[k]},this.sortedMax=Math.max(this.sortedMax,g[k]);this.sortedIndex.sort(this.sortMeanUp);this.initAngle=0}else if(c.match(/\bUP\b/)){this.sortedIndex=[];for(k=this.sortedMax=0;k<g.length;k++)this.sortedIndex[k]={index:k,value:g[k],tvalue:g[k]},this.sortedMax=Math.max(this.sortedMax,g[k]);this.sortedIndex.sort(this.sortIndexUp);this.initAngle=0}else if(c.match(/\bDOWN\b/)){this.sortedIndex=
[];for(k=this.sortedMax=0;k<g.length;k++)this.sortedIndex[k]={index:k,value:g[k],tvalue:g[k]},this.sortedMax=Math.max(this.sortedMax,g[k]);this.sortedIndex.sort(this.sortIndexDown);this.initAngle=0}else{if(c.match(/\bRANDOM\b/)){this.sortedIndex=[];this.sortedMax=0;if(this.nClipParts&&this.nClipParts<g.length){for(var wc=[],k=0;k<g.length;k++)wc[k]={index:k,value:g[k],tvalue:g[k]};wc.sort(this.sortIndexDown);for(k=0;k<this.nClipParts;k++){var xc=wc[k].index;this.sortedIndex[k]={index:xc,value:g[xc],
tvalue:g[xc]};this.sortedMax=Math.max(this.sortedMax,g[k])}}else for(k=0;k<g.length;k++)this.sortedIndex[k]={index:k,value:g[k],tvalue:g[k]},this.sortedMax=Math.max(this.sortedMax,g[k]);b?(this.itemA[b].randomA||(this.itemA[b].randomA=this.getRandomNumberArray(g.length+1)),this.shuffleArray(this.sortedIndex,this.itemA[b].randomA),this.initAngle=Math.floor(360*this.itemA[b].randomA[0])):this.initAngle=0}}else this.sortedIndex=null;if(c.match(/RINGS/)){if(this.sortedIndex)for(var Mb=0,k=0;k<this.sortedIndex.length;k++)this.sortedIndex[k].value&&
(this.sortedIndex[k].value+=Mb,Mb=this.sortedIndex[k].value);else for(Mb=0,this.sortedIndex=[],k=0;k<g.length;k++)this.sortedIndex[k]={index:k,value:g[k],tvalue:g[k]},this.sortedIndex[k].value&&(this.sortedIndex[k].value+=Mb,Mb=this.sortedIndex[k].value);this.sortedIndex.sort(this.sortIndexDown)}var $b=null,ac=null,bc=null,Q=0,Ra="",Vc=0,Ka=0,za=0,Ma=0,lb=-Number.MAX_VALUE,yc=Number.MAX_VALUE,Sa=0,zc=0,Wc=0,ab=!1,bb=0,Pa=g.length;this.nClipParts&&this.nClipParts<g.length&&(c.match(/\bUP\b/)?bb=g.length-
this.nClipParts:Pa=this.nClipParts);if(this.szFlag.match(/DOMINANT/)){for(var Jb=Ja=0,cc=-1,k=0;k<this.itemA[b].nValuesA.length;k++)m=this.itemA[b].nValuesA[k],tc=100/this.nMeanA[k]*m,uc=100/this.nMedianA[k]*m,vc=(m-(this.nMeanA[k]||0))/this.nDeviationA[k],Ja=m,this.szFlag.match(/PERCENTOFMEAN/)&&(Ja=tc),this.szFlag.match(/PERCENTOFMEDIAN/)&&(Ja=uc),this.szFlag.match(/DEVIATION/)&&(Ja=vc),m>(this.nFilterA[k]||0)&&Ja>Jb&&(this.itemA[b].nClass=k,Jb=Ja,cc=k);0<=cc&&(bb=this.itemA[b].nDominant=cc,Pa=
bb+1,Q=cc)}else this.szFlag.match(/COMPOSECOLOR/)&&(this.szFlag.match(/SUBTRACTIVE/)?this.itemA[b].szColor=__maptheme_getComposedColor_subtractive(this.itemA[b].nValuesA,this.colorScheme,this.nMax,Math.floor(255*this.nBrightness)):this.itemA[b].szColor=__maptheme_getComposedColor_additive(this.itemA[b].nValuesA,this.colorScheme,this.nMax,Math.floor(255*this.nBrightness)));for(k=bb;k<Pa;k++)zc+=0!=g[k],lb=Math.max(lb||this.nMaxA[k],this.nMaxA[k]),yc=Math.min(yc||this.nMinA[k],this.nMinA[k]),Sa=Math.max(Sa,
g[k]);if(this.szFlag.match(/STACKED/)&&this.nGridX)for(k=bb;k<Pa;){for(var Ac=0,ha=0;ha<this.nGridX;ha++)Ac+=g[k++];Sa=Math.max(Sa,Ac)}for(k=bb;k<Pa;k++){var M=k,m=g[M],Na=g[M];this.sortedIndex&&(m=this.sortedIndex[M].value,Na=this.sortedIndex[M].tvalue,M=this.sortedIndex[M].index);this.szValueField&&this.itemA[b]&&(Na=__scanValue(this.itemA[b].szValue));if(this.szShowParts){var Nb=!0;for(ua in this.szShowPartsA)this.szShowPartsA[ua]==M%(this.nGridX||1E6)&&(Nb=!1);if(Nb)continue}if(!c.match(/ZOOM/)||
!this.markedClasses||this.markedClasses[M]){Q=M;this.nGridX&&c.match(/PLOT/)&&(Q%=this.nGridX);if((c.match(/ZOOM/)||c.match(/NORMSIZE/))&&this.szLabelA)var Aa=this.formatValue(Na,1>Na?2:0),Ra=Aa+this.szUnit,Ra=Ra+(" "+this.szLabelA[M%(this.nGridX||1E7)]);else Aa=this.formatValue(Na,2),Ra=" "+Aa+this.szUnit;da=null;this.szTimeField&&(da="$item$"==this.szTimeField?(new Date(this.szFieldsA[M].split(" ")[0])).getTime():(new Date(this.itemA[b].szTime)).getTime());if(c.match(/CATEGORICAL/)&&!c.match(/AGGREGATE/)&&
!c.match(/GROUP/)){var Z="";if(this.nRangesA&&this.nRangesA.length)for(ha=0;ha<this.nRangesA.length;ha++)if(m==this.nRangesA[ha]||Number(m)==Number(this.nRangesA[ha])){Z=this.szSymbolsA[ha]||this.szSymbolsA[0]||"circle";Q=ha;break}Z=this.itemA[b].szSymbol||Z;Ra=String(m);oa=String(m);this.szLabelA&&this.szLabelA[Q]&&(Ra=this.szLabelA[Q],oa=this.szLabelA[Q]);Z.length||0!=M||(Z="empty",Ra=oa="no data",Q=0);if(Z.length){Vc++;D=null;Q="undefined"!=typeof this.itemA[b].nClass?this.itemA[b].nClass:Q;A=
"undefined"!=typeof this.itemA[b].szColor?this.itemA[b].szColor:this.colorScheme[Q];if(c.match(/NOLINES/))E="none";else if(E=this.itemA[b].szColor||this.colorScheme[Q],"white"==A||"#ffffff"==A)E="gray";E=this.szLineColor||E;if("circle"==Z||"square"==Z||"label"==Z||"carot"==Z||"diamond"==Z||"triangle"==Z||"hexagon"==Z||"cross"==Z||"empty"==Z){u=map.Scale.normalX(f/2);this.szSizeField&&b&&this.itemA[b]&&(u=u/Math.sqrt(this.nNormalSizeValue||this.nMaxSize)*Math.sqrt(this.itemA[b].nSize));F=map.Scale.normalX(f/
2);I=(this.nLineWidth||1)*map.Scale.normalX(Math.min(u/F,1));switch(Z){case "empty":D=map.Dom.newShape("circle",y,0,0,u,"fill:#888888;fill-opacity:0;stroke:#888888;stroke-width:"+I+";");break;case "circle":D=map.Dom.newShape("circle",y,0,0,u,"fill:"+A+";stroke:"+E+";stroke-width:"+I+";");break;case "square":D=map.Dom.newShape("rect",y,.8*-u,.8*-u,1.6*u,1.6*u,"fill:"+A+";stroke:"+E+";stroke-width:"+I+";");break;case "cross":var Fa=.4*u,wa=.8*u,D=map.Dom.newShape("path",y,"M 0,-"+(wa+Fa/2)+" l"+Fa/
2+",0 0,"+wa+" "+wa+",0 0,"+Fa+" -"+wa+",0 0,"+wa+" -"+Fa+",0 0,-"+wa+" -"+wa+",0 0,-"+Fa+" "+wa+",0 0,-"+wa+" "+Fa/2+",0 z","fill:"+A+";stroke:"+E+";stroke-width:"+I+";");break;case "diamond":case "carot":(D=map.Dom.newShape("rect",y,.8*-u,.8*-u,1.6*u,1.6*u,"fill:"+A+";stroke:"+E+";stroke-width:"+I+";"))&&D.setAttributeNS(null,"transform","rotate(45)");break;case "triangle":D=map.Dom.newShape("path",y,"M 0,"+u+" l"+1.2*u+",-"+2*u+" -"+2.4*u+",0 "+1.2*u+","+2*u+"z","fill:"+A+";stroke:"+E+";stroke-width:"+
I+";");break;case "hexagon":var Fa=u/2,wa=u*Math.sin(60/180*Math.PI),Ob=u,D=map.Dom.newShape("path",y,"M -"+u+",0 l "+Fa+",-"+wa+" "+Ob+",0 "+Fa+","+wa+" -"+Fa+","+wa+" -"+Ob+",0 -"+Fa+",-"+wa+" z","fill:"+A+";stroke:"+E+";stroke-width:"+I+";");break;case "label":var Bc=.8*u,D=map.Dom.newShape("rect",y,.8*-u,.4*-u,1.6*u,.8*u,"fill:"+A+";stroke:"+E+";stroke-width:"+I+";")}if(!D)continue;if(c.match(/HORZ/)){c.match(/VALUES/)&&(v=__maptheme_getChartColors(A),E=v.textColor,H=map.Dom.newText($a,0,0,"font-family:arial;font-size:"+
String(u/2)+"px;text-anchor:start;baseline-shift:-90%;fill:#bbbbbb;stroke:none;pointer-events:none",oa),H.fu.setPosition(M*u*2,-u-map.Scale.normalX(5)),1<g.length&&setRotate(H,-45));if(c.match(/AXIS/)&&this.szXaxisA){var v=__maptheme_getChartColors(A),E=v.textColor,dc=this.szXaxisA[k],H=map.Dom.newText($a,0,0,"font-family:arial;font-size:"+String(u/2)+"px;text-anchor:start;baseline-shift:-90%;fill:#bbbbbb;stroke:none;pointer-events:none",dc);H.fu.setPosition(M*u*2+map.Scale.normalX(2),u+map.Scale.normalX(1));
1<g.length&&setRotate(H,45)}D.setAttributeNS(szMapNs,"tooltip",Ra);D.fu.setPosition(M*u*2,0)}else!c.match(/VALUES/)||this.fHideValues&&!c.match(/ZOOM/)||(v=__maptheme_getChartColors(A),E=v.textColor,H=map.Dom.newText($a,0,0,"font-family:arial;font-size:"+String(u/2)+"px;text-anchor:start;baseline-shift:-45%;fill:#bbbbbb;stroke:none;pointer-events:none",oa),H.fu.setPosition(u+map.Scale.normalX(3),-M*(2*u-map.Scale.normalY(0)))),D.setAttributeNS(szMapNs,"tooltip",Ra),D.fu.setPosition(0,-M*(2*u-map.Scale.normalY(0)));
c.match(/OUTLINE/)?(D.style.setProperty("stroke-width",String(map.Scale.normalX(.5))),D.style.setProperty("stroke-opacity","1"),D.style.setProperty("fill-opacity","0.7")):c.match(/DOPACITY/)&&this.szAlphaField?b&&"undefined"!=typeof this.itemA[b].nAlpha&&(ka=1/(this.nDopacityPow||1),ta=(this.nDopacityScale||1)/Math.pow(this.nMaxAlpha,ka)*Math.pow(this.itemA[b].nAlpha,ka),D.style.setProperty("fill-opacity",String(ta),"")):D.style.setProperty("fill-opacity",String(this.fillOpacity?this.fillOpacity:
this.nOpacity?this.nOpacity:1),"")}else{u=map.Scale.normalX(.4*f);D=map.Dom.constructNode("use",y,{"xlink:href":"#"+Z+":antizoomandpan"});D.setAttributeNS(null,"style","fill:"+A+";stroke:"+E);if(this.szSizeField&&b&&this.itemA[b]){var L=1/Math.sqrt(this.nMaxSize)*Math.sqrt(this.itemA[b].nSize);D.fu.scale(L,L)}D.fu.setPosition(map.Scale.normalX(0)+M*map.Scale.normalX(20),map.Scale.normalY(0));0<M&&(map.Dom.newText(y,map.Scale.normalX(-9)+M*map.Scale.normalX(20),0,"font-family:arial;font-size:360px;text-anchor:middle;baseline-shift:-50%;fill:none;stroke:black;stroke-width:60;pointer-events:none;opacity:0.3;",
"+"),map.Dom.newText(y,map.Scale.normalX(-9)+M*map.Scale.normalX(20),0,"font-family:arial;font-size:360px;text-anchor:middle;baseline-shift:-50%;fill:white;stroke:none;pointer-events:none;opacity:0.8;","+"));c.match(/VALUES/)&&(v=__maptheme_getChartColors(A),E=v.textColor,H=map.Dom.newText($a,0,0,"font-family:arial;font-size:"+String(u/2)+"px;text-anchor:start;baseline-shift:-45%;fill:#bbbbbb;stroke:none;pointer-events:none",oa),H.fu.setPosition(u/2+map.Scale.normalX(3),2*-M*u),c.match(/MULTILINE/)&&
this.szSizeField&&b&&this.itemA[b]&&(H=map.Dom.newText($a,0,0,"font-family:arial;font-size:"+String(u/2)+"px;text-anchor:start;baseline-shift:-45%;fill:#bbbbbb;stroke:none;pointer-events:none",String(this.itemA[b].nSize)+this.szSizeValueUnits),H.fu.setPosition(u/2+map.Scale.normalX(3),2*-M*u+u/2)))}D.setAttributeNS(szMapNs,"value",String(m));D.setAttributeNS(szMapNs,"class",String(Q));D.setAttributeNS(szMapNs,"time",String(da));this.nRealizedCount++}else this.nMissingRangeCount++}else if(m||c.match(/PLOT|NOSIZE/)){F=
map.Scale.normalX(f/2);K=this.nNormalSizeValue||lb;c.match(/MENUSIZE/)?K=5*Sa:!this.nNormalSizeValue||c.match(/SEQUENCE/)&&this.szSizeField||(this.nMaxSize=K=this.nNormalSizeValue);Sa&&c.match(/ZOOM/)&&c.match(/SEQUENCE/)&&(K=Sa/2+Sa/2*Math.pow(K,.5)/Math.pow(Sa,.5));if(c.match(/INVERTSIZE/)&&0==K-m&&!c.match(/ZEROISVALUE/))return null;this.szFlag.match(/\bCLIP\b/)&&!this.szFlag.match(/MORPH/)&&this.nClipFrames&&(m=this.nClipFrames==g.length?Number(g[this.nActualFrame]):g[M]*(this.nClipFrames-1-this.nActualFrame)/
(this.nClipFrames-1)+g[g.length-1]*this.nActualFrame/(this.nClipFrames-1));u=0;c.match(/AUTOSIZE/)&&(jb=map.Layer.nDynamicObjectScale,kb=c.match(/\bRECT\b/)?c.match(/GAP/)?2.3:2:c.match(/GAP/)?1.6:1.5,K=Math.max(lb,this.nMax),F=this.nGridWidthPx?map.Scale.normalX(this.nGridWidthPx)/kb/jb:this.nGridWidth?map.Scale.getDeltaXofDistanceInMeter(this.nGridWidth)/kb/jb:F);u=c.match(/GRIDSIZE/)&&!c.match(/PLOT/)?this.nGridSize/2:c.match(/NOSIZE/)?map.Scale.normalX(f/3):c.match(/FIXSIZE/)?map.Scale.normalX(f/
3)/(this.nNormalSizeValue||1):c.match(/LINEAR/)||c.match(/SIZEP1/)?F/K*m:c.match(/SIZELOG/)?Math.max(1,F/Math.log(K)*Math.log(m)):c.match(/SIZEP4/)?F/Math.pow(K,.25)*Math.pow(m,.25):c.match(/SIZEP3/)||c.match(/SIZEVOLUME/)?F/Math.pow(K,1/3)*Math.pow(m,1/3):F/Math.sqrt(K)*Math.sqrt(m);c.match(/SEQUENCE/)?c.match(/MENUSIZE/)||c.match(/SUM/)&&!b?u*=this.szField100?1:2:c.match(/ZOOM/)&&!c.match(/PLOT/)?u*=2:c.match(/AGGREGATE/)&&c.match(/CATEGORICAL/)||!this.szSizeField||!b||!this.itemA[b]||(u=c.match(/SIZELOG/)?
Math.max(1,u/Math.log(this.nMaxSize)*Math.log(this.itemA[b].nSize)):c.match(/SIZEP4/)?u/Math.pow(this.nMaxSize,.25)*Math.pow(this.itemA[b].nSize,.25):c.match(/SIZEP3/)||c.match(/SIZEVOLUME/)?u/Math.pow(this.nMaxSize,1/3)*Math.pow(this.itemA[b].nSize,1/3):u/Math.sqrt(this.nMaxSize)*Math.sqrt(this.itemA[b].nSize)):c.match(/MENUSIZE/)||c.match(/SUM/)&&!b?u=1.5*F:c.match(/ZOOM/)&&!c.match(/PLOT/)?u=Math.max(u,2*F/3):c.match(/NOSIZE/)?u=F/5:(!c.match(/GRIDSIZE/)&&this.szSizeField&&b&&this.itemA[b]&&(u=
F/Math.sqrt(this.nMaxSize)*Math.sqrt(this.itemA[b].nSize)),c.match(/PLOTXY/)&&(u/=5));if(isNaN(u)||!u)if(u=0,!c.match(/STAR/)&&!c.match(/STACKED/))continue;Z=this.szSymbolsA[M];this.szValueField&&c.match(/CATEGORICAL/)&&this.szValuesA&&(Na=this.szValuesA[M]);if(b&&this.itemA[b].szColor)A=this.itemA[b].szColor,Q=this.itemA[b].nClass,this.colorClassUsedA&&(this.colorClassUsedA[Q]=!0);else if((c.match(/SEQUENCE/)||c.match(/DOMINANT/))&&this.colorScheme.length==this.partsA.length)A=this.colorScheme[M%
(this.nGridX||1E4)],E=this.colorScheme[M];else if(A=this.colorScheme[0],E=this.colorScheme[1]?this.colorScheme[1]:"none",2<this.colorScheme.length&&(A=this.colorScheme[this.colorScheme.length-1],E=this.colorScheme[0]),c.match(/NOLINES/)?E="none":"none"==E&&(v=__maptheme_getChartColors(A),E=v.textColor),2<this.colorScheme.length||this.szRanges&&this.szRanges.length){for(ha=0;ha<this.partsA.length;ha++)if(c.match(/CATEGORICAL/)&&m==this.partsA[ha].min||!c.match(/CATEGORICAL/)&&m<this.partsA[ha].max){A=
this.colorScheme[ha];v=__maptheme_getChartColors(A);E=v.textColor;c.match(/RANGE/)&&!c.match(/RANGES/)&&(u=map.Scale.normalX(2+5*(ha+1)/this.partsA.length));Q=ha;break}c.match(/NOLINES/)&&(E="none")}if("circle"==Z||"square"==Z||"carot"==Z||"diamond"==Z||"triangle"==Z||"hexagon"==Z||"empty"==Z||"label"==Z||"cross"==Z){E=this.szLineColor||E;I=(this.nLineWidth||1)*map.Scale.normalX(Math.min(2*u/F,.2));switch(Z){case "empty":D=map.Dom.newShape("circle",y,0,0,u,"fill:#888888;fill-opacity:0;stroke:#888888;stroke-width:"+
I+";");break;case "circle":!this.fShadow&&this.fOrigShadow&&(la=map.Dom.newShape("circle",y,map.Scale.normalX(.5)+.02*u,map.Scale.normalX(.5)+.02*u,1.02*u,"fill:#000000;stroke:none;opacity:"+.6*(this.fillOpacity?this.fillOpacity:1)));if(c.match(/GLOW/)&&!c.match(/ZOOM/)&&(!this.szGlowUpper||map.Scale.nTrueMapScale*map.Scale.nZoomScale<=this.nGlowUpper)&&(!this.szGlowLower||map.Scale.nTrueMapScale*map.Scale.nZoomScale>=this.nGlowLower)){if(Ua=map.Dom.newShape("circle",y,0,0,6*u,"fill:"+A+";stroke:none;fill-opacity:0.05;pointer-events:none;"))Ua.setAttributeNS(szMapNs,
"class",String(Q)),Ua.setAttributeNS(szMapNs,"time",da);if(vb=map.Dom.newShape("circle",y,0,0,2*u,"fill:"+A+";stroke:none;fill-opacity:0.1;pointer-events:none;"))vb.setAttributeNS(szMapNs,"class",String(Q)),vb.setAttributeNS(szMapNs,"time",String(da))}else c.match(/AURA/)&&!c.match(/ZOOM/)&&(!this.szGlowUpper||map.Scale.nTrueMapScale*map.Scale.nZoomScale<=this.nGlowUpper)&(!this.szGlowLower||map.Scale.nTrueMapScale*map.Scale.nZoomScale>=this.nGlowLower)&&(Ua=map.Dom.newShape("circle",y,0,0,1.3*u,
"fill:"+(this.szLineColor||A)+";stroke:none;fill-opacity:0.3;"))&&(Ua.setAttributeNS(szMapNs,"class",String(Q)),Ua.setAttributeNS(szMapNs,"time",String(da)));D=map.Dom.newShape("circle",y,0,0,u,"fill:"+A+";stroke:"+E+";stroke-width:"+I+";");break;case "square":D=map.Dom.newShape("rect",y,-u,-u,2*u,2*u,"fill:"+A+";stroke:"+E+";stroke-width:"+I+";");break;case "cross":D=map.Dom.newShape("rect",y,1.6*-u,.4*-u,3.2*u,.8*u,"fill:"+A+";stroke:"+E+";stroke-width:"+map.Scale.nFeatureScaling*map.Scale.nObjectScaling+
";");D=map.Dom.newShape("rect",y,.4*-u,1.6*-u,.8*u,3.2*u,"fill:"+A+";stroke:"+E+";stroke-width:"+map.Scale.nFeatureScaling*map.Scale.nObjectScaling+";");break;case "carot":case "diamond":(D=map.Dom.newShape("rect",y,-u,-u,2*u,2*u,"fill:"+A+";stroke:"+E+";stroke-width:"+I+";"))&&D.setAttributeNS(null,"transform","rotate(45)");break;case "triangle":D=map.Dom.newShape("path",y,"M 0,"+u+" l"+1.2*u+",-"+2*u+" -"+2.4*u+",0 "+1.2*u+","+2*u+"z","fill:"+A+";stroke:"+E+";stroke-width:"+I+";");break;case "hexagon":Fa=
u/2;wa=u*Math.sin(60/180*Math.PI);Ob=u;D=map.Dom.newShape("path",y,"M -"+u+",0 l "+Fa+",-"+wa+" "+Ob+",0 "+Fa+","+wa+" -"+Fa+","+wa+" -"+Ob+",0 -"+Fa+",-"+wa+" z","fill:"+A+";stroke:"+E+";stroke-width:"+I+";");break;case "label":if(V=this.formatValue(Na,this.szValueDecimals||(1>Na||1>=K?1:0),"ROUND")+(5>=this.szUnit.length?this.szUnit:""),c.match(/TEXTONLY/)){pa=__maptheme_getChartColors(A).textColor;T=String(Math.max(Math.min(.8*u,map.Scale.normalX(500)),map.Scale.normalX(2)));if(this.nValueSizeMin&&
!c.match(/ZOOM/)&&T*map.Layer.nDynamicObjectScale<map.Scale.normalX(this.nValueSizeMin)){D=map.Dom.newShape("rect",y,0,0,0,0,"fill:none;");la=map.Dom.newShape("rect",y,0,0,0,0,"fill:none;");break}Kb=this.szTextFont||"arial";la=map.Dom.newText(y,0,0,"font-family:"+Kb+";font-size:"+T+"px;font-weight:bold;text-anchor:middle;fill:none;stroke:"+A+";stroke-width:"+T/7+";stroke-opacity:0.5;pointer-events:none;stroke-linejoin:bevel;",V);la.setAttributeNS(null,"id",this.szId+":"+b+":text:bg");D=map.Dom.newText(y,
0,0,"font-family:"+Kb+";font-size:"+T+"px;font-weight:bold;text-anchor:middle;fill:#000000;opacity:"+ta+";stroke:none;",V);D.setAttributeNS(null,"id",this.szId+":"+b+":text")}else{T=String(Math.max(1,Math.min(.8*u,3.4/V.length*u)));if(this.nValueSizeMin&&!c.match(/ZOOM/)&&T*map.Layer.nDynamicObjectScale<map.Scale.normalX(this.nValueSizeMin)){D=map.Dom.newShape("rect",y,0,0,0,0,"fill:none;");break}Bc=1.6*T;if(D=map.Dom.newShape("rect",y,-u,.83*-T,2.05*u,1.6*T,"fill:"+A+";stroke:"+E+";stroke-width:"+
I+";"))D.setAttributeNS(null,"rx",map.Scale.normalX(2*u/F)),D.setAttributeNS(null,"ry",map.Scale.normalX(2*u/F))}}D&&(c.match(/OUTLINE/)?(D.style.setProperty("stroke-width",String(map.Scale.normalX(.5))),D.style.setProperty("stroke-opacity","1"),D.style.setProperty("fill-opacity","0.7")):c.match(/RANDOM/)?(D.style.setProperty("stroke-opacity",String(this.nOpacity?this.nOpacity:1),""),D.style.setProperty("fill-opacity",String(this.fillOpacity?this.fillOpacity:this.nOpacity?this.nOpacity:1),""),c.match(/DOPACITY/)&&
(ka=1/(this.nDopacityPow||1),ta=Math.pow(m,ka)/Math.pow(this.sortedMax,ka)*(this.nOpacity||1)*(this.nDopacityScale||1),D.style.setProperty("fill-opacity",String(ta),""))):c.match(/\bSORT\b/)&&c.match(/DOPACITY/)?(D.style.setProperty("stroke-opacity",String(this.nOpacity?this.nOpacity:1),""),ka=1/(this.nDopacityPow||1),ta=Math.pow(m,ka)/Math.pow(this.sortedMax,ka)*(this.nOpacity||1)*(this.nDopacityScale||1),D.style.setProperty("fill-opacity",String(ta),"")):c.match(/DOPACITY/)&&this.szAlphaField?b&&
"undefined"!=typeof this.itemA[b].nAlpha&&(ka=1/(this.nDopacityPow||1),ta=(this.nDopacityScale||1)/Math.pow(this.nMaxAlpha,ka)*Math.pow(this.itemA[b].nAlpha,ka),D.style.setProperty("fill-opacity",String(ta),"")):c.match(/DOPACITY/)?(ka=1/(this.nDopacityPow||1),ta=Math.pow(m-this.nMin,ka)/Math.pow(this.nMax-this.nMin,ka)*(this.fillOpacity||1)*(this.nDopacityScale||1),D.style.setProperty("fill-opacity",String(ta),""),c.match(/CATEGORICAL/)||(Q=Math.min(6,Math.ceil((m-this.nMin)/(this.nMax-this.nMin)*
7)),D.setAttributeNS(szMapNs,"class",String(Q)),y.setAttributeNS(szMapNs,"class",String(Q)),e.setAttributeNS(szMapNs,"class",String(Q)))):D.style.setProperty("fill-opacity",String(this.fillOpacity?this.fillOpacity:this.nOpacity?this.nOpacity:1),""),this.chartGroup&&this.chartGroup.style.setProperty("opacity","1",""),D.setAttributeNS(szMapNs,"tooltip",Ra),D.setAttributeNS(szMapNs,"time",da))}else if(!c.match(/MULTIPLE/)||c.match(/NORMSIZE/)||c.match(/MENUSIZE/))D=map.Dom.constructNode("use",y,{"xlink:href":"#"+
Z+":antizoomandpan"}),map.Dom.newShape("circle",y,0,0,.5*u,"fill:white;stroke:none;opacity:0"),D.fu.scale(u/F,u/F),D.setAttributeNS(null,"style","fill:"+A+";stroke:"+E);else for(var D=map.Dom.newGroup(y,y.getAttributeNS(null,"id")+":multiple"),ec=0;ec<m;ec++){var Cc=map.Dom.constructNode("use",D,{"xlink:href":"#"+Z+":antizoomandpan"});Cc.fu.setPosition(ec*(F+map.Scale.normalX(1)),0);Cc.fu.scale(1,1);Cc.setAttributeNS(null,"style","fill:"+A+";stroke:"+E);map.Dom.newShape("circle",D,ec*F,0,.5*u,"fill:white;stroke:none;opacity:0")}if(D&&
c.match(/VALUES/)&&!c.match(/TEXTONLY/)&&(!this.fHideValues||c.match(/ZOOM/))){H=null;V=Na;isNaN(Na)||(V=this.formatValue(Na,this.szValueDecimals||"")+(5>=this.szUnit.length?this.szUnit:""));var rd=Math.max(lb,this.nMax),sd=this.formatValue(rd,this.szValueDecimals||"")+(5>=this.szUnit.length?this.szUnit:""),td=Math.max((Na.length||0)+1,sd.length),v=__maptheme_getChartColors(A),pa=this.szTextColor||v.textColor,T=String(Math.min(1*F,("hexagon"==Z?2.7:3.2)/td*F)),T=u/F*T*this.nValueScale;if(c.match(/ZOOM/)&&
c.match(/LINES/)&&(null==this.nGridX||1>=this.nGridX||c.match(/STACKED/)))pa="black",C=C||map.Dom.newGroup(e,this.szId+":"+b+":textchartontop"),T=4+.5*g.length/(this.nGridX?2*this.nGridX:1),H=this.createTextLabel(SVGDocument,C,"",V,1.5*T,"","rgba(255,255,255,0.7)",v.lowColor,"GLOW"),H.setAttributeNS(null,"opacity","0.9"),C.fu.setPosition(1.7*-map.Scale.normalX(T),-map.Scale.normalY(5/(this.nGridX||1)));else if(c.match(/ZOOM/)&&!c.match(/SEQUENCE/))pa="black",H=map.Dom.newText(y,.5*u+.2*F,-u/2,this.szValuesTextStyle,
V);else if("circle"==Z||"square"==Z||"triangle"==Z||"hexagon"==Z||"label"==Z||"empty"==Z)if(c.match(/CENTERVALUES/))1==Q&&(H=map.Dom.newText(y,0,.33*T,"font-family:arial;font-size:"+T+"px;text-anchor:middle;fill:"+pa+";stroke:none;pointer-events:none",V));else if((c.match(/CENTER/)||c.match(/TOP/)||c.match(/BOTTOM/))&&!c.match(/DOMINANT/)){if(m){var P=6;this.szChartFlag+="|VALUEBACKGROUND";var J=J||map.Dom.newGroup(e,this.szId+":"+b+":chartontop"),Ma=Ma?Ma:u,Xc=-map.Scale.normalX(1),Yc=-map.Scale.normalX(1.33*
P)*(zc-Wc-1),H=this.createTextLabel(SVGDocument,J,"",V,P,"",A,this.szTextColor);H.fu.setPosition(Xc,Yc);if(b&&(c.match(/ZOOM/)||c.match(/NORMSIZE/))&&this.szLabelA){var ud=H.fu.getBox().width,H=map.Dom.newText(J,0,0,this.szValuesTextStyle+";color:#000;",this.szLabelA[M]);H.fu.setPosition(Xc+ud+map.Scale.normalX(6),Yc-map.Scale.normalX(-1));H.fu.scale(.6,.6)}H.setAttributeNS(szMapNs,"class",String(Q%(this.nGridX||1E6)));H=null;Wc++}}else if(this.szValueField&&c.match(/2VALUES/))var H=map.Dom.newText(y,
0,.2*-T,"font-family:arial;font-size:"+T+"px;text-anchor:middle;fill:"+pa+";stroke:none;pointer-events:none",V),Zc=Math.min(.8*T,120),Aa=this.formatValue(m,this.szValueDecimals||0)+this.szUnit,Ya=map.Dom.newText(y,0,T-.2*Zc,"font-family:arial;font-size:"+Zc+"px;text-anchor:middle;fill:"+pa+";stroke:none;pointer-events:none",Aa);else H=map.Dom.newText(y,0,.33*T,"font-family:arial;font-size:"+T+"px;text-anchor:middle;fill:"+pa+";stroke:none;pointer-events:none",V);else T=Math.max(.8*u,1),J=J||map.Dom.newGroup(e,
this.szId+":"+b+":chartontop"),H=this.createTextLabel(SVGDocument,J,"",V,T/map.Scale.normalX(1),"",A),H.fu.setPosition(map.Scale.normalX(0)+Ka,map.Scale.normalY(0)+za)}if(D&&(D.setAttributeNS(szMapNs,"class",String(Q%(this.nGridX||1E6))),D.setAttributeNS(szMapNs,"time",da),H&&(H.setAttributeNS(szMapNs,"class",String(Q%(this.nGridX||1E6))),H.setAttributeNS(szMapNs,"time",da),H.setAttributeNS(szMapNs,"tooltip",Ra)),Ya&&(Ya.setAttributeNS(szMapNs,"class",String(Q%(this.nGridX||1E6))),Ya.setAttributeNS(szMapNs,
"time",da)),la&&(la.setAttributeNS(szMapNs,"class",String(Q%(this.nGridX||1E6))),la.setAttributeNS(szMapNs,"time",da)),!c.match(/CENTER/))){var na=null;if(c.match(/STAR/)){if(0==k&&($b=D,ac=H,bc=Ya,Ma=u,c.match(/EXPAND/)&&c.match(/\bSORT\b/)&&c.match(/\bUP\b/)&&(Ma=c.match(/LINEAR/)||c.match(/SIZEP1/)?(c.match(/EXPANDMAX/)?2:.5)*F/K*this.sortedIndex[g.length-1].value:(c.match(/EXPANDMAX/)?2:.5)*F/Math.sqrt(K)*Math.sqrt(this.sortedIndex[g.length-1].value)),c.match(/ZOOM/)&&c.match(/STAR/)&&c.match(/\bUP\b/)?
Ma*=2:c.match(/COMPRESS/)&&(Ma*=c.match(/COMPRESSMAX/)?.25:.5)),(0<k||c.match(/\bUP\b/))&&u){var vd=this.nClipParts&&this.nClipParts<this.partsA.length?this.nClipParts:this.partsA.length,Dc=u,$c=Ma+u,wd=Math.sqrt(Math.pow($c,2)-Math.pow(Dc,2)),fc=90-Math.asin(Dc*wd/$c/Dc)/Math.PI*180,nb=Ma+u;c.match(/\bUP\b/)&&(5<k&&(fc/=1+u/F*2),nb=Ma*(1+vd/5));c.match(/ZOOM/)||(nb=this.nRangeScale?nb*this.nRangeScale:c.match(/EXPANDMAX/)?2*nb:c.match(/EXPAND/)?1.5*nb:nb);this.initAngle+=fc;Ka=Math.cos(this.initAngle/
180*Math.PI)*nb;za=Math.sin(this.initAngle/180*Math.PI)*nb;this.initAngle+=fc;na=new point(map.Scale.normalX(0)+Ka,map.Scale.normalY(0)+za)}}else if(c.match(/RANDOM/)){var gc=c.match(/EXPANDMAX/)?2*u:c.match(/EXPAND/)?1.5*u:u;c.match(/ZOOM/)&&(F*=2,gc*=2);Ka=Math.cos(this.initAngle+360/this.partsA.length*k/180*Math.PI)*Math.min(F,gc);za=Math.sin(this.initAngle+360/this.partsA.length*k/180*Math.PI)*Math.min(F,gc);na=new point(map.Scale.normalX(0)+Ka,map.Scale.normalY(0)+za)}else c.match(/HORZ/)?(Ka+=
u,na=new point(map.Scale.normalX(0)+Ka,map.Scale.normalY(0)+za),Ka+=u):c.match(/BOTTOM/)?na=new point(map.Scale.normalX(0),-u):c.match(/TOP/)?na=new point(.3*-u,.7*u-F):c.match(/CONE/)?na=new point(map.Scale.normalY(.33*k),-map.Scale.normalY(1*k)):c.match(/BASE/)&&(na=new point(map.Scale.normalX(0),za-u),za-=u*(c.match(/VALUES/)?1.25:1));na?(D.fu.setPosition(na.x,na.y),la&&la.fu.setPosition(na.x,na.y),Ua&&Ua.fu.setPosition(na.x,na.y),vb&&vb.fu.setPosition(na.x,na.y),H&&H.fu.setPosition(na.x,na.y),
Ya&&Ya.fu.setPosition(na.x,na.y)):Ya&&Ya.fu.setPosition(0,0);if(c.match(/PLOT/)){0!=m||c.match(/STACKED/)||(D.parentNode.removeChild(D),la&&la.parentNode.removeChild(la),H&&H.parentNode.removeChild(H));var G=map.Scale.normalX(f)*(c.match(/LINES/),1),X=k*G;this.nGridX&&(X=c.match(/PLOTVAR/)?Math.floor(k%this.nGridX)*G:Math.floor(k/this.nGridX)*G);var K=lb||this.nMax,K=Math.max(Sa,K),K=this.nMaxValuePlot="undefined"!==typeof this.nMaxValue?this.nMaxValue:K,qa=this.nMinValuePlot="undefined"!==typeof this.nMinValue?
this.nMinValue:Math.min(this.nMin,yc);if("inherit"==this.nMaxValue)for(var Pb=0;Pb<this.parent.themesA.length;Pb++)this.parent.themesA[Pb]!=this&&this.parent.themesA[Pb].nMaxValuePlot&&(K=this.parent.themesA[Pb].nMaxValuePlot);"auto"==this.nMaxValue&&(K=this.nMaxValuePlot=Sa);L=map.Scale.normalX(f)/(K-qa)*(this.nGridX||g.length-1)*(this.nRangeScale||1);if(!ab){var ad=this.szId+":"+this.itemA[b].szSelectionId+":chartgrid",ea=SVGDocument.getElementById(ad);if(!ea||c.match(/ZOOM/))J=J||map.Dom.newGroup(e,
this.szId+":"+b+":chartontop"),ea=map.Dom.newGroup(J,ad)}if(c.match(/PLOTXY/))ab||(ab=!0,c.match(/BOX/)&&c.match(/\bGRID\b/)&&!ea.childNodes.length&&(map.Dom.newShape("line",ea,0,0,this.nChartWidth+100,0,"stroke:#888888;stroke-width:"+map.Scale.normalX(.3)+";"),map.Dom.newShape("line",ea,0,0,0,-this.nChartHeight-100,"stroke:#888888;stroke-width:"+map.Scale.normalX(.3)+";"),map.Dom.newText(ea,10,80,"font-family:arial;font-size:80px;text-anchor:start;fill:#444444;stroke:none;pointer-events:none;",String(this.nMinX)),
map.Dom.newText(ea,this.nChartWidth+100,80,"font-family:arial;font-size:80px;text-anchor:end;fill:#444444;stroke:none;pointer-events:none;",String(this.nMaxX)),map.Dom.newText(ea,-10,10,"font-family:arial;font-size:80px;text-anchor:end;fill:#444444;stroke:none;pointer-events:none;",String(this.nMinY)),map.Dom.newText(ea,-10,-this.nChartHeight-100+80,"font-family:arial;font-size:80px;text-anchor:end;fill:#444444;stroke:none;pointer-events:none;",String(this.nMaxY)))),Ba=50+(this.itemA[b].nX-this.nMinX)*
this.nChartWidth/this.nRangeX,Xa=-100-(this.itemA[b].nY-this.nMinY)*this.nChartHeight/this.nRangeY,D.fu.setPosition(Ba,Xa),la&&la.fu.setPosition(Ba,Xa),Ua&&Ua.fu.setPosition(Ba,Xa),vb&&vb.fu.setPosition(Ba,Xa),H&&H.fu.setPosition(Ba,Xa);else if(c.match(/PLOTYX/))D.fu.setPosition((K+Math.abs(K-m))*L,X),la&&la.fu.setPosition((K+Math.abs(K-m))*L,X),H&&H.fu.setPosition((K+Math.abs(K-m))*L,X);else if(c.match(/PLOTY/)){D.fu.setPosition(0,(-K+Math.abs(K-m))*L);la&&la.fu.setPosition(0,(-K+Math.abs(K-m))*
L);H&&H.fu.setPosition(0,(-K+Math.abs(K-m))*L);var aa=1,aa=K/5,aa=10*Math.ceil(aa/(10*Math.floor(Math.log(aa))))*Math.floor(Math.log(aa))||1,K=Math.ceil(K/aa)*aa;if(!ab&&(ab=!0,c.match(/BOX/)&&c.match(/\bGRID\b/)))for(var ba=map.Scale.normalX(f)/2;ba<K*L;ba+=L*aa)map.Dom.newShape("line",ea,-20,-ba,20,-ba,"stroke:#444444;stroke-width:"+map.Scale.normalX(1)+";")}else if(c.match(/PLOTX/)){if(D.fu.setPosition((K-Math.abs(K-m))*L,0),la&&la.fu.setPosition((K-Math.abs(K-m))*L,0),H&&H.fu.setPosition((K-Math.abs(K-
m))*L,0),aa=1,aa=K/5,aa=10*Math.ceil(aa/(10*Math.floor(Math.log(aa))))*Math.floor(Math.log(aa))||1,K=Math.ceil(K/aa)*aa,!ab&&(ab=!0,c.match(/BOX/)&&c.match(/\bGRID\b/)))for(ba=map.Scale.normalX(f);ba<K*L+map.Scale.normalX(f);ba+=L*aa)map.Dom.newShape("line",ea,ba,-20,ba,20,"stroke:#444444;stroke-width:"+map.Scale.normalX(1)+";")}else{aa=1;aa=Math.ceil(K-qa)/5;.5>aa&&(aa=Math.ceil(K-qa)/10);if(1<aa)var bd=Math.pow(10,Math.floor(Math.log10(aa))),aa=Math.ceil(aa/bd)*bd||1;K=Math.ceil(K/aa)*aa;for(qa=
Math.floor(qa/aa)*aa;5>(K-qa)/aa;)aa/=2;5<(K-qa)/aa&&(aa*=2);if(!ab){ab=!0;this.plot_last_last_position=[];this.plot_last_position=[];this.plot_last_value=[];this.plot_last_stacked_value=[];this.plot_last_shape=[];this.plot_last_mean=[];this.plot_last_areaValue=[];this.plot_area_points=[];this.plot_area_shapes=[];this.plot_area_shapes[0]=map.Dom.newShape("path",y,"M0,0","fill:"+A+";fill-opacity:"+(this.fillOpacity||1)+";stroke:none");var cd=g.length/(this.nGridX||1),Cb=map.Scale.normalX(Math.max(g.length/
(this.nGridX||1),10)),Cb=Cb*(c.match(/ZOOM/)?.8:1),Qb=map.Dom.newGroup(y,"");Qb.parentNode.insertBefore(Qb,y.firstChild);if(c.match(/BOX/)&&c.match(/\bGRID\b/)&&!(!c.match(/ZOOM/)&&this.nBoxUpper&&map.Scale.nTrueMapScale*map.Scale.nZoomScale>this.nBoxUpper)){if(!c.match(/ZOOM/)){var Rb=-G/(c.match(/LINES/)?3:1),Sb=G*(this.nGridX?g.length/this.nGridX-1:g.length-1);map.Dom.newShape("rect",y,0,-(K-qa)*L,Sb,(K-qa)*L,"fill:#ffffff;fill-opacity:0;stroke:none;")}for(var Ec=.8,xd=0,ba=0;ba<=(K-qa)*L;ba+=
L*aa){var Fc=this.formatValue(Math.round(c.match(/INVERT/)?K-ba/L+qa:100*(ba/L+qa))/100,2);5<K&&(Fc=String(Math.round(c.match(/INVERT/)?K-ba/L+qa:ba/L+qa)));var cb=ba;c.match(/LOG/)&&(cb=100*Math.pow(10,xd++),cb>K&&(ba=K*L),Fc=this.formatValue(cb,0),cb=Math.log10(cb)*K/Math.ceil(Math.log10(K))*L);Rb=-G/(c.match(/LINES/)?3:1);Sb=G*(this.nGridX?g.length/this.nGridX-1:g.length-1);c.match(/PLOTVAR/)&&1<g.length/this.nGridX&&(Sb=G*this.nGridX);if(c.match(/GRADIENT/)&&0!=ba)var dd=Sb+(c.match(/LINES/),
0),N=map.Dom.newShape("path",y,"M"+Rb+","+-ba+" L "+dd+","+-ba+" "+dd+","+(-ba+L*aa)+" "+Rb+","+(-ba+L*aa)+" z","fill:#d8d8dd;fill-opacity:"+Ec+";stroke:none;"),Ec=Ec-.3;map.Dom.newShape("line",ea,Rb,-cb,Sb,-cb,"stroke:#aaaaaa;stroke-width:"+(0==cb?map.Scale.normalX(.05*cd):map.Scale.normalX(.03*cd))+";");map.Dom.newText(ea,1.1*Rb,-cb+.3*Cb,"font-family:arial;font-size:"+Cb+"px;text-anchor:end;fill:#888888;stroke:none;pointer-events:none;",Fc);this.nPlotHeight=ba}map.Dom.newShape("line",ea,X,0,X,
-(K-qa)*L,"stroke:#aaaaaa;stroke-width:"+map.Scale.normalX(.1)+";");if(this.szXaxisA&&this.szXaxisA.length)for(ba=0;ba<this.szXaxisA.length;ba++)this.szXaxisA[ba].length&&" "!=this.szXaxisA[ba]&&(map.Dom.newShape("line",ea,G*ba,100,G*ba,-(K-qa)*L,"stroke:#888888;stroke-width:"+map.Scale.normalX(.01*this.szXaxisA.length)+";stroke-dasharray:"+6*this.szXaxisA.length+" "+3*this.szXaxisA.length+";"),map.Dom.newText(ea,G*ba,1.5*Cb,"font-family:arial;font-size:"+Cb+"px;text-anchor:middle;fill:#888888;stroke:none;pointer-events:none;",
this.szXaxisA[ba]))}map.Dom.setClipRect(y,{x:-100,y:-(K-qa)*L,width:100+Pa/(this.nGridX||1)*G,height:100+(K-qa)*L})}var Va=this.nGridX?Math.floor(k/this.nGridX)+1:1,W=this.nGridX?k%this.nGridX:1;c.match(/LOG/)&&m&&(m=Math.log10(m)*K/Math.ceil(Math.log10(K)));var sa=c.match(/INVERT/)?K-m:m,sa=sa-qa,sa=sa+(c.match(/STACKED/)?this.plot_last_stacked_value[Va]||0:0);D.fu.setPosition(X,-sa*L);la&&la.fu.setPosition(X,-sa*L);if(H&&H.parentNode){var Gc=g.length/(this.nGridX||1);if(10<Gc){var Db=Math.floor(k/
(this.nGridX||1));(Db%10||Db>Gc-5)&&Db!=Gc-1&&(this.szXaxisA&&this.szXaxisA.length?this.szXaxisA[Db]&&this.szXaxisA[Db].length&&" "!=this.szXaxisA[Db]||H.parentNode.removeChild(H):H.parentNode.removeChild(H))}c.match(/LINES/)&&(null==this.nGridX||1>=this.nGridX||c.match(/STACKED/))?(H.fu.setPosition(X-map.Scale.normalX(f/4),-sa*L+map.Scale.normalY(f/4)/(this.nGridX||1)),H.fu.scale(1.5,1.5)):(H.fu.scale(1.5,1.5),H.fu.setPosition(X,-sa*L))}if(c.match(/LINES/)){var N=null;if(c.match(/ZEROISVALUE/)&&
this.plot_last_position[W]&&(m||this.plot_last_position[W].y)||m&&this.plot_last_position[W]&&this.plot_last_position[W].y)if(c.match(/AREA/)){if(N=map.Dom.newShape("path",Qb,"M"+(this.plot_last_position[W].x-2)+","+this.plot_last_position[W].y+" L "+X+","+-sa*L+" "+X+","+(-sa+m-qa)*L+" "+(this.plot_last_position[W].x-2)+","+(this.plot_last_last_position[W-1]?this.plot_last_last_position[W-1].y:0)+" z","fill:"+A+";fill-opacity:"+(this.fillOpacity||1)+";"))if(N.setAttributeNS(szMapNs,"value",String(m)),
N.setAttributeNS(szMapNs,"class",String(Q%(this.nGridX||1E6))),N.setAttributeNS(szMapNs,"tooltip",this.formatValue(m,this.szValueDecimals||2)+this.szUnit+" "+(this.szLabelA?this.szLabelA[Q%(this.nGridX||1E6)]:"")),N.setAttributeNS(szMapNs,"time",String(da)),this.szFlag.match(/\bFADE\b/)){var ed="Gradient"+Math.random(),fd=map.Dom.constructNode("linearGradient",y,{id:ed,gradientTransform:"rotate(90)"});map.Dom.constructNode("stop",fd,{offset:"0","stop-color":A,"stop-opacity":"1"});map.Dom.constructNode("stop",
fd,{offset:"1","stop-color":A,"stop-opacity":"0.1"});N.style.setProperty("fill","url(#"+ed+")")}var yd=1==k||k==Pa-1||2==Va||Va==Pa/(this.nGridX||1)?"but":"round";if(N=map.Dom.newShape("line",Qb,this.plot_last_position[W].x,this.plot_last_position[W].y,X,-sa*L,"stroke:"+A+";stroke-width:"+map.Scale.normalX(c.match(/STACKED/)?1:this.nLineWidth||3)+";stroke-linecap:"+yd+";"))N.setAttributeNS(szMapNs,"value",String(m)),N.setAttributeNS(szMapNs,"tooltip",this.formatValue(m,this.szValueDecimals||2)+this.szUnit+
" "+(this.szLabelA?this.szLabelA[Q%(this.nGridX||1E6)]:""))}else{if(N=map.Dom.newShape("line",Qb,this.plot_last_position[W].x,this.plot_last_position[W].y,X,-sa*L,"stroke:"+(this.szLineColor||A)+";stroke-width:"+map.Scale.normalX(this.nLineWidth||3)+";stroke-linecap:round;"))N.setAttributeNS(szMapNs,"value",String(m)),N.setAttributeNS(szMapNs,"class",String(Q%(this.nGridX||1E6))),N.setAttributeNS(szMapNs,"tooltip",this.formatValue(m,this.szValueDecimals||2)+this.szUnit+" "+(this.szLabelA?this.szLabelA[Q%
(this.nGridX||1E6)]:"")),N.setAttributeNS(szMapNs,"time",String(da));try{y.insertBefore(N,this.plot_last_shape[W])}catch(Gd){}}c.match(/LOLLIPOP/)&&m&&(N=map.Dom.newShape("line",ea,X,0,X,-sa*L,"stroke:"+A+";stroke-width:"+map.Scale.normalX(3)+";stroke-linecap:round;"))&&(N.setAttributeNS(szMapNs,"value",String(m)),N.setAttributeNS(szMapNs,"class",String(Q%(this.nGridX||1E6))),N.setAttributeNS(szMapNs,"time",String(da)));if(c.match(/PLOTVAR/)){var xa=c.match(/MEDIAN/)?this.nMedianA[M]:this.nMeanA[M],
xa=xa-qa;this.plot_last_mean[W]&&((N=map.Dom.newShape("path",ea,"M"+this.plot_last_mean[W].x+","+(this.plot_last_mean[W].y-this.nDeviationA[M-1]*L)+" L "+X+","+(-xa-this.nDeviationA[M])*L+" "+X+","+(-xa+this.nDeviationA[M])*L+" "+this.plot_last_mean[W].x+","+(this.plot_last_mean[W].y+this.nDeviationA[M-1]*L)+" z","fill:#d8d8dd;fill-opacity:0.2;stroke:none;"))&&N.setAttributeNS(szMapNs,"tooltip","standard deviation"),(N=map.Dom.newShape("line",y,this.plot_last_mean[W].x,this.plot_last_mean[W].y,X,
-xa*L,"stroke:#888888;stroke-width:"+map.Scale.normalX(2)+";stroke-linecap:round;stroke-dasharray:10 80;"))&&N.setAttributeNS(szMapNs,"tooltip","mean"));this.plot_last_mean[W]=new point(X,-xa*L)}this.plot_last_last_position[W]=c.match(/STACKED/)?this.plot_last_position[W]||new point(0,0):new point(0,0);this.plot_last_position[W]=0<=sa?new point(X,-sa*L):new point(X,0);this.plot_last_shape[W]=D;this.plot_last_areaValue[W]=m;this.plot_area_points.push(new point(X,-sa*L))}else if(c.match(/LOLLIPOP/)&&
m){if(N=map.Dom.newShape("line",ea,X,0,X,-sa*L,"stroke:"+A+";stroke-width:"+map.Scale.normalX(3)+";stroke-linecap:round;"))N.setAttributeNS(szMapNs,"value",String(m)),N.setAttributeNS(szMapNs,"class",String(Q%(this.nGridX||1E6))),N.setAttributeNS(szMapNs,"time",String(da))}else 1<g.length/this.nGridX?c.match(/PLOTVAR/)?(D.style.setProperty("fill-opacity",Va==g.length/this.nGridX?"1":"0.2",""),D.style.setProperty("stroke-width",Va==g.length/this.nGridX?"0":"3",""),N=null,this.plot_last_position[W]&&
(c.match(/PLOTVAR/)?(N=map.Dom.newShape("line",y,this.plot_last_position[W].x,this.plot_last_position[W].y,X,-sa*L,"stroke:"+A+";stroke-width:"+map.Scale.normalX(2)+";"),N.setAttributeNS(szMapNs,"value",String(m)),N.setAttributeNS(szMapNs,"class",String(Q%(this.nGridX||1E6))),N.setAttributeNS(szMapNs,"time",String(da)),N.parentNode.insertBefore(N,N.parentNode.firstChild),N=map.Dom.newShape("line",y,this.plot_last_position[W].x-40,this.plot_last_position[W].y,this.plot_last_position[W].x+40,this.plot_last_position[W].y,
"stroke:"+A+";stroke-width:"+map.Scale.normalX(this.nLineWidth||3)+";"),N.setAttributeNS(szMapNs,"value",String(m)),N.setAttributeNS(szMapNs,"class",String(Q%(this.nGridX||1E6))),N.setAttributeNS(szMapNs,"time",String(da)),N.parentNode.insertBefore(N,N.parentNode.firstChild),N=map.Dom.newShape("line",y,X,0,X,-this.nPlotHeight,"stroke:#dddddd;stroke-width:"+map.Scale.normalX(.25)+";"),N.setAttributeNS(szMapNs,"value",String(m)),N.setAttributeNS(szMapNs,"class",String(Q%(this.nGridX||1E6))),N.setAttributeNS(szMapNs,
"time",String(da)),N.parentNode.insertBefore(N,N.parentNode.firstChild)):(N=map.Dom.newShape("line",y,this.plot_last_position[W].x,this.plot_last_position[W].y,X,-sa*L,"stroke:"+A+";stroke-width:"+map.Scale.normalX(this.nLineWidth||3)+";"),N.setAttributeNS(szMapNs,"value",String(m)),N.setAttributeNS(szMapNs,"class",String(Q%(this.nGridX||1E6))),N.setAttributeNS(szMapNs,"time",String(da)),y.insertBefore(N,this.plot_last_shape[W]))),this.plot_last_last_position[W]=this.plot_last_position[W]||new point(0,
0),this.plot_last_position[W]=new point(X,-sa*L),this.plot_last_shape[W]=D):c.match(/BOX/)&&map.Dom.newShape("line",ea,X,0,X,-this.nPlotHeight,"stroke:#dddddd;stroke-width:"+map.Scale.normalX(.25)+";"):c.match(/PLOTVAR/)?(N=null,xa=c.match(/MEDIAN/)?this.nMedianA[M]:this.nMeanA[M],xa-=qa,N=map.Dom.newShape("line",ea,X,-(xa-this.nDeviationA[M])*L,X,-(xa+this.nDeviationA[M])*L,"stroke:#aaaaaa;stroke-width:"+map.Scale.normalX(1)+";"),N.setAttributeNS(szMapNs,"value",String(m)),N.setAttributeNS(szMapNs,
"class",String(Q%(this.nGridX||1E6))),N.setAttributeNS(szMapNs,"time",String(da)),N=map.Dom.newShape("line",ea,X-40,-xa*L,X+40,-xa*L,"stroke:#aaaaaa;stroke-width:"+map.Scale.normalX(2)+";"),N.setAttributeNS(szMapNs,"value",String(m)),N.setAttributeNS(szMapNs,"class",String(Q%(this.nGridX||1E6))),N.setAttributeNS(szMapNs,"time",String(da)),N=map.Dom.newShape("line",ea,X-80,-(xa-this.nDeviationA[M])*L,X+80,-(xa-this.nDeviationA[M])*L,"stroke:#aaaaaa;stroke-width:"+map.Scale.normalX(1)+";"),N.setAttributeNS(szMapNs,
"value",String(m)),N.setAttributeNS(szMapNs,"class",String(Q%(this.nGridX||1E6))),N.setAttributeNS(szMapNs,"time",String(da)),N=map.Dom.newShape("line",ea,X-80,-(xa+this.nDeviationA[M])*L,X+80,-(xa+this.nDeviationA[M])*L,"stroke:#aaaaaa;stroke-width:"+map.Scale.normalX(1)+";"),N.setAttributeNS(szMapNs,"value",String(m)),N.setAttributeNS(szMapNs,"class",String(Q%(this.nGridX||1E6))),N.setAttributeNS(szMapNs,"time",String(da)),map.Dom.newShape("line",ea,X,0,X,-this.nPlotHeight,"stroke:#dddddd;stroke-width:"+
map.Scale.normalX(.25)+";"),this.plot_last_position[W]&&(N=map.Dom.newShape("line",ea,this.plot_last_position[W].x,this.plot_last_position[W].y,X,-xa*L,"stroke:#888888;stroke-width:"+map.Scale.normalX(1)+";")),this.plot_last_last_position[W]=this.plot_last_position[W]||new point(0,0),this.plot_last_position[W]=new point(X,-xa*L)):c.match(/BOX/)&&map.Dom.newShape("line",ea,X,0,X,-this.nPlotHeight,"stroke:#dddddd;stroke-width:"+map.Scale.normalX(.25)+";");this.plot_last_value[Va]=m;this.plot_last_stacked_value[Va]=
sa}za=0}else"label"==Z&&(za-=Bc/1.95),D.fu.setPosition(map.Scale.normalX(0)+Ka,map.Scale.normalY(0)+za),la&&la.fu.setPosition(map.Scale.normalX(0)+Ka,map.Scale.normalY(0)+za),H&&H.fu.setPosition(Ka,map.Scale.normalY(0)+za),za="label"==Z?za-Bc/1.95:za-u}}}}$a&&$a.parentNode.appendChild($a);$b&&$b.parentNode.appendChild($b);ac&&ac.parentNode.appendChild(ac);bc&&bc.parentNode.appendChild(bc);if(0&c.match(/AREA/)&&!this.nGridX&&this.plot_area_points&&this.plot_area_points.length){for(var gd=!0,Hc=this.plot_area_points.length,
ua=0;ua<Hc;ua++)0==this.plot_area_points[ua].y&&(gd=!1);if(gd||c.match(/ZEROISVALUE/)){for(var eb="M"+this.plot_area_points[0].x+","+this.plot_area_points[0].y+" L ",ua=1;ua<Hc;ua++)eb+=this.plot_area_points[ua].x+","+this.plot_area_points[ua].y+" ";eb+=this.plot_area_points[Hc-1].x+",0 ";eb+="0,0 ";eb+="z ";this.plot_area_shapes[0].setAttributeNS(null,"d",eb)}}if("undefined"!=typeof this.szSymbolBoxStyle){var hd=map.Dom.getBox(y);wb.setAttributeNS(null,"x",-map.Scale.normalX(15));wb.setAttributeNS(null,
"y",-map.Scale.normalY(15));wb.setAttributeNS(null,"width",map.Scale.normalX(30*Vc));wb.setAttributeNS(null,"height",map.Scale.normalY(30));wb.setAttributeNS(null,"fill-opacity",1)}z.x=map.Scale.normalY(0);z.y=map.Scale.normalY(c.match(/ZOOM/)||c.match(/MENUSIZE/)?20:u/map.Scale.normalY(1)+5)}else if(c.match(/BUFFER/)){K=this.nMaxA[0];m=g[0];u=this.nBufferSize?this.nBufferSize:1E3;this.szShapeType.match(/line/)&&(u*=this.nScale);u=map.Scale.getDeltaXofDistanceInMeter(u);A=this.colorScheme[0];if(this.szFields&&
this.szFields.length&&this.nRangesA&&this.nRangesA.length&&(A=null,this.nRangesA.length==this.colorScheme.length))for(k=0;k<this.nRangesA.length;k++)if(m==this.nRangesA[k]||Number(m)==Number(this.nRangesA[k])){A=this.colorScheme[k];v=__maptheme_getChartColors(A);E="undefined"!=typeof this.szBorderColor?this.szBorderColor:.8>this.fillOpacity?"#888888":v.textColor;break}if(this.szShapeType.match(/point/))if(A){f=2*u/map.Scale.normalX(1);z.x=0;z.y=u+map.Scale.normalY(5);this.szFlag.match(/OVERLAY/);
D=map.Dom.newShape("circle",y,0,0,u,"");if(this.szFlag.match(/VALUE/))var ob="font-family:arial;font-size:"+map.Scale.normalX(5)+"px;fill:#222222;stroke-dasharray:none;pointer-events:none;",H=map.Dom.newText(y,u-map.Scale.normalX(5),0,ob,Map.Scale.prototype.formatDistanceString(this.nBufferSize));this.nRealizedCount++}else return new point(0,0);if(this.szShapeType.match(/line/)){var hc=SVGDocument.getElementById(b),Ic=hc.getAttributeNS(null,"id");if(!Ic.match(":paint")){var Tb=SVGDocument.getElementById(Ic+
":paint");Tb||(Tb=hc.cloneNode(1E3),y.appendChild(Tb),Tb.setAttributeNS(null,"id",Ic+":paint"));hc=Tb;this.nRealizedCount++}var zd=2*u/map.Scale.normalX(1);hc.setAttributeNS(null,"style","fill:none;stroke:"+A+";stroke-linejoin:round;stroke-linecap:round;stroke-width:"+map.Scale.normalX(zd)*map.Scale.nZoomScale+";stroke-opacity:"+String(this.fillOpacity?this.fillOpacity:this.nOpacity?this.nOpacity:0)+"");return null}}else if(c.match(/BAR/)||c.match(/BARS/)){var R=0,ia=0,Ad=f,Ga=1,va=0,x=1,Da=this.nMax-
this.nMin,Xb=this.nMax100-this.nMin100;this.nNormalSizeValue&&(Da=Xb=this.nMaxSize=this.nNormalSizeValue);if(c.match(/SIZE/)&&!c.match(/NORMSIZE/)&&this.szSizeField&&b&&this.itemA[b])Ga=c.match(/SIZELOG/)?1/Math.max(1,Math.log(this.nMaxSize)*Math.log(this.itemA[b].nSize)):c.match(/SIZEP4/)?1/Math.pow(this.nMaxSize,.25)*Math.pow(this.itemA[b].nSize,.25):c.match(/3D/)||c.match(/SIZEP3/)||c.match(/SIZEVOLUME/)?1/Math.pow(this.nMaxSize,1/3)*Math.pow(this.itemA[b].nSize,1/3):1/Math.sqrt(this.nMaxSize)*
Math.sqrt(this.itemA[b].nSize);else if(c.match(/SIZE/)&&!c.match(/NORMSIZE/)){var xb=r;c.match(/POINTER/)&&(xb/=g.length);Ga=c.match(/SIZELOG/)?1/Math.max(1,Math.log(Da)*Math.log(Math.abs(xb))):c.match(/SIZEP4/)?1/Math.pow(Da,.25)*Math.pow(Math.abs(xb),.25):c.match(/3D/)||c.match(/SIZEP3/)||c.match(/SIZEVOLUME/)?1/Math.pow(Da,1/3)*Math.pow(Math.abs(xb),1/3):1/Math.pow(Da,.5)*Math.pow(Math.abs(xb),.5)}0==Ga&&0!=r&&(Ga=30/f);f*=Ga;var B=map.Scale.normalX(f/g.length*.66);c.match(/STACKED/)&&(B=map.Scale.normalX(f/
3),this.nGridX&&!c.match(/MULTI/)&&(B/=2));c.match(/MENUSIZE/)&&1==g.length&&(B=map.Scale.normalX(f/2));P=B<map.Scale.normalX(5)?4*B/5:5*B/5;Za=1;c.match(/COLUMN/)&&(B*=c.match(/THICK/)?2:c.match(/THIN/)?1:1.5);c.match(/THIN/)&&(B*=.6,P*=.75);c.match(/THICK/)&&(B*=1.5,P*=1.5);c.match(/STACKED/)?P=map.Scale.normalX(5):(c.match(/ZOOM/)||c.match(/NORMSIZE/))&&1==g.length&&(P*=2.5);c.match(/STACKED/)&&!c.match(/ZOOM/)&&(P*=Ga);ob="font-family:arial;font-size:"+.95*P+"px;fill:#606060;pointer-events:none;";
ob=map.Scale.tStyle.Values.szStyle+"font-size:"+.95*P+"px";c.match(/NORMSIZE/)||c.match(/MENUSIZE/)||this.szFlag.match(/NORMSIZE/)||this.szFlag.match(/MENUSIZE/)||!this.nNormalSizeValue||this.szField100&&!c.match(/POINTER/)||(l=this.nNormalSizeValue);this.nOverrideMax&&(l=this.nOverrideMax);G=map.Scale.normalX(Ad)/l;if(c.match(/OFFSETMEAN/)||c.match(/OFFSETMEDIAN/)||c.match(/DEVIATION/))G=map.Scale.normalX(f)/300;c.match(/SIZE/)&&c.match(/SEQUENCE/)&&b&&1<g.length&&!this.szSizeField&&!this.szField100?
G=G*g.length/Ga:c.match(/SIZE/)&&b&&1<g.length&&!c.match(/EXPAND/)&&(G=this.szField100||c.match(/POINTER/)?G*Ga:G/(c.match(/SIZEP4/)?Ga*Ga:Ga));!this.nRangeScale||c.match(/ZOOM/)&&c.match(/HORZ/)||(G*=this.nRangeScale);c.match(/COMPRESSMAX/)?G/=4:c.match(/COMPRESSMORE/)?G/=3:c.match(/COMPRESS/)?G/=2:c.match(/EXPANDMAX/)?G*=4:c.match(/EXPANDMORE/)?G*=3:c.match(/EXPAND/)&&(G*=2);c.match(/POINTER/)&&!c.match(/NORMSIZE/)&&(G*=1.2);var Jc=map.Dom.newGroup(y,"");if(c.match(/\bSORT\b/)){this.sortedIndex=
[];for(k=0;k<g.length;k++)this.sortedIndex[k]={index:k,value:g[k]};this.sortedIndex.sort(c.match(/STACKED/)?this.sortIndexUp:this.sortIndexDown)}else this.sortedIndex=null;bb=0;c.match(/\bUP\b/)&&(bb=g.length-1);var fa=1;c.match(/CENTER/)&&(fa=2);for(var yb=new point(0,0),ic=null,Wa=null,fb=null,gb=null,Ha=null,Kc=null,jc=xb=0,Q=null,Bd=G,k=this.nClipParts&&this.nClipParts<g.length?g.length-this.nClipParts:0;k<g.length;k++){if(this.szShowParts){Nb=!0;for(ua in this.szShowPartsA)this.szShowPartsA[ua]==
k&&(Nb=!1);if(Nb)continue}G=Bd;M=Math.abs(bb-k);this.sortedIndex&&(M=this.sortedIndex[M].index);m=g[M];this.szFlag.match(/\bCLIP\b/)&&!this.szFlag.match(/MORPH/)&&this.nClipFrames&&(m=this.nClipFrames==g.length?Number(g[this.nActualFrame]):g[0]*(this.nClipFrames-1-this.nActualFrame)/(this.nClipFrames-1)+g[g.length-1]*this.nActualFrame/(this.nClipFrames-1),M=this.nActualFrame,k=g.length);var Ia=m;c.match(/INVERT/)&&(0!=m||c.match(/ZEROISVALUE/))&&(m=this.nMax-m);Aa=this.formatValue(m,this.szValueDecimals||
2);c.match(/OFFSETMEAN/)||c.match(/OFFSETMEDIAN/)?(c.match(/OFFSETMEAN/)&&(m*=100/this.nMeanA[M]),c.match(/OFFSETMEDIAN/)&&(m*=100/this.nMedianA[M]),m-=100,Ia=m=isFinite(m)&&!isNaN(m)?m:0,l=100,Aa=this.formatValue(m,this.szValueDecimals||2),0<m&&(Aa="+"+Aa)):c.match(/DEVIATION/)&&(m=(m-this.nMeanA[M])/this.nDeviationA[M],Ia=m=isFinite(m)&&!isNaN(m)?m:0,m*=100,Aa=this.formatValue(m,this.szValueDecimals||2),0<m&&(Aa="+"+Aa));var ja=this.colorScheme[M%(this.nGridX||1E6)],Q=M%(this.nGridX||1E6);if((c.match(/SEQUENCE/)||
1==g.length)&&2<=this.colorScheme.length)for(ja=this.colorScheme[this.partsA.length-1],ha=0;ha<this.partsA.length;ha++)if(m<this.partsA[ha].max){ja=this.colorScheme[ha];Q=ha;break}c.match(/LEFT/)&&c.match(/HORZ/)&&(m=-m);0>m&&!c.match(/STACKED/)&&(ia=-m*G,m=-m);c.match(/VOLUME/)&&c.match(/3D/)?(G=1,m=this.szSizeField&&b?B=map.Scale.normalX(f/3*2)*Math.pow(1/this.nMaxSize*this.itemA[b].nSize,1/3):B=map.Scale.normalX(f/3*2)*Math.pow(1/l*m,1/3)):(c.match(/POINTER/)&&c.match(/SIZE/)&&b&&(B=c.match(/WIDTH/)&&
q&&(!(c.match(/DIFFERENCE/)||c.match(/RELATIVE/)||c.match(/FRACTION/))||c.match(/OFFSETMEAN/)||c.match(/OFFSETMEDIAN/)||c.match(/DEVIATION/))?map.Scale.normalX(f)*Math.pow(Math.abs(1/this.nMax100*q),.5):map.Scale.normalX(f)*Math.pow(Math.abs(1/l*m),1/3),P=.6*B,this.nValueSizeMin&&!c.match(/ZOOM/)&&(P=P*map.Layer.nDynamicObjectScale>map.Scale.normalX(this.nValueSizeMin)?P:0),c.match(/ZOOM|XAXIS/)||(Za=Math.pow(Math.abs(m),.5)/Math.pow(this.nMax,.5),this.szFadeValuePow&&Number(this.szFadeValuePow)&&
(Za=Math.pow(Math.abs(m),Number(this.szFadeValuePow))/Math.pow(l,Number(this.szFadeValuePow))))),c.match(/DTEXT/)&&b&&!c.match(/ZOOM/)?(P=map.Scale.normalX(f/3*2)*Math.pow(Math.abs(1/l*m),.5)*.75,this.nValueSizeMin&&!c.match(/ZOOM/)&&(P=P*map.Layer.nDynamicObjectScale>map.Scale.normalX(this.nValueSizeMin)?P:0),Za=Math.pow(Math.abs(m),1/3)/Math.pow(l,1/3)):this.nValueSizeMin&&!c.match(/ZOOM/)&&(P=P*map.Layer.nDynamicObjectScale>map.Scale.normalX(this.nValueSizeMin)?P:0));P*=this.nValueScale||1;m=isFinite(m)&&
!isNaN(m)?m:0;if(0==m&&c.match(/NOZERO/))ia=0;else if(0>Ia&&c.match(/NONEGATIVE/))ia=0;else if(0<Ia&&c.match(/ONLYNEGATIVE/))ia=0;else{var U=map.Dom.newGroup(Jc,"");this.szFlag.match(/MENUSIZE/)&&1==g.length&&!c.match(/VOLUME/)&&(B*=.8,m=B/G*1.7,map.Dom.newShape("rect",U,0,-map.Scale.normalY(.75*f),map.Scale.normalX(.5*f),map.Scale.normalY(.75*f),"fill:red;stroke:none;fill-opacity:0"));var ma=m;if(c.match(/COLUMN/))0<m*G&&(S=DonutCharts.newChart(SVGDocument,U,R+B/2,0,B/2,0),S.setStyle("3D"),S.addStyle("SILENT"),
S.addPart(100,m*G*2-(c.match(/SPACED/)?B/2:B/5),ja,0,(this.szAggregation&&this.szAggregation.match(/sum/),this.formatValue(g[ga],this.szValueDecimals||(5>g[ga]?1:0),"ROUND")+this.szUnit),this.formatValue(g[ga],2)+this.szUnit+oa),S.realize());else if(c.match(/3D/)){v=__maptheme_getChartColors(ja);if(c.match(/VOLUME/)&&Wa){var Ca=(m*G-Wa)/15,ia=ia+Ca,A="white",A="#444444",A=Kc.borderColor;szFillColor=Kc.mainColor;szFillOpacity=.3;Wa<m*G&&(szFillOpacity=.2);map.Dom.newShape("line",U,fb+Ha,gb-Ca,R,ia-
Ca,"stroke:"+A+";stroke-width:"+map.Scale.normalX(.25)+";");map.Dom.newShape("line",U,fb+Ha,gb-Wa-Ca,R,ia-m*G-Ca,"stroke:"+A+";stroke-width:"+map.Scale.normalX(.25)+";");map.Dom.newShape("line",U,fb+Ha+Ha/3,gb-Ha/4-Ca,R+B/3,ia-B/4-Ca,"stroke:"+A+";stroke-width:"+map.Scale.normalX(.25)+";");map.Dom.newShape("line",U,fb+Ha+Ha/3,gb-Wa-Ha/4-Ca,R+B/3,ia-m*G-B/4-Ca,"stroke:"+A+";stroke-width:"+map.Scale.normalX(.25)+"");map.Dom.newShape("path",U,"M"+(fb+Ha)+","+(gb-Ca)+" L "+R+","+(ia-Ca)+" "+R+","+(ia-
m*G-Ca)+" "+(fb+Ha)+","+(gb-Wa-Ca)+" z","fill:"+szFillColor+";stroke:"+A+";stroke-width:"+map.Scale.normalX(.05)+";fill-opacity:"+szFillOpacity);Wa-m*G>-B/4&&map.Dom.newShape("path",U,"M"+(fb+Ha)+","+(gb-Wa-Ca)+" L "+R+","+(ia-m*G-Ca)+" "+(R+B/3)+","+(ia-m*G-B/4-Ca)+" "+(fb+Ha+Ha/3)+","+(gb-Wa-Ha/4-Ca)+" z","fill:"+szFillColor+";stroke:"+A+";stroke-width:"+map.Scale.normalX(.05)+";fill-opacity:"+szFillOpacity)}Wa=m*G;fb=R;gb=ia;Ha=B;Kc=v;if(ma=this.nFilterA[M]){var Ub="fill:#FFFFFF;stroke:gray;stroke-width:"+
map.Scale.normalX(.5)+";fill-opacity:0.1;stroke-opacity:0.1";map.Dom.newShape("path",U,"M"+R+",0 l "+B+",0 "+B/3+","+-B/4+" "+-B+" 0 z",Ub);map.Dom.newShape("rect",U,R+B/3,-ma*G/fa-B/4,B,ma*G,Ub);map.Dom.newShape("path",U,"M"+R+",0 l 0,"+-ma*G/fa+" "+B/3+","+-B/4+" 0,"+ma*G+" z",Ub);map.Dom.newShape("rect",U,R,-ma*G/fa,B,ma*G,Ub);map.Dom.newShape("path",U,"M"+(R+B)+",0 l 0,"+-ma*G/fa+" "+B/3+","+-B/4+" 0,"+ma*G+" z",Ub);v.highColor=ColorScheme.getDerivateColor(ja,.9)}0>=ia||c.match(/LEFT/)||c.match(/VOLUME/)?
(m&&(0==m&&(v=__maptheme_getChartColors("none")),map.Dom.newShape("rect",U,R,-m*G/fa,B,m*G,"fill:"+v.mainColor+";stroke:"+v.borderColor+";stroke-width:"+map.Scale.normalX(.05)+";stroke-opacity:0.3"),map.Dom.newShape("path",U,"M"+(R+B)+",0 l 0,"+-m*G/fa+" "+B/3+","+-B/4+" 0,"+m*G+" z","fill:"+v.lowColor+";stroke:"+v.borderColor+";stroke-width:"+map.Scale.normalX(.05)+""),v.highColor=ColorScheme.getDerivateColor(ja,.9)),map.Dom.newShape("path",U,"M"+R+","+-m*G/fa+" l "+B+",0 "+B/3+","+-B/4+" "+-B+" 0 z",
"fill:"+v.highColor+";stroke:"+v.borderColor+";stroke-width:"+map.Scale.normalX(.05)+";stroke-opacity:1")):(map.Dom.newShape("path",U,"M"+R+",0 l "+B+",0 "+B/3+","+-B/4+" "+-B+" 0 z","fill:"+v.highColor+";stroke:"+v.borderColor+";stroke-width:"+map.Scale.normalX(.05)+";fill-opacity:0.2"),map.Dom.newShape("rect",U,R+B/3,-m*G/fa-B/4,B,m*G,"fill:"+v.mainColor+";stroke:"+v.borderColor+";stroke-width:"+map.Scale.normalX(.05)+";fill-opacity:0.4"),map.Dom.newShape("path",U,"M"+R+",0 l 0,"+-m*G/fa+" "+B/
3+","+-B/4+" 0,"+m*G+" z","fill:"+v.lowColor+";stroke:"+v.borderColor+";stroke-width:"+map.Scale.normalX(.05)+";fill-opacity:0.4"),v.highColor=ColorScheme.getDerivateColor(ja,.9),map.Dom.newShape("rect",U,R,-m*G/fa,B,m*G,"fill:"+v.mainColor+";stroke:"+v.borderColor+";stroke-width:"+map.Scale.normalX(.05)+";fill-opacity:0.4"),map.Dom.newShape("path",U,"M"+(R+B)+",0 l 0,"+-m*G/fa+" "+B/3+","+-B/4+" 0,"+m*G+" z","fill:"+v.lowColor+";stroke:"+v.borderColor+";stroke-width:"+map.Scale.normalX(.05)+";fill-opacity:0.4"),
v.highColor=ColorScheme.getDerivateColor(ja,.9));ma&&(map.Dom.newShape("rect",U,R,-ma*G/fa,B,ma*G,"fill:#FFFFFF;stroke:none;stroke-width:"+map.Scale.normalX(.05)+";fill-opacity:0.25"),ma>m?map.Dom.newShape("path",U,"M"+R+","+-ma*G/fa+" l "+B+",0 "+B/3+","+-B/4+" "+-B+" 0 z","fill:#8888FF;stroke:#444488;stroke-width:"+map.Scale.normalX(.1)+";fill-opacity:0.2"):map.Dom.newShape("path",U,"M"+R+","+-ma*G/fa+" l "+B+",0 "+B/3+","+-B/4+" "+-B+" 0 z","fill:#8888FF;stroke:"+v.borderColor+";stroke-width:"+
map.Scale.normalX(.1)+";fill-opacity:0.1;stroke-opacity:0.4"))}else if(c.match(/Border/)){map.Dom.newShape("rect",U,R,-m*G/fa,B,m*G,"fill:"+ja+";stroke:none;");var Eb=R+2,Fb=R+B-2,Vb=2-m*G/fa,kc=Vb+m*G-2,v=__maptheme_getChartColors(ja);map.Dom.newShape("line",U,Eb,Vb,Eb,kc,"stroke:white;stroke-width:"+map.Scale.normalX(.001)+";stroke-opacity:1.0");map.Dom.newShape("line",U,Eb,Vb,Fb,Vb,"stroke:white;stroke-width:"+map.Scale.normalX(.001)+";stroke-opacity:1.0");map.Dom.newShape("line",U,Eb,kc,Fb,kc,
"stroke:black;stroke-width:"+map.Scale.normalX(.001)+";stroke-opacity:0.9");map.Dom.newShape("line",U,Fb,Vb,Fb,kc,"stroke:black;stroke-width:"+map.Scale.normalX(.001)+";stroke-opacity:0.9")}else if(c.match(/POINTER/)&&m){(c.match(/OFFSETMEAN/)||c.match(/OFFSETMEDIAN/)||c.match(/DEVIATION/))&&1E3<Math.abs(m*G)&&(G=(1E3+(Math.abs(m*G)-1E3)/10+Math.abs(m*G)%1E3)/Math.abs(m));var Wb="fill:"+ja+";fill-opacity:"+(this.fillOpacity||1)+";stroke:"+(this.szLineColor||"black")+";stroke-opacity:0.5;stroke-width:"+
map.Scale.normalX(this.nLineWidth)*Math.sqrt(Ga||1)+"";0>=ia?(!this.fShadow&&this.fOrigShadow&&map.Dom.newShape("path",U,"M"+(R+B/7+10)+","+(-m*G/fa+10)+" l "+-B/7+",0 0,"+-B/15+" "+B/2+","+-B/3+" "+B/2+","+B/3+" 0,"+B/15+" "+-B/7+",0 0,"+m*G+" "+5*-B/7+",0 z","fill:000000;fill-opacity:0.5;stroke:none;"),map.Dom.newShape("path",U,"M"+(R+B/7)+","+-m*G/fa+" l "+-B/7+",0 0,"+-B/15+" "+B/2+","+-B/3+" "+B/2+","+B/3+" 0,"+B/15+" "+-B/7+",0 0,"+m*G+" "+5*-B/7+",0 z",Wb)):c.match(/NONEGATIVE/)||(c.match(/LEFT/)||
(c.match(/ZOOM/)||c.match(/NORMSIZE/)?Wb="fill:"+ja+";stroke:"+ja+";stroke-width:"+map.Scale.normalX(.25)+";fill-opacity:0.5":2<this.partsA.length?(v=__maptheme_getChartColors(ja),Wb="fill:"+ja+";stroke:"+v.lowColor+";stroke-width:"+map.Scale.normalX(.25*this.nLineWidth*Ga||.25)+";fill-opacity:"+(this.nFadeNegative||.1)+";stroke-opacity:0.8"):(v=__maptheme_getChartColors(ja),Wb="fill:"+ja+";stroke:"+v.highColor+";stroke-width:"+map.Scale.normalX(.5*this.nLineWidth*Ga||.5)+";fill-opacity:"+(this.nFadeNegative||
.1)+";stroke-opacity:1")),map.Dom.newShape("path",U,"M"+(R+B/7)+","+-m*G/fa+" l "+5*B/7+",0 0,"+m*G+" "+B/7+",0 "+-B/2+","+B/4+" "+-B/2+","+-B/4+" "+B/7+",0 z",Wb))}else 0>=ia||c.match(/LEFT/)?map.Dom.newShape("rect",U,R,-m*G/fa,B,m*G,"fill:"+ja+";fill-opacity:"+(this.fillOpacity||1)+";stroke:"+(this.szLineColor||"black")+";stroke-width:"+map.Scale.normalX(.25*this.nLineWidth*Ga||.2)+";stroke-opacity:"+(this.nLineWidth?1:.1)+""):map.Dom.newShape("rect",U,R,-m*G/fa,B,m*G,"fill:"+ja+";fill-opacity:"+
(this.fillOpacity||1)+";stroke:"+ja+";stroke-width:"+map.Scale.normalX(.25)+";fill-opacity:0.3"),(ma=this.nFilterA[M])&&(0>=ia||c.match(/LEFT/)?map.Dom.newShape("rect",U,R,-ma*G/fa,B,ma*G,"fill:none;stroke:black;stroke-width:"+map.Scale.normalX(.5)+";stroke-opacity:0.1"):map.Dom.newShape("rect",U,R,-ma*G/fa,B,ma*G,"fill:none;stroke:"+ja+";stroke-width:"+map.Scale.normalX(.5)+";fill-opacity:0.3"));if((c.match(/VALUES/)||this.szXaxisA)&&!(0<ia&&c.match(/NONEGATIVE/))&&(c.match(/ZOOM/)||!this.szValueUpper||
map.Scale.nTrueMapScale*map.Scale.nZoomScale<=this.nValueUpper)){m||(m=0);if(c.match(/AXIS/)&&!c.match(/STACKED/)&&(this.szLabelA||this.szXaxisA)){var Va=M,dc=(this.szXaxisA?this.szXaxisA[Va]:this.szLabelA?this.szLabelA[Va]:" ")||" ",id=.8*P;c.match(/\bUP\b/)&&(id=.9*P);var H=map.Dom.newText(U,0,0,ob+";fill:#666666;text-anchor:end;font-size:"+id+"px"," "+dc+" "),Y=new point(map.Scale.normalX(.8),B/2+P/5*2);this.fNegativeValues?H.setAttributeNS(null,"transform","translate("+(R+Y.y)+","+(-Y.x+.9*P+
10)+") rotate(270)"):c.match(/CENTER/)?H.setAttributeNS(null,"transform","translate("+(R+Y.y)+","+(map.Scale.normalX(f/2)+.9*P)+") rotate(270)"):c.match(/HORZ/)?H.setAttributeNS(null,"transform","translate("+(R+Y.y)+","+(-Y.x+.9*P+10)+") rotate(270)"):(H.style.setProperty("text-anchor","end",""),1==g.length?H.setAttributeNS(null,"transform","translate("+(R+(c.match(/VOLUME/)?1.3*B:1.5*Y.y))+","+-Y.x+") "):1<dc.length?H.setAttributeNS(null,"transform","translate("+(R+Y.y)+","+.8*P+") rotate(315)"):
H.setAttributeNS(null,"transform","translate("+(R+.1*Y.y)+","+(-Y.x+P)+")"))}if(c.match(/VALUES/)&&0<P&&!(this.nGridX&&2<this.partsA.length/this.nGridX)){V=this.formatValue(Ia,this.szValueDecimals||(1>=this.nMax?1:0));c.match(/POINTER/)&&0<Ia&&(0>this.nMin||c.match(/OFFSETMEAN/)||c.match(/OFFSETMEDIAN/)||this.szFlag.match(/\bSIGN\b/))&&(V="+"+V);c.match(/VOLUME/)||(V+=this.szUnit?" "+this.szUnit+" ":"");!c.match(/STACKED/)||0==Ia||q||this.nGridX||(V=V+" ("+Math.round(Ia/r*100)+"%)");c.match(/STACKED/)&&
(P=c.match(/ZOOM/)?map.Scale.normalX(18):map.Scale.normalX(5));var lc=V.length*P*4/8,H=this.createTextLabel(SVGDocument,U,"",V,P/map.Scale.normalX(1),null,0<Ia&&(c.match(/CTEXT/)||c.match(/VALUEBACKGROUND/))?ja:null,this.szTextColor);H.style.setProperty("opacity",String(Za),"");var Lc=Qa=null;this.szXaxisA&&c.match(/CATEGORICAL/)&&!c.match(/AXIS/)&&(Lc=map.Dom.newTSpan(H,"fill:fill:#444444;font-size:"+P+"px"," "+this.szXaxisA[k]));var Gb=H.fu.getBox().width,Y=new point(map.Scale.normalX(-4),B/2+.15*
P),jd=!0;if(c.match(/DOINLINETEXT/)&&!c.match(/ZOOM/)&&!c.match(/NORMSIZE/)||!c.match(/VALUE/)||c.match(/VOLUME/)&&!c.match(/ZOOM/)||!(c.match(/THIN/)||c.match(/NOINLINETEXT/)||c.match(/DTEXT/)||c.match(/SIZE/)||Gb+map.Scale.normalX(1)>m*G/fa||c.match(/STACKED/)||c.match(/NORMSIZE/)||c.match(/ZOOM/))){v=__maptheme_getChartColors(ja);H.removeChild(H.firstChild);H.firstChild.style.setProperty("fill",v.textColor,"");Lc&&Lc.style.setProperty("fill",v.textColor,"");Qa&&Qa.parentNode.removeChild(Qa);var Cd=
map.Scale.normalX(0),zb=map.Scale.normalY(.5);c.match(/VOLUME/)?(L=m*G/(Gb+map.Scale.normalX(2)),H.parentNode.removeChild(H),H=map.Dom.newText(U,R+m*G/2,P*L/4-m*G/2,"font-family:arial;font-size:"+P*L+"px;text-anchor:middle;fill:"+v.textColor+";opacity:"+ta+";stroke:none;pointer-events:none",V)):(L=Math.min(1,m*G/Gb),.33>L?H.parentNode.removeChild(H):(0<Ia&&(Y.x+=Math.max(map.Scale.normalX(1),m*G-(Gb+map.Scale.normalX(3))*L)),zb/=L,H.firstChild.style.setProperty("font-size",String(P*L)),H.firstChild.setAttributeNS(null,
"transform","translate("+(R+Y.y-zb)+","+(-Y.x-Cd)+") rotate(270)\t")));yb.x=Math.max(0,yb.x-m*G)}else if(jd=!1,c.match(/STACKED/))if(0!=m||c.match(/ZEROISVALUE/))if(this.nGridX&&2<g.length/this.nGridX)H.parentNode.removeChild(H);else{Y.x=0;c.match(/3D/)&&(Y.x+=B/4,Y.y+=B/3);var mc=m*G/(c.match(/SUM/),2);yb.x=Math.max(0,yb.x+(.75*P-mc));var nc=new point(yb.x+Y.x+mc-P/3,0),hb=map.Scale.normalX(.5)*Ga,pb=R+Y.y+B/3,qb=R+Y.y+7*B/8,rb=-Y.x-mc,sb=-nc.x-P/3;if(this.nGridX&&jc<this.nGridX){Y.y-=2*B+H.fu.getBox().width;
var Dd=qb,qb=pb-(c.match(/3D/)?1.5*B:1.4*B),pb=Dd-(c.match(/3D/)?7*B/4:1.4*B);c.match(/3D/)&&(rb+=B/5,sb+=B/5,nc.x-=B/7);hb=-hb}H.setAttributeNS(null,"transform","translate("+(R+Y.y+B+hb-P)+","+(-nc.x-.25*P)+") ");var Mc=map.Dom.newGroup(U,""),Nc=map.Dom.newGroup(U,"");map.Dom.newShape("line",Mc,pb,rb,pb+hb,rb,"stroke-width:"+map.Scale.normalX(.15)+";stroke:white;opacity:0.2;");map.Dom.newShape("line",Nc,pb,rb,pb+hb,rb,"stroke-width:"+map.Scale.normalX(.05)+";stroke:#888888;");map.Dom.newShape("line",
Mc,pb+hb,rb,qb,sb,"stroke-width:"+map.Scale.normalX(.15)+";stroke:white;opacity:0.2;stroke-linecap:round;");map.Dom.newShape("line",Nc,pb+hb,rb,qb,sb,"stroke-width:"+map.Scale.normalX(.05)+";stroke:#888888;");map.Dom.newShape("line",Mc,qb,sb,qb+hb,sb,"stroke-width:"+map.Scale.normalX(.15)+";stroke:white;opacity:0.2;");map.Dom.newShape("line",Nc,qb,sb,qb+hb,sb,"stroke-width:"+map.Scale.normalX(.05)+";stroke:#888888;");yb.x=Math.max(0,yb.x+(2*P/3-(m*G-mc)))}else H.parentNode.removeChild(H);else{Y.x+=
B/4;c.match(/3D/)&&(Y.x+=B/4,Y.y=.3*B+P/2);c.match(/POINTER/)&&0<Ia&&(Y.x+=.25*B);var tb=m;Gb+map.Scale.normalX(1)>(ma-m)*G/fa&&(tb=Math.max(m,ma),ma>m&&(tb+=B/G*.2,map.Dom.newShape("line",U,R+.6*B,-Y.x-m*G/fa+B/3,R+.6*B,-Y.x-ma*G/fa-.4*B,"stroke:white;")));c.match(/VOLUME/)&&(tb+=B/5);if(1!=g.length||c.match(/HORZ/)||c.match(/VOLUME/))c.match(/VOLUME/)?H.setAttributeNS(null,"transform","translate("+(R+Y.y)+","+(-Y.x-tb*G/fa)+")  scale(0.9,0.9)"):H.setAttributeNS(null,"transform","translate("+(R+
Y.y)+","+(-10-.25*B-tb*G/fa)+") rotate(270) scale(0.9,0.9)");else{if(c.match(/ZOOM/)||c.match(/NORMSIZE/)){Y.y+=c.match(/3D/)?.75*B:.5*B;var Ed=Math.min(0,.55*P-m*G),kd=P;!c.match(/3D/)&&!c.match(/ZOOM/)||c.match(/SIZE/)||(kd=0);H.setAttributeNS(null,"transform","translate("+(R+kd)+","+(Ed-.5*P)+")")}else Y.y+=c.match(/3D/)?c.match(/VOLUME/)?.75*B:.6*B:.2*B,H.setAttributeNS(null,"transform","translate("+(R-.8*B)+","+(-tb*G/fa-.8*P-(c.match(/POINTER/)&&0<Ia?.3*B:0))+")");0>Ia&&H.style.setProperty("opacity",
String(.75*Za),"")}H.style.setProperty("fill","#404040","")}}}null!=h&&k==h&&(x=2*P,v=__maptheme_getChartColors(ja),map.Dom.newShape("path",U,"M5,0 l 35,-45 -25,0 0,-30 -20,0 0,30 -25,0 35,45","fill:#404040;stroke:white;stroke-width:"+map.Scale.normalX(.2)+"").fu.setPosition(k*(B+1.5)+.5*B,-m*G+(jd?-map.Scale.normalX(3):-Gb-map.Scale.normalX(12))));if(c.match(/TRENDLINE/)){zb=Math.min(m*G/2,map.Scale.normalY(1.5));v=__maptheme_getChartColors(ja);A=v.lowColor;x=P/5;0<k&&(Eb=(k-1)*(B+(c.match(/SPACED/)?
B/5:1))+B/2,Fb=k*(B+(c.match(/SPACED/)?B/5:1))+B/2,A="white",A=ic>m?"#CC3333":ic<m?"#22BB22":v.lowColor,map.Dom.newShape("line",U,Eb,-ic*G+zb,Fb,-m*G+zb,"stroke:#666666;stroke-width:"+map.Scale.normalX(1/g.length*1.2)+";opacity:0.8"));var ld=map.Dom.newShape("circle",U,0,0,x,"fill:"+A+";stroke:none;opacity:0.8");ld&&ld.fu.setPosition(k*(B+(c.match(/SPACED/)?B/5:0))+B/2,-m*G+zb)}c.match(/SILENT/)||(this.szFlag.match(/SEQUENCE/)?U.setAttributeNS(szMapNs,"tooltip",Aa+" ("+(this.szLabelA?this.szLabelA[Q]:
"")+") ["+this.szFieldsA[M]+"]"):(oa=this.szFieldsA[M],this.szLabelA&&this.szLabelA[M]&&(oa=this.szLabelA[M]),Aa+=this.szUnit,!r||this.nGridX||this.szField100&&!this.szFlag.match(/FRACTION/)||(Aa+=" ("+this.formatValue(100/r*m,2)+"%)"),U.setAttributeNS(szMapNs,"tooltip",Aa+" "+oa+"")));c.match(/FADEIN/)&&(2==g.length&&0==k?U.style.setProperty("opacity","0.6",""):c.match(/NORMSIZE/)||(ka=c.match(/FADEINP4/)?10:3,U.style.setProperty("opacity",String(.1+.9*Math.pow(k+1,ka)/Math.pow(g.length,ka)),"")));
c.match(/FADENEGATIVE/)&&0>Ia&&U.style.setProperty("opacity","0.5","");U.setAttributeNS(szMapNs,"class",String(Q));U.fu.setPosition(0,ia);c.match(/STACKED/)?ia-=m*G:(ia=0,R+=B,c.match(/VOLUME/)&&c.match(/SPACED/)?R+=B/(2==g.length?2:4):c.match(/SPACED/)?R+=B/5:c.match(/\bUP\b/)||(R+=1));jc++;c.match(/STACKED/)&&!c.match(/MULTI/)&&this.nGridX&&0==jc%this.nGridX&&(ia=0,R+=B+B/20);ic=m}}c.match(/HOR/)&&Jc.setAttributeNS(null,"transform","rotate(90) translate("+-R+",0)");z.y=0;z.x=0;c.match(/HOR/)?(z.y-=
1*B/2,c.match(/3D/)&&(z.y-=1*B/3)):c.match(/STACKED/)?z.x=B/2:c.match(/Up/)||c.match(/HOR/)?z.x=0:z.x=B*jc/2;c.match(/MENUSIZE/)&&(z.x+=B*(c.match(/HORZ/)?1:0),z.y+=B*(c.match(/HORZ/)?.3:0),z.y+=B*(c.match(/HORZ/)&&c.match(/3D/)?1:c.match(/VOLUME/)?.3:.6));this.nRealizedCount++;var Oc=map.Dom.newGroup(y,"");Oc.appendChild(Jc);c.match(/ZOOM/)&&(L=240/P/(1<g.length?2:1),Oc.fu.scale(L,L));Oc.fu.setPosition(y.fu.getPosition().x-z.x,-z.y);z.x=0;z.y=0;c.match(/HOR/)&&(z.y=1*B/2)}if(c.match(/EXTEND/)&&HTMLWindow.ixmaps.htmlgui_drawChartAfter)try{O=
this.objThemesA[this.szThemesA[0]],HTMLWindow.ixmaps.htmlgui_drawChartAfter(SVGDocument,{target:y,theme:this,item:b,values:g,maxSize:f,flag:c,mark:h,dbRecord:O.dbRecords?O.dbRecords[this.itemA[b].dbIndex]:null})}catch(Hd){}if(!c.match(/NORMSIZE/)){var La=new point(z.x,z.y);z.y=0;z.x=0;this.szAlign&&(c.match(/PLOT/)&&!c.match(/ZOOM/)?(this.szAlign.match(/center/)&&(z.x=map.Scale.normalX(f/2*g.length/(this.nGridX||1)),this.szAlign.match(/top/)||(z.y=-map.Scale.normalX(f/2*g.length/(this.nGridX||1)))),
this.szAlign.match(/right/)&&(z.x=map.Scale.normalX(f*g.length/(this.nGridX||1))),this.szAlign.match(/23right/)&&(z.x=map.Scale.normalX(.66*f*g.length/(this.nGridX||1))),this.szAlign.match(/10\%right/)&&(z.x=map.Scale.normalX(.9*f*g.length/(this.nGridX||1)))):this.nGridX&&!c.match(/ZOOM/)?(this.szAlign.match(/center/)&&(z.x=map.Scale.normalX(f/2/this.partsA.length*g.length/(this.nGridX||1))),this.szAlign.match(/right/)&&(z.x=map.Scale.normalX(f/this.partsA.length*g.length/(this.nGridX||1))),this.szAlign.match(/23right/)&&
(z.x=map.Scale.normalX(f/this.partsA.length*.66*g.length/(this.nGridX||1)))):(this.szAlign.match(/center/)&&(z.y=0),this.szAlign.match(/top/)&&(z.y=La.y?La.y:map.Scale.normalX(f/5)),this.szAlign.match(/above/)&&(z.y=La.y?La.y:map.Scale.normalX(f/2)),this.szAlign.match(/2above/)&&(z.y+=map.Scale.normalX(f/2)),this.szAlign.match(/below/)&&(z.y=-(La.y?La.y:map.Scale.normalX(f/2))),this.szAlign.match(/2below/)&&(z.y-=map.Scale.normalX(f/2)),this.szAlign.match(/bottom/)&&(z.y=-(La.y?La.y:map.Scale.normalX(f/
2))),this.szAlign.match(/2bottom/)&&(z.y-=map.Scale.normalX(f/2)),this.szAlign.match(/right/)&&(z.x=-(La.y?La.y:map.Scale.normalX(f/2))),this.szAlign.match(/2right/)&&(z.x-=map.Scale.normalX(f/2)),this.szAlign.match(/left/)&&(z.x=La.y?La.y:map.Scale.normalX(f/2)),this.szAlign.match(/2left/)&&(z.x+=map.Scale.normalX(f/2)),this.szAlign.match(/baseline/)&&(z.y+=map.Scale.normalY(f/5))))}if(b&&this.szLabelField&&!c.match(/NORMSIZE/)&&!c.match(/ZOOM/)&&(!this.nLabelUpper||map.Scale.nTrueMapScale*map.Scale.nZoomScale<=
this.nLabelUpper)){var oa=(oa=this.itemA[b].szLabel)?isNaN(__scanValue(oa))?oa+(this.szLabelUnits||""):this.formatValue(__scanValue(oa),2)+(this.szLabelUnits||""):this.szLabelField+"?",P=map.Scale.normalX(6),ob="opacity:0.7;font-family:arial;font-size:"+P+"px;text-anchor:middle;fill:#000000;pointer-events:none",Fd="opacity:1;fill:white;fill-opacity:0.4;stroke:#000000;stroke-width:"+map.Scale.normalX(1)+"pointer-events:none;",lc=(oa.length+2)*P*.5,ib=map.Dom.newGroup(y,"");ib.parentNode.append(ib);
c.match(/MULTI/)?ob+=";fill:#888888":ib.setAttributeNS(szMapNs,"class",String(Q));var Hb=map.Dom.newShape("rect",ib,-lc/2,.95*-P,lc,1.2*P,Fd);Hb.setAttributeNS(null,"rx",.2*P);Hb.setAttributeNS(null,"ry",.2*P);H=map.Dom.newText(ib,0,0,ob,oa);hd=H.fu.getBox();B=Math.max(hd.width,lc);Hb.setAttributeNS(null,"x",-B/2);Hb.setAttributeNS(null,"width",B);c.match(/MULTI/)?(ib.fu.setPosition(map.Scale.normalX(15)+.5*B,.77*P),ib.fu.scale(2,2),Hb.parentNode.removeChild(Hb)):ib.fu.setPosition(B/3,P/3+La.y);this.itemA[b].labelGroup=
ib}if(c.match(/MENU/)){var oc=y.fu.getBox();y.fu.setPosition(-oc.x-oc.width/2,-oc.y-oc.height/2-map.Scale.normalY(f/2)-map.Scale.normalY(2))}else c.match(/ZOOM/)||(y.fu.setPosition(y.fu.getPosition().x-z.x,y.fu.getPosition().y-z.y),ea&&ea.fu.setPosition(ea.fu.getPosition().x-z.x,ea.fu.getPosition().y-z.y));if(c.match(/ZOOM/)){var Pc=map.Dom.getBox(e);Pc.height>map.Scale.normalY(150)&&(L=Math.min(1,map.Scale.normalY(150)/Pc.height),L=Math.max(L,map.Scale.normalY(30)/Pc.height),y.fu.scale(L,L),J&&J.fu.scale(L,
L),C&&(C.fu.scale(L,L),na=C.fu.getPosition(),C.fu.setPosition(na.x*L,na.y)))}z.x=0;z.y=0;b&&(this.itemA[b].fDone=!0);this.nChartSizeDone=f;return z};MapTheme.prototype.getShapes=function(){var e=map.Layer.getLayerObj(this.szThemesA[0]);if(!e||!e.szFlag.match(/tiled/))for(a in this.itemA)this.parent.themeNodesA[a]||(this.parent.themeNodesA[a]=this.getShapeA(a))};
MapTheme.prototype.getItemNodes=function(e){this.parent.themeNodesA[e]&&this.parent.themeNodesA[e].length||(this.parent.themeNodesA[e]=this.getShapeA(e));return this.parent.themeNodesA[e]||[]};
MapTheme.prototype.getShapeA=function(e){e=__mpap_decode_utf8(e);var b=SVGDocument.getElementById(e.trim());if(b)return Array(b);if(e.match(/\,/)){var f=e.split("::"),c=f[0].split(",");for(i=0;i<c.length;i++)if(b=SVGDocument.getElementById((c[i]+"::"+f[1]).trim()))return Array(b)}this.nMissingLookupCount++;this.missedA[e]=e;return[]};MapTheme.prototype.getPositions=function(){for(a in this.itemA)this.getNodePosition(this.itemA[a].szSelectionId)};
MapTheme.prototype.getNodePosition=function(e){if("undefined"==typeof e)return null;var b=this.themeNodesPosA;if(!b[e]){if(e.match(/:clone/))return null;if(e.match(/(-?[0-9\.]+) ?, ?(-?[0-9\.]+)/)){var f=this.getMapPosition(e);b[e]=new point(f.x,f.y);return b[e]}this.parent.themeNodesA[e]||(this.parent.themeNodesA[e]=this.getShapeA(e));f=this.parent.themeNodesA[e][0];if(1<this.parent.themeNodesA[e].length)for(var c=parseFloat(f.getAttributeNS(szMapNs,"area")),h=1;h<this.parent.themeNodesA[e].length;h++){var g=
this.parent.themeNodesA[e][h],q=parseFloat(g.getAttributeNS(szMapNs,"area"));q>c&&(c=q,f=g)}f&&(this.szShapeType.match(/line/)?c=map.Dom.getBox(f):((c=f.getAttributeNS(szMapNs,"center"))||(c=f.parentNode.getAttributeNS(szMapNs,"center")),c&&2<c.length?(c=c.split(","),c=new box(Number(c[0].split(":")[1]),Number(c[1].split(":")[1]),0,0)):c=map.Dom.getBox(f)),h=map.Scale.getMapOffset(f),b[e]=new point(h.x+c.x+c.width/2,h.y+c.y+c.height/2),f=getMatrix(f))&&(b[e].x+=f[4],b[e].y+=f[5])}if(b[e]&&"undefined"!=
typeof b[e].x&&"undefined"!=typeof b[e].y)return b[e];this.missedA[e]=e;return null};
MapTheme.prototype.getNodeBox=function(e){if("undefined"==typeof e)return null;if(!this.parent.themeNodesBoxA[e]){if(e.match(/:clone/))return null;this.parent.themeNodesA[e]||(this.parent.themeNodesA[e]=this.getShapeA(e));var b=this.parent.themeNodesA[e][0];if(1<this.parent.themeNodesA[e].length)for(var f=parseFloat(b.getAttributeNS(szMapNs,"area")),c=1;c<this.parent.themeNodesA[e].length;c++){var h=this.parent.themeNodesA[e][c],g=parseFloat(h.getAttributeNS(szMapNs,"area"));g>f&&(f=g,b=h)}b&&(f=
map.Dom.getBox(b),b=map.Scale.getMapOffset(b),this.parent.themeNodesBoxA[e]=new box(b.x+f.x,b.y+f.y,f.width,f.height))}return this.parent.themeNodesBoxA[e]};MapTheme.prototype.getNodeArea=function(e){return(e=this.getItemNodes(e)[0])?Number(e.getAttributeNS(szMapNs,"area"))/1E6:0};positionRegExp=/(-?[0-9\.]+) ?, ?(-?[0-9\.]+)/;
MapTheme.prototype.getMapPosition=function(e){if(e){var b=null;if(e&&(b=e.match(positionRegExp)))return 180<Math.abs(parseFloat(b[1]))||180<Math.abs(parseFloat(b[2]))?new point(0,0):map.Scale.getMapPositionOfLatLon(parseFloat(b[1]),parseFloat(b[2]))}return new point(0,0)};MapTheme.prototype.onClick=function(e){this.fRemove||(this.widgetNode&&this.enable(),this.fToFront=!0,executeWithMessage("map.Themes.execute()","... processing ..."),map.Themes.onclickInfo(e,this.szId))};
MapTheme.prototype.showErrorInfo=function(){if(0!=this.nMissingPositionCount){var e=this.szId+":errordisplay:widget",b=map.Dictionary.getLocalText("Chart statistic"),b=new InfoContainer(SVGDocument,this.widgetNode,e+":movable",new point(map.Scale.normalX(0),map.Scale.normalX(0)),new point(-map.Scale.normalX(15),map.Scale.normalX(80)),"fixed",b),f=b.workspaceNode,c=[map.Dictionary.getLocalText("total items"),map.Dictionary.getLocalText("charts drawn"),map.Dictionary.getLocalText("missing positions"),
map.Dictionary.getLocalText("missing value match"),map.Dictionary.getLocalText("zero values"),String(this.nCount),String(this.nRealizedCount),String(this.nMissingPositionCount),String(this.nMissingRangeCount),String(this.nZeroValueCount)],f=map.Dom.newGroup(f,"");f.fu.setPosition(0,map.Scale.normalY(3));createTextGrid(SVGDocument,f,e+":textgrid",c,2);b.reformat()}};
MapTheme.prototype.getDataGrid=function(e,b){if(this.szFlag.match(/AGGREGATE/)&&3<this.itemA[e].nCount)return null;var f=map.Themes.getDataRow(e,this);if(f&&f.length){for(var c=0;c<f.length;c++)f[c]=f[c]||"---";(c=new ScrollArea(null,b,null,10,10,10))?(c.reformat(),gridGroup=c.workspaceNode):gridGroup=b;for(var h=[],g=map.Themes.getFieldIndexArray(this),q=0;q<g.length;q++)h[g[q]]="font-weight:bold;fill:#087BBB",h[g[q+f.length/2]]="font-weight:bold;fill:#087BBB";g=map.Scale.tStyle.Description.nFontHeight/
map.Scale.normalX(1);f=createTextGrid(SVGDocument,gridGroup,":textgrid",f,2,g,h);return c?(c.setWidth(Math.min(f.fu.getBox().width/map.Scale.normalX(1)+25,map.Scale.bBox.width/map.Scale.normalY(2.2))),c.setHeight(Math.min(f.fu.getBox().height/map.Scale.normalY(1)+25,map.Scale.bBox.height/map.Scale.normalY(1.5))),c.reformat(),c.hasScrollBars()&&c.setScrollPosition(new point(0,0)),c):f.fu}};function __sortYposUp(e,b){return e.y>b.y?1:-1}function __sortYposDown(e,b){return e.y<b.y?1:-1}
MapTheme.prototype.drawTextforOneQuadrant=function(e,b,f,c,h,g,q,l){var r=e.szStyle.match(/3D/)?2.4*f:1.2*f,k=r/2;l-=r*(b.length-2);for(i=0;i<b.length;i++){var w=b[i].y/b[i].ly,m=Math.max(k,Math.min(b[i].y,l)),k=m+r;l+=f;var x=1.2*b[i].x,x=q+map.Scale.normalX(2);m>b[i].y&&(w=Math.max(w,m/b[i].y));var v=e.mX+b[i].lx*h,z=e.mY+b[i].ly*g,y=e.mX+b[i].x*h,J=e.mY+b[i].y*g,x=e.mX+x*h,m=e.mY+m*g,C=map.Dom.newGroup(e.frameGroup,"");e.donutPartsA[b[i].index].textNode=C;var F=map.Dom.newGroup(C,""),u=map.Dom.newGroup(C,
"");w&&(map.Dom.newShape("line",F,v,z,y,J,"stroke:white;stroke-width:"+map.Scale.normalX(1.5)+";opacity:0.2;"),map.Dom.newShape("line",u,v,z,y,J,"stroke:#888888;stroke-width:"+map.Scale.normalX(.5)+";opacity:1;"),v=y,z=J);b[i].x<q-map.Scale.normalX(3)&&(map.Dom.newShape("line",F,v,z,e.mX+(q-map.Scale.normalX(3))*h,z,"stroke:white;stroke-width:"+map.Scale.normalX(1.5)+";opacity:0.2;stroke-linecap:round;"),map.Dom.newShape("line",u,v,z,e.mX+(q-map.Scale.normalX(3))*h,z,"stroke:#888888;stroke-width:"+
map.Scale.normalX(.5)+";opacity:1;"),v=e.mX+(q-map.Scale.normalX(3))*h);map.Dom.newShape("line",F,v,z,x,m,"stroke:white;stroke-width:"+map.Scale.normalX(1.5)+";opacity:0.2;stroke-linecap:round;");map.Dom.newShape("line",u,v,z,x,m,"stroke:#888888;stroke-width:"+map.Scale.normalX(.5)+";opacity:1;");v=x;x+=map.Scale.normalX(2)*h;map.Dom.newShape("line",F,v,m,x,m,"stroke:white;stroke-width:"+map.Scale.normalX(1.5)+";opacity:0.2;");map.Dom.newShape("line",u,v,m,x,m,"stroke:#888888;stroke-width:"+map.Scale.normalX(.5)+
";opacity:1;");x+=map.Scale.normalX(1.5)*h;(szText=e.partsA[b[i].index]&&e.partsA[b[i].index].szText?e.partsA[b[i].index].szText:null)||(szText=e.partsA[b[i].index].szInfo?e.partsA[b[i].index].szInfo:Math.round(10*e.partsA[b[i].index].nInfoValue)/10+" % ");w=this.createTextLabel(SVGDocument,C,"",szText,f/map.Scale.normalX(1),c,this.szFlag.match(/VALUEBACKGROUND/)?e.partsA[b[i].index].color:"white",this.szChartFlag.match(/ZOOM/)?null:this.szTextColor);w.fu.setPosition(x-f,m-0*f);w.setAttributeNS(szMapNs,
"tooltip",e.partsA[b[i].index].szInfo);e.szStyle.match(/3D/)&&w.fu.scale(1,2)}};
MapTheme.prototype.drawDonutText=function(e,b){var f=0,c=0,h=0,g=[],q=[],l=[],r=[],k=Math.min(10,this.partsA.length);for(i=0;i<k;i++){var w=e.getTextPosition(i);if(w){if(this.szShowPartsA){var m=!1;for(p in this.szShowPartsA)this.szShowPartsA[p]==i&&(m=!0);if(!m)continue}f=Math.max(f,Math.abs(w.y));c=Math.max(c,w.x);h=Math.min(h,w.x);e.szStyle.match(/STARBURST/)?(c=Math.max(c,w.x),h=Math.min(h,w.x)):(c=e.nRadOuter,h=-e.nRadOuter);0<w.x?0<w.y?q[q.length]={index:i,x:w.x,y:w.y,lx:w.lx,ly:w.ly}:g[g.length]=
{index:i,x:w.x,y:-w.y,lx:w.lx,ly:-w.ly}:0<w.y?l[l.length]={index:i,x:-w.x,y:w.y,lx:-w.lx,ly:w.ly}:r[r.length]={index:i,x:-w.x,y:-w.y,lx:-w.lx,ly:-w.ly}}}g.sort(__sortYposUp);q.sort(__sortYposUp);l.sort(__sortYposUp);r.sort(__sortYposUp);b||(b=map.Scale.normalX(12));this.drawTextforOneQuadrant(e,g,b,"text-anchor:start;",1,-1,c,f);this.drawTextforOneQuadrant(e,q,b,"text-anchor:start;",1,1,c,f);this.drawTextforOneQuadrant(e,l,b,"text-anchor:end;",-1,1,-h,f);this.drawTextforOneQuadrant(e,r,b,"text-anchor:end;",
-1,-1,-h,f)};
MapTheme.prototype.createTextLabel=function(e,b,f,c,h,g,q,l,r){var k="#555555",w=!0,m=!0,x=1,v=" "+this.szChartFlag+"|"+this.szFlag;if(v.match(/ZOOM/)||v.match(/MENUSIZE/)||v.match(/NORMSIZE/)||v.match(/INFOSIZE/)||v.match(/AXIS/)||v.match(/SELECTION/))w=q?w:!1,m=!1;v.match(/VALUEBACKGROUND/)&&(w=!0);v.match(/HORZ/)&&(w=!1);h||(h=14);g||(g="");q&&w?(k=l||ColorScheme.getTextColor(q),x=v.match(/ZOOM/)?.9:.5):(q="#fefeff",k=0>parseFloat(c)?"#ee3333":l);if(e&&b)return e=map.Dom.newGroup(b,f),b=null,m&&
!this.fShadow&&this.fOrigShadow&&(b=map.Dom.newShape("rect",e,1,1,1,1,"fill:#444444;fill-opacity:0.4;stroke:none;")),q=map.Dom.newShape("rect",e,1,1,1,1,"fill:"+q+";fill-opacity:"+x+";stroke:none;stroke-width:"+map.Scale.normalX(.05*h)+""),g=map.Scale.tStyle.Values.szStyle+(this.szTextFont?"font-family:"+this.szTextFont:"")+";font-size:"+map.Scale.normalY(h)+"px;fill:"+k+";fill-opacity:1;"+g,r&&r.match(/\bGLOW\b/)&&map.Dom.newText(e,map.Scale.normalX(h),map.Scale.normalY(.25*h),g+";font-size:"+map.Scale.normalY(h)+
"px;font-weight:normal;fill:none;stroke:white;stroke-width:"+map.Scale.normalY(h)/5+";stroke-opacity:0.3;pointer-events:none;stroke-linejoin:bevel;",c),map.Dom.newText(e,map.Scale.normalX(h),map.Scale.normalY(.25*h),g,c),c=map.Dom.newText(SVGHiddenGroup,map.Scale.normalX(h),map.Scale.normalY(.25*h),g,c),r=c.fu.getBox(),SVGHiddenGroup.removeChild(c),q.setAttributeNS(null,"rx",map.Scale.normalX(.1*h)),q.setAttributeNS(null,"ry",map.Scale.normalX(.1*h)),q.setAttributeNS(null,"x",r.x-map.Scale.normalX(.3*
h)),q.setAttributeNS(null,"y",r.y-map.Scale.normalY(0*h)),q.setAttributeNS(null,"width",r.width+map.Scale.normalX(.7*h)),q.setAttributeNS(null,"height",r.height+.1*map.Scale.normalY(h)),b&&(b.setAttributeNS(null,"rx",map.Scale.normalX(.1*h)),b.setAttributeNS(null,"ry",map.Scale.normalX(.1*h)),b.setAttributeNS(null,"x",r.x-map.Scale.normalX(.3*h)+map.Scale.normalX(.12*h)),b.setAttributeNS(null,"y",r.y+map.Scale.normalY(0*h)+map.Scale.normalY(.12*h)),b.setAttributeNS(null,"width",r.width+map.Scale.normalX(.7*
h)),b.setAttributeNS(null,"height",r.height+.1*map.Scale.normalY(h))),w||(q.style.setProperty("display","none",""),b&&b.style.setProperty("display","none","")),e};
MapTheme.prototype.getOverviewChart=function(e,b){e.fu=new Methods(e);var f=30;this.szChartFlag+="|MENUSIZE";if(this.szOverviewChart&&"NONE"!=this.szOverviewChart&&this.nCount){var f=map.Scale.normalX(100),c=map.Scale.normalY(100),h=map.Scale.normalX(75),g=map.Scale.normalX(50);if("undefined"!=typeof DonutCharts){var q=map.Dom.newGroup(e),f=DonutCharts.newChart(SVGDocument,q,f,c,h,g);this.szOverviewChart.match(/PIE/)&&(f.setStyle("flat"),f.setRadInner(0),f.setRadOuter(map.Scale.normalX(55)),f.setCenter(map.Scale.normalX(80),
map.Scale.normalY(55)));if(this.szOverviewChart.match(/DONUT/)||this.szOverviewChart.match(/3D/))f.setStyle("3D"),f.setCenter(map.Scale.normalX(80),map.Scale.normalY(100));f.setLine("white");f.setLineWidth(map.Scale.normalX(.1));c=map.Scale.normalY(20);for(h=0;h<this.partsA.length;h++){g=this.partsA[h].nCount/this.nCount*100;q=100/this.nSum*this.partsA[h].nSum;this.nRealizedCount&&this.szFlag.match(/CHART/)&&(g=this.partsA[h].nCount/this.nRealizedCount*100);this.nExactCount&&this.exactSizeA&&(g=this.partsA[h].nCount/
this.nExactCount*100,q=this.exactSizeA[h]);this.szOverviewChart.match(/DONUT/)&&(c=map.Scale.normalY(this.partsA[h].nSum/this.nSum*80));var l=String(this.partsA[h].nCount),r=g?String(" = "+this.formatValue(g,1)+" %"):"",k=q?String(", "+this.szLabelA[h]+" => "+this.formatValue(q,1)+""+this.szUnit):"";this.szOverviewChart.match(/PERCENTOFVALUE/)?(g=q,r="",l=this.nExactCount&&this.exactSizeA?String(this.formatValue(g,0)):String(this.formatValue(g,1)+(this.szFlag.match(/CHART/)?this.szUnit:" %"))):this.szOverviewChart.match(/DONUT/)||
(k="");this.szFlag.match(/CATEGORICAL/)?(r+=" ("+this.szLabelA[h]+")",k=""):this.szLegendLabelA&&this.szLegendLabelA.length&&(r+=" ["+this.szLegendLabelA[h]+"])");f.addPart(g,c,this.partsA[h].color,0,l,String(this.partsA[h].nCount)+" member(s)"+r+k,"map.Themes.markClass(evt,'"+this.szId+"','"+h+"')","map.Themes.unmarkClass(evt,'"+this.szId+"')")}f.realize();this.drawDonutText(f);f=map.Dom.getBox(e);if(0<f.width&&0<f.height){k=e.fu.getPosition();q=this.szOverviewChart.match(/PERCENTOFVALUE/)?"*  value / class":
"*  members / class";c=map.Scale.normalY(10);if(this.szOverviewChart.match(/DONUT/)||this.szOverviewChart.match(/3D/))c=map.Scale.normalY(15);map.Dom.newText(e,map.Scale.normalX(80),f.y+f.height+c,map.Scale.tStyle.Note.szStyle+";text-anchor:middle;",q)}}}else{if((this.szFlag.match(/BUBBLE/)||this.szFlag.match(/SQUARE/)||this.szFlag.match(/SYMBOL/))&&(!this.szFlag.match(/CATEGORICAL/)||!this.szFlag.match(/SYMBOL/))){h=this.nMinA[0];l=this.nMaxA[0];this.szSizeField&&(h=this.nMinSize,l=this.nMaxSize);
c=map.Scale.normalX(f/2);g=c/Math.sqrt(l)*Math.sqrt(h);if(this.szFlag.match(/LINEAR/)||this.szFlag.match(/SIZEP1/))g=c/l*h;q=this.szFlag.match(/SUM/)?"sum":"mean";nLinePos=5;nXPos=20;r=map.Dom.newGroup(e);if(!this.szFlag.match(/CATEGORICAL/)){var w=map.Dom.newGroup(r);this.drawChart(w,null,1.5*f,"VALUES|ZOOM|NORMSIZE");this.szFlag.match(/SEQUENCE/)&&(sChartBox=map.Dom.getBox(w),k=w.fu.getPosition(),w.fu.setPosition(sChartBox.width/1.5+k.x,-sChartBox.height/2+k.y),k=map.Scale.normalX(7*f)/sChartBox.height,
w.fu.scale(k,k),f*=7);map.Dom.newText(r,map.Scale.normalX(0),map.Scale.normalY(5),map.Scale.tStyle.Note.szStyle+";text-anchor:left;",map.Dictionary.getLocalText(q));r.fu.setPosition(map.Scale.normalX(nXPos),map.Scale.normalY(f));nLinePos=f+15}this.szFlag.match(/SEQUENCE/)||(q=map.Dom.newGroup(e),sumBox=map.Dom.getBox(r),q.fu.setPosition(sumBox.x+sumBox.width+map.Scale.normalX(.66*f),map.Scale.normalY(-5)),nLinePos=0,r="fill:none;stroke:black;stroke-width:"+map.Scale.normalX(.25)+"px",k=map.Dom.newGroup(q),
this.szFlag.match(/BUBBLE/)?map.Dom.newShape("circle",k,0,0,c,r):this.szFlag.match(/SQUARE/)&&map.Dom.newShape("rect",k,-c,-c,2*c,2*c,r),map.Dom.newShape("line",k,0,-c,1.1*c,-c,r),map.Dom.newText(k,1.1*c+map.Scale.normalX(2),-c,"font-family:arial;font-size:"+map.Scale.normalX(10)+"px;text-anchor:left;baseline-shift:-10%;fill:black;stroke:none;pointer-events:none",this.formatValue(l,1)+this.szUnit),k.fu.setPosition(map.Scale.normalX(nXPos),map.Scale.normalY(nLinePos+f/2)),0<g&&g!=c&&(l=map.Dom.newGroup(q),
this.szFlag.match(/BUBBLE/)?map.Dom.newShape("circle",l,0,0,g,r):this.szFlag.match(/SQUARE/)&&map.Dom.newShape("rect",l,-g,-g,2*g,2*g,r),map.Dom.newShape("line",l,0,-g,1.1*c,-g,r),map.Dom.newText(l,1.1*c+map.Scale.normalX(2),-g,"font-family:arial;font-size:"+map.Scale.normalX(10)+"px;text-anchor:left;baseline-shift:-60%;fill:black;stroke:none;pointer-events:none",this.formatValue(h,1)+this.szUnit),l.fu.setPosition(map.Scale.normalX(nXPos),map.Scale.normalY(nLinePos)+2*c-g)),map.Dom.newText(q,map.Scale.normalX(nXPos),
map.Scale.normalY(nLinePos+f+15),map.Scale.tStyle.Note.szStyle+";text-anchor:left;",map.Dictionary.getLocalText("min / max size-values")));e.fu.scale(1,1)}this.szFlag.match(/CHART/)&&this.szFlag.match(/BUFFER/)&&(c=map.Scale.normalX(f/2),h=map.Dom.getBox(e.parentNode),h=0<h.width?h.width/map.Scale.normalX(1)+10:10,k=map.Dom.newGroup(e.parentNode),map.Dom.newShape("circle",k,0,0,c,"fill:none;stroke:black;"),r="fill:none;stroke:black;stroke-width:"+map.Scale.normalX(1)+";",map.Dom.newShape("line",k,
0,0,c,0,r),map.Dom.newShape("line",k,0,map.Scale.normalY(-2),0,map.Scale.normalY(2.5),r),map.Dom.newShape("line",k,c,0,c+map.Scale.normalX(-3),map.Scale.normalY(-3),r),map.Dom.newShape("line",k,c,0,c+map.Scale.normalX(-3),map.Scale.normalY(3),r),map.Dom.newText(k,1.1*c+map.Scale.normalX(2),map.Scale.normalX(-10),"font-family:arial;font-size:"+map.Scale.normalX(10)+"px;text-anchor:left;baseline-shift:-10%;fill:black;stroke:none;pointer-events:none",Map.Scale.prototype.formatDistanceString(this.nBufferSize*
this.nScale)),k.fu.setPosition(map.Scale.normalX(f/2+h),map.Scale.normalY(f/2)),chartButtonObj=new Button(e.parentNode,b+":bufferselectbutton","BUTTON","#bufferselect_button","map.Selections.newSelection('activeLayer','activeBuffer','type:BUFFER;buffersize:200','test');","","select active layer with this buffer"),chartButtonObj.setPosition(map.Scale.normalX(f+h+10),map.Scale.normalY(f)),chartButtonObj.scale(1.4,1.4),chartButtonObj=null,_activeTheme&&map.Dom.newText(e.parentNode,map.Scale.normalX(f+
h+20),map.Scale.normalY(f+6),"font-family:arial;font-size:"+map.Scale.normalX(8)+"px;text-anchor:left;baseline-shift:-10%;fill:gray;stroke:none;pointer-events:none","... "+_activeTheme+""));if(!(!this.szFlag.match(/CHART/)||this.szFlag.match(/BUBBLE/)||this.szFlag.match(/SQUARE/)||this.szFlag.match(/CATEGORICAL/)||this.szFlag.match(/BUFFER/)||this.szFlag.match(/SYMBOL/))){c=map.Dom.getBox(e.parentNode);0>c.width&&(c=new box(0,0,0,0));f=30;this.szFlag.match(/BAR/)&&5<this.nOrigSumA.length&&!this.szFlag.match(/STACKED/)&&
(f=15*this.nOrigSumA.length/Math.log(this.nOrigSumA.length));this.drawChart(e,null,f,"VALUES|NORMSIZE"+(this.szFlag.match(/STACKED/)?"|EXPANDMAX":""));f=map.Dom.getBox(e);h=1;h=Math.min(2.5,Math.max(c.height/f.height,map.Scale.normalX(100)/f.height));e.fu=new Methods(e);e.fu.scale(h,h);summarizeGroup=map.Dom.newGroup(e,"textGroup");summarizeGroup.fu.scale(1/h,1/h);f=e.fu.getBox();this.szFlag.match(/BAR/)?e.fu.setPosition(c.width-f.x+map.Scale.normalX(10),-f.y+Math.max(10,.95*c.height-f.height)):e.fu.setPosition(c.width-
f.x+map.Scale.normalX(10),-f.y+Math.max(10,c.height/2-f.height/2));q=" * overall sum";this.szAggregation&&this.szAggregation.match(/mean/)&&(q=" * arithmetic mean");c="middle";if(this.szFlag.match(/RIGHT/)||this.szFlag.match(/STACKED/)||this.szFlag.match(/CENTER/)||this.szFlag.match(/POINTER/)||2>=this.partsA.length)c="start";map.Dom.newText(summarizeGroup,0,f.height+f.y+map.Scale.normalY(5),map.Scale.tStyle.Note.szStyle+"baseline-shift:-100%;text-anchor:"+c+";",q)}}};
MapTheme.prototype.drawColorSchemeLegend=function(e,b){var f=null,c=map.Scale.nButtonSize?.66*map.Scale.nButtonSize:12,h=map.Scale.nButtonSize||12,g=map.Scale.nButtonSize?1.2*map.Scale.nButtonSize:18,q=g,l="font-family:arial;font-size:"+map.Scale.normalY(c)+"px;fill:#666666;pointer-events:none;",r=1.2*h;this.szFlag.match(/BAR/)&&this.szFlag.match(/\bUP\b/)&&(r=h);var k=1.15*c,w=0*r,m=0;this.szFlag.match(/BAR/)&&(this.szFlag.match(/\bUP\b/)||this.szFlag.match(/STACKED/))&&(m=this.partsA.length-1);
this.showInfoMore||this.szFlag.match(/CATEGORICAL/)||this.szFlag.match(/\bUP\b/)||this.szFlag.match(/SYMBOL/)||this.szLabelA&&!this.szFlag.match(/\bCLIP\b/)||2>=this.partsA.length?this.szLegendStyle="large":this.szLegendStyle="compact";var x=new ScrollArea(null,e,null,10,10,10);x?(x.reformat(),f=x.workspaceNode):f=map.Dom.newGroup(e,b+":legend");for(var v=1,z=0;z<this.partsA.length;z++)this.partsA[z].min&&(this.partsA[z].min.toFixed(0)!=this.partsA[z].min&&(v=Math.min(v,.1)),this.partsA[z].min.toFixed(1)!=
this.partsA[z].min&&(v=Math.min(v,.01)));for(var y=[],z=0;z<this.partsA.length;z++)y[z]={},y[z].i=z,y[z].value=this.partsA[z].nCount;this.szFlag.match(/SYMBOL/)&&this.szFlag.match(/CATEGORICAL/)&&this.szFlag.match(/SORTDOWN/)&&y.sort(this.sortIndexDown);!this.szFlag.match(/POINTER/)&&!this.szFlag.match(/INVERT/)||this.szLegendStyle.match(/compact/)||y.reverse();var J=1;!this.szLabelA&&15<y.length&&(J=Math.floor(y.length/10),h*=1.5);var C=this.showInfoMore&&this.isMarkable?18:10,F=!1;if(this.szFlag.match(/CHART/)&&
1<this.szFieldsA.length&&!this.szFlag.match(/OFFSET/)&&!this.szFlag.match(/DEVIATION/)){for(var u=F=0;u<this.nOrigSumA.length;u++)this.partsA[u]&&"undefined"!=typeof this.partsA[u].nSum&&F++;F=F==this.nOrigSumA.length}for(var A=0;A<y.length;A+=J){var z=y[A].i,E=Math.min(Math.abs(m-z),this.partsA.length-J),I=null,u=null;if(this.szFlag.match(/SYMBOL/)&&this.szFlag.match(/CATEGORICAL/))g=0==this.nSkipCount?3*this.partsA[z].nCount/this.nCount*100:30/this.nCount*10*this.partsA[z].nCount;else if(F){u=g=
0;if(this.szFlag.match(/MORPH/)){for(u=0;u<this.nOrigSumA.length/2;u++)g=Math.max(g,this.nOrigSumA[u]*(this.nClipFrames-1-this.nActualFrame)/(this.nClipFrames-1)+this.nOrigSumA[u+this.nOrigSumA.length/2]*this.nActualFrame/(this.nClipFrames-1));u=(this.nOrigSumA[E]*(this.nClipFrames-1-this.nActualFrame)/(this.nClipFrames-1)+this.nOrigSumA[E+this.nOrigSumA.length/2]*this.nActualFrame/(this.nClipFrames-1))/g}else{for(u=0;u<this.nOrigSumA.length;u++)g=Math.max(g,this.partsA[u].nSum);u=this.partsA[E].nSum/
g}g=60*u}g=isNaN(g)?q:g;if(this.szFlag.match(/BUBBLE/))u=this.szFlag.match(/CATEGORICAL/)||this.szSizeField?h/2:h/4+h/4*(z+1)/this.partsA.length,u=map.Dom.newShape("circle",f,map.Scale.normalX(C+h/2),map.Scale.normalY(w+h/2),map.Scale.normalY(u),"fill:"+this.colorScheme[E]+";stroke:#eeeeee;stroke-width:"+map.Scale.normalX(.1)+";");else if(1<J)for(u=map.Dom.newGroup(f,""),I=0;I<J;I++)map.Dom.newShape("rect",u,map.Scale.normalX(C),map.Scale.normalY(w+h/J*I),map.Scale.normalX(g),map.Scale.normalY(h/
J),"fill:"+this.colorScheme[E+I]+";stroke:none;");else u=map.Dom.newShape("rect",f,map.Scale.normalX(C),map.Scale.normalY(w),map.Scale.normalX(g),map.Scale.normalY(h),"fill:"+this.colorScheme[E]+";stroke:#eeeeee;stroke-width:"+map.Scale.normalX(.1)+";");if(u){for(var D=this.partsA[E].nCount,I=1;I<J;I++)D+=this.partsA[E+I].nCount;this.isMarkable&&this.showInfoMore&&(map.Dom.newShape("rect",f,map.Scale.normalX(-5),map.Scale.normalY(w-2),map.Scale.normalX(g),map.Scale.normalY(h+4),"fill:white;stroke:none;opacity:0;").setAttributeNS(null,
"id",this.szId+":widget:background:"+E),buttonObj=new Button(f,this.szId+":class:"+E,"CHECKBOX|SELECTED","","map.Themes.showClass(evt,'"+this.szId+"','"+E+"','"+J+"')","map.Themes.hideClass(evt,'"+this.szId+"','"+E+"','"+J+"')","show/hide class"),buttonObj.setPosition(map.Scale.normalX(map.Scale.nButtonSize/2-1),map.Scale.normalY(w+map.Scale.nButtonSize/2-1)),buttonObj.scale(.75,.75));var I=this.partsA[E].min+(A?v:0),O=this.partsA[E+J-1].max,Oa=100<O-I?0:2;szMin=this.formatValue(I,Oa);szMax=this.formatValue(O,
Oa);szMembers="";this.szFlag.match(/SHOWMEMBERS/)&&(szMembers="  ["+D+"]");szLabel=szMin!=szMax?szMin+"..."+szMax+(this.szLegendUnits?this.szLegendUnits:"")+this.szUnit+szMembers:szMin+(this.szLegendUnits?this.szLegendUnits:"")+this.szUnit+szMembers;(!this.szFlag.match(/\bCLIP\b/)||this.szFlag.match(/MORPH/))&&this.szLabelA&&this.szLabelA[E]&&(szLabel=this.szLabelA[E]);this.szLegendLabelA[E]=szLabel;if(this.szLegendStyle.match(/compact/))this.fGrayNoMember&&0==D&&this.szFlag.match(/CHOROPLETH/)&&
this.szFlag.match(/DOMINANT/)&&(u.style.setProperty("fill-opacity","0.03",""),u.style.getPropertyValue("fill"),u.style.setProperty("stroke-opacity","0.2",""),u.style.setProperty("stroke","black",""),u.style.setProperty("stroke-width",map.Scale.normalX(.3),"")),this.szFlag.match(/CATEGORICAL/)||this.szFlag.match(/DOMINANT/)&&15<szLabel.length||(I=";font-size:"+map.Scale.normalX(.9*c)+"px;",0==A?(szLabel=0<szLabel.length?szMin+this.szUnit:szLabel,map.Dom.newText(f,map.Scale.normalX(C+2),map.Scale.normalY(w+
k*(J+1.5)),l+I,szLabel)):A==y.length-J&&(szLabel=0<szLabel.length?szMax+this.szUnit:szLabel,map.Dom.newText(f,map.Scale.normalX(C+2),map.Scale.normalY(w+k*(J+1.5)),l+I,szLabel)));else if(this.szFlag.match(/SYMBOL/)&&this.szFlag.match(/CATEGORICAL/))I=g+2,O=String(this.partsA[z].nCount),0==this.nSkipCount&&(O=String(Math.round(100/this.nCount*this.partsA[z].nCount))+"%"),Oa=5*O.length/7*c,"dynamic"==this.szTextPlacement&&Oa<g&&(I-=5*String(this.partsA[z].nCount).length/7*c),map.Dom.newText(f,map.Scale.normalX(C+
I),map.Scale.normalY(w+k+1),l,O),I+=Oa,this.szSymbolsA[z]&&this.szSymbolsA[z].match(/symbol/)&&(O=map.Dom.constructNode("use",f,{"xlink:href":"#"+this.szSymbolsA[z]+":antizoomandpan"}),O.setAttributeNS(null,"style","fill:"+this.colorScheme[E]),O.fu.scale(.5,.5),O.fu.setPosition(map.Scale.normalX(C+I+10),map.Scale.normalY(w+k-3)),I+=20),I=map.Dom.newText(f,map.Scale.normalX(C+I),map.Scale.normalY(w+k),l,"("+szLabel+")"),I.style.setProperty("fill","#bbbbdd","");else{I=g+4;if(F){O=this.partsA[E].nSum;
this.szFlag.match(/MORPH/)&&(O=this.nOrigSumA[E]*(this.nClipFrames-1-this.nActualFrame)/(this.nClipFrames-1)+this.nOrigSumA[E+this.nOrigSumA.length/2]*this.nActualFrame/(this.nClipFrames-1));if(this.szField100&&!this.szFlag.match(/SUM/)||this.szAggregation&&!this.szAggregation.match(/sum/))O/=this.partsA[E].nCount;szLabel=szLabel+"  ("+this.formatValue(O,1)+this.szUnit+")"}I=map.Dom.newText(f,map.Scale.normalX(C+I),map.Scale.normalY(w+k),l,szLabel);this.fGrayNoMember&&0==D&&this.szFlag.match(/CHOROPLETH/)&&
(I.style.setProperty("fill","#bbbbdd",""),u.style.setProperty("opacity","0.1",""))}this.szFlag.match(/BUFFER/)&&u.style.setProperty("fill-opacity",this.fillOpacity?this.fillOpacity:this.nOpacity?this.nOpacity:0,"");1==this.szFieldsA.length||!this.szFlag.match(/CHART/)||this.szFlag.match(/SYMBOL/)&&this.szFlag.match(/CATEGORICAL/)?(this.szLegendStyle.match(/compact/)?u.setAttributeNS(szMapNs,"tooltip",szLabel+" ("+D+" member(s))"):u.setAttributeNS(szMapNs,"tooltip",D+" member(s)"),z=u.getAttributeNS(null,
"style"),u.setAttributeNS(szMapNs,"onoverstyle",z+";stroke:black;stroke-width:"+map.Scale.normalX(.5)+";"),u.setAttributeNS(null,"onmouseover","map.Themes.markClass(evt,'"+this.szId+"','"+E+"','"+J+"')"),u.setAttributeNS(null,"onmouseout","map.Themes.unmarkClass(evt,'"+this.szId+"')"),u.setAttributeNS(null,"onclick","map.Themes.zoomToClass(evt,'"+this.szId+"','"+E+"','"+J+"')"),u.setAttributeNS(null,"id",b+":widget:classrect:"+E)):this.szFlag.match(/SYMBOL/)?this.szFlag.match(/CATEGORICAL/)?u.setAttributeNS(szMapNs,
"tooltip",this.partsA[z].nCount+" ("+this.formatValue(this.partsA[z].nCount/this.nCount*100,1)+" %)"):this.szFlag.match(/SEQUENCE/)&&u.setAttributeNS(szMapNs,"tooltip",this.nOrigSumA[z]+" ("+this.formatValue(this.nOrigSumA[z]/this.nSum*100,1)+" %)"):1<this.szFieldsA.length&&!this.szFlag.match(/SEQUENCE/)&&(this.nSum100?u.setAttributeNS(szMapNs,"tooltip",this.formatValue(100/this.nSum100*this.nOrigSumA[E],1)+" %"):this.nSum&&u.setAttributeNS(szMapNs,"tooltip",this.nOrigSumA[E]+" ("+this.formatValue(100/
this.nSum*this.nOrigSumA[E],1)+" %)"),u.setAttributeNS(null,"onmouseover","map.Themes.markClass(evt,'"+this.szId+"','"+E+"','"+J+"')"),u.setAttributeNS(null,"onmouseout","map.Themes.unmarkClass(evt,'"+this.szId+"')"))}this.szLegendStyle.match(/compact/)?C+=g:w+=9*r/10}this.szLegendStyle.match(/compact/)?w+=r*J*2:this.nNoData&&(w+=1.5*r/10,u=map.Dom.newShape("rect",f,0,map.Scale.normalY(w),map.Scale.normalX(g),map.Scale.normalY(h),"fill:"+(this.szNoDataColor?this.szNoDataColor:"#ffffff")+";stroke:#000000;stroke-width:"+
map.Scale.normalX(.1)+";"),u.setAttributeNS(szMapNs,"tooltip",this.nNoData+" member(s)"),u.setAttributeNS(null,"onmouseover","map.Themes.markClass(evt,'"+this.szId+"','"+E+"')"),u.setAttributeNS(null,"onmouseout","map.Themes.unmarkClass(evt,'"+this.szId+"')"),map.Dom.newText(f,map.Scale.normalX(22),map.Scale.normalY(w+k),l,map.Dictionary.getLocalText("no data")),w+=9*r/10);x&&(x.setWidth(-1),x.setHeight(Math.min(w+r,map.Scale.bBox.height/map.Scale.normalY(2.2))),this.nClipColorLegend&&x.setHeight(this.nClipColorLegend),
x.reformat(),x.hasScrollBars()&&(f.style.setProperty("display","none",""),map.Dom.newShape("rect",e,0,0,map.Scale.normalX(x.getWidth()),map.Scale.normalY(x.getHeight()),"fill:none;stroke:none;")));return f};MapTheme.prototype.showInfo=function(){};
MapTheme.prototype.chartButton=function(e,b,f){e=map.Dom.newGroup(e,"chartvari"+String(Math.random()));var c=this.szFlag;"2D"==f&&this.removeDefinitionFromFlag("3D");this.szFlag+="|NORMSIZE|SILENT|MENUSIZE|"+f;this.drawChart(e,null,b);this.szFlag=c;c=map.Dom.getBox(e);this.addChartTypeSign(e,f);f=Math.min(map.Scale.normalX(b)/c.width,map.Scale.normalY(b)/c.height);e.fu.scale(f,f);e.fu.setPosition(map.Scale.normalX(b+10),map.Scale.normalY(b)*f);return e};
MapTheme.prototype.addDefinitionToFlag=function(e){return this.szFlag=this.szFlag+"|"+e};MapTheme.prototype.removeDefinitionFromFlag=function(e){for(var b="",f=this.szFlag.split("|"),c=0;c<f.length;c++)f[c]!=e&&(b+=(b.length?"|":"")+f[c]);return this.szFlag=b};MapTheme.prototype.removeDefinition=function(e,b){for(var f="",c=e.split("|"),h=0;h<c.length;h++)c[h]!=b&&(f+=(f.length?"|":"")+c[h]);return f};
MapTheme.prototype.addChartTypeSign=function(e,b){var f="M0,0 l"+map.Scale.normalX(1.5)+",-"+map.Scale.normalX(1.5)+" 0,"+map.Scale.normalX(3)+" -"+map.Scale.normalX(1.5)+",-"+map.Scale.normalX(1.5)+" M"+map.Scale.normalX(2.5)+",0 l"+map.Scale.normalX(17.5)+",0 M"+map.Scale.normalX(22.5)+",0 l-"+map.Scale.normalX(1.5)+",-"+map.Scale.normalX(1.5)+" 0,"+map.Scale.normalX(3)+" "+map.Scale.normalX(1.5)+",-"+map.Scale.normalX(1.5)+"";if(b.match(/SIZE/)){var c=map.Dom.newGroup(e,"");map.Dom.newShape("path",
c,f,"stroke:white;stroke-width:"+map.Scale.normalX(4)+";stroke-opacity:0.5;stroke-linejoin:miter;stroke-linecap:square;");map.Dom.newShape("path",c,f,"stroke:#666666;stroke-width:"+map.Scale.normalX(1.5)+";stroke-linejoin:miter;stroke-linecap:square;");c.fu.setPosition(-map.Scale.normalX(10),map.Scale.normalX(-5))}b.match(/HEIGHT/)&&(c=map.Dom.newGroup(e,""),map.Dom.newShape("path",c,f,"stroke:white;stroke-width:"+map.Scale.normalX(4)+";stroke-opacity:0.5;stroke-linejoin:miter;stroke-linecap:square;"),
map.Dom.newShape("path",c,f,"stroke:#666666;stroke-width:"+map.Scale.normalX(1.5)+";stroke-linejoin:miter;stroke-linecap:square;"),c.setAttributeNS(null,"transform","translate(0,"+-map.Scale.normalX(25)+") rotate(90)"))};
MapTheme.prototype.getChartTypeMenu=function(e,b,f){"undefined"==typeof szChartTypeList&&(szChartTypeList="CHART|BAR CHART|BAR|3D CHART|BAR|3D|SORT CHART|BAR|HORZ|LEFT|UP CHART|BAR|HORZ|RIGHT|UP CHART|BAR|HORZ|LEFT|UP|COMPRESS CHART|BAR|HORZ|RIGHT|UP|COMPRESS CHART|BAR|HORZ|LEFT|UP|3D CHART|BAR|HORZ|RIGHT|UP|3D CHART|BAR|HORZ|LEFT|UP|COMPRESS|3D CHART|BAR|HORZ|RIGHT|UP|COMPRESS|3D CHART|BAR|HORZ|CENTER|UP CHART|BAR|STACKED CHART|BAR|STACKED|3D CHART|BAR|SORT|3D|COLUMNS|STACKED CHART|BAR|SORT|3D|COLUMNS|STACKED|SIZE CHART|PIE CHART|PIE|SIZE CHART|PIE|3D CHART|PIE|3D|SIZE CHART|PIE|3D|HEIGHT CHART|PIE|3D|VOLUME CHART|PIE|DONUT CHART|PIE|DONUT|SIZE CHART|PIE|DONUT|3D CHART|PIE|DONUT|3D|SIZE CHART|PIE|DONUT|3D|HEIGHT CHART|PIE|DONUT|3D|VOLUME CHART|PIE|STARBURST CHART|PIE|STARBURST|SIZE CHART|PIE|STARBURST|3D CHART|PIE|STARBURST|3D|SIZE CHART|PIE|STARBURST|3D|HEIGHT CHART|PIE|STARBURST|3D|VOLUME CHART|PIE|DONUT|STARBURST CHART|PIE|DONUT|STARBURST|SIZE CHART|PIE|DONUT|STARBURST|3D CHART|PIE|DONUT|STARBURST|3D|SIZE CHART|PIE|DONUT|STARBURST|3D|HEIGHT CHART|PIE|DONUT|STARBURST|3D|VOLUME".split(" "));"undefined"==
typeof szChartTypeListSingleValue_old&&(szChartTypeListSingleValue_old="CHART|BAR CHART|BAR|VALUES CHART|BAR|3D CHART|BAR|3D|VALUES CHART|BAR|3D|VOLUME CHART|BAR|3D|VOLUME|VALUES CHART|BAR|HORZ|RIGHT|UP CHART|BAR|HORZ|RIGHT|UP|VALUES CHART|BAR|HORZ|RIGHT|UP|3D CHART|BAR|HORZ|RIGHT|UP|VALUES|3D CHART|BAR|POINTER CHART|BAR|POINTER|VALUES CHART|BUBBLE|SURFACE CHART|BUBBLE|SURFACE|VALUES CHART|SQUARE|SURFACE CHART|SQUARE|SURFACE|VALUES".split(" "));"undefined"==typeof szChartTypeListSingleValue&&(szChartTypeListSingleValue=
"CHOROPLETH CHART|BUBBLE CHART|SQUARE CHART|PIE|3D|SIZE CHART|PIE|3D|HEIGHT CHART|PIE|3D|SIZE|HEIGHT CHART|BAR|3D|VOLUME CHART|BAR CHART|BAR|3D CHART|BAR|3D|SIZE CHART|BAR|HORZ|RIGHT|UP CHART|BAR|HORZ|RIGHT|UP|3D CHART|BAR|POINTER CHART|BAR|POINTER|SIZE CHART|BAR|HORZ|RIGHT|UP|POINTER CHART|LABEL".split(" "));var c=this.szOrigFlag;b=szChartTypeListSingleValue;if(1<this.szFieldsA.length||this.szFlag.match(/CATEGORICAL/)&&this.szFlag.match(/AGGREGATE/))b=szChartTypeList;f=f?f/60:3;for(i=0;i<b.length;i++){merkFlag=
this.szFlag;var h=map.Dom.constructNode("a",e,{});map.Dom.newShape("rect",h,map.Scale.normalX(i%f*60),map.Scale.normalY(60*Math.floor(i/f)),map.Scale.normalX(60),map.Scale.normalY(60),"fill:#f8f8ff;stroke:lightgray;stroke-dasharray:50 50;stroke-width:"+map.Scale.normalX(1)+";");var g=map.Dom.newGroup(h,"szDisplayId:chart:"+String(Math.random()));map.Dom.setClipRect(g,new box(-map.Scale.normalX(25),-map.Scale.normalX(60),map.Scale.normalX(60),map.Scale.normalX(60)));this.szFlag=b[i]+"|NORMSIZE|SILENT|MENUSIZE";
merkFlag.match(/CATEGORICAL/)&&(this.szFlag+="|CATEGORICAL");merkFlag.match(/GROUP/)&&(this.szFlag+="|GROUP");merkFlag.match(/AGGREGATE/)&&(this.szFlag+="|AGGREGATE");merkFlag.match(/COMPATIBLE/)&&(this.szFlag+="|COMPATIBLE");merkFlag.match(/FAST/)&&(this.szFlag+="|FAST");merkFlag.match(/RELOCATE/)&&(this.szFlag+="|RELOCATE");merkFlag.match(/DIFFERENCE/)&&(this.szFlag+="|DIFFERENCE");merkFlag.match(/FRACTION/)&&(this.szFlag+="|FRACTION");merkFlag.match(/INVERT/)&&(this.szFlag+="|INVERT");merkFlag.match(/INVERTSIZE/)&&
(this.szFlag+="|INVERTSIZE");merkFlag.match(/RELATIVE/)&&(this.szFlag+="|RELATIVE");merkFlag.match(/DENSITY/)&&(this.szFlag+="|DENSITY");merkFlag.match(/DOPACITYMAX/)?this.szFlag+="|DOPACITYMAX":merkFlag.match(/DOPACITYLOGMAX/)?this.szFlag+="|DOPACITYLOGMAX":merkFlag.match(/DOPACITYPOWMAX/)?this.szFlag+="|DOPACITYPOWMAX":merkFlag.match(/DOPACITYMEAN/)?this.szFlag+="|DOPACITYMEAN":merkFlag.match(/DOPACITYLOGMEAN/)?this.szFlag+="|DOPACITYLOGMEAN":merkFlag.match(/DOPACITYPOWMEAN/)?this.szFlag+="|DOPACITYPOWMEAN":
merkFlag.match(/DOPACITYLOG/)?this.szFlag+="|DOPACITYLOG":merkFlag.match(/DOPACITY/)&&(this.szFlag+="|DOPACITY");merkFlag.match(/AUTO100/)&&(this.szFlag+="|AUTO100");merkFlag.match(/AUTOCOMPLETE/)&&(this.szFlag+="|AUTOCOMPLETE");var q=this.szAggregation,l=this.nClipParts;this.nClipParts=10;var r=this.drawChart(g,null,40);"undefined"===typeof l?delete this.nClipParts:this.nClipParts=l;this.szAggregation=q;if(r){this.szFlag=merkFlag;var k=map.Scale.normalX(10);r.x-=map.Scale.normalX(60/f);g.fu.setPosition(k-
r.x+i%f*map.Scale.normalX(60),map.Scale.normalY(40)+k+r.y+Math.floor(i/f)*map.Scale.normalY(60));g.setAttributeNS(null,"clip-path","");nScale=900/Math.max(g.fu.getBox().width,g.fu.getBox().height);1>nScale&&g.fu.scale(nScale,nScale);k="";c.match(/UNDEFINEDISVALUE/)&&(k+="|UNDEFINEDISVALUE");c.match(/ZEROISVALUE/)&&(k+="|ZEROISVALUE");c.match(/NEGATIVEISVALUE/)&&(k+="|NEGATIVEISVALUE");c.match(/NONEGATIVE/)&&(k+="|NEGATIVEISVALUE");c.match(/GROUP/)&&(k+="|GROUP");c.match(/AGGREGATE/)&&(k+="|AGGREGATE");
c.match(/COMPATIBLE/)&&(k+="|COMPATIBLE");c.match(/FAST/)&&(k+="|FAST");c.match(/\bRECT\b/)&&(k+="|RECT");c.match(/HEX/)&&(k+="|HEX");c.match(/RELOCATE/)&&(k+="|RELOCATE");c.match(/CATEGORICAL/)&&(k+="|CATEGORICAL");c.match(/SUM/)&&(k+="|SUM");c.match(/MEAN/)&&(k+="|MEAN");c.match(/DIFFERENCE/)&&(k+="|DIFFERENCE");c.match(/RELATIVE/)&&(k+="|RELATIVE");c.match(/INVERT/)&&(k+="|INVERT");c.match(/INVERTSIZE/)&&(k+="|INVERTSIZE");c.match(/CALCMEAN/)&&(k+="|CALCMEAN");c.match(/CALC100/)&&(k+="|CALC100");
c.match(/PRODUCT/)&&(k+="|PRODUCT");c.match(/AUTOCOMPLETE/)&&(k+="|AUTOCOMPLETE");c.match(/AUTO100/)&&(k+="|AUTO100");c.match(/QUANTILE/)&&(k+="|QUANTILE");c.match(/DENSITY/)&&(k+="|DENSITY");c.match(/DOPACITY/)&&(k+="|DOPACITY");if(c.match(/VALUES/)||merkFlag.match(/VALUES/))k+="|VALUES";c.match(/VALUEBACKGROUND/)&&(k+="|VALUEBACKGROUND");b[i].match(/SIZE/)&&(merkFlag.match(/SIZELOG/)?k+="|SIZELOG":merkFlag.match(/SIZEP4/)?k+="|SIZEP4":merkFlag.match(/SIZEP3/)?k+="|SIZEP3":merkFlag.match(/SIZE/)&&
(k+="|SIZE"));merkFlag.match(/SPACED/)&&(k+="|SPACED");h.setAttributeNS(null,"onclick","map.Themes.changeThemeStyle(evt,'"+this.szId+"','type:"+b[i]+k+"')");this.addChartTypeSign(g,b[i])}}e=[];for(a in b)e.push(b[a]+k);return e};MapTheme.prototype.formatValue=function(e,b,f){return isNaN(e)?e:999<this.nMin&&3E3>this.nMax?__formatValue(e,b,f+"|NOBREAKS"):__formatValue(e,b,f)};MapTheme.prototype.remove=function(e){this.parent.removeTheme(e,this.szId)};
MapTheme.prototype.removeElements=function(e){this.widgetNode&&(widgetList.removeWidget(this.widgetNode),this.widgetNode.parentNode.removeChild(this.widgetNode),this.widgetNode=null);this.clipTimeout&&clearTimeout(this.clipTimeout);this.unpaintMap();if(this.onremove)try{eval(this.onremove)}catch(b){}try{HTMLWindow.ixmaps.htmlgui_onRemoveTheme(this.szId)}catch(f){}};
MapTheme.prototype.removeMapThemeStyles=function(e){e=e.split("|");for(var b=SVGRootElement.getElementsByTagName("path"),f=0;f<b.length;f++)if(1==b.item(f).nodeType){var c=b.item(f).parentNode.getAttributeNS(null,"id"),h=!1;if(c&&0!==c.length)for(var c=map.Tiles.getMasterId(c).split(":")[0],g=0;g<e.length;g++)c==e[g]&&(h=!0);h&&b.item(f).parentNode.removeAttributeNS(null,"style")}};
MapTheme.prototype.disable=function(){if(!this.szFlag.match(/CHART/)&&this.widgetNode)for(var e=this.widgetNode.getElementsByTagName("g"),b=0;b<e.length;b++)e.item(b).setAttributeNS(null,"opacity","0.9")};MapTheme.prototype.enable=function(){if(this.widgetNode){for(var e=this.widgetNode.getElementsByTagName("g"),b=0;b<e.length;b++)e.item(b).setAttributeNS(null,"opacity","1.0");this.widgetNode.parentNode.appendChild(this.widgetNode)}map.Themes.setActive(this)};
MapTheme.prototype.makeVisible=function(){for(var e=0;e<this.szThemesA.length;e++)map.Layer.isLayerOn(this.szThemesA[e])||map.Layer.isScaleDependentLayer(this.szThemesA[e])||(map.Themes.switchedLayerA[this.szThemesA[e]]=!0,map.Api.switchMapTheme(this.szThemesA[e],"on")),map.Tiles.switchScaleDependentTiles()};
MapTheme.prototype.checkVisible=function(){for(var e=0;e<this.szThemesA.length;e++)map.Themes.isThemeLayerUsed(this.szThemesA[e])&&this.isVisible||!map.Themes.switchedLayerA[this.szThemesA[e]]||(map.Api.switchMapTheme(this.szThemesA[e],"off"),map.Themes.switchedLayerA[this.szThemesA[e]]=null)};
MapTheme.prototype.resize=function(e){999!=e&&(this.nScale*=e);if(this.szFlag.match(/BUFFER/)&&this.szShapeType.match(/line/))this.fRedrawInfo=this.fRedraw=!0,this.nSkipCount=1,map.Themes.execute();else{map.Layer.changeObjectScaling(null,e,this.chartGroup);this.szFlag.match(/DECLUTTER/)&&this.declutterCharts();if(this.szFlag.match(/BUFFER/)){var b=this.chartGroup.getElementsByTagName("circle");for(n=0;n<b.length;n++){var f=b.item(n).getAttributeNS(null,"style");f&&f.length&&(szNewStylesValue=__scaleStyleString(f,
1/e),b.item(n).setAttributeNS(null,"style",szNewStylesValue))}}this.f=!0;this.showInfo()}};MapTheme.prototype.offset=function(e){var b=this.chartGroup.fu.getPosition();this.chartGroup.fu.setPosition(b.x+e.x,b.y+e.y)};
MapTheme.prototype.opacity=function(e){this.fillOpacity=(this.fillOpacity?this.fillOpacity:1)*e;this.fillOpacity=Math.min(1,this.fillOpacity);this.fillOpacity=Math.max(0,this.fillOpacity);this.nOpacity=(this.nOpacity?this.nOpacity:1)*e;this.nOpacity=Math.min(1,this.nOpacity);this.nOpacity=Math.max(0,this.nOpacity);if(this.chartGroup)for(var b=this.chartGroup.childNodes,f=0;f<b.length;f++)map.Layer.changeNodeOpacity(b.item(f),e);else if(this.szShapeType.match(/line/))for(f=0;f<this.szThemesA.length;f++)map.Layer.changeLayerOpacity(this.szThemesA[f],
e);else for(a in this.itemA)for(b=this.getItemNodes(a),f=0;f<b.length;f++)map.Layer.changeNodeOpacity(b[f],e,"fill-opacity")};
MapTheme.prototype.blur=function(e){if(this.chartGroup)if(this.nBlur){szBlurFilterId="blur-3";var b=SVGDocument.getElementById(szBlurFilterId);b?b.firstChild.setAttributeNS(null,"stdDeviation",map.Scale.normalX(e)):(b=map.Dom.newNode("filter",this.chartGroup.parentNode),b.setAttributeNS(null,"id",szBlurFilterId),filter=map.Dom.newNode("feGaussianBlur",b),filter.setAttributeNS(null,"stdDeviation",map.Scale.normalX(e)));this.chartGroup.style.setProperty("filter","url(#"+szBlurFilterId+")","")}else this.chartGroup.style.removeProperty("filter");
else if(this.szThemesA[0]){var f=SVGDocument.getElementById("maplayer");f&&(this.nBlur?(szBlurFilterId="blur-map",(b=SVGDocument.getElementById(szBlurFilterId))?b.firstChild.setAttributeNS(null,"stdDeviation",map.Scale.normalX(e)/map.Zoom.nZoom):(b=map.Dom.newNode("filter",f.parentNode),b.setAttributeNS(null,"id",szBlurFilterId),b.setAttributeNS(null,"x",0),b.setAttributeNS(null,"y",0),b.setAttributeNS(null,"width","100%"),b.setAttributeNS(null,"height","100%"),filter=map.Dom.newNode("feGaussianBlur",
b),filter.setAttributeNS(null,"stdDeviation",map.Scale.normalX(e)/map.Zoom.nZoom)),f.style.setProperty("filter","url(#"+szBlurFilterId+")","")):f.style.removeProperty("filter"))}};
MapTheme.prototype.toggle=function(e){this.chartGroup?1==e||"undefined"==typeof e&&"none"==this.chartGroup.style.getPropertyValue("display")?(this.chartGroup.style.setProperty("display","inline",""),this.chartGroup.display="inline"):(this.chartGroup.style.setProperty("display","none",""),this.chartGroup.display="none"):this.isChecked?(this.unpaintMap(),this.isChecked=!1,map.Themes.activateNextPaint(this)&&(this.fToggle=!1,map.Themes.execute(),this.widgetNode&&(this.widgetNode.setAttributeNS(null,
"opacity","1.0"),this.widgetNode.parentNode.appendChild(this.widgetNode)))):(this.fRedraw=this.isChecked=!0,this.fToggle=!1,map.Themes.execute())};MapTheme.prototype.getHistogram=function(e,b,f){map.Themes.getHistogram(e,b,f,this)};var __maptheme_chartcolors=[];function __maptheme_getChartColors(e){__maptheme_chartcolors[e]||(__maptheme_chartcolors[e]=new ChartColors(e));return __maptheme_chartcolors[e]}
function ChartColors(e){"string"!=typeof e&&(e="#ffffff");this.mainColor=e;this.lowColor=ColorScheme.getDerivateColor(e,.7);this.highColor=ColorScheme.getDerivateColor(e,1.3);this.borderColor=ColorScheme.getBorderColor(e);this.textColor=ColorScheme.getTextColor(e)}function __mpap_hex2dec(e){return parseInt(e,16)}
function __mpap_decode_utf8(e){if("string"==typeof e&&e.match(/&#x/)){var b="";sA=e.split("&#x");b=sA[0];for(e=1;e<sA.length;e++)b+=String.fromCharCode(__mpap_hex2dec(sA[e].substr(0,2))),b+=sA[e].substr(3,sA[e].length-3);return b}return e};
