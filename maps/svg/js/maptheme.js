var themeStyleTranslateA=[{style:"opacity",obj:"nOpacity"},{style:"fillopacity",obj:"fillOpacity"},{style:"autoopacity",obj:"autoOpacity"},{style:"shadow",obj:"fOrigShadow"},{style:"blur",obj:"nBlur"},{style:"filter",obj:"szFilter"},{style:"dfilter",obj:"nDeltaFilter"},{style:"filterfield",obj:"szFilterField"},{style:"dbtable",obj:"coTable"},{style:"dbtableUrl",obj:"coTableUrl"},{style:"dbtableType",obj:"coTableType"},{style:"dbtableExt",obj:"coTableExt"},{style:"datacache",obj:"fDataCache"},{style:"itemfield",
obj:"szItemField"},{style:"lookupfield",obj:"szSelectionField"},{style:"lookuptoupper",obj:"fSelectionFieldToUpper"},{style:"lookupsuffix",obj:"szSelectionFieldSuffix"},{style:"lookupdigits",obj:"nSelectionFieldDigits"},{style:"lookuptonumber",obj:"fSelectionFieldToNumber"},{style:"showdata",obj:"fShowData"},{style:"datafields",obj:"szDataFieldsA",type:"array"},{style:"userdraw",obj:"userDraw"},{style:"child",obj:"fChild"},{style:"ranges",obj:"szRangesA",type:"array"},{style:"rangecentervalue",obj:"nRangeCenterValue"},
{style:"symbols",obj:"szSymbolsA",type:"array"},{style:"values",obj:"szValuesA",type:"array",delimiter:"|"},{style:"label",obj:"szOrigLabelA",type:"array",delimiter:"|"},{style:"valuemap",obj:"valueMap",type:"object"},{style:"xaxis",obj:"szXaxisA",type:"array"},{style:"units",obj:"szUnits"},{style:"labelunits",obj:"szLabelUnits"},{style:"units100",obj:"szUnits100"},{style:"sizevalueunits",obj:"szSizeValueUnits"},{style:"alphavalueunits",obj:"szAlphaValueUnits"},{style:"legendunits",obj:"szLegendUnits"},
{style:"weights",obj:"szWeights"},{style:"align",obj:"szAlign"},{style:"normalsizevalue",obj:"nNormalSizeValue"},{style:"normalsizescale",obj:"szNormalSizeScale"},{style:"scale",obj:"nScale"},{style:"rangescale",obj:"nRangeScale"},{style:"colorfield",obj:"szColorField"},{style:"valuefield",obj:"szValueField"},{style:"labelfield",obj:"szLabelField"},{style:"sizefield",obj:"szSizeField"},{style:"alphafield",obj:"szAlphaField"},{style:"alphafield100",obj:"szAlphaField100"},{style:"xfield",obj:"szXField"},
{style:"yfield",obj:"szYField"},{style:"dopacitypow",obj:"nDopacityPow"},{style:"dopacityramp",obj:"szDopacityRamp"},{style:"dopacityscale",obj:"nDopacityScale"},{style:"buffersize",obj:"nBufferSize"},{style:"bufferstep",obj:"nBufferSizeStep"},{style:"field100min",obj:"nField100Min"},{style:"fractionscale",obj:"nFractionScale"},{style:"minvalue",obj:"nMinValue"},{style:"maxvalue",obj:"nMaxValue"},{style:"textfont",obj:"szTextFont"},{style:"textcolor",obj:"szTextColor"},{style:"linecolor",obj:"szLineColor"},
{style:"linewidth",obj:"nLineWidth"},{style:"bordercolor",obj:"szBorderColor"},{style:"borderstyle",obj:"szBorderStyle"},{style:"borderwidth",obj:"szBorderWidth"},{style:"borderradius",obj:"nBorderRadius"},{style:"boxcolor",obj:"szBoxColor"},{style:"boxopacity",obj:"nBoxOpacity"},{style:"boxmargin",obj:"nBoxMargin"},{style:"textplacement",obj:"szTextPlacement"},{style:"infotitle",obj:"szInfoTitle"},{style:"titlefield",obj:"szTitleField"},{style:"snippetfield",obj:"szSnippetField"},{style:"exclude",
obj:"szExcludeA",type:"array"},{style:"nodatacolor",obj:"szNoDataColor"},{style:"titleupper",obj:"szTitleUpper"},{style:"labelupper",obj:"szLabelUpper"},{style:"valueupper",obj:"szValueUpper"},{style:"glowupper",obj:"szGlowUpper"},{style:"glowlower",obj:"szGlowLower"},{style:"chartupper",obj:"szChartUpper"},{style:"chartlower",obj:"szChartLower"},{style:"boxupper",obj:"szBoxUpper"},{style:"shadowupper",obj:"szShadowUpper"},{style:"shadowlower",obj:"szShadowLower"},{style:"declutterupper",obj:"szDeclutterUpper"},
{style:"valuescale",obj:"nValueScale"},{style:"minvaluesize",obj:"nValueSizeMin"},{style:"valuedecimals",obj:"szValueDecimals"},{style:"fadevaluepow",obj:"szFadeValuePow"},{style:"fadenegative",obj:"nFadeNegative"},{style:"centerpart",obj:"szCenterPart"},{style:"clipframes",obj:"nClipFrames"},{style:"clipframerate",obj:"nClipFrameRate"},{style:"cliplegend",obj:"nClipColorLegend"},{style:"clipparts",obj:"nClipParts"},{style:"minchartsize",obj:"nChartSizeMin"},{style:"showparts",obj:"szShowParts"},
{style:"gridx",obj:"nGridX"},{style:"gridwidth",obj:"nGridWidth"},{style:"gridmatrix",obj:"nGridMatrix"},{style:"gridwidthpx",obj:"nGridWidthPx"},{style:"aggregationfield",obj:"szAggregationField"},{style:"aggregationscale",obj:"szAggregationFieldA",type:"array"},{style:"aggregation",obj:"szAggregation"},{style:"minaggregation",obj:"szMinAggregation"},{style:"aggregationupper",obj:"szAggregationUpper"},{style:"aggregationlower",obj:"szAggregationLower"},{style:"dominantfilter",obj:"szDominantFilter"},
{style:"dominantdfilter",obj:"nDominantDFilter"},{style:"overviewchart",obj:"szOverviewChart"},{style:"evidence",obj:"evidenceMode"},{style:"markclass",obj:"markedClass"},{style:"markclasses",obj:"markedClassesA",type:"array"},{style:"name",obj:"szName"},{style:"title",obj:"szTitle"},{style:"snippet",obj:"szSnippet"},{style:"description",obj:"szDescription"}];
function __maptheme_getStyleString(e){for(var b="",f=0;f<themeStyleTranslateA.length;f++)b+=__maptheme_getOneStyleProperty(e[themeStyleTranslateA[f].obj],themeStyleTranslateA[f].style,themeStyleTranslateA[f].type,themeStyleTranslateA[f].delimiter);return b.replace(/\"/gi,'\\"')}
function __maptheme_getOneStyleProperty(e,b,f,c){c=c?c:",";if("undefined"!=typeof e&&null!=e)if(f&&"undefined"!=typeof f){if("array"==f&&e&&e.length)return e=e.join(c),b+":"+e+";";if("object"==f&&e)return b+":"+JSON.stringify(e)+";"}else return b+":"+String(e)+";";return""}function __getArrayString(e,b){var f="";if(e&&"undefined"!=e&&"undefined"!=typeof e)for(var c=0;c<e.length;c++)f+=(0<c?b:"")+String(e[c]).replace(/\'/gi," ").replace(/\"/gi," ");return f}
function __maptheme_getStyleObj(e){for(var b={},f=0;f<themeStyleTranslateA.length;f++)null!=e[themeStyleTranslateA[f].obj]&&"undefined"!=e[themeStyleTranslateA[f].obj]&&(b[themeStyleTranslateA[f].style]=e[themeStyleTranslateA[f].obj]);return b}function __isdef(e){return"undefined"!==typeof e&&null!=e}
Map.Themes=function(){this.themesA=[];this.themeNodesA=[];this.themeNodesPosA=[];this.themeNodesBoxA=[];this.themeNodes=0;this.activeBuffer=this.activeTheme=null;this.switchedLayerA=[];this.enableMultiChoropleth=this.enableChartOffset=!1;this.enableSubThemes=!0;this.szChoroplethInfoStyle="histogram";this.nMaxThemeCharts=5E5;this.nMaxShadowCharts=1E3;this.nflushPaintShape=5E3;this.nflushChartDraw=1E3;this.nColorSchemeMaxHeight=120;this.autoHideInfoTools=this.allwaysShowValues=!1;this.themeDataCacheA=
[]};Map.Themes.prototype=new Map;if("string"==typeof thisversion&&map.checkVersion(thisversion)){map.Themes=new Map.Themes;try{HTMLWindow.ixmaps.htmlgui_onInitThemes()}catch(e$$4){}}else alert("Map.Themes incompatible !");Map.Themes.prototype.addTheme=function(e){this.themesA[this.themesA.length]=e;if(!e.szFlag.match(/selection/i))try{HTMLWindow.ixmaps.htmlgui_onNewTheme(e.szId)}catch(b){}};Map.Themes.prototype.getThemeCount=function(){return this.themesA.length};
Map.Themes.prototype.getAllThemes=function(){return this.themesA};Map.Themes.prototype.isTheme=function(e){for(var b=0;b<this.themesA.length;b++)if(this.themesA[b].szIdStr&&this.themesA[b].szIdStr==e)return this.themesA[b];return!1};
Map.Themes.prototype.newTheme=function(e,b,f,c,h,g){if(map.isIdle()){("undefined"!=typeof e&&"string"!=typeof e||"undefined"!=typeof b&&"string"!=typeof b||"undefined"!=typeof f&&"string"!=typeof f||"undefined"!=typeof c&&"string"!=typeof c||"undefined"!=typeof h&&"string"!=typeof h||"undefined"!=typeof g&&"string"!=typeof g)&&alert("ERROR: only string argument allowed !");var m=e+b+f+c+h+g;if(!c.match(/FORCE/)&&this.isTheme(m))return this.removeTheme(null,this.isTheme(m).szId),null;var l=g&&"undefined"!=
g?g.split("|"):null,q=g=null;if(q=(q=c.split("style="))&&1<q.length?__getStyleObj(q[1]):__getStyleObj(c))g=[5,"white","blue"],q.colorscheme&&(g=q.colorscheme.match(/\|/)||q.colorscheme.match(/RGB/)?q.colorscheme.split("|"):q.colorscheme.split(",")),g=new MapTheme(e,b,f,q.type,g,h,l),g.nOrder=this.getThemeCount(),g.szIdStr=m,this.parseStyle(g,q);this.allwaysShowValues&&(g.szFlag+="|VALUES");g.parent=this;this.addTheme(g);g.fRealize=!0;if(g.coTable)return this.loadExternalData(g.coTable,g.nRefreshTimeout,
g),g;if(fLoadExternalData){e=e.split("|");for(b=0;b<e.length;b++)this.loadExternalData(e[b],g.nRefreshTimeout,g);return g}map.Event.doDefaultZoom();executeWithMessage("map.Themes.execute()","... processing ...");return g}setTimeout('map.Themes.newTheme("'+e+'","'+b+'","'+f+'","'+c.replace(/\"/gi,'\\"')+'","'+h+'","'+g+'")',250)};Map.Themes.prototype.isArray=function(e){return"[object Array]"===Object.prototype.toString.call(e)};
Map.Themes.prototype.toArray=function(e){return this.isArray(e)?e:String(e).match(/\|/)?String(e).split("|"):String(e).split(",")};Map.Themes.prototype.toString=function(e){return this.isArray(e)?e.join("|"):e};
Map.Themes.prototype.newThemeByObj=function(e){if(map.isIdle()){if(e=e||this.newThemeObjA.pop()){var b=JSON.stringify(e);if(!e.style.type.match(/FORCE/)&&this.isTheme(b))return this.removeTheme(null,this.isTheme(b).szId),null;var f=null,c=e.style;if(!c)return null;if(this.isArray(c.label))var f=c.label,h=c.label.join("|");else f=(h=c.label)&&"undefined"!=h?h.split("|"):null;h=[5,"white","blue"];c.colorscheme&&(h=this.toArray(c.colorscheme));e.layer=this.toString(e.layer);e.field=this.toString(e.field);
f=new MapTheme(e.layer,e.field,e.field100,c.type,h,c.title,f);f.nOrder=this.getThemeCount();f.szIdStr=b;this.parseStyle(f,c);this.allwaysShowValues&&(f.szFlag+="|VALUES");f.parent=this;this.addTheme(f);f.fRealize=!0;if(f.coTable)return this.loadExternalData(f.coTable,f.nRefreshTimeout,f),f;if(fLoadExternalData){e=e.layer.split("|");for(b=0;b<e.length;b++)this.loadExternalData(e[b],f.nRefreshTimeout,f);return f}map.Event.doDefaultZoom();executeWithMessage("map.Themes.execute()","... processing ...");
return f}}else e&&(this.newThemeObjA=this.newThemeObjA||[],this.newThemeObjA.push(e)),setTimeout("map.Themes.newThemeByObj()",100)};
Map.Themes.prototype.parseStyle=function(e,b){if(e&&b){if(__isdef(b.classes)){if(isNaN(Number(e.origColorScheme[0]))){var f=e.origColorScheme[e.origColorScheme.length-1];e.origColorScheme[1]=e.origColorScheme[0];e.origColorScheme[2]=f}e.origColorScheme[0]=Number(b.classes)}__isdef(b.colorstyle)&&"spectrum"==e.origColorScheme[1]&&(e.origColorScheme[2]=b.colorstyle);__isdef(b.dominantdfilter)&&(e.nDominantDFilter=Number(b.dominantdfilter));__isdef(b.dominantfilter)&&(e.szDominantFilter=String(b.dominantfilter));
__isdef(b.filter)&&(e.szFilter=String(b.filter));__isdef(b.filterfield)&&(e.szFilterField=String(b.filterfield));__isdef(b.filtervalue)&&(e.szFilterValue=String(b.filtervalue));__isdef(b.overviewchart)&&(e.szOverviewChart=b.overviewchart);__isdef(b.evidence)&&(e.evidenceMode=b.evidence);__isdef(b.markclass)&&(e.markedClass=b.markclass,e.markedClasses||(e.markedClasses=[],e.markedClasses[e.markedClass]=!0,e.markedClassesA=[e.markedClass]));__isdef(b.markclasses)&&(e.markedClassesA=this.toArray(b.markclasses),
e.markedClasses=[],e.markedClassesA.forEach(function(b,f){b.length&&(e.markedClasses[b]=!0)}));__isdef(b.fillopacity)&&("auto"==b.fillopacity?(e.autoOpacity=!0,e.fillOpacity=0):e.fillOpacity=Number(b.fillopacity));__isdef(b.opacity)&&("auto"==b.opacity?(e.autoOpacity=!0,e.fillOpacity=0):e.nOpacity=Number(b.opacity));__isdef(b.autoopacity)&&(e.autoOpacity=!0,e.fillOpacity=0);__isdef(b.shadow)?e.fShadow=e.fOrigShadow=JSON.parse(b.shadow):e.fShadow=e.fOrigShadow=!1;__isdef(b.maxshadow)&&(e.nMaxShadowCharts=
Number(b.maxshadow));__isdef(b.blur)&&(e.nBlur=Number(b.blur));__isdef(b.dbtable)&&(f=b.dbtable.split(" "),e.coTable=f[0],2==f.length&&(e.coTableType="jsonDB",e.coTableUrl=f[1].split("(")[1].split(")")[0]),3==f.length&&(e.coTableType=f[1],e.coTableUrl=f[2].split("(")[1].split(")")[0]),4==f.length&&(e.coTableType=f[1],e.coTableUrl=f[2].split("(")[1].split(")")[0],e.coTableExt=f[3].split("(")[1].split(")")[0]));__isdef(b.dbtableType)&&(e.coTableType=b.dbtableType);__isdef(b.dbtableUrl)&&(e.coTableUrl=
b.dbtableUrl);__isdef(b.dbtableExt)&&(e.coTableExt=b.dbtableExt);__isdef(b.lookupfield)&&(e.szSelectionField=e.szItemField=b.lookupfield);__isdef(b.lookuptoupper)&&(e.fSelectionFieldToUpper=JSON.parse(b.lookuptoupper));__isdef(b.lookupsuffix)&&(e.szSelectionFieldSuffix=b.lookupsuffix);__isdef(b.lookupprefix)&&(e.szSelectionFieldPrefix=b.lookupprefix);__isdef(b.lookupdigits)&&(e.nSelectionFieldDigits=Number(b.lookupdigits));__isdef(b.lookuptonumber)&&(e.fSelectionFieldToNumber=JSON.parse(b.lookuptonumber));
__isdef(b.itemfield)&&(e.szItemField=b.itemfield);__isdef(b.ranges)&&(e.szRangesA=this.toArray(b.ranges),e.szRanges=this.toString(b.ranges));__isdef(b.symbols)&&(e.szSymbolsA=this.toArray(b.symbols));if(__isdef(b.values)&&(e.szValuesA=this.toArray(b.values),b.type.match(/EXACT/)&&e.szValuesA.length))for(f=0;f<e.szValuesA.length;f++)e.getStringValueIndex(e.szValuesA[f],"set");__isdef(b.align)&&(e.szAlign=b.align);__isdef(b.units)&&(e.szUnits=b.units);__isdef(b.units100)&&(e.szUnits100=b.units100);
__isdef(b.sizevalueunits)&&(e.szSizeValueUnits=" "+b.sizevalueunits);__isdef(b.alphavalueunits)&&(e.szAlphaValueUnits=" "+b.alphavalueunits);__isdef(b.legendunits)&&(e.szLegendUnits=" "+b.legendunits);__isdef(b.labelunits)&&(e.szLabelUnits=" "+b.labelunits);__isdef(b.xaxis)&&(e.szXaxisA=this.toArray(b.xaxis));__isdef(b.id)&&(e.szId=unescape(b.id));__isdef(b.name)&&(e.szName=unescape(b.name));__isdef(b.title)&&(e.szTitle=unescape(b.title));__isdef(b.snippet)&&(e.szSnippet=unescape(b.snippet));__isdef(b.description)&&
(e.szDescription=unescape(b.description));__isdef(b.label)&&(e.szLabelA=e.szOrigLabelA=this.toArray(b.label));__isdef(b.weights)&&(e.szWeightsA=this.toArray(b.weights),e.szWeights=this.toString(b.weights));__isdef(b.weight)&&(e.szWeightsA=[b.weights],e.szWeights=b.weight);__isdef(b.scale)&&(e.nScale=Number(b.scale));__isdef(b.colorfield)&&(e.szColorField=b.colorfield);__isdef(b.valuefield)&&(e.szValueField=b.valuefield);__isdef(b.labelfield)&&(e.szLabelField=b.labelfield);__isdef(b.titlefield)&&(e.szTitleField=
b.titlefield);__isdef(b.snippetfield)&&(e.szSnippetField=b.snippetfield);__isdef(b.sizefield)&&(e.szSizeField=b.sizefield);__isdef(b.alphafield)&&(e.szAlphaField=b.alphafield);__isdef(b.alphafield100)&&(e.szAlphaField100=b.alphafield100);__isdef(b.xfield)&&(e.szXField=b.xfield);__isdef(b.yfield)&&(e.szYField=b.yfield);__isdef(b.refresh)&&(e.nRefreshTimeout=1E3*Number(b.refresh));__isdef(b.buffersize)&&(e.nBufferSize=b.buffersize);__isdef(b.bufferstep)&&(e.nBufferSizeStep=b.bufferstep);__isdef(b.field100min)&&
(e.nField100Min=b.field100min);__isdef(b.fractionscale)&&(e.nFractionScale=b.fractionscale);__isdef(b.minvalue)&&(e.nMinValue=b.minvalue);__isdef(b.maxvalue)&&(e.nMaxValue=b.maxvalue);__isdef(b.showdata)&&(e.fShowData=JSON.parse(b.showdata));__isdef(b.datacache)&&(e.fDataCache=JSON.parse(b.datacache));__isdef(b.editor)&&(e.fEditor=JSON.parse(b.editor));__isdef(b.datafields)&&(e.szDataFieldsA=this.toArray(b.datafields));__isdef(b.textcolor)&&(e.szTextColor=b.textcolor);__isdef(b.textfont)&&(e.szTextFont=
b.textfont);__isdef(b.linecolor)&&(e.szLineColor=b.linecolor);__isdef(b.linewidth)&&(e.nLineWidth=b.linewidth);__isdef(b.bordercolor)&&(e.szBorderColor=b.bordercolor);__isdef(b.borderstyle)&&(e.szBorderStyle=b.borderstyle);__isdef(b.borderwidth)&&(e.szBorderWidth=b.borderwidth);__isdef(b.borderradius)&&(e.nBorderRadius=Number(b.borderradius));__isdef(b.boxcolor)&&(e.szBoxColor=b.boxcolor);__isdef(b.boxopacity)&&(e.nBoxOpacity=b.boxopacity);__isdef(b.boxmargin)&&(e.nBoxMargin=b.boxmargin);__isdef(b.textplacement)&&
(e.szTextPlacement=b.textplacement);__isdef(b.infotitle)&&(e.szInfoTitle=b.infotitle);__isdef(b.exclude)&&(e.szExcludeA=this.toArray(b.exclude));__isdef(b.aggregation)&&(e.szAggregation=b.aggregation);__isdef(b.rangecentervalue)&&(e.nRangeCenterValue=Number(b.rangecentervalue));__isdef(b.rangescale)&&(e.nRangeScale=b.rangescale);__isdef(b.normalsizevalue)&&(e.nNormalSizeValue=b.normalsizevalue);__isdef(b.normalsizescale)&&(e.szNormalSizeScale=b.normalsizescale,e.nNormalSizeScale=__scanScaleValue(e.szNormalSizeScale));
__isdef(b.nodatacolor)&&(e.szNoDataColor=__getSaveColor(b.nodatacolor));__isdef(b.boxupper)&&(e.szBoxUpper=b.boxupper,e.nBoxUpper=__scanScaleValue(e.szBoxUpper));__isdef(b.titleupper)&&(e.szTitleUpper=b.titleupper,e.nTitleUpper=__scanScaleValue(e.szTitleUpper));__isdef(b.labelupper)&&(e.szLabelUpper=b.labelupper,e.nLabelUpper=__scanScaleValue(e.szLabelUpper));__isdef(b.valueupper)&&(e.szValueUpper=b.valueupper,e.nValueUpper=__scanScaleValue(e.szValueUpper));__isdef(b.valuesupper)&&(e.szValueUpper=
b.valuesupper,e.nValueUpper=__scanScaleValue(e.szValueUpper));__isdef(b.glowupper)&&(e.szGlowUpper=b.glowupper,e.nGlowUpper=__scanScaleValue(e.szGlowUpper));__isdef(b.glowlower)&&(e.szGlowLower=b.glowlower,e.nGlowLower=__scanScaleValue(e.szGlowLower));__isdef(b.chartupper)&&(e.szChartUpper=b.chartupper,e.nChartUpper=__scanScaleValue(e.szChartUpper));__isdef(b.chartlower)&&(e.szChartLower=b.chartlower,e.nChartLower=__scanScaleValue(e.szChartLower));__isdef(b.shadowupper)&&(e.szShadowUpper=b.shadowupper,
e.nShadowUpper=__scanScaleValue(e.szShadowUpper));__isdef(b.shadowlower)&&(e.szShadowLower=b.shadowlower,e.nShadowLower=__scanScaleValue(e.szShadowLower));__isdef(b.declutterupper)&&(e.szDeclutterUpper=b.declutterupper,e.nDeclutterUpper=__scanScaleValue(e.szDeclutterUpper));__isdef(b.valuescale)&&(e.nValueScale=Number(b.valuescale));__isdef(b.clipframes)&&(e.nClipFrames=b.clipframes);__isdef(b.clipframerate)&&(e.nClipFrameRate=b.clipframerate,e.nClipTimeout=1/Number(b.clipframerate)*1E3);__isdef(b.cliplegend)&&
(e.nClipColorLegend=Number(b.cliplegend));__isdef(b.clipvaluesize)&&(e.nValueSizeMin=Number(b.clipvaluesize));__isdef(b.minvaluesize)&&(e.nValueSizeMin=Number(b.minvaluesize));__isdef(b.valuedecimals)&&(e.szValueDecimals=b.valuedecimals);__isdef(b.fadevaluepow)&&(e.szFadeValuePow=b.fadevaluepow);__isdef(b.dopacityscale)&&(e.nDopacityScale=b.dopacityscale);__isdef(b.dopacityramp)&&(e.szDopacityRamp=b.dopacityramp);__isdef(b.dopacitypow)&&(e.nDopacityPow=b.dopacitypow);__isdef(b.fadenegative)&&(e.nFadeNegative=
Number(b.fadenegative)||.5);__isdef(b.clipparts)&&(e.nClipParts=Number(b.clipparts)||0);__isdef(b.minsize)&&(e.nChartSizeMin=Number(b.minsize)||0);__isdef(b.minchartsize)&&(e.nChartSizeMin=Number(b.minchartsize)||0);__isdef(b.clipsize)&&(e.nChartSizeMin=Number(b.clipsize)||0);__isdef(b.showparts)&&(e.szShowParts=this.toString(b.showparts),e.szShowPartsA=this.toArray(b.showparts));__isdef(b.gridx)&&(e.nGridX=Number(b.gridx)||1);__isdef(b.gridwidth)&&(String(b.gridwidth).match(/px/)&&(e.nGridWidthPx=
parseFloat(b.gridwidth)||50,map.Themes.doChangeThemeStyle(e.szId,"AUTOGRID","add")),e.nGridWidth=Number(b.gridwidth)||0);__isdef(b.gridmatrix)&&(e.nGridMatrix=Number(b.gridmatrix)||20,map.Themes.doChangeThemeStyle(e.szId,"AUTOGRID","add"));__isdef(b.gridwidthpx)&&(e.nGridWidthPx=Number(b.gridwidthpx)||50,map.Themes.doChangeThemeStyle(e.szId,"AUTOGRID","add"));__isdef(b.aggregationfield)&&(e.szAggregationField=b.aggregationfield);__isdef(b.aggregationscale)&&(e.szAggregationFieldA=this.toArray(b.aggregationscale));
__isdef(b.minaggregation)&&(e.szMinAggregation=b.minaggregation,e.nMinAggregation=Number(b.minaggregation)||0);__isdef(b.aggregationupper)&&(e.szAggregationUpper=b.aggregationupper,e.nAggregationUpper=__scanScaleValue(e.szAggregationUpper));__isdef(b.aggregationlower)&&(e.szAggregationLower=b.aggregationlower,e.nAggregationLower=__scanScaleValue(e.szAggregationLower));__isdef(b.userdraw)&&(e.userDraw=b.userdraw);__isdef(b.centerpart)&&(e.szCenterPart=this.toString(b.centerpart));__isdef(b.child)&&
(e.fChild=!0);__isdef(b.valuemap)&&(e.valueMap=b.valuemap)}};Map.Themes.prototype.getAllThemeDefinitionStrings=function(){for(var e=[],b=0;b<this.themesA.length;b++)e.push(this.getThemeDefinitionString(this.themesA[b]));return e};__toRGB=function(e){var b,f;b=parseInt(e.substr(1,2),16);f=parseInt(e.substr(3,2),16);e=parseInt(e.substr(5,2),16);return"RGB("+b+","+f+","+e+")"};__getSaveColor=function(e){try{if("#"==e.charAt(0))return __toRGB(e)}catch(b){}return e};
__getSaveColorScheme=function(e){for(var b=0;b<e.length;b++)e[b]=__getSaveColor(e[b]);return e.join("|")};__scanScaleValue=function(e){return String(e).match(/:/)?Number(e.split(":")[1]):Number(e)};
Map.Themes.prototype.cleanUpThemeObj=function(e){var b=e.style;if(b.symbols){var f=b.symbols[0];for(i in b.symbols)if(b.symbols[i]!=f){f=null;break}f&&(b.symbols.length=1)}b.aggregationfield?(b.aggregationscale=null,b.gridwidth=null,b.gridwidthpx=null):b.aggregationscale?(b.gridwidth=null,b.gridwidthpx=null):b.gridwidthpx&&(b.gridwidth=null);b.evidence&&"isolate"==b.evidence&&(b.evidence=null);b.aggregation&&(b.aggregation=null);b.type.match(/DOMINANT/)||b.type.match(/PERCENTOFMEAN/)||b.type.match(/OFFSETMEAN/)||
b.type.match(/PERCENTOFMEAN/)||b.type.match(/DEVIATION/)||(b.dominantfilter=null,b.dominantdfilter=null);return e};Map.Themes.prototype.getThemeDefinitionString=function(e){return'map.Api.newMapTheme("'+e.szThemes+'","'+(e.szFields||"")+'","'+(e.szField100||"")+'","type:'+e.szFlag+";colorscheme:"+__getSaveColorScheme(e.origColorScheme)+";"+__maptheme_getStyleString(e)+';child:true;");'};
Map.Themes.prototype.getMapThemeStyleString=function(e){return(e=this.getTheme(e)||this.activeTheme)&&e.colorScheme?"type:"+e.szFlag+";colorscheme:"+e.colorScheme+";"+__maptheme_getStyleString(e)+"":null};Map.Themes.prototype.getMapThemeDefinitionObj=function(e){var b=this.getTheme(e)||this.activeTheme;e={};e.layer=b.szThemes;e.field=b.szFields||"";e.field100=b.szField100||"";var f={type:b.szFlag,colorscheme:b.origColorScheme},b=__maptheme_getStyleObj(b);for(a in b)f[a]=b[a];e.style=f;return this.cleanUpThemeObj(e)};
Map.Themes.prototype.getTheme=function(e){for(var b=0;b<this.themesA.length;b++)if(this.themesA[b].szId==e||this.themesA[b].szName==e)return this.themesA[b];return this.activeTheme};Map.Themes.prototype.getThemeIndex=function(e){for(var b=0;b<this.themesA.length;b++)if(this.themesA[b].szId==e)return b};
Map.Themes.prototype.refreshTheme=function(e){if(e=this.getTheme((e||"").split(":")[0])){e.fRealize=!0;e.fRedraw=!0;if(!fAllIncluded){if(e.coTable){this.loadExternalData(e.coTable,!0,e);return}if(fLoadExternalData){for(var b=szThemes.split("|"),f=0;f<b.length;f++)this.loadExternalData(b[f],!0,e);return}}executeWithMessage("map.Themes.execute()","... processing ...")}};Map.Themes.prototype.nextClipFrame=function(e){(e=this.getTheme(e.split(":")[0]))&&e.realizeNextClipFrame()};
Map.Themes.prototype.setClipFrame=function(e,b){var f=e?this.getTheme(e.split(":")[0]):this.activeTheme;f&&f.setClipFrame(b)};Map.Themes.prototype.pauseClip=function(e){(e=this.getTheme(e.split(":")[0]))&&e.pauseClip()};Map.Themes.prototype.startClip=function(e){(e=this.getTheme(e.split(":")[0]))&&e.startClip()};
Map.Themes.prototype.loadExternalData=function(e,b,f){this.coTableExt||(this.coTableExt=[]);if(e){var c=map.Dictionary.getLocalText("... creating theme ...");b&&(eval(e+".table = null"),c=map.Dictionary.getLocalText("... refreshing theme ..."));this.__test=null;try{eval("this.__test = "+e+".table")}catch(h){try{eval("this.__test = "+e+"_table")}catch(g){}}var m=f.fEditor||!(f.coTableUrl&&f.coTableExt)||!1;this.themeDataCacheA[e]&&((this.themeDataCacheA[e].coTableUrl||f.coTableUrl)&&this.themeDataCacheA[e].coTableUrl!=
f.coTableUrl||(this.themeDataCacheA[e].coTableExt||f.coTableExt)&&this.themeDataCacheA[e].coTableExt!=f.coTableExt||(m=!0));if(this.__test&&m&&0!=f.fDataCache)this.fWaitingforData=!1,executeWithMessage("map.Themes.execute()",c),f&&f.coTableExt&&(f.coTableExt=this.coTableExt[f.coTable]);else{if(f&&(f.coTableUrl||f.coTableExt))try{this.themeDataCacheA[e]={coTableUrl:f.coTableUrl,coTableExt:f.coTableExt};this.fWaitingforData=!0;SVGMessageGroup.fu.clear();HTMLWindow.ixmaps.htmlgui_loadExternalData(f.coTableUrl,
{theme:f,type:f.coTableType,name:f.coTable,ext:f.coTableExt});this.coTableExt[f.coTable]=f.coTableExt;return}catch(l){}fLocalHost?this.loadExternalDataDefault(e,b,c):this.loadExternalDataZipped(e,b,c)}}};
Map.Themes.prototype.loadExternalDataUrlZipped=function(e,b,f,c){this.fWaitingforData=!0;displayMessage(map.Dictionary.getLocalText("... loading data ..."));var h=new JSLoader;h.finishedCallback="map.Themes.loadExternalDataFinish('"+c+"')";h.errorCallback="map.Themes.loadExternalDataUrl('"+e+"','"+b+"',"+f+",'"+c+"')";h.szMessage=map.Dictionary.getLocalText("... loading data ...");h.loadScript(b+".gz",f)};
Map.Themes.prototype.loadExternalDataUrl=function(e,b,f,c){this.fWaitingforData=!0;displayMessage(map.Dictionary.getLocalText("... loading data ..."));var h=new JSLoader;h.finishedCallback="map.Themes.loadExternalDataFinish('"+c+"')";h.errorCallback="map.Themes.loadExternalDataDefault('"+e+"',"+f+",'"+c+"')";h.szMessage=map.Dictionary.getLocalText("... loading data ...");h.loadScript(b,f)};
Map.Themes.prototype.loadExternalDataZipped=function(e,b,f){this.fWaitingforData=!0;displayMessage(map.Dictionary.getLocalText("... loading data ..."));var c=new JSLoader;c.finishedCallback="map.Themes.loadExternalDataFinish('"+f+"')";c.errorCallback="map.Themes.loadExternalDataDefault('"+e+"',"+b+",'"+f+"')";c.szMessage=map.Dictionary.getLocalText("... loading data ...");c.loadScript(e+".js.gz",b)};
Map.Themes.prototype.loadExternalDataDefault=function(e,b,f){this.fWaitingforData=!0;displayMessage(map.Dictionary.getLocalText("... loading data ..."));var c=new JSLoader;c.finishedCallback="map.Themes.loadExternalDataFinish('"+f+"')";c.errorCallback="map.Themes.loadExternalDataFinish('"+f+"')";c.szMessage=map.Dictionary.getLocalText("... loading data ...");c.loadScript(e+".js",b)};
Map.Themes.prototype.loadExternalDataFinish=function(e){this.fWaitingforData=!1;executeWithMessage("map.Themes.execute()",e)};Map.Themes.prototype.activateTheme=function(e,b){var f=this.getTheme(b.split(":")[0]);f&&(f.fRedraw=!0,executeWithMessage("map.Themes.execute()","... processing ..."));e.stopPropagation();e.preventDefault()};
Map.Themes.prototype.removeTheme=function(e,b){var f=this.getTheme(b.split(":")[0]);f&&(f.szFlag.match(/CHART/)&&(f.fToggle=!0),f.fRemove=!0,executeWithMessage("map.Themes.execute()","... processing ..."));e&&(e.stopPropagation(),e.preventDefault())};Map.Themes.prototype.removeAll=function(e){for(var b=0;b<this.themesA.length;b++)this.themesA[b].szFlag.match(/LOCKED/)||(this.themesA[b].fRemove=!this.themesA[b].fRealize);map.Themes.execute();e&&(e.stopPropagation(),e.preventDefault())};
Map.Themes.prototype.removeAllCharts=function(e){for(var b=0;b<this.themesA.length;b++)this.themesA[b].szFlag.match(/CHART/)&&!this.themesA[b].szFlag.match(/LOCKED/)&&(this.themesA[b].fRemove=!this.themesA[b].fRealize);map.Themes.execute();e&&(e.stopPropagation(),e.preventDefault())};
Map.Themes.prototype.removeAllChoropleth=function(e){for(var b=0;b<this.themesA.length;b++)this.themesA[b].szFlag.match(/CHOROPLETH/)&&!this.themesA[b].szFlag.match(/LOCKED/)&&(this.themesA[b].fRemove=!this.themesA[b].fRealize);executeWithMessage("map.Themes.execute()","... processing ...");e&&(e.stopPropagation(),e.preventDefault())};
Map.Themes.prototype.removeAllSelections=function(e){for(var b=0;b<this.themesA.length;b++)this.themesA[b].szFlag.match(/SELECTION/)&&(this.themesA[b].fRemove=!0,executeWithMessage("map.Themes.execute()","... processing ..."));e&&(e.stopPropagation(),e.preventDefault())};Map.Themes.prototype.redrawInfoAll=function(e){for(var b=0;b<this.themesA.length;b++)this.themesA[b].fRedrawInfo=!0;map.Themes.execute();e&&(e.stopPropagation(),e.preventDefault())};
Map.Themes.prototype.reformat=function(e){for(var b=this.minY=this.minX=0;b<this.themesA.length;b++)this.themesA[b].fRepositionInfo=!0,this.themesA[b].fRedrawInfo=!0;map.Themes.execute();e&&(e.stopPropagation(),e.preventDefault())};
Map.Themes.prototype.execute=function(){var e=!1,b=0;if(!this.fWaitingforData)if(map.Tiles.isLoading())setTimeout("map.Themes.execute()",250),this.fExecuteDelayed=!0;else if(this.fExecuteDelayed)this.fExecuteDelayed=!1,executeWithMessage("map.Themes.execute()"," ... ");else{for(b=0;b<this.themesA.length;b++)(this.themesA[b].fRealize||this.themesA[b].fRedraw||this.themesA[b].fToFront)&&this.themesA[b].szFlag.match(/CHOROPLETH/)&&!this.themesA[b].szFlag.match(/SUBTHEME/)&&(e=this.themesA[b].szShapeType);
if(e&&this.enableMultiChoropleth)for(b=0;b<this.themesA.length;b++)this.themesA[b].szFlag&&this.themesA[b].szFlag.match(/CHOROPLETH/)&&this.themesA[b].szShapeType==e&&(this.themesA[b].disable(),this.themesA[b].isVisible=!1,this.themesA[b].fRedrawInfo=!1);if(e&&!this.enableMultiChoropleth)for(b=0;b<this.themesA.length;b++)!this.themesA[b].szFlag||!this.themesA[b].szFlag.match(/CHOROPLETH/)||this.themesA[b].szShapeType!=e||this.themesA[b].fRealize||this.themesA[b].fRedraw||this.themesA[b].fToFront||
(this.themesA[b].fRemove=!0);for(b=0;b<this.themesA.length;b++){if(this.themesA[b].fToggle){this.themesA[b].toggle();this.themesA[b].fToggle=!1;this.execute();break}if(this.themesA[b].fRemove){1<this.themesA.length&&!this.themesA[b].szFlag.match(/SELECTION/)&&!this.themesA[b].szFlag.match(/CHART/)&&this.activateNextPaint(this.themesA[b]);this.themesA[b].removeElements();this.remove(this.themesA[b]);this.reformat();this.execute();break}if(this.themesA[b].fRealize)this.themesA[b].fEnableProgressBar=
!0,setTimeout("map.Themes.showProgressBar()",5E3),this.themesA[b].fRealize=!1,this.themesA[b].realize();else if(this.themesA[b].fRedraw)this.themesA[b].checkHiddenLayerState&&this.themesA[b].checkHiddenLayerState()?(this.themesA[b].fRealize=!0,this.themesA[b].fRedraw=!1,this.themesA[b].fReload=!1,this.themesA[b].unpaintMap(),map.Themes.execute()):(this.themesA[b].fEnableProgressBar=!0,this.themesA[b].redraw(!1));else if(this.themesA[b].fActualize)this.themesA[b].fActualize=!1,this.themesA[b].checkHiddenLayerState&&
this.themesA[b].checkHiddenLayerState()?(this.themesA[b].fRealize=!0,this.themesA[b].fRedraw=!1,this.themesA[b].fReload=!1,this.themesA[b].unpaintMap(),map.Themes.execute()):(this.themesA[b].fEnableProgressBar=!0,this.themesA[b].redraw(!1));else if(this.themesA[b].fToFront)this.themesA[b].fEnableProgressBar=!1,this.themesA[b].toFront(),this.themesA[b].fToFront=!1;else if(this.themesA[b].fResize)this.themesA[b].resize(this.themesA[b].fResize),this.themesA[b].fResize=!1;else if(this.themesA[b].fOpacity)this.themesA[b].opacity(this.themesA[b].fOpacity),
this.themesA[b].fOpacity=!1;else if(this.themesA[b].fBlur)this.themesA[b].blur(this.themesA[b].nBlur),this.themesA[b].fBlur=!1;else if(this.themesA[b].fOffset)this.themesA[b].offset(this.themesA[b].fOffset),this.themesA[b].fOffset=!1;else if(this.themesA[b].fRedrawInfo)this.themesA[b].widgetNode&&this.themesA[b].showInfo(),this.themesA[b].fRedrawInfo=!1;else if(this.themesA[b].fResort){try{this.themesA[b].sortChartObjects()}catch(f){}this.themesA[b].fResort=!1}else if(this.themesA[b].fDeclutter){try{this.themesA[b].declutterCharts()}catch(c){}this.themesA[b].fDeclutter=
!1}}this.executeCallback&&(eval(this.executeCallback),this.executeCallback=null);clearMessage(100);clearMessage(1E3)}};Map.Themes.prototype.continueExecute=function(){for(var e=0;e<this.themesA.length;e++)this.themesA[e].fAggregate?(this.themesA[e].fAggregate=!1,this.themesA[e].realize_aggregate()):this.themesA[e].fDraw?(this.themesA[e].fDraw=!1,this.themesA[e].realize_draw()):this.themesA[e].fContinue&&(this.themesA[e].fContinue=!1,this.themesA[e].realizeContinue(this.themesA[e].continueIndex))};
Map.Themes.prototype.realizeDone=function(e){for(var b=0;b<this.themesA.length;b++)this.themesA[b].szFlag.match(/SELECTION/)&&(this.themesA[b].fRealize=!0);e.fRealizeDone=!0;try{HTMLWindow.ixmaps.htmlgui_onDrawTheme(e.szId)}catch(f){}e.szFlag.match(/TEXTONLY/)&&setTimeout("map.Layer.adaptLabel()",10)};
Map.Themes.prototype.showProgressBar=function(){for(var e=0;e<this.themesA.length;e++)(this.themesA[e].fRealize||this.themesA[e].fContinue||this.themesA[e].fAggregate||this.themesA[e].fDraw)&&2<this.themesA[e].nCount/this.themesA[e].nDoneCount&&this.themesA[e].mapSleep?this.themesA[e].mapSleep.fShowProgressBar=!0:(this.themesA[e].fRealize||this.themesA[e].fContinue||this.themesA[e].fAggregate||this.themesA[e].fDraw)&&setTimeout("map.Themes.showProgressBar()",1E3)};
Map.Themes.prototype.remove=function(e){e==this.activeTheme&&(this.activeTheme=null);e==this.activeBuffer&&(this.activeBuffer=null);for(var b=0;b<this.themesA.length;b++)if(this.themesA[b]==e){for(;b<this.themesA.length-1;b++)this.themesA[b]=this.themesA[b+1];this.themesA.length--}};Map.Themes.prototype.cancelExecute=function(){this.activeTheme.fCancel=!0};Map.Themes.prototype.sequence=function(){this.sequenceNr=0;this.sequenceNext()};
Map.Themes.prototype.sequenceNext=function(){this.sequenceNr<this.themesA.length&&(this.themesA[this.sequenceNr].fRedraw=!0,map.Themes.executeCallback="setTimeout('map.Themes.sequenceNext()',500)",map.Themes.execute(),this.sequenceNr++)};
Map.Themes.prototype.activateNextPaint=function(e){e=this.getThemeIndex(e.szId);for(var b=e-1;b!=e;b--){0>b&&(b=this.themesA.length-1);if(b==e)break;if(this.themesA[b].isChecked&&!this.themesA[b].szFlag.match(/CHART/))return this.themesA[b].fRedraw=!0,this.themesA[b].fRedrawInfo=!1,!0}return!1};Map.Themes.prototype.toggleThemeValues=function(e,b){this.toggleValueDisplay(e,this.activeTheme.szId,!this.activeTheme.szFlag.match(/VALUES/))};
Map.Themes.prototype.toggleThemeLegends=function(e,b){SVGThemeGroup.style.setProperty("display",b?"inline":"none","")};Map.Themes.prototype.minimizeThemeLegends=function(e){this.fMinimizedLegends=!0;for(var b=0;b<this.themesA.length;b++)this.minimizeInfo(e,this.themesA[b].szId)};Map.Themes.prototype.changeAllChartScaling=function(e,b){for(var f=0;f<this.themesA.length;f++)this.themesA[f].fResize=999,executeWithMessage("map.Themes.execute()","... processing ...");e.stopPropagation();e.preventDefault()};
Map.Themes.prototype.changeChartScaling=function(e,b,f){if(b=this.getTheme(b.split(":")[0]))b.fResize=f,executeWithMessage("map.Themes.execute()","... processing ...");e.stopPropagation();e.preventDefault()};Map.Themes.prototype.changeChartOpacity=function(e,b,f){if(b=this.getTheme(b.split(":")[0]))b.fOpacity=f,executeWithMessage("map.Themes.execute()","... processing ...");e.stopPropagation();e.preventDefault()};
Map.Themes.prototype.changeChartOffset=function(e,b,f){if((e=this.getTheme(b.split(":")[0]))&&e.leadOffset&&(f=SVGDocument.getElementById(f))){f.fu=new Methods(f);b=f.fu.getPosition();var c=f.fu.getGroupScale();e.fOffset=new point(b.x-e.leadOffset.x,b.y-e.leadOffset.y);f.fu.setPosition(e.leadOffset.x,e.leadOffset.y);e.fOffset.x/=map.Zoom.nZoom/c.x;e.fOffset.y/=map.Zoom.nZoom/c.y;e.offset(e.fOffset);e.fOffset=!1;e.leadOffset=!1}};
Map.Themes.prototype.tellChartOffset=function(e,b,f){(e=this.getTheme(b.split(":")[0]))&&!e.leadOffset&&this.enableChartOffset&&(f=SVGDocument.getElementById(f))&&(f.fu=new Methods(f),e.leadOffset=f.fu.getPosition())};
Map.Themes.prototype.initChartOffset=function(e,b,f){if(this.getTheme(b.split(":")[0])){var c=SVGDocument.getElementById(f);c&&(c.origPosition||(c.origPosition=c.fu.getPosition()),c.onMouseMove=function(b){c.actualPosition=c.fu.getPosition();map.Themes.makeChartOffsetPointer(c)},c.widgetObj=new Widget(c,c))}};Map.Themes.prototype.endChartOffset=function(e,b,f){this.getTheme(b.split(":")[0])&&(e=SVGDocument.getElementById(f))&&e.widgetObj.remove()};
Map.Themes.prototype.makeChartOffsetPointer=function(e,b){b=b||1;e.pointerObj?(map.Dom.clearGroup(e.pointerObj),map.Dom.clearGroup(e.pointShObj)):(e.pointerObj=map.Dom.newGroup(e),e.pointShObj=map.Dom.newGroup(e),e.pointerObj.parentNode.insertBefore(e.pointerObj,e.pointerObj.parentNode.firstChild),e.pointShObj.parentNode.insertBefore(e.pointShObj,e.pointShObj.parentNode.firstChild));if(e.origPosition||e.actualPosition){var f=new box(0,0,100,75),c=new point(e.actualPosition.x-e.origPosition.x,e.actualPosition.y-
e.origPosition.y),h=map.Scale.normalX(15),g=map.Scale.normalX(5),m=map.Scale.normalX(10);map.Scale.normalX(5);g=c.y+f.height/2;h=c.x+f.width/2;Math.abs(g)+f.width/2-f.height/2>Math.abs(h)?(f.width/3>m&&(c.x>-f.width/3&&(h-=f.width/3),c.x<-f.width/3*2&&(h+=f.width/3)),0<g?(map.Dom.newShape("path",e.pointShObj,"M"+-c.x+","+-c.y+" l "+(h-map.Scale.normalX(5/b))+","+(c.y+map.Scale.normalX(1/b))+" "+map.Scale.normalX(4/b)+",0 z","fill:black;fill-opacity:0.5"),map.Dom.newShape("path",e.pointerObj,"M"+-c.x+
","+-c.y+" l "+(h-map.Scale.normalX(5/b))+","+(c.y+map.Scale.normalX(1/b))+" "+map.Scale.normalX(3/b)+",0 z","fill:white")):(map.Dom.newShape("path",e.pointShObj,"M"+-c.x+","+-c.y+" l "+(h-map.Scale.normalX(4/b))+","+(c.y+f.height)+" "+map.Scale.normalX(4/b)+",0 z","fill:black;fill-opacity:0.5"),map.Dom.newShape("path",e.pointerObj,"M"+-c.x+","+-c.y+" l "+(h-map.Scale.normalX(4/b))+","+(c.y+f.height)+" "+map.Scale.normalX(3/b)+",0 z","fill:white"))):(f.height/5>m&&(c.y>-f.height/3&&(g-=f.height/3),
c.y<-f.height/3*2&&(g+=f.height/3)),0<h?(map.Dom.newShape("path",e.pointShObj,"M"+-c.x+","+-c.y+" l "+(c.x-f.width)+","+(g-map.Scale.normalX(4/b))+" 0,"+map.Scale.normalX(4/b)+" z","fill:black;fill-opacity:0.5"),map.Dom.newShape("path",e.pointerObj,"M"+-c.x+","+-c.y+" l "+(c.x-f.width)+","+(g-map.Scale.normalX(4/b))+" 0,"+map.Scale.normalX(3/b)+" z","fill:white")):(map.Dom.newShape("path",e.pointShObj,"M"+-c.x+","+-c.y+" l "+(c.x+f.width)+","+(g-map.Scale.normalX(4/b))+" 0,"+map.Scale.normalX(4/b)+
" z","fill:black;fill-opacity:0.5"),map.Dom.newShape("path",e.pointerObj,"M"+-c.x+","+-c.y+" l "+(c.x+f.width)+","+(g-map.Scale.normalX(4/b))+" 0,"+map.Scale.normalX(3/b)+" z","fill:white")))}};
MapTheme.prototype.declutterCharts=function(){if(!(this.szDeclutterUpper&&map.Scale.nTrueMapScale*map.Scale.nZoomScale>this.nDeclutterUpper)){for(var e=this.chartGroup.childNodes,b=0;b<e.length;b++)e[b].actualPosition&&(e[b].fu.setPosition(e[b].origPosition.x,e[b].origPosition.y),e[b].origPosition=null,e[b].actualPosition=null,e[b].pointerObj&&(map.Dom.clearGroup(e[b].pointerObj),map.Dom.clearGroup(e[b].pointShObj)),e[b].pointerObj=null,e[b].pointShObj=null);if(!e[0].actualPosition){var f=e[0].fu.getBox();
map.Zoom.getBox();for(var c=[],b=0;b<e.length;b++){var h=!1,g=e[b].fu.getPosition(),m=e[b].fu.getBox();m.x+=g.x;m.y+=g.y;for(var l in c)for(var q in c[l])if(!(m.y+m.height<c[l][q].box.y-.3*c[l][q].box.height||m.y>c[l][q].box.y+1.3*c[l][q].box.height||m.x+m.width<c[l][q].box.x-c[l][q].box.width||m.x>c[l][q].box.x+2*c[l][q].box.width)){c[l].push({node:e[b],y:e[b].fu.getPosition().x,box:m});h=!0;break}h||c.push([{node:e[b],y:e[b].fu.getPosition().x,box:m}])}for(l=0;l<c.length;l++)if(e=c[l],e.sort(this.sortUpChartObjectsCompare),
1<e.length&&5>e.length){h=e[0].node.fu.getPosition();for(b=0;b<e.length;b++)g=e[b].node.fu.getPosition(),g.y<h.y&&(h.x=g.x,h.y=g.y);h.y-=map.Scale.normalX(50)*map.Scale.nZoomScale;g=e[0].node.fu.getPosition();for(b=0;b<e.length;b++)e[b].node.origPosition=e[b].node.fu.getPosition(),e[b].node.fu.setPosition(g.x+1.2*f.width*b,h.y),e[b].node.actualPosition=new point(g.x+1.2*f.width*b,h.y),scale=e[b].node.fu.getScale().x,e[b].node.actualPosition.x=e[b].node.origPosition.x-(e[b].node.origPosition.x-e[b].node.actualPosition.x)/
scale,e[b].node.actualPosition.y=e[b].node.origPosition.y-(e[b].node.origPosition.y-e[b].node.actualPosition.y)/scale,map.Themes.makeChartOffsetPointer(e[b].node,this.nScale)}}}};
Map.Themes.prototype.setChartSizeType=function(e,b,f){if(b=this.getTheme(b.split(":")[0])){for(var c="",h=b.szFlag.split("|"),g=0;g<h.length;g++)"SIZE"==h[g]||"FIXSIZE"==h[g]||"NOSIZE"==h[g]||"HEIGHT"==h[g]||"3D"==h[g]&&"2D"==f||(c+=(c.length?"|":"")+h[g]);executeWithMessage("map.Themes.doChangeThemeStyle('"+b.szId+"','type:"+(c+("|"+f))+"')","... processing ...")}e.stopPropagation();e.preventDefault()};
Map.Themes.prototype.toggleValueDisplay=function(e,b,f){if(b=this.getTheme(b.split(":")[0])){for(var c="",h=b.szFlag.split("|"),g=0;g<h.length;g++)"VALUES"!=h[g]&&(c+=(c.length?"|":"")+h[g]);f&&(c+="|VALUES");executeWithMessage("map.Themes.doChangeThemeStyle('"+b.szId+"','type:"+c+"')","... processing ...")}e&&(e.stopPropagation(),e.preventDefault())};
Map.Themes.prototype.toggleDopacity=function(e,b,f){if(b=this.getTheme(b.split(":")[0])){for(var c="",h=b.szFlag.split("|"),g=0;g<h.length;g++)h[g].match(/DOPACITY/)||(c+=(c.length?"|":"")+h[g]);f&&(c+="|DOPACITYMAX");executeWithMessage("map.Themes.doChangeThemeStyle('"+b.szId+"','type:"+c+"')","... processing ...")}e&&(e.stopPropagation(),e.preventDefault())};
Map.Themes.prototype.changeDopacityAlphaRamp=function(e,b,f){if(b=this.getTheme(b.split(":")[0])){var c=b.szFlag;b.nDopacityScale=b.nDopacityScale||1;b.nDopacityScale*=f;executeWithMessage("map.Themes.doChangeThemeStyle('"+b.szId+"','type:"+c+"')","... processing ...")}e&&(e.stopPropagation(),e.preventDefault())};
Map.Themes.prototype.toggleChartDisplay=function(e,b,f){if(b=this.getTheme(b.split(":")[0]))b.fToggle=!0,executeWithMessage("map.Themes.execute()","... processing ...");e.stopPropagation();e.preventDefault()};Map.Themes.prototype.zoomTo=function(e,b){var f=this.getTheme(b)||this.activeTheme;f&&f.zoomTo()};Map.Themes.prototype.zoomToClass=function(e,b,f,c){setTimeout("map.Themes.doZoomToClass('"+b+"','"+f+"','"+c+"')",100)};
Map.Themes.prototype.markClass=function(e,b,f,c){var h=this.getTheme(b.split(":")[0]);if(h&&h.isVisible&&!h.showInfoMore)if("undefined"!=typeof h.markedClass&&h.markedClass==f||"undefined"!=typeof h.markedClasses&&h.markedClasses[f])this.unmarkClass(e,b,f);else{h.markedClass=f;h.markedClasses=h.markedClasses||[];h.markedClasses[f]=!0;h.markedClassesA=[];for(i in h.markedClasses)1==h.markedClasses[i]&&h.markedClassesA.push(i);h.fMarkEnable=!0;h.fUnmarkEnable=!1;this.markTimeout&&clearTimeout(this.markTimeout);
this.unmarkTimeout&&clearTimeout(this.unmarkTimeout);displayMessage("...",1E3,!0);this.markTimeout=setTimeout("map.Themes.doMarkClass('"+b+"','"+f+"','"+c+"')",50)}};
Map.Themes.prototype.unmarkClass=function(e,b,f){if((e=this.getTheme(b.split(":")[0]))&&e.isVisible&&!e.showInfoMore){e.markedClass=null;if(e.markedClasses){e.markedClasses[f]=!1;e.markedClassesA=[];for(i in e.markedClasses)1==e.markedClasses[i]&&e.markedClassesA.push(i);if(e.markedClassesA.length){displayMessage("...",1E3,!0);this.markTimeout=setTimeout("map.Themes.doMarkClass('"+b+"','"+f+"',1)",50);return}delete e.markedClassesA}displayMessage("...",1E3,!0);this.unmarkTimeout=setTimeout("map.Themes.doUnmarkClass('"+
b+"')",50);e.fUnmarkEnable=!0;e.fMarkEnable=!1}};Map.Themes.prototype.doZoomToClass=function(e,b,f){(e=this.getTheme(e.split(":")[0]))&&e.zoomToClass(Number(b),Number(f))};Map.Themes.prototype.doMarkClass=function(e,b,f){if(e=this.getTheme(e.split(":")[0])){e.markClass(Number(b),Number(f));try{HTMLWindow.ixmaps.htmlgui_onDrawTheme(e.szId)}catch(c){}}};
Map.Themes.prototype.doUnmarkClass=function(e){if(this.subTheme)this.subTheme.removeSubTheme(),this.subTheme=null;else if(e=this.getTheme(e.split(":")[0])){e.unmarkClass();try{HTMLWindow.ixmaps.htmlgui_onDrawTheme(e.szId)}catch(b){}}};Map.Themes.prototype.hideClass=function(e,b,f,c){(e=this.getTheme(b.split(":")[0]))&&e.isVisible&&e.showClass(Number(f),Number(c),!1)};Map.Themes.prototype.showClass=function(e,b,f,c){(e=this.getTheme(b.split(":")[0]))&&e.isVisible&&e.showClass(Number(f),Number(c),!0)};
Map.Themes.prototype.classesToRanges=function(e,b){var f=this.getTheme(b.split(":")[0]);f&&f.isVisible&&f.classesToRanges()};Map.Themes.prototype.filterItems=function(e,b,f,c){(e=b?this.getTheme(b.split(":")[0]):this.activeTheme)&&e.isVisible&&!e.showInfoMore&&(e.fMarkEnable=!0,e.fUnmarkEnable=!1,this.markTimeout&&clearTimeout(this.markTimeout),this.unmarkTimeout&&clearTimeout(this.unmarkTimeout),this.opt=c,this.markTimeout=setTimeout("map.Themes.doFilterItems('"+b+"','"+f+"')",500))};
Map.Themes.prototype.doFilterItems=function(e,b){executeWithMessage("map.Themes.doFilterItemsGo('"+e+"','"+b+"')","applying filter ...")};Map.Themes.prototype.doFilterItemsGo=function(e,b){var f=this.getTheme(e.split(":")[0]);f&&(f.filterItems(b,this.opt),this.activeTheme=f)};Map.Themes.prototype.selectFilterItems=function(e,b){var f=this.getTheme(b.split(":")[0]);f&&f.selectFilterItems()};
Map.Themes.prototype.highlightItems=function(e,b,f,c){(e=b?this.getTheme(b.split(":")[0]):this.activeTheme)&&e.isVisible&&(this.highlightTimeout&&clearTimeout(this.highlightTimeout),this.highlightTimeout=setTimeout("map.Themes.doHighlightItems('"+b+"','"+f+"','"+c+"')",500))};Map.Themes.prototype.doHighlightItems=function(e,b,f){(e=e?this.getTheme(e.split(":")[0]):this.activeTheme)&&e.highlightItems(b,f)};
Map.Themes.prototype.clearHighlightItems=function(e,b){var f=b?this.getTheme(b.split(":")[0]):this.activeTheme;f&&f.isVisible&&(this.highlightTimeout&&clearTimeout(this.highlightTimeout),f.clearHighlightItems())};Map.Themes.prototype.changeThemeStyle=function(e,b,f,c){executeWithMessage("map.Themes.doChangeThemeStyle('"+b+"','"+f.replace(/'/g,"\\'")+"','"+c+"')","... processing ...");e&&(e.stopPropagation(),e.preventDefault())};
function __calcNewValue(e,b,f){e=e||1;b=b||1;return f&&f.match(/pow/)?Math.pow(e,b):f&&f.match(/factor/)?e*b:f&&(f.match(/add/)||f.match(/delta/))?e+b:b}function __calcFactor(e,b,f){e=e||1;b=b||1;return f&&f.match(/factor/)?b:f&&f.match(/add/)?(e+b)/e:b/e}
Map.Themes.prototype.doChangeThemeStyle=function(e,b,f){var c=this.getTheme(e.split(":")[0])||this.activeTheme;if(c){if(b=__getStyleObj(b)){if(b.type){b.origType=b.type;if(f&&f.match(/add/)){var h=b.type.split("|");this.szTempStyle=c.szFlag;for(var g=0;g<h.length;g++)eval("this.szTempStyle.match(/"+h[g]+"/)")||(this.szTempStyle+="|"+h[g]);b.type=this.szTempStyle}else if(f&&f.match(/remove/)){for(var h=c.szFlag.split("|"),m="",g=0;g<h.length;g++)h[g]!=b.type&&(m+=(m.length?"|":"")+h[g]);b.type=m}else if(f&&
f.match(/toggle/)){for(var h=c.szFlag.split("|"),m="",l=!1,g=0;g<h.length;g++)h[g]!=b.type?m+=(m.length?"|":"")+h[g]:l=!0;b.type=m+(l?"":"|"+b.type)}else c.szFlag.match(/FRACTION/)&&(b.type+="|FRACTION"),c.szFlag.match(/PERMILLE/)&&(b.type+="|PERMILLE"),c.szFlag.match(/CALCVAL/)&&(b.type+="|CALCVAL"),c.szFlag.match(/CALC100/)&&(b.type+="|CALC100"),c.szFlag.match(/PRODUCT/)&&(b.type+="|PRODUCT"),c.szFlag.match(/RELATIVE/)&&(b.type+="|RELATIVE"),c.szFlag.match(/INVERT/)&&(b.type+="|INVERT"),c.szFlag.match(/INVERTSIZE/)&&
(b.type+="|INVERTSIZE"),c.szFlag.match(/DENSITY/)&&(b.type+="|DENSITY"),c.szFlag.match(/SUM/)&&(b.type+="|SUM"),c.szFlag.match(/CALCMEAN/)&&(b.type+="|CALCMEAN"),c.szFlag.match(/AUTO100/)&&(b.type+="|AUTO100");b.type.match(/LOCKED/)&&(c.fRedrawInfo=!0,map.Themes.execute());if(b.type.match(/CHART/)&&!c.szFlag.match(/CHART/)||b.type.match(/CHOROPLETH/)&&!c.szFlag.match(/CHOROPLETH/))c.unpaintMap(),this.activateNextPaint(c);if(b.type.match(/EQUIDISTANT/)||b.type.match(/LOG/)||b.type.match(/QUANTILE/))c.szOldRanges=
c.szRanges?c.szRanges:c.szOldRanges,c.szRanges=null,c.szOldLabelA=c.szLabelA?c.szLabelA:c.szOldLabelA,c.szLabelA=null,c.fRealize=!0;b.type.match(/RANGES/)&&b.ranges&&(c.szRanges=c.szOldRanges?c.szOldRanges:c.szRanges,c.szRangesA=b.ranges.split(b.ranges.match(/\|/)?"|":","),c.szLabelA=c.szOldLabelA?c.szOldLabelA:c.szLabelA,Number(c.origColorScheme[0])&&c.szRanges&&(c.origColorScheme[0]=c.szRangesA.length-1),c.fRealize=!0);if(b.type.match(/RANGES/)&&!b.ranges)for(a in c.szRangesA=[c.partsA[0].min],
c.partsA)c.szRangesA.push(c.partsA[a].max);g=c.szFlag;c.szFlag=b.type;!c.szFlag.match(/CHART/)||c.szFlag.match(/BUFFER/)||g.match(/CHART/)||(c.fShadow=c.fOrigShadow=!0);b.origType.match(/AGGREGATE/)||b.origType.match(/GROUP/)||b.origType.match(/RECT/)||b.origType.match(/RELOCATE/)?(c.fRealize=!0,c.fRedraw=!1,c.unpaintMap(),c.themeNodesPosA=[]):(c.fRedraw=!0,c.fRedrawInfo=!0);b.type.match(/DTEXT/)!=g.match(/DTEXT/)&&c.unlabelMap();b.type.match(/AUTO100/)!=g.match(/AUTO100/)&&(c.fRealize=!0,c.fRedraw=
!1,c.unpaintMap());b.type.match(/NOOUTLIER/)!=g.match(/NOOUTLIER/)&&(c.fRealize=!0,c.fRedraw=!1,c.unpaintMap());b.type.match(/OUTLIER/)!=g.match(/OUTLIER/)&&(c.fRealize=!0,c.fRedraw=!1,c.unpaintMap())}else if(f&&f.match(/remove/)){for(p in b)for(s in themeStyleTranslateA)themeStyleTranslateA[s].style==p&&(c[themeStyleTranslateA[s].obj]=null);c.fReload=!0;c.fRealize=!0;c.unpaintMap();executeWithMessage("map.Themes.execute()","... processing ...");return}__isdef(b.classes)&&(isNaN(Number(c.origColorScheme[0]))&&
(c.origColorScheme[3]=c.origColorScheme[c.origColorScheme.length/2],c.origColorScheme[4]="2colors",g=c.origColorScheme[c.origColorScheme.length-1],c.origColorScheme[1]=c.origColorScheme[0],c.origColorScheme[2]=g),c.origColorScheme[0]=Number(b.classes),c.szFlag.match(/CHART/)&&c.unpaintMap(),c.szOldRanges=c.szRanges,c.szRanges=null,c.fRealize=!0);__isdef(b.ranges)&&(c.szRanges=b.ranges,c.szRangesA=b.ranges.split(b.ranges.match(/\|/)?"|":","),c.fRealize=!0);__isdef(b.colorstyle)&&"spectrum"==c.origColorScheme[1]&&
(c.origColorScheme[2]=b.colorstyle,c.szFlag.match(/CHART/)&&c.unpaintMap(),c.fRealize=!0);__isdef(b.colordef)&&(c.origColorScheme=b.colordef.match(/\|/)?b.colordef.split("|"):b.colordef.split(","),c.colorScheme=c.origColorScheme,c.fRedraw=!0,c.szFlag.match(/CHART/)||(c.fRealize=!0),c.fRedrawInfo=!0,c.showInfo());if(__isdef(b.colorscheme)&&(h=b.colorscheme.match(/\|/)?b.colorscheme.split("|"):b.colorscheme.split(","))&&h.length){isNaN(Number(c.origColorScheme[0]))&&(c.origColorScheme[0]=c.origColorScheme.length);
c.origColorScheme.length=1;for(g=0;5>g;g++)c.origColorScheme[g+1]=g<h.length?h[g]:null;try{c.colorScheme=ColorScheme.createColorScheme(c.origColorScheme[1],c.origColorScheme[2],c.origColorScheme[0],c.origColorScheme[3],c.origColorScheme[4])}catch(q){c.colorScheme=c.defaultColorScheme}c.fRedraw=!0;c.szFlag.match(/CHART/)||(c.fRealize=!0);c.fRedrawInfo=!0;c.showInfo()}if(__isdef(b.colorschemegeneration)&&!isNaN(Number(c.origColorScheme[0]))){switch(b.colorschemegeneration){case "warm":c.origColorScheme[4]=
"#FFFDD8";break;case "cold":c.origColorScheme[4]="#FFFFFF";break;default:c.origColorScheme[4]=b.colorschemegeneration}c.szFlag.match(/CHART/)&&c.unpaintMap();try{c.colorScheme=ColorScheme.createColorScheme(c.origColorScheme[1],c.origColorScheme[2],c.origColorScheme[0],c.origColorScheme[3],c.origColorScheme[4])}catch(x){c.colorScheme=c.defaultColorScheme}c.fRedraw=!0;c.fRedrawInfo=!0}__isdef(b.symbols)&&(c.szSymbolsA=b.symbols.split(b.symbols.match(/\|/)?"|":","),c.fRealize=!0);__isdef(b.dominantdfilter)&&
(c.nDominantDFilter=Number(b.dominantdfilter),c.fRealize=!0);__isdef(b.dominantfilter)&&(c.szDominantFilter=String(b.dominantfilter),c.fRealize=!0);__isdef(b.filter)&&(f&&f.match(/remove/)?c.szFilter="":c.szFilter=String(b.filter),c.fRealize=!0,c.unpaintMap());__isdef(b.filterfield)&&(c.szFilterField=String(b.filterfield),c.fRealize=!0);__isdef(b.markclasses)&&(c.markedClassesA=this.toArray(b.markclasses),c.markedClasses=[],c.unmarkClass(),c.markedClassesA.forEach(function(b,e){0<=b&&(c.markedClasses[b]=
!0,c.markClass(b))}));__isdef(b.field100min)&&(c.nField100Min=b.field100min,c.fRealize=!0);__isdef(b.overviewchart)&&!c.szFlag.match(/CHART/)&&(c.szOverviewChart=b.overviewchart,c.fRedrawInfo=!0);__isdef(b.evidence)&&(c.evidenceMode=b.evidence);__isdef(b.aggregation)&&(c.szAggregation=b.aggregation);__isdef(b.opacity)&&(c.fOpacity=__calcNewValue(c.fOpacity,Number(b.opacity),f));__isdef(b.fillopacity)&&(c.fillOpacity=__calcNewValue(c.fillOpacity,Number(b.fillopacity),f),c.fillOpacity=Math.min(Math.max(c.fillOpacity,
.001),1),c.fRedraw=!0);__isdef(b.shadow)&&(c.fShadow="toggle"==b.shadow?c.fOrigShadow=!c.fOrigShadow:c.fOrigShadow=b.shadow,c.fRedraw=!0);__isdef(b.showdata)&&(c.fShowData="toggle"==b.showdata?!c.fShowData:JSON.parse(b.showdata),c.fRedraw=!0);__isdef(b.blur)&&("toggle"==b.blur?c.nBlur?(c.nOldBlur=c.nBlur,c.nBlur=0):c.nBlur=c.nOldBlur||1:c.nBlur=__calcNewValue(c.nBlur,Number(b.blur),f),c.fBlur=!0);__isdef(b.scale)&&(c.fResize=__calcFactor(c.nScale,Number(b.scale),f));__isdef(b.dopacityscale)&&(c.nDopacityScale=
__calcNewValue(c.nDopacityScale,Number(b.dopacityscale),f),c.fRedraw=!0);__isdef(b.d_dopacityscale)&&(c.nDopacityScale*=Number(b.d_dopacityscale),c.fRedraw=!0);__isdef(b.alphafield)&&(c.szAlphaField=String(b.alphafield),c.fRealize=!0);__isdef(b.alphafield100)&&(c.szAlphaField100=String(b.alphafield100),c.fRealize=!0);__isdef(b.dopacityramp)&&(c.szDopacityRamp=b.dopacityramp,c.fRealize=!0);__isdef(b.dopacitypow)&&(c.nDopacityPow=__calcNewValue(c.nDopacityPow,Number(b.dopacitypow),f),c.fRealize=!0);
__isdef(b.rangescale)&&(c.nRangeScale=__calcNewValue(c.nRangeScale||1,Number(b.rangescale),f),c.fRedraw=!0);__isdef(b.sizefield)&&(c.szSizeField=String(b.sizefield),c.fRealize=!0);__isdef(b.xfield)&&(c.szXField=String(b.xfield),c.fRealize=!0);__isdef(b.yfield)&&(c.szYField=String(b.yfield),c.fRealize=!0);__isdef(b.labelfield)&&(c.szLabelField=String(b.labelfield),c.fRealize=!0);__isdef(b.colorfield)&&(c.szColorField=String(b.colorfield),c.fRealize=!0);__isdef(b.valuefield)&&(c.szValueField=String(b.valuefield),
c.fRealize=!0);__isdef(b.normalsizevalue)&&(c.nNormalSizeValue||(c.nNormalSizeValue=c.szSizeField?c.nMaxSize:c.nMax),c.nNormalSizeValue=__calcNewValue(c.nNormalSizeValue,Number(b.normalsizevalue),f),c.fRedraw=!0);__isdef(b.valuedecimals)&&(c.szValueDecimals=b.valuedecimals,c.fRedraw=!0);__isdef(b.valueupper)&&(c.szValueUpper=b.valueupper,c.nValueUpper=__scanScaleValue(c.szValueUpper),c.fRedraw=!0);__isdef(b.titleupper)&&(c.szTitleUpper=b.titleupper,c.nTitleUpper=__scanScaleValue(c.szTitleUpper),c.fRedraw=
!0);__isdef(b.boxupper)&&(c.szBoxUpper=b.boxupper,c.nBoxUpper=__scanScaleValue(c.szBoxUpper),c.fRedraw=!0);__isdef(b.shadowupper)&&(c.szShadowUpper=b.shadowupper,c.nShadowUpper=__scanScaleValue(c.szShadowUpper),c.fRedraw=!0);__isdef(b.shadowlower)&&(c.szShadowLower=b.shadowlower,c.nShadowLower=__scanScaleValue(c.szShadowLower),c.fRedraw=!0);__isdef(b.declutterupper)&&(c.szDeclutterUpper=b.declutterupper,c.nDeclutterUpper=__scanScaleValue(c.szdeclutterUpper),c.fRedraw=!0);__isdef(b.aggregaionupper)&&
(c.szAggregationUpper=b.aggregationupper,c.nAggregationUpper=__scanScaleValue(c.szAggregationUpper),c.fRedraw=!0);__isdef(b.aggregaionlower)&&(c.szAggregationLower=b.aggregationlower,c.nAggregationLower=__scanScaleValue(c.szAggregationLower),c.fRedraw=!0);__isdef(b.minvaluesize)&&(c.nValueSizeMin=__calcNewValue(c.nValueSizeMin,Number(b.minvaluesize),f),c.fRedraw=!0);__isdef(b.clipvaluesize)&&(c.nValueSizeMin=__calcNewValue(c.nValueSizeMin,Number(b.clipvaluesize),f),c.fRedraw=!0);__isdef(b.minsize)&&
(c.nChartSizeMin=__calcNewValue(c.nChartSizeMin,Number(b.minsize),f),c.fRedraw=!0);__isdef(b.minchartsize)&&(c.nChartSizeMin=__calcNewValue(c.nChartSizeMin,Number(b.minchartsize),f),c.fRedraw=!0);__isdef(b.clipsize)&&(c.nChartSizeMin=__calcNewValue(c.nChartSizeMin,Number(b.clipsize),f),c.fRedraw=!0);__isdef(b.clipparts)&&(c.nClipParts=Number(b.clipparts),c.fRedraw=!0);__isdef(b.showparts)&&(c.szShowParts=b.showparts,c.szShowPartsA=b.showparts.split(b.showparts.match(/\|/)?"|":","),map.Themes.unmarkClass(null,
e),c.fRedraw=!0);__isdef(b.clipframerate)&&(c.nClipFrameRate=__calcNewValue(c.nClipFrameRate||1,Number(b.clipframerate),f),c.nClipTimeout=1/c.nClipFrameRate*1E3,c.fRedraw=!0);__isdef(b.gridx)&&(c.nGridX=Number(b.gridx)||7,c.fRedraw=!0);__isdef(b.gridwidth)&&(c.szAggregationField=null,"auto"==b.gridwidth?c.nGridWidthPx=c.nGridWidthPx||50:String(b.gridwidth).match(/px/)?c.nGridWidthPx=__calcNewValue(c.nGridWidthPx||1,Number(b.gridwidth),f):"factor"==f?__isdef(c.nGridWidthPx)?c.nGridWidthPx=__calcNewValue(c.nGridWidthPx||
1,Number(b.gridwidth),f):c.nGridWidth=__calcNewValue(c.nGridWidth||1E3,Number(b.gridwidth),f):(c.nGridWidthPx=null,c.nGridWidth=__calcNewValue(c.nGridWidth||1,Number(b.gridwidth),f)),c.fRealize=!0,c.fRedraw=!0,c.fSuppressAggregationScale=!0,c.themeNodesPosA=[],c.unpaintMap());__isdef(b.gridmatrix)&&(c.szAggregationField=null,c.nGridMatrix=__calcNewValue(c.nGridMatrix||1,Number(b.gridmatrix),f),c.fRealize=!0,c.fRedraw=!0,c.fSuppressAggregationScale=!0,c.unpaintMap(),c.themeNodesPosA=[]);__isdef(b.gridwidthpx)&&
(c.szAggregationField=null,c.nGridWidthPx=__calcNewValue(c.nGridWidthPx||50,Number(b.gridwidthpx),f),c.fRealize=!0,c.fRedraw=!0,c.fSuppressAggregationScale=!0,c.unpaintMap(),c.themeNodesPosA=[]);__isdef(b.aggregationfield)&&(c.szAggregationField=b.aggregationfield,c.fRealize=!0,c.fRedraw=!0,c.fSuppressAggregationScale=!0,c.unpaintMap(),c.themeNodesPosA=[]);__isdef(b.snippet)&&(c.szSnippet=unescape(b.snippet),c.fRealize=!0);__isdef(b.title)&&(c.szTitle=unescape(b.title),c.fRealize=!0);__isdef(b.child)&&
(c.fChild=!0)}c.fRedrawInfo=!0;map.Themes.execute()}};Map.Themes.prototype.getThemeLayerList=function(){for(var e=[],b,f=0;f<this.themesA.length;f++)if(this.themesA[f].objThemesA&&!this.themesA[f].fRemove)for(b in this.themesA[f].objThemesA)e[e.length]=b;return e};Map.Themes.prototype.isThemeLayerUsed=function(e){for(var b=this.getThemeLayerList(),f=0;f<b.length;f++)if(e==b[f])return!0;return!1};
Map.Themes.prototype.isNodePartOfAnyTheme=function(e){if(e=map.Layer.getLayerObjOfNode(e))for(var b=map.Themes.getThemeLayerList(),f=0;f<b.length;f++)if(e.szName==b[f])return!0;return!1};Map.Themes.prototype.resetThemeNodesCache=function(){this.themeNodesA=[];this.themeNodes=0};
Map.Themes.prototype.addToThemeNodesCache=function(e){var b=0;nodeA=e.getElementsByTagName("g");for(n=0;n<nodeA.length;n++)if(e=String(map.Tiles.getMasterId(nodeA.item(n).getAttributeNS(null,"id"))))map.Themes.themeNodesA[e]||(map.Themes.themeNodesA[e]=[]),map.Themes.themeNodesA[e].push(nodeA.item(n)),map.Themes.themeNodes++,b++};
Map.Themes.prototype.removeFromThemeNodesCache=function(e){var b=0;nodeA=e.getElementsByTagName("g");for(n=0;n<nodeA.length;n++)if((e=String(map.Tiles.getMasterId(nodeA.item(n).getAttributeNS(null,"id"))))&&map.Themes.themeNodesA[e]){var f=map.Themes.themeNodesA[e].indexOf(nodeA.item(n));-1<f&&(map.Themes.themeNodesA[e].splice(f,1),b++)}};Map.Themes.prototype.setActive=function(e){this.activeTheme=e};
Map.Themes.prototype.minimizeInfo=function(e,b){var f=this.getTheme(b.split(":")[0]);if(f){var c=f.widgetNode.firstChild;if(c){var h=Number(c.getAttributeNS(szMapNs,"titleheight"));0>=h&&(h=420);for(var c=c.childNodes,g=0;g<c.length;g++){var m=c.item(g),l=m.getAttributeNS(null,"id");l.match(/body/)&&m.style.setProperty("display","none","");l.match(/footer/)&&m.style.setProperty("display","none","");l.match(/backgroundrect/)&&(m.setAttributeNS(szMapNs,"maxheight",m.getAttributeNS(null,"height")),m.setAttributeNS(null,
"height",h));l.match(/shadowrect/)&&(m.setAttributeNS(szMapNs,"maxheight",m.getAttributeNS(null,"height")),m.setAttributeNS(null,"height",String(h-100)));l.match(/minimizebutton/)&&m.style.setProperty("display","none","")}f.minimizebutton.nodeObj.style.setProperty("display","none","");f.morebutton.nodeObj.style.setProperty("display","none","");f.addDefinitionToFlag("MINIMIZED")}}};
Map.Themes.prototype.maximizeInfo=function(e,b){var f=this.getTheme(b.split(":")[0]);if(f){var c=f.widgetNode.firstChild;if(c){for(var c=c.childNodes,h=0;h<c.length;h++){var g=c.item(h),m=g.getAttributeNS(null,"id");m.match(/body/)&&g.style.setProperty("display","inline","");m.match(/footer/)&&g.style.setProperty("display","inline","");m.match(/backgroundrect/)&&g.setAttributeNS(null,"height",g.getAttributeNS(szMapNs,"maxheight"));m.match(/shadowrect/)&&g.setAttributeNS(null,"height",g.getAttributeNS(szMapNs,
"maxheight"));m.match(/minimizebutton/)&&g.style.setProperty("display","inline","")}f.minimizebutton.nodeObj.style.setProperty("display","inline","");f.morebutton.nodeObj.style.setProperty("display","inline","");f.removeDefinitionFromFlag("MINIMIZED")}}};
Map.Themes.prototype.getChartAll=function(e,b,f){for(var c=b.getAttributeNS(null,"id"),h=0,g=0;g<this.themesA.length;g++){var m=map.Dom.newGroup(b,c+":C1");this.getChart(e,m,f,this.themesA[g]);var l=map.Dom.getBox(m);0>l.width&&(l=new box(0,0,0,0));m.fu.setPosition(0,h);h+=l.height+map.Scale.normalY(10)}};
Map.Themes.prototype.getChart=function(e,b,f,c){c||(c=this.activeTheme);if(!c)return null;e&&":paint"==e.substr(e.length-6,6)&&(e=e.substr(0,e.length-6));if(c.szFlag.match(/CHOROPLETH/)&&c.szFlag.match(/DOMINANT/)){var h=30;2<c.nOrigSumA.length&&(h=15*c.nOrigSumA.length/Math.log(c.nOrigSumA.length));f=map.Dom.newGroup(b,b.getAttributeNS(null,"id")+":1");if(c.szFlag.match(/PERCENTOFMEAN/)||c.szFlag.match(/PERCENTOFMEDIAN/)||c.szFlag.match(/DEVIATION/)){c.drawChart(f,e,h,"CHART|BAR|VALUES|ZOOM",e&&
c.itemA[e]?c.itemA[e].nDominant:null);var g=map.Dom.getBox(f);0>g.width&&(g=new box(0,0,0,0));f=map.Dom.newGroup(b,b.getAttributeNS(null,"id")+":2");c.drawChart(f,e,h,"VALUES|ZOOM");e=map.Dom.getBox(f);b=1<c.nOrigSumA.length?g.width/e.width*1.015:e.width/e.height;f.fu.setPosition(e.x-g.x,g.height+g.y+Math.min(map.Scale.normalY(200),Math.max(map.Scale.normalY(10),-e.y+map.Scale.normalY(6))));f.fu.scale(b,1);c=c.szFlag.match(/PERCENTOFMEDIAN/)?"median":"mean";e=e.width;map.Dom.newText(f,e,map.Scale.normalY(.9),
"font-family:arial;font-size:"+map.Scale.normalY(4)+"px;fill:#808080",map.Dictionary.getLocalText(c));map.Dom.newText(f,e,map.Scale.normalY(5.5),"font-family:arial;font-size:"+map.Scale.normalY(4)+"px;fill:#808080",map.Dictionary.getLocalText("-"));map.Dom.newText(f,e,map.Scale.normalY(-3.7),"font-family:arial;font-size:"+map.Scale.normalY(4)+"px;fill:#808080",map.Dictionary.getLocalText("+"))}else b="CHART|BAR|SPACED|VALUES|ZOOM",c.szFlag.match(/3D/)&&(b+="|3D"),c.szFlag.match(/SORT/)&&(b+="|SORT"),
c.szFlag.match(/HORZ/)&&(b+="|HORZ|AXIS"),c.drawChart(f,e,h,b,null);return new point(0,map.Scale.normalY(30))}if(c.szFlag.match(/BUFFER/)&&c.szFlag.match(/CHART/))return null;if(c.szFlag.match(/CHOROPLETH/)&&c.itemA[e])return h=c.itemA[e].nValuesA[0],f=__scaleStyleString(map.Scale.tStyle.Summary.szStyle,1),h=c.szFlag.match(/EXACT/)&&c.szLabelA&&c.szLabelA.length?c.szLabelA[h-1]:c.formatValue(h,2)+c.szUnit,map.Dom.newText(b,-40,0,f+";font-weight:normal;fill:#444444",h),!c.szFlag.match(/EXACT/)&&(c.szChoroplethInfoStyle.match(/HISTOGRAM/)||
c.szChoroplethInfoStyle.match(/histogram/)||c.szChoroplethInfoStyle.match(/CLASSES/)||c.szChoroplethInfoStyle.match(/classes/))&&(h=c.szChoroplethInfoStyle.match(/HISTOGRAM/)||c.szChoroplethInfoStyle.match(/histogram/),f=map.Dom.newGroup(b,b.getAttributeNS(null,"id")+":histogram"),this.getHistogram(e,f,h?"DISTRIBUTION":"CLASSES",c),f.fu.setPosition(0,map.Scale.normalY(4))),new point(0,0);if(c.szFlag.match(/INFOSIZE/))return c.drawChart(b,e,30,f);h=30;c.szFlag.match(/SEQUENCE/)&&(h=25);c.szFlag.match(/BAR/)&&
(c.szFlag.match(/STACKED/)?h=300:2>=c.nOrigSumA.length?h=30:(c.szFlag.match(/\|UP/)||c.szFlag.match(/CENTER/)||c.szFlag.match(/SEQUENCE/),h=15*c.nOrigSumA.length/Math.log(c.nOrigSumA.length)));return c.drawChart(b,e,h,f)};
Map.Themes.prototype.getSummary=function(e,b){b||(b=this.activeTheme);if(!b||!e)return null;b.itemA[e]||(aA=e.split("::"),1<aA.length&&(e=aA[0]+"::"+String(aA[1]).toUpperCase()));if(!b.itemA[e])return null;for(var f=b.itemA[e].nOrigValuesA,c=0,h=0;h<f.length;h++)isNaN(f[h])&&(f[h]=0),c+=f[h];b.szFlag.match(/DIFFERENCE/)&&(c=f[f.length-1]);if(b.itemA[e].nValue100)return b.szUnits100=b.szUnits100||"",b.szFlag.match(/RELATIVE/)||b.szFlag.match(/DIFFERENCE/)?map.Dictionary.getLocalText("Relative to")+
": "+String(__formatValue(b.itemA[e].nValue100,2))+" "+(b.szUnits100||""):b.itemA[e].nSize?b.szAggregation.match(/sum/)?map.Dictionary.getLocalText("Counted")+": "+String(__formatValue(b.itemA[e].nSize,2))+" "+(b.szUnits100||""):map.Dictionary.getLocalText("Total")+": "+String(__formatValue(b.itemA[e].nSize,2))+" "+(b.szUnits100||""):c!=b.itemA[e].nValue100?String(__formatValue(c,2))+" / "+String(__formatValue(b.itemA[e].nValue100,2))+" "+(b.szUnits100||""):map.Dictionary.getLocalText("Total")+": "+
String(__formatValue(c,2))+" "+(b.szUnits100||"");if(b.itemA[e].nSize)return b.szFlag.match(/EXACT/)&&1==b.itemA[e].nValuesA.length&&b.szValueField?b.szLabelA[b.itemA[e].nValuesA[0]-1]:map.Dictionary.getLocalText("Total")+": "+String(__formatValue(b.itemA[e].nSize,2))+" "+(b.szSizeValueUnits||"");if(b.itemA[e].nAlpha)return map.Dictionary.getLocalText("Alpha value")+": "+String(__formatValue(b.itemA[e].nAlpha,2))+" "+(b.szAlphaValueUnits||"");!b.szFlag.match(/SUM/)||b.szFlag.match(/SEQUENCE/)||b.szFlag.match(/CLIP/);
return null};
Map.Themes.prototype.getValueComment=function(e,b){b||(b=this.activeTheme);if(!b||!e)return null;b.itemA[e]||(aA=e.split("::"),1<aA.length&&(e=aA[0]+"::"+String(aA[1]).toUpperCase()));if(!b.itemA[e])return null;for(var f=b.itemA[e].nOrigValuesA,c=0;c<f.length;c++)isNaN(f[c])&&(f[c]=0);b.szFlag.match(/DIFFERENCE/);return b.szFlag.match(/OFFSETMEAN/)?map.Dictionary.getLocalText("value")+": "+String(__formatValue(b.itemA[e].nValuesA[0],2))+" "+map.Dictionary.getLocalText("mean")+": "+String(__formatValue(b.nMeanA[0],2)):
null};Map.Themes.prototype.getTitle=function(e,b){b||(b=this.activeTheme);if(!b||!e)return null;e=String(map.Tiles.getMasterId(e));b.itemA[e]||(aA=e.split("::"),1<aA.length&&(e=aA[0]+"::"+String(aA[1]).toUpperCase()));return b.itemA[e]?b.itemA[e].szTitle||null:null};Map.Themes.prototype.getLabel=function(e,b){b||(b=this.activeTheme);if(!b||!e)return null;b.itemA[e]||(aA=e.split("::"),1<aA.length&&(e=aA[0]+"::"+String(aA[1]).toUpperCase()));return b.itemA[e]?b.itemA[e].szLabel||null:null};
Map.Themes.prototype.getTextObjects=function(){for(var e=[],b=0;b<this.themesA.length;b++)if(this.themesA[b].szFlag.match(/TEXTONLY/)&&this.themesA[b].chartGroup)if("undefined"!=typeof this.themesA[b].markedClass&&null!=this.themesA[b].markedClass){nClass=this.themesA[b].markedClass;var f=this.themesA[b].chartGroup.getElementsByTagName("text");for(n=0;n<f.length;n++)0<f.item(n).firstChild.nodeValue.length&&Number(f.item(n).getAttributeNS(szMapNs,"class"))==nClass&&e.push(f.item(n))}else for(f=this.themesA[b].chartGroup.getElementsByTagName("text"),
n=0;n<f.length;n++)0<f.item(n).firstChild.nodeValue.length&&e.push(f.item(n));return e};Map.Themes.prototype.getMaxValue=function(e,b){b||(b=this.activeTheme);if(!b||!e)return null;for(var f=0,c=b.itemA[e].nValuesA,h=0;h<c.length;h++)isNaN(c[h])&&(c[h]=0),f=Math.max(f,c[h]);return f};
Map.Themes.prototype.getDataRow=function(e,b){b||(b=this.activeTheme);if(!b||!e)return null;b.itemA[e]||(aA=e.split("::"))&&1<aA.length&&(e=aA[0]+"::"+String(aA[1]).toUpperCase());if(!b.itemA[e])return null;var f=b.objThemesA[b.szThemesA[0]],c=[];if(b.szDataFieldsA)for(var h=0;h<b.szDataFieldsA.length;h++)for(var g=0;g<f.dbFields.length;g++)b.szDataFieldsA[h]==f.dbFields[g].id&&c.push(g);else for(g=0;g<f.dbFields.length;g++)c.push(g);var m=[];if(f.dbRecords){if("undefined"!=typeof b.itemA[e].dbIndexA&&
b.itemA[e].dbIndexA.length){for(d in b.itemA[e].dbIndexA)for(0<d&&m.push("--------------------"),g=0;g<c.length;g++)m.push(f.dbFields[c[g]].id);for(d in b.itemA[e].dbIndexA)for(0<d&&m.push("--------------------"),h=b.itemA[e].dbIndexA[d],g=0;g<c.length;g++)m.push(f.dbRecords[h][c[g]]);return m}if("undefined"!=typeof b.itemA[e].dbIndex){h=b.itemA[e].dbIndex;for(g=0;g<c.length;g++)m.push(f.dbFields[c[g]].id);for(g=0;g<c.length;g++)m.push(f.dbRecords[h][c[g]]);return m}e=e.split("::")[1];for(h=0;h<f.dbRecords.length;h++)if(f.dbRecords[h]&&
f.dbRecords[h][f.nFieldSelectionIndex]&&String(f.dbRecords[h][f.nFieldSelectionIndex]).toUpperCase()==String(e).toUpperCase()){for(g=0;g<f.dbFields.length;g++)m.push(f.dbFields[g].id);for(g=0;g<f.dbFields.length;g++)m.push(f.dbRecords[h][g]);break}}return m};
Map.Themes.prototype.getFieldIndexArray=function(e){e||(e=this.activeTheme);if(!e||e.szDataFieldsA)return[];e.fieldIndexArray=[];for(var b=0;b<e.objThemesA[e.szThemesA[0]].nFieldIndexA.length;b++)e.fieldIndexArray.push(e.objThemesA[e.szThemesA[0]].nFieldIndexA[b]);0<=e.objThemesA[e.szThemesA[0]].nField100Index&&e.fieldIndexArray.push(e.objThemesA[e.szThemesA[0]].nField100Index);return e.fieldIndexArray};
Map.Themes.prototype.getScatterArray=function(e,b,f){e||(e=this.activeTheme);var c=0,h=e.nMin,g=e.nMax,m=0,l;f.match(/LOG/)&&(m=1-h,h=Math.log(h+m),g=Math.log(g+m));for(var g=(g-h)/b,q=[],x=0;x<b+1;x++)q[x]=0;for(l in e.itemA)x=e.itemA[l].nValuesA[0],"number"==typeof x&&(f.match(/LOG/)&&(x=Math.log(x+m)),nPos=Math.max(0,Math.min(b-1,Math.floor((x-h)/g))),q[nPos]++,c=Math.max(c,q[nPos]));return q};
Map.Themes.prototype.getResolutionQualityOfArray=function(e){for(var b=e.length,f=-1E6,c=0;c<b;c++)f=Math.max(f,e[c]);for(c=nCount=0;c<b;c++)e[c]>f/10&&nCount++;return nCount/b*100};Map.Themes.prototype.getDeviationOfArray=function(e){for(var b=e.length,f=-1E6,c=0,h=0,g=0,g=0;g<b;g++)f=Math.max(f,e[g]),c+=e[g];c/=b;for(g=0;g<b;g++)h+=(e[g]-c)*(e[g]-c);return g=Math.sqrt(h/b)};
Map.Themes.prototype.getHistogram=function(e,b,f,c){if(!b)return null;c||(c=this.activeTheme);if(!c||c.nMin==c.nMax||e&&(c.itemA[e]||(aA=e.split("::"),1<aA.length&&(e=aA[0]+"::"+String(aA[1]).toUpperCase())),!c.itemA[e]))return null;this.histGroup=map.Dom.newGroup(b,b.getAttributeNS(null,"id")+":group");this.histFlag=f;this.histTheme=c;b=map.Scale.normalX(70);f=map.Scale.normalY(20);map.Dom.newShape("rect",this.histGroup,0,0,b-map.Scale.normalX(.5),f,"fill:none;stroke:none;");e?setTimeout("map.Themes.makeHistogram('"+
e+"')",100):setTimeout("map.Themes.makeHistogram()",100)};
Map.Themes.prototype.makeHistogram=function(e){var b=this.histGroup,f=this.histFlag,c=this.histTheme;if(f.match("CLASSES")){for(var h=map.Scale.normalX(50),g=map.Scale.normalY(5),m=h/c.colorScheme.length,l=0,q=0,x=e?c.itemA[e].nValuesA[0]:0,r=0,k=0;k<c.partsA.length;k++){var m=h/c.nCount*c.partsA[k].nCount,H=map.Dom.newShape("rect",b,l,q,m,g,"fill:"+c.colorScheme[k]+";stroke:black;stroke-width:1;");H&&H.setAttributeNS(szMapNs,"tooltip",c.szLegendLabelA[k]+" ("+c.formatValue(c.partsA[k].nCount)+" "+
map.Dictionary.getLocalText("members")+")");l+=m;x>c.partsA[k].max?r+=m:x>c.partsA[k].min&&(r+=m/(c.partsA[k].max-c.partsA[k].min)*(x-c.partsA[k].min))}map.Dom.newShape("circle",b,r,-map.Scale.normalX(.1),map.Scale.normalX(1),"fill:#444444;stroke:none;")}else if(f.match("DISTRIBUTION")){if(!isFinite(c.nMin)||!isFinite(c.nMax))return b;r=Math.min(140,Math.max(20,c.nCount/5));r=Math.min(500,Math.max(20,c.nCount/5));h=map.Scale.normalX(70);g=map.Scale.normalY(12);f.match("INTERACTIVE")&&(g=map.Scale.normalY(20));
var w=h/r,x=e?c.itemA[e].nValuesA[0]:0,B=0,D=c.nMin,C=c.nMax,y=0,K=this.getScatterArray(c,r,""),k=this.getDeviationOfArray(K),l=this.getScatterArray(c,r,"LOG"),q=this.getDeviationOfArray(l),E=!1,u=(C-D)/r;q&&q<k&&(K=l,y=1-D,D=Math.log(D+y),C=Math.log(C+y),x=Math.log(x+y),u=(C-D)/r,E=!0);for(k=0;k<r;k++)B=Math.max(B,K[k]);l=-20;q=0;c.histogram=new Map.Histogram(c);c.histogram.fDoLog=E;c.histogram.dValue=y;c.histogram.nWidth=h;c.histogram.nMin=D;c.histogram.nMax=C;for(var A=__scaleStyleString(map.Scale.tStyle.Summary.szStyle,
.4),I=0,k=0;k<c.partsA.length;k++){m=(E?h/(C-D)*(Math.min(C,Math.log(c.partsA[k].max+y))-D):h/(C-D)*(Math.min(C,c.partsA[k].max)-D))-l;if(H=map.Dom.newShape("rect",b,l,q,m,g,"fill:"+c.colorScheme[k]+";stroke:black;stroke-width:"+map.Scale.normalX(.2)+";stroke-opacity:0.1"))H.setAttributeNS(szMapNs,"tooltip",c.szLegendLabelA[k]+" ("+c.formatValue(c.partsA[k].nCount)+" "+map.Dictionary.getLocalText("members")+")"),H.setAttributeNS(szMapNs,"onoverstyle","fill:"+c.colorScheme[k]+";stroke:black;stroke-width:"+
map.Scale.normalX(.5)+";"),H.setAttributeNS(null,"onmouseover","map.Themes.markClass(evt,'"+c.szId+"','"+k+"','1')"),H.setAttributeNS(null,"onmouseout","map.Themes.unmarkClass(evt,'"+c.szId+"')");c.histogram.classRectA[k]=H;c.histogram.classRectXA[k]=l;c.histogram.classRectWidthA[k]=m;c.histogram.classRectMaxA[k]=c.partsA[k].max;if(f.match("INTERACTIVE")){var H=map.Dom.newGroup(b,""),F=null;if(0<k){map.Dom.newShape("line",H,l,q-map.Scale.normalY(2),l,q+g,"stroke:black;stroke-width:"+map.Scale.normalX(.5)+
";stroke-opacity:0.5");if(F=map.Dom.newShape("rect",H,l-map.Scale.normalY(1.5),q-map.Scale.normalY(6),map.Scale.normalX(3),map.Scale.normalY(5),"fill:"+c.colorScheme[k]+";stroke:black;styroke-width(1);"))F.setAttributeNS(null,"rx",map.Scale.normalX(2)),F.setAttributeNS(null,"ry",map.Scale.normalY(1.5));F=map.Dom.newText(H,l,q-map.Scale.normalY(7),A+"display:none;font-weight:normal;text-anchor:middle",c.formatValue(c.partsA[k-1].max,1))}I=new Slider(H,new box(-I,0,I+m,0));I.setId(String(k));I.parent=
c.histogram;I.textObj=F;I=m}l+=m}l=w/3;q=0;nScalingFactor=.9;k=this.getResolutionQualityOfArray(K);10>k&&(nScalingFactor=10-k);for(k=0;k<r;k++){C=K[k]/B*g*nScalingFactor;m=E?Math.exp(D+k*u)-y:D+k*u;I=E?Math.exp(D+(k+1)*u)-y:D+(k+1)*u;A="black";C=C&&!isNaN(C)?Math.min(g,Math.max(map.Scale.normalY(.5),C)):0;if(A=map.Dom.newShape("line",b,l,q+g,l,q+g-C,"stroke:"+A+";stroke-width:"+w+";"))A.setAttributeNS(szMapNs,"tooltip",c.formatValue(m,2)+" ... "+c.formatValue(I,2)+c.szUnit+" ("+K[k]+" members)"),
A.setAttributeNS(szMapNs,"onoverstyle","stroke:yellow;stroke-width:"+Math.max(map.Scale.normalX(1),w)+";");l+=w}map.Dom.newShape("line",b,-map.Scale.normalX(.5),g+1,h-map.Scale.normalX(.5),g+1,"stroke:black;stroke-width:"+map.Scale.normalX(.1)+";");r=-map.Scale.normalX(.5);h-=map.Scale.normalX(.5);l=map.Scale.normalX(2);map.Dom.newShape("line",b,r,g,r,g+l,"stroke:black;stroke-width:"+map.Scale.normalX(.2)+";");map.Dom.newShape("line",b,h,g,h,g+l,"stroke:black;stroke-width:"+map.Scale.normalX(.2)+
";");m=__scaleStyleString(map.Scale.tStyle.Summary.szStyle,.4);q=.4*map.Scale.tStyle.Summary.nFontHeight;K=g+l+.8*q;k=c.formatValue(c.nMin,0);B=c.formatValue(c.nMax,0);map.Dom.newText(b,r-10,K,m+";font-weight:normal;text-anchor:start",k);0>c.nMin&&0<c.nMax&&(r=(0-D)/u*w,map.Dom.newShape("line",b,r,g,r,g+l,"stroke:black;stroke-width:"+map.Scale.normalX(.2)+";"),map.Dom.newText(b,r,K,m+";font-weight:normal;text-anchor:start","0"));C=0;for(k=10;k<c.nMax;k*=10)for(A=1;9>A&&!(k*A>c.nMax||k*A<c.nMin);A++)r=
((E?Math.log(k*A+y):k*A)-D)/u*w,I=c.formatValue(k*A,0),r>C+I.length*q*3/8?(map.Dom.newShape("line",b,r,g,r,g+l,"stroke:black;stroke-width:"+map.Scale.normalX(.2)+";"),map.Dom.newText(b,r,K,m+";font-weight:normal;text-anchor:middle",I),C=r+I.length*q*3/8):map.Dom.newShape("line",b,r,g,r,g+l/2,"stroke:black;stroke-width:"+map.Scale.normalX(.2)+";");h>C+B.length*q*3/8&&map.Dom.newText(b,h,K,m+";font-weight:normal;text-anchor:middle;",B);e&&!f.match("INTERACTIVE")&&(r=(x-D)/u*w,map.Dom.newShape("circle",
b,r,-map.Scale.normalX(.1),map.Scale.normalX(1),"fill:#dd0000;stroke:none;"),map.Dom.newShape("line",b,-10,-5,r-10,-5,"stroke:#000000;stroke-width:"+map.Scale.normalX(.5)+";stroke-opacity:0.3"))}else{h=map.Scale.normalX(70);g=map.Scale.normalY(12);m=h/700;q=l=0;C=c.nMax;e=g/C;w=Math.max(1,Math.ceil(c.nCount/700));f=[];D=0;y=[];for(x in c.itemA)y.push(c.itemA[x].nValuesA[0]);y.sort(c.sortUp);for(x in y)D%w?f[f.length-1]+=y[x]/w:f[f.length]=y[x]/w,D++;f.sort(c.sortUp);for(k=0;k<f.length;k++){x=f[k];
C=f[k]*e*.9;A="black";for(w=0;w<c.partsA.length;w++)if(f[k]<c.partsA[w].max){A=c.colorScheme[w];break}A=map.Dom.newShape("line",b,l,q,l,g,"stroke:"+A+";stroke-width:"+m+";");A.setAttributeNS(szMapNs,"tooltip",c.formatValue(x,2)+c.szUnit);isNaN(C)&&(C=0);A=map.Dom.newShape("line",b,l,q+g,l,q+g-C,"stroke:#000000;stroke-width:"+m+";");A.setAttributeNS(szMapNs,"tooltip",c.formatValue(x,2)+c.szUnit);l+=m}k=c.formatValue(c.nMin,0);B=c.formatValue(c.nMax,0);m=__scaleStyleString(map.Scale.tStyle.Summary.szStyle,
.4);map.Dom.newText(b,l+map.Scale.normalX(1),q+g,m+";font-weight:normal;text-anchor:start;stroke-opacity:0.8;",k);map.Dom.newText(b,l+map.Scale.normalX(1),q+map.Scale.normalY(3.5),m+";font-weight:normal;text-anchor:start;stroke-opacity:0.8;",B);b&&b.fu.scale(h/l,1)}return b};Map.Histogram=function(e){this.mapTheme=e;this.fDoLog=!1;this.dValue=0;this.classRectA=[];this.classRectXA=[];this.classRectWidthA=[];this.classRectMaxA=[]};Map.Histogram.prototype=new Map;
Map.Histogram.prototype.onMouseOver=function(e,b,f){f.textObj&&f.textObj.style.setProperty("display","inline","")};Map.Histogram.prototype.onMouseOut=function(e,b,f){f.textObj&&f.textObj.style.setProperty("display","none","")};
Map.Histogram.prototype.onMouseMove=function(e,b,f){if(e=this.classRectA[Number(b)])e.setAttributeNS(null,"x",this.classRectXA[Number(b)]+f.value.x),e.setAttributeNS(null,"width",this.classRectWidthA[Number(b)]-f.value.x);if(e=this.classRectA[Number(b)-1]){e.setAttributeNS(null,"width",this.classRectWidthA[Number(b)-1]+f.value.x);var c=this.nMin+(this.nMax-this.nMin)/this.nWidth*(this.classRectXA[Number(b)]+f.value.x),c=this.fDoLog?Math.exp(c)-this.dValue:c;this.classRectMaxA[Number(b)-1]=c}f.textObj&&
(f.textObj.firstChild.nodeValue=__formatValue(c,1))};Map.Histogram.prototype.onMouseUp=function(e,b,f){(f=this.classRectA[Number(b)-1])&&(this.classRectWidthA[Number(b)-1]=f.getAttributeNS(null,"width"));b="ranges:"+String(this.nMin);for(f=0;f<this.classRectMaxA.length;f++)b+=","+String(this.classRectMaxA[f]);map.Themes.changeThemeStyle(e,this.mapTheme.szId,b)};Map.Themes.prototype.showErrorInfo=function(e,b){var f=this.getTheme(b.split(":")[0]);f&&f.showErrorInfo()};
Map.Themes.prototype.actualizeActiveTheme=function(e){for(var b=0,f=0;f<this.themesA.length;f++)if(this.themesA[f].fDone){if(this.themesA[f].szFlag.match(/CHART/))if(e&&1!=e&&this.themesA[f].szFlag.match(/DYNAMICSCALE/)&&(this.themesA[f].nScale*=Math.sqrt(e),this.themesA[f].fRealize=!0,this.themesA[f].fRedraw=!1,this.themesA[f].unpaintMap()),this.themesA[f].szFlag.match(/DECLUTTER/)&&(this.themesA[f].fDeclutter=!0,map.Themes.execute()),e&&(1!=e||this.themesA[f].szFlag.match(/FIXGRID/))&&(this.themesA[f].nChartSizeMin||
this.themesA[f].nValueSizeMin||this.themesA[f].szAggregationFieldA||this.themesA[f].nGridWidth||this.themesA[f].nGridMatrix||this.themesA[f].nGridWidthPx||this.themesA[f].nChartUpper||this.themesA[f].nChartLower||this.themesA[f].nValueUpper||this.themesA[f].nBoxUpper||this.themesA[f].nTitleUpper||this.themesA[f].nLabelUpper))if(this.themesA[f].fRealizeDone&&(this.themesA[f].szFlag.match(/AUTOGRID/)||this.themesA[f].nGridWidthPx||this.themesA[f].szAggregationFieldA)){if(this.themesA[f].szAggregationFieldA){for(var c=
this.themesA[f].nGridWidth,h=this.themesA[f].szAggregationField,g=0;g<this.themesA[f].szAggregationFieldA.length;g++){var m=Number(this.themesA[f].szAggregationFieldA[g].split(":")[1]);m&&map.Scale.nTrueMapScale*map.Scale.nZoomScale>m&&(isNaN(parseFloat(this.themesA[f].szAggregationFieldA[g+1]))?this.themesA[f].szAggregationField=this.themesA[f].szAggregationFieldA[g+1]:(this.themesA[f].szAggregationFieldA[g+1].match(/px/)?this.themesA[f].nGridWidthPx=parseFloat(this.themesA[f].szAggregationFieldA[g+
1]):(this.themesA[f].nGridWidth=parseFloat(this.themesA[f].szAggregationFieldA[g+1]),this.themesA[f].nGridWidthPx=0),this.themesA[f].szAggregationField=null));g++}this.themesA[f].szAggregationField!=h||this.themesA[f].nGridWidth!=c?(this.themesA[f].fRealize=!0,this.themesA[f].fRedraw=!1,this.themesA[f].unpaintMap(),this.themesA[f].themeNodesPosA=[]):(this.themesA[f].unpaintMap(),this.themesA[f].fRedraw=!0)}this.themesA[f].nGridWidthPx?(c=map.Scale.getDistanceInMeter(1E3,1E3,1E3+map.Scale.normalX(this.themesA[f].nGridWidthPx),
1E3),this.themesA[f].nGridWidth=c/map.Scale.nZoomScale,this.themesA[f].fRealize=!0,this.themesA[f].fRedraw=!1,this.themesA[f].unpaintMap(),this.themesA[f].themeNodesPosA=[]):this.themesA[f].nGridMatrix?(c=map.Zoom.getBox(),c=map.Scale.getDistanceInMeter(1E3,1E3,1E3+c.width,1E3),this.themesA[f].nGridWidth=c/(this.themesA[f].nGridMatrix||20)/map.Scale.nZoomScale,this.themesA[f].fRealize=!0,this.themesA[f].fRedraw=!1,this.themesA[f].unpaintMap(),this.themesA[f].themeNodesPosA=[]):this.themesA[f].nGridWidth&&
(this.themesA[f].fRealize=!0)}else this.themesA[f].fRealizeDone&&1>e&&(this.themesA[f].nChartSizeMin||this.themesA[f].nValueSizeMin)&&this.themesA[f].unpaintMap(),this.themesA[f].fRedraw=!0;else this.themesA[f].fActualize=!0;else this.themesA[f].isChecked&&!this.themesA[f].fMarkClass&&(this.themesA[f].fRedraw=!0);b+=this.themesA[f].timeAggregating}1E3<b?executeWithMessage("map.Themes.execute()","... actualize ...",100):map.Themes.execute();return null};
Map.Themes.prototype.resortCharts=function(e){var b=!1;if(this.themesA.length){for(var f=0;f<this.themesA.length;f++)this.themesA[f].fDone&&(b=this.themesA[f].fResort=!0);b&&map.Themes.execute()}e&&(e.stopPropagation(),e.preventDefault())};Map.Themes.prototype.clear=function(){this.themesA.length=0};
function ObjTheme(e,b,f,c,h){this.szName=e;this.coTable=f;this.szSelectionField=c;this.szItemField=h;this.nIndex=b;this.nFieldIndexA=[];this.nFieldSelectionIndex=this.nField100Index=-1;this.nFieldSelectionIndexA=[];this.nLabelFieldIndex=this.nValueFieldIndex=this.nFieldItemIndex=-1;this.leadOffset=!1}
ObjTheme.prototype.getFields=function(){this.szFields=this.theme.szFields;this.szFieldsA=this.theme.szFields.split("|");this.szField100=this.theme.szField100;this.szColorField=this.theme.szColorField;this.szValueField=this.theme.szValueField;this.szLabelField=this.theme.szLabelField;this.szTitleField=this.theme.szTitleField;this.szSnippetField=this.theme.szSnippetField;this.szSizeField=this.theme.szSizeField;this.szAlphaField=this.theme.szAlphaField;this.szAlphaField100=this.theme.szAlphaField100;
this.szXField=this.theme.szXField;this.szYField=this.theme.szYField;this.szFilterField=this.theme.szFilterField;this.szAggregationField=this.theme.szAggregationField;this.szSelectionFieldsA=(this.theme.szSelectionField||"").split("|");this.nFieldIndexA[0]=-1;this.nFieldSelectionIndexA[0]=-1;var e,b;b=this.coTable?this.coTable:this.szName;if(!this.szFields||""==this.szFields)return!0;try{eval("this.dbTable = "+b+".table")}catch(f){try{eval("this.dbTable = "+b+"_table")}catch(c){}}if(this.coTable&&
!this.dbTable)return displayMessage("Data not loaded!",1E3,!0),!1;if(this.dbTable){try{eval("this.dbFields = "+b+".fields")}catch(h){try{eval("this.dbFields = "+b+"_fields")}catch(g){}}try{this.szSelectionField||(this.szSelectionField=map.Layer.getLayerObj(this.szName).szSelection)}catch(m){return alert("no selection field found !!"),!1}for(e=0;e<this.dbTable.fields;e++)if(!this.dbFields||0==this.dbFields.length||!this.dbFields[e])return alert("ERROR: theme '"+this.szName+"' - table '"+b+"' - object 'fields' incorrect !"),
!1;if("$table$"==this.szFields){this.szFieldsA=[];for(e=0;e<this.dbFields.length;e++)this.dbFields[e].id!=this.szSelectionField&&"Total"!=this.dbFields[e].id&&this.szFieldsA.push(this.dbFields[e].id);this.theme.szFields=this.szFieldsA.join("|");this.theme.szFieldsA=this.szFieldsA;this.theme.szLabelA=this.szFieldsA}for(e=0;e<this.dbFields.length;e++){"undefined"!=typeof this.szItemField&&String(this.dbFields[e].id).toLowerCase()==String(this.szItemField).toLowerCase()&&(this.nFieldItemIndex=e);"undefined"!=
typeof this.szSelectionField&&String(this.dbFields[e].id).toLowerCase()==String(this.szSelectionField).toLowerCase()&&(this.nFieldSelectionIndex=e);for(b=0;b<this.szSelectionFieldsA.length;b++)this.dbFields[e].id==this.szSelectionFieldsA[b]&&(this.nFieldSelectionIndexA[b]=e);for(b=0;b<this.szFieldsA.length;b++)"!"==this.szFieldsA[b].substr(0,1)?this.dbFields[e].id==this.szFieldsA[b].substr(1,this.szFieldsA[b].length-1)&&(this.nFieldIndexA[b]=e):this.dbFields[e].id==this.szFieldsA[b]&&(this.nFieldIndexA[b]=
e);this.szField100&&this.dbFields[e].id==this.szField100&&(this.nField100Index=e);this.szColorField&&this.dbFields[e].id==this.szColorField&&(this.nColorFieldIndex=e);this.szValueField&&this.dbFields[e].id==this.szValueField&&(this.nValueFieldIndex=e);this.szLabelField&&this.dbFields[e].id==this.szLabelField&&(this.nLabelFieldIndex=e);this.szTitleField&&this.dbFields[e].id==this.szTitleField&&(this.nTitleFieldIndex=e);this.szSnippetField&&this.dbFields[e].id==this.szSnippetField&&(this.nSnippetFieldIndex=
e);this.szSizeField&&this.dbFields[e].id==this.szSizeField&&(this.nSizeFieldIndex=e);this.szXField&&this.dbFields[e].id==this.szXField&&(this.nXFieldIndex=e);this.szYField&&this.dbFields[e].id==this.szYField&&(this.nYFieldIndex=e);this.szAlphaField&&this.dbFields[e].id==this.szAlphaField&&(this.nAlphaFieldIndex=e);this.szAlphaField100&&this.dbFields[e].id==this.szAlphaField100&&(this.nAlphaField100Index=e);this.szFilterField&&this.dbFields[e].id==this.szFilterField&&(this.nFilterFieldIndex=e);this.szAggregationField&&
this.dbFields[e].id==this.szAggregationField&&(this.nAggregationFieldIndex=e)}-1==this.nFieldSelectionIndex&&-1==this.nFieldSelectionIndexA[0]&&(this.szSelectionField&&this.szSelectionField.length?alert("ERROR: theme '"+this.szName+"' selection field '"+this.szSelectionField+"' not found !"):alert("ERROR: theme '"+this.szName+"', selection not defined !"));for(b=0;b<this.szFieldsA.length;b++)if("undefined"==typeof this.nFieldIndexA[b])return alert("ERROR: theme '"+this.szName+"' value field '"+this.szFieldsA[b]+
"' not found !"),!1;this.szField100&&!this.szField100.match(/\$/)&&"undefined"==typeof this.nField100Index&&alert("ERROR: theme '"+this.szName+"' 100field: '"+this.szField100+"' not found !");this.szColorField&&!this.szColorField.match(/\$/)&&"undefined"==typeof this.nColorFieldIndex&&alert("ERROR: theme '"+this.szName+"' colorfield: '"+this.szColorField+"' not found !");this.szValueField&&!this.szValueField.match(/\$/)&&"undefined"==typeof this.nValueFieldIndex&&alert("ERROR: theme '"+this.szName+
"' valuefield: '"+this.szValueField+"' not found !");this.szLabelField&&!this.szLabelField.match(/\$/)&&"undefined"==typeof this.nLabelFieldIndex&&alert("ERROR: theme '"+this.szName+"' labelfield: '"+this.szLabelField+"' not found !");this.szTitleField&&!this.szTitleField.match(/\$/)&&"undefined"==typeof this.nTitleFieldIndex&&alert("ERROR: theme '"+this.szName+"' titlefield: '"+this.szTitleField+"' not found !");this.szSnippetField&&!this.szSnippetField.match(/\$/)&&"undefined"==typeof this.nSnippetFieldIndex&&
alert("ERROR: theme '"+this.szName+"' snippetfield: '"+this.szSnippetField+"' not found !");!this.szSizeField||this.szSizeField.match(/\$/)||this.szSizeField.match(/aggregation/)||"undefined"!=typeof this.nSizeFieldIndex||alert("ERROR: theme '"+this.szName+"' sizefield: '"+this.szSizeField+"' not found !");!this.szXField||this.szXField.match(/\$/)||this.szXField.match(/aggregation/)||"undefined"!=typeof this.nXFieldIndex||alert("ERROR: theme '"+this.szName+"' xfield: '"+this.szXField+"' not found !");
!this.szYField||this.szYField.match(/\$/)||this.szYField.match(/aggregation/)||"undefined"!=typeof this.nYFieldIndex||alert("ERROR: theme '"+this.szName+"' yfield: '"+this.szYField+"' not found !");this.szAlphaField&&!this.szAlphaField.match(/\$/)&&"undefined"==typeof this.nAlphaFieldIndex&&alert("ERROR: theme '"+this.szName+"' alphafield: '"+this.szAlphaField+"' not found !");this.szAlphaField100&&!this.szAlphaField100.match(/\$/)&&"undefined"==typeof this.nAlphaField100Index&&alert("ERROR: theme '"+
this.szName+"' alpha100field: '"+this.szAlphaField100+"' not found !");this.szFilterField&&!this.szFilterField.match(/\$/)&&"undefined"==typeof this.nFilterFieldIndex&&alert("ERROR: theme '"+this.szName+"' filterfield: '"+this.szFilterField+"' not found !");this.szAggregationField&&!this.szAggregationField.match(/\$/)&&"undefined"==typeof this.nAggregationFieldIndex&&alert("ERROR: theme '"+this.szName+"' aggregationfield: '"+this.szAggregationField+"' not found !")}else{e=SVGDocument.getElementById(this.szName);
null==e&&(b=map.Tiles.getTileNodes(this.szName))&&(e=b[0]);if(!e)return this.szName="",!1;e=e.getAttributeNS(szMapNs,"info");if(null==e||""==e)return this.szName="",!1;var l=e.split("|");for(e=0;e<l.length;e++){for(b=0;b<this.szFieldsA.length;b++)"!"==this.szFieldsA[b].substr(0,1)?l[e]==this.szFieldsA[b].substr(1,this.szFieldsA[b].length-1)&&(this.nFieldIndexA[b]=e):l[e]==this.szFieldsA[b]&&(this.nFieldIndexA[b]=e);this.szField100&&l[e]==this.szField100&&(this.nField100Index=e);this.szColorField&&
l[e]==this.szColorField&&(this.nColorFieldIndex=e);this.szValueField&&l[e]==this.szValueField&&(this.nValueFieldIndex=e);this.szLabelField&&l[e]==this.szLabelField&&(this.nLabelFieldIndex=e);this.szSizeField&&l[e]==this.szSizeField&&(this.nSizeFieldIndex=e);this.szXField&&l[e]==this.szXField&&(this.nXFieldIndex=e);this.szYField&&l[e]==this.szXField&&(this.nYFieldIndex=e);this.szAlphaField&&l[e]==this.szAlphaField&&(this.nAlphaFieldIndex=e);this.szAlphaField100&&l[e]==this.szAlphaField100&&(this.nAlphaField100Index=
e)}}for(b=0;b<this.szFieldsA.length;b++)0>this.nFieldIndexA[b]&&("$item$"!=this.szFieldsA[b]&&"$index$"!=this.szFieldsA[b]&&_ERROR("error: "+this.szFieldsA[b]+" not found in "+this.szName+" !"),this.szName="");return!0};
function MapTheme(e,b,f,c,h,g,m){this.fDone=!1;this.nMin=3E8;this.nNoData=this.nCount=this.nSum=this.nMax=0;this.szThemes=e;this.szThemesA=e.split("|");this.checkTheme();this.objThemesA=[];this.szFields=b;this.szFieldsA=b.split("|");this.szField100=f;this.nFieldsA=[];this.nFields100A=[];this.nFieldsSelectionA=[];this.nMinA=[];this.nMaxA=[];this.nSumA=[];this.nMeanA=[];this.nMedianA=[];this.nDeviationA=[];this.nOrigMinA=[];this.nOrigMaxA=[];this.nOrigSumA=[];for(f=0;f<this.szFieldsA.length;f++)this.nMinA[f]=
3E8,this.nMaxA[f]=0,this.nSumA[f]=0,this.nOrigMinA[f]=3E8,this.nOrigMaxA[f]=0,this.nOrigSumA[f]=0,this.nMedianA[f]=0,this.nMeanA[f]=0;this.nMin100=3E8;this.nSum100=this.nMax100=0;this.nMinSize=3E8;this.nSumSize=this.nMaxSize=0;this.nMinAlpha=3E8;this.nSumAlpha=this.nMaxAlpha=0;this.nMinX=3E8;this.nSumX=this.nMaxX=0;this.nMinY=3E8;this.nSumY=this.nMaxY=0;this.nDominantDFilter=this.szDominantFilter=null;this.nFilterA=[];this.dbTableA=[];this.dbFieldsA=[];this.dbRecordsA=[];if(h)for(f in this.origColorScheme=
[],h)this.origColorScheme[f]=h[f];else this.origColorScheme=null;this.defaultColorScheme=["#008888","#00aaaa","#00cccc","#00eeee","#00ffff"];this.szTitle=g?g:e+" ["+b+"]";this.szTitle=map.Dictionary.getLocalText(this.szTitle);this.szTitle=60<this.szTitle.length?this.szTitle.slice(0,50)+" ...":this.szTitle;this.szUnits="";this.szXaxisA=this.szAlphaValueUnits=this.szSizeValueUnits=null;this.szOrigLabelA=this.szLabelA=m;this.szLegendLabelA=[];this.szLegendStyle="";this.evidenceMode="isolate";this.szAggregation=
"mean";this.nValuesA=[];this.szExactA=this.szRangesA=this.szValuesA=null;this.itemA=[];this.fDataCache=!0;this.fEditor=!1;this.fNegativeValuePossible=this.fNullIsValue=!0;this.nStringToValue=1;this.nStringToValueA=[];this.szOrigFlag=this.szFlag=c?c:"CHOROPLETH";this.nScale=1;this.nRefreshTimeout=0;this.szId="theme"+String(Math.random());this.szShapeType="polygon";if(e=map.Layer.getLayerObj(this.szThemesA[0]))this.szShapeType=e.szType,"line"==this.szShapeType&&this.szOrigFlag.match(/BUFFER/)&&(this.szShapeType+=
"+buffer");this.hiddenLayerA=[];this.szFlag.match(/CHART/)||(this.szFlag.match(/PIE/)?this.szOverviewChart="PIE":this.szFlag.match(/DONUT/)&&(this.szOverviewChart="DONUT"));this.szFlag.match(/ZEROISNOTVALUE/)&&(this.fNullIsValue=!1);this.szFlag.match(/ZEROISVALUE/)&&(this.fNullIsValue=!0);this.szFlag.match(/NEGATIVEISVALUE/)&&(this.fNegativeValuePossible=!0);this.szFlag.match(/SUM/)&&(this.szAggregation="sum");if(this.szFlag.match(/CHART/)){if(this.szFlag.match(/EXACT/)||1<this.szFieldsA.length)this.fNullIsValue=
!0;this.szFlag.match(/BUFFER/)||(this.fShadow=this.fOrigShadow=!0)}this.szFlag.match(/EXACT/)&&!this.szLabelA&&(this.szLabelA=[]);this.fGrayNoMember=this.fSortBeforeDraw=this.fClipCharts=!0;this.nClipTimeout=1E3;this.paintedShapeNodesA=[];this.szChoroplethInfoStyle=map.Themes.szChoroplethInfoStyle;this.nMaxThemeCharts=map.Themes.nMaxThemeCharts;this.nMaxShadowCharts=map.Themes.nMaxShadowCharts;this.nflushPaintShape=map.Themes.nflushPaintShape;this.nflushChartDraw=map.Themes.nflushChartDraw;this.themeNodesPosA=
[]}MapTheme.prototype.checkTheme=function(){if(!this.szThemesA)return!1;for(var e=0;e<this.szThemesA.length;e++)if("generic"==this.szThemesA[e]||map.Layer.isLoaded(this.szThemesA[e]))return!0;this.ErrorMessage="theme layer not loaded ! zoom in ?";return!1};MapTheme.prototype.def=function(){return map.Themes.getMapThemeDefinitionObj(this.szId)};MapTheme.prototype.getDefinitionObject=function(){return map.Themes.getMapThemeDefinitionObj(this.szId)};
MapTheme.prototype.initValues=function(){this.nMin=3E8;for(var e=this.nNoData=this.nCount=this.nSum=this.nMax=0;e<this.szFieldsA.length;e++)this.nMinA[e]=3E8,this.nMaxA[e]=0,this.nSumA[e]=0,this.nOrigMinA[e]=3E8,this.nOrigMaxA[e]=0,this.nOrigSumA[e]=0,this.nMedianA[e]=0,this.nMeanA[e]=0,this.nDeviationA[e]=0;this.nMin100=3E8;this.nSum100=this.nMax100=0;this.itemA=[];this.posItemA=[];this.chartPosA=[];this.exactCountA=[];this.exactSizeA=[];this.quantileA=[];this.szAggregation||(this.szAggregation=
this.szField100?"mean":"sum");if(this.szAggregationFieldA&&!this.fSuppressAggregationScale)for(e=0;e<this.szAggregationFieldA.length;e++){var b=Number(this.szAggregationFieldA[e].split(":")[1]);b&&map.Scale.nTrueMapScale*map.Scale.nZoomScale>b&&(isNaN(parseFloat(this.szAggregationFieldA[e+1]))?this.szAggregationField=this.szAggregationFieldA[e+1]:(this.szAggregationFieldA[e+1].match(/px/)?this.nGridWidthPx=parseFloat(this.szAggregationFieldA[e+1]):(this.nGridWidth=parseFloat(this.szAggregationFieldA[e+
1]),this.nGridWidthPx=0),this.szAggregationField=null));e++}this.fSuppressAggregationScale=!1;this.nWrongRecordLengthCount=0;this.missedA=[];this.coTable&&"genericTable"!=this.coTable||(genericTable=this.loadTableFromMap(),this.coTable="genericTable")};
MapTheme.prototype.getMeanMedianQuantile=function(){if(!this.quantileA||!this.quantileA.length)for(var e=0;e<this.szFieldsA.length;e++){var b=[];for(a in this.itemA)b.push(this.itemA[a].nValuesA[e]);"$item$"!=this.szFieldsA[e]&&b.sort(this.sortUp);var f=Math.round(b.length/2);this.nMedianA[e]=b[f];this.nMeanA[e]=this.nSumA[e]/b.length;this.quantileA[e]=b}};
MapTheme.prototype.realize=function(){var e=new Date;this.fShowProgressBar=!0;this.initValues();this.getFields()?this.loadValues()?(this.timeLoading=new Date-e,this.fAggregate=!0,(1E3<this.timeLoading||this.szFlag.match(/VERBOSE/))&&!this.szFlag.match(/SILENT/)?executeWithMessage("map.Themes.continueExecute();",this.szFlag.match(/AGGREGATE/)?"aggregating":"parsing data"):map.Themes.continueExecute()):this.fRemove=!0:this.fRemove=!0};
MapTheme.prototype.realize_aggregate=function(){var e=new Date;this.distributeValues();this.timeAggregating=new Date-e;this.fDraw=!0;(1E3<this.timeLoading||this.szFlag.match(/VERBOSE/))&&!this.szFlag.match(/SILENT/)?executeWithMessage("map.Themes.continueExecute();","drawing"):map.Themes.continueExecute()};
MapTheme.prototype.realize_draw=function(){this.timeStart=new Date;this.nMissingPositionCount=this.nMissingRangeCount=this.nZeroValueCount=this.nRealizedCount=this.nSkipCount=this.nDoneCount=0;this.missedA=[];this.nActualFrame=0;var e=this.szFlag.match(/VERBOSE/)?"drawing":"";this.mapSleep=new Map.Sleep("map.Themes.continueExecute",this.nflushPaintShape,map.Dictionary.getLocalText(e));this.mapSleep.nCount=this.nCount;this.mapSleep.szCancel="map.Themes.cancelExecute()";this.szFlag.match(/CLIP/)&&(this.mapSleep=
null,this.nClipIncr=1);this.szFlag.match(/CHART/)?(this.mapSleep&&this.mapSleep.initCheckSleep(this.nflushChartDraw,e),this.chartMap()):(this.unlabelMap(),this.paintMap(),this.makeVisible());this.isChecked=!0;this.szFlag.match(/BUFFER/)?map.Themes.activeBuffer=this:map.Themes.activeTheme=this;try{HTMLWindow.ixmaps.htmlgui_setActualTheme(this.szId)}catch(b){}!this.szFlag.match(/CHART/)||this.szFlag.match(/BUBBLE/)||this.szFlag.match(/SQUARE/)||this.szFlag.match(/SYMBOL/)||this.szFlag.match(/BAR/)&&
this.colorScheme&&this.nOrigSumA&&this.nOrigSumA.length!=this.colorScheme.length?this.isMarkable=!0:this.isMarkable=!1};MapTheme.prototype.realizeContinue=function(e){this.fMakeLabel?this.labelMap(e):this.szFlag.match(/CHART/)?this.chartMap(e):this.paintMap(e)};
MapTheme.prototype.realizeNextClipFrame=function(){this.fClipPause||(this.nActualFrame+=this.nClipIncr,this.nActualFrame>=this.nClipFrames?this.szFlag.match(/BACK/)?(this.nClipIncr=-this.nClipIncr,this.clipTimeout=setTimeout("map.Themes.nextClipFrame('"+this.szId+"')",2E3)):this.szFlag.match(/LOOP/)?(this.nActualFrame=-1,this.clipTimeout=setTimeout("map.Themes.nextClipFrame('"+this.szId+"')",2E3)):(this.nActualFrame=this.nClipFrames-1,this.pauseClip()):0>this.nActualFrame?this.szFlag.match(/BACK/)?
(this.nClipIncr=-this.nClipIncr,this.clipTimeout=setTimeout("map.Themes.nextClipFrame('"+this.szId+"')",10)):(this.nActualFrame=0,this.pauseClip()):(displayMessage("... "+this.nActualFrame+" ...",5E3),this.mapSleep=null,this.szFlag.match(/CHART/)?(this.chartPosA=[],this.posItemA=[],this.fRedraw=!0,this.chartMap()):this.paintMap(),this.fRedrawInfo=!0))};
MapTheme.prototype.setClipFrame=function(e){this.fClipPause=!0;this.nActualFrame=Math.min(e,this.nClipFrames);this.mapSleep=null;this.szFlag.match(/CHART/)?(this.chartPosA=[],this.posItemA=[],this.unpaintMap(),this.chartMap()):this.paintMap();this.fRedrawInfo=!0};
MapTheme.prototype.startClip=function(){var e=SVGDocument.getElementById(this.szId+":display:widget:clippausebutton:button");e&&e.style.setProperty("display","inline","");(e=SVGDocument.getElementById(this.szId+":display:widget:clipstartbutton:button"))&&e.style.setProperty("display","none","");this.fClipPause=!1;this.nActualFrame=0;this.realizeNextClipFrame()};
MapTheme.prototype.pauseClip=function(){var e=SVGDocument.getElementById(this.szId+":display:widget:clippausebutton:button");e&&e.style.setProperty("display","none","");(e=SVGDocument.getElementById(this.szId+":display:widget:clipstartbutton:button"))&&e.style.setProperty("display","inline","");this.fClipPause=!0};
MapTheme.prototype.realizeDone=function(){this.nRefreshTimeout&&setTimeout("map.Themes.refreshTheme('"+this.szId+"')",this.nRefreshTimeout);this.szFlag.match(/CLIP/)&&(this.clipTimeout&&clearTimeout(this.clipTimeout),this.clipTimeout=setTimeout("map.Themes.nextClipFrame('"+this.szId+"')",this.nActualFrame?this.nClipTimeout:2E3));clearMessage();this.nWrongRecordLengthCount&&fDebug&&displayMessage("Data Error:  "+this.nWrongRecordLengthCount+" items have wrong record length",1E4,"notify");this.fRealize=
this.fRedraw=!1;this.fDone=!0;this.timeRealizing=new Date-this.timeStart;map.Themes.realizeDone(this)};MapTheme.prototype.beginDraw=function(){};MapTheme.prototype.endDraw=function(){};
MapTheme.prototype.redraw=function(e){this.clipTimeout&&clearTimeout(this.clipTimeout);this.fDataIncomplete&&this.__themeNodes!=map.Themes.themeNodes&&(this.fDataIncomplete=!1,this.initValues(),this.loadValues(),this.distributeValues());if(this.szFlag.match(/CHART/)){if(this.fClipCharts||this.fRedraw)this.nMissingPositionCount=this.nMissingRangeCount=this.nZeroValueCount=this.nRealizedCount=this.nDoneCount=this.nSkipCount=0,this.chartMap()}else if(this.isChecked){if(this.partsA)for(i=0;i<this.partsA.length;i++)this.partsA[i].nCount=
0,this.partsA[i].nSum=0;this.mapSleep&&this.mapSleep.initCheckSleep(this.nflushPaintShape,"painting map");this.makeVisible();this.paintMap()}e&&this.enable()};
MapTheme.prototype.toFront=function(){if(this.szFlag.match(/CHART/))this.chartGroup.parentNode.appendChild(this.chartGroup),(matrixA=getMatrix(this.chartGroup))&&setMatrix(this.chartGroup,matrixA),this.enable();else if(this.isChecked){for(i=0;i<this.partsA.length;i++)this.partsA[i].nCount=0,this.partsA[i].nSum=0;this.mapSleep&&this.mapSleep.initCheckSleep(this.nflushPaintShape,"painting map");this.paintMap()}else this.enable()};
MapTheme.prototype.getFields=function(){for(var e=0;e<this.szThemesA.length;e++){var b=this.szThemesA[e];this.objThemesA[b]=new ObjTheme(b,e,this.coTable,this.szSelectionField,this.szItemField);this.objThemesA[b].theme=this;if(!this.objThemesA[b].getFields()){try{HTMLWindow.ixmaps.htmlgui_onErrorTheme(b)}catch(f){}return!1}}return!0};
MapTheme.prototype.addItemValues=function(e,b,f,c,h){if(!this.szFlag.match(/RAW/)||f|c|h){var g;if(this.szExcludeA)for(g=0;g<this.szExcludeA.length;g++)if(e.split("::")[1]==this.szExcludeA[g])return;if(!(this.nField100Min&&f&&f<this.nField100Min)){if(this.nMinValue&&b&&!f){var m=!1;for(g=b.length-1;0<=g;g--)b[g]>=this.nMinValue&&(m=!0);if(!m)return}m=1;if(this.__fDensity||this.__fDensityAlpha)if(m=this.getNodeArea(e),!m&&this.__fTiledLayer){this.fDataIncomplete=!0;return}if(this.szWeights)for(g=0;g<
b.length;g++)b[g]*=this.szWeightsA[g]||this.szWeightsA[0];if(this.__fAuto100){for(g=f=0;g<b.length;g++)f+=b[g]||0;this.fField100=!0}this.itemA[e]={nOrigValuesA:[],nValuesA:b,nValue100:f,nValueSum:0};for(g=0;g<b.length;g++){this.itemA[e].nOrigValuesA[g]=isNaN(b[g])?0:b[g];this.itemA[e].nValueSum+=b[g];if(this.fField100)if(f){var l=b[g];0!=l||this.szFlag.match(/ZEROISVALUE/)?"!"==this.szFieldsA[g].substr(0,1)?(l=f-l,this.itemA[e].nOrigValuesA[g]=l):this.szFlag.match(/CALCVAL/)||this.szFlag.match(/CALC100/)?
(l=f?Math.round(l*f/100):l,this.itemA[e].nOrigValuesA[g]=l):this.szFlag.match(/PRODUCT/)?l=f?l*f:l:this.szFlag.match(/DIFFERENCE/)&&1==b.length&&!this.szFlag.match(/RELATIVE/)?(f=0<g?b[g-1]:this.itemA[e].nValue100,l-=f):(l=f?l/f:1,this.szFlag.match(/FRACTION/)?l*=this.nFractionScale||1:this.szFlag.match(/PERMILLE/)?l*=1E3:(l*=100,0<l&&this.szFlag.match(/RELATIVE/)?l-=100:0<l&&this.szFlag.match(/INVERT/)&&(l=100-l))):l=0;b[g]=l}else b[g]=0;this.__fDensity&&(b[g]=m?b[g]/m:null)}if(this.__fDifference&&
1<b.length){for(g=0;g<b.length;g++)g<b.length-1?(l=b[g],b[g]=b[g+1]-b[g],this.szFlag.match(/RELATIVE/)&&(b[g]*=100/l)):this.szFlag.match(/STACKED/)||(b[g]=0);b.pop()}for(g=0;g<b.length;g++){if(!this.nSumA)return;isNaN(b[g])||(this.nMin=Math.min(this.nMin,b[g]),this.nMax=Math.max(this.nMax,b[g]),this.nSum+=b[g],this.nMinA[g]=Math.min(this.nMinA[g],b[g]),this.nMaxA[g]=Math.max(this.nMaxA[g],b[g]),this.nSumA[g]+=b[g],this.nOrigMinA[g]=Math.min(this.nOrigMinA[g],this.itemA[e].nOrigValuesA[g]),this.nOrigMaxA[g]=
Math.max(this.nOrigMaxA[g],this.itemA[e].nOrigValuesA[g]),this.nOrigSumA[g]+=this.itemA[e].nOrigValuesA[g]);0>b[g]&&(this.fNegativeValues=!0)}isNaN(f)||(this.nMin100=Math.min(this.nMin100,f),this.nMax100=Math.max(this.nMax100,f),this.nSum100+=f);c&&this.szSizeField&&!isNaN(c)&&(this.itemA[e].nSize=c,this.nMinSize=Math.min(this.nMinSize,c),this.nMaxSize=Math.max(this.nMaxSize,c),this.nSumSize+=c);this.szAlphaField&&null!=h&&!isNaN(h)&&(this.__fDensityAlpha&&(h=m?Math.min(h/m,5E4):0),this.itemA[e].nAlpha=
h,this.nMinAlpha=Math.min(this.nMinAlpha,h),this.nMaxAlpha=Math.max(this.nMaxAlpha,h),this.nSumAlpha+=h);if(this.__fExact&&this.exactCountA)for(g=0;g<b.length;g++)b[g]&&(this.exactCountA[b[g]-1]?(this.exactCountA[b[g]-1]++,this.exactSizeA[b[g]-1]+=this.itemA[e].nSize||1):(this.exactCountA[b[g]-1]=1,this.exactSizeA[b[g]-1]=this.itemA[e].nSize||1));this.nCount++}}else{this.itemA[e]={nOrigValuesA:[],nValuesA:b,nValue100:f,nValueSum:0};for(g=0;g<b.length;g++){if(!this.nSumA)return;isNaN(b[g])||(this.nMin=
Math.min(this.nMin,b[g]),this.nMax=Math.max(this.nMax,b[g]),this.nSum+=b[g]);0>b[g]&&(this.fNegativeValues=!0);this.__fExact&&this.exactCountA&&b[g]&&(this.exactCountA[b[g]-1]?(this.exactCountA[b[g]-1]++,this.exactSizeA[b[g]-1]+=this.itemA[e].nSize||1):(this.exactCountA[b[g]-1]=1,this.exactSizeA[b[g]-1]=this.itemA[e].nSize||1))}this.nCount++}};
MapTheme.prototype.getStringValueIndex=function(e,b){if(0==e.length||" "==e)if(this.szFlag.match(/UNDEFINEDISVALUE/))e="undefined";else return-1;this.szFlag.match(/IGNORECASE/)&&(e=e.toUpperCase());e=e.trim();"undefined"!=typeof this.nStringToValueA[e]||this.szValuesA&&this.szValuesA.length&&"set"!=b||(this.szLabelA=this.szLabelA||[],this.szExactA=this.szExactA||[],this.nStringToValueA[e]=this.nStringToValue,this.szLabelA[this.nStringToValue-1]=this.szLabelA[this.nStringToValue-1]||e,this.szExactA.push(this.nStringToValue),
this.nStringToValue++);return this.nStringToValueA[e]};MapTheme.prototype.checkHiddenLayerState=function(){for(i=0;i<this.szThemesA.length;i++)if(map.Layer.isScaleDependentLayer(this.szThemesA[i])&&(this.hiddenLayerA[this.szThemesA[i]]&&map.Layer.isScaleDependentLayerOn(this.szThemesA[i])||!this.hiddenLayerA[this.szThemesA[i]]&&!map.Layer.isScaleDependentLayerOn(this.szThemesA[i])))return!0;return!1};
__scanValue=function(e){return String(e).match(/,/)?parseFloat(String(e).replace(/\./gi,"").replace(/,/gi,".")):parseFloat(String(e).replace(/ /gi,""))};
MapTheme.prototype.loadValues=function(){this.nMissingLookupCount=0;this.__fExact=this.szFlag.match(/EXACT/);this.__fDifference=this.szFlag.match(/DIFFERENCE/);this.__fFilter=this.szFilter&&this.szFilter.length;this.__fDensity=this.szFlag.match(/DENSITY/);this.__fDensityAlpha=!this.szFlag.match(/CHART/)&&this.szAlphaField100&&this.szAlphaField100.match(/\$density\$/i);this.__fAggregate=this.szFlag.match(/AGGREGATE/);this.__fAuto100=this.szFlag.match(/AUTO100/)&&!this.szFlag.match(/AGGREGATE/);this.__fTiledLayer=
map.Layer.getLayerObj(this.szThemesA[0])?map.Layer.getLayerObj(this.szThemesA[0]).szFlag.match(/tiled/):!1;this.__themeNodes=map.Themes.themeNodes;for(i=0;i<this.szThemesA.length;i++)if(map.Layer.isScaleDependentLayer(this.szThemesA[i])&&!map.Layer.isScaleDependentLayerOn(this.szThemesA[i]))this.fReload=this.hiddenLayerA[this.szThemesA[i]]=!0;else if(this.hiddenLayerA[this.szThemesA[i]]=!1,!this.loadValuesOfTheme(this.szThemesA[i]))return!1;return!0};
MapTheme.prototype.filterValues=function(e){if(this.szFilter.match(/WHERE/)){if(!this.objTheme.filterQueryA){for(var b=this.szFilter.split("WHERE ")[1].split(" "),f=0;f<b.length;f++)if('"'==b[f][0]&&'"'!=b[f][b[f].length-1]){do b[f]=b[f]+" "+b[f+1],b.splice(f+1,1);while('"'!=b[f][b[f].length-1])}this.objTheme.filterQueryA=[];var c={};do{var h=0;3<=b.length&&(c={},c.szFilterField=b[0].replace(/("|)/g,""),c.szFilterOp=b[1],c.szFilterValue=b[2].replace(/("|)/g,""),h=3);"BETWEEN"==c.szFilterOp&&5<=b.length&&
"AND"==b[3]&&(c.szFilterValue2=b[4],h=5);if(h){for(f=0;f<this.objTheme.dbFields.length;f++)this.objTheme.dbFields[f].id==c.szFilterField&&(c.nFilterFieldIndex=f);this.objTheme.filterQueryA.push(c);b.splice(0,h)}else{alert("ixmaps - filter error - incomplete query!\nquery: "+this.szFilter);break}if(b.length&&"AND"==b[0])b.splice(0,1);else break}while(b.length)}for(i in this.objTheme.filterQueryA)if(this.__szValue=String(this.objTheme.dbRecords[e][this.objTheme.filterQueryA[i].nFilterFieldIndex]),this.__szFilterOp=
this.objTheme.filterQueryA[i].szFilterOp,this.__szFilterValue=this.objTheme.filterQueryA[i].szFilterValue,this.__szFilterValue2=this.objTheme.filterQueryA[i].szFilterValue2,b=!0,b=__scanValue(this.__szValue),b="="==this.__szFilterOp?this.__szValue==this.__szFilterValue||b==Number(this.__szFilterValue):"!="==this.__szFilterOp?!(this.__szValue==this.__szFilterValue||b==Number(this.__szFilterValue)):"<>"==this.__szFilterOp?!(this.__szValue==this.__szFilterValue||b==Number(this.__szFilterValue)):">"==
this.__szFilterOp?b>Number(this.__szFilterValue):"<"==this.__szFilterOp?b<Number(this.__szFilterValue):">="==this.__szFilterOp?b>=Number(this.__szFilterValue):"<="==this.__szFilterOp?b<=Number(this.__szFilterValue):"LIKE"==this.__szFilterOp?eval("this.__szValue.match(/"+this.__szFilterValue.replace(/\//gi,"\\/")+"/i)"):"IN"==this.__szFilterOp?eval("this.__szFilterValue.match(/\\("+this.__szValue+"\\,/)")||eval("this.__szFilterValue.match(/\\,"+this.__szValue+"\\,/)")||eval("this.__szFilterValue.match(/\\,"+
this.__szValue+"\\)/)"):"BETWEEN"==this.__szFilterOp?b>=Number(this.__szFilterValue)&&b<=Number(this.__szFilterValue2):eval("this.__szValue.match(/"+this.__szFilterValue.replace(/\//gi,"\\/")+"/i)"),!b)return!1}else if(this.__szValue=this.objTheme.dbRecords[e].join(" "),!eval("this.__szValue.match(/"+this.szFilter+"/i)"))return!1;return!0};
MapTheme.prototype.getSelectionId=function(e,b){this.fSelection||(this.fSelection="lookup",this.objTheme.nFieldSelectionIndexA&&1<this.objTheme.nFieldSelectionIndexA.length?(this.fSelection="LatLon",this.nSelection_0=this.objTheme.nFieldSelectionIndexA[0],this.nSelection_1=this.objTheme.nFieldSelectionIndexA[1]):(szId=__mpap_decode_utf8(String(this.objTheme.dbRecords[b][this.objTheme.nFieldSelectionIndex])),szId.match(/MultiPoint/)?this.fSelection="MultiPoint":szId.match(/Point/)&&(this.fSelection=
"MultiPoint")));if("LatLon"==this.fSelection)return e+"::"+(String(this.objTheme.dbRecords[b][this.nSelection_0]).replace(/,/g,".")+","+String(this.objTheme.dbRecords[b][this.nSelection_1]).replace(/,/g,"."))+(this.szSelectionFieldSuffix||"").replace(/,/g,".");if("MultiPoint"==this.fSelection){szId=this.objTheme.dbRecords[b][this.objTheme.nFieldSelectionIndex];var f=null;return(f=szId.match(positionRegExp))?e+"::"+(f[2]+","+f[1])+(this.szSelectionFieldSuffix||""):null}szId=__mpap_decode_utf8(String(this.objTheme.dbRecords[b][this.objTheme.nFieldSelectionIndex]));
this.nSelectionFieldDigits&&(szId=("000000000000000"+szId).slice(-this.nSelectionFieldDigits));this.fSelectionFieldToNumber&&(szId=String(Number(szId)));this.fSelectionFieldToUpper&&(szId=String(szId).toUpperCase());return e+"::"+szId+(this.szSelectionFieldSuffix||"")};
MapTheme.prototype.loadValuesOfTheme=function(e){var b,f,c,h,g;this.fNegativeValues=this.fField100=!1;this.szUnit=(this.szUnits?"."==this.szUnits.substr(0,1)?"":" ":"")+(this.szUnits||"");var m=!0;this.objTheme=this.objThemesA[e];0<this.objTheme.nField100Index&&(this.fField100=!0);if(this.objTheme.dbTable&&e&&e.length){if(this.coTable){try{eval("this.objTheme.dbRecords = "+this.coTable+".records")}catch(l){eval("this.objTheme.dbRecords = "+this.coTable+"_records")}if(!this.objTheme.dbRecords)return displayMessage("Data "+
this.coTable+" could not be loaded!",2E3,!0),!1}else try{eval("this.objTheme.dbRecords = "+e+".records")}catch(q){eval("this.objTheme.dbRecords = "+e+"_records")}this.objTheme.nFieldSelectionIndexA.length||delete this.objTheme.nFieldSelectionIndexA;if("$item$"!=this.szFieldsA[0]&&!this.szFlag.match(/EXACT/))for(h=Math.min(40,this.objTheme.dbRecords.length),b=0;b<h;b++)if(this.objTheme.dbRecords[b])for(f=0;f<this.szFieldsA.length;f++)if(c=this.objTheme.dbRecords[b][this.objTheme.nFieldIndexA[f]],__scanValue(c)!=
parseFloat(c)){this.__fScanValue=!0;b=h;break}if(this.szFlag.match(/FAST/))return this.__fAggregateOnLoad=!0,this.loadAndAggregateValuesOfTheme(e);for(b=0;b<this.objTheme.dbRecords.length;b++)if(!this.objTheme.dbRecords[b]||this.objTheme.dbRecords[b].length<this.objTheme.dbFields.length)this.nWrongRecordLengthCount++;else if(!this.__fFilter||this.filterValues(b)){h=[];if("$item$"==this.szFieldsA[0])h[0]=1;else if("$index$"==this.szFieldsA[0])h[0]=b+1;else for(f=0;f<this.szFieldsA.length;f++)c=this.objTheme.dbRecords[b][this.objTheme.nFieldIndexA[f]],
this.__fExact?(c=this.valueMap?this.valueMap[String(c)]:c,c=this.getStringValueIndex(String(c))):c=this.__fScanValue?__scanValue(c):parseFloat(c),isNaN(c)||0==c&&!this.fNullIsValue||0>c&&!this.fNegativeValuePossible||(h[f]=c);h.length=this.szFieldsA.length;g="$item$"==this.szField100?1:0>this.objTheme.nField100Index?0:__scanValue(this.objTheme.dbRecords[b][this.objTheme.nField100Index]);0!=g||this.fNullIsValue||(g=null);0>g&&!this.fNegativeValuePossible&&(g=null);var x=null;this.szSizeField&&(x=__scanValue(this.objTheme.dbRecords[b][this.objTheme.nSizeFieldIndex]));
var r=null;this.szAlphaField&&(r=__scanValue(this.objTheme.dbRecords[b][this.objTheme.nAlphaFieldIndex]),isNaN(r)&&(r=0));this.szAlphaField100&&this.objTheme.nAlphaField100Index&&(r*=100/__scanValue(this.objTheme.dbRecords[b][this.objTheme.nAlphaField100Index]),isNaN(r)&&(r=0));if(c=f=this.getSelectionId(e,b)){0<=this.objTheme.nFieldItemIndex&&this.objTheme.nFieldItemIndex!=this.objTheme.nFieldSelectionIndex&&(f=__mpap_decode_utf8(String(this.objTheme.dbRecords[b][this.objTheme.nFieldItemIndex])),
this.fSelectionFieldToUpper&&(f=String(f).toUpperCase()),f=e+"::"+f);if(this.itemA[f]){if(this.szFlag.match(/DOT/))continue;f+="*"+Math.random();if(this.itemA[f])continue}this.addItemValues(f,h,g,x,r);this.itemA[f]&&(this.szColorField&&(this.itemA[f].szColor="$index$"==this.szColorField?b+1:__mpap_decode_utf8(this.objTheme.dbRecords[b][this.objTheme.nColorFieldIndex])),this.szValueField&&(this.itemA[f].szValue="$index$"==this.szValueField?b+1:__mpap_decode_utf8(this.objTheme.dbRecords[b][this.objTheme.nValueFieldIndex])),
this.szLabelField&&(this.itemA[f].szLabel="$index$"==this.szLabelField?b+1:__mpap_decode_utf8(this.objTheme.dbRecords[b][this.objTheme.nLabelFieldIndex]),this.__fExact&&(this.szLabelA[h[0]-1]=this.itemA[f].szLabel)),this.szTitleField&&(this.itemA[f].szTitle=__mpap_decode_utf8(this.objTheme.dbRecords[b][this.objTheme.nTitleFieldIndex])),this.szSnippetField&&(this.itemA[f].szSnippet=__mpap_decode_utf8(this.objTheme.dbRecords[b][this.objTheme.nSnippetFieldIndex])),this.itemA[f].szSelectionId=c?c:f,this.szAggregationField&&
(this.itemA[f].szAggregation=__mpap_decode_utf8(this.objTheme.dbRecords[b][this.objTheme.nAggregationFieldIndex])),this.szXField&&(this.itemA[f].nX=__scanValue(this.objTheme.dbRecords[b][this.objTheme.nXFieldIndex]),isNaN(this.itemA[f].nX)||(this.nMinX=Math.min(this.nMinX,this.itemA[f].nX),this.nMaxX=Math.max(this.nMaxX,this.itemA[f].nX),this.nSumX+=this.itemA[f].nXField)),this.szYField&&(this.itemA[f].nY=__scanValue(this.objTheme.dbRecords[b][this.objTheme.nYFieldIndex]),isNaN(this.itemA[f].nY)||
(this.nMinY=Math.min(this.nMinY,this.itemA[f].nY),this.nMaxY=Math.max(this.nMaxY,this.itemA[f].nY),this.nSumY+=this.itemA[f].nYField)),this.itemA[f].dbIndex=b)}else this.nMissingLookupCount++}}else m=!1;if(m)return!0};
MapTheme.prototype.loadAndAggregateValuesOfTheme=function(e){var b,f,c,h;console.log("*** F A S T ***");this.fNegativeValues=this.fField100=!1;this.__fMultiParts=this.szFlag.match(/EXACT/)&&!(this.szFlag.match(/PIE/)||this.szFlag.match(/BAR/)||this.szFlag.match(/SEQUENCE/)||this.szFlag.match(/PLOT/)||this.szFlag.match(/DOMINANT/)||this.szFlag.match(/USER/)||this.szFlag.match(/WAFFLE/));this.szUnit=(this.szUnits?"."==this.szUnits.substr(0,1)?"":" ":"")+(this.szUnits||"");this.objTheme=this.objThemesA[e];
0<this.objTheme.nField100Index&&(this.fField100=!0);if(!(this.objTheme.dbTable&&e&&e.length))return!1;if(this.coTable){try{eval("this.objTheme.dbRecords = "+this.coTable+".records")}catch(g){eval("this.objTheme.dbRecords = "+this.coTable+"_records")}if(!this.objTheme.dbRecords)return displayMessage("Data "+this.coTable+" could not be loaded!",2E3,!0),!1}else try{eval("this.objTheme.dbRecords = "+e+".records")}catch(m){eval("this.objTheme.dbRecords = "+e+"_records")}this.objTheme.nFieldSelectionIndexA.length||
delete this.objTheme.nFieldSelectionIndexA;if(this.szFlag.match(/ZOOMTO/)){this.getSelectionId(e,0);for(b=0;b<this.objTheme.dbRecords.length;b++)"LatLon"==this.fSelection?K=map.Scale.getMapPositionOfLatLon(parseFloat(String(this.objTheme.dbRecords[b][this.nSelection_0]).replace(/\,/g,".")),parseFloat(String(this.objTheme.dbRecords[b][this.nSelection_1]).replace(/\,/g,"."))):"MultiPoint"==this.fSelection?(c=this.objTheme.dbRecords[b][this.objTheme.nFieldSelectionIndex],K=c.match(positionRegExp),K=
map.Scale.getMapPositionOfLatLon(parseFloat(K[2]),parseFloat(K[1]))):(c=this.objTheme.dbRecords[b][this.objTheme.nFieldSelectionIndex],K=this.getNodePosition(e+"::"+c)),K&&(this.itemA[e+"::"+String(K.x)+","+String(K.y)]={ptPos:K});this.zoomTo();this.itemA=[];this.removeDefinitionFromFlag("ZOOMTO");e=map.Themes.getMapThemeDefinitionObj(this.szId);map.Themes.newThemeObjA=map.Themes.newThemeObjA||[];map.Themes.newThemeObjA.push(e);setTimeout("map.Themes.newThemeByObj()",100)}else{if("$item$"!=this.szFieldsA[0]&&
!this.szFlag.match(/EXACT/)){var l=Math.min(40,this.objTheme.dbRecords.length);for(b=0;b<l;b++)if(this.objTheme.dbRecords[b])for(f=0;f<this.szFieldsA.length;f++){var q=this.objTheme.dbRecords[b][this.objTheme.nFieldIndexA[f]];if(__scanValue(q)!=parseFloat(q)){this.__fScanValue=!0;b=l;break}}}this.nGridWidthPx&&(this.nGridWidth=b=map.Scale.getDistanceInMeter(1E3,1E3,1E3+map.Scale.normalX(this.nGridWidthPx),1E3));this.nGridMatrix&&(b=map.Zoom.getBox(),b=map.Scale.getDistanceInMeter(1E3,1E3,1E3+b.width,
1E3),this.nGridWidth=b/(this.nGridMatrix||20)/map.Scale.nZoomScale);l=this.nGridWidth?Math.round(map.Scale.getDeltaXofDistanceInMeter(this.nGridWidth)/20)*map.Scale.nZoomScale*20:0;this.nGridWidth&&!l&&(l=this.nGridWidth?map.Scale.getDeltaXofDistanceInMeter(this.nGridWidth)*map.Scale.nZoomScale:0);var x=map.Scale.mapCenter.x*map.Scale.nZoomScale,r=map.Scale.mapCenter.y*map.Scale.nZoomScale,k=1.15*l,H=1.15*l/2,w=l/4;this.getSelectionId(e,0);var B=0;this.nMin=3E8;this.nMax=-3E8;this.nMinSize=3E8;this.nSumSize=
this.nMaxSize=0;this.nMinAlpha=3E8;this.nSumAlpha=this.nMaxAlpha=0;if(this.__fExact)this.nMinA=[],this.nMaxA=[],this.nSumA=[],this.nOrigMinA=[],this.nOrigMaxA=[],this.nOrigSumA=[],this.nMedianA=[],this.nMeanA=[],this.nCountA=[];else for(b=0;b<this.szFieldsA.length;b++)this.nMinA[b]=3E8,this.nMaxA[b]=0,this.nSumA[b]=0,this.nOrigMinA[b]=3E8,this.nOrigMaxA[b]=0,this.nOrigSumA[b]=0,this.nMedianA[b]=0,this.nMeanA[b]=0;var D=[];for(v in this.szValuesA)D.push(0);this.szFlag.match(/DUMP/)&&(this.nChartGroupScale=
fObjectScaling?(this.nAutoScale||this.nScale)*map.Layer.nObjectScale*map.Scale.nObjectScaling:(this.nAutoScale||this.nScale)*map.Scale.nFeatureScaling*map.Scale.nObjectScaling,this.chartGroup=map.Dom.newGroup(map.Layer.objectGroup,this.szId+":chartgroup"));for(b=0;b<this.objTheme.dbRecords.length;b++)if(!this.objTheme.dbRecords[b]||this.objTheme.dbRecords[b].length<this.objTheme.dbFields.length)this.nWrongRecordLengthCount++;else if(!this.__fFilter||this.filterValues(b)){var C=[1];if("$item$"==this.szFieldsA[0])C[0]=
1;else if("$index$"==this.szFieldsA[0])C[0]=b+1;else for(f=0;f<this.szFieldsA.length;f++)q=this.objTheme.dbRecords[b][this.objTheme.nFieldIndexA[f]],q=this.valueMap?this.valueMap[String(q)]||q:q,this.__fExact?(q=this.getStringValueIndex(String(q)),this.exactCountA[q-1]++):q=this.__fScanValue?__scanValue(q):parseFloat(q),isNaN(q)||0==q&&!this.fNullIsValue||0>q&&!this.fNegativeValuePossible||(C[f]=q);C.length=this.szFieldsA.length;var y=null;this.szSizeField&&(y=this.objTheme.dbRecords[b][this.objTheme.nSizeFieldIndex],
y=this.valueMap?this.valueMap[String(y)]||__scanValue(y):__scanValue(y));var K=null;f=null;"LatLon"==this.fSelection?(K=map.Scale.getMapPositionOfLatLon(parseFloat(String(this.objTheme.dbRecords[b][this.nSelection_0]).replace(/\,/g,".")),parseFloat(String(this.objTheme.dbRecords[b][this.nSelection_1]).replace(/\,/g,"."))),c=String(K.x)+","+String(K.y)):"MultiPoint"==this.fSelection?(c=this.objTheme.dbRecords[b][this.objTheme.nFieldSelectionIndex],K=c.match(positionRegExp),K=map.Scale.getMapPositionOfLatLon(parseFloat(K[2]),
parseFloat(K[1]))):(c=this.objTheme.dbRecords[b][this.objTheme.nFieldSelectionIndex],K=this.getNodePosition(e+"::"+c));this.szFlag.match(/DUMP/)&&(shapeGroup=map.Dom.newGroup(this.chartGroup,this.szId+":"+c+":chart"),shapeGroup.fu.setMatrix([this.nChartGroupScale,0,0,this.nChartGroupScale,K.x,K.y]),map.Dom.newShape("circle",shapeGroup,0,0,map.Scale.normalX(3),"fill:blue;fill-opacity:0.2;stroke:none;"));if(K){var E=K;if(l)if(this.szFlag.match(/RECT/))K=this.szFlag.match(/FIXGRID/)?new point(Math.round((K.x+
x)/l)*l-x,Math.round((K.y+r)/l)*l-r):new point(Math.round(K.x/l)*l,Math.round(K.y/l)*l);else{if(this.szFlag.match(/PLOTY/))f=Math.round(K.y/l),h=f%2?H:0,f=new point(Math.round((K.x+h)/k)*k-h,f*l);else{f=Math.round(K.x/l);var u=f%2?H:0;f=new point(f*l,Math.round((K.y+u)/k)*k-u)}if(Math.abs(f.x-K.x)>w){h=[];var A=[],u=0==u?H:0;f.x>K.x?(h[0]=new point(f.x-l,f.y-H),h[1]=new point(f.x-l,f.y+H)):(h[0]=new point(f.x+l,f.y-H),h[1]=new point(f.x+l,f.y+H));A[0]=Math.sqrt(Math.pow(h[0].x-K.x,2)+Math.pow(h[0].y-
K.y,2));A[1]=Math.sqrt(Math.pow(h[1].x-K.x,2)+Math.pow(h[1].y-K.y,2));A[3]=Math.sqrt(Math.pow(f.x-K.x,2)+Math.pow(f.y-K.y,2));A[0]<A[3]?f=new point(Math.round(h[0].x/l)*l,Math.round((h[0].y+u)/k)*k-u):A[1]<A[3]&&(f=new point(Math.round(h[1].x/l)*l,Math.round((h[1].y+u)/k)*k-u))}K=f}h=c;c=e+"::"+String(K.x)+","+String(K.y)+","+(this.__fMultiParts?String(q):"");if(this.__fAggregate)if(this.itemA[c]){if(this.__fMultiParts)this.itemA[c].nSize+=y||1;else if(this.__fExact)f=C[0]-1,this.itemA[c].nValuesA[f]=
(this.itemA[c].nValuesA[f]||0)+(y||1),this.itemA[c].nSize+=y||1,this.nMinA[f]=Math.min(this.nMinA[f]||3E5,this.itemA[c].nValuesA[f]),this.nMaxA[f]=Math.max(this.nMaxA[f]||-3E5,this.itemA[c].nValuesA[f]);else for(f=0;f<this.szFieldsA.length;f++)this.itemA[c].nValuesA[f]+=C[f],this.szFlag.match(/MEAN/)?(this.nMinA[f]=Math.min(this.nMinA[f],C[f]),this.nMaxA[f]=Math.max(this.nMaxA[f],C[f])):(this.nMinA[f]=Math.min(this.nMinA[f],this.itemA[c].nValuesA[f]),this.nMaxA[f]=Math.max(this.nMaxA[f],this.itemA[c].nValuesA[f])),
this.itemA[c].nSize=Math.max(this.itemA[c].nSize,this.itemA[c].nValuesA[f]);this.nMin=this.nMinSize=Math.min(this.nMinSize,this.itemA[c].nSize);this.nMax=this.nMaxSize=Math.max(this.nMaxSize,this.itemA[c].nSize);this.nSumSize+=this.itemA[c].nSize;this.itemA[c].nCount++;this.itemA[c].dbIndexA.push(b);this.itemA[c].ptPosA.push(E)}else{B++;A=0;if(this.__fMultiParts)A=y||1;else if(this.__fExact)f=C[0]-1,C=D.slice(0),C[f]=y||1,this.nMinA[f]=Math.min(this.nMinA[f]||3E6,y||1),this.nMaxA[f]=Math.max(this.nMaxA[f]||
-3E6,y||1),A=0;else for(f=0;f<this.szFieldsA.length;f++)this.nMinA[f]=Math.min(this.nMinA[f],C[f]),this.nMaxA[f]=Math.max(this.nMaxA[f],C[f]),A=Math.max(A,C[f]);this.itemA[c]={nOrigValuesA:[],nValuesA:C,nValue100:1,nValueSum:0,nCount:1};this.itemA[c].szSelectionId=String(h);this.itemA[c].nSize=A||y||1;this.nMin=this.nMinSize=Math.min(this.nMinSize,this.itemA[c].nSize);this.nMax=this.nMaxSize=Math.max(this.nMaxSize,this.itemA[c].nSize);this.nSumSize+=this.itemA[c].nSize;this.itemA[c].dbIndexA=[b];
this.nCount++;this.itemA[c].ptPos=K;this.itemA[c].ptPosA=[E]}else this.itemA[c]&&(c+="*"+Math.random()),B++,this.itemA[c]={nOrigValuesA:[],nValuesA:C,nValue100:1,nValueSum:0},this.itemA[c].szSelectionId=String(h),this.itemA[c].nSize=y||this.itemA[c].nValuesA[0],this.nMin=this.nMinSize=Math.min(this.nMinSize,this.itemA[c].nSize),this.nMax=this.nMaxSize=Math.max(this.nMaxSize,this.itemA[c].nSize),this.nCount++,this.itemA[c].ptPos=K,this.itemA[c].dbIndexA=[b]}}if(this.szFlag.match(/AGGREGATE/)&&this.szFlag.match(/MEAN/))if(this.__fMultiParts)for(a in this.itemA)this.itemA[a].nSize/=
this.itemA[a].nCount;else for(a in this.itemA){for(f=0;f<this.szFieldsA.length;f++)this.itemA[a].nValuesA[f]/=this.itemA[a].nCount;this.itemA[a].nSize/=this.itemA[a].nCount}if(this.szFlag.match(/RELOCATE/))for(a in this.itemA){for(p=q=e=0;p<this.itemA[a].ptPosA.length;p++)e+=this.itemA[a].ptPosA[p].x,q+=this.itemA[a].ptPosA[p].y;this.itemA[a].ptPos={x:e/this.itemA[a].nCount,y:q/this.itemA[a].nCount}}console.log(this);return!0}};
MapTheme.prototype.loadTableFromMap=function(){var e,b,f,c={table:{fields:0,records:0},fields:[],records:[]},h=SVGDocument.getElementById(this.szThemes);if(null==h){var g=map.Tiles.getTileNodes(this.szThemes);g&&(h=g[0])}if(!h)return this.szThemes="",null;h=h.getAttributeNS(szMapNs,"info");if(null==h||""==h)return this.szThemes="",null;h=h.split("|");h.push("FeatureId");for(e in h)c.fields.push({id:h[e]}),c.table.fields++;var h=[],m=[];for(e=0;e<this.szThemesA.length;e++){this.objTheme=this.objThemesA[this.szThemesA[e]];
g=map.Layer.getLayerObj(this.szThemesA[e]);if(null==g)return alert("MapTheme error: no layer like '"+this.szThemesA[e]+"'"),!1;if(g.szFlag.match(/tiled/)){m[0]=map.Scale.canvasNode;m.length=1;this.fDataIncomplete=!map.Tiles.allTilesLoaded();break}else m[m.length]=SVGDocument.getElementById(g.szName)}g=!0;for(b=0;b<m.length;b++){f=m[b].getElementsByTagName("path");var l=m[b].getElementsByTagName("use"),q=m[b].getElementsByTagName("circle");for(e=0;e<f.length;e++)h[h.length]=f.item(e);for(e=0;e<l.length;e++)h[h.length]=
l.item(e);for(e=0;e<q.length;e++)h[h.length]=q.item(e)}if(0==h.length)for(g=!1,b=0;b<m.length;b++)for(f=m[b].getElementsByTagName("g"),e=0;e<f.length;e++)h[h.length]=f.item(e);for(e=0;e<h.length;e++)if(1==h[e].nodeType&&h[e].hasAttributeNS(szMapNs,"info")){f=g?h[e].parentNode.getAttributeNS(null,"id"):h[e].getAttributeNS(null,"id");m=-1;if(f&&0!==f.length)for(l=map.Tiles.getMasterId(f).split(":")[0],b=0;b<this.szThemesA.length;b++)l==this.szThemesA[b]&&(m=b);b=map.Tiles.getMasterId(f);!this.itemA[b]&&
0<=m&&(m=h[e].getAttributeNS(szMapNs,"info").split("|"),m.push(b.split("::")[1]),c.records.push(m),c.table.records++,this.itemA[b]=1)}this.itemA=[];return c};
MapTheme.prototype.aggregateValues=function(){if(!(this.__fAggregateOnLoad||!this.szFlag.match(/AGGREGATE/)&&!this.szFlag.match(/GROUP/)||this.szAggregationUpper&&map.Scale.nTrueMapScale*map.Scale.nZoomScale>this.nAggregationUpper||this.szAggregationLower&&map.Scale.nTrueMapScale*map.Scale.nZoomScale<this.nAggregationLower)){var e=[],b=[],f=[],c=[],h=[],g=null,m=0;this.nTopicsSkipedByZeroExclusion=0;this.nGridWidthPx&&(this.nGridWidth=g=map.Scale.getDistanceInMeter(1E3,1E3,1E3+map.Scale.normalX(this.nGridWidthPx),
1E3));this.nGridMatrix&&(g=map.Zoom.getBox(),g=map.Scale.getDistanceInMeter(1E3,1E3,1E3+g.width,1E3),this.nGridWidth=g/(this.nGridMatrix||20)/map.Scale.nZoomScale);var l=this.nGridWidth?Math.round(map.Scale.getDeltaXofDistanceInMeter(this.nGridWidth)/20)*map.Scale.nZoomScale*20:0,g=function(b){for(elem in b)return elem}(this.itemA),q="undefined",x=this.itemA[g].szSelectionId.split("::")[0],r=null,k=1.15*l,H=1.15*l/2,w=l/4;if(this.szAggregationField)for(a in this.itemA){q="undefined";g=g||a;q=this.itemA[a].szAggregation;
e[q]||(e[q]=[],c[q]=new point(0,0),b[q]=0,f[q]=0,m++);e[q][a]=this.itemA[a];e[q][a].nSize=this.itemA[a].nSize||1;e[q][a].szTitle=this.itemA[a].szTitle||q;f[q]+=e[q][a].nSize;var B=this.getNodePosition(this.itemA[a].szSelectionId);B&&(c[q].x+=B.x,c[q].y+=B.y,b[q]++)}else if(this.nGridWidth)for(a in this.itemA)if(B=this.getNodePosition(this.itemA[a].szSelectionId)){if(this.szFlag.match(/RECT/))this.szFlag.match(/FIXGRID/)?(r=map.Scale.mapCenter.x*map.Scale.nZoomScale,q=map.Scale.mapCenter.y*map.Scale.nZoomScale,
r=new point(Math.round((B.x+r)/l)*l-r,Math.round((B.y+q)/l)*l-q)):r=new point(Math.round(B.x/l)*l,Math.round(B.y/l)*l);else{if(this.szFlag.match(/PLOTY/))r=Math.round(B.y/l),q=r%2?H:0,r=new point(Math.round((B.x+q)/k)*k-q,r*l);else var r=Math.round(B.x/l),D=r%2?H:0,r=new point(r*l,Math.round((B.y+D)/k)*k-D);if(Math.abs(u-B.x)>w){var q=[],C=[],D=0==D?H:0;u>B.x?(q[0]=new point(r.x-l,r.y-H),q[1]=new point(r.x-l,r.y+H)):(q[0]=new point(r.x+l,r.y-H),q[1]=new point(r.x+l,r.y+H));C[0]=Math.sqrt(Math.pow(q[0].x-
B.x,2)+Math.pow(q[0].y-B.y,2));C[1]=Math.sqrt(Math.pow(q[1].x-B.x,2)+Math.pow(q[1].y-B.y,2));C[3]=Math.sqrt(Math.pow(r.x-B.x,2)+Math.pow(r.y-B.y,2));C[0]<C[3]?r=new point(Math.round(q[0].x/l)*l,Math.round((q[0].y+D)/k)*k-D):C[1]<C[3]&&(r=new point(Math.round(q[1].x/l)*l,Math.round((q[1].y+D)/k)*k-D))}}q=x+"::"+String(r.x)+","+String(r.y);this.themeNodesPosA[a]=r;this.themeNodesPosA[q]=r;e[q]||(e[q]=[],c[q]=new point(0,0),b[q]=0,m++);e[q][a]=this.itemA[a];e[q][a].nSize=this.itemA[a].nSize||1;c[q].x+=
B.x;c[q].y+=B.y;b[q]++}else e[q]||(e[q]=[],c[q]=new point(0,0),b[q]=0,this.fDataIncomplete=fTilesLoaded,m++),e[q][a]=this.itemA[a],e[q][a].nSize=this.itemA[a].nSize||1,b[q]++,this.fDataIncomplete=!0;else for(a in this.itemA)(B=this.getNodePosition(this.itemA[a].szSelectionId))?(q=this.itemA[a].szSelectionId,e[q]||(e[q]=[],c[q]=new point(0,0),b[q]=0,m++),e[q][a]=this.itemA[a],e[q][a].nSize=this.itemA[a].nSize||1,c[q].x+=B.x,c[q].y+=B.y,b[q]++):(e[q]||(e[q]=[],c[q]=new point(0,0),b[q]=0,this.fDataIncomplete=
fTilesLoaded,m++),e[q][a]=this.itemA[a],e[q][a].nSize=this.itemA[a].nSize||1,b[q]++,this.fDataIncomplete=!0);if(this.szFlag.match(/GROUP/))for(t in this.itemA=[],e){m=e[t];this.indexA=[];for(a in m)this.indexA.push(a);for(var b=[],y=0;y<this.indexA.length;y++)b.push({a:this.indexA[y],y:m[this.indexA[y]].nValuesA[0]});this.szFlag.match(/\|UP/)?b.sort(this.sortDownChartObjectsCompare):b.sort(this.sortUpChartObjectsCompare);for(y in b)m[b[y].a].szSelectionId=t,this.itemA[t+"*"+Math.random()]=m[b[y].a]}else{if(this.szFlag.match(/EXACT/))for(t in this.szSizeField||
(this.szSizeField="$aggregation$"),e){m=e[t];h[t]=0;D=[];for(a in m)h[t]++,D[m[a].nValuesA[0]]||(D[m[a].nValuesA[0]]={itemA:[]}),D[m[a].nValuesA[0]].itemA[a]=m[a];e[t]=[];for(y in D)for(a in m=D[y].itemA,x=null,m)null==x?(x=e[t][a]=m[a],x.nCount=1,x.dbIndexA=x.dbIndexA||[],x.nSize=x.nSize||1,x.nAlpha=x.nAlpha||1):(x.nCount+=1,x.nValue100+=m[a].nValue100,x.nSize+=m[a].nSize||1,x.nAlpha+=m[a].nAlpha||1,x.szValue=String(x.nSize),l&&!this.szAggregationField&&(!x.szTitle||3<x.nCount)&&(x.szTitle=this.formatValue(x.nCount,
0)+" "+map.Dictionary.getLocalText("items aggregated")),x.dbIndexA.push(m[a].dbIndex))}else for(t in e){m=e[t];if(!this.szFlag.match(/SUM/)&&!this.szFlag.match(/ZEROISVALUE/)){l=[];D=0;for(a in m)if(D++,m[a])for(y=0;y<m[a].nValuesA.length;y++)if(0==m[a].nOrigValuesA[y]){l[a]=a;break}if(1<D)for(a in l)delete m[a],this.nTopicsSkipedByZeroExclusion++}e[t]=[];x=null;for(a in m)if(null==x)x=e[t][a]=m[a],x.nCount=1,x.dbIndexA=x.dbIndexA||[],x.nSize=x.nSize||1,x.nAlpha=x.nAlpha||1;else{for(y=0;y<m[a].nValuesA.length;y++)x.nValuesA[y]+=
m[a].nValuesA[y]||0,x.nOrigValuesA[y]+=m[a].nOrigValuesA[y]||0;x.nCount+=1;x.nValue100+=m[a].nValue100;x.nSize+=m[a].nSize||1;x.nAlpha+=m[a].nAlpha||1;x.szValue=String(x.nSize);x.szTitle=this.formatValue(x.nCount,0)+" "+map.Dictionary.getLocalText("items aggregated");x.dbIndexA.push(m[a].dbIndex)}}if(this.szAggregationField||this.szFlag.match(/RELOCATE/)){var K=new point(0,0),E=0,y=1E6,l=0;for(t in e)y=Math.min(y,c[t].x/b[t]),E=Math.max(E,c[t].y/b[t]),K.x+=c[t].x*(f[t]||1),K.y+=c[t].y*(f[t]||1),l+=
b[t]*(f[t]||1);K.x/=l;K.y/=l;new point(y,K.y);E=new point(K.x,E)}this.nMin=3E8;this.nMax=-3E8;this.nMinSize=3E8;this.nSumSize=this.nMaxSize=0;this.nMinAlpha=3E8;this.nSumAlpha=this.nMaxAlpha=0;this.szFlag.match(/EXACT/)&&(this.nMinA=[],this.nMaxA=[],this.nSumA=[],this.nOrigMinA=[],this.nOrigMaxA=[],this.nOrigSumA=[],this.nMedianA=[],this.nMeanA=[],this.nCountA=[]);f="[";l=this.nStringToValue-1;for(y=0;y<l;y++)f+="0,";f+="]";this.itemA=[];l=0;D=Math.max(this.szRangesA?this.szRangesA.length:0,this.szExactA?
this.szExactA.length:0)-(this.szFlag.match(/EXACT/)?0:1);x=this.szFlag.match(/EXACT/)&&(this.szFlag.match(/PIE/)||this.szFlag.match(/BAR/)||this.szFlag.match(/SEQUENCE/)||this.szFlag.match(/PLOT/)||this.szFlag.match(/DOMINANT/)||this.szFlag.match(/USER/)||this.szFlag.match(/WAFFLE/));for(t in e)if(l++,"undefined"!=t){var m=e[t],u;if(x){for(a in m){u=a;break}this.itemA[u]={};eval("var nValuesA = "+f+";");this.itemA[u].szSelectionId=u;this.itemA[u].szTitle=m[u].szTitle;if(this.szAggregationField||this.szFlag.match(/RELOCATE/))this.szFlag.match(/ALIGN/)?
(this.itemA[u].szSelectionId=g,this.szFlag.match(/\|UP/)?this.themeNodesPosA[u]=new point(E.x,E.y):this.themeNodesPosA[u]=new point(K.x,K.y)):this.themeNodesPosA[u]=new point(c[t].x/b[t],c[t].y/b[t]);this.itemA[u].dbIndexA=[];k=y=0;for(a in m){nValuesA[m[a].nValuesA[0]-1]=m[a].nSize/(this.szFlag.match(/SUM/)?1:m[a].nCount);y+=m[a].nSize;k+=m[a].nCount;this.itemA[u].dbIndexA.push(m[a].dbIndex);for(db in m[a].dbIndexA)this.itemA[u].dbIndexA.push(m[a].dbIndexA[db]);delete this.itemA[u].dbIndex}this.itemA[u].nValuesA=
this.itemA[u].nOrigValuesA=nValuesA;this.itemA[u].nMinA=[];this.itemA[u].nMaxA=[];this.itemA[u].nSize=y/(this.szFlag.match(/SUM/)?1:k);this.itemA[u].nAlpha=m[a].nAlpha;this.itemA[u].szTitle=this.nGridWidth&&!this.szAggregationField&&1<h[t]?__formatValue(h[t],0)+" item(s) aggregated":this.itemA[u].szTitle||t;this.itemA[u].szValue=this.itemA[u].szTitle;this.itemA[u].szLabel=this.itemA[u].szTitle;this.nMin=this.nMinSize=Math.min(this.nMinSize,this.itemA[u].nSize);this.nMax=this.nMaxSize=Math.max(this.nMaxSize,
this.itemA[u].nSize);this.nSumSize+=y/(this.szFlag.match(/SUM/)?1:k);this.nMinAlpha=Math.min(this.nMinAlpha,this.itemA[u].nAlpha);this.nMaxAlpha=Math.max(this.nMaxAlpha,this.itemA[u].nAlpha);this.nSumAlpha+=this.itemA[u].nAlpha;if(this.szFlag.match(/AUTO100/)){for(y=nValue100=0;y<this.itemA[u].nValuesA.length;y++)nValue100+=this.itemA[u].nValuesA[y]||0;this.itemA[u].nValue100=nValue100;this.fField100=!0;for(y=0;y<this.itemA[u].nValuesA.length;y++)this.itemA[u].nValuesA[y]=this.itemA[u].nOrigValuesA[y]/
this.itemA[u].nValue100*100}if(this.szFlag.match(/EXACT/)&&(this.szFlag.match(/EXACT/)||!this.nNormalSizeValue)){if(!this.nMinA.length)for(y=0;y<this.itemA[u].nValuesA.length;y++)this.nMinA[y]=null,this.nMaxA[y]=null,this.nSumA[y]=0,this.nOrigMinA[y]=null,this.nOrigMaxA[y]=null,this.nOrigSumA[y]=0,this.nMedianA[y]=0,this.nMeanA[y]=0,this.nCountA[y]=0;for(y=0;y<this.itemA[u].nValuesA.length;y++)this.nMinA[y]=Math.min(this.nMinA[y]||this.itemA[u].nValuesA[y],this.itemA[u].nValuesA[y]),this.nMaxA[y]=
Math.max(this.nMaxA[y]||this.itemA[u].nValuesA[y],this.itemA[u].nValuesA[y]),this.nSumA[y]+=this.itemA[u].nValuesA[y],this.nOrigMinA[y]=Math.min(this.nOrigMinA[y]||this.itemA[u].nOrigValuesA[y],this.itemA[u].nOrigValuesA[y]),this.nOrigMaxA[y]=Math.max(this.nOrigMaxA[y]||this.itemA[u].nOrigValuesA[y],this.itemA[u].nOrigValuesA[y]),this.nOrigSumA[y]+=this.itemA[u].nOrigValuesA[y],this.itemA[u].nValuesA[y]&&this.nCountA[y]++}this.nCount=l*D}else for(a in m)if(m[a]){k=a;this.szAggregationField||(k=t,
this.itemA[k]&&(k=k.split("*")[0]+"*"+Math.random()));this.itemA[k]=m[a];m[a].szValue=m[a].szValue||1;this.nMinSize=Math.min(this.nMinSize,this.itemA[k].nSize);this.nMaxSize=Math.max(this.nMaxSize,this.itemA[k].nSize);this.nSumSize+=this.itemA[k].nSize;this.nMinAlpha=Math.min(this.nMinAlpha,this.itemA[k].nAlpha);this.nMaxAlpha=Math.max(this.nMaxAlpha,this.itemA[k].nAlpha);this.nSumAlpha+=this.itemA[k].nAlpha;H=this.szFlag.match(/SUM/)?1:m[a].nCount;this.itemA[k].nSize/=H;this.itemA[k].szValue/=H;
this.itemA[k].nValue100/=H;if(this.nGridWidth||this.szAggregationField)for(H=this.szFlag.match(/SUM/)||this.szFlag.match(/EXACT/)?1:m[a].nCount,this.itemA[k].szSelectionId=a,y=0;y<this.itemA[k].nValuesA.length;y++)this.itemA[k].nValuesA[y]/=H,this.itemA[k].nOrigValuesA[y]/=H,this.itemA[k].nValue100&&(this.itemA[k].nValuesA[y]=this.itemA[k].nOrigValuesA[y]/this.itemA[k].nValue100,this.szFlag.match(/FRACTION/)||(this.itemA[k].nValuesA[y]*=this.szFlag.match(/PERMILLE/)?1E3:100),this.szFlag.match(/INVERT/)&&
(this.itemA[k].nValuesA[y]=100-this.itemA[k].nValuesA[y])),this.nMin=Math.min(this.itemA[k].nValuesA[y]||3E8,this.nMin||3E8),this.nMax=Math.max(this.itemA[k].nValuesA[y]||-3E8,this.nMax||-3E8);else this.nMin=Math.min(this.itemA[k].nSize,this.nMin||3E8),this.nMax=Math.max(this.itemA[k].nSize,this.nMax||-3E8);if(this.szFlag.match(/AUTO100/)){for(y=nValue100=0;y<this.itemA[k].nValuesA.length;y++)nValue100+=this.itemA[k].nValuesA[y]||0;this.itemA[k].nValue100=nValue100;this.fField100=!0;for(y=0;y<this.itemA[k].nValuesA.length;y++)this.itemA[k].nValuesA[y]=
this.itemA[k].nOrigValuesA[y]/this.itemA[k].nValue100*100}if(this.szAggregationField||this.szFlag.match(/RELOCATE/))this.szFlag.match(/ALIGN/)?this.szFlag.match(/\|UP/)?this.themeNodesPosA[k]=new point(E.x,E.y):this.themeNodesPosA[k]=new point(K.x,K.y):(this.themeNodesPosA[a]=new point(c[t].x/b[t],c[t].y/b[t]),this.themeNodesPosA[k]=new point(c[t].x/b[t],c[t].y/b[t]))}}if(this.szMinAggregation){e=H=0;for(a in this.itemA)e+=this.itemA[a].nCount,H++;e/=H;for(a in this.itemA)this.itemA[a].nCount&&this.itemA[a].nCount<
(this.nMinAggregation||e/2)&&delete this.itemA[a];this.nMax=this.nMin=null;for(a in this.itemA)for(y=0;y<this.itemA[a].nValuesA.length;y++)this.nMin=Math.min(this.itemA[a].nValuesA[y]||3E8,this.nMin||3E8),this.nMax=Math.max(this.itemA[a].nValuesA[y]||-3E8,this.nMax||-3E8)}this.fSorted=!0}}};
MapTheme.prototype.distributeValues=function(){if(0==this.nCount)return!1;if(this.szFlag.match(/OUTLIER/)){var e=this.szFieldsA.length;this.getMeanMedianQuantile();for(var b=0;b<e;b++){var f=[],c;for(c in this.itemA)this.itemA[c].nValuesA[b]&&f.push(this.itemA[c].nValuesA[b]);this.nDeviationA[b]=this.parent.getDeviationOfArray(f)}for(b=0;b<e;b++)for(c in this.itemA)Math.abs(this.itemA[c].nValuesA[b]-this.nMeanA[b])>3*this.nDeviationA[b]?this.szFlag.match(/NOOUTLIER/)&&delete this.itemA[c]:this.szFlag.match(/NOOUTLIER/)||
delete this.itemA[c]}(this.szFlag.match(/AGGREGATE/)||this.szFlag.match(/GROUP/))&&(!this.szAggregationUpper||map.Scale.nTrueMapScale*map.Scale.nZoomScale<=this.nAggregationUpper)&&(!this.szAggregationLower||map.Scale.nTrueMapScale*map.Scale.nZoomScale>=this.nAggregationLower)&&this.aggregateValues();"$aggregation$"==this.szSizeField&&(this.szSizeField=null);if(this.szFlag.match(/EXACT/)&&(!this.szExactA||!this.szExactA.length)&&(this.szExactA=this.szExactA||[],this.nStringToValueA))for(c in this.nStringToValueA)this.szExactA.push(this.nStringToValueA[c]);
!this.szFlag.match(/EXACT/)||this.szLabelA&&this.szLabelA.length||!this.szValuesA||(this.szLabelA=this.szValuesA);this.origColorScheme||(this.origColorScheme=this.colorScheme=this.defaultColorScheme);if(isNaN(Number(this.origColorScheme[0])))this.colorScheme=this.origColorScheme;else{!this.szFlag.match(/SEQUENCE/)&&this.szFieldsA.length>this.origColorScheme[0]&&(this.origColorScheme[0]=this.szFieldsA.length);this.szFlag.match(/EXACT/)&&(this.origColorScheme[0]=this.szExactA.length);if(this.szColorField){this.colorFieldA=
[];this.colorClassA=[];this.colorClassUsedA=[];for(c in this.itemA)this.colorFieldA[this.itemA[c].szColor]=!0;e=0;for(c in this.colorFieldA)e++;this.origColorScheme[0]=e}try{this.colorScheme=ColorScheme.createColorScheme(this.origColorScheme[1],this.origColorScheme[2],this.origColorScheme[0],this.origColorScheme[3],this.origColorScheme[4])}catch(h){this.colorScheme=this.defaultColorScheme}if(this.szColorField){b=0;for(c in this.colorFieldA)this.colorClassA[c]=b,this.colorFieldA[c]=this.colorScheme[b++];
for(c in this.itemA)this.itemA[c].nClass=this.colorClassA[this.itemA[c].szColor],this.itemA[c].szColor=this.colorFieldA[this.itemA[c].szColor]}}if(this.colorScheme[0].match(/user/i))try{HTMLWindow.ixmaps.htmlgui_colorScheme(this)}catch(g){}if(this.szFlag.match(/DOMINANT/))for(;this.colorScheme.length<this.szFieldsA.length;)this.colorScheme[this.colorScheme.length]="#dddddd";if(this.szFlag.match(/NORMALIZE/)&&this.nMax){for(c in this.itemA)this.itemA[c].nValuesA[0]/=this.nMax;this.nMin/=this.nMax;
this.nMax/=this.nMax}if(this.szFlag.match(/INVERTSIZE/)&&this.szSizeField){for(c in this.itemA)this.itemA[c].nSize=this.nMaxSize-this.itemA[c].nSize;this.nNormalSizeValue=this.nNormalSizeValue||this.nMaxSize}this.szFlag.match(/EXACT/)||this.szFlag.match(/SEQUENCE/)||this.getMeanMedianQuantile();var e=this.colorScheme.length,b=this.nMax-this.nMin,f=this.nMin,m=this.nMax;null==this.nRangeCenterValue||isNaN(this.nRangeCenterValue)||(b=Math.max(Math.abs(this.nRangeCenterValue-f),Math.abs(m-this.nRangeCenterValue)),
f=this.nRangeCenterValue-b,m=this.nRangeCenterValue+b,b=m-f);if(this.szFlag.match(/INTEGER/))e>b?e=b:e>b/2?e=Math.floor(b/2):b+=e-b%e;else{var l=1;for(this.szField100&&(l=.01);b>1E3*l;)l*=10;1<l?(f=Math.floor(f/l)*l,m=Math.ceil(m/l)*l):m+=m/1E5;b=m-f}if((this.nRangesA=this.szRangesA||this.szExactA)&&this.nRangesA.length){e=this.nRangesA.length-(this.szFlag.match(/EXACT/)?0:1);if(this.szSymbolsA&&this.szSymbolsA.length)for(;this.szSymbolsA.length<e;)this.szSymbolsA[this.szSymbolsA.length]=this.szSymbolsA[this.szSymbolsA.length-
1];if(this.colorScheme&&this.colorScheme.length)for(;this.colorScheme.length<e;)this.colorScheme[this.colorScheme.length]="#dddddd";this.partsA=[];for(b=0;b<e;b++)f=Number(this.nRangesA[b]),m=Number(this.nRangesA[b+(this.szFlag.match(/EXACT/)?0:1)])+1E-9,this.partsA[this.partsA.length]={min:f,max:m,color:this.colorScheme[b],nCount:0,nSum:0};if(this.szFlag.match(/EXACT/)&&this.exactCountA)for(b=0;b<e;b++)this.partsA[b].nCount=this.exactCountA[b];if(this.szFlag.match(/PLOTVAR/)||this.szFlag.match(/DOMINANT/))for(this.getMeanMedianQuantile(),
b=0;b<e;b++){f=[];for(c in this.itemA)this.itemA[c].nValuesA[b]&&f.push(this.itemA[c].nValuesA[b]);this.nDeviationA[b]=this.parent.getDeviationOfArray(f);this.szDominantFilter=this.szDominantFilter||"min";this.nDominantDFilter=this.nDominantDFilter||0;this.szDominantFilter.match(/min/)?this.nFilterA[b]=this.nMinA[b]+(this.nMaxA[b]-this.nMinA[b])/100*this.nDominantDFilter:this.szDominantFilter.match(/max/)?this.nFilterA[b]=this.nMinA[b]+(this.nMaxA[b]-this.nMinA[b])/100*this.nDominantDFilter:this.szDominantFilter.match(/mean/)?
this.nFilterA[b]=this.nMeanA[b]+(this.nMaxA[b]-this.nMeanA[b])/100*this.nDominantDFilter:this.szDominantFilter.match(/median/)&&(this.nFilterA[b]=this.nMedianA[b]+(this.nMaxA[b]-this.nMedianA[b])/100*this.nDominantDFilter)}}else{var q=b/e;q>l&&(q=Math.floor(q/l)*l);this.nMin==this.nMax&&(e=1);this.partsA=[];for(b=0;b<e;b++)this.partsA[this.partsA.length]={min:f+b*q,max:f+(b+1)*q,color:this.colorScheme[b],nCount:0,nSum:0};this.partsA[this.partsA.length-1].max=m;if(this.szFlag.match(/QUANTILE/)){this.getMeanMedianQuantile();
l=Math.round(this.quantileA[0].length/e);for(b=0;b<this.partsA.length;b++)this.partsA[b].min=this.quantileA[0][b*l],this.partsA[b].max=this.quantileA[0][(b+1)*l];this.partsA[this.partsA.length-1].max=m}if(this.szFlag.match(/LOG/)){f=Math.log(this.nMin?this.nMin:1);b=Math.log(this.nMax?this.nMax:1)-Math.log(this.nMin?this.nMin:1);q=b/e;this.partsA=[];for(b=0;b<e;b++)this.partsA[this.partsA.length]={min:Math.exp(f+b*q),max:Math.exp(f+(b+1)*q),color:this.colorScheme[b],nCount:0,nSum:0};this.partsA[this.partsA.length-
1].max=this.nMax}if(this.szFlag.match(/DOMINANT/)||this.szFlag.match(/OFFSETMEAN/)||this.szFlag.match(/OFFSETMEDIAN/)||this.szFlag.match(/DEVIATION/)||this.szFlag.match(/PLOTVAR/)){this.getMeanMedianQuantile();for(b=0;b<this.szFieldsA.length;b++){e=[];for(c in this.itemA)this.itemA[c].nValuesA[b]&&e.push(this.itemA[c].nValuesA[b]);"$item$"!=this.szFieldsA[b]&&e.sort(this.sortUp);this.nMedianA[b]=e[Math.round(e.length/2)];this.nSum100?this.szFlag.match(/DIFFERENCE/)?this.nMeanA[b]=this.nSumA[b]/this.nCount:
(this.nMeanA[b]=this.nOrigSumA[b]/this.nSum100,this.szFlag.match(/FRACTION/)?this.nMeanA[b]*=this.nFractionScale||1:this.szFlag.match(/PERMILLE/)?this.nMeanA[b]*=1E3:(this.nMeanA[b]*=100,this.szFlag.match(/RELATIVE/)?this.nMeanA[b]-=100:this.szFlag.match(/INVERT/)&&(this.nMeanA[b]=100-this.nMeanA[b]))):this.nMeanA[b]=this.nSumA[b]/this.nCount}for(b=0;b<this.partsA.length;b++)this.szDominantFilter=this.szDominantFilter||"min",this.nDominantDFilter=this.nDominantDFilter||0,this.szDominantFilter.match(/min/)?
this.nFilterA[b]=this.nMinA[b]+(this.nMaxA[b]-this.nMinA[b])/100*this.nDominantDFilter:this.szDominantFilter.match(/max/)?this.nFilterA[b]=this.nMinA[b]+(this.nMaxA[b]-this.nMinA[b])/100*this.nDominantDFilter:this.szDominantFilter.match(/mean/)?this.nFilterA[b]=this.nMeanA[b]+(this.nMaxA[b]-this.nMeanA[b])/100*this.nDominantDFilter:this.szDominantFilter.match(/median/)&&(this.nFilterA[b]=this.nMedianA[b]+(this.nMaxA[b]-this.nMedianA[b])/100*this.nDominantDFilter);if(this.szFlag.match(/DEVIATION/)||
this.szFlag.match(/PLOTVAR/))for(b=0;b<this.szFieldsA.length;b++){f=[];for(c in this.itemA)this.itemA[c].nValuesA[b]&&f.push(this.itemA[c].nValuesA[b]);this.nDeviationA[b]=this.parent.getDeviationOfArray(f)}}}this.partsA[this.partsA.length-1].max+=.001;return!0};MapTheme.prototype.sortUp=function(e,b){return e-b};MapTheme.prototype.sortIndexUp=function(e,b){return e.value-b.value};MapTheme.prototype.sortIndexDown=function(e,b){return b.value-e.value};
MapTheme.prototype.sortPartsUp=function(e,b){return e.nCount-b.nCount};MapTheme.prototype.sortMeanUp=function(e,b){return e.mean-b.mean};MapTheme.prototype.shuffleArray=function(e,b){for(var f=e.length-1;0<f;f--){var c=Math.floor((b&&b[f]?b[f]:Math.random())*f+1),h=e[f];e[f]=e[c];e[c]=h}};MapTheme.prototype.getRandomNumberArray=function(e){for(var b=[],f=0;f<e;f++)b.push(Math.random());return b};
MapTheme.prototype.paintMap=function(e){this.beginDraw();this.mapSleep&&(this.mapSleep.checkSleepMessage="painting map");var b=0,f=0,c=0,h=0,g=0,m=0,l="",q="";map.Dictionary.getLocalText("of mean");map.Dictionary.getLocalText("of median");var x=!1,r=0,k=c=l=0,h=null;this.fillOpacity=this.fillOpacity?this.fillOpacity:this.nOpacity;this.szStyle="fill-opacity:"+String(this.fillOpacity?this.fillOpacity:fTransparentMap?.6:1);this.autoOpacity&&(this.szStyle="fill-opacity:"+String(Math.max(.3,Math.min(1,
.3+.7/Math.max(1,Math.log(map.Zoom.nZoom))))));this.szShapeType.match(/line/)&&(this.szStyle=this.fillOpacity?"stroke-opacity:"+this.fillOpacity+";":"stroke-opacity:1");if(!e||0==e){e=0;this.indexA=[];for(k in this.itemA)this.indexA[this.indexA.length]=k,this.itemA[k].todo=!0;this.nDoneCount=0}for(;e<this.indexA.length;e++){if(this.mapSleep&&(this.mapSleep.nDoneCount=this.nDoneCount,this.mapSleep.checkSleep(e,10))){this.fContinue=!0;this.continueIndex=e;this.szItemFilter&&this.szItemFilter.length&&
this.filterItems(this.szItemFilter,this.itemFilterOpt);null!=this.markedClass&&this.markClass(this.markedClass,1);return}k=this.indexA[e];this.nDoneCount++;x=!1;r=0;if(this.szFlag.match(/COMPOSECOLOR/))__maptheme_getComposedColor(this.itemA[k].nValuesA,this.colorScheme);else if(this.szFlag.match(/DOMINANT/)){x=!0;nIndex=-1;for(l=0;l<this.itemA[k].nValuesA.length;l++)b=this.itemA[k].nValuesA[l],f=100/this.nMeanA[l]*b,c=100/this.nMedianA[l]*b,h=(b-this.nMeanA[l])/this.nDeviationA[l],g=b,this.szFlag.match(/PERCENTOFMEAN/)&&
(g=f),this.szFlag.match(/PERCENTOFMEDIAN/)&&(g=c),this.szFlag.match(/DEVIATION/)&&(g=h),b>this.nFilterA[l]&&g>r&&(this.itemA[k].nClass=l,r=g,nIndex=l);if(0<=nIndex){this.itemA[k].nDominant=nIndex;b=this.itemA[k].nValuesA[nIndex];l=" "+this.szFieldsA[nIndex]+" ";this.szLabelA&&this.szLabelA[nIndex]&&(l=" "+this.szLabelA[nIndex]+" ");if(this.szFlag.match(/PERCENTOFMEAN/)||this.szFlag.match(/DEVIATION/))q=map.Dictionary.getLocalText(" ( mean: ")+this.formatValue(this.nMeanA[nIndex],1)+this.szUnit+")";
this.szFlag.match(/PERCENTOFMEDIAN/)&&(q=map.Dictionary.getLocalText(" ( median: ")+this.formatValue(this.nMedianA[nIndex],1)+this.szUnit+")");this.itemA[k].nValue=this.itemA[k].nValuesA[nIndex];this.itemA[k].szLabel=l;this.itemA[k].szColor=this.colorScheme[nIndex];this.itemA[k].nClass=nIndex;h=this.getItemNodes(k);for(c=0;c<h.length;c++)if(g=this.paintShape(h[c],this.colorScheme[nIndex],this.itemA[k].nValue,nIndex),g.setAttributeNS(szMapNs,"tooltip",this.formatValue(b,2)+this.szUnit+l+q),this.szFlag.match(/DOPACITY/)){var H=
r=0,r=isNaN(this.itemA[k].nValuesA[nIndex])?0:this.itemA[k].nValuesA[nIndex],H=isNaN(this.nMaxA[nIndex])?0:this.nMaxA[nIndex];this.szAlphaField?(m=0,"undefined"!=typeof this.itemA[k].nAlpha&&(m=1/(this.nDopacityPow||1),m=(this.nDopacityScale||1)/Math.pow(this.nMaxAlpha,m)*Math.pow(this.itemA[k].nAlpha,m))):this.szFlag.match(/DOPACITYLOGMEAN/)?m=Math.log((this.nDopacityScale||1)*(f-100))/Math.log(100):this.szFlag.match(/DOPACITYPOWMEAN/)?(m=1/(this.nDopacityPow||1),m=Math.pow((this.nDopacityScale||
1)*(f-100),m)/Math.pow(100,m)):this.szFlag.match(/DOPACITYMEAN/)?(m=1/(this.nDopacityPow||1),m=Math.pow((this.nDopacityScale||1)*(f-100),m)/Math.pow(100,m)):this.szFlag.match(/DOPACITYLOGMAX/)?m=Math.log(r)/Math.log(H):this.szFlag.match(/DOPACITYPOWMAX/)?(m=1/(this.nDopacityPow||1),m=(this.nDopacityScale||1)*Math.pow(r,m)/Math.pow(H,m)):this.szFlag.match(/DOPACITYMAX/)?(m=1/(this.nDopacityPow||1),m=(this.nDopacityScale||1)*Math.pow(r,m)/Math.pow(H,m)):m=Math.log((this.nDopacityScale||1)*r)/Math.log(H);
m=1E-4>m?0:m;m=Math.min(this.nOpacity||.9,m);this.autoOpacity&&(m*=Math.max(.3,Math.min(1,.3+.7/Math.max(1,Math.log(map.Zoom.nZoom)))));g.style.setProperty("fill-opacity",String(m),"")}this.partsA[nIndex].nCount++}else for(h=this.getItemNodes(k),c=0;c<h.length;c++)this.unPaintShape(h[c]),h[c].removeAttributeNS(szMapNs,"tooltip")}else for(b=this.szFlag.match(/CLIP/)&&this.nClipFrames?this.nClipFrames==this.itemA[k].nValuesA.length?Number(this.itemA[k].nValuesA[this.nActualFrame]):this.itemA[k].nValuesA[0]*
(this.nClipFrames-1-this.nActualFrame)/(this.nClipFrames-1)+this.itemA[k].nValuesA[1]*this.nActualFrame/(this.nClipFrames-1):this.itemA[k].nValuesA[0],l=0;l<this.partsA.length;l++)if(b<this.partsA[l].max){this.itemA[k].nValue=b;this.itemA[k].szColor=this.partsA[l].color;this.itemA[k].nClass=l;if(this.itemA[k].todo){h=this.getItemNodes(k);for(c=0;c<h.length;c++)g=this.paintShape(h[c],this.partsA[l].color,b,l),this.szLabelA&&this.szLabelA[l]&&this.szFlag.match(/EXACT/)?g.setAttributeNS(szMapNs,"tooltip",
this.szLabelA[l]):g.setAttributeNS(szMapNs,"tooltip",this.formatValue(b,2)+this.szUnit),this.szFlag.match(/DOPACITY/)&&(this.szAlphaField?(m=0,"undefined"!=typeof this.itemA[k].nAlpha&&(m=1/(this.nDopacityPow||1),m=(this.nDopacityScale||1)/Math.pow(this.nMaxAlpha,m)*Math.pow(this.itemA[k].nAlpha,m))):0>this.nMin&&0<this.nMax?this.szFlag.match(/DOPACITYMAX/)?(m=1/(this.nDopacityPow||1),m=Math.pow(Math.abs(b),m)/Math.pow(this.nMedianA[0]-this.nMin,m)*(this.fillOpacity||1)*(this.nDopacityScale||1)):
m=this.szFlag.match(/DOPACITYLOG/)?Math.log(Math.abs(b))/Math.log(this.nMedianA[0]-this.nMin)*.5*(this.fillOpacity||1)*(this.nDopacityScale||1):Math.abs(b)/(this.nMedianA[0]-this.nMin)*.5*(this.fillOpacity||1)*(this.nDopacityScale||1):this.szFlag.match(/BIPOLAR/)||this.szFlag.match(/DOPACITYMINMAX/)?this.szFlag.match(/DOPACITYMAX/)?(m=1/(this.nDopacityPow||1),m=b>=this.nMeanA[0]?Math.pow(Math.abs(b-this.nMeanA[0]),m)/Math.pow(Math.abs(this.nMax-this.nMeanA[0]),m)*(this.fillOpacity||1)*(this.nDopacityScale||
1):Math.pow(Math.abs(this.nMeanA[0]-b),m)/Math.pow(Math.abs(this.nMeanA[0]-this.nMin),m)*(this.fillOpacity||1)*(this.nDopacityScale||1)):this.szFlag.match(/DOPACITYLOG/)?m=b>=this.nMedianA[0]?Math.log(Math.abs(b-this.nMedianA[0]))/Math.log(this.nMax-this.nMedianA[0])*(this.fillOpacity||1)*(this.nDopacityScale||1):Math.log(Math.abs(b-this.nMedianA[0]))/Math.log(this.nMedianA[0]-this.nMin)*(this.fillOpacity||1)*(this.nDopacityScale||1):(m=1/(this.nDopacityPow||1),m=b>=this.nMedianA[0]?Math.pow(Math.abs(b-
this.nMedianA[0]),m)/Math.pow(this.nMax-this.nMedianA[0],m)*(this.fillOpacity||1)*(this.nDopacityScale||1):Math.pow(Math.abs(b-this.nMedianA[0]),m)/Math.pow(this.nMedianA[0]-this.nMin,m)*(this.fillOpacity||1)*(this.nDopacityScale||1)):this.szFlag.match(/DOPACITYMIN/)?(m=1/(this.nDopacityPow||1),m=Math.pow(this.nMax-b,m)/Math.pow(this.nMax-this.nMin,m)*(this.fillOpacity||1)*(this.nDopacityScale||1)):this.szFlag.match(/DOPACITYMAX/)?(m=1/(this.nDopacityPow||1),m=Math.pow(b-this.nMin,m)/Math.pow(this.nMax-
this.nMin,m)*(this.fillOpacity||1)*(this.nDopacityScale||1)):this.szFlag.match(/DOPACITYLOG/)?m=Math.log(b-this.nMin)/Math.log(this.nMedianA[0]-this.nMin)*.5*(this.fillOpacity||1)*(this.nDopacityScale||1):this.szFlag.match(/DOPACITY/)&&(m=(b-this.nMin)/(this.nMedianA[0]-this.nMin)*.5*(this.fillOpacity||1)*(this.nDopacityScale||1)),m=1E-4>m?0:m,m=Math.min(this.nOpacity||.9,m),this.autoOpacity&&(m*=Math.max(.3,Math.min(1,.3+.7/Math.max(1,Math.log(map.Zoom.nZoom))))),g.style.setProperty("fill-opacity",
String(m),""));this.itemA[k].todo=!1}this.partsA[l].nCount++;this.partsA[l].nSum+=b;x=!0;break}if(!x)for(this.itemA[k].szColor=this.szNoDataColor?this.szNoDataColor:"white",h=this.getItemNodes(k),c=0;c<h.length;c++)g=this.paintShape(h[c],this.szNoDataColor?this.szNoDataColor:"white",-1,-1),g.setAttributeNS(szMapNs,"tooltip","no value"),this.szFlag.match(/DOPACITY/)&&g.style.setProperty("fill-opacity","0",""),this.nNoData++}this.isVisible=!0;this.realizeDone();this.fShowProgressBar=!1;this.showInfo();
this.endDraw();this.szItemFilter&&this.szItemFilter.length&&this.filterItems(this.szItemFilter,this.itemFilterOpt);null!=this.markedClass&&this.markClass(this.markedClass,1);this.szFlag.match(/CLIP/)?this.nClipFrames==this.itemA[k].nValuesA.length?this.szXaxisA&&this.szXaxisA[this.nActualFrame]?displayMessage(this.szXaxisA[this.nActualFrame],3E3,"big"):this.szLabelA&&this.szLabelA[this.nActualFrame]&&displayMessage(this.szLabelA[this.nActualFrame],3E3,"big"):(b=this.szXaxisA||this.szLabelA)&&(0==
this.nActualFrame?displayMessage(b[0],3E3,"big"):this.nActualFrame==this.nClipFrames-1?displayMessage(b[1],3E3,"big"):displayMessage(" ... ",3E3,"big")):this.ErrorMessage?(displayMessage(this.ErrorMessage,1E4,"notify"),this.ErrorMessage=null):clearMessage();this.szFlag.match(/VALUES/)&&(!this.szValueUpper||map.Scale.nTrueMapScale*map.Scale.nZoomScale<=this.nValueUpper)?(this.mapSleep&&this.mapSleep.initCheckSleep(25),this.fContinue=this.fMakeLabel=!0,this.nActualFrame=this.nMissingPositionCount=this.nMissingRangeCount=
this.nZeroValueCount=this.nRealizedCount=this.nSkipCount=this.nDoneCount=this.continueIndex=0,setTimeout("map.Themes.continueExecute()",250)):this.unlabelMap()};
MapTheme.prototype.unpaintMap=function(){if(this.szFlag.match(/CHART/)){if(this.chartGroup){if(0==this.chartGroup.childNodes.length&&this.itemA){var e=null;for(a in this.itemA)(e=SVGDocument.getElementById(this.szId+":"+a+":chartgroup"))&&e.parentNode.removeChild(e)}e=this.chartGroup.getAttributeNS(null,"id");map.Dom.removeElementById(e);this.chartGroup=null}}else{this.beginDraw();for(e=0;e<this.paintedShapeNodesA.length;e++)this.unPaintShape(this.paintedShapeNodesA[e]),this.paintedShapeNodesA[e].removeAttributeNS(szMapNs,
"tooltip");this.paintedShapeNodesA.length=0;this.unlabelMap();this.endDraw();this.isVisible=!1;this.checkVisible();setTimeout("map.Layer.adaptLabel(null)",10)}};
MapTheme.prototype.paintShape=function(e,b,f,c){this.paintedShapeNodesA.push(e);switch(this.szShapeType){case "line":e.setAttributeNS(null,"style","stroke:"+b+";"+this.szStyle);break;case "line+buffer":var h=e.getAttributeNS(null,"id");if(!h.match(":paint")){var g=SVGDocument.getElementById(h+":paint");g||(g=e.cloneNode(1E3),e.parentNode.insertBefore(g,e),g.setAttributeNS(null,"id",h+":paint"));e=g}h=4;if(this.nBufferSize)if(this.nBufferSize.match(/\$value\$/)){f=this.nBufferSize.split("$value$");
h="";for(g=0;g<f.length;g++)h+=f[g],g<f.length-1&&(h+="nValue");h=eval(h)}else h=this.nBufferSize.match(/value/)?1E3<100/(this.nMin+1E-9)*(this.nMax-this.nMin)?6+Math.log(f/this.nMax):10*f/(this.nMax-this.nMin):this.nBufferSize;h*=Math.log(1+1/__featureScaling_lastScale);e.setAttributeNS(null,"style","stroke:"+b+";stroke-width:"+map.Scale.normalX(h)*map.Scale.nZoomScale+";"+this.szStyle+";stroke-linecap:butt;");break;default:e.setAttributeNS(null,"style","fill:"+b+";"+this.szStyle)}e.setAttributeNS(szMapNs,
"class",c);return e};MapTheme.prototype.unPaintShape=function(e){if("line+buffer"==this.szShapeType){var b=e.getAttributeNS(null,"id");(b=SVGDocument.getElementById(b+":paint"))&&b.parentNode.removeChild(b)}e.removeAttributeNS(null,"style");e.removeAttributeNS(szMapNs,"class")};
MapTheme.prototype.zoomToClass=function(e,b){var f=0;if(this.szFlag.match(/DOMINANT/))for(a in this.itemA)this.itemA[a].nClass==e&&f++;else f=this.partsA[e].nCount;if(0==f)displayMessage("No members !");else{var c=null;if(this.szFlag.match(/CHART/))for(var h=this.chartGroup.childNodes,f=0;f<h.length;f++){var g=h.item(f);if(null==g.getAttributeNS(szMapNs,"class"))for(var g=g.firstChild.childNodes,m=0;m<g.length;m++)g.item(m).getAttributeNS(szMapNs,"class");else g.getAttributeNS(szMapNs,"class")}else if(this.szFlag.match(/DOMINANT/))for(a in this.itemA)if(this.itemA[a].nClass==
e&&"highlight"==this.evidenceMode)for(c=this.getItemNodes(a),f=0;f<c.length;f++);else{if(this.itemA[a].nClass!=e&&"highlight"!=this.evidenceMode)for(c=this.getItemNodes(a),f=0;f<c.length;f++);}else{for(var h=new point(1E5,1E5),g=new point(-1E5,-1E5),m=this.partsA[e].min,l=this.partsA[e].max,f=1;f<b;f++)m=Math.min(m,this.partsA[e+f].min),l=Math.max(l,this.partsA[e+f].max);this.szFlag.match(/EXACT/)&&(m++,l++);for(a in this.itemA)if(this.itemA[a].nValuesA[0]>m&&this.itemA[a].nValuesA[0]<l)for(c=this.getItemNodes(a),
f=0;f<c.length;f++){bBox=map.Dom.getBox(c[f]);if(0==bBox.width||0==bBox.height){var q=getMatrix(c[f]);bBox.x+=q[4];bBox.y+=q[5];bBox.width=map.Scale.viewBox.width/20;bBox.height=map.Scale.viewBox.height/20;bBox.x-=bBox.width/2;bBox.y-=bBox.height/2}q=map.Scale.getMapOffset(c[f]);bBox.x+=q.x;bBox.y+=q.y;h.x=Math.min(h.x,bBox.x);h.y=Math.min(h.y,bBox.y);g.x=Math.max(g.x,bBox.x+bBox.width);g.y=Math.max(g.y,bBox.y+bBox.height)}f=new box(h.x,h.y,g.x-h.x,g.y-h.y);f.scale(1.2);f=map.Zoom.clipArea(f);map.Zoom.setNewArea(f)}}};
MapTheme.prototype.markClass=function(e,b){if(0!=this.fMarkEnable)if(map.Themes.enableSubThemes&&this.szFields.match(/\|/)&&this.szFlag.match(/DOMINANT/)&&!this.szFlag.match(/CHART/))this.createSubTheme(e);else if(isNaN(e))displayMessage("no class!");else{var f=this.szItemFilter&&this.szItemFilter.length;if(!this.szFlag.match(/CHART/)||f)this.fUnmarkEnable=!0,this.unmarkClass(),this.fUnmarkEnable=!1;if(0!=this.fMarkEnable){var c=0;if(this.szFlag.match(/DOMINANT/)&&!this.szFlag.match(/CHART/))for(a in this.itemA)this.itemA[a].nClass==
e&&c++;else c=1==this.partsA.length&&this.szFlag.match(/DOPACITY/)?99:this.partsA[e].nCount;if(500<c&&"highlight"==this.evidenceMode)displayMessage("Sorry ! to many members");else if(0==c)displayMessage("No members !");else if(clearMessage(),highLightList.removeAll(),c=null,this.szFlag.match(/CHART/)){for(var h=this.chartGroup.childNodes,g=[],c=0;c<h.length;c++){var m=h.item(c);if(null==m.getAttributeNS(szMapNs,"class"))for(var l=m.getElementsByTagName("g"),q=0;q<l.length;q++)for(var x=l.item(q).childNodes,
r=0;r<x.length;r++){var k=x.item(r);if(k.getAttributeNS&&k.getAttributeNS(szMapNs,"class")){if(this.szFlag.match(/SEQUENCE/)&&!this.szFlag.match(/PLOT/)&&"isolate_gray"!=this.evidenceMode){var H=k.getAttributeNS(null,"transform");H&&H.length&&(k.setAttributeNS(szMapNs,"orig-transform",H),k.setAttributeNS(null,"transform",""))}H=Number(k.getAttributeNS(szMapNs,"class"));this.szFlag.match(/BAR/)&&this.szFlag.match(/3D/)&&!this.szFlag.match(/STACKED/)&&(1<this.szFieldsA.length||this.szFlag.match(/AGGREGATE/)&&
this.szFlag.match(/EXACT/))?1==this.markedClasses[H]?(k.setAttributeNS(null,"transform","matrix(1 0 0 1 -10 6.6)"),k.style.setProperty("fill-opacity","1","")):(k.setAttributeNS(null,"transform","matrix(1 0 0 1 0 0)"),k.style.setProperty("fill-opacity","0.85","")):1==this.markedClasses[H]?f||(k.style.setProperty("display","inline",""),(H=k.getAttributeNS(szMapNs,"fill"))&&k.style.setProperty("fill",H,""),(H=k.getAttributeNS(szMapNs,"stroke"))&&k.style.setProperty("stroke",H,""),(H=k.getAttributeNS(szMapNs,
"fill-opacity"))?k.style.setProperty("fill-opacity",H,""):""==H&&k.style.setProperty("fill-opacity","1",""),g.push(m)):"isolate_gray"==this.evidenceMode?(k.getAttributeNS(szMapNs,"fill")||(k.setAttributeNS(szMapNs,"fill",k.style.getPropertyValue("fill")),k.setAttributeNS(szMapNs,"stroke",k.style.getPropertyValue("stroke")),k.setAttributeNS(szMapNs,"fill-opacity",k.style.getPropertyValue("fill-opacity"))),k.style.setProperty("fill","#bbbbbb",""),"none"!=k.style.getPropertyValue("stroke")&&k.style.setProperty("stroke",
"#888888",""),H=k.getAttributeNS(szMapNs,"fill-opacity"),this.szFlag.match(/SEQUENCE/)?(k.style.setProperty("fill-opacity","0",""),k.style.setProperty("stroke-opacity",String(.9*H),""),k.style.setProperty("stroke-width","20","")):k.style.setProperty("fill-opacity",String(.5*H),"")):k.style.setProperty("display","none","")}}else H=Number(m.getAttributeNS(szMapNs,"class")),1==this.markedClasses[H]?f||(m.style.setProperty("display","inline",""),(H=m.getAttributeNS(szMapNs,"fill"))&&m.style.setProperty("fill",
H,""),g.push(m)):"isolate_gray"==this.evidenceMode?(m.setAttributeNS(szMapNs,"fill",k.style.getPropertyValue("fill")),m.style.setProperty("fill","#bbbbbb",""),m.setAttributeNS(szMapNs,"stroke",k.style.getPropertyValue("fill")),m.style.setProperty("stroke","#888888",""),m.setAttributeNS(szMapNs,"fill-opacity",k.style.getPropertyValue("fill-opacity")),m.style.setProperty("fill-opacity","0.05","")):m.style.setProperty("display","none","")}g.forEach(function(b){b.parentNode.appendChild(b)})}else{this.beginDraw();
if(this.szFlag.match(/DOMINANT/))for(a in this.itemA)if(this.itemA[a].nClass==e&&"highlight"==this.evidenceMode)for(c=this.getItemNodes(a),f=0;f<c.length;f++)highLightList.addItem(c[f]);else{if(this.itemA[a].nClass!=e&&"highlight"!=this.evidenceMode)for(c=this.getItemNodes(a),f=0;f<c.length;f++)c[f].setAttributeNS(szMapNs,"themestyle",c[f].getAttributeNS(null,"style")),c[f].style.setProperty("display","none","")}else{f=this.partsA[e].min;k=this.partsA[e].max;for(c=1;c<b;c++)f=Math.min(f,this.partsA[e+
c].min),k=Math.max(k,this.partsA[e+c].max);for(a in this.itemA)if(f=!1,this.markedClasses&&this.markedClasses[this.itemA[a].nClass]&&(f=!0),f){if("highlight"==this.evidenceMode)for(c=this.getItemNodes(a),f=0;f<c.length;f++)highLightList.addItem(c[f])}else if("highlight"!=this.evidenceMode)for(c=this.getItemNodes(a),f=0;f<c.length;f++)if(this.szFlag.match(/BUFFER/))(k=SVGDocument.getElementById(c[f].getAttributeNS(null,"id")+":paint"))&&k.style.setProperty("display","none","");else{c[f].setAttributeNS(szMapNs,
"themestyle",c[f].getAttributeNS(null,"style"));c[f].setAttributeNS(null,"style",c[f].getAttributeNS(szMapNs,"origthemestyle"));h=c[f].firstChild.nextSibling.getAttribute("id")||c[f].getAttribute("id");if(k=SVGDocument.getElementById(h+"L"))k.setAttributeNS(szMapNs,"display",k.style.getPropertyValue("display")),k.style.setProperty("display","none","");if(k=SVGDocument.getElementById(h+"L:bg"))k.setAttributeNS(szMapNs,"display",k.style.getPropertyValue("display")),k.style.setProperty("display","none",
"");if(k=SVGDocument.getElementById(h+":::value"))k.setAttributeNS(szMapNs,"display",k.style.getPropertyValue("display")),k.style.setProperty("display","none","");if(k=SVGDocument.getElementById(h+":::value:bg"))k.setAttributeNS(szMapNs,"display",k.style.getPropertyValue("display")),k.style.setProperty("display","none","")}}this.endDraw();this.fMarkClass=!0}}}};
MapTheme.prototype.unmarkClass=function(e){if(0!=this.fUnmarkEnable)if(this.subTheme)this.removeSubTheme();else if(this.szItemFilter&&this.szItemFilter.length)this.fMarkEnable=!0,this.filterItems(this.szItemFilter,this.itemFilterOpt);else if(clearMessage(),this.szFlag.match(/CHART/)){e=this.chartGroup.childNodes;for(var b=0;b<e.length;b++){var f=e.item(b);if(null==f.getAttributeNS(szMapNs,"class"))for(var f=f.getElementsByTagName("g"),c=0;c<f.length;c++)for(var h=f.item(c).childNodes,g=0;g<h.length;g++){var m=
h.item(g);if(m.getAttributeNS&&m.getAttributeNS(szMapNs,"class")){if(this.szFlag.match(/SEQUENCE/)){var l=m.getAttributeNS(szMapNs,"orig-transform");l&&l.length&&(m.removeAttributeNS(szMapNs,"orig-transform"),m.setAttributeNS(null,"transform",l))}this.szFlag.match(/BAR/)&&this.szFlag.match(/3D/)&&!this.szFlag.match(/STACKED/)&&(m.setAttributeNS(null,"transform","matrix(1 0 0 1 0 0)"),m.style.setProperty("fill-opacity","1",""));m.style&&(m.style.setProperty("display","inline",""),(value=m.getAttributeNS(szMapNs,
"fill"))&&m.style.setProperty("fill",value,""),(value=m.getAttributeNS(szMapNs,"stroke"))&&m.style.setProperty("stroke",value,""),(value=m.getAttributeNS(szMapNs,"fill-opacity"))?m.style.setProperty("fill-opacity",value,""):""==value&&m.style.setProperty("fill-opacity","1",""))}}else f.style.setProperty("display","inline","")}this.szFlag.match(/TEXTONLY/)&&setTimeout("map.Layer.adaptLabel()",10)}else{this.beginDraw();if("highlight"!=this.evidenceMode)for(a in this.itemA)for(e=this.getItemNodes(a),
b=0;b<e.length;b++)this.szFlag.match(/BUFFER/)?(f=SVGDocument.getElementById(e[b].getAttributeNS(null,"id")+":paint"))&&f.style.setProperty("display","inline",""):(f=e[b].getAttributeNS(szMapNs,"themestyle"))&&f.length&&"null"!=f&&(e[b].setAttributeNS(null,"style",f),e[b].removeAttributeNS(szMapNs,"themestyle"),c=e[b].firstChild.nextSibling.getAttribute("id")||e[b].getAttribute("id"),(f=SVGDocument.getElementById(c+"L"))&&f.style.setProperty("display",f.getAttributeNS(szMapNs,"display"),""),(f=SVGDocument.getElementById(c+
"L:bg"))&&f.style.setProperty("display",f.getAttributeNS(szMapNs,"display"),""),(f=SVGDocument.getElementById(c+":::value"))&&f.style.setProperty("display",f.getAttributeNS(szMapNs,"display"),""),(f=SVGDocument.getElementById(c+":::value:bg"))&&f.style.setProperty("display",f.getAttributeNS(szMapNs,"display"),""));else highLightList.removeAll();this.endDraw();this.fMarkClass=!1}};
MapTheme.prototype.showClass=function(e,b,f){var c=0;if(this.szFlag.match(/DOMINANT/))for(a in this.itemA)this.itemA[a].nClass==e&&c++;clearMessage();var h=null,c=f?"inline":"none";if(this.szFlag.match(/CHART/))for(f=this.chartGroup.childNodes,h=0;h<f.length;h++){var g=f.item(h);if(null==g.getAttributeNS(szMapNs,"class"))for(g=g.firstChild.childNodes,b=0;b<g.length;b++){var m=g.item(b),l=Number(m.getAttributeNS(szMapNs,"class"));l==e&&m.style.setProperty("display",c,"")}else l=Number(g.getAttributeNS(szMapNs,
"class")),l==e&&g.style.setProperty("display",c,"")}else{this.beginDraw();if(this.szFlag.match(/DOMINANT/))for(a in this.itemA){if(this.itemA[a].nClass==e)for(h=this.getItemNodes(a),b=0;b<h.length;b++)h[b].setAttributeNS(szMapNs,"themestyle",h[b].getAttributeNS(null,"style")),h[b].style.setProperty("display",c,"")}else{l=this.partsA[e].min;g=this.partsA[e].max;for(h=1;h<b;h++)l=Math.min(l,this.partsA[e+h].min),g=Math.max(g,this.partsA[e+h].max);this.szFlag.match(/EXACT/)&&(l++,g++);for(a in this.itemA)if(this.szFlag.match(/EXACT/)&&
this.itemA[a].nValuesA[0]==l||this.itemA[a].nValuesA[0]>l&&this.itemA[a].nValuesA[0]<g)for(h=this.getItemNodes(a),b=0;b<h.length;b++)this.szFlag.match(/BUFFER/)?(e=SVGDocument.getElementById(h[b].getAttributeNS(null,"id")+":paint"))&&e.style.setProperty("display",c,""):f?(e=h[b].getAttributeNS(szMapNs,"themestyle"))&&e.length&&"null"!=e&&(h[b].setAttributeNS(null,"style",e),h[b].removeAttributeNS(szMapNs,"themestyle")):(h[b].setAttributeNS(szMapNs,"themestyle",h[b].getAttributeNS(null,"style")),h[b].setAttributeNS(null,
"style",h[b].getAttributeNS(szMapNs,"origthemestyle")))}this.endDraw()}};
MapTheme.prototype.createSubTheme=function(e){this.subTheme&&this.removeSubTheme();var b="",f="",c="",h="",g="",m="",l="",q="";this.coTable&&"undefined"!=typeof this.coTable&&(b="dbtable:"+this.coTable+";");this.szSelectionField&&"undefined"!=typeof this.szSelectionField&&(f="lookupfield:"+this.szSelectionField+";");this.szAlphaField&&"undefined"!=typeof this.szAlphaField&&(c="alphafield:"+this.szAlphaField+";");this.szAlphaField100&&"undefined"!=typeof this.szAlphaField100&&(h="alphafield100:"+this.szAlphaField100+
";");this.nDopacityScale&&"undefined"!=typeof this.nDopacityScale&&(g="dopacityscale:"+this.nDopacityScale+";");this.nDopacityPow&&"undefined"!=typeof this.nDopacityPow&&(m="dopacitypow:"+this.nDopacityPow+";");var x="lookuptoupper:"+(this.fSelectionFieldToUpper||"")+";",x=x+("lookupsuffix:"+(this.szSelectionFieldSuffix||"")+";"),x=x+("lookupprefix:"+(this.szSelectionFieldPrefix||"")+";"),x=x+("lookupdigits:"+(Number(this.nSelectionFieldDigits)||"")+";"),x=x+("lookuptonumber:"+(this.fSelectionFieldToNumber||
"")+";"),x=x+("lookuptoupper:"+(this.fSelectionFieldToUpper||"")+";");this.szFlag.match(/DOPACITY/)&&(l+="DOPACITYMAX|");this.szFlag.match(/AGGREGATE/)&&(l+="AGGREGATE|");this.szFlag.match(/GROUP/)&&(l+="GROUP|");this.szFlag.match(/SUM/)&&(l+="SUM|");this.szFlag.match(/ZEROISVALUE/)&&(l+="ZEROISVALUE|");this.szFlag.match(/VALUES/)&&(l+="VALUES|");this.szAggregationField&&"undefined"!=typeof this.szAggregationField&&(q+="aggregationfield:"+this.szAggregationField+";");this.szUnits&&"undefined"!=typeof this.szUnits&&
(q+="units:"+this.szUnits+";");map.Themes.enableMultiChoropleth=!0;if(this.markedClassesA&&1<this.markedClassesA.length){var l=this.szFields.split("|"),r="",k="";for(i=0;i<this.markedClassesA.length;i++)r+=(r.length?"|":"")+l[this.markedClassesA[i]],k+=(k.length?"|":"")+this.colorScheme[this.markedClassesA[i]];e=map.Themes.newTheme(this.szThemes,r,this.szField100,"type:"+this.szFlag+";colorscheme:"+k+";"+b+f+c+h+g+m+x+q,this.szLabelA[e],"")}else e=map.Themes.newTheme(this.szThemes,this.szFields.split("|")[e],
this.szField100,"type:CHOROPLETH|QUANTILE|NOINFO|SUBTHEME|"+l+";colorscheme:7|white|"+this.colorScheme[e]+";"+b+f+c+h+g+m+x+q,this.szLabelA[e],"");this.subTheme=e;map.Themes.subTheme=this};MapTheme.prototype.removeSubTheme=function(){map.Themes.enableMultiChoropleth=!1;this.subTheme&&(map.Themes.subTheme=!1,map.Themes.removeTheme(null,this.subTheme.szId),this.subTheme=null,map.Themes.realizeDone(this))};
MapTheme.prototype.isItemInFilter=function(e,b,f,c){if(!(0!=f.length||c&&c.field))return!0;if("undefined"!=typeof b.dbIndex)if(b=b.dbIndex,f.length){if(this.__szValue=e.dbRecords[b].join(" "),eval("this.__szValue.match(/"+f.replace(/\//gi,"\\/")+"/i)"))return!0}else if(c&&c.field){for(f=0;f<e.dbFields.length;f++)if(e.dbFields[f].id==c.field&&(c.min&&e.dbRecords[b][f]<c.min||c.max&&e.dbRecords[b][f]>c.max||c.txt&&e.dbRecords[b][f]!=c.txt))return!1;return!0}return!1};
MapTheme.prototype.filterItems=function(e,b){if(0!=this.fMarkEnable){this.szItemFilter=e;this.itemFilterOpt=b;this.filterNodesA=e.length||b&&b.field?[]:null;for(var f=null,c=0;c<this.szThemesA.length&&(!(f=this.objThemesA[this.szThemesA[c]])||!f.dbRecords);c++);if(f&&f.dbRecords){if(this.szFlag.match(/CHART/))for(var h=this.chartGroup.childNodes,c=0;c<h.length;c++){var g=[],m=h.item(c);g.push(m);for(var l=0;l<g.length;l++)szId=g[l].getAttributeNS(null,"id"),szId=szId.split(":")[1]+"::"+szId.split(":")[3],
this.itemA[szId]?this.isItemInFilter(f,this.itemA[szId],e,b)?(m.style.setProperty("display","inline",""),this.filterNodesA&&this.filterNodesA.push(szId)):m.style.setProperty("display","none",""):m.style.setProperty("display","inline","")}else{this.beginDraw();for(a in this.itemA)if(this.itemA[a]&&"undefined"!=typeof this.itemA[a].dbIndex)if(this.isItemInFilter(f,this.itemA[a],e,b))for(this.filterNodesA&&this.filterNodesA.push(a),tilesNodesA=this.getItemNodes(a),j=0;j<tilesNodesA.length;j++)this.szFlag.match(/BUFFER/)?
(c=SVGDocument.getElementById(tilesNodesA[j].getAttributeNS(null,"id")+":paint"))&&c.style.setProperty("display","inline",""):(c=tilesNodesA[j].getAttributeNS(szMapNs,"themestyle"))&&c.length&&"null"!=c&&(tilesNodesA[j].setAttributeNS(null,"style",c),tilesNodesA[j].removeAttributeNS(szMapNs,"themestyle"),(c=SVGDocument.getElementById(tilesNodesA[j].firstChild.nextSibling.getAttribute("id")+"L"))&&c.style.setProperty("display",c.getAttributeNS(szMapNs,"display"),""),(c=SVGDocument.getElementById(tilesNodesA[j].firstChild.nextSibling.getAttribute("id")+
"L:bg"))&&c.style.setProperty("display",c.getAttributeNS(szMapNs,"display"),""));else for(tilesNodesA=this.getItemNodes(a),j=0;j<tilesNodesA.length;j++)if(this.szFlag.match(/BUFFER/))(c=SVGDocument.getElementById(tilesNodesA[j].getAttributeNS(null,"id")+":paint"))&&c.style.setProperty("display","none","");else{tilesNodesA[j].getAttributeNS(szMapNs,"themestyle")||tilesNodesA[j].setAttributeNS(szMapNs,"themestyle",tilesNodesA[j].getAttributeNS(null,"style"));tilesNodesA[j].setAttributeNS(null,"style",
tilesNodesA[j].getAttributeNS(szMapNs,"origthemestyle"));if(c=SVGDocument.getElementById(tilesNodesA[j].firstChild.nextSibling.getAttribute("id")+"L"))c.setAttributeNS(szMapNs,"display",c.style.getPropertyValue("display")),c.style.setProperty("display","none","");if(c=SVGDocument.getElementById(tilesNodesA[j].firstChild.nextSibling.getAttribute("id")+"L:bg"))c.setAttributeNS(szMapNs,"display",c.style.getPropertyValue("display")),c.style.setProperty("display","none","")}this.endDraw()}this.fMarkClass=
!0}}};MapTheme.prototype.selectFilterItems=function(){map.Selections.newSelection("generic",this.filterNodesA,"type:queryresult",this.szItemFilter)};
MapTheme.prototype.highlightItems=function(e,b){highLightList.removeAll();var f=e.split(b||",");__this=this;f.forEach(function(b){if(__this.szFlag.match(/CHART/)){var e=SVGDocument.getElementById(__this.szId+":"+b+":chart");highLightList.addItem(e);e=SVGDocument.getElementById(__this.szId+":"+b+":chartgroup");map.displayInfo(null,e.firstChild,"add|fix")}else{tilesNodesA=__this.getItemNodes(b);for(j=0;j<tilesNodesA.length;j++)highLightList.addItem(tilesNodesA[j]);map.displayInfo(null,tilesNodesA[0].firstChild.nextSibling,
"add|fix")}})};MapTheme.prototype.clearHighlightItems=function(){highLightList.removeAll();map.removeInfo()};
MapTheme.prototype.labelMap=function(e){var b=map.Zoom.getBox(),f=null;this.szValuesTextStyle="font-family:verdana;font-size:"+map.Scale.normalX(11)+"px;pointer-events:none";if(!e||0==e){var c=0;e=0;this.indexA=[];var h=0,g=0;if(this.fClipCharts)for(c in this.itemA){if(g++,this.itemA[c].nValuesA&&0<this.itemA[c].nValuesA.length&&(f=this.getNodePosition(this.itemA[c].szSelectionId)))if(f.x<b.x||f.x>b.x+b.width||f.y<b.y||f.y>b.y+b.height){if(this.nSkipCount++,chartGroup=SVGDocument.getElementById(this.szId+
":"+c+":chart"))chartGroup.parentNode.removeChild(chartGroup),this.chartPosA[this.itemA[c].szSelectionId]=null,this.posItemA[this.itemA[c].szSelectionId]=null}else this.indexA[this.indexA.length]=c,h++}else for(c in this.itemA)this.indexA[this.indexA.length]=c,g++,h++;h>this.nMaxThemeCharts&&(this.indexA.length=0,this.nSkipCount=h);this.mapSleep&&(this.mapSleep.nCount=h);this.fEnableProgressBar=!1}for(;e<this.indexA.length;e++){if(this.fCancel){displayMessage("Canceled by user",1E3,!0);this.fCancel=
!1;return}if(this.mapSleep&&(this.mapSleep.nDoneCount=this.nDoneCount,this.mapSleep.checkSleep(e,10))){this.fContinue=!0;this.continueIndex=e;return}c=this.indexA[e];this.nDoneCount++;if(this.itemA[c].nValuesA&&0<this.itemA[c].nValuesA.length)if(f=this.getNodePosition(this.itemA[c].szSelectionId))if(this.fClipCharts&&!this.szFlag.match(/BUFFER/)&&(f.x<b.x||f.x>b.x+b.width||f.y<b.y||f.y>b.y+b.height))this.nSkipCount++;else for(f=this.getItemNodes(c),j=0;j<f.length;j++)this.labelShape(f[j],this.itemA[c].szColor,
this.itemA[c].szLabel?this.itemA[c].szLabel:this.itemA[c].nValue);else this.nMissingPositionCount++}this.fMakeLabel=!1;setTimeout("map.Layer.adaptLabel(null)",10)};MapTheme.prototype.unlabelMap=function(){for(a in map.Layer.generatedLabelA)map.Dom.removeElementById(a),map.Layer.generatedLabelA[a]=null};
MapTheme.prototype.labelShape=function(e,b,f){if(this.szFlag.match(/VALUES/)&&"undefined"!=f&&"undefined"!=typeof f&&(!this.szFlag.match(/NOZERO/)||0!=f)){var c=e.parentNode.getAttributeNS(null,"id"),h=SVGDocument.getElementById(c+":label");if(h){var g=SVGDocument.getElementById(c+":values:bg");g||(g=map.Dom.newGroup(h.parentNode,c+":values:bg"),map.Layer.generatedLabelA[c+":values:bg"]=g);var m=SVGDocument.getElementById(c+":values");m||(m=map.Dom.newGroup(h.parentNode,c+":values"),map.Layer.generatedLabelA[c+
":values"]=m);try{var l=e.firstChild.nextSibling.getAttributeNS(null,"id").split("#"),q=l[0]+"L"+(l[1]?"#"+l[1]:"")}catch(x){q=e.getAttributeNS(null,"id")+":::value"}SVGDocument.getElementById(q)||(h=__maptheme_getChartColors(b),b="string"==typeof f?f:this.formatValue(f,this.szValueDecimals||0)+(this.szUnit.match(/\%/)?"%":""),c="#ffffff",c=this.szTextColor||h.highColor,h=h.lowColor,l=1,this.szFlag.match(/DTEXT/)&&(l=Math.max(.7,Math.min(1.5,2/Math.sqrt(this.nMax)*Math.sqrt(f)))),f=map.Scale.normalX(11)*
map.Scale.nZoomScale*l*map.Scale.nLabelScaling*(this.nLabelScale||1),g=map.Dom.newText(g,0,0,"font-family:verdana;font-weight:normal;font-size:"+f+"px;text-anchor:middle;fill:none;stroke:"+h+";stroke-width:"+map.Scale.normalX(4)*map.Scale.nZoomScale+";stroke-opacity:0.5;pointer-events:none;display:none;stroke-linejoin:bevel;",b),m=map.Dom.newText(m,0,0,"font-family:verdana;font-weight:normal;font-size:"+f+"px;text-anchor:middle;fill:"+c+";stroke:none;pointer-events:none;display:none;",b),m.setAttributeNS(null,
"id",q),g.setAttributeNS(null,"id",q+":bg"),this.szFlag.match(/DOPACITY/)&&(m.style.setProperty("fill-opacity","1",""),g.style.setProperty("stroke-opacity","1","")),(q=e.getAttributeNS(szMapNs,"center"))?(e=q.split(","),e=new point(Number(e[0].split(":")[1]),Number(e[1].split(":")[1]))):e=this.getNodePosition(e.getAttributeNS(null,"id")),e&&(m.fu.setPosition(e.x,e.y),g.fu.setPosition(e.x,e.y)))}}};
MapTheme.prototype.zoomTo=function(){var e=new point(1E5,1E5),b=new point(-1E5,-1E5);if(this.szFlag.match(/CHART/))for(a in this.itemA){var f=this.itemA[a].ptPos||this.getNodePosition(this.itemA[a].szSelectionId);f&&(e.x=Math.min(e.x,f.x),e.y=Math.min(e.y,f.y),b.x=Math.max(b.x,f.x),b.y=Math.max(b.y,f.y))}else for(a in this.itemA)for(tilesNodesA=this.getItemNodes(a),j=0;j<tilesNodesA.length;j++){bBox=map.Dom.getBox(tilesNodesA[j]);if(0==bBox.width||0==bBox.height)f=getMatrix(tilesNodesA[j]),bBox.x+=
f[4],bBox.y+=f[5],bBox.width=map.Scale.viewBox.width/20,bBox.height=map.Scale.viewBox.height/20,bBox.x-=bBox.width/2,bBox.y-=bBox.height/2;f=map.Scale.getMapOffset(tilesNodesA[j]);bBox.x+=f.x;bBox.y+=f.y;e.x=Math.min(e.x,bBox.x);e.y=Math.min(e.y,bBox.y);b.x=Math.max(b.x,bBox.x+bBox.width);b.y=Math.max(b.y,bBox.y+bBox.height)}e=new box(e.x,e.y,b.x-e.x,b.y-e.y);e.scale(1);e=map.Zoom.clipArea(e);map.Zoom.setNewArea(e)};
MapTheme.prototype.chartMap=function(e){if(!this.nChartUpper||map.Scale.nTrueMapScale*map.Scale.nZoomScale<=this.nChartUpper)if(!this.nChartLower||map.Scale.nTrueMapScale*map.Scale.nZoomScale>this.nChartLower){this.chartGroup&&!e&&(this.chartPosA=[]);var b=this.nChartSize?this.nChartSize:30,f=map.Zoom.getBox(),c=this.szFlag.match(/AGGREGATE/)&&this.nGridWidth?map.Scale.getDeltaXofDistanceInMeter(this.nGridWidth||0)*map.Scale.nZoomScale:map.Scale.normalX(30)*map.Scale.nZoomScale;f.x-=c/2;f.y-=c/2;
f.width+=c;f.height+=c;var h=null,c="#777777",g=8;if(!e||0==e){if(!this.partsA)return;var m=0;e=0;this.indexA=[];this.szValuesLineStyle="stroke:white;stroke-width:"+map.Scale.normalX(1.5)+";opacity:0.5;";this.szValuesLineBgStyle="stroke:#888888;stroke-width:"+map.Scale.normalX(.5)+";opacity:1;";this.szValuesTextStyle="font-family:"+(this.szTextFont||"arial")+";font-size:"+map.Scale.normalX(g)+"px;fill:"+c+";pointer-events:none";var l=map.Layer.objectGroup;if(!this.chartGroup&&(this.chartGroup=map.Dom.newGroup(l,
this.szId+":chartgroup"),this.chartGroup.style.setProperty("opacity",String(this.nOpacity?this.nOpacity:1),""),this.szFlag.match(/NOSCALE/)&&antiZoomAndPanList.addGroup(this.chartGroup),this.szFlag.match(/AGGREGATE/)&&(this.szFlag.match(/AUTOSIZE/)||this.szFlag.match(/GRIDSIZE/))&&antiZoomAndPanList.addGroup(this.chartGroup),this.szFlag.match(/GRIDSIZE/)&&!this.szFlag.match(/AGGREGATE/)&&antiZoomAndPanList.addGroup(this.chartGroup),this.szFlag.match(/BUFFER/))){this.szFlag.match(/OVERLAY/)&&!this.szShapeType.match(/line/)&&
this.chartGroup.style.setProperty("opacity","1","");map.Layer.getLayerObj(this.szThemesA[0]);this.chartGroup.style.setProperty("pointer-events","none","");antiZoomAndPanList.addGroup(this.chartGroup);var c=this.colorScheme[0],q=this.colorScheme[1]?this.colorScheme[1]:"red";"undefined"!=typeof this.szBorderColor&&(q=this.szBorderColor);var x="stroke-width:0;";if("undefined"!=typeof this.szBorderStyle)switch(this.szBorderStyle){case "dotted":x="stroke-width:"+map.Scale.normalX(1)+";stroke-linecap:round;stroke-dasharray:1,50;";
break;case "dashed":x="stroke-width:"+map.Scale.normalX(1)+";stroke-linecap:butt;stroke-dasharray:30,30;";break;case "solid":x="stroke-width:"+map.Scale.normalX(1)+";";break;case "none":x="stroke-width:0;"}if("undefined"!=typeof this.szBorderWidth)switch(this.szBorderWidth){case "thin":x+="stroke-width:"+map.Scale.normalX(.5)+";";break;case "thick":x+="stroke-width:"+map.Scale.normalX(1.5)+";"}this.chartGroup.setAttributeNS(null,"style","fill:"+c+";fill-opacity:"+(this.fillOpacity?this.fillOpacity:
this.nOpacity?this.nOpacity:0)+";stroke:"+q+";"+x+";")}this.blur(this.nBlur);this.autoOpacity&&(this.fillOpacity=1*Math.max(.1,Math.min(1,20/Math.max(1,Math.pow(map.Zoom.nZoom,.5)))));this.mapSleep&&(this.mapSleep.checkSleepMessage="creating charts");l=getRotateAttributeValue(map.Scale.canvasNode);if(this.szFlag.match(/SORT/)&&!this.szFlag.match(/SEQUENCE/)&&!this.szFlag.match(/3D/)){this.indexA=[];for(m in this.itemA)this.indexA[this.indexA.length]=m;for(var q=[],r=0;r<this.indexA.length;r++)g=this.itemA[this.indexA[r]].nValuesA[this.nActualFrame||
0],this.itemA[this.indexA[r]].nSize?g=this.itemA[this.indexA[r]].nSize:this.szFlag.match(/SIZE/)&&this.itemA[this.indexA[r]].nValueSum&&(g=this.itemA[this.indexA[r]].nValueSum),isNaN(g)||q.push({a:this.indexA[r],y:g});this.szFlag.match(/\|UP/)?q.sort(this.sortDownChartObjectsCompare):q.sort(this.sortUpChartObjectsCompare);if(this.szValueField&&"$index$"==this.szValueField)for(r=0;r<q.length;r++)this.itemA[q[r].a].szValue=String(q.length-r);this.indexA=[]}if(this.szFlag.match(/CHART/)&&!this.szFlag.match(/EXACT/)){for(s=
0;s<this.partsA.length;s++)this.partsA[s].nCount=0,this.partsA[s].nSum=0;this.fRedrawInfo=!0;this.szFlag.match(/SEQUENCE/)&&(this.nFadeNegative=this.nFadeNegative||1)}x=q=g=0;if(this.fClipCharts&&!this.szFlag.match(/BUFFER/)){for(r=0;r<this.partsA.length;r++)this.partsA[r].nCount=0,this.partsA[r].nSum=0;for(m in this.itemA)if(q++,this.itemA[m].nValuesA&&0<this.itemA[m].nValuesA.length)if(h=this.itemA[m].ptPos||this.getNodePosition(this.itemA[m].szSelectionId))if(h.x<f.x||h.x>f.x+f.width||h.y<f.y||
h.y>f.y+f.height)this.nSkipCount++,(chartGroup=this.itemA[m].chartNode)&&chartGroup.parentNode&&(chartGroup.parentNode&&chartGroup.parentNode.removeChild(chartGroup),this.itemA[m].chartNode=null,this.chartPosA[this.itemA[m].szSelectionId]=null,this.posItemA[this.itemA[m].szSelectionId]=null);else{this.indexA[this.indexA.length]=m;if(this.szFlag.match(/CHART/)&&!this.szFlag.match(/EXACT/))for(r=0;r<this.partsA.length;r++)this.partsA[r].nCount++,this.partsA[r].nSum+=isNaN(this.itemA[m].nValuesA[r])?
0:this.itemA[m].nValuesA[r];else if(this.szFlag.match(/CHART/))if(1<this.itemA[m].nValuesA.length)for(r=0;r<this.partsA.length;r++)this.partsA[r].nCount++,this.partsA[r].nSum+=isNaN(this.itemA[m].nValuesA[r])?0:this.itemA[m].nValuesA[r];else this.partsA[this.itemA[m].nValuesA[0]-1]&&(this.partsA[this.itemA[m].nValuesA[0]-1].nCount++,this.partsA[this.itemA[m].nValuesA[0]-1].nSum+=isNaN(this.itemA[m].nSize)?1:this.itemA[m].nSize);g++}else this.missedA[m]=m,x++;if(q==x&&!map.Tiles.allTilesLoaded()){this.fRedraw=
this.fDataIncomplete=!0;map.Tiles.switchScaleDependentTiles();setTimeout("map.Themes.execute()",1);return}}else for(m in this.itemA){this.indexA[this.indexA.length]=m;if(this.szFlag.match(/CHART/)&&!this.szFlag.match(/EXACT/))for(r=0;r<this.partsA.length;r++)this.partsA[r].nCount++,this.partsA[r].nSum+=isNaN(this.itemA[m].nValuesA[r])?0:this.itemA[m].nValuesA[r];q++;g++}if(g>this.nMaxThemeCharts)for(m in this.ErrorMessage="max charts ("+this.nMaxThemeCharts+") exceeded; please zoom in",this.indexA.length=
0,this.nSkipCount=g,this.itemA)(chartGroup=SVGDocument.getElementById(this.szId+":"+m+":chart"))&&chartGroup.parentNode.removeChild(chartGroup);this.fRedrawAllCharts=!1;g>this.nMaxShadowCharts?(this.fShadow&&(this.fRedrawAllCharts=!0),this.fShadow=!1):(this.fOrigShadow&&!this.fShadow&&(this.fRedrawAllCharts=!0),this.fShadow=this.fOrigShadow);this.szShadowUpper&&(map.Scale.nTrueMapScale*map.Scale.nZoomScale>this.nShadowUpper?(this.xOrigShadow=this.xOrigShadow||this.fOrigShadow,this.fShadow=this.fOrigShadow=
!1):this.fOrigShadow=this.xOrigShadow||this.fOrigShadow);this.szShadowLower&&(map.Scale.nTrueMapScale*map.Scale.nZoomScale<this.nShadowLower?(this.xOrigShadow=this.xOrigShadow||this.fOrigShadow,this.fShadow=this.fOrigShadow=!1):this.fOrigShadow=this.xOrigShadow||this.fOrigShadow);this.mapSleep&&(this.mapSleep.nCount=g);this.fSorted=!1;if(this.fSortBeforeDraw&&this.nMin!=this.nMax&&!this.szFlag.match(/NOSRT/)&&!this.szFlag.match(/DOT/)&&(!this.szFlag.match(/NOSIZE/)||this.szFlag.match(/3D/)||this.szFlag.match(/SORT/))&&
(!this.szFlag.match(/EXACT/)||this.szFlag.match(/AGGREGATE/)||this.szSizeField)){q=[];if((this.szFlag.match(/3D/)||this.szFlag.match(/BOX/)||this.szFlag.match(/POINTER/))&&(!this.szFlag.match(/MULTIPLE/)&&!this.szFlag.match(/MULTIGRID/)||this.szFlag.match(/AGGREGATE/)))for(r=0;r<this.indexA.length;r++)(h=this.itemA[this.indexA[r]].ptPos||this.getNodePosition(this.itemA[this.indexA[r]].szSelectionId))?q[r]=l?{a:this.indexA[r],y:h.x*Math.sin(l)+h.y*Math.cos(l)}:{a:this.indexA[r],y:h.y}:q[r]={a:this.indexA[r],
y:0};else if(this.szSizeField||this.szFlag.match(/AGGREGATE/)&&this.szFlag.match(/SUM/))for(r=0;r<this.indexA.length;r++)g=this.itemA[this.indexA[r]].nSize,isNaN(g)||q.push({a:this.indexA[r],y:g});else if(this.szFlag.match(/SIZE/))for(r=0;r<this.indexA.length;r++)g=this.itemA[this.indexA[r]].nValueSum,isNaN(g)||q.push({a:this.indexA[r],y:g});else for(r=0;r<this.indexA.length;r++)g=this.itemA[this.indexA[r]].nValuesA[this.nActualFrame||0],isNaN(g)||q.push({a:this.indexA[r],y:g});this.szFlag.match(/SORT/)&&
this.szFlag.match(/\|UP/)&&!this.szFlag.match(/SEQUENCE/)&&!this.szFlag.match(/3D/)?q.sort(this.sortDownChartObjectsCompare):q.sort(this.sortUpChartObjectsCompare);for(r=0;r<q.length;r++)this.indexA[r]=q[r].a;this.fSorted=!0}}this.chart={szColor:this.colorScheme[0],szLineColor:this.colorScheme[1]?this.colorScheme[1]:"none",szTextColor:this.colorScheme[1]?this.colorScheme[1]:"none"};if(2<this.colorScheme.length||this.szFlag.match(/EXACT/))this.chart.szColor=this.colorScheme[this.colorScheme.length-
1],this.chart.szLineColor=this.colorScheme[0];this.szFlag.match(/NOLINES/)?this.chart.szLineColor="none":"none"==this.chart.szLineColor&&(c=__maptheme_getChartColors(c),this.chart.szLineColor=c.textColor);this.szFlag.match(/PLOT/)&&(this.szFlag.match(/GRIDSIZE/)||this.szFlag.match(/AUTOSIZE/))?(g=0,c=map.Layer.nDynamicObjectScale,h=this.szFlag.match(/GAP/)?1.2:1,g=this.nGridWidthPx?map.Scale.normalX(this.nGridWidthPx)/h*this.nScale/c:this.nGridWidth?map.Scale.getDeltaXofDistanceInMeter(this.nGridWidth)/
h*this.nScale/c:map.Scale.normalX(b/3),this.nAutoScale=g/map.Scale.normalX((this.itemA[m]?this.itemA[m].nValuesA.length:1)/(this.nGridX||1)*b),this.nGridSize=g):this.szFlag.match(/GRIDSIZE/)&&(c=map.Layer.nDynamicObjectScale,h=this.szFlag.match(/RECT/)||!this.szFlag.match(/AGGREGATE/)?this.szFlag.match(/GAP/)?1.15:1:this.szFlag.match(/GAP/)?.8:.75,this.nGridSize=this.nGridWidthPx?map.Scale.normalX(this.nGridWidthPx)/h/c:this.nGridWidth?map.Scale.getDeltaXofDistanceInMeter(this.nGridWidth)/h/c:map.Scale.normalX(b/
3));this.nChartGroupScale=fObjectScaling?(this.nAutoScale||this.nScale)*map.Layer.nObjectScale*map.Scale.nObjectScaling:(this.nAutoScale||this.nScale)*map.Scale.nFeatureScaling*map.Scale.nObjectScaling;this.fGlowInScale=!1;(!this.szGlowUpper||map.Scale.nTrueMapScale*map.Scale.nZoomScale<=this.nGlowUpper)&&(!this.szGlowLower||map.Scale.nTrueMapScale*map.Scale.nZoomScale>=this.nGlowLower)&&(this.fGlowInScale=!0);this.fDoRedraw=!1;if(1E3>this.indexA.length||this.fRedraw||this.fRedrawAllCharts||this.szFlag.match(/BUFFER/)&&
this.szShapeType.match(/line/))this.fDoRedraw=!0;g=map.Scale.getDeltaXofDistanceInMeter(this.nGridWidth)/2*20;for(g=g*map.Scale.nZoomScale*20;e<this.indexA.length;e++){if(this.fCancel){displayMessage("Canceled by user",1E3,!0);this.fCancel=!1;return}if(this.mapSleep&&(this.mapSleep.nDoneCount=this.nDoneCount,this.mapSleep.checkSleep(e,10))){this.fContinue=!0;this.continueIndex=e;this.szItemFilter&&this.szItemFilter.length&&this.filterItems(this.szItemFilter,this.itemFilterOpt);null!=this.markedClass&&
this.markClass(this.markedClass,1);return}c=null;m=this.indexA[e];this.nDoneCount++;if(this.itemA[m].nValuesA&&0!=this.itemA[m].nValuesA.length)if(r=this.itemA[m].szSelectionId,h=this.itemA[m].ptPos||this.getNodePosition(r),h.x=isNaN(h.x)?0:h.x,h.y=isNaN(h.y)?0:h.y,!h||isNaN(h.x)||isNaN(h.y))this.nMissingPositionCount++;else if(this.fClipCharts&&!this.szFlag.match(/BUFFER/)&&(h.x<f.x||h.x>f.x+f.width||h.y<f.y||h.y>f.y+f.height))this.nSkipCount++;else{this.fRedraw&&(this.itemA[m].chartNode=this.itemA[m].chartNode||
SVGDocument.getElementById(this.szId+":"+m+":chart"));if(this.itemA[m].chartNode&&this.itemA[m].chartNode.parentNode)if(this.fDoRedraw)this.itemA[m].chartNode.parentNode.removeChild(this.itemA[m].chartNode),this.itemA[m].chartNode=null;else{this.nRealizedCount++;continue}q=new point(0,0);if(this.szFlag.match(/DOT/)){c=map.Dom.newGroup(this.chartGroup,this.szId+":"+r+":chartgroup");c.fu.setMatrix([this.nChartGroupScale,0,0,this.nChartGroupScale,h.x,h.y]);if(this.szFlag.match(/EXACT/))this.chart.szColor=
this.colorScheme[this.itemA[m].nValuesA[0]-1];else if(1<this.partsA.length)for(r=0;r<this.partsA.length;r++)this.itemA[m].nValuesA[0]>=this.partsA[r].min&&this.itemA[m].nValuesA[0]<this.partsA[r].max&&(this.chart.szColor=this.colorScheme[r]);this.itemA[m].chartNode=map.Dom.newShape("circle",c,0,0,map.Scale.normalX(3),"fill:"+this.chart.szColor+";fill-opacity:"+(this.fillOpacity||1)+";stroke:none;")}else if(this.szFlag.match(/\|QUAD\|/)){c=map.Dom.newGroup(this.chartGroup,this.szId+":"+r+":chart");
c.fu.setMatrix([this.nChartGroupScale,0,0,this.nChartGroupScale,h.x,h.y]);if(this.szFlag.match(/EXACT/))this.chart.szColor=this.colorScheme[this.itemA[m].nValuesA[0]-1];else if(1<this.partsA.length)for(r=0;r<this.partsA.length;r++)this.itemA[m].nValuesA[0]>=this.partsA[r].min&&this.itemA[m].nValuesA[0]<this.partsA[r].max&&(this.chart.szColor=this.colorScheme[r]);this.itemA[m].chartNode=map.Dom.newShape("rect",c,-g,-g,2*g,2*g,"fill:"+this.chart.szColor+";stroke:none;")}else{c=null;if(r)if(c=SVGDocument.getElementById(this.szId+
":"+r+":chart"))c.fu=new Methods(c);else if(c=map.Dom.newGroup(this.chartGroup,this.szId+":"+r+":chart"),this.szFlag.match(/BOX/)){q="#bbbbbb";"undefined"!=typeof this.szBorderColor&&(q=this.szBorderColor);x="stroke-width:"+map.Scale.normalX(.5)+";stroke-opacity:0.3;";if("undefined"!=typeof this.szBorderStyle)switch(this.szBorderStyle){case "dotted":x="stroke-width:"+map.Scale.normalX(1)+";stroke-linecap:round;stroke-dasharray:1,50;";break;case "dashed":x="stroke-width:"+map.Scale.normalX(1)+";stroke-linecap:butt;stroke-dasharray:30,30;";
break;case "solid":x="stroke-width:"+map.Scale.normalX(1)+";";break;case "none":x="stroke-width:0;"}if("undefined"!=typeof this.szBorderWidth)switch(this.szBorderWidth){case "thin":x+="stroke-width:"+map.Scale.normalX(.3)+";";break;case "thick":x+="stroke-width:"+map.Scale.normalX(1.5)+";"}newBox=map.Dom.newShape("rect",c,0,0,1,1,"fill:"+(this.szBoxColor||"white")+";fill-opacity:"+(this.nBoxOpacity||1)+";stroke:"+q+";"+x);newBox.setAttributeNS(null,"id",this.szId+":"+r+":chart:box");switch(this.szSymbolBoxStyle){case "frame":this.boxShape.setAttributeNS(null,
"fill-opacity",0);break;case "field":this.boxShape.setAttributeNS(null,"fill-opacity",1)}}this.itemA[m].chartNode=c;c.setAttributeNS(szMapNs,"value",String(this.itemA[m].nValuesA[0]));q=this.drawChart(c,m,b,this.szFlag+"|SILENT");x=this.nScale;this.nScale=this.nAutoScale||this.nScale;q&&h&&c&&(this.szFlag.match(/PLOT/)&&this.nGridSize&&this.nAutoScale&&(q.x+=this.nGridSize/this.nAutoScale/2,q.y-=this.nGridSize/this.nAutoScale/2),this.szFlag.match(/NOSCALE/)?c.fu.setMatrix([this.nScale,0,0,this.nScale,
h.x-q.x*this.nScale,h.y-q.y*this.nScale]):c.fu.setMatrix([this.nChartGroupScale,0,0,this.nChartGroupScale,h.x-q.x*map.Layer.nObjectScale*this.nScale,h.y-q.y*map.Layer.nObjectScale*this.nScale]));this.nScale=x;if(q){r=r.split("*")[0];if((this.szFlag.match(/MULTIPLE/)||this.szFlag.match(/ALIGN/))&&c.lastChild.firstChild){h=map.Dom.getBox(c.lastChild);q=this.szFlag.match(/\|UP/)?h.height:h.width;if(this.chartPosA[r]){this.chartPosA[r]+=this.szFlag.match(/TEXTONLY/)?5:.5*q;var x=c.lastChild.fu.getPosition(),
k=q*(this.nGridX||10);this.szFlag.match(/\|UP/)?c.lastChild.fu.setPosition(x.x+h.width*Math.floor(this.chartPosA[r]/k),x.y-h.y-h.height/2-this.chartPosA[r]%k):c.lastChild.fu.setPosition(x.x+this.chartPosA[r]%k,x.y-h.height*Math.floor(this.chartPosA[r]/k));this.chartPosA[r]+=this.szFlag.match(/TEXTONLY/)?q:.5*q}else this.chartPosA[r]=this.szFlag.match(/TEXTONLY/)?q:-h.y;this.posItemA&&(this.posItemA[r]||(this.posItemA[r]=[]),this.posItemA[r].push(this.itemA[m]))}else if((this.szFlag.match(/MULTIFIX/)||
this.szFlag.match(/MULTIGRID/))&&c.lastChild){var q=1,H=map.Scale.normalX(this.nChartSizeDone),w=map.Scale.normalX(this.nChartSizeDone),h=this.getNodePosition(r),r=String(h.x)+String(h.y);if(this.chartPosA[r]){var x=c.lastChild.fu.getPosition(),B=this.chartPosA[r],k=this.nGridX||7;this.szFlag.match(/\|UP/)?c.lastChild.fu.setPosition(x.x+H*Math.floor(B/k),x.y-B%k*w):c.lastChild.fu.setPosition(x.x+B%k*H,x.y-w*Math.floor(B/k));this.chartPosA[r]+=q}else this.chartPosA[r]=q;this.posItemA&&(this.posItemA[r]||
(this.posItemA[r]=[]),this.posItemA[r].push(this.itemA[m]));this.itemA[m].labelGroup&&B%k!=k-1&&this.itemA[m].labelGroup.style.setProperty("display","none","")}else(this.szFlag.match(/MULTISQUARE/)||this.szFlag.match(/MULTIQUAD/))&&c.lastChild&&(q=1,H=map.Scale.normalX(this.nChartSizeDone*(this.nRangeScale||1)),w=map.Scale.normalX(this.nChartSizeDone*(this.nRangeScale||1)),h=this.getNodePosition(r),r=String(h.x)+String(h.y),this.chartPosA[r]?(x=c.lastChild.fu.getPosition(),B=this.chartPosA[r],h=Math.floor(Math.sqrt(B)),
h<(this.nGridX||1E7)?(k=B-h*h,c.lastChild.fu.setPosition(x.x+(k<=h?k:h)*H,x.y-(k<=h?h:h-(k-h))*w)):(x=c.lastChild.fu.getPosition(),B=this.chartPosA[r],k=this.nGridX||7,this.szFlag.match(/\|UP/)?c.lastChild.fu.setPosition(x.x+H*Math.floor(B/k),x.y-B%k*w):c.lastChild.fu.setPosition(x.x+B%k*H,x.y-w*Math.floor(B/k))),this.chartPosA[r]+=q):this.chartPosA[r]=q,this.posItemA&&(this.posItemA[r]||(this.posItemA[r]=[]),this.posItemA[r].push(this.itemA[m])),this.itemA[m].labelGroup&&B%k!=k-1&&this.itemA[m].labelGroup.style.setProperty("display",
"none",""));this.szFlag.match(/TEXTONLY/)&&fCheckLabelOverlap&&(h=SVGDocument.getElementById(this.szId+":"+m+":text"))&&new Map.Label.Item(h);l&&setRotate(c,-Number(l));1==this.fShadow&&SVGDocument.getElementById(szShadowFilterId)?c.style.setProperty("filter","url(#"+szShadowFilterId+")",""):1==this.fShadow&&(r=map.Dom.newNode("filter",this.chartGroup.parentNode),r.setAttributeNS(null,"id",szShadowFilterId),r.setAttributeNS(null,"filterUnits","objectBoundingBox"),r.setAttributeNS(null,"x","-50%"),
r.setAttributeNS(null,"y","-50%"),r.setAttributeNS(null,"width","200%"),r.setAttributeNS(null,"height","200%"),h=map.Dom.newNode("feGaussianBlur",r),h.setAttributeNS(null,"stdDeviation","10"),h.setAttributeNS(null,"result","BlurAlpha"),h=map.Dom.newNode("feOffset",r),h.setAttributeNS(null,"in","BlurAlpha"),h.setAttributeNS(null,"dx","10"),h.setAttributeNS(null,"dy","10"),h.setAttributeNS(null,"result","OffsetBlurAlpha"),h=map.Dom.newNode("feColorMatrix",r),h.setAttributeNS(null,"in","OffsetBlurAlpha"),
h.setAttributeNS(null,"type","matrix"),h.setAttributeNS(null,"values","0.1 0.1 0.1 0 0 0.1 0.1 0.1 0 0 0.1 0.1 0.1 0 0 0 0 0 1 0"),h.setAttributeNS(null,"result","matrixOut"),h=map.Dom.newNode("feMerge",r),r=map.Dom.newNode("feMergeNode",h),r.setAttributeNS(null,"in","matrixOut"),r=map.Dom.newNode("feMergeNode",h),r.setAttributeNS(null,"in","SourceGraphic"),h=map.Dom.getBox(c.lastChild),h.width&&h.height&&c.style.setProperty("filter","url(#"+szShadowFilterId+")",""))}}}}if(this.szFlag.match(/BOX/))if(this.nBoxUpper&&
map.Scale.nTrueMapScale*map.Scale.nZoomScale>this.nBoxUpper)(f=SVGDocument.getElementById(this.szId+":"+D+":chart:box"))&&f.parentNode.removeChild(f);else for(e=0;e<this.indexA.length;e++)if(m=this.indexA[e],this.itemA[m].fDone){var D=this.itemA[m].szSelectionId,c=SVGDocument.getElementById(this.szId+":"+D+":chart"),f=SVGDocument.getElementById(this.szId+":"+D+":chart:box");if(c&&f&&!f.getAttributeNS(szMapNs,"boxed")){h=map.Dom.getBox(c);k=map.Scale.normalX(this.nBoxMargin||2);k=Math.min(2*k,k*(h.width/
map.Scale.normalX(b)));if(this.szFlag.match(/TITLE/)&&this.szTitleField&&(!this.nTitleUpper||map.Scale.nTrueMapScale*map.Scale.nZoomScale<=this.nTitleUpper)){g=Math.max(map.Scale.normalX(.9),Math.min(h.width/6.6,map.Scale.normalX(6)));this.szFlag.match(/GRIDSIZE/)&&(g=Math.max(h.width/10,map.Scale.normalX(6)));B=this.itemA[m].szTitle;try{B=HTMLWindow.ixmaps.htmlgui_onInfoTitle(this.itemA[m].szTitle,this.itemA[m])}catch(C){}B=map.Dom.newText(c,h.x,h.y-1*g,"font-family:arial;font-size:"+g+"px;text-anchor:start;fill:"+
(this.szTextColor||"#888888")+";stroke:none;pointer-events:none;",String(B||" "));this.szFlag.match(/LONGTITLE/)?(h=map.Dom.getBox(c),h.y+=.1*g,h.height-=.1*g):(D=h.height,h.height+=1.8*g,h.y-=h.height-D,map.Dom.setClipRect(B,new box(h.x,h.y-10*g,h.width-g/3,20*g)))}this.szFlag.match(/PLOTX/)&&!this.szFlag.match(/PLOTXY/)?(h.height=map.Scale.normalX(b),h.y=-map.Scale.normalX(b/2),h.width=this.nMax*map.Scale.normalX(1.1*b)/this.nMax*5*(this.nRangeScale||1)):this.szFlag.match(/PLOTY/)&&(D=h.height,
B=h.width,h.width=map.Scale.normalX(b),h.height=this.nMax*map.Scale.normalX(1.1*b)/this.nMax*5*(this.nRangeScale||1),h.x-=(h.width-B)/2,h.y-=(h.height-D)/2);f.setAttributeNS(null,"x",h.x-k);f.setAttributeNS(null,"y",h.y-k);f.setAttributeNS(null,"width",h.width+2*k);f.setAttributeNS(null,"height",h.height+2*k);(this.szFlag.match(/AUTOSIZE/)||this.szFlag.match(/GRIDSIZE/))&&h.width>h.height&&(f.setAttributeNS(null,"y",h.y-k-(h.width-h.height)),f.setAttributeNS(null,"height",h.width+2*k));"undefined"!=
typeof this.nBorderRadius&&(k=Math.min(map.Scale.normalX(this.nBorderRadius),map.Scale.normalX(this.nBorderRadius*(h.width/map.Scale.normalX(b)))),f.setAttributeNS(null,"rx",k),f.setAttributeNS(null,"ry",k));k=map.Scale.normalX(.2*(this.szBorderWidth||1)*(h.width/map.Scale.normalX(b)));f.style.setProperty("stroke-width",k);f.setAttributeNS(szMapNs,"boxed","1")}}this.szItemFilter&&this.szItemFilter.length&&this.filterItems(this.szItemFilter,this.itemFilterOpt);null!=this.markedClass&&this.markClass(this.markedClass,
1);this.isVisible=!0;this.realizeDone();this.fShowProgressBar=!1;this.showInfo();this.szFlag.match(/SHOWSTATISTIC/)&&this.showErrorInfo();this.szFlag.match(/CLIP/)?this.nClipFrames==this.itemA[m].nValuesA.length?this.szXaxisA&&this.szXaxisA[this.nActualFrame]?displayMessage(this.szXaxisA[this.nActualFrame],3E3,"big"):this.szLabelA&&this.szLabelA[this.nActualFrame]&&displayMessage(this.szLabelA[this.nActualFrame],3E3,"big"):(b=this.szXaxisA||this.szLabelA)&&(0==this.nActualFrame?displayMessage(b[0],
3E3,"big"):this.nActualFrame==this.nClipFrames-1?displayMessage(b[1],3E3,"big"):displayMessage(" ... ",3E3,"big")):this.ErrorMessage?(displayMessage(this.ErrorMessage,1E4,"notify"),this.ErrorMessage=null):clearMessage();this.fSorted||(this.fResort=!0,map.Themes.execute());this.szFlag.match(/DECLUTTER/)&&(this.fDeclutter=!0,map.Themes.execute())}else this.unpaintMap(),this.realizeDone();else this.unpaintMap(),this.realizeDone()};
MapTheme.prototype.sortChartObjects=function(){if(!(!this.chartGroup||this.szFlag.match(/NOSRT/)||this.szFlag.match(/NOSIZE/)&&!this.szFlag.match(/3D/)||this.szFlag.match(/EXACT/)&&!this.szFlag.match(/AGGREGATE/)&&!this.szSizeField)){var e=null,b=[],f=this.chartGroup.childNodes;if(this.szFlag.match(/BUBBLE/)||this.szFlag.match(/SQUARE/)||this.szFlag.match(/BUFFER/)||this.szFlag.match(/TEXTONLY/))for(var c=0;c<f.length;c++)e=f.item(c),b[c]={node:e,y:Math.abs(Number(e.getAttributeNS(szMapNs,"value")))};
else for(var h=getRotateAttributeValue(map.Scale.canvasNode)/180*Math.PI,c=0;c<f.length;c++)e=f.item(c),b[c]=h?{node:e,y:getTranslate(e).x*Math.sin(h)+getTranslate(e).y*Math.cos(h)}:{node:e,y:getTranslate(e).y};this.szFlag.match(/SORT/)&&this.szFlag.match(/\|UP/)&&!this.szFlag.match(/SEQUENCE/)?b.sort(this.sortDownChartObjectsCompare):b.sort(this.sortUpChartObjectsCompare);for(c=0;c<b.length;c++)b[c].node.parentNode.appendChild(b[c].node);(matrixA=getMatrix(this.chartGroup))&&setMatrix(this.chartGroup,
matrixA)}};MapTheme.prototype.sortUpChartObjectsCompare=function(e,b){return e.y-b.y};MapTheme.prototype.sortDownChartObjectsCompare=function(e,b){return b.y-e.y};
MapTheme.prototype.getChartSize=function(e,b,f,c){if(f.match(/NOSIZE/))return Math.max(5,b/4);c=Math.abs(c);var h=Math.max(5,b/2),g=this.nMax-this.nMin;this.nNormalSizeValue&&(g=this.nMaxSize=this.nNormalSizeValue);var m=this.itemA[e].nValue100;f.match(/SIZE/)&&!f.match(/NORMSIZE/)&&this.szSizeField&&e&&this.itemA[e]?h=f.match(/LINEAR/)||f.match(/SIZEP1/)?h/this.nMaxSize*this.itemA[e].nSize:f.match(/SIZELOG/)?h/Math.log(this.nMaxSize)*Math.log(this.itemA[e].nSize):f.match(/SIZEP4/)?h/Math.pow(this.nMaxSize,
.25)*Math.pow(this.itemA[e].nSize,.25):f.match(/3D/)||f.match(/SIZEP3/)||f.match(/SIZEVOLUME/)?h/Math.pow(this.nMaxSize,1/3)*Math.pow(this.itemA[e].nSize,1/3):h/Math.sqrt(this.nMaxSize)*Math.sqrt(this.itemA[e].nSize):f.match(/SIZE/)&&!f.match(/NORMSIZE/)&&(h=f.match(/LINEAR/)||f.match(/SIZEP1/)?h/g*c:f.match(/SIZELOG/)?h/Math.log(g)*Math.log(c):f.match(/SIZEP4/)?h/Math.pow(g,.25)*Math.pow(c,.25):f.match(/3D/)||f.match(/SIZEP3/)||f.match(/SIZEVOLUME/)?h/Math.pow(g,1/3)*Math.pow(c,1/3):h/Math.sqrt(g)*
Math.sqrt(c));map.Scale.normalX(10);f.match(/HEIGHT/)&&!f.match(/NORMSIZE/)&&(f.match(/SIZE/)?this.szSizeField&&e&&this.itemA[e]?Math.pow(10/g*this.itemA[e].nSize,1/3):Math.pow(10/g*c,1/3):m&&this.nMax100&&this.nMin100&&f.match(/FRACTION/));f.match(/ZOOM/)&&(this.origSize=h*=map.Scale.nObjectScaling,h=b/10+1*h/Math.log(Math.abs(g))*Math.log(Math.abs(c)),h=Math.min(h,b),h=Math.max(h,b/5));return h};
MapTheme.prototype.checkChartSize=function(e,b,f,c){return this.nChartSizeMin&&!f.match(/ZOOM/)&&this.getChartSize(e,b,f,c)/map.Layer.nObjectScale<this.nChartSizeMin?!1:!0};
MapTheme.prototype.drawChart=function(e,b,f,c,h){var g,m,l=null,q=0,x=0;this.szChartFlag=c;if(b){if(!this.itemA[b])return null;this.itemA[b].fDone=!1;var l=this.itemA[b].nValuesA,q=this.itemA[b].nValue100,x=Math.max(this.nMax,Math.abs(this.nMin)),r=0;if(!this.szFlag.match(/BUFFER/))for(var k=0;k<l.length;k++)isNaN(l[k])&&(l[k]=0),r+=l[k];if(this.szFlag.match(/MORPH/)&&this.szFlag.match(/CLIP/)&&this.nClipFrames){for(var l=[],H=this.itemA[b].nValuesA,k=0;k<H.length/2;k++){var w=H[k]*(this.nClipFrames-
1-this.nActualFrame)/(this.nClipFrames-1)+H[k+H.length/2]*this.nActualFrame/(this.nClipFrames-1);l[k]=w}for(k=r=0;k<l.length;k++)isNaN(l[k])&&(l[k]=0),r+=l[k]}if(c.match(/NOPE/))return new point(0,0);if(c.match(/DOT/)){var B=1,w=l[0];if(c.match(/EXACT/))this.chart.szColor=this.colorScheme[w];else if(2<this.colorScheme.length||this.szRanges&&this.szRanges.length)for(lb=!1,k=0;k<this.partsA.length;k++)if(w<this.partsA[k].max){this.chart.szColor=this.colorScheme[k];var D=__maptheme_getChartColors(A);
c.match(/NOLINES/)?this.chart.szLineColor="none":this.chart.szLineColor=D.textColor;c.match(/RANGE/)&&!c.match(/RANGES/)&&(B=map.Scale.normalX(2+5*(k+1)/this.partsA.length));R=k;lb=!0;break}F=map.Dom.newShape("circle",e,0,0,map.Scale.normalX(3),"fill:"+this.chart.szColor+";stroke:none;");return new point(0,0)}}else{l=[];r=0;if(this.szOrigFlag.match(/AGGREGATE/)&&this.szOrigFlag.match(/EXACT/))for(k=0;k<this.colorScheme.length;k++)l[k]=this.nOrigSumA[k],x=Math.max(x,this.nOrigSumA[k]),r+=l[k];else for(k=
0;k<this.szFieldsA.length;k++)l[k]=this.nOrigSumA[k],x=Math.max(x,this.nOrigSumA[k]),r+=l[k];if(q=this.nSum100){x=0;r=q;for(k=l.length-1;0<=k;k--)this.szFlag.match(/DIFFERENCE/)?q=0<k?l[k-1]:this.nSum100:this.szFlag.match(/CALCVAL/)||this.szFlag.match(/CALC100/)?l[k]=l[k]:this.szFlag.match(/PRODUCT/)?l[k]=l[k]:(l[k]/=q,x=Math.max(x,l[k]),this.szFlag.match(/PERMILLE/)?l[k]*=1E3:this.szFlag.match(/FRACTION/)||(l[k]*=100),this.szFlag.match(/RELATIVE/)&&(l[k]-=100),this.szFlag.match(/INVERT/)&&(l[k]=
100-l[k]));if(this.szFlag.match(/STACKED/)){if(x=100,this.szFlag.match(/NORMSIZE/)||c.match(/NORMSIZE/))for(k=x=0;k<l.length;k++)x+=l[k]}else x*=100,x+=x/10,x=this.nMax}else{if(this.szFlag.match(/DIFFERENCE/))for(k=l.length-1;0<=k;k--)0<k?l[k]-=l[k-1]:this.szFlag.match(/STACKED/)||(l[k]=0);if(this.szAggregation&&this.szAggregation.match(/mean/)){for(k=0;k<l.length;k++)l[k]/=this.nCount;x=this.szFlag.match(/MENUSIZE/)?x/this.nCount:this.nMax}if(this.szFlag.match(/STACKED/)&&(this.szFlag.match(/NORMSIZE/)||
c.match(/NORMSIZE/)||this.szFlag.match(/MENUSIZE/)||c.match(/MENUSIZE/)))for(k=x=0;k<l.length;k++)x+=l[k]}}B=b?this.getChartSize(b,f,c,r):1;if(this.nChartSizeMin&&!c.match(/ZOOM/)){if(B/map.Layer.nObjectScale<this.nChartSizeMin)return null}else if(!this.szFlag.match(/MULTIFIX/)&&!this.szFlag.match(/MULTIGRID/)&&(isNaN(B)||0==B))return null;var C=new point(0,0);if(!c)c=this.szFlag;else if(!c.match(/CHART/)&&c.match(/VALUES/)||c.match(/NORMSIZE/)||c.match(/MENUSIZE/))c=this.szFlag+"|"+c;c.match(/DOMINANT/)&&
!c.match(/CHART/)&&(c=c.match(/PERCENTOFMEAN/)?"BAR|OFFSETMEAN|POINTER|VALUES|ZOOM":c.match(/PERCENTOFMEDIAN/)?"BAR|OFFSETMEDIAN|POINTER|VALUES|ZOOM":c.match(/DEVIATION/)?"BAR|DEVIATION|POINTER|VALUES|ZOOM":"BAR|3D|VALUES|ZOOM");c.match(/ZOOM/)&&c.match(/BAR/)&&c.match(/POINTER/)&&1<l.length&&(c=this.removeDefinition(c,"SIZE")+"|COMPRESSMAX");if(1==l.length&&0==l[0]&&!c.match(/ZEROISVALUE/)&&!c.match(/EXACT/))return this.nZeroValueCount++,null;c.match(/VALUES/)&&(this.fHideValues=this.szValueUpper&&
map.Scale.nTrueMapScale*map.Scale.nZoomScale>this.nValueUpper);g=map.Dom.newGroup(e,this.szId+":"+b+(b?":chartgroup":":ochrtgroup"));var y=null,K=null;c.match(/MOVABLE/)&&(g.setAttributeNS(null,"id",g.getAttributeNS(null,"id")+":movable"),g.setAttributeNS(null,"onmousedown",'map.Themes.initChartOffset(evt,"'+this.szId+'","'+this.szId+":"+b+':chartgroup:movable")'),g.setAttributeNS(null,"onmouseup",'map.Themes.endChartOffset(evt,"'+this.szId+'","'+this.szId+":"+b+':chartgroup:movable")'));if(c.match(/CHOROPLETH/)){var E=
map.Scale.normalX(f/2),u=2*E/3,A=this.colorScheme[0],I=this.colorScheme[1]?this.colorScheme[1]:"none";m=map.Scale.normalX(.1)*map.Scale.nFeatureScaling*map.Scale.nObjectScaling;var F=map.Dom.constructNode("use",g,{"xlink:href":"#choropleth_icon"});F.fu.scale(2,2);f=2*u/map.Scale.normalX(1);C.x=0;C.y=u+map.Scale.normalY(5)}if(c.match(/BLANK/))return null;if(c.match(/USER/))try{u=map.Scale.normalX(f);c.match(/GRIDSIZE/)&&(u=this.nGridSize);var u=.97*u,ma=this.objThemesA[this.szThemesA[0]],Ga=HTMLWindow.ixmaps.htmlgui_drawChart(SVGDocument,
{target:g,theme:this,item:this.itemA[b],values:l,maxSize:u,flag:c,mark:h,dbRecord:ma.dbRecords?ma.dbRecords[this.itemA[b].dbIndex]:null});if(Ga)return g.fu.setPosition(g.fu.getPosition().x-Ga.x,g.fu.getPosition().y-Ga.y),Ga.x=0,Ga.y=0,Ga}catch(fd){}if(c.match(/PIE/)){if(0==r&&!c.match(/AUTOCOMPLETE/))return null;if(c.match(/SORT/)){this.sortedIndex=[];for(k=0;k<l.length;k++)this.sortedIndex[k]={index:k,value:l[k]};this.sortedIndex.sort(this.sortIndexDown)}else this.sortedIndex=null;if(c.match(/CENTER/)){for(var dc=
this.nCenter=0,zc=-3E7,Ac=3E7,oa=0;oa<(this.nClipParts||l.length);oa++){var ea=this.sortedIndex?this.sortedIndex[oa].index:oa,dc=dc+l[ea];l[ea]<Ac&&(Ac=l[ea],this.nCenterMin=ea);l[ea]>zc&&(zc=l[ea],this.nCenterMax=ea)}this.szCenterPart=this.szCenterPart||"max","first"==this.szCenterPart?this.nCenter=0:"last"==this.szCenterPart?this.nCenter=l.length-1:"min"==this.szCenterPart?this.nCenter=this.nCenterMin:"max"==this.szCenterPart?this.nCenter=this.nCenterMax:Number(this.szCenterPart)&&(this.nCenter=
Number(this.szCenterPart));this.nCenterValue=l[this.nCenter];this.nCenterSize=this.nCenterValue/dc*100}var pa=0,B=Math.max(5,f/2),va=this.nMax-this.nMin,Lb=this.nMax100-this.nMin100;this.nNormalSizeValue&&(va=Lb=this.nMaxSize=this.nNormalSizeValue);c.match(/GRIDSIZE/)&&!c.match(/NORMSIZE/)?B=this.nGridSize/f*(c.match(/RECT/)?.72:.6):c.match(/SIZE/)&&!c.match(/NORMSIZE/)&&this.szSizeField&&b&&this.itemA[b]?B=c.match(/SIZELOG/)?B/Math.log(this.nMaxSize)*Math.log(this.itemA[b].nSize):c.match(/SIZEP4/)?
B/Math.pow(this.nMaxSize,.25)*Math.pow(this.itemA[b].nSize,.25):c.match(/3D/)||c.match(/SIZEP3/)||c.match(/SIZEVOLUME/)?B/Math.pow(this.nMaxSize,1/3)*Math.pow(this.itemA[b].nSize,1/3):B/Math.sqrt(this.nMaxSize)*Math.sqrt(this.itemA[b].nSize):c.match(/SIZE/)&&!c.match(/NORMSIZE/)&&(B=c.match(/SIZELOG/)?B/Math.log(va)*Math.log(r):c.match(/SIZEP4/)?B/Math.pow(va,.25)*Math.pow(r,.25):c.match(/3D/)||c.match(/SIZEP3/)||c.match(/SIZEVOLUME/)?B/Math.pow(va,1/3)*Math.pow(r,1/3):B/Math.sqrt(va)*Math.sqrt(r));
pa=map.Scale.normalX(10);c.match(/HEIGHT/)&&!c.match(/NORMSIZE/)&&(pa=c.match(/SIZE/)?this.szSizeField&&b&&this.itemA[b]?pa*Math.pow(10/va*this.itemA[b].nSize,1/3)*3:pa*Math.pow(10/va*r,1/3)*3:q&&this.nMax100&&this.nMin100&&!c.match(/FRACTION/)?10*pa/Lb*q:10*pa/va*r);c.match(/ZOOM/)&&(this.origSize=B*=map.Scale.nObjectScaling,B=f/10+3*B/Math.log(va)*Math.log(r)*map.Layer.nDynamicObjectScale,B=Math.min(B,1.2*f),B=Math.max(B,f/2));var U=DonutCharts.newChart(SVGDocument,g,0,0,map.Scale.normalX(B),0);
C.x=0;C.y=map.Scale.normalY(B)+map.Scale.normalY(5);U.setStyle("flat");U.setLine("#555566");U.setLineWidth(map.Scale.normalX(.1));c.match(/NOLINES/)&&U.setLine("none");c.match(/WHITELINES/)&&U.setLine("white");this.szLineColor&&U.setLine(this.szLineColor);if(c.match(/3D/)){U.setStyle("3D");var fa=.5;c.match(/P3/)?fa=1/3:c.match(/P4/)&&(fa=.25);c.match(/SIZE/)&&!c.match(/NORMSIZE/)&&this.szSizeField&&b&&this.itemA[b]?pa=pa/Math.pow(this.nMaxSize,fa)*Math.pow(this.itemA[b].nSize,fa):c.match(/SIZE/)&&
!c.match(/NORMSIZE/)&&(pa=pa/Math.pow(va,fa)*Math.pow(r,fa));c.match(/ZOOM/)&&(pa*=map.Scale.nObjectScaling,pa=pa/this.origSize*B);C.y*=.7}c.match(/VOLUME/)&&U.addStyle("VOLUME");if(c.match(/CENTER/)){var Qc=Math.sqrt(Math.pow(map.Scale.normalX(B),2)/100*this.nCenterSize);U.setRadInner(Qc)}else c.match(/DONUT/)&&(c.match(/3D/)?U.setRadInner(map.Scale.normalX(.5*B)):c.match(/THIN/)?U.setRadInner(map.Scale.normalX(.66*B)):c.match(/THICK/)?U.setRadInner(map.Scale.normalX(.33*B)):U.setRadInner(map.Scale.normalX(.42*
B)));c.match(/STARBURST/)&&(U.addStyle("STARBURST"),C.y*=.8);if(c.match(/XSFLOWER/)||c.match(/XSRAYS/))U.addStyle("XSRAYS"),C.y*=.8;else if(c.match(/SFLOWER/)||c.match(/SRAYS/))U.addStyle("SRAYS"),C.y*=.8;else if(c.match(/FLOWER/)||c.match(/RAYS/))U.addStyle("RAYS"),C.y*=.8;c.match(/SILENT/)&&U.addStyle("SILENT");c.match(/AUTOCOMPLETE/)&&U.addStyle("AUTOCOMPLETE");c.match(/BIGTOTOP/)&&U.addStyle("BIGTOTOP");c.match(/NOROTATE/)&&U.addStyle("NOROTATE");c.match(/ROTATE/)&&U.addStyle("ROTATE");c.match(/SYMMETRIC/)&&
U.addStyle("SYMMETRIC");c.match(/HALF/)&&(U.addStyle("HALF"),U.addStyle("NOROTATE"));var Na=0,Bc=0,N=0;if(c.match(/DONUT/))for(k=0;k<l.length;k++)l[k]>l[Na]&&(Na=k),l[k]<l[Bc]&&(Bc=k);for(k=0;k<(this.nClipParts?Math.min(this.nClipParts,l.length):l.length);k++){var la="",ea=k;this.sortedIndex&&(ea=this.sortedIndex[ea].index);if(!c.match(/CENTER/)||ea!=this.nCenter){la=this.szLabelA&&this.szLabelA[ea]?"  "+this.szLabelA[ea]:"  "+this.szFieldsA[ea];A=this.colorScheme[ea];if(1==l.length)for(xa=0;xa<this.partsA.length;xa++)if(c.match(/EXACT/)&&
l[ea]==this.partsA[xa].min||!c.match(/EXACT/)&&l[ea]<this.partsA[xa].max){A=this.colorScheme[xa];e.setAttributeNS(szMapNs,"class",String(xa));break}var Cc=(c.match(/AUTOCOMPLETE/)&&!this.szUnit.match(/%/)?" % ":"")+this.szUnit;if(this.szShowParts){var Rc=A,A="none";for(oa in this.szShowPartsA)this.szShowPartsA[oa]==ea&&(A=Rc)}l[ea]&&(U.addPart(l[ea],pa,A,0,(this.szAggregation&&this.szAggregation.match(/sum/),this.formatValue(l[ea],this.szValueDecimals||0,"ROUND")+Cc),this.formatValue(l[ea],2)+Cc+
la).nClass=ea);"none"==this.colorScheme[k]&&U.setLine(this.szLineColor||"black")}}U.realize();if(c.match(/CENTER/)&&!c.match(/DONUT/)){var u=Math.sqrt(Math.pow(map.Scale.normalX(B),2)/100*this.nCenterSize),A=this.colorScheme[this.nCenter],Dc=map.Dom.newShape("circle",g,0,0,.95*u,"fill:"+A+";");Dc.setAttributeNS(szMapNs,"class",String(this.nCenter));Dc.setAttributeNS(szMapNs,"tooltip",this.szLabelA?this.szLabelA[this.nCenter]+": "+l[this.nCenter]+this.szUnit+"":l[this.nCenter]+this.szUnit);if(c.match(/CENTERVALUE/)||
c.match(/ZOOM/)||c.match(/VALUES/)&&!this.fHideValues){var X=this.formatValue(this.nCenterValue,this.szValueDecimals||0,"ROUND")+(5>=this.szUnit.length?this.szUnit:""),D=__maptheme_getChartColors(A),Ba=D.textColor,Y=String(Math.min(.8*u,3.5/X.length*u));map.Dom.newText(g,0,.33*Y,"font-family:arial;font-size:"+Y+"px;font-weight:bold;text-anchor:middle;fill:"+Ba+";opacity:"+String(this.nOpacity?this.nOpacity:1)+";stroke:none;pointer-events:none",X).setAttributeNS(szMapNs,"class",String(this.nCenter))}}if(c.match(/VALUES/)&&
(c.match(/ZOOM/)||!this.szValueUpper||map.Scale.nTrueMapScale*map.Scale.nZoomScale<=this.nValueUpper))if(Y=Math.min(.8*B,3.4/U.partsA[0].szText.length*B),1<l.length||c.match(/NOINLINETEXT/)||c.match(/ZOOM/)&&6>Y)this.drawDonutText(U,map.Scale.normalX(11)/(c.match(/ZOOM/)||c.match(/NORMSIZE/)?1.6:2));else{var X=U.partsA[0].szText,D=__maptheme_getChartColors(A),Ba=this.szTextColor||D.textColor,u=map.Scale.normalX(B),Y=String(Math.min(.8*u,3.4/X.length*u)),wa=this.nValueSizeMin?Y/map.Scale.normalX(5):
1;c.match(/VOLUME/)&&(pa=U.donutPartsA[0].nHeight);c.match(/3D/)||(pa=.6*u);var J=map.Dom.newText(g,0,-pa+u/2+.45*Y,"font-family:arial;font-size:"+Y+"px;text-anchor:middle;fill:"+Ba+";opacity:"+wa+";stroke:none;pointer-events:none",X);c.match(/3D/)&&(J.fu.setPosition(0,-u/2+Y*(c.match(/VOLUME/)?.5:.25)),J.fu.scale(1,.5))}this.fillOpacity&&g.setAttributeNS(null,"opacity",String(this.fillOpacity));this.nOpacity&&(g.setAttributeNS(null,"fill-opacity",String(this.nOpacity)),g.setAttributeNS(null,"stroke-opacity",
String(this.nOpacity)));if(c.match(/FADEDEVIATION/)){var Mb=(l[0]-this.nMeanA[0])/this.nDeviationA[0];10<Mb&&(wa=Math.pow(10,.5)/Math.pow(Mb,.5),g.setAttributeNS(null,"opacity",String(wa)))}else c.match(/LIMITDEVIATION/)&&(Mb=(l[0]-this.nMeanA[0])/this.nDeviationA[0],10<Mb&&g.setAttributeNS(null,"opacity","0"));if(1==l.length&&c.match(/EXACT/))U.donutPartsA[0].objNode.setAttributeNS(szMapNs,"class",e.getAttributeNS(szMapNs,"class")),U.donutPartsA[0].textNode&&U.donutPartsA[0].textNode.setAttributeNS(szMapNs,
"class",e.getAttributeNS(szMapNs,"class"));else for(k=0;k<U.donutPartsA.length;k++)U.donutPartsA[k].objNode.setAttributeNS(szMapNs,"class",String(U.partsA[k].nClass)),U.donutPartsA[k].textNode&&U.donutPartsA[k].textNode.setAttributeNS(szMapNs,"class",String(U.partsA[k].nClass));this.nRealizedCount++}else if(c.match(/WAFFLE/)){var ga=map.Scale.normalX(f);if(c.match(/GRIDSIZE/))ga=1.05*this.nGridSize;else if(c.match(/AUTOSIZE/))var Ia=map.Layer.nDynamicObjectScale,Ja=c.match(/RECT/)?c.match(/GAP/)?
2.3:2:c.match(/GAP/)?1.7:1.6,N=Math.max($a,this.nMax),ga=this.nGridWidthPx?map.Scale.normalX(this.nGridWidthPx)/Ja/Ia:this.nGridWidth?map.Scale.getDeltaXofDistanceInMeter(this.nGridWidth)/Ja/Ia:E,ga=ga/Math.sqrt(this.nMaxSize)*Math.sqrt(this.itemA[b].nSize);ga*=.97;F=map.Dom.newShape("rect",g,-(ga/2)+10,-(ga/2)+10,ga-20,ga-20,"fill:"+(this.szBoxColor||"back")+";stroke:"+(this.szBorderColor||"none")+";stroke-width:"+(this.szBorderWidth||2)+";fill-opacity:"+(this.nBoxOpacity||.05)+";opacity:1;");ga*=
.9;if(c.match(/SORT/)){this.sortedIndex=[];for(k=0;k<l.length;k++)this.sortedIndex[k]={index:k,value:l[k]};this.sortedIndex.sort(this.sortIndexDown)}else this.sortedIndex=null;var x=Math.max(this.nMax,Math.abs(this.nMin)),ec=this.nGridX||(c.match(/WAFFLE100/)?10:Math.max(5,Math.round(Math.sqrt(x))));c.match(/AUTO100/)&&(ec=10);for(var zb=ga/(1.1*ec),xa=-ga/2,mb=ga/2,Ec=0,k=0;k<l.length;k++){var Oa=this.sortedIndex?this.sortedIndex[k].index:k;l[Oa]=Math.round(l[Oa]);if(l[Oa])for(ii=0;ii<l[Oa];ii++)F=
map.Dom.newShape("rect",g,xa,mb-zb,zb,zb,"fill:"+this.colorScheme[Oa]+";stroke:null;fill-opacity:"+(this.fillOpacity||1)+";opacity:"+(this.nOpacity||1)+";"),F.setAttributeNS(szMapNs,"class",String(Oa)),F.setAttributeNS(szMapNs,"tooltip",this.szLabelA?this.szLabelA[Oa]+": "+l[Oa]+this.szUnit+"":l[Oa]+this.szUnit),xa+=1.1*zb,++Ec>=ec&&(xa=-ga/2,mb-=1.1*zb,Ec=0)}this.nRealizedCount++}else if(c.match(/BUBBLE/)||c.match(/SQUARE/)||c.match(/LABEL/)){E=map.Scale.normalX(f/2);c.match(/AUTOSIZE/)&&(Ia=map.Layer.nDynamicObjectScale,
Ja=c.match(/RECT/)?c.match(/GAP/)?2.3:2:c.match(/GAP/)?1.7:1.6,N=Math.max($a,this.nMax),E=this.nGridWidthPx?map.Scale.normalX(this.nGridWidthPx)/Ja/Ia:this.nGridWidth?map.Scale.getDeltaXofDistanceInMeter(this.nGridWidth)/Ja/Ia:E);N=Math.max(this.nMax,this.nMaxA[0]);this.nNormalSizeValue&&(this.nMaxSize=N=this.nNormalSizeValue);w=l[0];if(this.szFlag.match(/CLIP/)&&!this.szFlag.match(/MORPH/)&&this.nClipFrames&&(this.nClipFrames==l.length?(w=Number(l[this.nActualFrame]),N=this.nNormalSizeValue||this.nMaxA[this.nActualFrame]):
w=l[0]*(this.nClipFrames-1-this.nActualFrame)/(this.nClipFrames-1)+l[l.length-1]*this.nActualFrame/(this.nClipFrames-1),0==w&&!c.match(/ZEROISVALUE/))||c.match(/INVERTSIZE/)&&0==N-l[0]&&!c.match(/ZEROISVALUE/))return null;var qb=b&&this.itemA[b]&&this.szSizeField?this.itemA[b].nSize||0:w,rb=b&&this.itemA[b]&&this.szSizeField?this.nMaxSize:N,u=c.match(/MENUSIZE/)?map.Scale.normalX(f/2.5):c.match(/LINEAR/)||c.match(/SIZEP1/)?E/rb*Math.abs(qb):c.match(/SIZEP3/)?E/Math.pow(rb,1/3)*Math.pow(Math.abs(qb),
1/3):c.match(/SIZEP4/)?E/Math.pow(rb,.25)*Math.pow(Math.abs(qb),.25):c.match(/SIZELOG/)?E/Math.log(rb)*Math.log(Math.abs(qb)):c.match(/EXACT/)&&!this.szSizeField?E/3/(this.nNormalSizeValue||1):c.match(/NOSIZE/)?E/2:c.match(/FIXSIZE/)?E/2/(this.nNormalSizeValue||1):c.match(/ZOOM/)?3*E/3:c.match(/NORMSIZE/)?2*E/3/(c.match(/EXACT/)?1:Math.log(rb)*Math.log(Math.abs(qb))):c.match(/MENUSIZE/)||c.match(/SUM/)&&!b?2*E/3:E/Math.sqrt(rb)*Math.sqrt(Math.abs(qb)),lb=!0,R=null,ka=F=null,sb=null,Nb=null,Pa=J=null,
A=this.colorScheme[0],Ba=I=this.colorScheme[1]?this.colorScheme[1]:"none";if(2<this.colorScheme.length||c.match(/EXACT/))A=this.colorScheme[this.colorScheme.length-1],I=this.colorScheme[0];c.match(/NOLINES/)?I="none":"none"==I&&(D=__maptheme_getChartColors(A),I=D.textColor);if(c.match(/EXACT/))R=w-1,A=this.colorScheme[R],D=__maptheme_getChartColors(A),I=c.match(/NOLINES/)?"none":D.textColor,c.match(/RANGE/)&&!c.match(/RANGES/)&&(u=map.Scale.normalX(2+5*(k+1)/this.partsA.length)),lb=!0;else if(2<this.colorScheme.length||
this.szRanges&&this.szRanges.length)if(lb=!1,this.szFlag.match(/DOMINANT/)){for(var Ca=0,Ab=0,M=-1,k=0;k<this.itemA[b].nValuesA.length;k++){var w=this.itemA[b].nValuesA[k],fc=100/this.nMeanA[k]*w,gc=100/this.nMedianA[k]*w,hc=(w-this.nMeanA[k])/this.nDeviationA[k],Ca=w;this.szFlag.match(/PERCENTOFMEAN/)&&(Ca=fc);this.szFlag.match(/PERCENTOFMEDIAN/)&&(Ca=gc);this.szFlag.match(/DEVIATION/)&&(Ca=hc);w>this.nFilterA[k]&&Ca>Ab&&(this.itemA[b].nClass=k,Ab=Ca,M=k)}if(0<=M){this.itemA[b].nDominant=M;w=this.itemA[b].nValuesA[M];
la=" "+this.szFieldsA[M]+" ";this.szLabelA&&this.szLabelA[M]&&(la=" "+this.szLabelA[M]+" ");if(this.szFlag.match(/PERCENTOFMEAN/)||this.szFlag.match(/DEVIATION/))szRelevanz=map.Dictionary.getLocalText(" ( mean: ")+this.formatValue(this.nMeanA[M],1)+this.szUnit+")";this.szFlag.match(/PERCENTOFMEDIAN/)&&(szRelevanz=map.Dictionary.getLocalText(" ( median: ")+this.formatValue(this.nMedianA[M],1)+this.szUnit+")");this.itemA[b].nValue=this.itemA[b].nValuesA[M];this.itemA[b].szLabel=la;A=this.colorScheme[M];
D=__maptheme_getChartColors(A);I=c.match(/NOLINES/)?"none":D.textColor;R=M;lb=!0}}else for(k=0;k<this.partsA.length;k++)if(w>=this.partsA[k].min&&w<this.partsA[k].max){A=this.colorScheme[k];D=__maptheme_getChartColors(A);I=c.match(/NOLINES/)?"none":D.textColor;c.match(/RANGE/)&&!c.match(/RANGES/)&&(u=map.Scale.normalX(2+5*(k+1)/this.partsA.length));R=k;lb=!0;break}Ba=this.szTextColor||I;I=this.szLineColor||I;if(lb){m=this.nLineWidth||.1;m=c.match(/OUTLINE/)?map.Scale.normalX(Math.min(1,1/E*u)):map.Scale.normalX(m/
E*u);if(c.match(/BUBBLE/))c.match(/GLOW/)&&!c.match(/ZOOM/)&&this.fGlowInScale?((F=map.Dom.newShape("circle",g,0,0,6*u,"fill:"+A+";stroke:none;fill-opacity:0.05;pointer-events:none;"))&&F.setAttributeNS(szMapNs,"class",String(R)),(F=map.Dom.newShape("circle",g,0,0,2*u,"fill:"+A+";stroke:none;fill-opacity:0.1;pointer-events:none;"))&&F.setAttributeNS(szMapNs,"class",String(R))):c.match(/AURA/)&&!c.match(/ZOOM/)&&this.fGlowInScale&&(F=map.Dom.newShape("circle",g,0,0,1.3*u,"fill:"+(this.szLineColor||
A)+";stroke:none;fill-opacity:0.3;"))&&F.setAttributeNS(szMapNs,"class",String(R)),F=map.Dom.newShape("circle",g,0,0,u,"fill:"+A+";stroke:"+I+";stroke-width:"+m+";");else if(c.match(/SQUARE/))F=map.Dom.newShape("rect",g,-u,-u,2*u,2*u,"fill:"+A+";stroke:"+I+";stroke-width:"+m+";");else if(c.match(/TEXTONLY/))F=map.Dom.newShape("rect",g,-u,-8,2.05*u,8,"fill:none;stroke:none;");else if(c.match(/LABEL/)){X=this.formatValue(w,this.szValueDecimals||(1>w||1>=N?1:0),"ROUND")+(5>=this.szUnit.length?this.szUnit:
"");0<w&&(this.szFlag.match(/DIFFERENCE/)||this.szFlag.match(/RELATIVE/))&&(X="+"+X);var tb=Math.min(.8*u,3.4/X.length*u);if(!this.fShadow&&this.fOrigShadow&&u>map.Scale.normalX(5)){if(F=map.Dom.newShape("rect",g,-u+.02*u,.83*-tb+.02*u,2.05*u,1.6*tb,"fill:#000000;stroke:none;opacity:"+.4*(this.fillOpacity?this.fillOpacity:1)))F.setAttributeNS(null,"rx",map.Scale.normalX(2*u/E)),F.setAttributeNS(null,"ry",map.Scale.normalX(2*u/E));if(F=map.Dom.newShape("rect",g,-u+.03*u,.83*-tb+.03*u,2.05*u,1.6*tb,
"fill:"+A+";stroke:none;opacity:"+.2*(this.fillOpacity?this.fillOpacity:1)))F.setAttributeNS(null,"rx",map.Scale.normalX(2*u/E)),F.setAttributeNS(null,"ry",map.Scale.normalX(2*u/E))}if(F=map.Dom.newShape("rect",g,-u,.83*-tb,2.05*u,1.6*tb,"fill:"+A+";stroke:"+I+";stroke-width:"+m+";"))F.setAttributeNS(null,"rx",map.Scale.normalX(2*u/E)),F.setAttributeNS(null,"ry",map.Scale.normalX(2*u/E))}if(F){c.match(/SILENT/)||(c.match(/EXACT/)&&this.szLabelA&&this.szLabelA[k]?F.setAttributeNS(szMapNs,"tooltip",
this.szLabelA[k]+" "+this.szTitle+""):F.setAttributeNS(szMapNs,"tooltip",this.formatValue(w,2)+this.szUnit+" "+this.szTitle+""));J=null;if(c.match(/VALUES/)&&(!this.szValueUpper||map.Scale.nTrueMapScale*map.Scale.nZoomScale<=this.nValueUpper))if(X=null,this.szValueField&&this.itemA[b]?X=this.formatValue(this.itemA[b].szValue,this.szValueDecimals||(1>this.itemA[b].szValue?1:0),"ROUND")+(5>=this.szUnit.length?this.szUnit:""):c.match(/EXACT/)&&this.szLabelA?X=this.szLabelA[w-1]||"?":(X=this.formatValue(w,
this.szValueDecimals||(1>w||1>=N?1:0),"ROUND")+(5>=this.szUnit.length?this.szUnit:""),0<w&&(this.szFlag.match(/DIFFERENCE/)||this.szFlag.match(/RELATIVE/))&&(X="+"+X)),Y=String(Math.min(.8*u,3.3/X.length*u)),c.match(/TEXTONLY/)){D=__maptheme_getChartColors(A);Ba=D.textColor;Y=String(Math.max(Math.min(.8*u,map.Scale.normalX(500)),map.Scale.normalX(2)));if(this.nValueSizeMin&&!c.match(/ZOOM/)&&Y*map.Layer.nDynamicObjectScale<map.Scale.normalX(this.nValueSizeMin))return null;var Bb=this.szTextFont||
"arial",Pa=map.Dom.newText(g,0,0,"font-family:"+Bb+";font-size:"+Y+"px;font-weight:normal;text-anchor:middle;fill:none;stroke:"+A+";stroke-width:"+Y/7+";stroke-opacity:0.5;pointer-events:none;stroke-linejoin:bevel;",X);Pa.setAttributeNS(null,"id",this.szId+":"+b+":text:bg");J=map.Dom.newText(g,0,0,"font-family:"+Bb+";font-size:"+Y+"px;font-weight:normal;text-anchor:middle;fill:"+(this.szTextColor||"#000000")+";opacity:"+wa+";stroke:none;",X);J.setAttributeNS(null,"id",this.szId+":"+b+":text");F.parentNode.removeChild(F)}else if(c.match(/ZOOM/)&&
Y<map.Scale.normalX(6))Ba="black",J=map.Dom.newText(g,u+.1*E,-u/2,this.szValuesTextStyle,X);else if(c.match(/LABEL/)||Y>map.Scale.normalX(1))wa=this.nValueSizeMin?Y/map.Scale.normalX(5):1,J=map.Dom.newText(g,0,.33*Y,"font-family:arial;font-size:"+Y+"px;font-weight:bold;text-anchor:middle;fill:"+Ba+";opacity:"+wa+";stroke:none;pointer-events:none",X);if(c.match(/DTEXT/)&&b&&!c.match(/ZOOM/)){var Qa=Math.pow(Math.abs(u),1/3)/Math.pow(E,1/3);F.style.setProperty("fill-opacity",String(Qa),"");F.style.setProperty("stroke-opacity",
String(Qa),"");J&&J.style.setProperty("fill-opacity",String(Qa),"")}else F.style.setProperty("fill-opacity",String(this.fillOpacity?this.fillOpacity:1),""),c.match(/OUTLINE/)||this.szLineColor?F.style.setProperty("stroke-opacity","1",""):F.style.setProperty("stroke-opacity",String(this.fillOpacity&&.5>this.fillOpacity?1:.3),"")}null!=R&&(F&&(F.setAttributeNS(szMapNs,"value",String(w)),F.setAttributeNS(szMapNs,"class",String(R))),J&&(J.setAttributeNS(szMapNs,"value",String(w)),J.setAttributeNS(szMapNs,
"class",String(R))),Pa&&(Pa.setAttributeNS(szMapNs,"value",String(w)),Pa.setAttributeNS(szMapNs,"class",String(R))));f=2*u/map.Scale.normalX(1);C.x=0;C.y=u+map.Scale.normalY(5);this.nRealizedCount++}else return this.nMissingRangeCount++,null}else if(c.match(/SYMBOL/)){if("undefined"!=typeof this.szSymbolBoxStyle){I="#dddddd";"undefined"!=typeof this.szBorderColor&&(I=this.szBorderColor);var Cb="stroke-width:0;";if("undefined"!=typeof this.szBorderStyle)switch(this.szBorderStyle){case "dotted":Cb=
"stroke-width:"+map.Scale.normalX(1)+";stroke-linecap:round;stroke-dasharray:1,50;";break;case "dashed":Cb="stroke-width:"+map.Scale.normalX(1)+";stroke-linecap:butt;stroke-dasharray:30,30;";break;case "solid":Cb="stroke-width:"+map.Scale.normalX(1)+";";break;case "none":Cb="stroke-width:0;"}var nb=map.Dom.newShape("rect",g,0,0,1,1,"fill:white;stroke:"+I+";"+Cb);switch(this.szSymbolBoxStyle){case "frame":nb.setAttributeNS(null,"fill-opacity",0);break;case "field":nb.setAttributeNS(null,"fill-opacity",
1)}}if(!this.szSymbolsA)for(this.szSymbolsA=[],k=0;k<l.length;k++)this.szSymbolsA.push("circle");else if(this.szSymbolsA.length<l.length)for(k=this.szSymbolsA.length;k<l.length;k++)this.szSymbolsA.push(this.szSymbolsA[this.szSymbolsA.length-1]);var Ra=null;c.match(/VALUES/)&&(Ra=map.Dom.newGroup(g,this.szId+":"+b+":textgroup"));this.initAngle=0;if(c.match(/SORT/))if(c.match(/MEAN/)){this.sortedIndex=[];for(k=this.sortedMax=0;k<l.length;k++)this.sortedIndex[k]={index:k,value:l[k],tvalue:l[k],mean:this.nMeanA[k]},
this.sortedMax=Math.max(this.sortedMax,l[k]);this.sortedIndex.sort(this.sortMeanUp);this.initAngle=0}else if(c.match(/MEDIAN/)){this.sortedIndex=[];for(k=this.sortedMax=0;k<l.length;k++)this.sortedIndex[k]={index:k,value:l[k],tvalue:l[k],mean:this.nMedianA[k]},this.sortedMax=Math.max(this.sortedMax,l[k]);this.sortedIndex.sort(this.sortMeanUp);this.initAngle=0}else if(c.match(/\|UP/)){this.sortedIndex=[];for(k=this.sortedMax=0;k<l.length;k++)this.sortedIndex[k]={index:k,value:l[k],tvalue:l[k]},this.sortedMax=
Math.max(this.sortedMax,l[k]);this.sortedIndex.sort(this.sortIndexUp);this.initAngle=0}else if(c.match(/DOWN/)){this.sortedIndex=[];for(k=this.sortedMax=0;k<l.length;k++)this.sortedIndex[k]={index:k,value:l[k],tvalue:l[k]},this.sortedMax=Math.max(this.sortedMax,l[k]);this.sortedIndex.sort(this.sortIndexDown);this.initAngle=0}else{if(c.match(/RANDOM/)){this.sortedIndex=[];this.sortedMax=0;if(this.nClipParts&&this.nClipParts<l.length){for(var ic=[],k=0;k<l.length;k++)ic[k]={index:k,value:l[k],tvalue:l[k]};
ic.sort(this.sortIndexDown);for(k=0;k<this.nClipParts;k++){var jc=ic[k].index;this.sortedIndex[k]={index:jc,value:l[jc],tvalue:l[jc]};this.sortedMax=Math.max(this.sortedMax,l[k])}}else for(k=0;k<l.length;k++)this.sortedIndex[k]={index:k,value:l[k],tvalue:l[k]},this.sortedMax=Math.max(this.sortedMax,l[k]);b?(this.itemA[b].randomA||(this.itemA[b].randomA=this.getRandomNumberArray(l.length+1)),this.shuffleArray(this.sortedIndex,this.itemA[b].randomA),this.initAngle=Math.floor(360*this.itemA[b].randomA[0])):
this.initAngle=0}}else this.sortedIndex=null;if(c.match(/RINGS/)){if(this.sortedIndex)for(var Db=0,k=0;k<this.sortedIndex.length;k++)this.sortedIndex[k].value&&(this.sortedIndex[k].value+=Db,Db=this.sortedIndex[k].value);else for(Db=0,this.sortedIndex=[],k=0;k<l.length;k++)this.sortedIndex[k]={index:k,value:l[k],tvalue:l[k]},this.sortedIndex[k].value&&(this.sortedIndex[k].value+=Db,Db=this.sortedIndex[k].value);this.sortedIndex.sort(this.sortIndexDown)}var Ob=null,Pb=null,Fc=R=0,Da=0,ra=0,Ha=0,$a=
null,kc=null,ub=0,lc=0,Gc=0,ab=!1,bb=0,Na=l.length;this.nClipParts&&this.nClipParts<l.length&&(c.match(/\|UP/)?bb=l.length-this.nClipParts:Na=this.nClipParts);if(this.szFlag.match(/DOMINANT/)){for(var Ab=Ca=0,Qb=-1,k=0;k<this.itemA[b].nValuesA.length;k++)w=this.itemA[b].nValuesA[k],fc=100/this.nMeanA[k]*w,gc=100/this.nMedianA[k]*w,hc=(w-(this.nMeanA[k]||0))/this.nDeviationA[k],Ca=w,this.szFlag.match(/PERCENTOFMEAN/)&&(Ca=fc),this.szFlag.match(/PERCENTOFMEDIAN/)&&(Ca=gc),this.szFlag.match(/DEVIATION/)&&
(Ca=hc),w>(this.nFilterA[k]||0)&&Ca>Ab&&(this.itemA[b].nClass=k,Ab=Ca,Qb=k);0<=Qb&&(bb=this.itemA[b].nDominant=Qb,Na=bb+1,R=Qb)}for(k=bb;k<Na;k++)lc+=0!=l[k],$a=Math.max($a||this.nMaxA[k],this.nMaxA[k]),kc=Math.min(kc||this.nMinA[k],this.nMinA[k]),ub=Math.max(ub,l[k]);for(k=bb;k<Na;k++){var M=k,w=l[M],Sa=l[M];this.sortedIndex&&(w=this.sortedIndex[M].value,Sa=this.sortedIndex[M].tvalue,M=this.sortedIndex[M].index);this.szValueField&&this.itemA[b]&&(Sa=__scanValue(this.itemA[b].szValue));if(this.szShowParts){var Eb=
!0;for(oa in this.szShowPartsA)this.szShowPartsA[oa]==M%(this.nGridX||1E6)&&(Eb=!1);if(Eb)continue}R=M;if(c.match(/EXACT/)&&!c.match(/AGGREGATE/)&&!c.match(/GROUP/)){var ba="";if(this.nRangesA&&this.nRangesA.length)for(ii=0;ii<this.nRangesA.length;ii++)if(w==this.nRangesA[ii]||Number(w)==Number(this.nRangesA[ii])){ba=this.szSymbolsA[ii]||this.szSymbolsA[0]||"circle";R=ii;break}var Ka=String(w),la=String(w);this.szLabelA&&this.szLabelA[R]&&(Ka=this.szLabelA[R],la=this.szLabelA[R]);ba.length||0!=M||
(ba="empty",Ka=la="no data",R=0);if(ba.length){Fc++;F=null;A=this.colorScheme[R];if(c.match(/NOLINES/))I="none";else if(I=this.colorScheme[R],"white"==A||"#ffffff"==A)I="gray";if("circle"==ba||"square"==ba||"carot"==ba||"diamond"==ba||"triangle"==ba||"hexagon"==ba||"cross"==ba||"empty"==ba){u=map.Scale.normalX(f/3);this.szSizeField&&b&&this.itemA[b]&&(u=u/Math.sqrt(this.nNormalSizeValue||this.nMaxSize)*Math.sqrt(this.itemA[b].nSize));switch(ba){case "empty":F=map.Dom.newShape("circle",g,0,0,u,"fill:#888888;fill-opacity:0;stroke:#888888;stroke-width:"+
map.Scale.nFeatureScaling*map.Scale.nObjectScaling+";");break;case "circle":F=map.Dom.newShape("circle",g,0,0,u,"fill:"+A+";stroke:"+I+";stroke-width:"+map.Scale.nFeatureScaling*map.Scale.nObjectScaling+";");break;case "square":F=map.Dom.newShape("rect",g,.8*-u,.8*-u,1.6*u,1.6*u,"fill:"+A+";stroke:"+I+";stroke-width:"+map.Scale.nFeatureScaling*map.Scale.nObjectScaling+";");break;case "cross":F=map.Dom.newShape("rect",g,.8*-u,.2*-u,1.6*u,.4*u,"fill:"+A+";stroke:"+I+";stroke-width:"+map.Scale.nFeatureScaling*
map.Scale.nObjectScaling+";");F=map.Dom.newShape("rect",g,.2*-u,.8*-u,.4*u,1.6*u,"fill:"+A+";stroke:"+I+";stroke-width:"+map.Scale.nFeatureScaling*map.Scale.nObjectScaling+";");break;case "diamond":case "carot":(F=map.Dom.newShape("rect",g,.8*-u,.8*-u,1.6*u,1.6*u,"fill:"+A+";stroke:"+I+";stroke-width:"+map.Scale.nFeatureScaling*map.Scale.nObjectScaling+";"))&&F.setAttributeNS(null,"transform","rotate(45)");break;case "triangle":F=map.Dom.newShape("path",g,"M 0,"+u+" l"+1.2*u+",-"+2*u+" -"+2.4*u+",0 "+
1.2*u+","+2*u+"z","fill:"+A+";stroke:"+I+";stroke-width:"+map.Scale.nFeatureScaling*map.Scale.nObjectScaling+";");break;case "hexagon":var Ta=u/2,Ua=u*Math.sin(60/180*Math.PI),Fb=u,F=map.Dom.newShape("path",g,"M -"+u+",0 l "+Ta+",-"+Ua+" "+Fb+",0 "+Ta+","+Ua+" -"+Ta+","+Ua+" -"+Fb+",0 -"+Ta+",-"+Ua+" z","fill:"+A+";stroke:"+I+";stroke-width:"+m+";")}if(!F)continue;if(c.match(/HORZ/)){c.match(/VALUES/)&&(D=__maptheme_getChartColors(A),I=D.textColor,J=map.Dom.newText(Ra,0,0,"font-family:arial;font-size:"+
String(u/2)+"px;text-anchor:start;baseline-shift:-90%;fill:#bbbbbb;stroke:none;pointer-events:none",la),J.fu.setPosition(M*u*2,-u-map.Scale.normalX(5)),1<l.length&&setRotate(J,-45));if(c.match(/AXIS/)&&this.szXaxisA){var D=__maptheme_getChartColors(A),I=D.textColor,Rb=this.szXaxisA[k],J=map.Dom.newText(Ra,0,0,"font-family:arial;font-size:"+String(u/2)+"px;text-anchor:start;baseline-shift:-90%;fill:#bbbbbb;stroke:none;pointer-events:none",Rb);J.fu.setPosition(M*u*2+map.Scale.normalX(2),u+map.Scale.normalX(1));
1<l.length&&setRotate(J,45)}F.setAttributeNS(szMapNs,"tooltip",Ka);F.fu.setPosition(M*u*2,0)}else!c.match(/VALUES/)||this.fHideValues&&!c.match(/ZOOM/)||(D=__maptheme_getChartColors(A),I=D.textColor,J=map.Dom.newText(Ra,0,0,"font-family:arial;font-size:"+String(u/2)+"px;text-anchor:start;baseline-shift:-45%;fill:#bbbbbb;stroke:none;pointer-events:none",la),J.fu.setPosition(u+map.Scale.normalX(3),-M*(2*u-map.Scale.normalY(0)))),F.setAttributeNS(szMapNs,"tooltip",Ka),F.fu.setPosition(0,-M*(2*u-map.Scale.normalY(0)))}else{u=
map.Scale.normalX(.4*f);F=map.Dom.constructNode("use",g,{"xlink:href":"#"+ba+":antizoomandpan"});F.setAttributeNS(null,"style","fill:"+A+";stroke:"+I);if(this.szSizeField&&b&&this.itemA[b]){var L=1/Math.sqrt(this.nMaxSize)*Math.sqrt(this.itemA[b].nSize);F.fu.scale(L,L)}F.fu.setPosition(map.Scale.normalX(0)+M*map.Scale.normalX(20),map.Scale.normalY(0));0<M&&(map.Dom.newText(g,map.Scale.normalX(-9)+M*map.Scale.normalX(20),0,"font-family:arial;font-size:360px;text-anchor:middle;baseline-shift:-50%;fill:none;stroke:black;stroke-width:60;pointer-events:none;opacity:0.3;",
"+"),map.Dom.newText(g,map.Scale.normalX(-9)+M*map.Scale.normalX(20),0,"font-family:arial;font-size:360px;text-anchor:middle;baseline-shift:-50%;fill:white;stroke:none;pointer-events:none;opacity:0.8;","+"));c.match(/VALUES/)&&(D=__maptheme_getChartColors(A),I=D.textColor,J=map.Dom.newText(Ra,0,0,"font-family:arial;font-size:"+String(u/2)+"px;text-anchor:start;baseline-shift:-45%;fill:#bbbbbb;stroke:none;pointer-events:none",la),J.fu.setPosition(u/2+map.Scale.normalX(3),2*-M*u),this.szSizeField&&
b&&this.itemA[b]&&(J=map.Dom.newText(Ra,0,0,"font-family:arial;font-size:"+String(u/2)+"px;text-anchor:start;baseline-shift:-45%;fill:#bbbbbb;stroke:none;pointer-events:none",String(this.itemA[b].nSize)+this.szSizeValueUnits),J.fu.setPosition(u/2+map.Scale.normalX(3),2*-M*u+u/2)))}F.setAttributeNS(szMapNs,"value",String(w));F.setAttributeNS(szMapNs,"class",String(R%(this.nGridX||1E6)));this.nRealizedCount++}else this.nMissingRangeCount++}else if(w||c.match(/PLOT/)){E=map.Scale.normalX(f/2);N=this.nNormalSizeValue||
$a;c.match(/MENUSIZE/)?N=5*ub:!this.nNormalSizeValue||c.match(/SEQUENCE/)&&this.szSizeField||(this.nMaxSize=N=this.nNormalSizeValue);c.match(/ZOOM/)&&c.match(/SEQUENCE/)&&(N=ub/2+ub/2*Math.pow(N,.5)/Math.pow(ub,.5));if(c.match(/INVERTSIZE/)&&0==N-w&&!c.match(/ZEROISVALUE/))return null;this.szFlag.match(/CLIP/)&&!this.szFlag.match(/MORPH/)&&this.nClipFrames&&(w=this.nClipFrames==l.length?Number(l[this.nActualFrame]):l[M]*(this.nClipFrames-1-this.nActualFrame)/(this.nClipFrames-1)+l[l.length-1]*this.nActualFrame/
(this.nClipFrames-1));u=0;c.match(/AUTOSIZE/)&&(Ia=map.Layer.nDynamicObjectScale,Ja=c.match(/RECT/)?c.match(/GAP/)?2.3:2:c.match(/GAP/)?1.6:1.5,N=Math.max($a,this.nMax),E=this.nGridWidthPx?map.Scale.normalX(this.nGridWidthPx)/Ja/Ia:this.nGridWidth?map.Scale.getDeltaXofDistanceInMeter(this.nGridWidth)/Ja/Ia:E);u=c.match(/GRIDSIZE/)&&!c.match(/PLOT/)?this.nGridSize/2:c.match(/NOSIZE/)?map.Scale.normalX(f/3):c.match(/FIXSIZE/)?map.Scale.normalX(f/3)/(this.nNormalSizeValue||1):c.match(/LINEAR/)||c.match(/SIZEP1/)?
E/N*w:c.match(/SIZELOG/)?E/Math.log(N)*Math.log(w):c.match(/SIZEP4/)?E/Math.pow(N,.25)*Math.pow(w,.25):c.match(/SIZEP3/)||c.match(/SIZEVOLUME/)?E/Math.pow(N,1/3)*Math.pow(w,1/3):E/Math.sqrt(N)*Math.sqrt(w);c.match(/SEQUENCE/)?c.match(/MENUSIZE/)||c.match(/SUM/)&&!b?u*=this.szField100?1:2:c.match(/ZOOM/)&&!c.match(/PLOT/)?u*=2:c.match(/AGGREGATE/)&&c.match(/EXACT/)||!this.szSizeField||!b||!this.itemA[b]||(u=c.match(/SIZELOG/)?u/Math.log(this.nMaxSize)*Math.log(this.itemA[b].nSize):c.match(/SIZEP4/)?
u/Math.pow(this.nMaxSize,.25)*Math.pow(this.itemA[b].nSize,.25):c.match(/SIZEP3/)||c.match(/SIZEVOLUME/)?u/Math.pow(this.nMaxSize,1/3)*Math.pow(this.itemA[b].nSize,1/3):u/Math.sqrt(this.nMaxSize)*Math.sqrt(this.itemA[b].nSize)):c.match(/MENUSIZE/)||c.match(/SUM/)&&!b?u=1.5*E:c.match(/ZOOM/)&&!c.match(/PLOT/)?u=Math.max(u,2*E/3):c.match(/NOSIZE/)?u=E/5:c.match(/PLOTXY/)?u/=5:this.szSizeField&&b&&this.itemA[b]&&(u=E/Math.sqrt(this.nMaxSize)*Math.sqrt(this.itemA[b].nSize));if(isNaN(u)||!u)if(u=0,!c.match(/STAR/)&&
!c.match(/STACKED/))continue;ba=this.szSymbolsA[M];this.szValueField&&c.match(/EXACT/)&&this.szValuesA&&(Sa=this.szValuesA[M]);if(b&&this.itemA[b].szColor)A=this.itemA[b].szColor,R=this.itemA[b].nClass,this.colorClassUsedA[R]=!0;else if((c.match(/SEQUENCE/)||c.match(/DOMINANT/))&&this.colorScheme.length==this.partsA.length)A=this.colorScheme[M%(this.nGridX||1E4)],I=this.colorScheme[M];else if(A=this.colorScheme[0],I=this.colorScheme[1]?this.colorScheme[1]:"none",2<this.colorScheme.length&&(A=this.colorScheme[this.colorScheme.length-
1],I=this.colorScheme[0]),c.match(/NOLINES/)?I="none":"none"==I&&(D=__maptheme_getChartColors(A),I=D.textColor),2<this.colorScheme.length||this.szRanges&&this.szRanges.length){for(ii=0;ii<this.partsA.length;ii++)if(c.match(/EXACT/)&&w==this.partsA[ii].min||!c.match(/EXACT/)&&w<this.partsA[ii].max){A=this.colorScheme[ii];D=__maptheme_getChartColors(A);I=D.textColor;c.match(/RANGE/)&&!c.match(/RANGES/)&&(u=map.Scale.normalX(2+5*(ii+1)/this.partsA.length));R=ii;e.setAttributeNS(szMapNs,"class",String(R%
(this.nGridX||1E6)));break}c.match(/NOLINES/)&&(I="none")}if("circle"==ba||"square"==ba||"carot"==ba||"diamond"==ba||"triangle"==ba||"hexagon"==ba||"empty"==ba||"label"==ba||"cross"==ba){I=this.szLineColor||I;m=(this.nLineWidth||1)*map.Scale.normalX(Math.min(2*u/E,.2));switch(ba){case "empty":F=map.Dom.newShape("circle",g,0,0,u,"fill:#888888;fill-opacity:0;stroke:#888888;stroke-width:"+m+";");break;case "circle":!this.fShadow&&this.fOrigShadow&&(ka=map.Dom.newShape("circle",g,map.Scale.normalX(.5)+
.02*u,map.Scale.normalX(.5)+.02*u,1.02*u,"fill:#000000;stroke:none;opacity:"+.6*(this.fillOpacity?this.fillOpacity:1)));c.match(/GLOW/)&&!c.match(/ZOOM/)&&(!this.szGlowUpper||map.Scale.nTrueMapScale*map.Scale.nZoomScale<=this.nGlowUpper)&&(!this.szGlowLower||map.Scale.nTrueMapScale*map.Scale.nZoomScale>=this.nGlowLower)?((sb=map.Dom.newShape("circle",g,0,0,6*u,"fill:"+A+";stroke:none;fill-opacity:0.05;pointer-events:none;"))&&sb.setAttributeNS(szMapNs,"class",String(R)),(Nb=map.Dom.newShape("circle",
g,0,0,2*u,"fill:"+A+";stroke:none;fill-opacity:0.1;pointer-events:none;"))&&Nb.setAttributeNS(szMapNs,"class",String(R))):c.match(/AURA/)&&!c.match(/ZOOM/)&&(!this.szGlowUpper||map.Scale.nTrueMapScale*map.Scale.nZoomScale<=this.nGlowUpper)&(!this.szGlowLower||map.Scale.nTrueMapScale*map.Scale.nZoomScale>=this.nGlowLower)&&(sb=map.Dom.newShape("circle",g,0,0,1.3*u,"fill:"+(this.szLineColor||A)+";stroke:none;fill-opacity:0.3;"))&&sb.setAttributeNS(szMapNs,"class",String(R));F=map.Dom.newShape("circle",
g,0,0,u,"fill:"+A+";stroke:"+I+";stroke-width:"+m+";");break;case "square":F=map.Dom.newShape("rect",g,-u,-u,2*u,2*u,"fill:"+A+";stroke:"+I+";stroke-width:"+m+";");break;case "cross":F=map.Dom.newShape("rect",g,1.6*-u,.4*-u,3.2*u,.8*u,"fill:"+A+";stroke:"+I+";stroke-width:"+map.Scale.nFeatureScaling*map.Scale.nObjectScaling+";");F=map.Dom.newShape("rect",g,.4*-u,1.6*-u,.8*u,3.2*u,"fill:"+A+";stroke:"+I+";stroke-width:"+map.Scale.nFeatureScaling*map.Scale.nObjectScaling+";");break;case "carot":case "diamond":(F=
map.Dom.newShape("rect",g,-u,-u,2*u,2*u,"fill:"+A+";stroke:"+I+";stroke-width:"+m+";"))&&F.setAttributeNS(null,"transform","rotate(45)");break;case "triangle":F=map.Dom.newShape("path",g,"M 0,"+u+" l"+1.2*u+",-"+2*u+" -"+2.4*u+",0 "+1.2*u+","+2*u+"z","fill:"+A+";stroke:"+I+";stroke-width:"+m+";");break;case "hexagon":Ta=u/2;Ua=u*Math.sin(60/180*Math.PI);Fb=u;F=map.Dom.newShape("path",g,"M -"+u+",0 l "+Ta+",-"+Ua+" "+Fb+",0 "+Ta+","+Ua+" -"+Ta+","+Ua+" -"+Fb+",0 -"+Ta+",-"+Ua+" z","fill:"+A+";stroke:"+
I+";stroke-width:"+m+";");break;case "label":if(X=this.formatValue(Sa,this.szValueDecimals||(1>Sa||1>=N?1:0),"ROUND")+(5>=this.szUnit.length?this.szUnit:""),c.match(/TEXTONLY/)){Ba=__maptheme_getChartColors(A).textColor;Y=String(Math.max(Math.min(.8*u,map.Scale.normalX(500)),map.Scale.normalX(2)));if(this.nValueSizeMin&&!c.match(/ZOOM/)&&Y*map.Layer.nDynamicObjectScale<map.Scale.normalX(this.nValueSizeMin)){F=map.Dom.newShape("rect",g,0,0,0,0,"fill:none;");ka=map.Dom.newShape("rect",g,0,0,0,0,"fill:none;");
break}Bb=this.szTextFont||"arial";ka=map.Dom.newText(g,0,0,"font-family:"+Bb+";font-size:"+Y+"px;font-weight:bold;text-anchor:middle;fill:none;stroke:"+A+";stroke-width:"+Y/7+";stroke-opacity:0.5;pointer-events:none;stroke-linejoin:bevel;",X);ka.setAttributeNS(null,"id",this.szId+":"+b+":text:bg");F=map.Dom.newText(g,0,0,"font-family:"+Bb+";font-size:"+Y+"px;font-weight:bold;text-anchor:middle;fill:#000000;opacity:"+wa+";stroke:none;",X);F.setAttributeNS(null,"id",this.szId+":"+b+":text")}else{Y=
String(Math.max(1,Math.min(.8*u,3.4/X.length*u)));if(this.nValueSizeMin&&!c.match(/ZOOM/)&&Y*map.Layer.nDynamicObjectScale<map.Scale.normalX(this.nValueSizeMin)){F=map.Dom.newShape("rect",g,0,0,0,0,"fill:none;");break}F=map.Dom.newShape("rect",g,-u,.83*-Y,2.05*u,1.6*Y,"fill:"+A+";stroke:"+I+";stroke-width:"+m+";");F.setAttributeNS(null,"rx",map.Scale.normalX(2*u/E));F.setAttributeNS(null,"ry",map.Scale.normalX(2*u/E))}}if(F){c.match(/OUTLINE/)?(F.style.setProperty("stroke-width",String(map.Scale.normalX(.5))),
F.style.setProperty("stroke-opacity","1"),F.style.setProperty("fill-opacity","0.7")):c.match(/RANDOM/)?(F.style.setProperty("stroke-opacity",String(this.nOpacity?this.nOpacity:1),""),F.style.setProperty("fill-opacity",String(this.fillOpacity?this.fillOpacity:this.nOpacity?this.nOpacity:1),""),c.match(/DOPACITY/)&&(fa=1/(this.nDopacityPow||1),wa=Math.pow(w,fa)/Math.pow(this.sortedMax,fa)*(this.nOpacity||1)*(this.nDopacityScale||1),F.style.setProperty("fill-opacity",String(wa),""))):c.match(/SORT/)&&
c.match(/DOPACITY/)?(F.style.setProperty("stroke-opacity",String(this.nOpacity?this.nOpacity:1),""),fa=1/(this.nDopacityPow||1),wa=Math.pow(w,fa)/Math.pow(this.sortedMax,fa)*(this.nOpacity||1)*(this.nDopacityScale||1),F.style.setProperty("fill-opacity",String(wa),"")):c.match(/DOPACITY/)&&this.szAlphaField?b&&"undefined"!=typeof this.itemA[b].nAlpha&&(fa=1/(this.nDopacityPow||1),wa=(this.nDopacityScale||1)/Math.pow(this.nMaxAlpha,fa)*Math.pow(this.itemA[b].nAlpha,fa),F.style.setProperty("fill-opacity",
String(wa),"")):c.match(/DOPACITY/)?(fa=1/(this.nDopacityPow||1),wa=Math.pow(w-this.nMin,fa)/Math.pow(this.nMax-this.nMin,fa)*(this.fillOpacity||1)*(this.nDopacityScale||1),F.style.setProperty("fill-opacity",String(wa),""),c.match(/EXACT/)||(R=Math.min(6,Math.ceil((w-this.nMin)/(this.nMax-this.nMin)*7)),F.setAttributeNS(szMapNs,"class",String(R)),g.setAttributeNS(szMapNs,"class",String(R)),e.setAttributeNS(szMapNs,"class",String(R)))):F.style.setProperty("fill-opacity",String(this.fillOpacity?this.fillOpacity:
this.nOpacity?this.nOpacity:1),"");this.chartGroup&&this.chartGroup.style.setProperty("opacity","1","");if((c.match(/ZOOM/)||c.match(/NORMSIZE/))&&this.szLabelA){var Aa=this.formatValue(Sa,2),Ka=Aa+this.szUnit,Ka=Ka+(" - "+this.szLabelA[M%(this.nGridX||1E7)]);this.szXaxisA&&this.szXaxisA.length&&(Ka+=" ("+this.szXaxisA[Math.floor(M/(this.nGridX||1))]+")")}else Aa=this.formatValue(Sa,2),Ka=" "+Aa+this.szUnit;F.setAttributeNS(szMapNs,"tooltip",Ka)}}else if(!c.match(/MULTIPLE/)||c.match(/NORMSIZE/)||
c.match(/MENUSIZE/))F=map.Dom.constructNode("use",g,{"xlink:href":"#"+ba+":antizoomandpan"}),map.Dom.newShape("circle",g,0,0,.5*u,"fill:white;stroke:none;opacity:0"),F.fu.scale(u/E,u/E),F.setAttributeNS(null,"style","fill:"+A+";stroke:"+I);else for(var F=map.Dom.newGroup(g,g.getAttributeNS(null,"id")+":multiple"),Sb=0;Sb<w;Sb++){var mc=map.Dom.constructNode("use",F,{"xlink:href":"#"+ba+":antizoomandpan"});mc.fu.setPosition(Sb*(E+map.Scale.normalX(1)),0);mc.fu.scale(1,1);mc.setAttributeNS(null,"style",
"fill:"+A+";stroke:"+I);map.Dom.newShape("circle",F,Sb*E,0,.5*u,"fill:white;stroke:none;opacity:0")}if(F&&c.match(/VALUES/)&&(!this.fHideValues||c.match(/ZOOM/))){var J=null,X=this.formatValue(Sa,this.szValueDecimals||"")+(5>=this.szUnit.length?this.szUnit:""),Sc=Math.max($a,this.nMax),Tc=this.formatValue(Sc,this.szValueDecimals||"")+(5>=this.szUnit.length?this.szUnit:""),Uc=Math.max((Sa.length||0)+1,Tc.length),D=__maptheme_getChartColors(A),Ba=this.szTextColor||D.textColor,Y=String(Math.min(1*E,
("hexagon"==ba?2.7:3.2)/Uc*E)),Y=u/E*Y;if(c.match(/ZOOM/)&&c.match(/LINES/)&&(null==this.nGridX||1>=this.nGridX||c.match(/STACKED/)))Ba="black",y=y||map.Dom.newGroup(e,this.szId+":"+b+":chartontop"),Y=4+.5*l.length/(this.nGridX?2*this.nGridX:1),J=this.createTextLabel(SVGDocument,y,"",X,Y,"",D.lowColor,"white"),J.setAttributeNS(null,"opacity","0.5");else if(c.match(/ZOOM/)&&!c.match(/SEQUENCE/))Ba="black",J=map.Dom.newText(g,.5*u+.2*E,-u/2,this.szValuesTextStyle,X);else if("circle"==ba||"square"==
ba||"triangle"==ba||"hexagon"==ba||"label"==ba||"empty"==ba)if((c.match(/CENTER/)||c.match(/TOP/)||c.match(/BOTTOM/))&&!c.match(/DOMINANT/)){if(w){var O=6;this.szChartFlag+="|VALUEBACKGROUND";var y=y||map.Dom.newGroup(e,this.szId+":"+b+":chartontop"),Ha=Ha?Ha:u,Hc=-map.Scale.normalX(1),Ic=-map.Scale.normalX(1.33*O)*(lc-Gc-1),J=this.createTextLabel(SVGDocument,y,"",X,O,"",A);J.fu.setPosition(Hc,Ic);if(b&&(c.match(/ZOOM/)||c.match(/NORMSIZE/))&&this.szLabelA){var Vc=J.fu.getBox().width,J=map.Dom.newText(y,
0,0,this.szValuesTextStyle+";color:#000;",this.szLabelA[M]);J.fu.setPosition(Hc+Vc+map.Scale.normalX(6),Ic-map.Scale.normalX(-1));J.fu.scale(.6,.6)}J.setAttributeNS(szMapNs,"class",String(R%(this.nGridX||1E6)));J=null;Gc++}}else J=map.Dom.newText(g,0,.33*Y,"font-family:arial;font-size:"+Y+"px;text-anchor:middle;fill:"+Ba+";stroke:none;pointer-events:none",X);else Y=Math.max(.8*u,1),y=y||map.Dom.newGroup(e,this.szId+":"+b+":chartontop"),J=this.createTextLabel(SVGDocument,y,"",X,Y/map.Scale.normalX(1),
"",A),J.fu.setPosition(map.Scale.normalX(0)+Da,map.Scale.normalY(0)+ra)}if(F&&(F.setAttributeNS(szMapNs,"class",String(R%(this.nGridX||1E6))),J&&J.setAttributeNS(szMapNs,"class",String(R%(this.nGridX||1E6))),ka&&ka.setAttributeNS(szMapNs,"class",String(R%(this.nGridX||1E6))),!c.match(/CENTER/))){var sa=null;if(c.match(/STAR/)){if(0==k&&(Ob=F,Pb=J,Ha=u,c.match(/EXPAND/)&&c.match(/SORT/)&&c.match(/\|UP/)&&(Ha=c.match(/LINEAR/)||c.match(/SIZEP1/)?(c.match(/EXPANDMAX/)?2:.5)*E/N*this.sortedIndex[l.length-
1].value:(c.match(/EXPANDMAX/)?2:.5)*E/Math.sqrt(N)*Math.sqrt(this.sortedIndex[l.length-1].value)),c.match(/ZOOM/)&&c.match(/STAR/)&&c.match(/\|UP/)?Ha*=2:c.match(/COMPRESS/)&&(Ha*=c.match(/COMPRESSMAX/)?.25:.5)),(0<k||c.match(/\|UP/))&&u){var Wc=this.nClipParts&&this.nClipParts<this.partsA.length?this.nClipParts:this.partsA.length,nc=u,Jc=Ha+u,Xc=Math.sqrt(Math.pow(Jc,2)-Math.pow(nc,2)),Tb=90-Math.asin(nc*Xc/Jc/nc)/Math.PI*180,cb=Ha+u;c.match(/\|UP/)&&(5<k&&(Tb/=1+u/E*2),cb=Ha*(1+Wc/5));c.match(/ZOOM/)||
(cb=this.nRangeScale?cb*this.nRangeScale:c.match(/EXPANDMAX/)?2*cb:c.match(/EXPAND/)?1.5*cb:cb);this.initAngle+=Tb;Da=Math.cos(this.initAngle/180*Math.PI)*cb;ra=Math.sin(this.initAngle/180*Math.PI)*cb;this.initAngle+=Tb;sa=new point(map.Scale.normalX(0)+Da,map.Scale.normalY(0)+ra)}}else if(c.match(/RANDOM/)){var Ub=c.match(/EXPANDMAX/)?2*u:c.match(/EXPAND/)?1.5*u:u;c.match(/ZOOM/)&&(E*=2,Ub*=2);Da=Math.cos(this.initAngle+360/this.partsA.length*k/180*Math.PI)*Math.min(E,Ub);ra=Math.sin(this.initAngle+
360/this.partsA.length*k/180*Math.PI)*Math.min(E,Ub);sa=new point(map.Scale.normalX(0)+Da,map.Scale.normalY(0)+ra)}else c.match(/HORZ/)?(Da+=u,sa=new point(map.Scale.normalX(0)+Da,map.Scale.normalY(0)+ra),Da+=u):c.match(/BOTTOM/)?sa=new point(map.Scale.normalX(0),-u):c.match(/TOP/)?sa=new point(.3*-u,.7*u-E):c.match(/CONE/)?sa=new point(map.Scale.normalY(.33*k),-map.Scale.normalY(1*k)):c.match(/BASE/)&&(sa=new point(map.Scale.normalX(0),ra-u),ra-=u*(c.match(/VALUES/)?1.25:1));sa&&(F.fu.setPosition(sa.x,
sa.y),ka&&ka.fu.setPosition(sa.x,sa.y),sb&&sb.fu.setPosition(sa.x,sa.y),Nb&&Nb.fu.setPosition(sa.x,sa.y),J&&J.fu.setPosition(sa.x,sa.y));if(c.match(/PLOT/)){0!=w||c.match(/STACKED/)||(F.parentNode.removeChild(F),ka&&ka.parentNode.removeChild(ka),J&&J.parentNode.removeChild(J));var G=map.Scale.normalX(f)*(c.match(/LINES/)?1:2/3),V=k*G;this.nGridX&&(V=c.match(/PLOTVAR/)?Math.floor(k%this.nGridX)*G:Math.floor(k/this.nGridX)*G);var N=$a||this.nMax,N=this.nMaxValue||N,ta=this.nMinValue||Math.min(this.nMin,
kc),L=map.Scale.normalX(f)/(N-ta)*(this.nGridX||l.length-1)*(this.nRangeScale||1),y=y||map.Dom.newGroup(e,this.szId+":"+b+":chartontop");if(c.match(/AREA/))var da=map.Dom.newGroup(y,"");else da=map.Dom.newGroup(g,""),da.parentNode.insertBefore(da,da.parentNode.firstChild);K=map.Dom.newGroup(y,"");if(c.match(/PLOTXY/))ab||(ab=!0,Ia=map.Layer.nDynamicObjectScale,Ja=1.1,ga=this.nGridWidthPx?map.Scale.normalX(this.nGridWidthPx)/Ja/this.nScale/Ia:this.nGridWidth?map.Scale.getDeltaXofDistanceInMeter(this.nGridWidth)/
Ja/this.nScale/Ia:map.Scale.normalX(f/3),ga-=2*map.Scale.normalX(this.nBoxMargin||0),c.match(/BOX/)&&c.match(/GRID/)&&(map.Dom.newShape("line",da,0,0,ga,0,"stroke:#888888;stroke-width:"+map.Scale.normalX(.3)+";"),map.Dom.newShape("line",da,0,0,0,-ga,"stroke:#888888;stroke-width:"+map.Scale.normalX(.3)+";"),map.Dom.newText(da,20,80,"font-family:arial;font-size:80px;text-anchor:end;fill:#aaaaaa;stroke:none;pointer-events:none;","0"),map.Dom.newText(da,ga,80,"font-family:arial;font-size:80px;text-anchor:end;fill:#aaaaaa;stroke:none;pointer-events:none;",
String(this.nMaxX)),map.Dom.newText(da,-10,-ga+80,"font-family:arial;font-size:80px;text-anchor:end;fill:#aaaaaa;stroke:none;pointer-events:none;",String(this.nMaxY))),this.nGridSize=ga,this.nAutoScale=1),fa=1,xa=Math.pow(this.itemA[b].nX,fa)*ga/Math.pow(this.nMaxX,fa),mb=-Math.pow(this.itemA[b].nY,fa)*ga/Math.pow(this.nMaxY,fa),F.fu.setPosition(xa,mb),ka&&ka.fu.setPosition(xa,mb),J&&J.fu.setPosition(xa,mb);else if(c.match(/PLOTYX/))F.fu.setPosition((N+Math.abs(N-w))*L,V),ka&&ka.fu.setPosition((N+
Math.abs(N-w))*L,V),J&&J.fu.setPosition((N+Math.abs(N-w))*L,V);else if(c.match(/PLOTY/)){F.fu.setPosition(0,(-N+Math.abs(N-w))*L);ka&&ka.fu.setPosition(0,(-N+Math.abs(N-w))*L);J&&J.fu.setPosition(0,(-N+Math.abs(N-w))*L);var Z=1,Z=N/5,Z=10*Math.ceil(Z/(10*Math.floor(Math.log(Z))))*Math.floor(Math.log(Z))||1,N=Math.ceil(N/Z)*Z;if(!ab&&(ab=!0,c.match(/BOX/)&&c.match(/GRID/)))for(var aa=map.Scale.normalX(f)/2;aa<N*L;aa+=L*Z)map.Dom.newShape("line",da,-20,-aa,20,-aa,"stroke:#444444;stroke-width:"+map.Scale.normalX(1)+
";")}else if(c.match(/PLOTX/)){if(F.fu.setPosition((N-Math.abs(N-w))*L,0),ka&&ka.fu.setPosition((N-Math.abs(N-w))*L,0),J&&J.fu.setPosition((N-Math.abs(N-w))*L,0),Z=1,Z=N/5,Z=10*Math.ceil(Z/(10*Math.floor(Math.log(Z))))*Math.floor(Math.log(Z))||1,N=Math.ceil(N/Z)*Z,!ab&&(ab=!0,c.match(/BOX/)&&c.match(/GRID/)))for(aa=map.Scale.normalX(f);aa<N*L+map.Scale.normalX(f);aa+=L*Z)map.Dom.newShape("line",da,aa,-20,aa,20,"stroke:#444444;stroke-width:"+map.Scale.normalX(1)+";")}else{Z=1;Z=Math.ceil(N-ta)/5;.5>
Z&&(Z=Math.ceil(N-ta)/10);1<Z&&(Z=10*Math.ceil(Z/(10*Math.floor(Math.log(Z))))*Math.floor(Math.log(Z))||1);N=Math.ceil(N/Z)*Z;for(ta=Math.floor(ta/Z)*Z;5>(N-ta)/Z;)Z/=2;5<(N-ta)/Z&&(Z*=2);if(!ab){ab=!0;this.plot_last_last_position=[];this.plot_last_position=[];this.plot_last_value=[];this.plot_last_stacked_value=[];this.plot_last_shape=[];this.plot_last_mean=[];this.plot_last_areaValue=[];this.plot_area_points=[];this.plot_area_shapes=[];this.plot_area_shapes[0]=map.Dom.newShape("path",g,"M0,0","fill:"+
A+";fill-opacity:"+(this.fillOpacity||1)+";stroke:none");var eb=map.Scale.normalX(Math.max(l.length/(this.nGridX||1),10)),eb=eb*(c.match(/ZOOM/)?.8:1);if(c.match(/BOX/)&&c.match(/GRID/)){for(var oc=.8,aa=0;aa<=(N-ta)*L;aa+=L*Z){var Gb=-G/(c.match(/LINES/)?3:1),pc=G*(this.nGridX?l.length/this.nGridX-1:l.length-1);c.match(/PLOTVAR/)&&1<l.length/this.nGridX&&(pc=G*this.nGridX);if(c.match(/GRADIENT/)&&0!=aa)var Kc=pc+(c.match(/LINES/),0),Q=map.Dom.newShape("path",g,"M"+Gb+","+-aa+" L "+Kc+","+-aa+" "+
Kc+","+(-aa+L*Z)+" "+Gb+","+(-aa+L*Z)+" z","fill:#d8d8dd;fill-opacity:"+oc+";stroke:none;"),oc=oc-.3;map.Dom.newShape("line",da,Gb,-aa,pc,-aa,"stroke:#aaaaaa;stroke-width:"+(0==aa?map.Scale.normalX(.5):map.Scale.normalX(.3))+";");5<N?map.Dom.newText(da,1.1*Gb,-aa+.3*eb,"font-family:arial;font-size:"+eb+"px;text-anchor:end;fill:#888888;stroke:none;pointer-events:none;",String(Math.round(c.match(/INVERT/)?N-aa/L+ta:aa/L+ta))):map.Dom.newText(da,1.1*Gb,-aa+.3*eb,"font-family:arial;font-size:"+eb+"px;text-anchor:end;fill:#888888;stroke:none;pointer-events:none;",
this.formatValue(Math.round(c.match(/INVERT/)?N-aa/L+ta:100*(aa/L+ta))/100,2));this.nPlotHeight=aa}map.Dom.newShape("line",da,V,0,V,-(N-ta)*L,"stroke:#aaaaaa;stroke-width:"+map.Scale.normalX(.1)+";");if(this.szXaxisA&&this.szXaxisA.length)for(aa=0;aa<this.szXaxisA.length;aa++)this.szXaxisA[aa].length&&" "!=this.szXaxisA[aa]&&(map.Dom.newShape("line",da,G*aa,100,G*aa,-(N-ta)*L,"stroke:#444444;stroke-width:"+map.Scale.normalX(.5)+";stroke-dasharray:20 80;"),map.Dom.newText(da,G*aa,1.5*eb,"font-family:arial;font-size:"+
eb+"px;text-anchor:middle;fill:#888888;stroke:none;pointer-events:none;",this.szXaxisA[aa]))}}var La=this.nGridX?Math.floor(k/this.nGridX)+1:1,T=this.nGridX?k%this.nGridX:1,na=c.match(/INVERT/)?N-w:w,na=na-ta,na=na+(c.match(/STACKED/)?this.plot_last_stacked_value[La]||0:0);F.fu.setPosition(V,-na*L);ka&&ka.fu.setPosition(V,-na*L);J&&(c.match(/LINES/)&&(null==this.nGridX||1>=this.nGridX||c.match(/STACKED/))?J.fu.setPosition(V-map.Scale.normalX(f/4),-na*L-map.Scale.normalY(f/4)/(this.nGridX||1)):J.fu.setPosition(V,
-na*L));if(c.match(/LINES/)){var Q=null;if(c.match(/ZEROISVALUE/)&&this.plot_last_position[T]&&(w||this.plot_last_position[T].y)||w&&this.plot_last_position[T]&&this.plot_last_position[T].y)if(c.match(/AREA/)){if(Q=map.Dom.newShape("path",g,"M"+(this.plot_last_position[T].x-2)+","+this.plot_last_position[T].y+" L "+V+","+-na*L+" "+V+","+(-na+w-ta)*L+" "+(this.plot_last_position[T].x-2)+","+(this.plot_last_last_position[T-1]?this.plot_last_last_position[T-1].y:0)+" z","fill:"+A+";fill-opacity:"+(this.fillOpacity||
1)+";"))Q.setAttributeNS(szMapNs,"value",String(w)),Q.setAttributeNS(szMapNs,"class",String(R%(this.nGridX||1E6))),Q.setAttributeNS(szMapNs,"tooltip",(this.szLabelA?this.szLabelA[R%(this.nGridX||1E6)]+": ":"")+this.formatValue(this.plot_last_areaValue[T],this.szValueDecimals||2)+this.szUnit+" ... "+this.formatValue(w,this.szValueDecimals||2)+this.szUnit);var Yc=1==k||k==Na-1||2==La||La==Na/(this.nGridX||1)?"but":"round";(Q=map.Dom.newShape("line",g,this.plot_last_position[T].x,this.plot_last_position[T].y,
V,-na*L,"stroke:"+A+";stroke-width:"+map.Scale.normalX(c.match(/STACKED/)?1:this.nLineWidth||3)+";stroke-linecap:"+Yc+";"))&&Q.setAttributeNS(szMapNs,"value",String(w))}else{if(Q=map.Dom.newShape("line",da,this.plot_last_position[T].x,this.plot_last_position[T].y,V,-na*L,"stroke:"+(this.szLineColor||A)+";stroke-width:"+map.Scale.normalX(this.nLineWidth||3)+";stroke-linecap:round;"))Q.setAttributeNS(szMapNs,"value",String(w)),Q.setAttributeNS(szMapNs,"class",String(R%(this.nGridX||1E6)));try{g.insertBefore(Q,
this.plot_last_shape[T])}catch(gd){}}c.match(/LOLLIPOP/)&&w&&(Q=map.Dom.newShape("line",da,V,0,V,-na*L,"stroke:"+A+";stroke-width:"+map.Scale.normalX(3)+";stroke-linecap:round;"))&&(Q.setAttributeNS(szMapNs,"value",String(w)),Q.setAttributeNS(szMapNs,"class",String(R%(this.nGridX||1E6))));if(c.match(/PLOTVAR/)){var qa=c.match(/MEDIAN/)?this.nMedianA[M]:this.nMeanA[M],qa=qa-ta;this.plot_last_mean[T]&&((Q=map.Dom.newShape("path",da,"M"+this.plot_last_mean[T].x+","+(this.plot_last_mean[T].y-this.nDeviationA[M-
1]*L)+" L "+V+","+(-qa-this.nDeviationA[M])*L+" "+V+","+(-qa+this.nDeviationA[M])*L+" "+this.plot_last_mean[T].x+","+(this.plot_last_mean[T].y+this.nDeviationA[M-1]*L)+" z","fill:#d8d8dd;fill-opacity:0.2;stroke:none;"))&&Q.setAttributeNS(szMapNs,"tooltip","standard deviation"),(Q=map.Dom.newShape("line",g,this.plot_last_mean[T].x,this.plot_last_mean[T].y,V,-qa*L,"stroke:#888888;stroke-width:"+map.Scale.normalX(2)+";stroke-linecap:round;stroke-dasharray:10 80;"))&&Q.setAttributeNS(szMapNs,"tooltip",
"mean"));this.plot_last_mean[T]=new point(V,-qa*L)}this.plot_last_last_position[T]=c.match(/STACKED/)?this.plot_last_position[T]||new point(0,0):new point(0,0);this.plot_last_position[T]=0<=na?new point(V,-na*L):new point(V,0);this.plot_last_shape[T]=F;this.plot_last_areaValue[T]=w;this.plot_area_points.push(new point(V,-na*L))}else if(c.match(/LOLLIPOP/)&&w){if(Q=map.Dom.newShape("line",da,V,0,V,-na*L,"stroke:"+A+";stroke-width:"+map.Scale.normalX(3)+";stroke-linecap:round;"))Q.setAttributeNS(szMapNs,
"value",String(w)),Q.setAttributeNS(szMapNs,"class",String(R%(this.nGridX||1E6)))}else 1<l.length/this.nGridX?c.match(/PLOTVAR/)?(F.style.setProperty("fill-opacity",La==l.length/this.nGridX?"1":"0.2",""),F.style.setProperty("stroke-width",La==l.length/this.nGridX?"0":"3",""),Q=null,this.plot_last_position[T]&&(c.match(/PLOTVAR/)?(Q=map.Dom.newShape("line",g,this.plot_last_position[T].x,this.plot_last_position[T].y,V,-na*L,"stroke:"+A+";stroke-width:"+map.Scale.normalX(2)+";"),Q.setAttributeNS(szMapNs,
"value",String(w)),Q.setAttributeNS(szMapNs,"class",String(R%(this.nGridX||1E6))),Q.parentNode.insertBefore(Q,Q.parentNode.firstChild),Q=map.Dom.newShape("line",g,this.plot_last_position[T].x-40,this.plot_last_position[T].y,this.plot_last_position[T].x+40,this.plot_last_position[T].y,"stroke:"+A+";stroke-width:"+map.Scale.normalX(this.nLineWidth||3)+";"),Q.setAttributeNS(szMapNs,"value",String(w)),Q.setAttributeNS(szMapNs,"class",String(R%(this.nGridX||1E6))),Q.parentNode.insertBefore(Q,Q.parentNode.firstChild),
Q=map.Dom.newShape("line",g,V,0,V,-this.nPlotHeight,"stroke:#dddddd;stroke-width:"+map.Scale.normalX(.25)+";"),Q.setAttributeNS(szMapNs,"value",String(w)),Q.setAttributeNS(szMapNs,"class",String(R%(this.nGridX||1E6))),Q.parentNode.insertBefore(Q,Q.parentNode.firstChild)):(Q=map.Dom.newShape("line",g,this.plot_last_position[T].x,this.plot_last_position[T].y,V,-na*L,"stroke:"+A+";stroke-width:"+map.Scale.normalX(this.nLineWidth||3)+";"),Q.setAttributeNS(szMapNs,"value",String(w)),Q.setAttributeNS(szMapNs,
"class",String(R%(this.nGridX||1E6))),g.insertBefore(Q,this.plot_last_shape[T]))),this.plot_last_last_position[T]=this.plot_last_position[T]||new point(0,0),this.plot_last_position[T]=new point(V,-na*L),this.plot_last_shape[T]=F):c.match(/BOX/)&&map.Dom.newShape("line",da,V,0,V,-this.nPlotHeight,"stroke:#dddddd;stroke-width:"+map.Scale.normalX(.25)+";"):c.match(/PLOTVAR/)?(Q=null,qa=c.match(/MEDIAN/)?this.nMedianA[M]:this.nMeanA[M],qa-=ta,Q=map.Dom.newShape("line",da,V,-(qa-this.nDeviationA[M])*L,
V,-(qa+this.nDeviationA[M])*L,"stroke:#aaaaaa;stroke-width:"+map.Scale.normalX(1)+";"),Q.setAttributeNS(szMapNs,"value",String(w)),Q.setAttributeNS(szMapNs,"class",String(R%(this.nGridX||1E6))),Q=map.Dom.newShape("line",da,V-40,-qa*L,V+40,-qa*L,"stroke:#aaaaaa;stroke-width:"+map.Scale.normalX(2)+";"),Q.setAttributeNS(szMapNs,"value",String(w)),Q.setAttributeNS(szMapNs,"class",String(R%(this.nGridX||1E6))),Q=map.Dom.newShape("line",da,V-80,-(qa-this.nDeviationA[M])*L,V+80,-(qa-this.nDeviationA[M])*
L,"stroke:#aaaaaa;stroke-width:"+map.Scale.normalX(1)+";"),Q.setAttributeNS(szMapNs,"value",String(w)),Q.setAttributeNS(szMapNs,"class",String(R%(this.nGridX||1E6))),Q=map.Dom.newShape("line",da,V-80,-(qa+this.nDeviationA[M])*L,V+80,-(qa+this.nDeviationA[M])*L,"stroke:#aaaaaa;stroke-width:"+map.Scale.normalX(1)+";"),Q.setAttributeNS(szMapNs,"value",String(w)),Q.setAttributeNS(szMapNs,"class",String(R%(this.nGridX||1E6))),map.Dom.newShape("line",da,V,0,V,-this.nPlotHeight,"stroke:#dddddd;stroke-width:"+
map.Scale.normalX(.25)+";"),this.plot_last_position[T]&&(Q=map.Dom.newShape("line",da,this.plot_last_position[T].x,this.plot_last_position[T].y,V,-qa*L,"stroke:#888888;stroke-width:"+map.Scale.normalX(1)+";")),this.plot_last_last_position[T]=this.plot_last_position[T]||new point(0,0),this.plot_last_position[T]=new point(V,-qa*L)):c.match(/BOX/)&&map.Dom.newShape("line",da,V,0,V,-this.nPlotHeight,"stroke:#dddddd;stroke-width:"+map.Scale.normalX(.25)+";");this.plot_last_value[La]=w;this.plot_last_stacked_value[La]=
na}ra=0}else"label"==ba&&(ra-=1.2*Y),F.fu.setPosition(map.Scale.normalX(0)+Da,map.Scale.normalY(0)+ra),ka&&ka.fu.setPosition(map.Scale.normalX(0)+Da,map.Scale.normalY(0)+ra),J&&J.fu.setPosition(Da,map.Scale.normalY(0)+ra),ra="label"==ba?ra-.33*Y:ra-u}}}Ra&&Ra.parentNode.appendChild(Ra);Ob&&Ob.parentNode.appendChild(Ob);Pb&&Pb.parentNode.appendChild(Pb);K&&K.parentNode.appendChild(K);if(0&c.match(/AREA/)&&!this.nGridX&&this.plot_area_points&&this.plot_area_points.length){for(var Lc=!0,qc=this.plot_area_points.length,
oa=0;oa<qc;oa++)0==this.plot_area_points[oa].y&&(Lc=!1);if(Lc||c.match(/ZEROISVALUE/)){for(var Va="M"+this.plot_area_points[0].x+","+this.plot_area_points[0].y+" L ",oa=1;oa<qc;oa++)Va+=this.plot_area_points[oa].x+","+this.plot_area_points[oa].y+" ";Va+=this.plot_area_points[qc-1].x+",0 ";Va+="0,0 ";Va+="z ";this.plot_area_shapes[0].setAttributeNS(null,"d",Va)}}if("undefined"!=typeof this.szSymbolBoxStyle){var Mc=map.Dom.getBox(g);nb.setAttributeNS(null,"x",-map.Scale.normalX(15));nb.setAttributeNS(null,
"y",-map.Scale.normalY(15));nb.setAttributeNS(null,"width",map.Scale.normalX(30*Fc));nb.setAttributeNS(null,"height",map.Scale.normalY(30));nb.setAttributeNS(null,"fill-opacity",1)}C.x=map.Scale.normalY(0);C.y=map.Scale.normalY(c.match(/ZOOM/)||c.match(/MENUSIZE/)?20:u/map.Scale.normalY(1)+5)}else if(c.match(/BUFFER/)){N=this.nMaxA[0];w=l[0];u=this.nBufferSize?this.nBufferSize:1E3;this.szShapeType.match(/line/)&&(u*=this.nScale);u=map.Scale.getDeltaXofDistanceInMeter(u);A=this.colorScheme[0];if(this.szFields&&
this.szFields.length&&this.nRangesA&&this.nRangesA.length&&(A=null,this.nRangesA.length==this.colorScheme.length))for(k=0;k<this.nRangesA.length;k++)if(w==this.nRangesA[k]||Number(w)==Number(this.nRangesA[k])){A=this.colorScheme[k];D=__maptheme_getChartColors(A);I="undefined"!=typeof this.szBorderColor?this.szBorderColor:.8>this.fillOpacity?"#888888":D.textColor;break}if(this.szShapeType.match(/point/))if(A){f=2*u/map.Scale.normalX(1);C.x=0;C.y=u+map.Scale.normalY(5);this.szFlag.match(/OVERLAY/);
F=map.Dom.newShape("circle",g,0,0,u,"");if(this.szFlag.match(/VALUE/))var vb="font-family:arial;font-size:"+map.Scale.normalX(5)+"px;fill:#222222;stroke-dasharray:none;pointer-events:none;",J=map.Dom.newText(g,u-map.Scale.normalX(5),0,vb,Map.Scale.prototype.formatDistanceString(this.nBufferSize));this.nRealizedCount++}else return new point(0,0);if(this.szShapeType.match(/line/)){var Vb=SVGDocument.getElementById(b),rc=Vb.getAttributeNS(null,"id");if(!rc.match(":paint")){var Hb=SVGDocument.getElementById(rc+
":paint");Hb||(Hb=Vb.cloneNode(1E3),g.appendChild(Hb),Hb.setAttributeNS(null,"id",rc+":paint"));Vb=Hb;this.nRealizedCount++}var Zc=2*u/map.Scale.normalX(1);Vb.setAttributeNS(null,"style","fill:none;stroke:"+A+";stroke-linejoin:round;stroke-linecap:round;stroke-width:"+map.Scale.normalX(Zc)*map.Scale.nZoomScale+";stroke-opacity:"+String(this.fillOpacity?this.fillOpacity:this.nOpacity?this.nOpacity:0)+"");return null}}else if(c.match(/BAR/)||c.match(/BARS/)){var P=0,ha=0,$c=f,Ea=1,pa=0,B=1,va=this.nMax-
this.nMin,Lb=this.nMax100-this.nMin100;this.nNormalSizeValue&&(va=Lb=this.nMaxSize=this.nNormalSizeValue);if(c.match(/SIZE/)&&!c.match(/NORMSIZE/)&&this.szSizeField&&b&&this.itemA[b])Ea=c.match(/SIZELOG/)?1/Math.log(this.nMaxSize)*Math.log(this.itemA[b].nSize):c.match(/SIZEP4/)?1/Math.pow(this.nMaxSize,.25)*Math.pow(this.itemA[b].nSize,.25):c.match(/3D/)||c.match(/SIZEP3/)||c.match(/SIZEVOLUME/)?1/Math.pow(this.nMaxSize,1/3)*Math.pow(this.itemA[b].nSize,1/3):1/Math.sqrt(this.nMaxSize)*Math.sqrt(this.itemA[b].nSize);
else if(c.match(/SIZE/)&&!c.match(/NORMSIZE/)){var Wa=r;c.match(/POINTER/)&&(Wa/=l.length);Ea=c.match(/SIZELOG/)?1/Math.log(va)*Math.log(Math.abs(Wa)):c.match(/SIZEP4/)?1/Math.pow(va,.25)*Math.pow(Math.abs(Wa),.25):c.match(/3D/)||c.match(/SIZEP3/)||c.match(/SIZEVOLUME/)?1/Math.pow(va,1/3)*Math.pow(Math.abs(Wa),1/3):1/Math.pow(va,.5)*Math.pow(Math.abs(Wa),.5)}0==Ea&&0!=r&&(Ea=30/f);f*=Ea;var z=map.Scale.normalX(f/l.length*.66);c.match(/STACKED/)&&(z=map.Scale.normalX(f/3),this.nGridX&&!c.match(/MULTI/)&&
(z/=2));c.match(/MENUSIZE/)&&1==l.length&&(z=map.Scale.normalX(f/2));O=z<map.Scale.normalX(5)?4*z/5:5*z/5;Qa=1;c.match(/COLUMN/)&&(z*=c.match(/THICK/)?2:c.match(/THIN/)?1:1.5);c.match(/THIN/)&&(z*=.6,O*=.75);c.match(/THICK/)&&(z*=1.5,O*=1.5);c.match(/STACKED/)?O=map.Scale.normalX(5):(c.match(/ZOOM/)||c.match(/NORMSIZE/))&&1==l.length&&(O*=2.5);c.match(/STACKED/)&&!c.match(/ZOOM/)&&(O*=Ea);vb="font-family:arial;font-size:"+.95*O+"px;fill:#606060;pointer-events:none;";vb=map.Scale.tStyle.Values.szStyle+
"font-size:"+.95*O+"px";c.match(/NORMSIZE/)||c.match(/MENUSIZE/)||this.szFlag.match(/NORMSIZE/)||this.szFlag.match(/MENUSIZE/)||!this.nNormalSizeValue||this.szField100&&!c.match(/POINTER/)||(x=this.nNormalSizeValue);this.nOverrideMax&&(x=this.nOverrideMax);G=map.Scale.normalX($c)/x;if(c.match(/OFFSETMEAN/)||c.match(/OFFSETMEDIAN/)||c.match(/DEVIATION/))G=map.Scale.normalX(f)/300;c.match(/SIZE/)&&c.match(/SEQUENCE/)&&b&&1<l.length&&!this.szSizeField&&!this.szField100?G=G*l.length/Ea:c.match(/SIZE/)&&
b&&1<l.length&&!c.match(/EXPAND/)&&(G=this.szField100||c.match(/POINTER/)?G*Ea:G/(c.match(/SIZEP4/)?Ea*Ea:Ea));!this.nRangeScale||c.match(/ZOOM/)&&c.match(/HORZ/)||(G*=this.nRangeScale);c.match(/COMPRESSMAX/)?G/=4:c.match(/COMPRESSMORE/)?G/=3:c.match(/COMPRESS/)?G/=2:c.match(/EXPANDMAX/)?G*=4:c.match(/EXPANDMORE/)?G*=3:c.match(/EXPAND/)&&(G*=2);c.match(/POINTER/)&&!c.match(/NORMSIZE/)&&(G*=1.2);var sc=map.Dom.newGroup(g,"");if(c.match(/SORT/)){this.sortedIndex=[];for(k=0;k<l.length;k++)this.sortedIndex[k]=
{index:k,value:l[k]};this.sortedIndex.sort(c.match(/STACKED/)?this.sortIndexUp:this.sortIndexDown)}else this.sortedIndex=null;bb=0;c.match(/\|UP/)&&(bb=l.length-1);var ca=1;c.match(/CENTER/)&&(ca=2);for(var ob=new point(0,0),Wb=null,Ma=null,Xa=null,Ya=null,ya=null,tc=null,Xb=Wa=0,R=null,ad=G,k=this.nClipParts&&this.nClipParts<l.length?l.length-this.nClipParts:0;k<l.length;k++){if(this.szShowParts){Eb=!0;for(oa in this.szShowPartsA)this.szShowPartsA[oa]==k&&(Eb=!1);if(Eb)continue}G=ad;M=Math.abs(bb-
k);this.sortedIndex&&(M=this.sortedIndex[M].index);R=M;w=l[M];this.szFlag.match(/CLIP/)&&!this.szFlag.match(/MORPH/)&&this.nClipFrames&&(w=this.nClipFrames==l.length?Number(l[this.nActualFrame]):l[0]*(this.nClipFrames-1-this.nActualFrame)/(this.nClipFrames-1)+l[l.length-1]*this.nActualFrame/(this.nClipFrames-1),M=this.nActualFrame,k=l.length);var za=w;c.match(/INVERT/)&&(0!=w||c.match(/ZEROISVALUE/))&&(w=this.nMax-w);c.match(/DIFFERENCE/)&&c.match(/SUM/)&&(za=Wa+=w);Aa=this.formatValue(w,this.szValueDecimals||
2);c.match(/OFFSETMEAN/)||c.match(/OFFSETMEDIAN/)?(c.match(/OFFSETMEAN/)&&(w*=100/this.nMeanA[M]),c.match(/OFFSETMEDIAN/)&&(w*=100/this.nMedianA[M]),w-=100,za=w=isFinite(w)&&!isNaN(w)?w:0,x=100,Aa=this.formatValue(w,this.szValueDecimals||2),0<w&&(Aa="+"+Aa)):c.match(/DEVIATION/)&&(w=(w-this.nMeanA[M])/this.nDeviationA[M],za=w=isFinite(w)&&!isNaN(w)?w:0,w*=100,Aa=this.formatValue(w,this.szValueDecimals||2),0<w&&(Aa="+"+Aa));var ia=this.colorScheme[M];if((c.match(/SEQUENCE/)||1==l.length)&&2<=this.colorScheme.length)for(ia=
this.colorScheme[this.partsA.length-1],ii=0;ii<this.partsA.length;ii++)if(w<this.partsA[ii].max){ia=this.colorScheme[ii];R=ii;break}c.match(/LEFT/)&&c.match(/HORZ/)&&(w=-w);0>w&&!c.match(/STACKED/)&&(ha=-w*G,w=-w);c.match(/VOLUME/)&&c.match(/3D/)?(G=1,w=this.szSizeField&&b?z=map.Scale.normalX(f/3*2)*Math.pow(1/this.nMaxSize*this.itemA[b].nSize,1/3):z=map.Scale.normalX(f/3*2)*Math.pow(1/x*w,1/3)):(c.match(/POINTER/)&&c.match(/SIZE/)&&b&&(z=c.match(/WIDTH/)&&q&&(!(c.match(/DIFFERENCE/)||c.match(/RELATIVE/)||
c.match(/FRACTION/))||c.match(/OFFSETMEAN/)||c.match(/OFFSETMEDIAN/)||c.match(/DEVIATION/))?map.Scale.normalX(f)*Math.pow(Math.abs(1/this.nMax100*q),.5):map.Scale.normalX(f)*Math.pow(Math.abs(1/x*w),1/3),O=.6*z,this.nValueSizeMin&&!c.match(/ZOOM/)&&(O=O*map.Layer.nDynamicObjectScale>map.Scale.normalX(this.nValueSizeMin)?O:0),c.match(/ZOOM/)||(Qa=Math.pow(Math.abs(w),.5)/Math.pow(x,.5),this.szFadeValuePow&&Number(this.szFadeValuePow)&&(Qa=Math.pow(Math.abs(w),Number(this.szFadeValuePow))/Math.pow(x,
Number(this.szFadeValuePow))))),c.match(/DTEXT/)&&b&&!c.match(/ZOOM/)?(O=map.Scale.normalX(f/3*2)*Math.pow(Math.abs(1/x*w),.5)*.75,this.nValueSizeMin&&!c.match(/ZOOM/)&&(O=O*map.Layer.nDynamicObjectScale>map.Scale.normalX(this.nValueSizeMin)?O:0),Qa=Math.pow(Math.abs(w),1/3)/Math.pow(x,1/3)):this.nValueSizeMin&&!c.match(/ZOOM/)&&(O=O*map.Layer.nDynamicObjectScale>map.Scale.normalX(this.nValueSizeMin)?O:0));w=isFinite(w)&&!isNaN(w)?w:0;if(0==w&&c.match(/NOZERO/))ha=0;else if(0>za&&c.match(/NONEGATIVE/))ha=
0;else if(0<za&&c.match(/ONLYNEGATIVE/))ha=0;else{var S=map.Dom.newGroup(sc,"");this.szFlag.match(/MENUSIZE/)&&1==l.length&&!c.match(/VOLUME/)&&(z*=.8,w=z/G*1.7,map.Dom.newShape("rect",S,0,-map.Scale.normalY(.75*f),map.Scale.normalX(.5*f),map.Scale.normalY(.75*f),"fill:red;stroke:none;fill-opacity:0"));var ja=w;if(c.match(/COLUMN/))0<w*G&&(U=DonutCharts.newChart(SVGDocument,S,P+z/2,0,z/2,0),U.setStyle("3D"),U.addStyle("SILENT"),U.addPart(100,w*G*2-(c.match(/SPACED/)?z/2:z/5),ia,0,(this.szAggregation&&
this.szAggregation.match(/sum/),this.formatValue(l[ea],this.szValueDecimals||(5>l[ea]?1:0),"ROUND")+this.szUnit),this.formatValue(l[ea],2)+this.szUnit+la),U.realize());else if(c.match(/3D/)){D=__maptheme_getChartColors(ia);if(c.match(/VOLUME/)&&Ma){var ua=(w*G-Ma)/15,ha=ha+ua,A="white",A="#444444",A=tc.borderColor;szFillColor=tc.mainColor;szFillOpacity=.3;Ma<w*G&&(szFillOpacity=.2);map.Dom.newShape("line",S,Xa+ya,Ya-ua,P,ha-ua,"stroke:"+A+";stroke-width:"+map.Scale.normalX(.25)+";");map.Dom.newShape("line",
S,Xa+ya,Ya-Ma-ua,P,ha-w*G-ua,"stroke:"+A+";stroke-width:"+map.Scale.normalX(.25)+";");map.Dom.newShape("line",S,Xa+ya+ya/3,Ya-ya/4-ua,P+z/3,ha-z/4-ua,"stroke:"+A+";stroke-width:"+map.Scale.normalX(.25)+";");map.Dom.newShape("line",S,Xa+ya+ya/3,Ya-Ma-ya/4-ua,P+z/3,ha-w*G-z/4-ua,"stroke:"+A+";stroke-width:"+map.Scale.normalX(.25)+"");map.Dom.newShape("path",S,"M"+(Xa+ya)+","+(Ya-ua)+" L "+P+","+(ha-ua)+" "+P+","+(ha-w*G-ua)+" "+(Xa+ya)+","+(Ya-Ma-ua)+" z","fill:"+szFillColor+";stroke:"+A+";stroke-width:"+
map.Scale.normalX(.05)+";fill-opacity:"+szFillOpacity);Ma-w*G>-z/4&&map.Dom.newShape("path",S,"M"+(Xa+ya)+","+(Ya-Ma-ua)+" L "+P+","+(ha-w*G-ua)+" "+(P+z/3)+","+(ha-w*G-z/4-ua)+" "+(Xa+ya+ya/3)+","+(Ya-Ma-ya/4-ua)+" z","fill:"+szFillColor+";stroke:"+A+";stroke-width:"+map.Scale.normalX(.05)+";fill-opacity:"+szFillOpacity)}Ma=w*G;Xa=P;Ya=ha;ya=z;tc=D;if(ja=this.nFilterA[M]){var Ib="fill:#FFFFFF;stroke:gray;stroke-width:"+map.Scale.normalX(.5)+";fill-opacity:0.1;stroke-opacity:0.1";map.Dom.newShape("path",
S,"M"+P+",0 l "+z+",0 "+z/3+","+-z/4+" "+-z+" 0 z",Ib);map.Dom.newShape("rect",S,P+z/3,-ja*G/ca-z/4,z,ja*G,Ib);map.Dom.newShape("path",S,"M"+P+",0 l 0,"+-ja*G/ca+" "+z/3+","+-z/4+" 0,"+ja*G+" z",Ib);map.Dom.newShape("rect",S,P,-ja*G/ca,z,ja*G,Ib);map.Dom.newShape("path",S,"M"+(P+z)+",0 l 0,"+-ja*G/ca+" "+z/3+","+-z/4+" 0,"+ja*G+" z",Ib);D.highColor=ColorScheme.getDerivateColor(ia,.9)}0>=ha||c.match(/LEFT/)||c.match(/VOLUME/)?(w&&(0==w&&(D=__maptheme_getChartColors("none")),map.Dom.newShape("rect",
S,P,-w*G/ca,z,w*G,"fill:"+D.mainColor+";stroke:"+D.borderColor+";stroke-width:"+map.Scale.normalX(.05)+";stroke-opacity:0.3"),map.Dom.newShape("path",S,"M"+(P+z)+",0 l 0,"+-w*G/ca+" "+z/3+","+-z/4+" 0,"+w*G+" z","fill:"+D.lowColor+";stroke:"+D.borderColor+";stroke-width:"+map.Scale.normalX(.05)+""),D.highColor=ColorScheme.getDerivateColor(ia,.9)),map.Dom.newShape("path",S,"M"+P+","+-w*G/ca+" l "+z+",0 "+z/3+","+-z/4+" "+-z+" 0 z","fill:"+D.highColor+";stroke:"+D.borderColor+";stroke-width:"+map.Scale.normalX(.05)+
";stroke-opacity:1")):(map.Dom.newShape("path",S,"M"+P+",0 l "+z+",0 "+z/3+","+-z/4+" "+-z+" 0 z","fill:"+D.highColor+";stroke:"+D.borderColor+";stroke-width:"+map.Scale.normalX(.05)+";fill-opacity:0.2"),map.Dom.newShape("rect",S,P+z/3,-w*G/ca-z/4,z,w*G,"fill:"+D.mainColor+";stroke:"+D.borderColor+";stroke-width:"+map.Scale.normalX(.05)+";fill-opacity:0.4"),map.Dom.newShape("path",S,"M"+P+",0 l 0,"+-w*G/ca+" "+z/3+","+-z/4+" 0,"+w*G+" z","fill:"+D.lowColor+";stroke:"+D.borderColor+";stroke-width:"+
map.Scale.normalX(.05)+";fill-opacity:0.4"),D.highColor=ColorScheme.getDerivateColor(ia,.9),map.Dom.newShape("rect",S,P,-w*G/ca,z,w*G,"fill:"+D.mainColor+";stroke:"+D.borderColor+";stroke-width:"+map.Scale.normalX(.05)+";fill-opacity:0.4"),map.Dom.newShape("path",S,"M"+(P+z)+",0 l 0,"+-w*G/ca+" "+z/3+","+-z/4+" 0,"+w*G+" z","fill:"+D.lowColor+";stroke:"+D.borderColor+";stroke-width:"+map.Scale.normalX(.05)+";fill-opacity:0.4"),D.highColor=ColorScheme.getDerivateColor(ia,.9));ja&&(map.Dom.newShape("rect",
S,P,-ja*G/ca,z,ja*G,"fill:#FFFFFF;stroke:none;stroke-width:"+map.Scale.normalX(.05)+";fill-opacity:0.25"),ja>w?map.Dom.newShape("path",S,"M"+P+","+-ja*G/ca+" l "+z+",0 "+z/3+","+-z/4+" "+-z+" 0 z","fill:#8888FF;stroke:#444488;stroke-width:"+map.Scale.normalX(.1)+";fill-opacity:0.2"):map.Dom.newShape("path",S,"M"+P+","+-ja*G/ca+" l "+z+",0 "+z/3+","+-z/4+" "+-z+" 0 z","fill:#8888FF;stroke:"+D.borderColor+";stroke-width:"+map.Scale.normalX(.1)+";fill-opacity:0.1;stroke-opacity:0.4"))}else if(c.match(/Border/)){map.Dom.newShape("rect",
S,P,-w*G/ca,z,w*G,"fill:"+ia+";stroke:none;");var wb=P+2,xb=P+z-2,Jb=2-w*G/ca,Yb=Jb+w*G-2,D=__maptheme_getChartColors(ia);map.Dom.newShape("line",S,wb,Jb,wb,Yb,"stroke:white;stroke-width:"+map.Scale.normalX(.001)+";stroke-opacity:1.0");map.Dom.newShape("line",S,wb,Jb,xb,Jb,"stroke:white;stroke-width:"+map.Scale.normalX(.001)+";stroke-opacity:1.0");map.Dom.newShape("line",S,wb,Yb,xb,Yb,"stroke:black;stroke-width:"+map.Scale.normalX(.001)+";stroke-opacity:0.9");map.Dom.newShape("line",S,xb,Jb,xb,Yb,
"stroke:black;stroke-width:"+map.Scale.normalX(.001)+";stroke-opacity:0.9")}else if(c.match(/POINTER/)&&w){(c.match(/OFFSETMEAN/)||c.match(/OFFSETMEDIAN/)||c.match(/DEVIATION/))&&1E3<Math.abs(w*G)&&(G=(1E3+(Math.abs(w*G)-1E3)/10+Math.abs(w*G)%1E3)/Math.abs(w));var Kb="fill:"+ia+";fill-opacity:"+(this.fillOpacity||1)+";stroke:"+(this.szLineColor||"black")+";stroke-opacity:0.5;stroke-width:"+map.Scale.normalX(this.nLineWidth*Ea||.25)+"";0>=ha?(!this.fShadow&&this.fOrigShadow&&map.Dom.newShape("path",
S,"M"+(P+z/7+10)+","+(-w*G/ca+10)+" l "+-z/7+",0 0,"+-z/15+" "+z/2+","+-z/3+" "+z/2+","+z/3+" 0,"+z/15+" "+-z/7+",0 0,"+w*G+" "+5*-z/7+",0 z","fill:000000;fill-opacity:0.5;stroke:none;"),map.Dom.newShape("path",S,"M"+(P+z/7)+","+-w*G/ca+" l "+-z/7+",0 0,"+-z/15+" "+z/2+","+-z/3+" "+z/2+","+z/3+" 0,"+z/15+" "+-z/7+",0 0,"+w*G+" "+5*-z/7+",0 z",Kb)):c.match(/NONEGATIVE/)||(c.match(/LEFT/)||(c.match(/ZOOM/)||c.match(/NORMSIZE/)?Kb="fill:"+ia+";stroke:"+ia+";stroke-width:"+map.Scale.normalX(.25)+";fill-opacity:0.5":
2<this.partsA.length?(D=__maptheme_getChartColors(ia),Kb="fill:"+ia+";stroke:"+D.lowColor+";stroke-width:"+map.Scale.normalX(.25)+";fill-opacity:"+(this.nFadeNegative||.1)+";stroke-opacity:0.8"):(D=__maptheme_getChartColors(ia),Kb="fill:"+ia+";stroke:"+D.highColor+";stroke-width:"+map.Scale.normalX(.5)+";fill-opacity:"+(this.nFadeNegative||.1)+";stroke-opacity:1")),map.Dom.newShape("path",S,"M"+(P+z/7)+","+-w*G/ca+" l "+5*z/7+",0 0,"+w*G+" "+z/7+",0 "+-z/2+","+z/4+" "+-z/2+","+-z/4+" "+z/7+",0 z",
Kb))}else 0>=ha||c.match(/LEFT/)?map.Dom.newShape("rect",S,P,-w*G/ca,z,w*G,"fill:"+ia+";fill-opacity:"+(this.fillOpacity||1)+";stroke:"+(this.szLineColor||"black")+";stroke-width:"+map.Scale.normalX(this.nLineWidth*Ea||.2)+";stroke-opacity:"+(this.nLineWidth?1:.1)+""):map.Dom.newShape("rect",S,P,-w*G/ca,z,w*G,"fill:"+ia+";fill-opacity:"+(this.fillOpacity||1)+";stroke:"+ia+";stroke-width:"+map.Scale.normalX(.25)+";fill-opacity:0.3"),(ja=this.nFilterA[M])&&(0>=ha||c.match(/LEFT/)?map.Dom.newShape("rect",
S,P,-ja*G/ca,z,ja*G,"fill:none;stroke:black;stroke-width:"+map.Scale.normalX(.5)+";stroke-opacity:0.1"):map.Dom.newShape("rect",S,P,-ja*G/ca,z,ja*G,"fill:none;stroke:"+ia+";stroke-width:"+map.Scale.normalX(.5)+";fill-opacity:0.3"));if((c.match(/VALUES/)||this.szXaxisA)&&!(0<ha&&c.match(/NONEGATIVE/))&&(c.match(/ZOOM/)||!this.szValueUpper||map.Scale.nTrueMapScale*map.Scale.nZoomScale<=this.nValueUpper)){w||(w=0);if(c.match(/AXIS/)&&!c.match(/STACKED/)&&(this.szLabelA||this.szXaxisA)){var La=M,Rb=this.szXaxisA?
this.szXaxisA[La]:this.szLabelA?this.szLabelA[La]:"",Nc=.8*O;c.match(/\|UP/)&&(Nc=.9*O);var J=map.Dom.newText(S,0,0,vb+";fill:#666666;text-anchor:end;font-size:"+Nc+"px"," "+Rb+" "),W=new point(map.Scale.normalX(.8),z/2+O/5*2);this.fNegativeValues?J.setAttributeNS(null,"transform","translate("+(P+W.y)+","+(-W.x+.9*O+10)+") rotate(270)"):c.match(/CENTER/)?J.setAttributeNS(null,"transform","translate("+(P+W.y)+","+(map.Scale.normalX(f/2)+.9*O)+") rotate(270)"):c.match(/HORZ/)?J.setAttributeNS(null,
"transform","translate("+(P+W.y)+","+(-W.x+.9*O+10)+") rotate(270)"):(J.style.setProperty("text-anchor","end",""),1==l.length?J.setAttributeNS(null,"transform","translate("+(P+(c.match(/VOLUME/)?1.3*z:1.5*W.y))+","+-W.x+") "):1<Rb.length?J.setAttributeNS(null,"transform","translate("+(P+W.y)+","+.8*O+") rotate(315)"):J.setAttributeNS(null,"transform","translate("+(P+.1*W.y)+","+(-W.x+O)+")"))}if(c.match(/VALUES/)&&0<O&&!(this.nGridX&&2<this.partsA.length/this.nGridX)){X=this.formatValue(za,this.szValueDecimals||
(1>=this.nMax?1:0));c.match(/POINTER/)&&0<za&&(0>this.nMin||c.match(/OFFSETMEAN/)||c.match(/OFFSETMEDIAN/))&&(X="+"+X);c.match(/VOLUME/)||(X+=this.szUnit?" "+this.szUnit+" ":"");!c.match(/STACKED/)||0==za||q||this.nGridX||(X=X+" ("+Math.round(za/r*100)+"%)");c.match(/STACKED/)&&(O=18);var Zb=X.length*O*4/8,J=this.createTextLabel(SVGDocument,S,"",X,O/map.Scale.normalX(1),null,0<za&&(c.match(/CTEXT/)||c.match(/VALUEBACKGROUND/))?ia:null,this.szTextColor);J.style.setProperty("opacity",String(Qa),"");
var uc=Pa=null;this.szXaxisA&&c.match(/EXACT/)&&!c.match(/AXIS/)&&(uc=map.Dom.newTSpan(J,"fill:fill:#444444;font-size:"+O+"px"," "+this.szXaxisA[k]));var yb=J.fu.getBox().width,W=new point(map.Scale.normalX(-4),z/2+.15*O),Oc=!0;if(c.match(/DOINLINETEXT/)&&!c.match(/ZOOM/)&&!c.match(/NORMSIZE/)||!c.match(/VALUE/)||c.match(/VOLUME/)&&!c.match(/ZOOM/)||!(c.match(/THIN/)||c.match(/NOINLINETEXT/)||c.match(/DTEXT/)||c.match(/SIZE/)||yb+map.Scale.normalX(1)>w*G/ca||c.match(/STACKED/)||c.match(/NORMSIZE/)||
c.match(/ZOOM/))){D=__maptheme_getChartColors(ia);J.removeChild(J.firstChild);J.firstChild.style.setProperty("fill",D.textColor,"");uc&&uc.style.setProperty("fill",D.textColor,"");Pa&&Pa.parentNode.removeChild(Pa);var bd=map.Scale.normalX(0),pb=map.Scale.normalY(.5);c.match(/VOLUME/)?(L=w*G/(yb+map.Scale.normalX(2)),J.parentNode.removeChild(J),J=map.Dom.newText(S,P+w*G/2,O*L/4-w*G/2,"font-family:arial;font-size:"+O*L+"px;text-anchor:middle;fill:"+D.textColor+";opacity:"+wa+";stroke:none;pointer-events:none",
X)):(L=Math.min(1,w*G/yb),.33>L?J.parentNode.removeChild(J):(0<za&&(W.x+=Math.max(map.Scale.normalX(1),w*G-(yb+map.Scale.normalX(3))*L)),pb/=L,J.firstChild.style.setProperty("font-size",String(O*L)),J.firstChild.setAttributeNS(null,"transform","translate("+(P+W.y-pb)+","+(-W.x-bd)+") rotate(270)\t")));ob.x=Math.max(0,ob.x-w*G)}else if(Oc=!1,c.match(/STACKED/))if(0!=w||c.match(/ZEROISVALUE/)){W.x=0;c.match(/3D/)&&(W.x+=z/4,W.y+=z/3);var $b=w*G/(c.match(/SUM/),2);ob.x=Math.max(0,ob.x+(.75*O-$b));var ac=
new point(ob.x+W.x+$b-O/3,0),Za=map.Scale.normalX(1.5),fb=P+W.y+z/3,gb=P+W.y+7*z/8,hb=-W.x-$b,ib=-ac.x-O/3;if(this.nGridX&&Xb<this.nGridX){W.y-=2*z+J.fu.getBox().width;var cd=gb,gb=fb-(c.match(/3D/)?1.5*z:1.4*z),fb=cd-(c.match(/3D/)?7*z/4:1.4*z);c.match(/3D/)&&(hb+=z/5,ib+=z/5,ac.x-=z/7);Za=-Za}J.setAttributeNS(null,"transform","translate("+(P+W.y+z+Za-O)+","+(-ac.x-.25*O)+") ");var vc=map.Dom.newGroup(S,""),wc=map.Dom.newGroup(S,"");map.Dom.newShape("line",vc,fb,hb,fb+Za,hb,"stroke-width:"+map.Scale.normalX(.15)+
";stroke:white;opacity:0.2;");map.Dom.newShape("line",wc,fb,hb,fb+Za,hb,"stroke-width:"+map.Scale.normalX(.05)+";stroke:#888888;");map.Dom.newShape("line",vc,fb+Za,hb,gb,ib,"stroke-width:"+map.Scale.normalX(.15)+";stroke:white;opacity:0.2;stroke-linecap:round;");map.Dom.newShape("line",wc,fb+Za,hb,gb,ib,"stroke-width:"+map.Scale.normalX(.05)+";stroke:#888888;");map.Dom.newShape("line",vc,gb,ib,gb+Za,ib,"stroke-width:"+map.Scale.normalX(.15)+";stroke:white;opacity:0.2;");map.Dom.newShape("line",wc,
gb,ib,gb+Za,ib,"stroke-width:"+map.Scale.normalX(.05)+";stroke:#888888;");ob.x=Math.max(0,ob.x+(2*O/3-(w*G-$b)))}else J.parentNode.removeChild(J);else{W.x+=z/4;c.match(/3D/)&&(W.x+=z/4,W.y=.3*z+O/2);c.match(/POINTER/)&&0<za&&(W.x+=.25*z);var jb=w;yb+map.Scale.normalX(1)>(ja-w)*G/ca&&(jb=Math.max(w,ja),ja>w&&(jb+=z/G*.2,map.Dom.newShape("line",S,P+.6*z,-W.x-w*G/ca+z/3,P+.6*z,-W.x-ja*G/ca-.4*z,"stroke:white;")));c.match(/VOLUME/)&&(jb+=z/5);if(1!=l.length||c.match(/HORZ/)||c.match(/VOLUME/))c.match(/VOLUME/)?
J.setAttributeNS(null,"transform","translate("+(P+W.y)+","+(-W.x-jb*G/ca)+")  scale(0.9,0.9)"):J.setAttributeNS(null,"transform","translate("+(P+W.y)+","+(-0-jb*G/ca)+") rotate(270) scale(0.9,0.9)");else{if(c.match(/ZOOM/)||c.match(/NORMSIZE/)){W.y+=c.match(/3D/)?.75*z:.5*z;var dd=Math.min(0,.55*O-w*G),Pc=O;!c.match(/3D/)&&!c.match(/ZOOM/)||c.match(/SIZE/)||(Pc=0);J.setAttributeNS(null,"transform","translate("+(P+Pc)+","+(dd-.5*O)+")")}else W.y+=c.match(/3D/)?c.match(/VOLUME/)?.75*z:.6*z:.2*z,J.setAttributeNS(null,
"transform","translate("+(P-.8*z)+","+(-jb*G/ca-.8*O-(c.match(/POINTER/)&&0<za?.3*z:0))+")");0>za&&J.style.setProperty("opacity",String(.75*Qa),"")}J.style.setProperty("fill","#404040","")}}}null!=h&&k==h&&(B=2*O,D=__maptheme_getChartColors(ia),map.Dom.newShape("path",S,"M5,0 l 35,-45 -25,0 0,-30 -20,0 0,30 -25,0 35,45","fill:#404040;stroke:white;stroke-width:"+map.Scale.normalX(.2)+"").fu.setPosition(k*(z+1.5)+.5*z,-w*G+(Oc?-map.Scale.normalX(3):-yb-map.Scale.normalX(5.5))));c.match(/TRENDLINE/)&&
(pb=Math.min(w*G/2,map.Scale.normalY(1.5)),D=__maptheme_getChartColors(ia),A=D.lowColor,B=O/5,0<k&&(wb=(k-1)*(z+(c.match(/SPACED/)?z/5:1))+z/2,xb=k*(z+(c.match(/SPACED/)?z/5:1))+z/2,A="white",A=Wb>w?"#CC3333":Wb<w?"#22BB22":D.lowColor,map.Dom.newShape("line",S,wb,-Wb*G+pb,xb,-w*G+pb,"stroke:#666666;stroke-width:"+map.Scale.normalX(1/l.length*1.2)+";opacity:0.8")),map.Dom.newShape("circle",S,0,0,B,"fill:"+A+";stroke:none;opacity:0.8").fu.setPosition(k*(z+(c.match(/SPACED/)?z/5:0))+z/2,-w*G+pb));c.match(/SILENT/)||
(this.szFlag.match(/SEQUENCE/)?S.setAttributeNS(szMapNs,"tooltip",Aa+" ("+(this.szLabelA?this.szLabelA[R]:"")+") ["+this.szFieldsA[M]+"]"):(la=this.szFieldsA[M],this.szLabelA&&this.szLabelA[M]&&(la=this.szLabelA[M]),!r||this.szField100&&!this.szFlag.match(/FRACTION/)||(Aa=Aa+" ("+this.formatValue(100/r*w,2)+"%)"),S.setAttributeNS(szMapNs,"tooltip",Aa+this.szUnit+" "+la+"")));c.match(/FADEIN/)&&(2==l.length&&0==k?S.style.setProperty("opacity","0.6",""):c.match(/NORMSIZE/)||(fa=c.match(/FADEINP4/)?
10:3,S.style.setProperty("opacity",String(.1+.9*Math.pow(k+1,fa)/Math.pow(l.length,fa)),"")));c.match(/FADENEGATIVE/)&&0>za&&S.style.setProperty("opacity","0.5","");S.setAttributeNS(szMapNs,"class",String(R));S.fu.setPosition(0,ha);c.match(/STACKED/)?ha-=w*G:(ha=0,P+=z,c.match(/VOLUME/)&&c.match(/SPACED/)?P+=z/(2==l.length?2:4):c.match(/SPACED/)?P+=z/5:c.match(/\|UP/)||(P+=1));Xb++;c.match(/STACKED/)&&!c.match(/MULTI/)&&this.nGridX&&0==Xb%this.nGridX&&(ha=0,P+=z+z/20);Wb=w}}c.match(/HOR/)&&sc.setAttributeNS(null,
"transform","rotate(90) translate("+-P+",0)");C.y=0;C.x=0;c.match(/HOR/)?(C.y-=1*z/2,c.match(/3D/)&&(C.y-=1*z/3)):c.match(/STACKED/)?C.x=z/2:c.match(/Up/)||c.match(/HOR/)?C.x=0:C.x=z*Xb/2;c.match(/MENUSIZE/)&&(C.x+=z*(c.match(/HORZ/)?1:0),C.y+=z*(c.match(/HORZ/)?.3:0),C.y+=z*(c.match(/HORZ/)&&c.match(/3D/)?1:c.match(/VOLUME/)?.3:.6));this.nRealizedCount++;var xc=map.Dom.newGroup(g,"");xc.appendChild(sc);c.match(/ZOOM/)&&(L=240/O/(1<l.length?2:1),xc.fu.scale(L,L));xc.fu.setPosition(g.fu.getPosition().x-
C.x,-C.y);C.x=0;C.y=0;c.match(/HOR/)&&(C.y=1*z/2)}if(c.match(/EXTEND/)&&HTMLWindow.ixmaps.htmlgui_drawChartAfter)try{ma=this.objThemesA[this.szThemesA[0]],HTMLWindow.ixmaps.htmlgui_drawChartAfter(SVGDocument,{target:g,theme:this,item:b,values:l,maxSize:f,flag:c,mark:h,dbRecord:ma.dbRecords?ma.dbRecords[this.itemA[b].dbIndex]:null})}catch(hd){}if(!c.match(/NORMSIZE/)){var Fa=new point(C.x,C.y);C.y=0;C.x=0;this.szAlign&&!c.match(/PLOT/)&&(this.szAlign.match(/center/)&&(C.y=0),this.szAlign.match(/top/)&&
(C.y=Fa.y?Fa.y:map.Scale.normalX(f/5)),this.szAlign.match(/above/)&&(C.y=Fa.y?Fa.y:map.Scale.normalX(f/2)),this.szAlign.match(/2above/)&&(C.y+=map.Scale.normalX(f/2)),this.szAlign.match(/below/)&&(C.y=-(Fa.y?Fa.y:map.Scale.normalX(f/2))),this.szAlign.match(/2below/)&&(C.y-=map.Scale.normalX(f/2)),this.szAlign.match(/bottom/)&&(C.y=-(Fa.y?Fa.y:map.Scale.normalX(f/2))),this.szAlign.match(/2bottom/)&&(C.y-=map.Scale.normalX(f/2)),this.szAlign.match(/right/)&&(C.x=-(Fa.y?Fa.y:map.Scale.normalX(f/2))),
this.szAlign.match(/2right/)&&(C.x-=map.Scale.normalX(f/2)),this.szAlign.match(/left/)&&(C.x=Fa.y?Fa.y:map.Scale.normalX(f/2)),this.szAlign.match(/2left/)&&(C.x+=map.Scale.normalX(f/2)),this.szAlign.match(/baseline/)&&(C.y+=map.Scale.normalY(f/5)))}if(b&&this.szLabelField&&!c.match(/NORMSIZE/)&&!c.match(/ZOOM/)&&(!this.nLabelUpper||map.Scale.nTrueMapScale*map.Scale.nZoomScale<=this.nLabelUpper)){var la=(la=this.itemA[b].szLabel)?isNaN(__scanValue(la))?la+(this.szLabelUnits||""):this.formatValue(__scanValue(la),
2)+(this.szLabelUnits||""):this.szLabelField+"?",O=map.Scale.normalX(6),vb="opacity:0.7;font-family:arial;font-size:"+O+"px;text-anchor:middle;fill:#000000;pointer-events:none",ed="opacity:1;fill:white;fill-opacity:0.4;stroke:#000000;stroke-width:"+map.Scale.normalX(1)+"pointer-events:none;",Zb=(la.length+2)*O*.5,kb=map.Dom.newGroup(g,"");kb.parentNode.append(kb);c.match(/MULTI/)||kb.setAttributeNS(szMapNs,"class",String(R));var bc=map.Dom.newShape("rect",kb,-Zb/2,.95*-O,Zb,1.2*O,ed);bc.setAttributeNS(null,
"rx",.2*O);bc.setAttributeNS(null,"ry",.2*O);J=map.Dom.newText(kb,0,0,vb,la);Mc=J.fu.getBox();z=Math.max(Mc.width,Zb);bc.setAttributeNS(null,"x",-z/2);bc.setAttributeNS(null,"width",z);c.match(/MULTIPLE/)?kb.fu.setPosition(map.Scale.normalX(15)+.5*z,-O):kb.fu.setPosition(z/3,O/3+Fa.y);this.itemA[b].labelGroup=kb}if(c.match(/MENU/)){var cc=g.fu.getBox();g.fu.setPosition(-cc.x-cc.width/2,-cc.y-cc.height/2-map.Scale.normalY(f/2)-map.Scale.normalY(2))}else g.fu.setPosition(g.fu.getPosition().x-C.x,g.fu.getPosition().y-
C.y);if(c.match(/ZOOM/)){var yc=map.Dom.getBox(e);yc.height>map.Scale.normalY(150)&&(L=Math.min(1,map.Scale.normalY(150)/yc.height),L=Math.max(L,map.Scale.normalY(30)/yc.height),g.fu.scale(L,L),y&&y.fu.scale(L,L))}C.x=0;C.y=0;b&&(this.itemA[b].fDone=!0);this.nChartSizeDone=f;return C};MapTheme.prototype.getShapes=function(){var e=map.Layer.getLayerObj(this.szThemesA[0]);if(!e||!e.szFlag.match(/tiled/))for(a in this.itemA)this.parent.themeNodesA[a]||(this.parent.themeNodesA[a]=this.getShapeA(a))};
MapTheme.prototype.getItemNodes=function(e){this.parent.themeNodesA[e]&&this.parent.themeNodesA[e].length||(this.parent.themeNodesA[e]=this.getShapeA(e));return this.parent.themeNodesA[e]||[]};
MapTheme.prototype.getShapeA=function(e){e=__mpap_decode_utf8(e);var b=SVGDocument.getElementById(e.trim());if(b)return Array(b);if(e.match(/\,/)){var f=e.split("::"),c=f[0].split(",");for(i=0;i<c.length;i++)if(b=SVGDocument.getElementById((c[i]+"::"+f[1]).trim()))return Array(b)}this.nMissingLookupCount++;this.missedA[e]=e;return[]};MapTheme.prototype.getPositions=function(){for(a in this.itemA)this.getNodePosition(this.itemA[a].szSelectionId)};
MapTheme.prototype.getNodePosition=function(e){if("undefined"==typeof e)return null;var b=this.nGridWidth||this.szAggregationField?this.themeNodesPosA:this.parent.themeNodesPosA;if(!b[e]){if(e.match(/:clone/))return null;if(e.match(/(-?[0-9\.]+) ?, ?(-?[0-9\.]+)/)){var f=this.getMapPosition(e);b[e]=new point(f.x,f.y);return b[e]}this.parent.themeNodesA[e]||(this.parent.themeNodesA[e]=this.getShapeA(e));f=this.parent.themeNodesA[e][0];if(1<this.parent.themeNodesA[e].length)for(var c=parseFloat(f.getAttributeNS(szMapNs,
"area")),h=1;h<this.parent.themeNodesA[e].length;h++){var g=this.parent.themeNodesA[e][h],m=parseFloat(g.getAttributeNS(szMapNs,"area"));m>c&&(c=m,f=g)}f&&(this.szShapeType.match(/line/)?c=map.Dom.getBox(f):((c=f.getAttributeNS(szMapNs,"center"))||(c=f.parentNode.getAttributeNS(szMapNs,"center")),c&&2<c.length?(c=c.split(","),c=new box(Number(c[0].split(":")[1]),Number(c[1].split(":")[1]),0,0)):c=map.Dom.getBox(f)),f=map.Scale.getMapOffset(f),b[e]=new point(f.x+c.x+c.width/2,f.y+c.y+c.height/2))}return b[e]&&
"undefined"!=typeof b[e].x&&"undefined"!=typeof b[e].y?b[e]:null};
MapTheme.prototype.getNodeBox=function(e){if("undefined"==typeof e)return null;if(!this.parent.themeNodesBoxA[e]){if(e.match(/:clone/))return null;this.parent.themeNodesA[e]||(this.parent.themeNodesA[e]=this.getShapeA(e));var b=this.parent.themeNodesA[e][0];if(1<this.parent.themeNodesA[e].length)for(var f=parseFloat(b.getAttributeNS(szMapNs,"area")),c=1;c<this.parent.themeNodesA[e].length;c++){var h=this.parent.themeNodesA[e][c],g=parseFloat(h.getAttributeNS(szMapNs,"area"));g>f&&(f=g,b=h)}b&&(f=
map.Dom.getBox(b),b=map.Scale.getMapOffset(b),this.parent.themeNodesBoxA[e]=new box(b.x+f.x,b.y+f.y,f.width,f.height))}return this.parent.themeNodesBoxA[e]};MapTheme.prototype.getNodeArea=function(e){return(e=this.getItemNodes(e)[0])?Number(e.getAttributeNS(szMapNs,"area"))/1E6:0};positionRegExp=/(-?[0-9\.]+) ?, ?(-?[0-9\.]+)/;
MapTheme.prototype.getMapPosition=function(e){if(e){var b=null;if(e&&(b=e.match(positionRegExp)))return 180<Math.abs(parseFloat(b[1]))||180<Math.abs(parseFloat(b[2]))?new point(0,0):map.Scale.getMapPositionOfLatLon(parseFloat(b[1]),parseFloat(b[2]))}return new point(0,0)};MapTheme.prototype.onClick=function(e){this.fRemove||(this.widgetNode&&this.enable(),this.fToFront=!0,executeWithMessage("map.Themes.execute()","... processing ..."),map.Themes.onclickInfo(e,this.szId))};
MapTheme.prototype.showErrorInfo=function(){if(0!=this.nMissingPositionCount){var e=this.szId+":errordisplay:widget",b=map.Dictionary.getLocalText("Chart statistic"),b=new InfoContainer(SVGDocument,this.widgetNode,e+":movable",new point(map.Scale.normalX(0),map.Scale.normalX(0)),new point(-map.Scale.normalX(15),map.Scale.normalX(80)),"fixed",b),f=b.workspaceNode,c=[map.Dictionary.getLocalText("total items"),map.Dictionary.getLocalText("charts drawn"),map.Dictionary.getLocalText("missing positions"),
map.Dictionary.getLocalText("missing value match"),map.Dictionary.getLocalText("zero values"),String(this.nCount),String(this.nRealizedCount),String(this.nMissingPositionCount),String(this.nMissingRangeCount),String(this.nZeroValueCount)],f=map.Dom.newGroup(f,"");f.fu.setPosition(0,map.Scale.normalY(3));createTextGrid(SVGDocument,f,e+":textgrid",c,2);b.reformat()}};
MapTheme.prototype.getDataGrid=function(e,b){if(this.szFlag.match(/AGGREGATE/)&&3<this.itemA[e].nCount)return null;var f=map.Themes.getDataRow(e,this);if(f&&f.length){for(var c=0;c<f.length;c++)f[c]=f[c]||"---";(c=new ScrollArea(null,b,null,10,10,10))?(c.reformat(),gridGroup=c.workspaceNode):gridGroup=b;for(var h=[],g=map.Themes.getFieldIndexArray(this),m=0;m<g.length;m++)h[g[m]]="font-weight:bold;fill:#087BBB",h[g[m+f.length/2]]="font-weight:bold;fill:#087BBB";g=map.Scale.tStyle.Description.nFontHeight/
map.Scale.normalX(1);f=createTextGrid(SVGDocument,gridGroup,":textgrid",f,2,g,h);return c?(c.setWidth(Math.min(f.fu.getBox().width/map.Scale.normalX(1)+15,map.Scale.bBox.width/map.Scale.normalY(2.2))),c.setHeight(Math.min(f.fu.getBox().height/map.Scale.normalY(1)+15,map.Scale.bBox.height/map.Scale.normalY(2.2))),c.reformat(),c.hasScrollBars()&&c.setScrollPosition(new point(0,0)),c):f.fu}};function __sortYposUp(e,b){return e.y>b.y?1:-1}function __sortYposDown(e,b){return e.y<b.y?1:-1}
MapTheme.prototype.drawTextforOneQuadrant=function(e,b,f,c,h,g,m,l){var q=e.szStyle.match(/3D/)?2.4*f:1.2*f,x=q/2;l-=q*(b.length-2);for(i=0;i<b.length;i++){var r=b[i].y/b[i].ly,k=Math.max(x,Math.min(b[i].y,l)),x=k+q;l+=f;var H=1.2*b[i].x,H=m+map.Scale.normalX(2);k>b[i].y&&(r=Math.max(r,k/b[i].y));var w=e.mX+b[i].lx*h,B=e.mY+b[i].ly*g,D=e.mX+b[i].x*h,C=e.mY+b[i].y*g,H=e.mX+H*h,k=e.mY+k*g,y=map.Dom.newGroup(e.frameGroup,"");e.donutPartsA[b[i].index].textNode=y;var K=map.Dom.newGroup(y,""),E=map.Dom.newGroup(y,
"");r&&(map.Dom.newShape("line",K,w,B,D,C,"stroke:white;stroke-width:"+map.Scale.normalX(1.5)+";opacity:0.2;"),map.Dom.newShape("line",E,w,B,D,C,"stroke:#888888;stroke-width:"+map.Scale.normalX(.5)+";opacity:1;"),w=D,B=C);b[i].x<m-map.Scale.normalX(3)&&(map.Dom.newShape("line",K,w,B,e.mX+(m-map.Scale.normalX(3))*h,B,"stroke:white;stroke-width:"+map.Scale.normalX(1.5)+";opacity:0.2;stroke-linecap:round;"),map.Dom.newShape("line",E,w,B,e.mX+(m-map.Scale.normalX(3))*h,B,"stroke:#888888;stroke-width:"+
map.Scale.normalX(.5)+";opacity:1;"),w=e.mX+(m-map.Scale.normalX(3))*h);map.Dom.newShape("line",K,w,B,H,k,"stroke:white;stroke-width:"+map.Scale.normalX(1.5)+";opacity:0.2;stroke-linecap:round;");map.Dom.newShape("line",E,w,B,H,k,"stroke:#888888;stroke-width:"+map.Scale.normalX(.5)+";opacity:1;");w=H;H+=map.Scale.normalX(2)*h;map.Dom.newShape("line",K,w,k,H,k,"stroke:white;stroke-width:"+map.Scale.normalX(1.5)+";opacity:0.2;");map.Dom.newShape("line",E,w,k,H,k,"stroke:#888888;stroke-width:"+map.Scale.normalX(.5)+
";opacity:1;");H+=map.Scale.normalX(1.5)*h;(szText=e.partsA[b[i].index].szText?e.partsA[b[i].index].szText:null)||(szText=e.partsA[b[i].index].szInfo?e.partsA[b[i].index].szInfo:Math.round(10*e.partsA[b[i].index].nInfoValue)/10+" % ");r=this.createTextLabel(SVGDocument,y,"",szText,f/map.Scale.normalX(1),c,e.partsA[b[i].index].color,this.szChartFlag.match(/ZOOM/)?null:this.szTextColor);r.fu.setPosition(H-f,k-0*f);r.setAttributeNS(szMapNs,"tooltip",e.partsA[b[i].index].szInfo);e.szStyle.match(/3D/)&&
r.fu.scale(1,2)}};
MapTheme.prototype.drawDonutText=function(e,b){var f=0,c=0,h=0,g=[],m=[],l=[],q=[];for(i=0;i<this.partsA.length;i++){var x=e.getTextPosition(i);if(x){if(this.szShowPartsA){var r=!1;for(p in this.szShowPartsA)this.szShowPartsA[p]==i&&(r=!0);if(!r)continue}f=Math.max(f,Math.abs(x.y));c=Math.max(c,x.x);h=Math.min(h,x.x);e.szStyle.match(/STARBURST/)?(c=Math.max(c,x.x),h=Math.min(h,x.x)):(c=e.nRadOuter,h=-e.nRadOuter);0<x.x?0<x.y?m[m.length]={index:i,x:x.x,y:x.y,lx:x.lx,ly:x.ly}:g[g.length]={index:i,x:x.x,
y:-x.y,lx:x.lx,ly:-x.ly}:0<x.y?l[l.length]={index:i,x:-x.x,y:x.y,lx:-x.lx,ly:x.ly}:q[q.length]={index:i,x:-x.x,y:-x.y,lx:-x.lx,ly:-x.ly}}}g.sort(__sortYposUp);m.sort(__sortYposUp);l.sort(__sortYposUp);q.sort(__sortYposUp);b||(b=map.Scale.normalX(12));this.drawTextforOneQuadrant(e,g,b,"text-anchor:start;",1,-1,c,f);this.drawTextforOneQuadrant(e,m,b,"text-anchor:start;",1,1,c,f);this.drawTextforOneQuadrant(e,l,b,"text-anchor:end;",-1,1,-h,f);this.drawTextforOneQuadrant(e,q,b,"text-anchor:end;",-1,-1,
-h,f)};
MapTheme.prototype.createTextLabel=function(e,b,f,c,h,g,m,l){var q="#555555",x=!0,r=!0,k=1,H=" "+this.szChartFlag+"|"+this.szFlag;if(H.match(/ZOOM/)||H.match(/MENUSIZE/)||H.match(/NORMSIZE/)||H.match(/INFOSIZE/)||H.match(/AXIS/)||H.match(/SELECTION/))x=m?x:!1,r=!1;H.match(/VALUEBACKGROUND/)&&(x=!0);H.match(/HORZ/)&&(x=!1);h||(h=12);g||(g="");m&&x?(q=l||ColorScheme.getTextColor(m),k=H.match(/ZOOM/)?.9:.5):(m="#fefeff",q=0>parseFloat(c)?"#ee3333":q);if(e&&b)return e=map.Dom.newGroup(b,f),b=null,r&&
!this.fShadow&&this.fOrigShadow&&(b=map.Dom.newShape("rect",e,1,1,1,1,"fill:#444444;fill-opacity:0.4;stroke:none;")),m=map.Dom.newShape("rect",e,1,1,1,1,"fill:"+m+";fill-opacity:"+k+";stroke:#dddddd;stroke-width:"+map.Scale.normalX(.05*h)+""),g=map.Scale.tStyle.Values.szStyle+(this.szTextFont?"font-family:"+this.szTextFont:"")+";font-size:"+map.Scale.normalY(h)+"px;fill:"+q+";"+g,c=map.Dom.newText(e,map.Scale.normalX(h),map.Scale.normalY(.25*h),g,c),c=map.Dom.getBox(c),m.setAttributeNS(null,"rx",
map.Scale.normalX(.1*h)),m.setAttributeNS(null,"ry",map.Scale.normalX(.1*h)),m.setAttributeNS(null,"x",c.x-map.Scale.normalX(.3*h)),m.setAttributeNS(null,"y",c.y-map.Scale.normalY(0*h)),m.setAttributeNS(null,"width",c.width+map.Scale.normalX(.7*h)),m.setAttributeNS(null,"height",c.height+.1*map.Scale.normalY(h)),b&&(b.setAttributeNS(null,"rx",map.Scale.normalX(.1*h)),b.setAttributeNS(null,"ry",map.Scale.normalX(.1*h)),b.setAttributeNS(null,"x",c.x-map.Scale.normalX(.3*h)+map.Scale.normalX(.12*h)),
b.setAttributeNS(null,"y",c.y+map.Scale.normalY(0*h)+map.Scale.normalY(.12*h)),b.setAttributeNS(null,"width",c.width+map.Scale.normalX(.7*h)),b.setAttributeNS(null,"height",c.height+.1*map.Scale.normalY(h))),x||(m.style.setProperty("display","none",""),b&&b.style.setProperty("display","none","")),e};
MapTheme.prototype.getOverviewChart=function(e,b){e.fu=new Methods(e);var f=30;this.szChartFlag+="|MENUSIZE";if(this.szOverviewChart&&"NONE"!=this.szOverviewChart&&this.nCount){var f=map.Scale.normalX(100),c=map.Scale.normalY(100),h=map.Scale.normalX(75),g=map.Scale.normalX(50);if("undefined"!=typeof DonutCharts){var m=map.Dom.newGroup(e),f=DonutCharts.newChart(SVGDocument,m,f,c,h,g);this.szOverviewChart.match(/PIE/)&&(f.setStyle("flat"),f.setRadInner(0),f.setRadOuter(map.Scale.normalX(55)),f.setCenter(map.Scale.normalX(80),
map.Scale.normalY(55)));if(this.szOverviewChart.match(/DONUT/)||this.szOverviewChart.match(/3D/))f.setStyle("3D"),f.setCenter(map.Scale.normalX(80),map.Scale.normalY(100));f.setLine("white");f.setLineWidth(map.Scale.normalX(.1));c=map.Scale.normalY(20);for(h=0;h<this.partsA.length;h++){g=this.partsA[h].nCount/this.nCount*100;m=100/this.nSum*this.partsA[h].nSum;this.nRealizedCount&&this.szFlag.match(/CHART/)&&(g=this.partsA[h].nCount/this.nRealizedCount*100);this.nExactCount&&this.exactSizeA&&(g=this.partsA[h].nCount/
this.nExactCount*100,m=this.exactSizeA[h]);this.szOverviewChart.match(/DONUT/)&&(c=map.Scale.normalY(this.partsA[h].nSum/this.nSum*80));var l=String(this.partsA[h].nCount),q=g?String(" = "+this.formatValue(g,1)+" %"):"",x=m?String(", "+this.formatValue(m,1)+" % of value"):"";this.szOverviewChart.match(/PERCENTOFVALUE/)?(g=m,q="",l=this.nExactCount&&this.exactSizeA?String(this.formatValue(g,0)):String(this.formatValue(g,1)+(this.szFlag.match(/CHART/)?this.szUnit:" %"))):this.szOverviewChart.match(/DONUT/)||
(x="");this.szFlag.match(/EXACT/)?(q+=" ("+this.szLabelA[h]+")",x=""):this.szLegendLabelA&&this.szLegendLabelA.length&&(q+=" ["+this.szLegendLabelA[h]+"])");f.addPart(g,c,this.partsA[h].color,0,l,String(this.partsA[h].nCount)+" member(s)"+q+x,"map.Themes.markClass(evt,'"+this.szId+"','"+h+"')","map.Themes.unmarkClass(evt,'"+this.szId+"')")}f.realize();this.drawDonutText(f);f=map.Dom.getBox(e);if(0<f.width&&0<f.height){x=e.fu.getPosition();m=this.szOverviewChart.match(/PERCENTOFVALUE/)?"*  value / class":
"*  members / class";c=map.Scale.normalY(10);if(this.szOverviewChart.match(/DONUT/)||this.szOverviewChart.match(/3D/))c=map.Scale.normalY(15);map.Dom.newText(e,map.Scale.normalX(80),f.y+f.height+c,map.Scale.tStyle.Note.szStyle+";text-anchor:middle;",m)}}}else{if((this.szFlag.match(/BUBBLE/)||this.szFlag.match(/SQUARE/)||this.szFlag.match(/SYMBOL/))&&(!this.szFlag.match(/EXACT/)||!this.szFlag.match(/SYMBOL/))){h=this.nMinA[0];l=this.nMaxA[0];this.szSizeField&&(h=this.nMinSize,l=this.nMaxSize);c=map.Scale.normalX(f/
2);g=c/Math.sqrt(l)*Math.sqrt(h);if(this.szFlag.match(/LINEAR/)||this.szFlag.match(/SIZEP1/))g=c/l*h;m=this.szFlag.match(/SUM/)?"sum":"mean";nLinePos=5;nXPos=20;q=map.Dom.newGroup(e);if(!this.szFlag.match(/EXACT/)){var r=map.Dom.newGroup(q);this.drawChart(r,null,1.5*f,"VALUES|ZOOM|NORMSIZE");this.szFlag.match(/SEQUENCE/)&&(sChartBox=map.Dom.getBox(r),x=r.fu.getPosition(),r.fu.setPosition(sChartBox.width/1.5+x.x,-sChartBox.height/2+x.y),x=map.Scale.normalX(7*f)/sChartBox.height,r.fu.scale(x,x),f*=
7);map.Dom.newText(q,map.Scale.normalX(0),map.Scale.normalY(5),map.Scale.tStyle.Note.szStyle+";text-anchor:left;",map.Dictionary.getLocalText(m));q.fu.setPosition(map.Scale.normalX(nXPos),map.Scale.normalY(f));nLinePos=f+15}this.szFlag.match(/SEQUENCE/)||(m=map.Dom.newGroup(e),sumBox=map.Dom.getBox(q),m.fu.setPosition(sumBox.x+sumBox.width+map.Scale.normalX(.66*f),map.Scale.normalY(-5)),nLinePos=0,q="fill:none;stroke:black;stroke-width:"+map.Scale.normalX(.25)+"px",x=map.Dom.newGroup(m),this.szFlag.match(/BUBBLE/)?
map.Dom.newShape("circle",x,0,0,c,q):this.szFlag.match(/SQUARE/)&&map.Dom.newShape("rect",x,-c,-c,2*c,2*c,q),map.Dom.newShape("line",x,0,-c,1.1*c,-c,q),map.Dom.newText(x,1.1*c+map.Scale.normalX(2),-c,"font-family:arial;font-size:"+map.Scale.normalX(10)+"px;text-anchor:left;baseline-shift:-10%;fill:black;stroke:none;pointer-events:none",this.formatValue(l,1)+this.szUnit),x.fu.setPosition(map.Scale.normalX(nXPos),map.Scale.normalY(nLinePos+f/2)),0<g&&g!=c&&(l=map.Dom.newGroup(m),this.szFlag.match(/BUBBLE/)?
map.Dom.newShape("circle",l,0,0,g,q):this.szFlag.match(/SQUARE/)&&map.Dom.newShape("rect",l,-g,-g,2*g,2*g,q),map.Dom.newShape("line",l,0,-g,1.1*c,-g,q),map.Dom.newText(l,1.1*c+map.Scale.normalX(2),-g,"font-family:arial;font-size:"+map.Scale.normalX(10)+"px;text-anchor:left;baseline-shift:-60%;fill:black;stroke:none;pointer-events:none",this.formatValue(h,1)+this.szUnit),l.fu.setPosition(map.Scale.normalX(nXPos),map.Scale.normalY(nLinePos)+2*c-g)),map.Dom.newText(m,map.Scale.normalX(nXPos),map.Scale.normalY(nLinePos+
f+15),map.Scale.tStyle.Note.szStyle+";text-anchor:left;",map.Dictionary.getLocalText("min / max size-values")));e.fu.scale(1,1)}this.szFlag.match(/CHART/)&&this.szFlag.match(/BUFFER/)&&(c=map.Scale.normalX(f/2),h=map.Dom.getBox(e.parentNode),h=0<h.width?h.width/map.Scale.normalX(1)+10:10,x=map.Dom.newGroup(e.parentNode),map.Dom.newShape("circle",x,0,0,c,"fill:none;stroke:black;"),q="fill:none;stroke:black;stroke-width:"+map.Scale.normalX(1)+";",map.Dom.newShape("line",x,0,0,c,0,q),map.Dom.newShape("line",
x,0,map.Scale.normalY(-2),0,map.Scale.normalY(2.5),q),map.Dom.newShape("line",x,c,0,c+map.Scale.normalX(-3),map.Scale.normalY(-3),q),map.Dom.newShape("line",x,c,0,c+map.Scale.normalX(-3),map.Scale.normalY(3),q),map.Dom.newText(x,1.1*c+map.Scale.normalX(2),map.Scale.normalX(-10),"font-family:arial;font-size:"+map.Scale.normalX(10)+"px;text-anchor:left;baseline-shift:-10%;fill:black;stroke:none;pointer-events:none",Map.Scale.prototype.formatDistanceString(this.nBufferSize*this.nScale)),x.fu.setPosition(map.Scale.normalX(f/
2+h),map.Scale.normalY(f/2)),chartButtonObj=new Button(e.parentNode,b+":bufferselectbutton","BUTTON","#bufferselect_button","map.Selections.newSelection('activeLayer','activeBuffer','type:BUFFER;buffersize:200','test');","","select active layer with this buffer"),chartButtonObj.setPosition(map.Scale.normalX(f+h+10),map.Scale.normalY(f)),chartButtonObj.scale(1.4,1.4),chartButtonObj=null,_activeTheme&&map.Dom.newText(e.parentNode,map.Scale.normalX(f+h+20),map.Scale.normalY(f+6),"font-family:arial;font-size:"+
map.Scale.normalX(8)+"px;text-anchor:left;baseline-shift:-10%;fill:gray;stroke:none;pointer-events:none","... "+_activeTheme+""));if(!(!this.szFlag.match(/CHART/)||this.szFlag.match(/BUBBLE/)||this.szFlag.match(/SQUARE/)||this.szFlag.match(/EXACT/)||this.szFlag.match(/BUFFER/)||this.szFlag.match(/SYMBOL/))){c=map.Dom.getBox(e.parentNode);0>c.width&&(c=new box(0,0,0,0));f=30;this.szFlag.match(/BAR/)&&5<this.nOrigSumA.length&&!this.szFlag.match(/STACKED/)&&(f=15*this.nOrigSumA.length/Math.log(this.nOrigSumA.length));
this.drawChart(e,null,f,"VALUES|NORMSIZE"+(this.szFlag.match(/STACKED/)?"|EXPANDMAX":""));f=map.Dom.getBox(e);h=1;h=Math.min(2.5,Math.max(c.height/f.height,map.Scale.normalX(100)/f.height));e.fu=new Methods(e);e.fu.scale(h,h);summarizeGroup=map.Dom.newGroup(e,"textGroup");summarizeGroup.fu.scale(1/h,1/h);f=e.fu.getBox();this.szFlag.match(/BAR/)?e.fu.setPosition(c.width-f.x+map.Scale.normalX(10),-f.y+Math.max(10,.95*c.height-f.height)):e.fu.setPosition(c.width-f.x+map.Scale.normalX(10),-f.y+Math.max(10,
c.height/2-f.height/2));m=" * overall sum";this.szAggregation&&this.szAggregation.match(/mean/)&&(m=" * arithmetic mean");c="middle";if(this.szFlag.match(/RIGHT/)||this.szFlag.match(/STACKED/)||this.szFlag.match(/CENTER/)||this.szFlag.match(/POINTER/)||2>=this.partsA.length)c="start";map.Dom.newText(summarizeGroup,0,f.height+f.y+map.Scale.normalY(5),map.Scale.tStyle.Note.szStyle+"baseline-shift:-100%;text-anchor:"+c+";",m)}}};
MapTheme.prototype.drawColorSchemeLegend=function(e,b){var f=null,c=map.Scale.nButtonSize?.66*map.Scale.nButtonSize:12,h=map.Scale.nButtonSize||12,g=map.Scale.nButtonSize?1.2*map.Scale.nButtonSize:18,m=g,l="font-family:arial;font-size:"+map.Scale.normalY(c)+"px;fill:#666666;pointer-events:none;",q=1.2*h;this.szFlag.match(/BAR/)&&this.szFlag.match(/\|UP/)&&(q=h);var x=1.15*c,r=0*q,k=0;this.szFlag.match(/BAR/)&&(this.szFlag.match(/\|UP/)||this.szFlag.match(/STACKED/))&&(k=this.partsA.length-1);this.showInfoMore||
this.szFlag.match(/EXACT/)||this.szFlag.match(/\|UP/)||this.szFlag.match(/SYMBOL/)||this.szLabelA&&!this.szFlag.match(/CLIP/)||2>=this.partsA.length?this.szLegendStyle="large":this.szLegendStyle="compact";var H=new ScrollArea(null,e,null,10,10,10);H?(H.reformat(),f=H.workspaceNode):f=map.Dom.newGroup(e,b+":legend");for(var w=1,B=0;B<this.partsA.length;B++)this.partsA[B].min&&(this.partsA[B].min.toFixed(0)!=this.partsA[B].min&&(w=Math.min(w,.1)),this.partsA[B].min.toFixed(1)!=this.partsA[B].min&&(w=
Math.min(w,.01)));for(var D=[],B=0;B<this.partsA.length;B++)D[B]={},D[B].i=B,D[B].value=this.partsA[B].nCount;this.szFlag.match(/SYMBOL/)&&this.szFlag.match(/EXACT/)&&this.szFlag.match(/SORTDOWN/)&&D.sort(this.sortIndexDown);!this.szFlag.match(/POINTER/)&&!this.szFlag.match(/INVERT/)||this.szLegendStyle.match(/compact/)||D.reverse();var C=1;!this.szLabelA&&15<D.length&&(C=Math.floor(D.length/10),h*=1.5);var y=this.showInfoMore&&this.isMarkable?18:10,K=!1;if(this.szFlag.match(/CHART/)&&1<this.szFieldsA.length&&
!this.szFlag.match(/OFFSET/)&&!this.szFlag.match(/DEVIATION/)){for(var E=K=0;E<this.nOrigSumA.length;E++)this.partsA[E]&&"undefined"!=typeof this.partsA[E].nSum&&K++;K=K==this.nOrigSumA.length}for(var u=0;u<D.length;u+=C){var B=D[u].i,A=Math.min(Math.abs(k-B),this.partsA.length-C),I=null,E=null;if(this.szFlag.match(/SYMBOL/)&&this.szFlag.match(/EXACT/))g=0==this.nSkipCount?3*this.partsA[B].nCount/this.nCount*100:30/this.nCount*10*this.partsA[B].nCount;else if(K){E=g=0;if(this.szFlag.match(/MORPH/)){for(E=
0;E<this.nOrigSumA.length/2;E++)g=Math.max(g,this.nOrigSumA[E]*(this.nClipFrames-1-this.nActualFrame)/(this.nClipFrames-1)+this.nOrigSumA[E+this.nOrigSumA.length/2]*this.nActualFrame/(this.nClipFrames-1));E=(this.nOrigSumA[A]*(this.nClipFrames-1-this.nActualFrame)/(this.nClipFrames-1)+this.nOrigSumA[A+this.nOrigSumA.length/2]*this.nActualFrame/(this.nClipFrames-1))/g}else{for(E=0;E<this.nOrigSumA.length;E++)g=Math.max(g,this.partsA[E].nSum);E=this.partsA[A].nSum/g}g=60*E}g=isNaN(g)?m:g;if(this.szFlag.match(/BUBBLE/))E=
this.szFlag.match(/EXACT/)||this.szSizeField?h/2:h/4+h/4*(B+1)/this.partsA.length,E=map.Dom.newShape("circle",f,map.Scale.normalX(y+h/2),map.Scale.normalY(r+h/2),map.Scale.normalY(E),"fill:"+this.colorScheme[A]+";stroke:#eeeeee;stroke-width:"+map.Scale.normalX(.1)+";");else if(1<C)for(E=map.Dom.newGroup(f,""),I=0;I<C;I++)map.Dom.newShape("rect",E,map.Scale.normalX(y),map.Scale.normalY(r+h/C*I),map.Scale.normalX(g),map.Scale.normalY(h/C),"fill:"+this.colorScheme[A+I]+";stroke:none;");else E=map.Dom.newShape("rect",
f,map.Scale.normalX(y),map.Scale.normalY(r),map.Scale.normalX(g),map.Scale.normalY(h),"fill:"+this.colorScheme[A]+";stroke:#eeeeee;stroke-width:"+map.Scale.normalX(.1)+";");if(E){for(var F=this.partsA[A].nCount,I=1;I<C;I++)F+=this.partsA[A+I].nCount;this.isMarkable&&this.showInfoMore&&(map.Dom.newShape("rect",f,map.Scale.normalX(-5),map.Scale.normalY(r-2),map.Scale.normalX(g),map.Scale.normalY(h+4),"fill:white;stroke:none;opacity:0;").setAttributeNS(null,"id",this.szId+":widget:background:"+A),buttonObj=
new Button(f,this.szId+":class:"+A,"CHECKBOX|SELECTED","","map.Themes.showClass(evt,'"+this.szId+"','"+A+"','"+C+"')","map.Themes.hideClass(evt,'"+this.szId+"','"+A+"','"+C+"')","show/hide class"),buttonObj.setPosition(map.Scale.normalX(map.Scale.nButtonSize/2-1),map.Scale.normalY(r+map.Scale.nButtonSize/2-1)),buttonObj.scale(.75,.75));var I=this.partsA[A].min+(u?w:0),ma=this.partsA[A+C-1].max,Ga=100<ma-I?0:2;szMin=this.formatValue(I,Ga);szMax=this.formatValue(ma,Ga);szMembers="";this.szFlag.match(/SHOWMEMBERS/)&&
(szMembers="  ["+F+"]");szLabel=szMin!=szMax?szMin+"..."+szMax+(this.szLegendUnits?this.szLegendUnits:"")+this.szUnit+szMembers:szMin+(this.szLegendUnits?this.szLegendUnits:"")+this.szUnit+szMembers;(!this.szFlag.match(/CLIP/)||this.szFlag.match(/MORPH/))&&this.szLabelA&&this.szLabelA[A]&&(szLabel=this.szLabelA[A]);this.szLegendLabelA[A]=szLabel;if(this.szLegendStyle.match(/compact/))this.fGrayNoMember&&0==F&&this.szFlag.match(/CHOROPLETH/)&&this.szFlag.match(/DOMINANT/)&&(E.style.setProperty("fill-opacity",
"0.03",""),E.style.getPropertyValue("fill"),E.style.setProperty("stroke-opacity","0.2",""),E.style.setProperty("stroke","black",""),E.style.setProperty("stroke-width",map.Scale.normalX(.3),"")),this.szFlag.match(/EXACT/)||this.szFlag.match(/DOMINANT/)&&15<szLabel.length||(I=";font-size:"+map.Scale.normalX(.9*c)+"px;",0==u?(szLabel=0<szLabel.length?szMin+this.szUnit:szLabel,map.Dom.newText(f,map.Scale.normalX(y+2),map.Scale.normalY(r+x*(C+1.5)),l+I,szLabel)):u==D.length-C&&(szLabel=0<szLabel.length?
szMax+this.szUnit:szLabel,map.Dom.newText(f,map.Scale.normalX(y+2),map.Scale.normalY(r+x*(C+1.5)),l+I,szLabel)));else if(this.szFlag.match(/SYMBOL/)&&this.szFlag.match(/EXACT/))I=g+2,ma=String(this.partsA[B].nCount),0==this.nSkipCount&&(ma=String(Math.round(100/this.nCount*this.partsA[B].nCount))+"%"),Ga=5*ma.length/7*c,"dynamic"==this.szTextPlacement&&Ga<g&&(I-=5*String(this.partsA[B].nCount).length/7*c),map.Dom.newText(f,map.Scale.normalX(y+I),map.Scale.normalY(r+x+1),l,ma),I+=Ga,this.szSymbolsA[B]&&
this.szSymbolsA[B].match(/symbol/)&&(ma=map.Dom.constructNode("use",f,{"xlink:href":"#"+this.szSymbolsA[B]+":antizoomandpan"}),ma.setAttributeNS(null,"style","fill:"+this.colorScheme[A]),ma.fu.scale(.5,.5),ma.fu.setPosition(map.Scale.normalX(y+I+10),map.Scale.normalY(r+x-3)),I+=20),I=map.Dom.newText(f,map.Scale.normalX(y+I),map.Scale.normalY(r+x),l,"("+szLabel+")"),I.style.setProperty("fill","#bbbbdd","");else{I=g+4;if(K){ma=this.partsA[A].nSum;this.szFlag.match(/MORPH/)&&(ma=this.nOrigSumA[A]*(this.nClipFrames-
1-this.nActualFrame)/(this.nClipFrames-1)+this.nOrigSumA[A+this.nOrigSumA.length/2]*this.nActualFrame/(this.nClipFrames-1));if(this.szField100&&!this.szFlag.match(/SUM/)||this.szAggregation&&!this.szAggregation.match(/sum/))ma/=this.partsA[A].nCount;szLabel=szLabel+"  ("+this.formatValue(ma,1)+this.szUnit+")"}I=map.Dom.newText(f,map.Scale.normalX(y+I),map.Scale.normalY(r+x),l,szLabel);this.fGrayNoMember&&0==F&&this.szFlag.match(/CHOROPLETH/)&&(I.style.setProperty("fill","#bbbbdd",""),E.style.setProperty("opacity",
"0.1",""))}this.szFlag.match(/BUFFER/)&&E.style.setProperty("fill-opacity",this.fillOpacity?this.fillOpacity:this.nOpacity?this.nOpacity:0,"");1==this.szFieldsA.length||!this.szFlag.match(/CHART/)||this.szFlag.match(/SYMBOL/)&&this.szFlag.match(/EXACT/)?(this.szLegendStyle.match(/compact/)?E.setAttributeNS(szMapNs,"tooltip",szLabel+" ("+F+" member(s))"):E.setAttributeNS(szMapNs,"tooltip",F+" member(s)"),B=E.getAttributeNS(null,"style"),E.setAttributeNS(szMapNs,"onoverstyle",B+";stroke:black;stroke-width:"+
map.Scale.normalX(.5)+";"),E.setAttributeNS(null,"onmouseover","map.Themes.markClass(evt,'"+this.szId+"','"+A+"','"+C+"')"),E.setAttributeNS(null,"onmouseout","map.Themes.unmarkClass(evt,'"+this.szId+"')"),E.setAttributeNS(null,"onclick","map.Themes.zoomToClass(evt,'"+this.szId+"','"+A+"','"+C+"')"),E.setAttributeNS(null,"id",b+":widget:classrect:"+A)):this.szFlag.match(/SYMBOL/)?this.szFlag.match(/EXACT/)?E.setAttributeNS(szMapNs,"tooltip",this.partsA[B].nCount+" ("+this.formatValue(this.partsA[B].nCount/
this.nCount*100,1)+" %)"):this.szFlag.match(/SEQUENCE/)&&E.setAttributeNS(szMapNs,"tooltip",this.nOrigSumA[B]+" ("+this.formatValue(this.nOrigSumA[B]/this.nSum*100,1)+" %)"):1<this.szFieldsA.length&&!this.szFlag.match(/SEQUENCE/)&&(this.nSum100?E.setAttributeNS(szMapNs,"tooltip",this.formatValue(100/this.nSum100*this.nOrigSumA[A],1)+" %"):this.nSum&&E.setAttributeNS(szMapNs,"tooltip",this.nOrigSumA[A]+" ("+this.formatValue(100/this.nSum*this.nOrigSumA[A],1)+" %)"),E.setAttributeNS(null,"onmouseover",
"map.Themes.markClass(evt,'"+this.szId+"','"+A+"','"+C+"')"),E.setAttributeNS(null,"onmouseout","map.Themes.unmarkClass(evt,'"+this.szId+"')"))}this.szLegendStyle.match(/compact/)?y+=g:r+=9*q/10}this.szLegendStyle.match(/compact/)?r+=q*C*2:this.nNoData&&(r+=1.5*q/10,E=map.Dom.newShape("rect",f,0,map.Scale.normalY(r),map.Scale.normalX(g),map.Scale.normalY(h),"fill:"+(this.szNoDataColor?this.szNoDataColor:"#ffffff")+";stroke:#000000;stroke-width:"+map.Scale.normalX(.1)+";"),E.setAttributeNS(szMapNs,
"tooltip",this.nNoData+" member(s)"),E.setAttributeNS(null,"onmouseover","map.Themes.markClass(evt,'"+this.szId+"','"+A+"')"),E.setAttributeNS(null,"onmouseout","map.Themes.unmarkClass(evt,'"+this.szId+"')"),map.Dom.newText(f,map.Scale.normalX(22),map.Scale.normalY(r+x),l,map.Dictionary.getLocalText("no data")),r+=9*q/10);H&&(H.setWidth(-1),H.setHeight(Math.min(r+q,map.Scale.bBox.height/map.Scale.normalY(2.2))),this.nClipColorLegend&&H.setHeight(this.nClipColorLegend),H.reformat(),H.hasScrollBars()&&
(f.style.setProperty("display","none",""),map.Dom.newShape("rect",e,0,0,map.Scale.normalX(H.getWidth()),map.Scale.normalY(H.getHeight()),"fill:none;stroke:none;")));return f};MapTheme.prototype.showInfo=function(){};
MapTheme.prototype.chartButton=function(e,b,f){e=map.Dom.newGroup(e,"chartvari"+String(Math.random()));var c=this.szFlag;"2D"==f&&this.removeDefinitionFromFlag("3D");this.szFlag+="|NORMSIZE|SILENT|MENUSIZE|"+f;this.drawChart(e,null,b);this.szFlag=c;c=map.Dom.getBox(e);this.addChartTypeSign(e,f);f=Math.min(map.Scale.normalX(b)/c.width,map.Scale.normalY(b)/c.height);e.fu.scale(f,f);e.fu.setPosition(map.Scale.normalX(b+10),map.Scale.normalY(b)*f);return e};
MapTheme.prototype.addDefinitionToFlag=function(e){return this.szFlag=this.szFlag+"|"+e};MapTheme.prototype.removeDefinitionFromFlag=function(e){for(var b="",f=this.szFlag.split("|"),c=0;c<f.length;c++)f[c]!=e&&(b+=(b.length?"|":"")+f[c]);return this.szFlag=b};MapTheme.prototype.removeDefinition=function(e,b){for(var f="",c=e.split("|"),h=0;h<c.length;h++)c[h]!=b&&(f+=(f.length?"|":"")+c[h]);return f};9;
MapTheme.prototype.addChartTypeSign=function(e,b){var f="M0,0 l"+map.Scale.normalX(1.5)+",-"+map.Scale.normalX(1.5)+" 0,"+map.Scale.normalX(3)+" -"+map.Scale.normalX(1.5)+",-"+map.Scale.normalX(1.5)+" M"+map.Scale.normalX(2.5)+",0 l"+map.Scale.normalX(17.5)+",0 M"+map.Scale.normalX(22.5)+",0 l-"+map.Scale.normalX(1.5)+",-"+map.Scale.normalX(1.5)+" 0,"+map.Scale.normalX(3)+" "+map.Scale.normalX(1.5)+",-"+map.Scale.normalX(1.5)+"";if(b.match(/SIZE/)){var c=map.Dom.newGroup(e,"");map.Dom.newShape("path",
c,f,"stroke:white;stroke-width:"+map.Scale.normalX(4)+";stroke-opacity:0.5;stroke-linejoin:miter;");map.Dom.newShape("path",c,f,"stroke:#666666;stroke-width:"+map.Scale.normalX(1.5)+";stroke-linejoin:miter;");c.fu.setPosition(-map.Scale.normalX(10),map.Scale.normalX(-5))}b.match(/HEIGHT/)&&(c=map.Dom.newGroup(e,""),map.Dom.newShape("path",c,f,"stroke:white;stroke-width:"+map.Scale.normalX(4)+";stroke-opacity:0.5;stroke-linejoin:miter;"),map.Dom.newShape("path",c,f,"stroke:#666666;stroke-width:"+map.Scale.normalX(1.5)+
";stroke-linejoin:miter;"),c.setAttributeNS(null,"transform","translate(0,"+-map.Scale.normalX(25)+") rotate(90)"))};
MapTheme.prototype.getChartTypeMenu=function(e,b,f){"undefined"==typeof szChartTypeList&&(szChartTypeList="CHART|BAR CHART|BAR|3D CHART|BAR|3D|SORT CHART|BAR|HORZ|LEFT|UP CHART|BAR|HORZ|RIGHT|UP CHART|BAR|HORZ|LEFT|UP|COMPRESS CHART|BAR|HORZ|RIGHT|UP|COMPRESS CHART|BAR|HORZ|LEFT|UP|3D CHART|BAR|HORZ|RIGHT|UP|3D CHART|BAR|HORZ|LEFT|UP|COMPRESS|3D CHART|BAR|HORZ|RIGHT|UP|COMPRESS|3D CHART|BAR|HORZ|CENTER|UP CHART|BAR|STACKED CHART|BAR|STACKED|3D CHART|BAR|SORT|3D|COLUMNS|STACKED CHART|BAR|SORT|3D|COLUMNS|STACKED|SIZE CHART|PIE CHART|PIE|SIZE CHART|PIE|3D CHART|PIE|3D|SIZE CHART|PIE|3D|HEIGHT CHART|PIE|3D|VOLUME CHART|PIE|DONUT CHART|PIE|DONUT|SIZE CHART|PIE|DONUT|3D CHART|PIE|DONUT|3D|SIZE CHART|PIE|DONUT|3D|HEIGHT CHART|PIE|DONUT|3D|VOLUME CHART|PIE|STARBURST CHART|PIE|STARBURST|SIZE CHART|PIE|STARBURST|3D CHART|PIE|STARBURST|3D|SIZE CHART|PIE|STARBURST|3D|HEIGHT CHART|PIE|STARBURST|3D|VOLUME CHART|PIE|DONUT|STARBURST CHART|PIE|DONUT|STARBURST|SIZE CHART|PIE|DONUT|STARBURST|3D CHART|PIE|DONUT|STARBURST|3D|SIZE CHART|PIE|DONUT|STARBURST|3D|HEIGHT CHART|PIE|DONUT|STARBURST|3D|VOLUME".split(" "));"undefined"==
typeof szChartTypeListSingleValue_old&&(szChartTypeListSingleValue_old="CHART|BAR CHART|BAR|VALUES CHART|BAR|3D CHART|BAR|3D|VALUES CHART|BAR|3D|VOLUME CHART|BAR|3D|VOLUME|VALUES CHART|BAR|HORZ|RIGHT|UP CHART|BAR|HORZ|RIGHT|UP|VALUES CHART|BAR|HORZ|RIGHT|UP|3D CHART|BAR|HORZ|RIGHT|UP|VALUES|3D CHART|BAR|POINTER CHART|BAR|POINTER|VALUES CHART|BUBBLE|SURFACE CHART|BUBBLE|SURFACE|VALUES CHART|SQUARE|SURFACE CHART|SQUARE|SURFACE|VALUES".split(" "));"undefined"==typeof szChartTypeListSingleValue&&(szChartTypeListSingleValue=
"CHOROPLETH CHART|BUBBLE CHART|SQUARE CHART|PIE|3D|SIZE CHART|PIE|3D|HEIGHT CHART|PIE|3D|SIZE|HEIGHT CHART|BAR|3D|VOLUME CHART|BAR CHART|BAR|3D CHART|BAR|3D|SIZE CHART|BAR|HORZ|RIGHT|UP CHART|BAR|HORZ|RIGHT|UP|3D CHART|BAR|POINTER CHART|BAR|POINTER|SIZE CHART|BAR|HORZ|RIGHT|UP|POINTER CHART|LABEL".split(" "));var c=this.szOrigFlag;b=szChartTypeListSingleValue;if(1<this.szFieldsA.length||this.szFlag.match(/EXACT/)&&this.szFlag.match(/AGGREGATE/))b=szChartTypeList;f=f?f/60:3;for(i=0;i<b.length;i++){merkFlag=
this.szFlag;var h=map.Dom.constructNode("a",e,{});map.Dom.newShape("rect",h,map.Scale.normalX(i%f*60),map.Scale.normalY(60*Math.floor(i/f)),map.Scale.normalX(60),map.Scale.normalY(60),"fill:#f8f8ff;stroke:lightgray;stroke-dasharray:50 50;stroke-width:"+map.Scale.normalX(1)+";");var g=map.Dom.newGroup(h,"szDisplayId:chart:"+String(Math.random()));map.Dom.setClipRect(g,new box(-map.Scale.normalX(25),-map.Scale.normalX(60),map.Scale.normalX(60),map.Scale.normalX(60)));this.szFlag=b[i]+"|NORMSIZE|SILENT|MENUSIZE";
merkFlag.match(/EXACT/)&&(this.szFlag+="|EXACT");merkFlag.match(/GROUP/)&&(this.szFlag+="|GROUP");merkFlag.match(/AGGREGATE/)&&(this.szFlag+="|AGGREGATE");merkFlag.match(/RELOCATE/)&&(this.szFlag+="|RELOCATE");merkFlag.match(/DIFFERENCE/)&&(this.szFlag+="|DIFFERENCE");merkFlag.match(/FRACTION/)&&(this.szFlag+="|FRACTION");merkFlag.match(/INVERT/)&&(this.szFlag+="|INVERT");merkFlag.match(/INVERTSIZE/)&&(this.szFlag+="|INVERTSIZE");merkFlag.match(/RELATIVE/)&&(this.szFlag+="|RELATIVE");merkFlag.match(/DENSITY/)&&
(this.szFlag+="|DENSITY");merkFlag.match(/DOPACITYMAX/)?this.szFlag+="|DOPACITYMAX":merkFlag.match(/DOPACITYLOGMAX/)?this.szFlag+="|DOPACITYLOGMAX":merkFlag.match(/DOPACITYPOWMAX/)?this.szFlag+="|DOPACITYPOWMAX":merkFlag.match(/DOPACITYMEAN/)?this.szFlag+="|DOPACITYMEAN":merkFlag.match(/DOPACITYLOGMEAN/)?this.szFlag+="|DOPACITYLOGMEAN":merkFlag.match(/DOPACITYPOWMEAN/)?this.szFlag+="|DOPACITYPOWMEAN":merkFlag.match(/DOPACITYLOG/)?this.szFlag+="|DOPACITYLOG":merkFlag.match(/DOPACITY/)&&(this.szFlag+=
"|DOPACITY");merkFlag.match(/AUTO100/)&&(this.szFlag+="|AUTO100");merkFlag.match(/AUTOCOMPLETE/)&&(this.szFlag+="|AUTOCOMPLETE");var m=this.szAggregation,l=this.drawChart(g,null,40);this.szAggregation=m;if(l){this.szFlag=merkFlag;var q=map.Scale.normalX(10);l.x-=map.Scale.normalX(60/f);g.fu.setPosition(q-l.x+i%f*map.Scale.normalX(60),map.Scale.normalY(40)+q+l.y+Math.floor(i/f)*map.Scale.normalY(60));q="";c.match(/UNDEFINEDISVALUE/)&&(q+="|UNDEFINEDISVALUE");c.match(/ZEROISVALUE/)&&(q+="|ZEROISVALUE");
c.match(/NEGATIVEISVALUE/)&&(q+="|NEGATIVEISVALUE");c.match(/NONEGATIVE/)&&(q+="|NEGATIVEISVALUE");c.match(/GROUP/)&&(q+="|GROUP");c.match(/AGGREGATE/)&&(q+="|AGGREGATE");c.match(/RELOCATE/)&&(q+="|RELOCATE");c.match(/EXACT/)&&(q+="|EXACT");c.match(/SUM/)&&(q+="|SUM");c.match(/DIFFERENCE/)&&(q+="|DIFFERENCE");c.match(/RELATIVE/)&&(q+="|RELATIVE");c.match(/INVERT/)&&(q+="|INVERT");c.match(/INVERTSIZE/)&&(q+="|INVERTSIZE");c.match(/CALCMEAN/)&&(q+="|CALCMEAN");c.match(/CALC100/)&&(q+="|CALC100");c.match(/PRODUCT/)&&
(q+="|PRODUCT");c.match(/AUTOCOMPLETE/)&&(q+="|AUTOCOMPLETE");c.match(/AUTO100/)&&(q+="|AUTO100");c.match(/QUANTILE/)&&(q+="|QUANTILE");c.match(/DENSITY/)&&(q+="|DENSITY");c.match(/DOPACITY/)&&(q+="|DOPACITY");if(c.match(/VALUES/)||merkFlag.match(/VALUES/))q+="|VALUES";c.match(/VALUEBACKGROUND/)&&(q+="|VALUEBACKGROUND");b[i].match(/SIZE/)&&(merkFlag.match(/SIZELOG/)?q+="|SIZELOG":merkFlag.match(/SIZEP4/)?q+="|SIZEP4":merkFlag.match(/SIZEP3/)?q+="|SIZEP3":merkFlag.match(/SIZE/)&&(q+="|SIZE"));merkFlag.match(/SPACED/)&&
(q+="|SPACED");h.setAttributeNS(null,"onclick","map.Themes.changeThemeStyle(evt,'"+this.szId+"','type:"+b[i]+q+"')");this.addChartTypeSign(g,b[i])}}e=[];for(a in b)e.push(b[a]+q);return e};MapTheme.prototype.formatValue=function(e,b,f){return isNaN(e)?e:999<this.nMin&&3E3>this.nMax?__formatValue(e,b,f+"|NOBREAKS"):__formatValue(e,b,f)};MapTheme.prototype.remove=function(e){this.parent.removeTheme(e,this.szId)};
MapTheme.prototype.removeElements=function(e){this.widgetNode&&(widgetList.removeWidget(this.widgetNode),this.widgetNode.parentNode.removeChild(this.widgetNode),this.widgetNode=null);this.clipTimeout&&clearTimeout(this.clipTimeout);this.unpaintMap();if(this.onremove)try{eval(this.onremove)}catch(b){}try{HTMLWindow.ixmaps.htmlgui_onRemoveTheme(this.szId)}catch(f){}};
MapTheme.prototype.removeMapThemeStyles=function(e){e=e.split("|");for(var b=SVGRootElement.getElementsByTagName("path"),f=0;f<b.length;f++)if(1==b.item(f).nodeType){var c=b.item(f).parentNode.getAttributeNS(null,"id"),h=!1;if(c&&0!==c.length)for(var c=map.Tiles.getMasterId(c).split(":")[0],g=0;g<e.length;g++)c==e[g]&&(h=!0);h&&b.item(f).parentNode.removeAttributeNS(null,"style")}};
MapTheme.prototype.disable=function(){if(!this.szFlag.match(/CHART/)&&this.widgetNode)for(var e=this.widgetNode.getElementsByTagName("g"),b=0;b<e.length;b++)e.item(b).setAttributeNS(null,"opacity","0.9")};MapTheme.prototype.enable=function(){if(this.widgetNode){for(var e=this.widgetNode.getElementsByTagName("g"),b=0;b<e.length;b++)e.item(b).setAttributeNS(null,"opacity","1.0");this.widgetNode.parentNode.appendChild(this.widgetNode)}map.Themes.setActive(this)};
MapTheme.prototype.makeVisible=function(){for(var e=0;e<this.szThemesA.length;e++)map.Layer.isLayerOn(this.szThemesA[e])||map.Layer.isScaleDependentLayer(this.szThemesA[e])||(map.Themes.switchedLayerA[this.szThemesA[e]]=!0,map.Api.switchMapTheme(this.szThemesA[e],"on")),map.Tiles.switchScaleDependentTiles()};
MapTheme.prototype.checkVisible=function(){for(var e=0;e<this.szThemesA.length;e++)map.Themes.isThemeLayerUsed(this.szThemesA[e])&&this.isVisible||!map.Themes.switchedLayerA[this.szThemesA[e]]||(map.Api.switchMapTheme(this.szThemesA[e],"off"),map.Themes.switchedLayerA[this.szThemesA[e]]=null)};
MapTheme.prototype.resize=function(e){999!=e&&(this.nScale*=e);if(this.szFlag.match(/BUFFER/)&&this.szShapeType.match(/line/))this.fRedrawInfo=this.fRedraw=!0,this.nSkipCount=1,map.Themes.execute();else{map.Layer.changeObjectScaling(null,e,this.chartGroup);this.szFlag.match(/DECLUTTER/)&&this.declutterCharts();if(this.szFlag.match(/BUFFER/)){var b=this.chartGroup.getElementsByTagName("circle");for(n=0;n<b.length;n++){var f=b.item(n).getAttributeNS(null,"style");f&&f.length&&(szNewStylesValue=__scaleStyleString(f,
1/e),b.item(n).setAttributeNS(null,"style",szNewStylesValue))}}this.f=!0;this.showInfo()}};MapTheme.prototype.offset=function(e){var b=this.chartGroup.fu.getPosition();this.chartGroup.fu.setPosition(b.x+e.x,b.y+e.y)};
MapTheme.prototype.opacity=function(e){this.fillOpacity=(this.fillOpacity?this.fillOpacity:1)*e;this.fillOpacity=Math.min(1,this.fillOpacity);this.fillOpacity=Math.max(0,this.fillOpacity);this.nOpacity=(this.nOpacity?this.nOpacity:1)*e;this.nOpacity=Math.min(1,this.nOpacity);this.nOpacity=Math.max(0,this.nOpacity);if(this.chartGroup)for(var b=this.chartGroup.childNodes,f=0;f<b.length;f++)map.Layer.changeNodeOpacity(b.item(f),e);else if(this.szShapeType.match(/line/))for(f=0;f<this.szThemesA.length;f++)map.Layer.changeLayerOpacity(this.szThemesA[f],
e);else for(a in this.itemA)for(b=this.getItemNodes(a),f=0;f<b.length;f++)map.Layer.changeNodeOpacity(b[f],e,"fill-opacity")};
MapTheme.prototype.blur=function(e){if(this.chartGroup)if(this.nBlur){szBlurFilterId="blur-3";var b=SVGDocument.getElementById(szBlurFilterId);b?b.firstChild.setAttributeNS(null,"stdDeviation",map.Scale.normalX(e)):(b=map.Dom.newNode("filter",this.chartGroup.parentNode),b.setAttributeNS(null,"id",szBlurFilterId),filter=map.Dom.newNode("feGaussianBlur",b),filter.setAttributeNS(null,"stdDeviation",map.Scale.normalX(e)));this.chartGroup.style.setProperty("filter","url(#"+szBlurFilterId+")","")}else this.chartGroup.style.removeProperty("filter");
else if(this.szThemesA[0]){var f=SVGDocument.getElementById("maplayer");f&&(this.nBlur?(szBlurFilterId="blur-map",(b=SVGDocument.getElementById(szBlurFilterId))?b.firstChild.setAttributeNS(null,"stdDeviation",map.Scale.normalX(e)/map.Zoom.nZoom):(b=map.Dom.newNode("filter",f.parentNode),b.setAttributeNS(null,"id",szBlurFilterId),b.setAttributeNS(null,"x",0),b.setAttributeNS(null,"y",0),b.setAttributeNS(null,"width","100%"),b.setAttributeNS(null,"height","100%"),filter=map.Dom.newNode("feGaussianBlur",
b),filter.setAttributeNS(null,"stdDeviation",map.Scale.normalX(e)/map.Zoom.nZoom)),f.style.setProperty("filter","url(#"+szBlurFilterId+")","")):f.style.removeProperty("filter"))}};
MapTheme.prototype.toggle=function(){this.chartGroup?"none"==this.chartGroup.style.getPropertyValue("display")?this.chartGroup.style.setProperty("display","inline",""):this.chartGroup.style.setProperty("display","none",""):this.isChecked?(this.unpaintMap(),this.isChecked=!1,map.Themes.activateNextPaint(this)&&(this.fToggle=!1,map.Themes.execute(),this.widgetNode&&(this.widgetNode.setAttributeNS(null,"opacity","1.0"),this.widgetNode.parentNode.appendChild(this.widgetNode)))):(this.fRedraw=this.isChecked=
!0,this.fToggle=!1,map.Themes.execute())};MapTheme.prototype.getHistogram=function(e,b,f){map.Themes.getHistogram(e,b,f,this)};var __maptheme_chartcolors=[];function __maptheme_getChartColors(e){__maptheme_chartcolors[e]||(__maptheme_chartcolors[e]=new ChartColors(e));return __maptheme_chartcolors[e]}
function ChartColors(e){"string"!=typeof e&&(e="#ffffff");this.mainColor=e;this.lowColor=ColorScheme.getDerivateColor(e,.7);this.highColor=ColorScheme.getDerivateColor(e,1.3);this.borderColor=ColorScheme.getBorderColor(e);this.textColor=ColorScheme.getTextColor(e)}function __mpap_hex2dec(e){return parseInt(e,16)}
function __mpap_decode_utf8(e){if("string"==typeof e&&e.match(/&#x/)){var b="";sA=e.split("&#x");b=sA[0];for(e=1;e<sA.length;e++)b+=String.fromCharCode(__mpap_hex2dec(sA[e].substr(0,2))),b+=sA[e].substr(3,sA[e].length-3);return b}return e};
