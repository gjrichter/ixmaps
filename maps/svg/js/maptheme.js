var themeStyleTranslateA=[{style:"opacity",obj:"nOpacity"},{style:"fillopacity",obj:"fillOpacity"},{style:"autoopacity",obj:"autoOpacity"},{style:"shadow",obj:"fOrigShadow"},{style:"blur",obj:"nBlur"},{style:"filter",obj:"szFilter"},{style:"dfilter",obj:"nDeltaFilter"},{style:"filterfield",obj:"szFilterField"},{style:"dbtable",obj:"coTable"},{style:"dbtableUrl",obj:"coTableUrl"},{style:"dbtableType",obj:"coTableType"},{style:"dbtableExt",obj:"coTableExt"},{style:"datacache",obj:"fDataCache"},{style:"itemfield",
obj:"szItemField"},{style:"lookupfield",obj:"szSelectionField"},{style:"lookuptoupper",obj:"fSelectionFieldToUpper"},{style:"lookupsuffix",obj:"szSelectionFieldSuffix"},{style:"lookupdigits",obj:"nSelectionFieldDigits"},{style:"lookuptonumber",obj:"fSelectionFieldToNumber"},{style:"lookupfield2",obj:"szSelectionField2"},{style:"showdata",obj:"fShowData"},{style:"datafields",obj:"szDataFieldsA",type:"array"},{style:"userdraw",obj:"userDraw"},{style:"child",obj:"fChild"},{style:"crsdatum",obj:"szCRSDatum"},
{style:"crsutmzone",obj:"szCRSUTMZone"},{style:"ranges",obj:"szRangesA",type:"array"},{style:"rangecentervalue",obj:"nRangeCenterValue"},{style:"symbols",obj:"szSymbolsA",type:"array"},{style:"values",obj:"szValuesA",type:"array",delimiter:"|"},{style:"colorvalues",obj:"szColorValuesA",type:"array",delimiter:"|"},{style:"symbolvalues",obj:"szSymbolValuesA",type:"array",delimiter:"|"},{style:"label",obj:"szOrigLabelA",type:"array",delimiter:"|"},{style:"valuemap",obj:"valueMap",type:"object"},{style:"xaxis",
obj:"szXaxisA",type:"array"},{style:"units",obj:"szUnits"},{style:"labelunits",obj:"szLabelUnits"},{style:"units100",obj:"szUnits100"},{style:"sizevalueunits",obj:"szSizeValueUnits"},{style:"alphavalueunits",obj:"szAlphaValueUnits"},{style:"legendunits",obj:"szLegendUnits"},{style:"weights",obj:"szWeights"},{style:"align",obj:"szAlign"},{style:"refreshtimeout",obj:"nRefreshTimeout"},{style:"normalsizevalue",obj:"nNormalSizeValue"},{style:"normalsizescale",obj:"szNormalSizeScale"},{style:"scale",obj:"nScale"},
{style:"rangescale",obj:"nRangeScale"},{style:"sizepow",obj:"nSizePow"},{style:"colorfield",obj:"szColorField"},{style:"symbolfield",obj:"szSymbolField"},{style:"valuefield",obj:"szValueField"},{style:"labelfield",obj:"szLabelField"},{style:"sizefield",obj:"szSizeField"},{style:"timefield",obj:"szTimeField"},{style:"alphafield",obj:"szAlphaField"},{style:"alphafield100",obj:"szAlphaField100"},{style:"xfield",obj:"szXField"},{style:"yfield",obj:"szYField"},{style:"dopacitypow",obj:"nDopacityPow"},
{style:"dopacityramp",obj:"szDopacityRamp"},{style:"dopacityscale",obj:"nDopacityScale"},{style:"brightness",obj:"nBrightness"},{style:"buffersize",obj:"nBufferSize"},{style:"bufferstep",obj:"nBufferSizeStep"},{style:"field100min",obj:"nField100Min"},{style:"fractionscale",obj:"nFractionScale"},{style:"minvalue",obj:"nMinValue"},{style:"maxvalue",obj:"nMaxValue"},{style:"textfont",obj:"szTextFont"},{style:"textcolor",obj:"szTextColor"},{style:"textscale",obj:"nTextScale"},{style:"linecolor",obj:"szLineColor"},
{style:"linecolor",obj:"szLineColorA",type:"array"},{style:"linewidth",obj:"nLineWidth"},{style:"markersize",obj:"nMarkerSize"},{style:"gapsize",obj:"nGapSize"},{style:"bordercolor",obj:"szBorderColor"},{style:"borderstyle",obj:"szBorderStyle"},{style:"borderwidth",obj:"szBorderWidth"},{style:"borderradius",obj:"nBorderRadius"},{style:"boxcolor",obj:"szBoxColor"},{style:"boxopacity",obj:"nBoxOpacity"},{style:"boxmargin",obj:"nBoxMargin"},{style:"textplacement",obj:"szTextPlacement"},{style:"infotitle",
obj:"szInfoTitle"},{style:"titlefield",obj:"szTitleField"},{style:"snippetfield",obj:"szSnippetField"},{style:"exclude",obj:"szExcludeA",type:"array"},{style:"nodatacolor",obj:"szNoDataColor"},{style:"titleupper",obj:"szTitleUpper"},{style:"labelupper",obj:"szLabelUpper"},{style:"valueupper",obj:"szValueUpper"},{style:"glowupper",obj:"szGlowUpper"},{style:"glowlower",obj:"szGlowLower"},{style:"chartupper",obj:"szChartUpper"},{style:"chartlower",obj:"szChartLower"},{style:"boxupper",obj:"szBoxUpper"},
{style:"shadowupper",obj:"szShadowUpper"},{style:"shadowlower",obj:"szShadowLower"},{style:"declutterupper",obj:"szDeclutterUpper"},{style:"valuescale",obj:"nValueScale"},{style:"minvaluesize",obj:"nValueSizeMin"},{style:"valuedecimals",obj:"nValueDecimals"},{style:"fadevaluepow",obj:"szFadeValuePow"},{style:"fadenegative",obj:"nFadeNegative"},{style:"centerpart",obj:"szCenterPart"},{style:"clipframes",obj:"nClipFrames"},{style:"clipframerate",obj:"nClipFrameRate"},{style:"cliplegend",obj:"nClipColorLegend"},
{style:"clipparts",obj:"nClipParts"},{style:"minchartsize",obj:"nChartSizeMin"},{style:"maxcharts",obj:"nMaxCharts"},{style:"showparts",obj:"szShowParts"},{style:"gridx",obj:"nGridX"},{style:"gridwidth",obj:"nGridWidth"},{style:"gridmatrix",obj:"nGridMatrix"},{style:"gridwidthpx",obj:"nGridWidthPx"},{style:"gridoffsetx",obj:"nGridOffsetX"},{style:"gridoffsety",obj:"nGridOffsetY"},{style:"aggregationfield",obj:"szAggregationField"},{style:"aggregationscale",obj:"szAggregationFieldA",type:"array"},
{style:"aggregation",obj:"szAggregation"},{style:"minaggregation",obj:"szMinAggregation"},{style:"aggregationupper",obj:"szAggregationUpper"},{style:"aggregationlower",obj:"szAggregationLower"},{style:"clipupper",obj:"szClipUpper"},{style:"cliplower",obj:"szClipLower"},{style:"dominantfilter",obj:"szDominantFilter"},{style:"dominantdfilter",obj:"nDominantDFilter"},{style:"overviewchart",obj:"szOverviewChart"},{style:"evidence",obj:"evidenceMode"},{style:"markclass",obj:"markedClass"},{style:"markclasses",
obj:"markedClassesA",type:"array"},{style:"name",obj:"szName"},{style:"title",obj:"szTitle"},{style:"snippet",obj:"szSnippet"},{style:"splash",obj:"szSplash"},{style:"description",obj:"szDescription"}];function __maptheme_getOneStyleProperty(c,a,d,b){b=b?b:",";if("undefined"!=typeof c&&null!=c)if(d&&"undefined"!=typeof d){if("array"==d&&c&&c.length&&"object"==typeof c)return c=c.join(b),a+":"+c+";";if("object"==d&&c)return a+":"+JSON.stringify(c)+";"}else return a+":"+String(c)+";";return""}
function __maptheme_getStyleString(c){c=map.Themes.getMapThemeDefinitionObj(c.szId);for(var a="",d=0;d<themeStyleTranslateA.length;d++)a+=__maptheme_getOneStyleProperty(c.style[themeStyleTranslateA[d].style],themeStyleTranslateA[d].style,themeStyleTranslateA[d].type,themeStyleTranslateA[d].delimiter);return a.replace(/\"/gi,'\\"')}
function __maptheme_getStyleObj(c){for(var a={},d=0;d<themeStyleTranslateA.length;d++)null!=c[themeStyleTranslateA[d].obj]&&"undefined"!=c[themeStyleTranslateA[d].obj]&&(a[themeStyleTranslateA[d].style]=c[themeStyleTranslateA[d].obj]);return a}function __isdef(c){return"undefined"!==typeof c&&null!=c}
Map.Themes=function(){this.themesA=[];this.themeNodesA=[];this.themeNodesPosA=[];this.themeNodesBoxA=[];this.themeNodes=0;this.activeBuffer=this.activeTheme=null;this.switchedLayerA=[];this.enableMultiChoropleth=this.enableChartOffset=!1;this.enableSubThemes=!0;this.szChoroplethInfoStyle="";this.nMaxThemeCharts=1E6;this.nMaxShadowCharts=1E3;this.nflushPaintShape=5E3;this.nflushChartDraw=1E3;this.nColorSchemeMaxHeight=120;this.autoHideInfoTools=this.allwaysShowValues=!1;this.themeDataCacheA=[]};
Map.Themes.prototype=new Map;if("string"==typeof thisversion&&map.checkVersion(thisversion)){map.Themes=new Map.Themes;try{HTMLWindow.ixmaps.htmlgui_onInitThemes()}catch(e$$4){}}else alert("Map.Themes incompatible !");Map.Themes.prototype.addTheme=function(c){this.themesA[this.themesA.length]=c;if(!c.szFlag.match(/selection/i))try{HTMLWindow.ixmaps.htmlgui_onNewTheme(c.szId)}catch(a){}};Map.Themes.prototype.getThemeCount=function(){return this.themesA.length};Map.Themes.prototype.getAllThemes=function(){return this.themesA};
Map.Themes.prototype.isTheme=function(c){for(var a=0;a<this.themesA.length;a++)if(this.themesA[a].szIdStr&&this.themesA[a].szIdStr==c)return this.themesA[a];return!1};Map.Themes.prototype.isIdle=function(){for(var c=0;c<this.themesA.length;c++)if(!this.themesA[c].fRealizeDone)return!1;return!0};Map.Themes.prototype.isArray=function(c){return"[object Array]"===Object.prototype.toString.call(c)};
Map.Themes.prototype.toArray=function(c){return this.isArray(c)?c:String(c).match(/\|/)||String(c).match(/\RGB/)?String(c).split("|"):String(c).split(",")};Map.Themes.prototype.toString=function(c){return this.isArray(c)?c.join("|"):c};Map.Themes.prototype.newTheme=function(c,a,d,b,f,e){var l=null,l=(l=b.split("style="))&&1<l.length?__getStyleObj(l[1]):__getStyleObj(b);l.label=e&&"undefined"!=e?e.split("|"):l.label||null;l.szTitle=f;return this.newThemeByObj({layer:c,field:a,field100:d,style:l})};
Map.Themes.prototype.newThemeByObj=function(c){if(map.isIdle()){if(this.newThemeObjA&&this.newThemeObjA.length&&(c&&this.newThemeObjA.push(c),c=this.newThemeObjA.shift()),c){var a=JSON.stringify(c);if(!c.style.type.match(/FORCE/)&&this.isTheme(a))return this.removeTheme(null,this.isTheme(a).szId),null;var d=null,b=c.style;if(!b)return null;var f;this.isArray(b.label)?(d=b.label,f=b.label.join("|")):d=(f=b.label)&&"undefined"!=f?f.split("|"):null;f=[5,"white","blue"];b.colorscheme&&(f=this.toArray(b.colorscheme));
c.layer=this.toString(c.layer);c.field=this.toString(c.field);b.type.match(/\bEXACT\b/)&&!b.type.match(/\bCATEGORICAL\b/)&&(b.type+="|CATEGORICAL");d=new MapTheme(c.layer,c.field,c.field100,b.type,f,b.title,d);d.nOrder=this.getThemeCount();d.szIdStr=a;this.parseStyle(d,b);this.allwaysShowValues&&(d.szFlag+="|VALUES");d.parent=this;this.addTheme(d);d.fRealize=!0;if(d.coTable)return this.loadExternalData(d.coTable,d.nRefreshTimeout,d),d;if(fLoadExternalData){c=c.layer.split("|");for(a=0;a<c.length;a++)this.loadExternalData(c[a],
d.nRefreshTimeout,d);return d}map.Event.doDefaultZoom();executeWithMessage("map.Themes.execute()","... processing ...");return d}}else c&&(this.newThemeObjA=this.newThemeObjA||[],this.newThemeObjA.push(c)),setTimeout(function(){map.Themes.newThemeByObj()},100)};
Map.Themes.prototype.parseStyle=function(c,a){if(c&&a){if(__isdef(a.classes)){if(isNaN(Number(c.origColorScheme[0]))){var d=c.origColorScheme[c.origColorScheme.length-1];c.origColorScheme[1]=c.origColorScheme[0];c.origColorScheme[2]=d}c.origColorScheme[0]=Number(a.classes)}__isdef(a.colorstyle)&&"spectrum"==c.origColorScheme[1]&&(c.origColorScheme[2]=a.colorstyle);__isdef(a.dominantdfilter)&&(c.nDominantDFilter=Number(a.dominantdfilter));__isdef(a.dominantfilter)&&(c.szDominantFilter=String(a.dominantfilter));
__isdef(a.filter)&&(c.szFilter=String(a.filter));__isdef(a.filterfield)&&(c.szFilterField=String(a.filterfield));__isdef(a.filtervalue)&&(c.szFilterValue=String(a.filtervalue));__isdef(a.overviewchart)&&(c.szOverviewChart=a.overviewchart);__isdef(a.evidence)&&(c.evidenceMode=a.evidence);__isdef(a.markclass)&&(c.markedClass=a.markclass,c.markedClasses||(c.markedClasses=[],c.markedClasses[c.markedClass]=!0,c.markedClassesA=[c.markedClass]));__isdef(a.markclasses)&&(c.markedClassesA=this.toArray(a.markclasses),
c.markedClasses=[],c.markedClassesA.forEach(function(a,d){a.length&&(c.markedClasses[a]=!0,c.markedClass=a)}));__isdef(a.fillopacity)&&("auto"==a.fillopacity?(c.autoOpacity=!0,c.fillOpacity=0):c.fillOpacity=Number(a.fillopacity));__isdef(a.opacity)&&("auto"==a.opacity?(c.autoOpacity=!0,c.fillOpacity=0):c.nOpacity=Number(a.opacity));__isdef(a.autoopacity)&&(c.autoOpacity=!0,c.fillOpacity=0);__isdef(a.shadow)?c.fShadow=c.fOrigShadow=JSON.parse(a.shadow):c.fShadow=c.fOrigShadow=!1;__isdef(a.maxshadow)&&
(c.nMaxShadowCharts=Number(a.maxshadow));__isdef(a.blur)&&(c.nBlur=Number(a.blur));__isdef(a.dbtable)&&(d=a.dbtable.split(" "),c.coTable=d[0],2==d.length&&(c.coTableType="jsonDB",c.coTableUrl=d[1].split("(")[1].split(")")[0]),3==d.length&&(c.coTableType=d[1],c.coTableUrl=d[2].split("(")[1].split(")")[0]),4==d.length&&(c.coTableType=d[1],c.coTableUrl=d[2].split("(")[1].split(")")[0],c.coTableExt=d[3].split("(")[1].split(")")[0]));__isdef(a.dbtableType)&&(c.coTableType=a.dbtableType);__isdef(a.dbtableUrl)&&
(c.coTableUrl=a.dbtableUrl);__isdef(a.dbtableExt)&&(c.coTableExt=a.dbtableExt);__isdef(a.lookupfield)&&(c.szSelectionField=c.szItemField=a.lookupfield);__isdef(a.lookupfield2)&&(c.szSelectionField2=a.lookupfield2);__isdef(a.lookuptoupper)&&(c.fSelectionFieldToUpper=JSON.parse(a.lookuptoupper));__isdef(a.lookupsuffix)&&(c.szSelectionFieldSuffix=a.lookupsuffix);__isdef(a.lookupprefix)&&(c.szSelectionFieldPrefix=a.lookupprefix);__isdef(a.lookupdigits)&&(c.nSelectionFieldDigits=Number(a.lookupdigits));
__isdef(a.lookuptonumber)&&(c.fSelectionFieldToNumber=JSON.parse(a.lookuptonumber));__isdef(a.crsutmzone)&&(c.szCRSUTMZone=a.crsutmzone);__isdef(a.crsdatum)&&(c.szCRSDatum=a.crsdatum);__isdef(a.itemfield)&&(c.szItemField=a.itemfield);__isdef(a.ranges)&&(c.szRangesA=this.toArray(a.ranges),c.szRanges=this.toString(a.ranges));__isdef(a.symbols)&&(c.szSymbolsA=this.toArray(a.symbols));if(__isdef(a.values)&&(c.szValuesA=this.toArray(a.values),a.type.match(/CATEGORICAL/)&&c.szValuesA.length))for(d=0;d<
c.szValuesA.length;d++)c.getStringValueIndex(c.szValuesA[d],"set");__isdef(a.colorvalues)&&(c.szColorValuesA=this.toArray(a.colorvalues));__isdef(a.symbolvalues)&&(c.szSymbolValuesA=this.toArray(a.symbolvalues));__isdef(a.align)&&(c.szAlign=a.align);__isdef(a.units)&&(c.szUnits=a.units);__isdef(a.units100)&&(c.szUnits100=a.units100);__isdef(a.sizevalueunits)&&(c.szSizeValueUnits=" "+a.sizevalueunits);__isdef(a.alphavalueunits)&&(c.szAlphaValueUnits=" "+a.alphavalueunits);__isdef(a.legendunits)&&(c.szLegendUnits=
" "+a.legendunits);__isdef(a.labelunits)&&(c.szLabelUnits=" "+a.labelunits);__isdef(a.xaxis)&&(c.szXaxisA=this.toArray(a.xaxis));__isdef(a.id)&&(c.szId=unescape(a.id));__isdef(a.name)&&(c.szId=c.szName=unescape(a.name));__isdef(a.title)&&(c.szTitle=unescape(a.title));__isdef(a.snippet)&&(c.szSnippet=unescape(a.snippet));__isdef(a.splash)&&(c.szSplash=unescape(a.splash));__isdef(a.description)&&(c.szDescription=unescape(a.description));__isdef(a.label)&&(c.szLabelA=c.szOrigLabelA=this.toArray(a.label));
__isdef(a.weights)&&(c.szWeightsA=this.toArray(a.weights),c.szWeights=this.toString(a.weights));__isdef(a.weight)&&(c.szWeightsA=[a.weights],c.szWeights=a.weight);__isdef(a.scale)&&(c.nScale=Number(a.scale));__isdef(a.colorfield)&&(c.szColorField=a.colorfield);__isdef(a.symbolfield)&&(c.szSymbolField=a.symbolfield);__isdef(a.valuefield)&&(c.szValueField=a.valuefield);__isdef(a.labelfield)&&(c.szLabelField=a.labelfield);__isdef(a.titlefield)&&(c.szTitleField=a.titlefield);__isdef(a.snippetfield)&&
(c.szSnippetField=a.snippetfield);__isdef(a.sizefield)&&(c.szSizeField=a.sizefield);__isdef(a.timefield)&&(c.szTimeField=a.timefield);__isdef(a.alphafield)&&(c.szAlphaField=a.alphafield);__isdef(a.alphafield100)&&(c.szAlphaField100=a.alphafield100);__isdef(a.xfield)&&(c.szXField=a.xfield);__isdef(a.yfield)&&(c.szYField=a.yfield);__isdef(a.refresh)&&(c.nRefreshTimeout=1E3*Number(a.refresh));__isdef(a.refreshtimeout)&&(c.nRefreshTimeout=Number(a.refreshtimeout));__isdef(a.buffersize)&&(c.nBufferSize=
a.buffersize);__isdef(a.bufferstep)&&(c.nBufferSizeStep=a.bufferstep);__isdef(a.field100min)&&(c.nField100Min=a.field100min);__isdef(a.fractionscale)&&(c.nFractionScale=a.fractionscale);__isdef(a.minvalue)&&(c.nMinValue=a.minvalue);__isdef(a.maxvalue)&&(c.nMaxValue=a.maxvalue);__isdef(a.showdata)&&(c.fShowData=JSON.parse(a.showdata));__isdef(a.datacache)&&(c.fDataCache=JSON.parse(a.datacache));__isdef(a.editor)&&(c.fEditor=JSON.parse(a.editor));__isdef(a.datafields)&&(c.szDataFieldsA=this.toArray(a.datafields));
__isdef(a.textcolor)&&(c.szTextColor=a.textcolor);__isdef(a.textfont)&&(c.szTextFont=a.textfont);__isdef(a.textscale)&&(c.nTextScale=Number(a.textscale));__isdef(a.linecolor)&&(c.szLineColorA=this.toArray(a.linecolor),c.szLineColor=c.szLineColorA[c.szLineColorA.length-1]);__isdef(a.linewidth)&&(c.nLineWidth=a.linewidth);__isdef(a.markersize)&&(c.nMarkerSize=a.markersize);__isdef(a.gapsize)&&(c.nGapSize=a.gapsize);__isdef(a.bordercolor)&&(c.szBorderColor=a.bordercolor);__isdef(a.borderstyle)&&(c.szBorderStyle=
a.borderstyle);__isdef(a.borderwidth)&&(c.szBorderWidth=a.borderwidth);__isdef(a.borderradius)&&(c.nBorderRadius=Number(a.borderradius));__isdef(a.boxcolor)&&(c.szBoxColor=a.boxcolor);__isdef(a.boxopacity)&&(c.nBoxOpacity=a.boxopacity);__isdef(a.boxmargin)&&(c.nBoxMargin=a.boxmargin);__isdef(a.textplacement)&&(c.szTextPlacement=a.textplacement);__isdef(a.infotitle)&&(c.szInfoTitle=a.infotitle);__isdef(a.exclude)&&(c.szExcludeA=this.toArray(a.exclude));__isdef(a.aggregation)&&(c.szAggregation=a.aggregation);
__isdef(a.rangecentervalue)&&(c.nRangeCenterValue=Number(a.rangecentervalue));__isdef(a.rangescale)&&(c.nRangeScale=a.rangescale);__isdef(a.normalsizevalue)&&(c.nNormalSizeValue=a.normalsizevalue);__isdef(a.normalsizescale)&&(c.szNormalSizeScale=a.normalsizescale,c.nNormalSizeScale=__scanScaleValue(c.szNormalSizeScale));__isdef(a.nodatacolor)&&(c.szNoDataColor=__getSaveColor(a.nodatacolor));__isdef(a.boxupper)&&(c.szBoxUpper=a.boxupper,c.nBoxUpper=__scanScaleValue(c.szBoxUpper));__isdef(a.titleupper)&&
(c.szTitleUpper=a.titleupper,c.nTitleUpper=__scanScaleValue(c.szTitleUpper));__isdef(a.labelupper)&&(c.szLabelUpper=a.labelupper,c.nLabelUpper=__scanScaleValue(c.szLabelUpper));__isdef(a.valueupper)&&(c.szValueUpper=a.valueupper,c.nValueUpper=__scanScaleValue(c.szValueUpper));__isdef(a.valuesupper)&&(c.szValueUpper=a.valuesupper,c.nValueUpper=__scanScaleValue(c.szValueUpper));__isdef(a.glowupper)&&(c.szGlowUpper=a.glowupper,c.nGlowUpper=__scanScaleValue(c.szGlowUpper));__isdef(a.glowlower)&&(c.szGlowLower=
a.glowlower,c.nGlowLower=__scanScaleValue(c.szGlowLower));__isdef(a.chartupper)&&(c.szChartUpper=a.chartupper,c.nChartUpper=__scanScaleValue(c.szChartUpper));__isdef(a.chartlower)&&(c.szChartLower=a.chartlower,c.nChartLower=__scanScaleValue(c.szChartLower));__isdef(a.shadowupper)&&(c.szShadowUpper=a.shadowupper,c.nShadowUpper=__scanScaleValue(c.szShadowUpper));__isdef(a.shadowlower)&&(c.szShadowLower=a.shadowlower,c.nShadowLower=__scanScaleValue(c.szShadowLower));__isdef(a.declutterupper)&&(c.szDeclutterUpper=
a.declutterupper,c.nDeclutterUpper=__scanScaleValue(c.szDeclutterUpper));__isdef(a.valuescale)&&(c.nValueScale=Number(a.valuescale));__isdef(a.clipframes)&&(c.nClipFrames=a.clipframes);__isdef(a.clipframerate)&&(c.nClipFrameRate=a.clipframerate,c.nClipTimeout=1/Number(a.clipframerate)*1E3);__isdef(a.cliplegend)&&(c.nClipColorLegend=Number(a.cliplegend));__isdef(a.clipvaluesize)&&(c.nValueSizeMin=Number(a.clipvaluesize));__isdef(a.minvaluesize)&&(c.nValueSizeMin=Number(a.minvaluesize));__isdef(a.valuedecimals)&&
(c.nValueDecimals=a.valuedecimals);__isdef(a.fadevaluepow)&&(c.szFadeValuePow=a.fadevaluepow);__isdef(a.dopacityscale)&&(c.nDopacityScale=a.dopacityscale);__isdef(a.dopacityramp)&&(c.szDopacityRamp=a.dopacityramp);__isdef(a.dopacitypow)&&(c.nDopacityPow=a.dopacitypow);__isdef(a.fadenegative)&&(c.nFadeNegative=Number(a.fadenegative)||.5);__isdef(a.brightness)&&(c.nBrightness=a.brightness);__isdef(a.clipparts)&&(c.nClipParts=Number(a.clipparts)||0);__isdef(a.minsize)&&(c.nChartSizeMin=Number(a.minsize)||
0);__isdef(a.minchartsize)&&(c.nChartSizeMin=Number(a.minchartsize)||0);__isdef(a.maxcharts)&&(c.nMaxCharts=Math.round(Number(a.maxcharts))||0);__isdef(a.clipsize)&&(c.nChartSizeMin=Number(a.clipsize)||0);__isdef(a.sizepow)&&(c.nSizePow=a.sizepow);__isdef(a.showparts)&&(c.szShowParts=this.toString(a.showparts),c.szShowPartsA=this.toArray(a.showparts));__isdef(a.gridx)&&(c.nGridX=Number(a.gridx)||1);__isdef(a.gridwidth)&&(String(a.gridwidth).match(/px/)&&(c.nGridWidthPx=parseFloat(a.gridwidth)||50,
map.Themes.doChangeThemeStyle(c.szId,"AUTOGRID","add")),c.nGridWidth=Number(a.gridwidth)||0);__isdef(a.gridmatrix)&&(c.nGridMatrix=Number(a.gridmatrix)||20,map.Themes.doChangeThemeStyle(c.szId,"AUTOGRID","add"));__isdef(a.gridwidthpx)&&(c.nGridWidthPx=Number(a.gridwidthpx)||50,map.Themes.doChangeThemeStyle(c.szId,"AUTOGRID","add"));__isdef(a.gridoffsetx)&&(c.nGridOffsetX=Number(a.gridoffsetx)||0);__isdef(a.gridoffsety)&&(c.nGridOffsetY=Number(a.gridoffsety)||0);__isdef(a.aggregationfield)&&(c.szAggregationField=
a.aggregationfield);__isdef(a.aggregationscale)&&(c.szAggregationFieldA=this.toArray(a.aggregationscale));__isdef(a.minaggregation)&&(c.szMinAggregation=a.minaggregation,c.nMinAggregation=Number(a.minaggregation)||0);__isdef(a.aggregationupper)&&(c.szAggregationUpper=a.aggregationupper,c.nAggregationUpper=__scanScaleValue(c.szAggregationUpper));__isdef(a.aggregationlower)&&(c.szAggregationLower=a.aggregationlower,c.nAggregationLower=__scanScaleValue(c.szAggregationLower));__isdef(a.clipupper)&&(c.szClipUpper=
a.clipupper,c.nClipUpper=__scanScaleValue(c.szClipUpper));__isdef(a.cliplower)&&(c.szClipLower=a.cliplower,c.nClipLower=__scanScaleValue(c.szClipLower));__isdef(a.userdraw)&&(c.userDraw=a.userdraw);__isdef(a.centerpart)&&(c.szCenterPart=this.toString(a.centerpart));__isdef(a.child)&&(c.fChild=!0);__isdef(a.valuemap)&&(c.valueMap=a.valuemap)}};
Map.Themes.prototype.getAllThemeDefinitionStrings=function(){for(var c=[],a=0;a<this.themesA.length;a++)c.push(this.getThemeDefinitionString(this.themesA[a]));return c};
var __toRGB=function(c){var a,d,b="0123456789abcdef";a=parseInt(c.substr(1,2),16);d=parseInt(c.substr(3,2),16);b=parseInt(c.substr(5,2),16);return"RGB("+a+","+d+","+b+")"},__getSaveColor=function(c){try{if("#"==c.charAt(0))return __toRGB(c)}catch(a){}return c},__getSaveColorScheme=function(c){for(var a=0;a<c.length;a++)c[a]=__getSaveColor(c[a]);return c.join("|")},__scanScaleValue=function(c){return String(c).match(/:/)?Number(c.split(":")[1]):Number(c)};
Map.Themes.prototype.cleanUpThemeObj=function(c){var a=c.style,d=null;if(a.colorscheme){var d=a.colorscheme[0],b;for(b in a.colorscheme)if(a.colorscheme[b]!=d){d=null;break}d&&(a.colorscheme.length=1)}if(a.symbols){d=a.symbols[0];for(b in a.symbols)if(a.symbols[b]!=d){d=null;break}d&&(a.symbols.length=1)}a.aggregationfield?(a.aggregationscale=null,a.gridwidth=null,a.gridwidthpx=null):a.aggregationscale?(a.gridwidth=null,a.gridwidthpx=null):a.gridwidthpx&&(a.gridwidth=null);a.evidence&&"isolate"==
a.evidence&&(a.evidence=null);a.aggregation&&(a.aggregation=null);a.type.match(/DOMINANT/)||a.type.match(/PERCENTOFMEAN/)||a.type.match(/OFFSETMEAN/)||a.type.match(/PERCENTOFMEAN/)||a.type.match(/DEVIATION/)||(a.dominantfilter=null,a.dominantdfilter=null);a.itemfield&&a.lookupfield&&a.itemfield==a.lookupfield&&(a.itemfield=null);return c};
Map.Themes.prototype.getThemeDefinitionString=function(c){return'map.Api.newMapTheme("'+c.szThemes+'","'+(c.szFields||"")+'","'+(c.szField100||"")+'","type:'+c.szFlag+";colorscheme:"+__getSaveColorScheme(c.origColorScheme)+";"+__maptheme_getStyleString(c)+';child:true;");'};Map.Themes.prototype.getMapThemeStyleString=function(c){return(c=this.getTheme(c)||this.activeTheme)&&c.colorScheme?"type:"+c.szFlag+";colorscheme:"+c.colorScheme+";"+__maptheme_getStyleString(c)+"":null};
Map.Themes.prototype.getMapThemeDefinitionObj=function(c){var a=this.getTheme(c)||this.activeTheme;c={};c.layer=a.szThemes;c.field=a.szFields||"";c.field100=a.szField100||"";a.szFlag.match(/\bCATEGORICAL\b/)&&a.colorScheme&&3<a.colorScheme.length&&(!a.szValuesA||!a.szValuesA.length)&&a.szLabelA&&a.szLabelA.length&&100>=a.szLabelA.length&&(a.szValuesA=a.szLabelA.slice(0));var d={type:a.szFlag,colorscheme:a.origColorScheme},a=__maptheme_getStyleObj(a),b;for(b in a)d[b]=a[b];c.style=d;return this.cleanUpThemeObj(c)};
Map.Themes.prototype.getTheme=function(c){if(!c||"string"!=typeof c)return this.activeTheme;c=c.split(":")[0];for(var a=0;a<this.themesA.length;a++)if(this.themesA[a].szId==c||this.themesA[a].szName==c)return this.themesA[a];return this.activeTheme};Map.Themes.prototype.getThemeIndex=function(c){for(var a=0;a<this.themesA.length;a++)if(this.themesA[a].szId==c)return a};
Map.Themes.prototype.refreshTheme=function(c){if(c=this.getTheme(c))c.fRealize=!0,c.fRedraw=!0,!fAllIncluded&&c.coTable?this.loadExternalData(c.coTable,!0,c):executeWithMessage("map.Themes.execute()","... processing ...")};Map.Themes.prototype.nextClipFrame=function(c){(c=this.getTheme(c))&&c.realizeNextClipFrame()};Map.Themes.prototype.setClipFrame=function(c,a){var d=c?this.getTheme(c):this.activeTheme;d&&d.setClipFrame(a)};Map.Themes.prototype.pauseClip=function(c){(c=this.getTheme(c))&&c.pauseClip()};
Map.Themes.prototype.startClip=function(c){(c=this.getTheme(c))&&c.startClip()};
Map.Themes.prototype.loadExternalData=function(c,a,d){this.coTableExt||(this.coTableExt=[]);if(c){var b=map.Dictionary.getLocalText("... creating theme ...");a&&("undefined"!=eval("typeof("+c+")")&&eval(c+".table = null"),b=map.Dictionary.getLocalText("... refreshing theme ..."));this.__test=null;try{eval("this.__test = "+c+".table")}catch(f){try{eval("this.__test = "+c+"_table")}catch(e){}}var l=d.fEditor||!(d.coTableUrl&&d.coTableExt)||!1;this.themeDataCacheA[c]&&((this.themeDataCacheA[c].coTableUrl||
d.coTableUrl)&&this.themeDataCacheA[c].coTableUrl!=d.coTableUrl||(this.themeDataCacheA[c].coTableExt||d.coTableExt)&&this.themeDataCacheA[c].coTableExt!=d.coTableExt||(l=!0));if(this.__test&&l&&!0===d.fDataCache)this.fWaitforData=!1,d.fWaitingforData=!1,executeWithMessage("map.Themes.execute()",b),d&&d.coTableExt&&(d.coTableExt=this.coTableExt[d.coTable]);else{if(d&&(d.coTableUrl||d.coTableExt))try{this.themeDataCacheA[c]={coTableUrl:d.coTableUrl,coTableExt:d.coTableExt};this.fWaitforData=!0;d.fWaitingforData=
!0;HTMLWindow.ixmaps.htmlgui_loadExternalData(d.coTableUrl,{theme:d,type:d.coTableType,name:d.coTable,ext:d.coTableExt});this.coTableExt[d.coTable]=d.coTableExt;return}catch(k){}fLocalHost?this.loadExternalDataDefault(c,a,b):this.loadExternalDataZipped(c,a,b)}}};
Map.Themes.prototype.loadExternalDataZipped=function(c,a,d){this.fWaitforData=!0;displayMessage(map.Dictionary.getLocalText("... loading data ..."));var b=new JSLoader;b.finishedCallback="map.Themes.loadExternalDataFinish('"+d+"')";b.errorCallback="map.Themes.loadExternalDataDefault('"+c+"',"+a+",'"+d+"')";b.szMessage=map.Dictionary.getLocalText("... loading data ...");b.loadScript(map.mapRoot+c+".js.gz",a)};
Map.Themes.prototype.loadExternalDataDefault=function(c,a,d){this.fWaitforData=!0;displayMessage(map.Dictionary.getLocalText("... loading data ..."));var b=new JSLoader;b.finishedCallback="map.Themes.loadExternalDataFinish('"+d+"')";b.errorCallback="map.Themes.loadExternalDataFinish('"+d+"')";b.szMessage=map.Dictionary.getLocalText("... loading data ...");b.loadScript(map.mapRoot+c+".js",a)};
Map.Themes.prototype.loadExternalDataFinish=function(c){this.fWaitforData=!1;executeWithMessage("map.Themes.execute()",c)};Map.Themes.prototype.setExternalData=function(c,a,d){a&&(this._dataObj=a,eval(d+" = this._dataObj"));this.fWaitforData=!1;c=this.getAllThemes();for(var b in c)c[b].coTable==d&&(c[b].fWaitingforData=!1);this.execute()};
Map.Themes.prototype.activateTheme=function(c,a){var d=this.getTheme(a);d&&(d.fRedraw=!0,executeWithMessage("map.Themes.execute()","... processing ..."));c.stopPropagation();c.preventDefault()};Map.Themes.prototype.showTheme=function(c,a){var d=this.getTheme(a);d&&(d.fShow=!0,executeWithMessage("map.Themes.execute()","... processing ..."));c&&(c.stopPropagation(),c.preventDefault())};
Map.Themes.prototype.hideTheme=function(c,a){var d=this.getTheme(a);d&&(d.fHide=!0,executeWithMessage("map.Themes.execute()","... processing ..."));c&&(c.stopPropagation(),c.preventDefault())};Map.Themes.prototype.toggleTheme=function(c,a){var d=this.getTheme(a);d&&(d.fToggle=!0,executeWithMessage("map.Themes.execute()","... processing ..."));c&&(c.stopPropagation(),c.preventDefault())};
Map.Themes.prototype.removeTheme=function(c,a){for(var d=0;d<this.themesA.length;d++)if(this.themesA[d].szId==a||this.themesA[d].szName==a){var b=this.themesA[d];b.szFlag.match(/LOCKED/)||(b.szFlag.match(/CHART/)&&(b.fToggle=!0),b.fRemove=!0,executeWithMessage("map.Themes.execute()","... processing ..."))}c&&(c.stopPropagation(),c.preventDefault())};
Map.Themes.prototype.removeAll=function(c){for(var a=0;a<this.themesA.length;a++)this.themesA[a].szFlag.match(/LOCKED/)||(this.themesA[a].fRemove=!this.themesA[a].fRealize);setTimeout(function(){map.Themes.execute()},100);c&&(c.stopPropagation(),c.preventDefault())};
Map.Themes.prototype.removeAllCharts=function(c){for(var a=0;a<this.themesA.length;a++)this.themesA[a].szFlag.match(/CHART/)&&!this.themesA[a].szFlag.match(/LOCKED/)&&(this.themesA[a].fRemove=!this.themesA[a].fRealize);this.fWaitforData=!0;map.Themes.execute();c&&(c.stopPropagation(),c.preventDefault())};
Map.Themes.prototype.removeAllChoropleth=function(c){for(var a=0;a<this.themesA.length;a++)this.themesA[a].szFlag.match(/CHOROPLETH/)&&!this.themesA[a].szFlag.match(/LOCKED/)&&(this.themesA[a].fRemove=!this.themesA[a].fRealize);this.fWaitforData=!0;executeWithMessage("map.Themes.execute()","... processing ...");c&&(c.stopPropagation(),c.preventDefault())};
Map.Themes.prototype.removeAllSelections=function(c){for(var a=0;a<this.themesA.length;a++)this.themesA[a].szFlag.match(/SELECTION/)&&(this.themesA[a].fRemove=!0,executeWithMessage("map.Themes.execute()","... processing ..."));c&&(c.stopPropagation(),c.preventDefault())};Map.Themes.prototype.redrawInfoAll=function(c){for(var a=0;a<this.themesA.length;a++)this.themesA[a].fRedrawInfo=!0;map.Themes.execute();c&&(c.stopPropagation(),c.preventDefault())};
Map.Themes.prototype.reformat=function(c){for(var a=this.minY=this.minX=0;a<this.themesA.length;a++)this.themesA[a].fRepositionInfo=!0,this.themesA[a].fRedrawInfo=!0;map.Themes.execute();c&&(c.stopPropagation(),c.preventDefault())};
Map.Themes.prototype.execute=function(){var c=null,a=null,d=0;if(!map.isIdle())setTimeout(function(){map.Themes.execute()},100);else if(!this.fWaitforData)if(map.Tiles.isLoading())setTimeout(function(){map.Themes.execute()},250),this.fExecuteDelayed=!0;else if(this.fExecuteDelayed)this.fExecuteDelayed=!1,executeWithMessage("map.Themes.execute()"," ... ");else{for(d=0;d<this.themesA.length;d++)(this.themesA[d].fRealize||this.themesA[d].fRedraw||this.themesA[d].fToFront)&&this.themesA[d].szFlag.match(/CHOROPLETH/)&&
!this.themesA[d].szFlag.match(/SUBTHEME/)&&(c=this.themesA[d].szShapeType,a=this.themesA[d].szThemes);if(c&&this.enableMultiChoropleth)for(d=0;d<this.themesA.length;d++)this.themesA[d].szFlag&&this.themesA[d].szFlag.match(/CHOROPLETH/)&&this.themesA[d].szShapeType==c&&(this.themesA[d].disable(),this.themesA[d].isVisible=!1,this.themesA[d].fRedrawInfo=!1);if(c&&!this.enableMultiChoropleth)for(d=0;d<this.themesA.length;d++)!this.themesA[d].szFlag||!this.themesA[d].szFlag.match(/CHOROPLETH/)||this.themesA[d].szShapeType!=
c||this.themesA[d].szThemes!=a||this.themesA[d].fRealize||this.themesA[d].fRedraw||this.themesA[d].fToFront||(this.themesA[d].fRemove=!0);for(d=0;d<this.themesA.length;d++){if(this.themesA[d].fWaitingforData)return;if(this.themesA[d].fShow){this.themesA[d].toggle(!0);this.themesA[d].fShow=!1;break}if(this.themesA[d].fHide){this.themesA[d].toggle(!1);this.themesA[d].fHide=!1;break}if(this.themesA[d].fToggle){this.themesA[d].toggle();this.themesA[d].fToggle=!1;this.execute();break}if(this.themesA[d].fRemove){1<
this.themesA.length&&!this.themesA[d].szFlag.match(/SELECTION/)&&!this.themesA[d].szFlag.match(/CHART/)&&this.activateNextPaint(this.themesA[d]);this.themesA[d].removeElements();this.remove(this.themesA[d]);this.reformat();this.execute();break}if(this.themesA[d].fRealize)this.themesA[d].fEnableProgressBar=!0,this.themesA[d].fRealize=!1,this.themesA[d].realize();else if(this.themesA[d].fRedraw)this.themesA[d].checkHiddenLayerState&&this.themesA[d].checkHiddenLayerState()?(this.themesA[d].fRealize=
!0,this.themesA[d].fRedraw=!1,this.themesA[d].fReload=!1,this.themesA[d].unpaintMap(),map.Themes.execute()):(this.themesA[d].fEnableProgressBar=!0,this.themesA[d].redraw(!1));else if(this.themesA[d].fActualize)this.themesA[d].fActualize=!1,this.themesA[d].checkHiddenLayerState&&this.themesA[d].checkHiddenLayerState()?(this.themesA[d].fRealize=!0,this.themesA[d].fRedraw=!1,this.themesA[d].fReload=!1,this.themesA[d].unpaintMap(),map.Themes.execute()):(this.themesA[d].fEnableProgressBar=!0,this.themesA[d].redraw(!1));
else if(this.themesA[d].fToFront)this.themesA[d].fEnableProgressBar=!1,this.themesA[d].toFront(),this.themesA[d].fToFront=!1;else if(this.themesA[d].fResize)this.themesA[d].resize(this.themesA[d].fResize),this.themesA[d].fResize=!1;else if(this.themesA[d].fOpacity)this.themesA[d].opacity(this.themesA[d].fOpacity),this.themesA[d].fOpacity=!1;else if(this.themesA[d].fBlur)this.themesA[d].blur(this.themesA[d].nBlur),this.themesA[d].fBlur=!1;else if(this.themesA[d].fOffset)this.themesA[d].offset(this.themesA[d].fOffset),
this.themesA[d].fOffset=!1;else if(this.themesA[d].fRedrawInfo)this.themesA[d].widgetNode&&this.themesA[d].showInfo(),this.themesA[d].fRedrawInfo=!1;else if(this.themesA[d].fResort){try{this.themesA[d].sortChartObjects()}catch(b){}this.themesA[d].fResort=!1}else if(this.themesA[d].fDeclutter){try{this.themesA[d].declutterCharts()}catch(f){}this.themesA[d].fDeclutter=!1}}this.executeCallback&&(eval(this.executeCallback),this.executeCallback=null);clearMessage();clearMessage(1E3)}};
Map.Themes.prototype.executeContinue=function(){for(var c=0;c<this.themesA.length;c++)this.themesA[c].fAnalyze?(this.themesA[c].fAnalyze=!1,this.themesA[c].realize_analyze()):this.themesA[c].fDraw?(this.themesA[c].fDraw=!1,this.themesA[c].realize_draw()):this.themesA[c].fContinue?(this.themesA[c].fContinue=!1,this.themesA[c].realizeContinue(this.themesA[c].continueIndex)):this.themesA[c].fContinueLoadAndAggregate&&(this.themesA[c].fContinueLoadAndAggregate=!1,this.themesA[c].loadAndAggregateValuesOfTheme(this.themesA[c].szThemeLayer,
this.themesA[c].continueIndex))};Map.Themes.prototype.realizeDone=function(c){for(var a=0;a<this.themesA.length;a++)this.themesA[a].szFlag.match(/SELECTION/)&&(this.themesA[a].fRealize=!0);c.fRealizeDone=!0;try{HTMLWindow.ixmaps.htmlgui_onDrawTheme(c.szId)}catch(d){}c.szFlag.match(/TEXTONLY/)&&setTimeout(function(){map.Layer.adaptLabel()},10);c.userChartDrawError&&c.userChartDrawError==c.nDoneCount&&displayMessage("User draw function error! ",5E3);this.isIdle()&&clearMessage()};
Map.Themes.prototype.showProgressBar=function(){for(var c=0;c<this.themesA.length;c++)(this.themesA[c].fRealize||this.themesA[c].fContinue||this.themesA[c].fAnalyze||this.themesA[c].fDraw)&&2<this.themesA[c].nCount/this.themesA[c].nDoneCount&&this.themesA[c].mapSleep?this.themesA[c].mapSleep.fShowProgressBar=!0:(this.themesA[c].fRealize||this.themesA[c].fContinue||this.themesA[c].fAnalyze||this.themesA[c].fDraw)&&setTimeout(function(){map.Themes.showProgressBar()},1E3)};
Map.Themes.prototype.remove=function(c){c==this.activeTheme&&(this.activeTheme=null);c==this.activeBuffer&&(this.activeBuffer=null);for(var a=0;a<this.themesA.length;a++)if(this.themesA[a]==c){for(;a<this.themesA.length-1;a++)this.themesA[a]=this.themesA[a+1];this.themesA.length--}c.removeValues();delete c};Map.Themes.prototype.cancelExecute=function(){this.activeTheme.fCancel=!0};Map.Themes.prototype.sequence=function(){this.sequenceNr=0;this.sequenceNext()};
Map.Themes.prototype.sequenceNext=function(){this.sequenceNr<this.themesA.length&&(this.themesA[this.sequenceNr].fRedraw=!0,map.Themes.executeCallback="setTimeout('map.Themes.sequenceNext()',500)",map.Themes.execute(),this.sequenceNr++)};
Map.Themes.prototype.activateNextPaint=function(c){c=this.getThemeIndex(c.szId);for(var a=c-1;a!=c;a--){0>a&&(a=this.themesA.length-1);if(a==c)break;if(this.themesA[a].isChecked&&!this.themesA[a].szFlag.match(/CHART/))return this.themesA[a].fRedraw=!0,this.themesA[a].fRedrawInfo=!1,!0}return!1};Map.Themes.prototype.toggleThemeValues=function(c,a){this.toggleValueDisplay(c,this.activeTheme.szId,!this.activeTheme.szFlag.match(/VALUES/))};
Map.Themes.prototype.toggleThemeLegends=function(c,a){SVGThemeGroup.style.setProperty("display",a?"inline":"none","")};Map.Themes.prototype.minimizeThemeLegends=function(c){this.fMinimizedLegends=!0;for(var a=0;a<this.themesA.length;a++)this.minimizeInfo(c,this.themesA[a].szId)};Map.Themes.prototype.changeAllChartScaling=function(c,a){for(var d=0;d<this.themesA.length;d++)this.themesA[d].fResize=999,executeWithMessage("map.Themes.execute()","... processing ...");c.stopPropagation();c.preventDefault()};
Map.Themes.prototype.changeChartScaling=function(c,a,d){if(a=this.getTheme(a))a.fResize=d,executeWithMessage("map.Themes.execute()","... processing ...");c.stopPropagation();c.preventDefault()};Map.Themes.prototype.changeChartOpacity=function(c,a,d){if(a=this.getTheme(a))a.fOpacity=d,executeWithMessage("map.Themes.execute()","... processing ...");c.stopPropagation();c.preventDefault()};
Map.Themes.prototype.changeChartOffset=function(c,a,d){if((c=this.getTheme(a))&&c.leadOffset&&(d=SVGDocument.getElementById(d))){d.fu=new Methods(d);a=d.fu.getPosition();var b=d.fu.getGroupScale();c.fOffset=new point(a.x-c.leadOffset.x,a.y-c.leadOffset.y);d.fu.setPosition(c.leadOffset.x,c.leadOffset.y);c.fOffset.x/=map.Zoom.nZoom/b.x;c.fOffset.y/=map.Zoom.nZoom/b.y;c.offset(c.fOffset);c.fOffset=!1;c.leadOffset=!1}};
Map.Themes.prototype.tellChartOffset=function(c,a,d){(c=this.getTheme(a))&&!c.leadOffset&&this.enableChartOffset&&(d=SVGDocument.getElementById(d))&&(d.fu=new Methods(d),c.leadOffset=d.fu.getPosition())};Map.Themes.prototype.initChartOffset=function(c,a,d){if(this.getTheme(a)){var b=SVGDocument.getElementById(d);b&&(b.origPosition||(b.origPosition=b.fu.getPosition()),b.onMouseMove=function(a){b.actualPosition=b.fu.getPosition();map.Themes.makeChartOffsetPointer(b)},b.widgetObj=new Widget(b,b))}};
Map.Themes.prototype.endChartOffset=function(c,a,d){this.getTheme(a)&&(c=SVGDocument.getElementById(d))&&c.widgetObj.remove()};
Map.Themes.prototype.makeChartOffsetPointer=function(c,a){a=a||1;c.pointerObj?(map.Dom.clearGroup(c.pointerObj),map.Dom.clearGroup(c.pointShObj)):(c.pointerObj=map.Dom.newGroup(c),c.pointShObj=map.Dom.newGroup(c),c.pointerObj.parentNode.insertBefore(c.pointerObj,c.pointerObj.parentNode.firstChild),c.pointShObj.parentNode.insertBefore(c.pointShObj,c.pointShObj.parentNode.firstChild));if(c.origPosition||c.actualPosition){var d=new box(0,0,100,75),b=new point(c.actualPosition.x-c.origPosition.x,c.actualPosition.y-
c.origPosition.y),f=map.Scale.normalX(15),e=map.Scale.normalX(5),l=map.Scale.normalX(10);map.Scale.normalX(5);e=b.y+d.height/2;f=b.x+d.width/2;Math.abs(e)+d.width/2-d.height/2>Math.abs(f)?(d.width/3>l&&(b.x>-d.width/3&&(f-=d.width/3),b.x<-d.width/3*2&&(f+=d.width/3)),0<e?(map.Dom.newShape("path",c.pointShObj,"M"+-b.x+","+-b.y+" l "+(f-map.Scale.normalX(5/a))+","+(b.y+map.Scale.normalX(1/a))+" "+map.Scale.normalX(4/a)+",0 z","fill:black;fill-opacity:0.5"),map.Dom.newShape("path",c.pointerObj,"M"+-b.x+
","+-b.y+" l "+(f-map.Scale.normalX(5/a))+","+(b.y+map.Scale.normalX(1/a))+" "+map.Scale.normalX(3/a)+",0 z","fill:white")):(map.Dom.newShape("path",c.pointShObj,"M"+-b.x+","+-b.y+" l "+(f-map.Scale.normalX(4/a))+","+(b.y+d.height)+" "+map.Scale.normalX(4/a)+",0 z","fill:black;fill-opacity:0.5"),map.Dom.newShape("path",c.pointerObj,"M"+-b.x+","+-b.y+" l "+(f-map.Scale.normalX(4/a))+","+(b.y+d.height)+" "+map.Scale.normalX(3/a)+",0 z","fill:white"))):(d.height/5>l&&(b.y>-d.height/3&&(e-=d.height/3),
b.y<-d.height/3*2&&(e+=d.height/3)),0<f?(map.Dom.newShape("path",c.pointShObj,"M"+-b.x+","+-b.y+" l "+(b.x-d.width)+","+(e-map.Scale.normalX(4/a))+" 0,"+map.Scale.normalX(4/a)+" z","fill:black;fill-opacity:0.5"),map.Dom.newShape("path",c.pointerObj,"M"+-b.x+","+-b.y+" l "+(b.x-d.width)+","+(e-map.Scale.normalX(4/a))+" 0,"+map.Scale.normalX(3/a)+" z","fill:white")):(map.Dom.newShape("path",c.pointShObj,"M"+-b.x+","+-b.y+" l "+(b.x+d.width)+","+(e-map.Scale.normalX(4/a))+" 0,"+map.Scale.normalX(4/a)+
" z","fill:black;fill-opacity:0.5"),map.Dom.newShape("path",c.pointerObj,"M"+-b.x+","+-b.y+" l "+(b.x+d.width)+","+(e-map.Scale.normalX(4/a))+" 0,"+map.Scale.normalX(3/a)+" z","fill:white")))}};
MapTheme.prototype.declutterCharts=function(){if(!(this.szDeclutterUpper&&map.Scale.nTrueMapScale*map.Scale.nZoomScale>this.nDeclutterUpper)){for(var c=this.chartGroup.childNodes,a=0;a<c.length;a++)c[a].actualPosition&&(c[a].fu.setPosition(c[a].origPosition.x,c[a].origPosition.y),c[a].origPosition=null,c[a].actualPosition=null,c[a].pointerObj&&(map.Dom.clearGroup(c[a].pointerObj),map.Dom.clearGroup(c[a].pointShObj)),c[a].pointerObj=null,c[a].pointShObj=null);if(!c[0].actualPosition){var d=c[0].fu.getBox();
map.Zoom.getBox();for(var b=[],a=0;a<c.length;a++){var f=!1,e=c[a].fu.getPosition(),l=c[a].fu.getBox();l.x+=e.x;l.y+=e.y;for(var k in b)for(var n in b[k])if(!(l.y+l.height<b[k][n].box.y-.3*b[k][n].box.height||l.y>b[k][n].box.y+1.3*b[k][n].box.height||l.x+l.width<b[k][n].box.x-b[k][n].box.width||l.x>b[k][n].box.x+2*b[k][n].box.width)){b[k].push({node:c[a],y:c[a].fu.getPosition().x,box:l});f=!0;break}f||b.push([{node:c[a],y:c[a].fu.getPosition().x,box:l}])}for(k=0;k<b.length;k++)if(c=b[k],c.sort(this.sortUpChartObjectsCompare),
1<c.length&&5>c.length){f=c[0].node.fu.getPosition();for(a=0;a<c.length;a++)e=c[a].node.fu.getPosition(),e.y<f.y&&(f.x=e.x,f.y=e.y);f.y-=map.Scale.normalX(50)*map.Scale.nZoomScale;e=c[0].node.fu.getPosition();for(a=0;a<c.length;a++)c[a].node.origPosition=c[a].node.fu.getPosition(),c[a].node.fu.setPosition(e.x+1.2*d.width*a,f.y),c[a].node.actualPosition=new point(e.x+1.2*d.width*a,f.y),l=c[a].node.fu.getScale().x,c[a].node.actualPosition.x=c[a].node.origPosition.x-(c[a].node.origPosition.x-c[a].node.actualPosition.x)/
l,c[a].node.actualPosition.y=c[a].node.origPosition.y-(c[a].node.origPosition.y-c[a].node.actualPosition.y)/l,map.Themes.makeChartOffsetPointer(c[a].node,this.nScale)}}}};Map.Themes.prototype.toggleValueDisplay=function(c,a,d){if(a=this.getTheme(a)){for(var b="",f=a.szFlag.split("|"),e=0;e<f.length;e++)"VALUES"!=f[e]&&(b+=(b.length?"|":"")+f[e]);d&&(b+="|VALUES");executeWithMessage("map.Themes.doChangeThemeStyle('"+a.szId+"','type:"+b+"')","... processing ...")}c&&(c.stopPropagation(),c.preventDefault())};
Map.Themes.prototype.toggleDopacity=function(c,a,d){if(a=this.getTheme(a)){for(var b="",f=a.szFlag.split("|"),e=0;e<f.length;e++)f[e].match(/DOPACITY/)||(b+=(b.length?"|":"")+f[e]);d&&(b+="|DOPACITYMAX");executeWithMessage("map.Themes.doChangeThemeStyle('"+a.szId+"','type:"+b+"')","... processing ...")}c&&(c.stopPropagation(),c.preventDefault())};
Map.Themes.prototype.changeDopacityAlphaRamp=function(c,a,d){if(a=this.getTheme(a)){var b=a.szFlag;a.nDopacityScale=a.nDopacityScale||1;a.nDopacityScale*=d;executeWithMessage("map.Themes.doChangeThemeStyle('"+a.szId+"','type:"+b+"')","... processing ...")}c&&(c.stopPropagation(),c.preventDefault())};Map.Themes.prototype.toggleChartDisplay=function(c,a,d){if(a=this.getTheme(a))a.fToggle=!0,executeWithMessage("map.Themes.execute()","... processing ...");c.stopPropagation();c.preventDefault()};
Map.Themes.prototype.zoomTo=function(c,a){var d=this.getTheme(a)||this.activeTheme;d&&d.zoomTo()};Map.Themes.prototype.zoomToClass=function(c,a,d,b){setTimeout(function(){map.Themes.doZoomToClass(a,d,b)},100)};
Map.Themes.prototype.markClass=function(c,a,d,b){var f=this.getTheme(a);f&&f.isVisible&&!f.showInfoMore&&("undefined"!=typeof f.markedClass&&f.markedClass==d||"undefined"!=typeof f.markedClasses&&f.markedClasses[d]?this.unmarkClass(c,a,d):(f.fMarkEnable=!0,f.fUnmarkEnable=!1,this.markTimeout&&clearTimeout(this.markTimeout),this.unmarkTimeout&&clearTimeout(this.unmarkTimeout),displayMessage("...",1E3,!0),this.markTimeout=setTimeout(function(){map.Themes.doMarkClass(a,d,b)},50)))};
Map.Themes.prototype.unmarkClass=function(c,a,d){(c=this.getTheme(a))&&c.isVisible&&!c.showInfoMore&&(displayMessage("...",1E3,!0),this.unmarkTimeout=setTimeout(function(){map.Themes.doUnmarkClass(a,d)},50),c.fUnmarkEnable=!0,c.fMarkEnable=!1)};Map.Themes.prototype.doZoomToClass=function(c,a,d){(c=this.getTheme(c))&&c.zoomToClass(Number(a),Number(d))};
Map.Themes.prototype.doMarkClass=function(c,a,d){if(c=this.getTheme(c)){c.markedClass=a;c.markedClasses=c.markedClasses||[];c.markedClasses[a]=!0;c.markedClassesA=[];for(var b in c.markedClasses)!0===c.markedClasses[b]&&c.markedClassesA.push(b);c.markClass(Number(a),Number(d));try{HTMLWindow.ixmaps.htmlgui_onDrawTheme(c.szId)}catch(f){}}};
Map.Themes.prototype.doUnmarkClass=function(c,a){if(this.subTheme)this.subTheme.removeSubTheme(),this.subTheme=null;else{var d=this.getTheme(c);if(d){d.markedClass=null;if(d.markedClasses){d.markedClasses[a]=!1;d.markedClassesA=[];for(var b in d.markedClasses)!0===d.markedClasses[b]&&d.markedClassesA.push(b);if(d.markedClassesA.length){displayMessage("...",1E3,!0);d.fMarkEnable=!0;d.markClass(d.markedClassesA[0],1);d.fMarkEnable=!1;try{HTMLWindow.ixmaps.htmlgui_onDrawTheme(d.szId)}catch(f){}return}delete d.markedClassesA;
delete d.markedClasses}d.unmarkClass();try{HTMLWindow.ixmaps.htmlgui_onDrawTheme(d.szId)}catch(e){}}}};Map.Themes.prototype.hideClass=function(c,a,d,b){(c=this.getTheme(a))&&c.isVisible&&c.showClass(Number(d),Number(b),!1)};Map.Themes.prototype.showClass=function(c,a,d,b){(c=this.getTheme(a))&&c.isVisible&&c.showClass(Number(d),Number(b),!0)};Map.Themes.prototype.classesToRanges=function(c,a){var d=this.getTheme(a);d&&d.isVisible&&d.classesToRanges()};
Map.Themes.prototype.filterItems=function(c,a,d,b){(c=a?this.getTheme(a):this.activeTheme)&&c.isVisible&&!c.showInfoMore&&(c.fMarkEnable=!0,c.fUnmarkEnable=!1,this.markTimeout&&clearTimeout(this.markTimeout),this.unmarkTimeout&&clearTimeout(this.unmarkTimeout),this.opt=b,this.markTimeout=setTimeout(function(){map.Themes.doFilterItems(a,d)},500))};Map.Themes.prototype.doFilterItems=function(c,a){executeWithMessage("map.Themes.doFilterItemsGo('"+c+"','"+a+"')","applying filter ...")};
Map.Themes.prototype.doFilterItemsGo=function(c,a){clearMessage();var d=this.getTheme(c?c:null);d&&(d.filterItems(a,this.opt),this.activeTheme=d)};Map.Themes.prototype.selectFilterItems=function(c,a){var d=this.getTheme(a);d&&d.selectFilterItems()};Map.Themes.prototype.highlightItems=function(c,a,d,b){(c=a?this.getTheme(a):this.activeTheme)&&c.isVisible&&(this.highlightTimeout&&clearTimeout(this.highlightTimeout),this.highlightTimeout=setTimeout(function(){map.Themes.doHighlightItems(a,d,b)},500))};
Map.Themes.prototype.doHighlightItems=function(c,a,d){(c=c?this.getTheme(c):this.activeTheme)&&c.highlightItems(a,d)};Map.Themes.prototype.clearHighlightItems=function(c,a){var d=a?this.getTheme(a):this.activeTheme;d&&d.isVisible&&(this.highlightTimeout&&clearTimeout(this.highlightTimeout),d.clearHighlightItems())};
Map.Themes.prototype.setTimeFrame=function(c,a,d,b){(c=this.getTheme(a))&&c.isVisible&&!c.showInfoMore&&(this.markTimeout&&clearTimeout(this.markTimeout),this.unmarkTimeout&&clearTimeout(this.unmarkTimeout),this.markTimeout=setTimeout(function(){map.Themes.doSetTimeFrame(a,d,b)},1))};Map.Themes.prototype.doSetTimeFrame=function(c,a,d){(c=this.getTheme(c))&&c.setTimeFrame(a,d)};
Map.Themes.prototype.changeThemeStyle=function(c,a,d,b){b.match(/fast||silent||direct/)?map.Themes.doChangeThemeStyle(a,d.replace(/'/g,"\\'"),b):executeWithMessage("map.Themes.doChangeThemeStyle('"+a+"','"+d.replace(/'/g,"\\'")+"','"+b+"')","... processing ...");c&&(c.stopPropagation(),c.preventDefault())};function __calcNewValue(c,a,d){c=Number(c)||0;a=Number(a)||0;return d&&d.match(/pow/)?Math.pow(c,a):d&&d.match(/factor/)?c*a:d&&(d.match(/add/)||d.match(/delta/))?c+a:a}
function __calcFactor(c,a,d){c=c||0;a=a||0;return d&&d.match(/factor/)?a:d&&d.match(/add/)?(c+a)/c:a/c}
Map.Themes.prototype.doChangeThemeStyle=function(c,a,d){var b=this.getTheme(c);if(b){if(a=__getStyleObj(a)){if(a.type){a.origType=a.type;if(d&&d.match(/add/)){var f=a.type.split("|");this.szTempStyle=b.szFlag;for(var e=0;e<f.length;e++)eval("this.szTempStyle.match(/"+f[e]+"/)")||(this.szTempStyle+="|"+f[e]);a.type=this.szTempStyle}else if(d&&d.match(/remove/)){for(var f=b.szFlag.split("|"),l="",e=0;e<f.length;e++)f[e]!=a.type&&(l+=(l.length?"|":"")+f[e]);a.type=l}else if(d&&d.match(/toggle/)){for(var f=
b.szFlag.split("|"),l="",k=!1,e=0;e<f.length;e++)f[e]!=a.type?l+=(l.length?"|":"")+f[e]:k=!0;a.type=l+(k?"":"|"+a.type)}else b.szFlag.match(/FRACTION/)&&(a.type+="|FRACTION"),b.szFlag.match(/PERMILLE/)&&(a.type+="|PERMILLE"),b.szFlag.match(/CALCVAL/)&&(a.type+="|CALCVAL"),b.szFlag.match(/CALC100/)&&(a.type+="|CALC100"),b.szFlag.match(/PRODUCT/)&&(a.type+="|PRODUCT"),b.szFlag.match(/RELATIVE/)&&(a.type+="|RELATIVE"),b.szFlag.match(/INVERT/)&&(a.type+="|INVERT"),b.szFlag.match(/INVERTSIZE/)&&(a.type+=
"|INVERTSIZE"),b.szFlag.match(/DENSITY/)&&(a.type+="|DENSITY"),b.szFlag.match(/SUM/)&&(a.type+="|SUM"),b.szFlag.match(/CALCMEAN/)&&(a.type+="|CALCMEAN"),b.szFlag.match(/AUTO100/)&&(a.type+="|AUTO100");a.type.match(/LOCKED/)&&(b.fRedrawInfo=!0,map.Themes.execute());if(a.type.match(/CHART/)&&!b.szFlag.match(/CHART/)||a.type.match(/CHOROPLETH/)&&!b.szFlag.match(/CHOROPLETH/))b.unpaintMap(),this.activateNextPaint(b);!a.type.match(/CATEGORICAL/)&&(a.type.match(/EQUIDISTANT/)||a.type.match(/POW2/)||a.type.match(/POW3/)||
a.type.match(/LOG/)||a.type.match(/QUANTILE/))&&(b.szOldRanges=b.szRanges?b.szRanges:b.szOldRanges,b.szRanges=null,b.szOldLabelA=b.szLabelA?b.szLabelA:b.szOldLabelA,b.szLabelA=null,b.fRealize=!0);a.type.match(/RANGES/)&&a.ranges&&(b.szRanges=b.szOldRanges?b.szOldRanges:b.szRanges,b.szRangesA=a.ranges.split(a.ranges.match(/\|/)?"|":","),b.szLabelA=b.szOldLabelA?b.szOldLabelA:b.szLabelA,Number(b.origColorScheme[0])&&b.szRanges&&(b.origColorScheme[0]=b.szRangesA.length-1),b.fRealize=!0);if(a.type.match(/RANGES/)&&
!a.ranges){b.szRangesA=[b.partsA[0].min];for(var n in b.partsA)b.szRangesA.push(b.partsA[n].max)}n=b.szFlag;b.szFlag=a.type;!b.szFlag.match(/CHART/)||b.szFlag.match(/BUFFER/)||n.match(/CHART/)||(b.fShadow=b.fOrigShadow=!0);a.origType.match(/AGGREGATE/)||a.origType.match(/GROUP/)||a.origType.match(/\bRECT\b/)||a.origType.match(/RELOCATE/)?(b.fRealize=!0,b.fRedraw=!1,b.unpaintMap(),b.themeNodesPosA=[]):(b.fRedraw=!0,b.fRedrawInfo=!0);a.type.match(/DTEXT/)!=n.match(/DTEXT/)&&b.unlabelMap();a.type.match(/AUTO100/)!=
n.match(/AUTO100/)&&(b.fRealize=!0,b.fRedraw=!1,b.unpaintMap());a.type.match(/DIFFERENCE/)!=n.match(/DIFFERENCE/)&&(b.fRealize=!0,b.fRedraw=!1,b.unpaintMap());a.type.match(/NOOUTLIER/)!=n.match(/NOOUTLIER/)&&(b.fRealize=!0,b.fRedraw=!1,b.unpaintMap());a.type.match(/OUTLIER/)!=n.match(/OUTLIER/)&&(b.fRealize=!0,b.fRedraw=!1,b.unpaintMap());a.type.match(/NEGATIVEISNOTVALUE/)!=n.match(/NEGATIVEISNOTVALUE/)&&(b.fNegativeValuePossible=!a.type.match(/NEGATIVEISNOTVALUE/),b.fRealize=!0,b.fRedraw=!0)}else if(d&&
d.match(/remove/)){for(f in a)for(l in themeStyleTranslateA)themeStyleTranslateA[l].style==f&&(b[themeStyleTranslateA[l].obj]=null);b.fReload=!0;b.fRealize=!0;b.unpaintMap();executeWithMessage("map.Themes.execute()","... processing ...");return}__isdef(a.classes)&&(isNaN(Number(b.origColorScheme[0]))&&(b.origColorScheme[3]=b.origColorScheme[b.origColorScheme.length/2],b.origColorScheme[4]="2colors",n=b.origColorScheme[b.origColorScheme.length-1],b.origColorScheme[1]=b.origColorScheme[0],b.origColorScheme[2]=
n),b.origColorScheme[0]=Number(a.classes),b.szFlag.match(/CHART/)&&b.unpaintMap(),b.szOldRanges=b.szRanges,b.szRanges=null,b.fRealize=!0);__isdef(a.ranges)&&(b.szRanges=a.ranges,b.szRangesA=a.ranges.split(a.ranges.match(/\|/)?"|":","),b.fRealize=!0);__isdef(a.colorstyle)&&"spectrum"==b.origColorScheme[1]&&(b.origColorScheme[2]=a.colorstyle,b.szFlag.match(/CHART/)&&b.unpaintMap(),b.fRealize=!0);__isdef(a.colordef)&&(b.origColorScheme=a.colordef.match(/\|/)?a.colordef.split("|"):a.colordef.split(","),
b.colorScheme=b.origColorScheme,b.fRedraw=!0,b.szFlag.match(/CHART/)||(b.fRealize=!0),b.fRedrawInfo=!0,b.showInfo());if(__isdef(a.colorscheme)&&(n=a.colorscheme.match(/\|/)?a.colorscheme.split("|"):a.colorscheme.split(","))&&n.length){isNaN(Number(b.origColorScheme[0]))&&(b.origColorScheme[0]=b.origColorScheme.length);b.origColorScheme.length=1;for(e=0;5>e;e++)b.origColorScheme[e+1]=e<n.length?n[e]:null;try{b.colorScheme=ColorScheme.createColorScheme(b.origColorScheme[1],b.origColorScheme[2],b.origColorScheme[0],
b.origColorScheme[3],b.origColorScheme[4])}catch(h){b.colorScheme=b.defaultColorScheme}b.fRedraw=!0;b.szFlag.match(/CHART/)||(b.fRealize=!0);b.fRedrawInfo=!0;b.showInfo()}if(__isdef(a.colorschemegeneration)&&!isNaN(Number(b.origColorScheme[0]))){switch(a.colorschemegeneration){case "warm":b.origColorScheme[4]="#FFFDD8";break;case "cold":b.origColorScheme[4]="#FFFFFF";break;default:b.origColorScheme[4]=a.colorschemegeneration}b.szFlag.match(/CHART/)&&b.unpaintMap();try{b.colorScheme=ColorScheme.createColorScheme(b.origColorScheme[1],
b.origColorScheme[2],b.origColorScheme[0],b.origColorScheme[3],b.origColorScheme[4])}catch(p){b.colorScheme=b.defaultColorScheme}b.fRedraw=!0;b.fRedrawInfo=!0}__isdef(a.symbols)&&(b.szSymbolsA=a.symbols.split(a.symbols.match(/\|/)?"|":","),b.fRealize=!0);if(__isdef(a.values)){n=this.toArray(a.values);if(n.length)for(e=0;e<n.length;e++)b.getStringValueIndex(n[e],"set");b.szValuesA=[];b.szLabelA=[];for(e in b.nStringToValueA)b.szValuesA.push(e),b.szLabelA.push(e);b.fRealize=!0}__isdef(a.dominantdfilter)&&
(b.nDominantDFilter=Number(a.dominantdfilter),b.fRealize=!0);__isdef(a.dominantfilter)&&(b.szDominantFilter=String(a.dominantfilter),b.fRealize=!0);__isdef(a.filter)&&(d&&d.match(/remove/)?b.szFilter="":b.szFilter=String(a.filter),b.fRealize=!0,b.unpaintMap());__isdef(a.filterfield)&&(b.szFilterField=String(a.filterfield),b.fRealize=!0);__isdef(a.markclasses)&&(b.markedClassesA=this.toArray(a.markclasses),b.markedClasses=[],b.unmarkClass(),b.markedClassesA.forEach(function(a,c){0<=a&&(b.markedClasses[a]=
!0,b.markClass(a))}));__isdef(a.field100min)&&(b.nField100Min=a.field100min,b.fRealize=!0);__isdef(a.overviewchart)&&!b.szFlag.match(/CHART/)&&(b.szOverviewChart=a.overviewchart,b.fRedrawInfo=!0);__isdef(a.evidence)&&(b.evidenceMode=a.evidence);__isdef(a.aggregation)&&(b.szAggregation=a.aggregation);__isdef(a.opacity)&&(b.fOpacity=__calcNewValue(b.fOpacity,Number(a.opacity),d),b.autoOpacity=!1);__isdef(a.fillopacity)&&(b.fillOpacity=__calcNewValue(b.fillOpacity||(1>Number(a.fillopacity)?1:0),Number(a.fillopacity),
d),b.autoOpacity=!1,b.fillOpacity=Math.min(Math.max(b.fillOpacity,.001),1),b.fRedraw=!0);__isdef(a.shadow)&&(b.fShadow="toggle"==a.shadow?b.fOrigShadow=!b.fOrigShadow:b.fOrigShadow=a.shadow,b.fRedraw=!0);__isdef(a.showdata)&&(b.fShowData="toggle"==a.showdata?!b.fShowData:JSON.parse(a.showdata),b.fRedraw=!0);__isdef(a.blur)&&("toggle"==a.blur?b.nBlur?(b.nOldBlur=b.nBlur,b.nBlur=0):b.nBlur=b.nOldBlur||1:b.nBlur=__calcNewValue(b.nBlur,Number(a.blur),d),b.fBlur=!0);__isdef(a.scale)&&(b.fResize=__calcFactor(b.nScale,
Number(a.scale),d));__isdef(a.dopacityscale)&&(b.nDopacityScale=__calcNewValue(b.nDopacityScale,Number(a.dopacityscale),d),b.fRedraw=!0);__isdef(a.d_dopacityscale)&&(b.nDopacityScale*=Number(a.d_dopacityscale),b.fRedraw=!0);__isdef(a.alphafield)&&(b.szAlphaField=String(a.alphafield),b.fRealize=!0);__isdef(a.alphafield100)&&(b.szAlphaField100=String(a.alphafield100),b.fRealize=!0);__isdef(a.dopacityramp)&&(b.szDopacityRamp=a.dopacityramp,b.fRealize=!0);__isdef(a.dopacitypow)&&(b.nDopacityPow=__calcNewValue(b.nDopacityPow,
Number(a.dopacitypow),d),b.fRealize=!0);__isdef(a.brightness)&&(b.nBrightness=__calcNewValue(b.nBrightness||1,Number(a.brightness),d),b.fRealize=!0);__isdef(a.rangescale)&&(b.nRangeScale=__calcNewValue(b.nRangeScale||1,Number(a.rangescale),d),b.fRedraw=!0);__isdef(a.sizefield)&&(b.szSizeField=String(a.sizefield),b.fRealize=!0);__isdef(a.timefield)&&(b.szTimeField=String(a.timefield),b.fRealize=!0);__isdef(a.xfield)&&(b.szXField=String(a.xfield),b.fRealize=!0);__isdef(a.yfield)&&(b.szYField=String(a.yfield),
b.fRealize=!0);__isdef(a.labelfield)&&(b.szLabelField=String(a.labelfield),b.fRealize=!0);__isdef(a.colorfield)&&(b.szColorField=String(a.colorfield),b.fRealize=!0);__isdef(a.symbolfield)&&(b.szSymbolField=String(a.symbolfield),b.fRealize=!0);__isdef(a.valuefield)&&(b.szValueField=String(a.valuefield),b.fRealize=!0);__isdef(a.normalsizevalue)&&(b.nNormalSizeValue||(b.nNormalSizeValue=b.szSizeField?b.nMaxSize:b.nMax),b.nNormalSizeValue=__calcNewValue(b.nNormalSizeValue,Number(a.normalsizevalue),d),
b.fRedraw=!0);__isdef(a.minvalue)&&(b.nMinValue=__calcNewValue(b.nMinValue||1,Number(a.minvalue),d),b.fRedraw=!0);__isdef(a.valuedecimals)&&(b.nValueDecimals=a.valuedecimals,b.fRedraw=!0);__isdef(a.valuescale)&&(b.nValueScale=__calcNewValue(b.nValueScale,Number(a.valuescale),d),b.fRedraw=!0);__isdef(a.linewidth)&&(b.nLineWidth=__calcNewValue(b.nLineWidth,Number(a.linewidth),d),b.fRedraw=!0);__isdef(a.markersize)&&(b.nMarkerSize=__calcNewValue(b.nMarkerSize,Number(a.markersize),d),b.fRedraw=!0);__isdef(a.gapsize)&&
(b.nGapSize=__calcNewValue(b.nGapSize,Number(a.gapsize),d),b.fRedraw=!0);__isdef(a.linecolor)&&(b.szLineColor=String(a.linecolor),b.fRedraw=!0);__isdef(a.valueupper)&&(b.szValueUpper=a.valueupper,b.nValueUpper=__scanScaleValue(b.szValueUpper),b.fRedraw=!0);__isdef(a.titleupper)&&(b.szTitleUpper=a.titleupper,b.nTitleUpper=__scanScaleValue(b.szTitleUpper),b.fRedraw=!0);__isdef(a.boxupper)&&(b.szBoxUpper=a.boxupper,b.nBoxUpper=__scanScaleValue(b.szBoxUpper),b.fRedraw=!0);__isdef(a.shadowupper)&&(b.szShadowUpper=
a.shadowupper,b.nShadowUpper=__scanScaleValue(b.szShadowUpper),b.fRedraw=!0);__isdef(a.shadowlower)&&(b.szShadowLower=a.shadowlower,b.nShadowLower=__scanScaleValue(b.szShadowLower),b.fRedraw=!0);__isdef(a.declutterupper)&&(b.szDeclutterUpper=a.declutterupper,b.nDeclutterUpper=__scanScaleValue(b.szdeclutterUpper),b.fRedraw=!0);__isdef(a.aggregationupper)&&(b.szAggregationUpper=a.aggregationupper,b.nAggregationUpper=__scanScaleValue(b.szAggregationUpper),b.fRedraw=!0);__isdef(a.aggregationlower)&&(b.szAggregationLower=
a.aggregationlower,b.nAggregationLower=__scanScaleValue(b.szAggregationLower),b.fRedraw=!0);__isdef(a.clipupper)&&(b.szClipUpper=a.clipupper,b.nClipUpper=__scanScaleValue(b.szClipUpper),b.fRedraw=!0);__isdef(a.cliplower)&&(b.szClipLower=a.cliplower,b.nClipLower=__scanScaleValue(b.szClipLower),b.fRedraw=!0);__isdef(a.minvaluesize)&&(b.nValueSizeMin=__calcNewValue(b.nValueSizeMin,Number(a.minvaluesize),d),b.fRedraw=!0);__isdef(a.clipvaluesize)&&(b.nValueSizeMin=__calcNewValue(b.nValueSizeMin,Number(a.clipvaluesize),
d),b.fRedraw=!0);__isdef(a.minsize)&&(b.nChartSizeMin=__calcNewValue(b.nChartSizeMin,Number(a.minsize),d),b.fRedraw=!0);__isdef(a.minchartsize)&&(b.nChartSizeMin=__calcNewValue(b.nChartSizeMin,Number(a.minchartsize),d),b.fRedraw=!0);__isdef(a.maxcharts)&&(b.nMaxCharts=__calcNewValue(b.nMaxCharts,Number(a.maxcharts),d),b.nMaxCharts=Math.max(1,Math.round(b.nMaxCharts)),b.unpaintMap(),b.fRedraw=!0);__isdef(a.sizepow)&&(b.nSizePow=__calcNewValue(b.nSizePow,Number(a.sizepow),d),b.fRedraw=!0);__isdef(a.clipsize)&&
(b.nChartSizeMin=__calcNewValue(b.nChartSizeMin,Number(a.clipsize),d),b.fRedraw=!0);__isdef(a.clipparts)&&(b.nClipParts=Number(a.clipparts),b.fRedraw=!0);__isdef(a.showparts)&&(b.szShowParts=a.showparts,b.szShowPartsA=a.showparts.split(a.showparts.match(/\|/)?"|":","),map.Themes.unmarkClass(null,c),b.fRedraw=!0);__isdef(a.clipframerate)&&(b.nClipFrameRate=__calcNewValue(b.nClipFrameRate||1,Number(a.clipframerate),d),b.nClipTimeout=1/b.nClipFrameRate*1E3,b.fRedraw=!0);__isdef(a.gridx)&&(b.nGridX=Number(a.gridx)||
7,b.fRedraw=!0);__isdef(a.gridwidth)&&(b.szAggregationField=null,"auto"==a.gridwidth?b.nGridWidthPx=b.nGridWidthPx||50:String(a.gridwidth).match(/px/)?b.nGridWidthPx=__calcNewValue(b.nGridWidthPx||1,Number(a.gridwidth),d):"factor"==d?__isdef(b.nGridWidthPx)?b.nGridWidthPx=__calcNewValue(b.nGridWidthPx||1,Number(a.gridwidth),d):b.nGridWidth=__calcNewValue(b.nGridWidth||1E3,Number(a.gridwidth),d):(b.nGridWidthPx=null,b.nGridWidth=__calcNewValue(b.nGridWidth||1,Number(a.gridwidth),d)),b.fRealize=!0,
b.fRedraw=!0,b.fSuppressAggregationScale=!0,b.themeNodesPosA=[],b.unpaintMap());__isdef(a.gridmatrix)&&(b.szAggregationField=null,b.nGridMatrix=__calcNewValue(b.nGridMatrix||1,Number(a.gridmatrix),d),b.fRealize=!0,b.fRedraw=!0,b.fSuppressAggregationScale=!0,b.unpaintMap(),b.themeNodesPosA=[]);__isdef(a.gridwidthpx)&&(b.szAggregationField=null,b.nGridWidthPx=__calcNewValue(b.nGridWidthPx||50,Number(a.gridwidthpx),d),b.fRealize=!0,b.fRedraw=!0,b.fSuppressAggregationScale=!0,b.unpaintMap(),b.themeNodesPosA=
[]);__isdef(a.gridoffsetx)&&(b.nGridOffsetX=__calcNewValue(b.nGridOffsetX||0,Number(a.gridoffsetx),d),b.fRealize=!0,b.fRedraw=!0,b.fSuppressAggregationScale=!0,b.unpaintMap(),b.themeNodesPosA=[]);__isdef(a.gridoffsety)&&(b.nGridOffsetY=__calcNewValue(b.nGridOffsetY||0,Number(a.gridoffsety),d),b.fRealize=!0,b.fRedraw=!0,b.fSuppressAggregationScale=!0,b.unpaintMap(),b.themeNodesPosA=[]);__isdef(a.aggregationfield)&&(b.szAggregationField=a.aggregationfield,b.fRealize=!0,b.fRedraw=!0,b.fSuppressAggregationScale=
!0,b.unpaintMap(),b.themeNodesPosA=[]);__isdef(a.snippet)&&(b.szSnippet=unescape(a.snippet),b.fRealize=!0);__isdef(a.title)&&(b.szTitle=unescape(a.title),b.fRealize=!0);__isdef(a.child)&&(b.fChild=!0)}b.fRedrawInfo=!0;map.Themes.execute()}};Map.Themes.prototype.getThemeLayerList=function(){for(var c=[],a,d=0;d<this.themesA.length;d++)if(this.themesA[d].objThemesA&&!this.themesA[d].fRemove)for(a in this.themesA[d].objThemesA)c[c.length]=a;return c};
Map.Themes.prototype.isThemeLayerUsed=function(c){for(var a=this.getThemeLayerList(),d=0;d<a.length;d++)if(c==a[d])return!0;return!1};Map.Themes.prototype.isNodePartOfAnyTheme=function(c){if(c=map.Layer.getLayerObjOfNode(c))for(var a=map.Themes.getThemeLayerList(),d=0;d<a.length;d++)if(c.szName==a[d])return!0;return!1};Map.Themes.prototype.resetThemeNodesCache=function(){this.themeNodesA=[];this.themeNodes=0};
Map.Themes.prototype.addToThemeNodesCache=function(c){var a=0;c=c.getElementsByTagName("g");for(var d=0;d<c.length;d++){var b=String(map.Tiles.getMasterId(c.item(d).getAttributeNS(null,"id")));b&&(map.Themes.themeNodesA[b]||(map.Themes.themeNodesA[b]=[]),map.Themes.themeNodesA[b].push(c.item(d)),map.Themes.themeNodes++,a++)}};
Map.Themes.prototype.removeFromThemeNodesCache=function(c){var a=0;c=c.getElementsByTagName("g");for(var d=0;d<c.length;d++){var b=String(map.Tiles.getMasterId(c.item(d).getAttributeNS(null,"id")));if(b&&map.Themes.themeNodesA[b]){var f=map.Themes.themeNodesA[b].indexOf(c.item(d));-1<f&&(map.Themes.themeNodesA[b].splice(f,1),a++)}}};Map.Themes.prototype.setActive=function(c){this.activeTheme=c};
Map.Themes.prototype.minimizeInfo=function(c,a){var d=this.getTheme(a);if(d){var b=d.widgetNode.firstChild;if(b){var f=Number(b.getAttributeNS(szMapNs,"titleheight"));0>=f&&(f=420);for(var b=b.childNodes,e=0;e<b.length;e++){var l=b.item(e),k=l.getAttributeNS(null,"id");k.match(/body/)&&l.style.setProperty("display","none","");k.match(/footer/)&&l.style.setProperty("display","none","");k.match(/backgroundrect/)&&(l.setAttributeNS(szMapNs,"maxheight",l.getAttributeNS(null,"height")),l.setAttributeNS(null,
"height",f));k.match(/shadowrect/)&&(l.setAttributeNS(szMapNs,"maxheight",l.getAttributeNS(null,"height")),l.setAttributeNS(null,"height",String(f-100)));k.match(/minimizebutton/)&&l.style.setProperty("display","none","")}d.minimizebutton.nodeObj.style.setProperty("display","none","");d.morebutton.nodeObj.style.setProperty("display","none","");d.addDefinitionToFlag("MINIMIZED")}}};
Map.Themes.prototype.maximizeInfo=function(c,a){var d=this.getTheme(a);if(d){var b=d.widgetNode.firstChild;if(b){for(var b=b.childNodes,f=0;f<b.length;f++){var e=b.item(f),l=e.getAttributeNS(null,"id");l.match(/body/)&&e.style.setProperty("display","inline","");l.match(/footer/)&&e.style.setProperty("display","inline","");l.match(/backgroundrect/)&&e.setAttributeNS(null,"height",e.getAttributeNS(szMapNs,"maxheight"));l.match(/shadowrect/)&&e.setAttributeNS(null,"height",e.getAttributeNS(szMapNs,"maxheight"));
l.match(/minimizebutton/)&&e.style.setProperty("display","inline","")}d.minimizebutton.nodeObj.style.setProperty("display","inline","");d.morebutton.nodeObj.style.setProperty("display","inline","");d.removeDefinitionFromFlag("MINIMIZED")}}};
Map.Themes.prototype.getChartAll=function(c,a,d){for(var b=a.getAttributeNS(null,"id"),f=0,e=0;e<this.themesA.length;e++){var l=map.Dom.newGroup(a,b+":C1");this.getChart(c,l,d,this.themesA[e]);var k=map.Dom.getBox(l);0>k.width&&(k=new box(0,0,0,0));l.fu.setPosition(0,f);f+=k.height+map.Scale.normalY(10);this.themesA[e].szFlag.match(/AGGREGATE/)&&(k=c.split("::")[0]+"::"+this.themesA[e].getNodePosition(c).x+","+this.themesA[e].getNodePosition(c).y,this.getChart(k,l,d,this.themesA[e]),k=map.Dom.getBox(l),
0>k.width&&(k=new box(0,0,0,0)),l.fu.setPosition(0,f),f+=k.height+map.Scale.normalY(10))}};
Map.Themes.prototype.getChart=function(c,a,d,b){b||(b=this.activeTheme);if(!b)return null;c&&":paint"==c.substr(c.length-6,6)&&(c=c.substr(0,c.length-6));if(b.szFlag.match(/CHOROPLETH/)&&b.szFlag.match(/DOMINANT|COMPOSE/)){var f=30;2<b.nOrigSumA.length&&(f=15*b.nOrigSumA.length/Math.log(b.nOrigSumA.length));d=map.Dom.newGroup(a,a.getAttributeNS(null,"id")+":1");if(b.szFlag.match(/PERCENTOFMEAN/)||b.szFlag.match(/PERCENTOFMEDIAN/)||b.szFlag.match(/DEVIATION/)){b.drawChart(d,c,f,"CHART|BAR|VALUES|ZOOM",
c&&b.itemA[c]?b.itemA[c].nDominant:null);var e=map.Dom.getBox(d);0>e.width&&(e=new box(0,0,0,0));d=map.Dom.newGroup(a,a.getAttributeNS(null,"id")+":2");a=b.szUnit;b.szUnit="";b.drawChart(d,c,f,"VALUES|ZOOM");b.szUnit=a;c=map.Dom.getBox(d);a=1<b.nOrigSumA.length?e.width/c.width*1.015:c.width/c.height;d.fu.setPosition(c.x-e.x,e.height+e.y+Math.min(map.Scale.normalY(200),Math.max(map.Scale.normalY(10),-c.y+map.Scale.normalY(6))));d.fu.scale(a,1);b=b.szFlag.match(/PERCENTOFMEDIAN/)?"median":"mean";c=
c.width;map.Dom.newText(d,c,map.Scale.normalY(.9),"font-family:arial;font-size:"+map.Scale.normalY(4)+"px;fill:#808080",map.Dictionary.getLocalText(b));map.Dom.newText(d,c,map.Scale.normalY(5.5),"font-family:arial;font-size:"+map.Scale.normalY(4)+"px;fill:#808080",map.Dictionary.getLocalText("-"));map.Dom.newText(d,c,map.Scale.normalY(-3.7),"font-family:arial;font-size:"+map.Scale.normalY(4)+"px;fill:#808080",map.Dictionary.getLocalText("+"))}else a="CHART|BAR|SPACED|VALUES|ZOOM",b.szFlag.match(/3D/)&&
(a+="|3D"),b.szFlag.match(/\bSORT\b/)&&(a+="|SORT"),b.szFlag.match(/HORZ/)&&(a+="|HORZ|AXIS"),b.drawChart(d,c,f,a,null);return new point(0,map.Scale.normalY(30))}if(b.szFlag.match(/BUFFER/)&&b.szFlag.match(/CHART/))return null;if(b.szFlag.match(/CHOROPLETH/)&&b.itemA[c])return f=b.itemA[c].nValuesA[b.nActualFrame||0],d=__scaleStyleString(map.Scale.tStyle.Summary.szStyle,1),b.szFlag.match(/CATEGORICAL/)&&b.szLabelA&&b.szLabelA.length?f=b.szLabelA[f-1]:(e=10>b.nMax-b.nMin?2:0,f=b.formatValue(f,b.nValueDecimals||
e)+b.szUnit),b.szFlag.match(/CLIP/)&&b.szXaxisA&&map.Dom.newText(a,-40,-280,__scaleStyleString(map.Scale.tStyle.Summary.szStyle,.8)+";font-weight:normal;fill:#888888",b.szXaxisA[b.nActualFrame]),map.Dom.newText(a,-40,0,d+";font-weight:normal;fill:#888888",f),d=__scaleStyleString(map.Scale.tStyle.Summary.szStyle,.8),f=b.itemA[c].szTitle,"undefined"!=typeof f&&"undefined"!=f&&map.Dom.newText(a,-40,280,d+";font-weight:normal;fill:#888888",f),!b.szFlag.match(/CATEGORICAL/)&&(b.szChoroplethInfoStyle.match(/HISTOGRAM/)||
b.szChoroplethInfoStyle.match(/histogram/)||b.szChoroplethInfoStyle.match(/CLASSES/)||b.szChoroplethInfoStyle.match(/classes/))&&(f=b.szChoroplethInfoStyle.match(/HISTOGRAM/)||b.szChoroplethInfoStyle.match(/histogram/),d=map.Dom.newGroup(a,a.getAttributeNS(null,"id")+":histogram"),this.getHistogram(c,d,f?"DISTRIBUTION":"CLASSES",b),d.fu.setPosition(0,map.Scale.normalY(4))),new point(0,0);if(b.szFlag.match(/INFOSIZE/))return b.drawChart(a,c,30,d);f=30;b.szFlag.match(/SEQUENCE/)&&(f=25);b.szFlag.match(/BAR/)&&
(b.szFlag.match(/STACKED/)?f=300:2>=b.nOrigSumA.length?f=30:(b.szFlag.match(/\bUP\b/)||b.szFlag.match(/CENTER/)||b.szFlag.match(/SEQUENCE/),f=15*b.nOrigSumA.length/Math.log(b.nOrigSumA.length)));return b.drawChart(a,c,f,d)};
Map.Themes.prototype.getSummary=function(c,a){a||(a=this.activeTheme);if(!a||!c)return null;if(!a.itemA[c]){var d=c.split("::");1<d.length&&(c=d[0]+"::"+String(d[1]).toUpperCase())}if(!a.itemA[c])return null;for(var d=a.itemA[c].nOrigValuesA,b=0,f=0;f<d.length;f++)isNaN(d[f])&&(d[f]=0),b+=d[f];a.szFlag.match(/DIFFERENCE/)&&(b=d[d.length-1]);if(a.itemA[c].nValue100){a.szUnits100=a.szUnits100||"";if(a.szFlag.match(/RELATIVE/)||a.szFlag.match(/DIFFERENCE/))return map.Dictionary.getLocalText("Relative to")+
": "+String(a.formatValue(a.itemA[c].nValue100,a.nValueDecimals||0))+" "+(a.szUnits100||"");if(a.itemA[c].nSize){if(a.szAggregation.match(/sum/))return map.Dictionary.getLocalText("Counted")+": "+String(a.formatValue(a.itemA[c].nSize,a.nValueDecimals||0))+" "+(a.szUnits100||"")}else if(b!=a.itemA[c].nValue100)return String(__formatValue(b,2))+" / "+String(a.formatValue(a.itemA[c].nValue100,a.nValueDecimals||0))+" "+(a.szUnits100||"")}else if(a.itemA[c].nSize){if(a.szFlag.match(/CATEGORICAL/)&&1==
a.itemA[c].nValuesA.length&&a.szValueField)return a.szLabelA[a.itemA[c].nValuesA[0]-1]}else{if(a.itemA[c].nAlpha)return map.Dictionary.getLocalText("Alpha value")+": "+String(a.formatValue(a.itemA[c].nAlpha,a.nValueDecimals||0))+" "+(a.szAlphaValueUnits||"");!a.szFlag.match(/SUM/)||a.szFlag.match(/SEQUENCE/)||a.szFlag.match(/\bCLIP\b/)}return null};
Map.Themes.prototype.getValueComment=function(c,a){a||(a=this.activeTheme);if(!a||!c)return null;if(!a.itemA[c]){var d=c.split("::");1<d.length&&(c=d[0]+"::"+String(d[1]).toUpperCase())}if(!a.itemA[c])return null;for(var d=a.itemA[c].nOrigValuesA,b=0;b<d.length;b++)isNaN(d[b])&&(d[b]=0);a.szFlag.match(/DIFFERENCE/);return a.szFlag.match(/OFFSETMEAN/)?map.Dictionary.getLocalText("value")+": "+String(__formatValue(a.itemA[c].nValuesA[0],2))+" "+map.Dictionary.getLocalText("mean")+": "+String(__formatValue(a.nMeanA[0],
2)):null};Map.Themes.prototype.getTitle=function(c,a){a||(a=this.activeTheme);if(!a||!c)return null;c=String(map.Tiles.getMasterId(c));if(!a.itemA[c]){var d=c.split("::");1<d.length&&(c=d[0]+"::"+String(d[1]).toUpperCase())}return a.itemA[c]?a.itemA[c].szTitle||null:null};Map.Themes.prototype.getLabel=function(c,a){a||(a=this.activeTheme);if(!a||!c)return null;if(!a.itemA[c]){var d=c.split("::");1<d.length&&(c=d[0]+"::"+String(d[1]).toUpperCase())}return a.itemA[c]?a.itemA[c].szLabel||null:null};
Map.Themes.prototype.getTextObjects=function(){for(var c=[],a=0;a<this.themesA.length;a++)if(this.themesA[a].szFlag.match(/TEXTONLY/)&&this.themesA[a].chartGroup)if("undefined"!=typeof this.themesA[a].markedClass&&null!=this.themesA[a].markedClass)for(var d=this.themesA[a].markedClass,b=this.themesA[a].chartGroup.getElementsByTagName("text"),f=0;f<b.length;f++)0<b.item(f).firstChild.nodeValue.length&&Number(b.item(f).getAttributeNS(szMapNs,"class"))==d&&c.push(b.item(f));else for(b=this.themesA[a].chartGroup.getElementsByTagName("text"),
f=0;f<b.length;f++)0<b.item(f).firstChild.nodeValue.length&&c.push(b.item(f));return c};Map.Themes.prototype.getMaxValue=function(c,a){a||(a=this.activeTheme);if(!a||!c)return null;for(var d=0,b=a.itemA[c].nValuesA,f=0;f<b.length;f++)isNaN(b[f])&&(b[f]=0),d=Math.max(d,b[f]);return d};
Map.Themes.prototype.getDataRow=function(c,a){a||(a=this.activeTheme);if(!a||!c)return null;if(!a.itemA[c]){var d=c.split("::");d&&1<d.length&&(c=d[0]+"::"+String(d[1]).toUpperCase())}if(!a.itemA[c])return null;var d=a.objThemesA[a.szThemesA[0]],b=[];if(a.szDataFieldsA)for(var f=0;f<a.szDataFieldsA.length;f++)for(var e=0;e<d.dbFields.length;e++)a.szDataFieldsA[f]==d.dbFields[e].id&&b.push(e);else for(e=0;e<d.dbFields.length;e++)b.push(e);var l=[];if(d.dbRecords){if("undefined"!=typeof a.itemA[c].dbIndexA&&
a.itemA[c].dbIndexA.length){for(var k in a.itemA[c].dbIndexA)for(0<k&&l.push("--------------------"),e=0;e<b.length;e++)l.push(d.dbFields[b[e]].id);for(k in a.itemA[c].dbIndexA)for(0<k&&l.push("--------------------"),f=a.itemA[c].dbIndexA[k],e=0;e<b.length;e++)l.push(d.dbRecords[f][b[e]]);return l}if("undefined"!=typeof a.itemA[c].dbIndex){f=a.itemA[c].dbIndex;for(e=0;e<b.length;e++)l.push(d.dbFields[b[e]].id);for(e=0;e<b.length;e++)l.push(d.dbRecords[f][b[e]]);return l}c=c.split("::")[1];for(f=0;f<
d.dbRecords.length;f++)if(d.dbRecords[f]&&d.dbRecords[f][d.nFieldSelectionIndex]&&String(d.dbRecords[f][d.nFieldSelectionIndex]).toUpperCase()==String(c).toUpperCase()){for(e=0;e<d.dbFields.length;e++)l.push(d.dbFields[e].id);for(e=0;e<d.dbFields.length;e++)l.push(d.dbRecords[f][e]);break}}return l};
Map.Themes.prototype.getFieldIndexArray=function(c){c||(c=this.activeTheme);if(!c||c.szDataFieldsA)return[];c.fieldIndexArray=[];for(var a=0;a<c.objThemesA[c.szThemesA[0]].nFieldIndexA.length;a++)c.fieldIndexArray.push(c.objThemesA[c.szThemesA[0]].nFieldIndexA[a]);0<=c.objThemesA[c.szThemesA[0]].nField100Index&&c.fieldIndexArray.push(c.objThemesA[c.szThemesA[0]].nField100Index);return c.fieldIndexArray};
Map.Themes.prototype.getScatterArray=function(c,a,d){c||(c=this.activeTheme);var b=0,f=c.nMin,e=c.nMax,l=0,k;d.match(/LOG/)?(l=1-f,f=Math.log(f+l),e=Math.log(e+l)):d.match(/POW2/)&&(l=1-f,f=Math.pow(f+l,.5),e=Math.pow(e+l,.5));d.match(/POW3/)&&(l=1-f,f=Math.pow(f+l,1/3),e=Math.pow(e+l,1/3));for(var e=(e-f)/a,n=[],h=0;h<a+1;h++)n[h]=0;for(k in c.itemA)h=c.itemA[k].nValuesA[0],"number"==typeof h&&(d.match(/LOG/)?h=Math.log(h+l):d.match(/POW2/)?h=Math.pow(h+l,.5):d.match(/POW3/)&&(h=Math.pow(h+l,1/3)),
h=Math.max(0,Math.min(a-1,Math.floor((h-f)/e))),n[h]++,b=Math.max(b,n[h]));return n};Map.Themes.prototype.getResolutionQualityOfArray=function(c){for(var a=c.length,d=-1E6,b=0;b<a;b++)d=Math.max(d,c[b]);for(var f=0,b=0;b<a;b++)c[b]>d/10&&f++;return f/a*100};Map.Themes.prototype.getDeviationOfArray=function(c){for(var a=c.length,d=-1E6,b=0,f=0,e=0,e=0;e<a;e++)d=Math.max(d,c[e]),b+=c[e];b/=a;for(e=0;e<a;e++)f+=(c[e]-b)*(c[e]-b);return e=Math.sqrt(f/a)};
Map.Themes.prototype.getHistogram=function(c,a,d,b){if(!a)return null;b||(b=this.activeTheme);if(!b||b.nMin==b.nMax)return null;if(c){if(!b.itemA[c]){var f=c.split("::");1<f.length&&(c=f[0]+"::"+String(f[1]).toUpperCase())}if(!b.itemA[c])return null}this.histGroup=map.Dom.newGroup(a,a.getAttributeNS(null,"id")+":group");this.histFlag=d;this.histTheme=b;a=map.Scale.normalX(70);d=map.Scale.normalY(20);map.Dom.newShape("rect",this.histGroup,0,0,a-map.Scale.normalX(.5),d,"fill:none;stroke:none;");c?setTimeout(function(){map.Themes.makeHistogram(c)},
100):setTimeout(function(){map.Themes.makeHistogram()},100)};
Map.Themes.prototype.makeHistogram=function(c){var a=this.histGroup,d=this.histFlag,b=this.histTheme;if(d.match("CLASSES")){for(var f=map.Scale.normalX(50),e=map.Scale.normalY(5),l=f/b.colorScheme.length,k=0,n=0,h=c?b.itemA[c].nValuesA[0]:0,p=0,g=0;g<b.partsA.length;g++){var l=f/b.nCount*b.partsA[g].nCount,u=map.Dom.newShape("rect",a,k,n,l,e,"fill:"+b.colorScheme[g]+";stroke:black;stroke-width:1;");u&&u.setAttributeNS(szMapNs,"tooltip",b.szLegendLabelA[g]+" ("+b.formatValue(b.partsA[g].nCount)+" "+
map.Dictionary.getLocalText("members")+")");k+=l;h>b.partsA[g].max?p+=l:h>b.partsA[g].min&&(p+=l/(b.partsA[g].max-b.partsA[g].min)*(h-b.partsA[g].min))}map.Dom.newShape("circle",a,p,-map.Scale.normalX(.1),map.Scale.normalX(1),"fill:#444444;stroke:none;")}else if(d.match("DISTRIBUTION")){if(!isFinite(b.nMin)||!isFinite(b.nMax))return a;p=Math.min(140,Math.max(20,b.nCount/5));p=Math.min(500,Math.max(20,b.nCount/5));f=map.Scale.normalX(70);e=map.Scale.normalY(12);d.match("INTERACTIVE")&&(e=map.Scale.normalY(20));
var r=f/p,h=c?b.itemA[c].nValuesA[0]:0,q=0,t=b.nMin,x=b.nMax,E=0,B=this.getScatterArray(b,p,""),g=this.getDeviationOfArray(B),k=this.getScatterArray(b,p,"LOG"),n=this.getDeviationOfArray(k),m=!1,y=(x-t)/p;n&&n<g&&(B=k,E=1-t,t=Math.log(t+E),x=Math.log(x+E),h=Math.log(h+E),y=(x-t)/p,m=!0);for(g=0;g<p;g++)q=Math.max(q,B[g]);k=-20;n=0;b.histogram=new Map.Histogram(b);b.histogram.fDoLog=m;b.histogram.dValue=E;b.histogram.nWidth=f;b.histogram.nMin=t;b.histogram.nMax=x;for(var A=__scaleStyleString(map.Scale.tStyle.Summary.szStyle,
.4),z=0,g=0;g<b.partsA.length;g++){l=(m?f/(x-t)*(Math.min(x,Math.log(b.partsA[g].max+E))-t):f/(x-t)*(Math.min(x,b.partsA[g].max)-t))-k;if(u=map.Dom.newShape("rect",a,k,n,l,e,"fill:"+b.colorScheme[g]+";stroke:black;stroke-width:"+map.Scale.normalX(.2)+";stroke-opacity:0.1"))u.setAttributeNS(szMapNs,"tooltip",b.szLegendLabelA[g]+" ("+b.formatValue(b.partsA[g].nCount)+" "+map.Dictionary.getLocalText("members")+")"),u.setAttributeNS(szMapNs,"onoverstyle","fill:"+b.colorScheme[g]+";stroke:black;stroke-width:"+
map.Scale.normalX(.5)+";"),u.setAttributeNS(null,"onmouseover","map.Themes.markClass(evt,'"+b.szId+"','"+g+"','1')"),u.setAttributeNS(null,"onmouseout","map.Themes.unmarkClass(evt,'"+b.szId+"')");b.histogram.classRectA[g]=u;b.histogram.classRectXA[g]=k;b.histogram.classRectWidthA[g]=l;b.histogram.classRectMaxA[g]=b.partsA[g].max;if(d.match("INTERACTIVE")){var u=map.Dom.newGroup(a,""),v=null;if(0<g){map.Dom.newShape("line",u,k,n-map.Scale.normalY(2),k,n+e,"stroke:black;stroke-width:"+map.Scale.normalX(.5)+
";stroke-opacity:0.5");if(v=map.Dom.newShape("rect",u,k-map.Scale.normalY(1.5),n-map.Scale.normalY(6),map.Scale.normalX(3),map.Scale.normalY(5),"fill:"+b.colorScheme[g]+";stroke:black;styroke-width(1);"))v.setAttributeNS(null,"rx",map.Scale.normalX(2)),v.setAttributeNS(null,"ry",map.Scale.normalY(1.5));v=map.Dom.newText(u,k,n-map.Scale.normalY(7),A+"display:none;font-weight:normal;text-anchor:middle",b.formatValue(b.partsA[g-1].max,1))}z=new Slider(u,new box(-z,0,z+l,0));z.setId(String(g));z.parent=
b.histogram;z.textObj=v;z=l}k+=l}k=r/3;n=0;l=.9;g=this.getResolutionQualityOfArray(B);10>g&&(l=10-g);for(g=0;g<p;g++){x=B[g]/q*e*l;z=m?Math.exp(t+g*y)-E:t+g*y;u=m?Math.exp(t+(g+1)*y)-E:t+(g+1)*y;A="black";x=x&&!isNaN(x)?Math.min(e,Math.max(map.Scale.normalY(.5),x)):0;if(A=map.Dom.newShape("line",a,k,n+e,k,n+e-x,"stroke:"+A+";stroke-width:"+r+";"))A.setAttributeNS(szMapNs,"tooltip",b.formatValue(z,2)+" ... "+b.formatValue(u,2)+b.szUnit+" ("+B[g]+" members)"),A.setAttributeNS(szMapNs,"onoverstyle",
"stroke:yellow;stroke-width:"+Math.max(map.Scale.normalX(1),r)+";");k+=r}map.Dom.newShape("line",a,-map.Scale.normalX(.5),e+1,f-map.Scale.normalX(.5),e+1,"stroke:black;stroke-width:"+map.Scale.normalX(.1)+";");p=-map.Scale.normalX(.5);f-=map.Scale.normalX(.5);k=map.Scale.normalX(2);map.Dom.newShape("line",a,p,e,p,e+k,"stroke:black;stroke-width:"+map.Scale.normalX(.2)+";");map.Dom.newShape("line",a,f,e,f,e+k,"stroke:black;stroke-width:"+map.Scale.normalX(.2)+";");l=__scaleStyleString(map.Scale.tStyle.Summary.szStyle,
.4);n=.4*map.Scale.tStyle.Summary.nFontHeight;B=e+k+.8*n;g=b.formatValue(b.nMin,0);q=b.formatValue(b.nMax,0);map.Dom.newText(a,p-10,B,l+";font-weight:normal;text-anchor:start",g);0>b.nMin&&0<b.nMax&&(p=(0-t)/y*r,map.Dom.newShape("line",a,p,e,p,e+k,"stroke:black;stroke-width:"+map.Scale.normalX(.2)+";"),map.Dom.newText(a,p,B,l+";font-weight:normal;text-anchor:start","0"));x=0;for(g=10;g<b.nMax;g*=10)for(A=1;9>A&&!(g*A>b.nMax||g*A<b.nMin);A++)p=((m?Math.log(g*A+E):g*A)-t)/y*r,z=b.formatValue(g*A,0),
p>x+z.length*n*3/8?(map.Dom.newShape("line",a,p,e,p,e+k,"stroke:black;stroke-width:"+map.Scale.normalX(.2)+";"),map.Dom.newText(a,p,B,l+";font-weight:normal;text-anchor:middle",z),x=p+z.length*n*3/8):map.Dom.newShape("line",a,p,e,p,e+k/2,"stroke:black;stroke-width:"+map.Scale.normalX(.2)+";");f>x+q.length*n*3/8&&map.Dom.newText(a,f,B,l+";font-weight:normal;text-anchor:middle;",q);c&&!d.match("INTERACTIVE")&&(p=(h-t)/y*r,map.Dom.newShape("circle",a,p,-map.Scale.normalX(.1),map.Scale.normalX(1),"fill:#dd0000;stroke:none;"),
map.Dom.newShape("line",a,-10,-5,p-10,-5,"stroke:#000000;stroke-width:"+map.Scale.normalX(.5)+";stroke-opacity:0.3"))}else{f=map.Scale.normalX(70);e=map.Scale.normalY(12);l=f/700;n=k=0;x=b.nMax;c=e/x;r=Math.max(1,Math.ceil(b.nCount/700));d=[];t=0;E=[];for(h in b.itemA)E.push(b.itemA[h].nValuesA[0]);E.sort(b.sortUp);for(h in E)t%r?d[d.length-1]+=E[h]/r:d[d.length]=E[h]/r,t++;d.sort(b.sortUp);for(g=0;g<d.length;g++){h=d[g];x=d[g]*c*.9;A="black";for(r=0;r<b.partsA.length;r++)if(d[g]<b.partsA[r].max){A=
b.colorScheme[r];break}A=map.Dom.newShape("line",a,k,n,k,e,"stroke:"+A+";stroke-width:"+l+";");A.setAttributeNS(szMapNs,"tooltip",b.formatValue(h,2)+b.szUnit);isNaN(x)&&(x=0);A=map.Dom.newShape("line",a,k,n+e,k,n+e-x,"stroke:#000000;stroke-width:"+l+";");A.setAttributeNS(szMapNs,"tooltip",b.formatValue(h,2)+b.szUnit);k+=l}g=b.formatValue(b.nMin,0);q=b.formatValue(b.nMax,0);l=__scaleStyleString(map.Scale.tStyle.Summary.szStyle,.4);map.Dom.newText(a,k+map.Scale.normalX(1),n+e,l+";font-weight:normal;text-anchor:start;stroke-opacity:0.8;",
g);map.Dom.newText(a,k+map.Scale.normalX(1),n+map.Scale.normalY(3.5),l+";font-weight:normal;text-anchor:start;stroke-opacity:0.8;",q);a&&a.fu.scale(f/k,1)}return a};Map.Histogram=function(c){this.mapTheme=c;this.fDoLog=!1;this.dValue=0;this.classRectA=[];this.classRectXA=[];this.classRectWidthA=[];this.classRectMaxA=[]};Map.Histogram.prototype=new Map;Map.Histogram.prototype.onMouseOver=function(c,a,d){d.textObj&&d.textObj.style.setProperty("display","inline","")};
Map.Histogram.prototype.onMouseOut=function(c,a,d){d.textObj&&d.textObj.style.setProperty("display","none","")};
Map.Histogram.prototype.onMouseMove=function(c,a,d){if(c=this.classRectA[Number(a)])c.setAttributeNS(null,"x",this.classRectXA[Number(a)]+d.value.x),c.setAttributeNS(null,"width",this.classRectWidthA[Number(a)]-d.value.x);if(c=this.classRectA[Number(a)-1]){c.setAttributeNS(null,"width",this.classRectWidthA[Number(a)-1]+d.value.x);var b=this.nMin+(this.nMax-this.nMin)/this.nWidth*(this.classRectXA[Number(a)]+d.value.x),b=this.fDoLog?Math.exp(b)-this.dValue:b;this.classRectMaxA[Number(a)-1]=b}d.textObj&&
(d.textObj.firstChild.nodeValue=__formatValue(b,1))};Map.Histogram.prototype.onMouseUp=function(c,a,d){(d=this.classRectA[Number(a)-1])&&(this.classRectWidthA[Number(a)-1]=d.getAttributeNS(null,"width"));a="ranges:"+String(this.nMin);for(d=0;d<this.classRectMaxA.length;d++)a+=","+String(this.classRectMaxA[d]);map.Themes.changeThemeStyle(c,this.mapTheme.szId,a)};Map.Themes.prototype.showErrorInfo=function(c,a){var d=this.getTheme(a);d&&d.showErrorInfo()};
Map.Themes.prototype.actualizeActiveTheme=function(c){for(var a=0;a<this.themesA.length;a++)if(this.themesA[a].fDone)if(this.themesA[a].szFlag.match(/CHART/))if(this.themesA[a].__fClipToGeoBounds&&(this.themesA[a].fRealize=!0,this.themesA[a].fRedraw=!1),c&&1!=c&&this.themesA[a].szFlag.match(/DYNAMICSCALE/)&&(this.themesA[a].nScale*=Math.sqrt(c),this.themesA[a].fRealize=!0,this.themesA[a].fRedraw=!1,this.themesA[a].unpaintMap()),c&&1!=c&&this.themesA[a].szFlag.match(/BEZIER/)&&(this.themesA[a].fRedraw=
!0),this.themesA[a].szFlag.match(/DECLUTTER/)&&(this.themesA[a].fDeclutter=!0,map.Themes.execute()),c&&(1!=c||this.themesA[a].szFlag.match(/FIXGRID/))&&(this.themesA[a].nChartSizeMin||this.themesA[a].nValueSizeMin||this.themesA[a].szAggregationFieldA||this.themesA[a].nGridWidth||this.themesA[a].nGridMatrix||this.themesA[a].nGridWidthPx||this.themesA[a].nChartUpper||this.themesA[a].nChartLower||this.themesA[a].nValueUpper||this.themesA[a].nBoxUpper||this.themesA[a].nTitleUpper||this.themesA[a].nLabelUpper))if(this.themesA[a].fRealizeDone&&
(this.themesA[a].szFlag.match(/AUTOGRID/)||this.themesA[a].nGridWidthPx||this.themesA[a].szAggregationFieldA)||this.themesA[a].nMaxCharts){if(this.themesA[a].szAggregationFieldA){for(var d=this.themesA[a].nGridWidth,b=this.themesA[a].szAggregationField,f=0;f<this.themesA[a].szAggregationFieldA.length;f++){var e=Number(this.themesA[a].szAggregationFieldA[f].split(":")[1]);e&&map.Scale.nTrueMapScale*map.Scale.nZoomScale>e&&(isNaN(parseFloat(this.themesA[a].szAggregationFieldA[f+1]))?this.themesA[a].szAggregationField=
this.themesA[a].szAggregationFieldA[f+1]:(this.themesA[a].szAggregationFieldA[f+1].match(/px/)?this.themesA[a].nGridWidthPx=parseFloat(this.themesA[a].szAggregationFieldA[f+1]):(this.themesA[a].nGridWidth=parseFloat(this.themesA[a].szAggregationFieldA[f+1]),this.themesA[a].nGridWidthPx=0),this.themesA[a].szAggregationField=null));f++}this.themesA[a].szAggregationField!=b||this.themesA[a].nGridWidth!=d?(this.themesA[a].fRealize=!0,this.themesA[a].fRedraw=!1,this.themesA[a].unpaintMap(),this.themesA[a].themeNodesPosA=
[]):this.themesA[a].fRedraw=!0}this.themesA[a].nGridWidthPx?(d=map.Scale.getDistanceInMeter(1E3,1E3,1E3+map.Scale.normalX(this.themesA[a].nGridWidthPx),1E3),this.themesA[a].nGridWidth=d/map.Scale.nZoomScale,this.themesA[a].fRealize=!0,this.themesA[a].fRedraw=!1,this.themesA[a].unpaintMap(),this.themesA[a].themeNodesPosA=[]):this.themesA[a].nGridMatrix?(d=map.Zoom.getBox(),d=map.Scale.getDistanceInMeter(1E3,1E3,1E3+d.width,1E3),this.themesA[a].nGridWidth=d/(this.themesA[a].nGridMatrix||20)/map.Scale.nZoomScale,
this.themesA[a].fRealize=!0,this.themesA[a].fRedraw=!1,this.themesA[a].unpaintMap(),this.themesA[a].themeNodesPosA=[]):this.themesA[a].nGridWidth&&(this.themesA[a].fActualize=!0)}else this.themesA[a].nMaxCharts&&this.themesA[a].unpaintMap(),this.themesA[a].fRealizeDone&&1>c&&(this.themesA[a].nChartSizeMin||this.themesA[a].nValueSizeMin)&&this.themesA[a].unpaintMap(),this.themesA[a].fRedraw=!0;else this.themesA[a].nMaxCharts&&1!=c&&this.themesA[a].unpaintMap(),this.themesA[a].fActualize=!0;else this.themesA[a].isChecked&&
!this.themesA[a].fMarkClass&&(this.themesA[a].fRedraw=!0);executeWithMessage("map.Themes.execute()","...",100);return null};Map.Themes.prototype.resortCharts=function(c){var a=!1;if(this.themesA.length){for(var d=0;d<this.themesA.length;d++)this.themesA[d].fDone&&(a=this.themesA[d].fResort=!0);a&&map.Themes.execute()}c&&(c.stopPropagation(),c.preventDefault())};Map.Themes.prototype.clear=function(){this.themesA.length=0};
function ObjTheme(c,a,d,b,f){this.szName=c;this.coTable=d;this.szSelectionField=b;this.szItemField=f;this.nIndex=a;this.nFieldIndexA=[];this.nFieldSelectionIndex=this.nField100Index=-1;this.nFieldSelectionIndexA=[];this.nLabelFieldIndex=this.nValueFieldIndex=this.nFieldItemIndex=-1;this.leadOffset=!1}
ObjTheme.prototype.getFields=function(){this.szFields=this.theme.szFields;this.szFieldsA=this.theme.szFields.split("|");for(var c in this.szFieldsA)this.szFieldsA[c]=this.szFieldsA[c].trim();this.szField100=this.theme.szField100;this.szColorField=this.theme.szColorField;this.szSymbolField=this.theme.szSymbolField;this.szValueField=this.theme.szValueField;this.szLabelField=this.theme.szLabelField;this.szTitleField=this.theme.szTitleField;this.szSnippetField=this.theme.szSnippetField;this.szSizeField=
this.theme.szSizeField;this.szAlphaField=this.theme.szAlphaField;this.szAlphaField100=this.theme.szAlphaField100;this.szXField=this.theme.szXField;this.szYField=this.theme.szYField;this.szTimeField=this.theme.szTimeField;this.szFilterField=this.theme.szFilterField;this.szAggregationField=this.theme.szAggregationField;this.szSelectionFieldsA=(this.theme.szSelectionField||"").split("|");this.nFieldIndexA[0]=-1;this.nFieldSelectionIndexA[0]=-1;this.theme.szSelectionField2&&(this.szSelectionField2=this.theme.szSelectionField2||
null,this.szSelectionFields2A=(this.theme.szSelectionField2||"").split("|"),this.nFieldSelection2IndexA=[-1]);var a;a=this.coTable?this.coTable:this.szName;if(!this.szFields||""===this.szFields)return!0;try{eval("this.dbTable = "+a+".table")}catch(d){try{eval("this.dbTable = "+a+"_table")}catch(b){}}if(this.coTable&&!this.dbTable)return displayMessage("Data not loaded!",1E3,!0),!1;if(this.dbTable){try{eval("this.dbFields = "+a+".fields")}catch(f){try{eval("this.dbFields = "+a+"_fields")}catch(e){}}try{this.szSelectionField||
(this.szSelectionField=map.Layer.getLayerObj(this.szName).szSelection)}catch(l){return alert("no selection field found !!"),!1}for(c=0;c<this.dbTable.fields;c++)if(!this.dbFields||0===this.dbFields.length||!this.dbFields[c])return alert("ERROR: theme '"+this.szName+"' - table '"+a+"' - object 'fields' incorrect !"),!1;if("$table$"==this.szFields){this.szFieldsA=[];for(c=0;c<this.dbFields.length;c++)this.dbFields[c].id!=this.szSelectionField&&"Total"!=this.dbFields[c].id&&this.szFieldsA.push(this.dbFields[c].id);
this.theme.szFields=this.szFieldsA.join("|");this.theme.szFieldsA=this.szFieldsA;this.theme.szLabelA=this.szFieldsA}for(c=0;c<this.dbFields.length;c++){"undefined"!=typeof this.szItemField&&String(this.dbFields[c].id).toLowerCase()==String(this.szItemField).toLowerCase()&&(this.nFieldItemIndex=c);"undefined"!=typeof this.szSelectionField&&String(this.dbFields[c].id).toLowerCase()==String(this.szSelectionField).toLowerCase()&&(this.nFieldSelectionIndex=c);if("undefined"!=typeof this.szSelectionField2)for(String(this.dbFields[c].id).toLowerCase()==
String(this.szSelectionField2).toLowerCase()&&(this.nFieldSelection2Index=c),a=0;a<this.szSelectionFields2A.length;a++)this.dbFields[c].id==this.szSelectionFields2A[a]&&(this.nFieldSelection2IndexA[a]=c);for(a=0;a<this.szSelectionFieldsA.length;a++)this.dbFields[c].id==this.szSelectionFieldsA[a]&&(this.nFieldSelectionIndexA[a]=c);for(a=0;a<this.szFieldsA.length;a++)"!"==this.szFieldsA[a].substr(0,1)?this.dbFields[c].id==this.szFieldsA[a].substr(1,this.szFieldsA[a].length-1)&&(this.nFieldIndexA[a]=
c):this.dbFields[c].id==this.szFieldsA[a]&&(this.nFieldIndexA[a]=c);this.szField100&&this.dbFields[c].id==this.szField100&&(this.nField100Index=c);this.szColorField&&this.dbFields[c].id==this.szColorField&&(this.nColorFieldIndex=c);this.szSymbolField&&this.dbFields[c].id==this.szSymbolField&&(this.nSymbolFieldIndex=c);this.szValueField&&this.dbFields[c].id==this.szValueField&&(this.nValueFieldIndex=c);this.szLabelField&&this.dbFields[c].id==this.szLabelField&&(this.nLabelFieldIndex=c);this.szTitleField&&
this.dbFields[c].id==this.szTitleField&&(this.nTitleFieldIndex=c);this.szSnippetField&&this.dbFields[c].id==this.szSnippetField&&(this.nSnippetFieldIndex=c);this.szSizeField&&this.dbFields[c].id==this.szSizeField&&(this.nSizeFieldIndex=c);this.szTimeField&&this.dbFields[c].id==this.szTimeField&&(this.nTimeFieldIndex=c);this.szXField&&this.dbFields[c].id==this.szXField&&(this.nXFieldIndex=c);this.szYField&&this.dbFields[c].id==this.szYField&&(this.nYFieldIndex=c);this.szAlphaField&&this.dbFields[c].id==
this.szAlphaField&&(this.nAlphaFieldIndex=c);this.szAlphaField100&&this.dbFields[c].id==this.szAlphaField100&&(this.nAlphaField100Index=c);this.szFilterField&&this.dbFields[c].id==this.szFilterField&&(this.nFilterFieldIndex=c);this.szAggregationField&&this.dbFields[c].id==this.szAggregationField&&(this.nAggregationFieldIndex=c)}-1==this.nFieldSelectionIndex&&-1==this.nFieldSelectionIndexA[0]&&(this.szSelectionField&&this.szSelectionField.length?alert("ERROR on load theme data: selection field '"+
this.szSelectionField+"' not found !"):alert("ERROR on load theme data: selection not defined !"));for(a=0;a<this.szFieldsA.length;a++)if("undefined"==typeof this.nFieldIndexA[a])return alert("ERROR on load theme data: value field '"+this.szFieldsA[a]+"' not found !"),!1;this.szField100&&!this.szField100.match(/\$/)&&"undefined"==typeof this.nField100Index&&alert("ERROR on load theme data: 100field: '"+this.szField100+"' not found !");this.szColorField&&!this.szColorField.match(/\$/)&&"undefined"==
typeof this.nColorFieldIndex&&alert("ERROR on load theme data: colorfield: '"+this.szColorField+"' not found !");this.szSymbolField&&!this.szSymbolField.match(/\$/)&&"undefined"==typeof this.nSymbolFieldIndex&&alert("ERROR on load theme data: symbolfield: '"+this.szSymbolField+"' not found !");this.szValueField&&!this.szValueField.match(/\$/)&&"undefined"==typeof this.nValueFieldIndex&&alert("ERROR on load theme data: valuefield: '"+this.szValueField+"' not found !");this.szLabelField&&!this.szLabelField.match(/\$/)&&
"undefined"==typeof this.nLabelFieldIndex&&alert("ERROR on load theme data: labelfield: '"+this.szLabelField+"' not found !");this.szTitleField&&!this.szTitleField.match(/\$/)&&"undefined"==typeof this.nTitleFieldIndex&&alert("ERROR on load theme data: titlefield: '"+this.szTitleField+"' not found !");this.szSnippetField&&!this.szSnippetField.match(/\$/)&&"undefined"==typeof this.nSnippetFieldIndex&&alert("ERROR on load theme data: snippetfield: '"+this.szSnippetField+"' not found !");this.szSizeField&&
!this.szSizeField.match(/\$/)&&"undefined"==typeof this.nSizeFieldIndex&&alert("ERROR on load theme data: sizefield: '"+this.szSizeField+"' not found !");this.szTimeField&&!this.szTimeField.match(/\$/)&&"undefined"==typeof this.nTimeFieldIndex&&alert("ERROR on load theme data: timefield: '"+this.szTimeField+"' not found !");this.szXField&&!this.szXField.match(/\$/)&&"undefined"==typeof this.nXFieldIndex&&alert("ERROR on load theme data: xfield: '"+this.szXField+"' not found !");this.szYField&&!this.szYField.match(/\$/)&&
"undefined"==typeof this.nYFieldIndex&&alert("ERROR on load theme data: yfield: '"+this.szYField+"' not found !");this.szAlphaField&&!this.szAlphaField.match(/\$/)&&"undefined"==typeof this.nAlphaFieldIndex&&alert("ERROR on load theme data: alphafield: '"+this.szAlphaField+"' not found !");this.szAlphaField100&&!this.szAlphaField100.match(/\$/)&&"undefined"==typeof this.nAlphaField100Index&&alert("ERROR on load theme data: alpha100field: '"+this.szAlphaField100+"' not found !");this.szFilterField&&
!this.szFilterField.match(/\$/)&&"undefined"==typeof this.nFilterFieldIndex&&alert("ERROR on load theme data: filterfield: '"+this.szFilterField+"' not found !");this.szAggregationField&&!this.szAggregationField.match(/\$/)&&"undefined"==typeof this.nAggregationFieldIndex&&alert("ERROR on load theme data: aggregationfield: '"+this.szAggregationField+"' not found !");!this.szItemField||this.szItemField==this.szSelectionField||this.szItemField.match(/\$/)||"undefined"!=typeof this.nFieldItemIndex&&
-1!=this.nFieldItemIndex||alert("ERROR on load theme data: itemfield: '"+this.szItemField+"' not found !")}else{c=SVGDocument.getElementById(this.szName);null==c&&(a=map.Tiles.getTileNodes(this.szName))&&(c=a[0]);if(!c)return this.szName="",!1;c=c.getAttributeNS(szMapNs,"info");if(null==c||""===c)return this.szName="",!1;var k=c.split("|");for(c=0;c<k.length;c++){for(a=0;a<this.szFieldsA.length;a++)"!"==this.szFieldsA[a].substr(0,1)?k[c]==this.szFieldsA[a].substr(1,this.szFieldsA[a].length-1)&&(this.nFieldIndexA[a]=
c):k[c]==this.szFieldsA[a]&&(this.nFieldIndexA[a]=c);this.szField100&&k[c]==this.szField100&&(this.nField100Index=c);this.szColorField&&k[c]==this.szColorField&&(this.nColorFieldIndex=c);this.szSymbolField&&k[c]==this.szSymbolField&&(this.nSymbolFieldIndex=c);this.szValueField&&k[c]==this.szValueField&&(this.nValueFieldIndex=c);this.szLabelField&&k[c]==this.szLabelField&&(this.nLabelFieldIndex=c);this.szTimeField&&k[c]==this.szTimeField&&(this.nTimeFieldIndex=c);this.szSizeField&&k[c]==this.szSizeField&&
(this.nSizeFieldIndex=c);this.szXField&&k[c]==this.szXField&&(this.nXFieldIndex=c);this.szYField&&k[c]==this.szXField&&(this.nYFieldIndex=c);this.szAlphaField&&k[c]==this.szAlphaField&&(this.nAlphaFieldIndex=c);this.szAlphaField100&&k[c]==this.szAlphaField100&&(this.nAlphaField100Index=c)}}for(a=0;a<this.szFieldsA.length;a++)0>this.nFieldIndexA[a]&&("$item$"!=this.szFieldsA[a]&&"$index$"!=this.szFieldsA[a]&&_ERROR("ERROR on load theme data: '"+this.szFieldsA[a]+"' not found !"),this.szName="");return!0};
function MapTheme(c,a,d,b,f,e,l){this.fDone=!1;this.nMin=Number.MAX_VALUE;this.nMax=-Number.MAX_VALUE;this.nNoData=this.nCount=this.nSum=0;this.szThemes=c;this.szThemesA=c.split("|");this.checkTheme();this.objThemesA=[];this.szFields=a;this.szFieldsA=a.split("|");this.szField100=d;this.nFieldsA=[];this.nFields100A=[];this.nFieldsSelectionA=[];this.nMinA=[];this.nMaxA=[];this.nSumA=[];this.nMeanA=[];this.nMedianA=[];this.nDeviationA=[];this.nOrigMinA=[];this.nOrigMaxA=[];this.nOrigSumA=[];for(d=0;d<
this.szFieldsA.length;d++)this.nMinA[d]=Number.MAX_VALUE,this.nMaxA[d]=-Number.MAX_VALUE,this.nSumA[d]=0,this.nOrigMinA[d]=Number.MAX_VALUE,this.nOrigMaxA[d]=-Number.MAX_VALUE,this.nOrigSumA[d]=0,this.nMedianA[d]=0,this.nMeanA[d]=0;this.nMin100=Number.MAX_VALUE;this.nMax100=-Number.MAX_VALUE;this.nSum100=0;this.nMinSize=Number.MAX_VALUE;this.nMaxSize=-Number.MAX_VALUE;this.nSumSize=0;this.nMinAlpha=Number.MAX_VALUE;this.nMaxAlpha=-Number.MAX_VALUE;this.nSumAlpha=0;this.nMinX=Number.MAX_VALUE;this.nMaxX=
-Number.MAX_VALUE;this.nSumX=0;this.nMinY=Number.MAX_VALUE;this.nMaxY=-Number.MAX_VALUE;this.nSumY=0;this.nDominantDFilter=this.szDominantFilter=null;this.nFilterA=[];this.dbTableA=[];this.dbFieldsA=[];this.dbRecordsA=[];if(f)for(d in this.origColorScheme=[],f)this.origColorScheme[d]=f[d];else this.origColorScheme=null;this.defaultColorScheme=["#008888","#00aaaa","#00cccc","#00eeee","#00ffff"];this.szTitle=e?e:c+" ["+a+"]";this.szTitle=map.Dictionary.getLocalText(this.szTitle);this.szTitle=60<this.szTitle.length?
this.szTitle.slice(0,50)+" ...":this.szTitle;this.szUnits="";this.szXaxisA=this.szAlphaValueUnits=this.szSizeValueUnits=null;this.szOrigLabelA=this.szLabelA=l;this.szLegendLabelA=[];this.szLegendStyle="";this.evidenceMode="isolate";this.szAggregation="mean";this.nValuesA=[];this.szExactA=this.szRangesA=this.szValuesA=null;this.itemA=[];this.fDataCache=!0;this.fEditor=!1;this.fNegativeValuePossible=this.fNullIsValue=!0;this.nStringToValue=1;this.nStringToValueA=[];this.szOrigFlag=this.szFlag=b?b:"CHOROPLETH";
this.nValueScale=this.nScale=1;this.nRefreshTimeout=0;this.szId="theme"+String(Math.random());this.szShapeType="polygon";if(c=map.Layer.getLayerObj(this.szThemesA[0]))this.szShapeType=c.szType,"line"==this.szShapeType&&this.szOrigFlag.match(/BUFFER/)&&(this.szShapeType+="+buffer");this.hiddenLayerA=[];this.szFlag.match(/CHART/)||(this.szFlag.match(/PIE/)?this.szOverviewChart="PIE":this.szFlag.match(/DONUT/)&&(this.szOverviewChart="DONUT"));this.szFlag.match(/ZEROISNOTVALUE/)&&(this.fNullIsValue=!1);
this.szFlag.match(/ZEROISVALUE/)&&(this.fNullIsValue=!0);this.szFlag.match(/NEGATIVEISNOTVALUE/)&&(this.fNegativeValuePossible=!1);this.szFlag.match(/NEGATIVEISVALUE/)&&(this.fNegativeValuePossible=!0);this.szFlag.match(/SUM/)&&(this.szAggregation="sum");if(this.szFlag.match(/CHART/)){if(this.szFlag.match(/CATEGORICAL/)||1<this.szFieldsA.length)this.fNullIsValue=!0;this.szFlag.match(/BUFFER/)||(this.fShadow=this.fOrigShadow=!0)}this.szFlag.match(/CATEGORICAL/)&&(this.fNegativeValuePossible=!1);this.szFlag.match(/CATEGORICAL/)&&
!this.szLabelA&&(this.szLabelA=[]);this.fGrayNoMember=this.fSortBeforeDraw=this.fClipCharts=!0;this.nClipTimeout=1E3;this.paintedShapeNodesA=[];this.szChoroplethInfoStyle=map.Themes.szChoroplethInfoStyle;this.nMaxThemeCharts=map.Themes.nMaxThemeCharts;this.nMaxShadowCharts=map.Themes.nMaxShadowCharts;this.nflushPaintShape=map.Themes.nflushPaintShape;this.nflushChartDraw=map.Themes.nflushChartDraw;this.themeNodesPosA=this.szFlag.match(/AGGREGATE|GROUP/)?[]:map.Themes.themeNodesPosA}
MapTheme.prototype.checkTheme=function(){if(!this.szThemesA)return!1;for(var c=0;c<this.szThemesA.length;c++)if("generic"==this.szThemesA[c]||map.Layer.isLoaded(this.szThemesA[c]))return!0;this.ErrorMessage="theme layer not loaded ! zoom in ?";return!1};MapTheme.prototype.def=function(){return map.Themes.getMapThemeDefinitionObj(this.szId)};MapTheme.prototype.getDefinitionObject=function(){return map.Themes.getMapThemeDefinitionObj(this.szId)};
MapTheme.prototype.set=function(c){map.Themes.parseStyle(this,c)};MapTheme.prototype.setDefinitionObject=function(c){map.Themes.parseStyle(this,c)};
MapTheme.prototype.initValues=function(){this.nMin=Number.MAX_VALUE;this.nMax=-Number.MAX_VALUE;for(var c=this.nNoData=this.nCount=this.nSum=0;c<this.szFieldsA.length;c++)this.nMinA[c]=Number.MAX_VALUE,this.nMaxA[c]=-Number.MAX_VALUE,this.nSumA[c]=0,this.nOrigMinA[c]=Number.MAX_VALUE,this.nOrigMaxA[c]=-Number.MAX_VALUE,this.nOrigSumA[c]=0,this.nMedianA[c]=0,this.nMeanA[c]=0,this.nDeviationA[c]=0;this.nMin100=Number.MAX_VALUE;this.nMax100=-Number.MAX_VALUE;this.nSum100=0;this.itemA=[];this.posItemA=
[];this.chartPosA=[];this.exactCountA=[];this.exactSizeA=[];this.quantileA=[];this.szAggregation||(this.szAggregation=this.szField100?"mean":"sum");if(this.szAggregationFieldA&&!this.fSuppressAggregationScale)for(c=0;c<this.szAggregationFieldA.length;c++){var a=Number(this.szAggregationFieldA[c].split(":")[1]);a&&map.Scale.nTrueMapScale*map.Scale.nZoomScale>a&&(isNaN(parseFloat(this.szAggregationFieldA[c+1]))?this.szAggregationField=this.szAggregationFieldA[c+1]:(this.szAggregationFieldA[c+1].match(/px/)?
this.nGridWidthPx=parseFloat(this.szAggregationFieldA[c+1]):(this.nGridWidth=parseFloat(this.szAggregationFieldA[c+1]),this.nGridWidthPx=0),this.szAggregationField=null));c++}this.fSuppressAggregationScale=!1;this.nWrongRecordLengthCount=0;this.missedA=[];this.coTable&&"genericTable"!=this.coTable||!this.loadTableFromMap()||(this.coTable="genericTable")};
MapTheme.prototype.removeValues=function(){this.missedA=this.quantileA=this.exactSizeA=this.exactCountA=this.chartPosA=this.posItemA=this.itemA=null};
MapTheme.prototype.getMeanMedianQuantile=function(){if(!this.quantileA||!this.quantileA.length)for(var c=0;c<this.szFieldsA.length;c++){var a=[],d=0,b;for(b in this.itemA)a.push(this.itemA[b].nValuesA[c]),d+=this.itemA[b].nValuesA[c];"$item$"!=this.szFieldsA[c]&&a.sort(this.sortUp);var f=Math.round(a.length/2);this.nMedianA[c]=a[f];this.nMeanA[c]=d/a.length;this.quantileA[c]=a}};
MapTheme.prototype.realize=function(){var c=new Date;this.fShowProgressBar=!0;this.initValues();this.getFields()?this.loadValues()?(this.fDone=!1,this.timeLoading=new Date-c,(1E3<this.timeLoading||this.szFlag.match(/VERBOSE/))&&!this.szFlag.match(/SILENT/)?executeWithMessage("map.Themes.executeContinue();",this.szFlag.match(/AGGREGATE/)?"aggregating":"parsing data"):map.Themes.executeContinue()):this.fRemove=!0:this.fRemove=!0};
MapTheme.prototype.realize_analyze=function(){var c=new Date;this.distributeValues();this.timeAggregating=new Date-c;this.fDraw=!0;(1E3<this.timeLoading||this.szFlag.match(/VERBOSE/))&&!this.szFlag.match(/SILENT/)?executeWithMessage("map.Themes.executeContinue();","drawing"):map.Themes.executeContinue()};
MapTheme.prototype.realize_draw=function(){var c=map.Layer.getLayerObj(this.szThemesA[0]);c&&(this.szShapeType=c.szType,"line"==this.szShapeType&&this.szOrigFlag.match(/BUFFER/)&&(this.szShapeType+="+buffer"));this.timeStart=new Date;this.nActualFrame=this.nMissingRangeCount=this.nZeroValueCount=this.nRealizedCount=this.nSkipCount=this.nDoneCount=0;c=this.szFlag.match(/VERBOSE/)?"drawing":"";this.mapSleep=new Map.Sleep("map.Themes.executeContinue",this.nflushPaintShape,map.Dictionary.getLocalText(c));
this.mapSleep.nCount=this.nCount;this.mapSleep.szCancel="map.Themes.cancelExecute()";this.szFlag.match(/\bCLIP\b/)&&(this.mapSleep=null,this.nClipIncr=1);this.szFlag.match(/FEATURE/)?(this.mapSleep=null,this.unpaintMap(),this.chartMap()):this.szFlag.match(/CHART/)?(this.mapSleep&&(this.mapSleep.initCheckSleep(this.nflushChartDraw,c),this.mapSleep.fShowProgressBar=!0),this.chartMap()):(this.unlabelMap(),this.paintMap(),this.makeVisible());this.isChecked=!0;this.szFlag.match(/BUFFER/)?map.Themes.activeBuffer=
this:map.Themes.activeTheme=this;try{HTMLWindow.ixmaps.htmlgui_setActualTheme(this.szId)}catch(a){}!this.szFlag.match(/CHART/)||this.szFlag.match(/BUBBLE/)||this.szFlag.match(/SQUARE/)||this.szFlag.match(/SYMBOL/)||this.szFlag.match(/BAR/)&&this.colorScheme&&this.nOrigSumA&&this.nOrigSumA.length!=this.colorScheme.length?this.isMarkable=!0:this.isMarkable=!1};MapTheme.prototype.realizeContinue=function(c){this.fMakeLabel?this.labelMap(c):this.szFlag.match(/CHART/)?this.chartMap(c):this.paintMap(c)};
MapTheme.prototype.realizeNextClipFrame=function(){this.fClipPause||(this.nActualFrame+=this.nClipIncr,this.nActualFrame>=this.nClipFrames?this.szFlag.match(/BACK/)?(this.nClipIncr=-this.nClipIncr,this.clipTimeout=setTimeout(function(){map.Themes.nextClipFrame(this.szId)},1E3)):this.szFlag.match(/LOOP/)?(this.nActualFrame=-1,this.clipTimeout=setTimeout(function(){map.Themes.nextClipFrame(this.szId)},1E3)):(this.nActualFrame=this.nClipFrames-1,this.pauseClip()):0>this.nActualFrame?this.szFlag.match(/BACK/)?
(this.nClipIncr=-this.nClipIncr,this.clipTimeout=setTimeout(function(){map.Themes.nextClipFrame(this.szId)},10)):(this.nActualFrame=0,this.pauseClip()):(this.mapSleep=null,this.szFlag.match(/CHART/)?(this.chartPosA=[],this.posItemA=[],this.fRedraw=!0,this.chartMap()):this.paintMap(),this.fRedrawInfo=!0))};
MapTheme.prototype.setClipFrame=function(c){this.fClipPause=!0;this.nActualFrame=Math.min(c,this.nClipFrames);this.mapSleep=null;this.szFlag.match(/CHART/)?(this.chartPosA=[],this.posItemA=[],this.chartMap()):this.paintMap();this.fRedrawInfo=!0};
MapTheme.prototype.startClip=function(c){var a=SVGDocument.getElementById(this.szId+":display:widget:clippausebutton:button");a&&a.style.setProperty("display","inline","");(a=SVGDocument.getElementById(this.szId+":display:widget:clipstartbutton:button"))&&a.style.setProperty("display","none","");this.fClipPause=!1;this.nActualFrame=c||this.nActualFrame;this.realizeNextClipFrame()};
MapTheme.prototype.pauseClip=function(){var c=SVGDocument.getElementById(this.szId+":display:widget:clippausebutton:button");c&&c.style.setProperty("display","none","");(c=SVGDocument.getElementById(this.szId+":display:widget:clipstartbutton:button"))&&c.style.setProperty("display","inline","");this.clipTimeout&&clearTimeout(this.clipTimeout);this.fClipPause=!0};
MapTheme.prototype.realizeDone=function(){this.nRefreshTimeout&&(this.refreshTimeout&&clearTimeout(this.refreshTimeout),this.refreshTimeout=setTimeout(function(){map.Themes.refreshTheme(this.szId)},this.nRefreshTimeout));this.szFlag.match(/\bCLIP\b/)&&(this.szFlag.match(/\bPAUSE\b/)&&(this.removeDefinitionFromFlag("PAUSE"),this.fClipPause=!0),this.clipTimeout&&clearTimeout(this.clipTimeout),this.clipTimeout=setTimeout(function(){map.Themes.nextClipFrame(this.szId)},this.nActualFrame?this.nClipTimeout:
1E3));this.nWrongRecordLengthCount&&fDebug&&displayMessage("Data Error:  "+this.nWrongRecordLengthCount+" items have wrong record length",1E4,"notify");this.fRealize=this.fRedraw=!1;this.fDone=!0;this.timeRealizing=new Date-this.timeStart;map.Themes.realizeDone(this)};MapTheme.prototype.beginDraw=function(){};MapTheme.prototype.endDraw=function(){};
MapTheme.prototype.redraw=function(c){if(!this.szFlag.match(/FEATURE/)){this.clipTimeout&&clearTimeout(this.clipTimeout);this.fDataIncomplete&&this.__themeNodes!=map.Themes.themeNodes&&(this.fDataIncomplete=!1,this.initValues(),this.loadValues(),this.distributeValues());if(this.szFlag.match(/CHART/)){if(this.fClipCharts||this.fRedraw)this.nMissingPositionCount=this.nMissingRangeCount=this.nZeroValueCount=this.nRealizedCount=this.nDoneCount=this.nSkipCount=0,this.chartMap()}else if(this.isChecked){if(this.partsA)for(var a=
0;a<this.partsA.length;a++)this.partsA[a].nCount=0,this.partsA[a].nSum=0;this.mapSleep&&this.mapSleep.initCheckSleep(this.nflushPaintShape,"painting map");this.makeVisible();this.paintMap()}c&&this.enable()}};
MapTheme.prototype.toFront=function(){if(this.szFlag.match(/CHART/)){this.chartGroup.parentNode.appendChild(this.chartGroup);var c=getMatrix(this.chartGroup);c&&setMatrix(this.chartGroup,c);this.enable()}else if(this.isChecked){for(c=0;c<this.partsA.length;c++)this.partsA[c].nCount=0,this.partsA[c].nSum=0;this.mapSleep&&this.mapSleep.initCheckSleep(this.nflushPaintShape,"painting map");this.paintMap()}else this.enable()};
MapTheme.prototype.getFields=function(){for(var c=0;c<this.szThemesA.length;c++){var a=this.szThemesA[c];this.objThemesA[a]=new ObjTheme(a,c,this.coTable,this.szSelectionField,this.szItemField);this.objThemesA[a].theme=this;if(!this.objThemesA[a].getFields()){try{HTMLWindow.ixmaps.htmlgui_onErrorTheme(a)}catch(d){}return!1}}return!0};
MapTheme.prototype.addItemValues=function(c,a,d,b,f){if(!this.szFlag.match(/RAW/)||d|b|f){var e;if(this.szExcludeA)for(e=0;e<this.szExcludeA.length;e++)if(c.split("::")[1]==this.szExcludeA[e])return;if(!(this.nField100Min&&d&&d<this.nField100Min)){if(this.nMinValue&&a&&!d){var l=!1;for(e=a.length-1;0<=e;e--)a[e]>=this.nMinValue&&(l=!0);if(!l)return}l=1;if(this.__fDensity||this.__fDensityAlpha)if(l=this.getNodeArea(c),!l&&this.__fTiledLayer){this.fDataIncomplete=!0;return}if(this.szWeights)for(e=0;e<
a.length;e++)a[e]*=this.szWeightsA[e]||this.szWeightsA[0];if(this.__fAuto100){for(e=d=0;e<a.length;e++)d+=a[e]||0;this.fField100=!0}this.itemA[c]={nOrigValuesA:[],nValuesA:a,nValue100:d,nValueSum:0};for(e=0;e<a.length;e++){this.itemA[c].nOrigValuesA[e]=isNaN(a[e])?0:a[e];this.itemA[c].nValueSum+=a[e]||0;if(this.fField100)if(d){var k=a[e];0!==k||this.szFlag.match(/ZEROISVALUE/)?"!"==this.szFieldsA[e].substr(0,1)?(k=d-k,this.itemA[c].nOrigValuesA[e]=k):this.szFlag.match(/CALCVAL/)||this.szFlag.match(/CALC100/)?
(k=d?Math.round(k*d/100):k,this.itemA[c].nOrigValuesA[e]=k):this.szFlag.match(/PRODUCT/)?k=d?k*d:k:this.szFlag.match(/DIFFERENCE/)&&1==a.length&&!this.szFlag.match(/RELATIVE/)?(d=0<e?a[e-1]:this.itemA[c].nValue100,k-=d):(k=d?k/d:1,this.szFlag.match(/FRACTION/)?k*=this.nFractionScale||1:this.szFlag.match(/PERMILLE/)?k*=1E3:(k*=100,0<k&&this.szFlag.match(/RELATIVE/)?k-=100:0<k&&this.szFlag.match(/INVERT/)&&(k=100-k))):k=0;a[e]=k}else a[e]=0;this.__fDensity&&(a[e]=l?a[e]/l:null)}if(this.__fDifference&&
1<a.length){for(e=0;e<a.length;e++)e<a.length-1?(k=a[e],a[e]=a[e+1]-a[e],this.szFlag.match(/RELATIVE/)&&(a[e]*=100/k)):this.szFlag.match(/STACKED/)||(a[e]=0);a.pop()}for(e=0;e<a.length;e++){if(!this.nSumA)return;isNaN(a[e])||(this.nMin=Math.min(this.nMin,a[e]),this.nMax=Math.max(this.nMax,a[e]),this.nSum+=a[e],this.nMinA[e]=Math.min(this.nMinA[e],a[e]),this.nMaxA[e]=Math.max(this.nMaxA[e],a[e]),this.nSumA[e]+=a[e],this.nOrigMinA[e]=Math.min(this.nOrigMinA[e],this.itemA[c].nOrigValuesA[e]),this.nOrigMaxA[e]=
Math.max(this.nOrigMaxA[e],this.itemA[c].nOrigValuesA[e]),this.nOrigSumA[e]+=this.itemA[c].nOrigValuesA[e]);0>a[e]&&(this.fNegativeValues=!0)}isNaN(d)||(this.nMin100=Math.min(this.nMin100,d),this.nMax100=Math.max(this.nMax100,d),this.nSum100+=d);b&&this.szSizeField&&!isNaN(b)&&(this.itemA[c].nSize=b,this.nMinSize=this.nMin=Math.min(this.nMinSize,b),this.nMaxSize=this.nMax=Math.max(this.nMaxSize,b),this.nSumSize+=b);this.szAlphaField&&null!=f&&!isNaN(f)&&(this.__fDensityAlpha&&(f=l?Math.min(f/l,5E4):
0),this.itemA[c].nAlpha=f,this.nMinAlpha=Math.min(this.nMinAlpha,f),this.nMaxAlpha=Math.max(this.nMaxAlpha,f),this.nSumAlpha+=f);if(this.__fExact&&this.exactCountA)for(e=0;e<a.length;e++)a[e]&&(this.exactCountA[a[e]-1]?(this.exactCountA[a[e]-1]++,this.exactSizeA[a[e]-1]+=this.itemA[c].nSize||1):(this.exactCountA[a[e]-1]=1,this.exactSizeA[a[e]-1]=this.itemA[c].nSize||1));this.nCount++}}else{this.itemA[c]={nOrigValuesA:[],nValuesA:a,nValue100:d,nValueSum:0};for(e=0;e<a.length;e++){if(!this.nSumA)return;
isNaN(a[e])||(this.nMin=Math.min(this.nMin,a[e]),this.nMax=Math.max(this.nMax,a[e]),this.nSum+=a[e]);0>a[e]&&(this.fNegativeValues=!0);this.__fExact&&this.exactCountA&&a[e]&&(this.exactCountA[a[e]-1]?(this.exactCountA[a[e]-1]++,this.exactSizeA[a[e]-1]+=this.itemA[c].nSize||1):(this.exactCountA[a[e]-1]=1,this.exactSizeA[a[e]-1]=this.itemA[c].nSize||1))}this.nCount++}};
MapTheme.prototype.getStringValueIndex=function(c,a){if(0===c.length||" "==c)if(this.szFlag.match(/UNDEFINEDISVALUE/))c="undefined";else return-1;this.szFlag.match(/IGNORECASE/)&&(c=c.toUpperCase());c=c.trim();"undefined"!=typeof this.nStringToValueA[c]||this.szValuesA&&this.szValuesA.length&&"set"!=a||(this.szLabelA=this.szLabelA||[],this.szExactA=this.szExactA||[],this.nStringToValueA[c]=this.nStringToValue,this.szLabelA[this.nStringToValue-1]=this.szLabelA[this.nStringToValue-1]||c,this.szExactA.push(this.nStringToValue),
this.nStringToValue++);return this.nStringToValueA[c]};MapTheme.prototype.checkHiddenLayerState=function(){for(var c=0;c<this.szThemesA.length;c++)if(map.Layer.isScaleDependentLayer(this.szThemesA[c])&&(this.hiddenLayerA[this.szThemesA[c]]&&map.Layer.isScaleDependentLayerOn(this.szThemesA[c])||!this.hiddenLayerA[this.szThemesA[c]]&&!map.Layer.isScaleDependentLayerOn(this.szThemesA[c])))return!0;return!1};
var __scanValue=function(c){return String(c).match(/,/)?parseFloat(String(c).replace(/\./gi,"").replace(/,/gi,".")):parseFloat(String(c).replace(/ /gi,""))};
MapTheme.prototype.loadValues=function(){this.nMissingLookupCount=0;this.__fExact=this.szFlag.match(/CATEGORICAL/);this.__fMax=this.szFlag.match(/\bMAX\b/);this.__fDifference=this.szFlag.match(/DIFFERENCE/);this.__fFilter=this.szFilter&&this.szFilter.length;this.__fDensity=this.szFlag.match(/DENSITY/);this.__fDensityAlpha=!this.szFlag.match(/CHART/)&&this.szAlphaField100&&this.szAlphaField100.match(/\$density\$/i);this.__fAggregate=this.szFlag.match(/AGGREGATE/);this.__fAuto100=this.szFlag.match(/AUTO100/)&&
!this.szFlag.match(/AGGREGATE/);this.__fTiledLayer=map.Layer.getLayerObj(this.szThemesA[0])?map.Layer.getLayerObj(this.szThemesA[0]).szFlag.match(/tiled/):!1;this.__themeNodes=map.Themes.themeNodes;for(var c=0;c<this.szThemesA.length;c++)if(map.Layer.isScaleDependentLayer(this.szThemesA[c])&&!map.Layer.isScaleDependentLayerOn(this.szThemesA[c]))this.fReload=this.hiddenLayerA[this.szThemesA[c]]=!0;else if(this.hiddenLayerA[this.szThemesA[c]]=!1,!this.loadValuesOfTheme(this.szThemesA[c]))return!1;return!0};
MapTheme.prototype.filterValues=function(c){if(this.szFilter.match(/WHERE/)){if(!this.objTheme.filterQueryA){for(var a=this.szFilter.split("WHERE ")[1].split(" "),d=0;d<a.length;d++)if(a[d].length){if('"'==a[d][0]&&'"'!=a[d][a[d].length-1]){do a[d]=a[d]+" "+a[d+1],a.splice(d+1,1);while('"'!=a[d][a[d].length-1])}}else a.splice(d,1),d--;this.objTheme.filterQueryA=[];var b={};do{var f=0;3<=a.length&&(b={},b.szFilterField=a[0].replace(/("|)/g,""),b.szFilterOp=a[1],b.szFilterValue=a[2].replace(/("|)/g,
""),f=3);"BETWEEN"==b.szFilterOp&&5<=a.length&&"AND"==a[3]&&(b.szFilterValue2=a[4].replace(/("|)/g,""),f=5);if(f){for(d=0;d<this.objTheme.dbFields.length;d++)this.objTheme.dbFields[d].id==b.szFilterField&&(b.nFilterFieldIndex=d),this.objTheme.dbFields[d].id==b.szFilterValue&&(b.nFilterValueIndex=d);this.objTheme.filterQueryA.push(b);a.splice(0,f)}else{alert("ixmaps - filter error - incomplete query!\nquery: "+this.szFilter);break}if(a.length&&"AND"==a[0])a.splice(0,1);else break}while(a.length)}for(var e in this.objTheme.filterQueryA)if(this.__szValue=
String(this.objTheme.dbRecords[c][this.objTheme.filterQueryA[e].nFilterFieldIndex]),this.__szFilterOp=this.objTheme.filterQueryA[e].szFilterOp,this.__szFilterValue=this.objTheme.filterQueryA[e].szFilterValue,this.__szFilterValue2=this.objTheme.filterQueryA[e].szFilterValue2,null!=this.objTheme.filterQueryA[e].nFilterValueIndex&&(this.__szFilterValue=String(this.objTheme.dbRecords[c][this.objTheme.filterQueryA[e].nFilterValueIndex])),a=!0,a=__scanValue(this.__szValue),a="="==this.__szFilterOp?this.__szValue==
this.__szFilterValue||a==Number(this.__szFilterValue):"!="==this.__szFilterOp?!(this.__szValue==this.__szFilterValue||a==Number(this.__szFilterValue)):"<>"==this.__szFilterOp?!(this.__szValue==this.__szFilterValue||a==Number(this.__szFilterValue)):">"==this.__szFilterOp?a>Number(this.__szFilterValue):"<"==this.__szFilterOp?a<Number(this.__szFilterValue):">="==this.__szFilterOp?a>=Number(this.__szFilterValue):"<="==this.__szFilterOp?a<=Number(this.__szFilterValue):"LIKE"==this.__szFilterOp?"*"==this.__szFilterValue?
this.__szValue.length:eval("this.__szValue.match(/"+this.__szFilterValue.replace(/\//gi,"\\/")+"/i)"):"NOT"==this.__szFilterOp?eval("!this.__szValue.match(/"+this.__szFilterValue.replace(/\//gi,"\\/")+"/i)"):"IN"==this.__szFilterOp?eval("this.__szFilterValue.match(/\\("+this.__szValue+"\\)/)")||eval("this.__szFilterValue.match(/\\("+this.__szValue+"\\,/)")||eval("this.__szFilterValue.match(/\\,"+this.__szValue+"\\,/)")||eval("this.__szFilterValue.match(/\\,"+this.__szValue+"\\)/)"):"BETWEEN"==this.__szFilterOp?
a>=Number(this.__szFilterValue)&&a<=Number(this.__szFilterValue2):eval("this.__szValue.match(/"+this.__szFilterValue.replace(/\//gi,"\\/")+"/i)"),!a)return!1}else if(this.__szValue=this.objTheme.dbRecords[c].join(" "),!eval("this.__szValue.match(/"+this.szFilter+"/i)"))return!1;return!0};
MapTheme.prototype.getSelectionId=function(c,a){if(!this.fSelection){this.fSelection="lookup";if(this.objTheme.nFieldSelectionIndexA&&1<this.objTheme.nFieldSelectionIndexA.length)this.fSelection=this.szCRSDatum?"UTM":"LatLon",this.nSelection_0=this.objTheme.nFieldSelectionIndexA[0],this.nSelection_1=this.objTheme.nFieldSelectionIndexA[1];else if(this.objTheme.nFieldSelectionIndex){var d=__mpap_decode_utf8(String(this.objTheme.dbRecords[a][this.objTheme.nFieldSelectionIndex]));d.match(/MultiPoint/)?
this.fSelection="MultiPoint":d.match(/Point/)?this.fSelection="MultiPoint":d.match(/LineString/)?this.fSelection="LineString":d.match(/MultiLineString/)&&(this.fSelection="MultiLineString")}this.objTheme.nFieldSelection2IndexA&&1<this.objTheme.nFieldSelection2IndexA.length?(this.fSelection2=this.szCRSDatum?"UTM":"LatLon",this.nSelection2_0=this.objTheme.nFieldSelection2IndexA[0],this.nSelection2_1=this.objTheme.nFieldSelection2IndexA[1]):"undefined"!=typeof this.objTheme.nFieldSelection2Index&&(d=
__mpap_decode_utf8(String(this.objTheme.dbRecords[a][this.objTheme.nFieldSelection2Index])),d.match(/MultiPoint/)?this.fSelection2="MultiPoint":d.match(/Point/)?this.fSelection2="MultiPoint":this.fSelection2="mapshape")}if("LatLon"==this.fSelection||"UTM"==this.fSelection)return c+"::"+(String(this.objTheme.dbRecords[a][this.nSelection_0]).replace(/,/g,".")+","+String(this.objTheme.dbRecords[a][this.nSelection_1]).replace(/,/g,"."))+(this.szSelectionFieldSuffix||"").replace(/,/g,".");if("Point"==
this.fSelection||"MultiPoint"==this.fSelection||"LineString"==this.fSelection||"MultiLineString"==this.fSelection){var d=this.objTheme.dbRecords[a][this.objTheme.nFieldSelectionIndex],b=null;return(b=d.match(positionRegExp))?c+"::"+(b[2]+","+b[1])+(this.szSelectionFieldSuffix||""):null}d=__mpap_decode_utf8(String(this.objTheme.dbRecords[a][this.objTheme.nFieldSelectionIndex]));this.nSelectionFieldDigits&&(d=("000000000000000"+d).slice(-this.nSelectionFieldDigits));this.fSelectionFieldToNumber&&(d=
String(Number(d)));this.fSelectionFieldToUpper&&(d=String(d).toUpperCase());return c+"::"+d+(this.szSelectionFieldSuffix||"")};
MapTheme.prototype.loadValuesOfTheme=function(c){var a,d,b,f,e;this.fNegativeValues=this.fField100=!1;this.szUnit=(this.szUnits?"."==this.szUnits.substr(0,1)?"":" ":"")+(this.szUnits||"");var l=!0;this.objTheme=this.objThemesA[c];0<this.objTheme.nField100Index&&(this.fField100=!0);if(this.objTheme.dbTable&&c&&c.length){if(this.coTable){try{eval("this.objTheme.dbRecords = "+this.coTable+".records")}catch(k){eval("this.objTheme.dbRecords = "+this.coTable+"_records")}if(!this.objTheme.dbRecords)return displayMessage("Data "+
this.coTable+" could not be loaded!",2E3,!0),!1}else try{eval("this.objTheme.dbRecords = "+c+".records")}catch(n){eval("this.objTheme.dbRecords = "+c+"_records")}this.objTheme.nFieldSelectionIndexA.length||delete this.objTheme.nFieldSelectionIndexA;if("$item$"!=this.szFieldsA[0]&&!this.szFlag.match(/CATEGORICAL/))for(f=Math.min(40,this.objTheme.dbRecords.length),a=0;a<f;a++)if(this.objTheme.dbRecords[a])for(d=0;d<this.szFieldsA.length;d++)if(b=this.objTheme.dbRecords[a][this.objTheme.nFieldIndexA[d]],
__scanValue(b)!=parseFloat(b)){this.__fScanValue=!0;a=f;break}if(this.szFlag.match(/FAST/)||this.szFlag.match(/AGGREGATE/)&&!this.szFlag.match(/COMPATIBLE|PERCENTOFMEAN/))return this.__fAggregateOnLoad=!0,this.loadAndAggregateValuesOfTheme(c);for(a=0;a<this.objTheme.dbRecords.length;a++)if(!this.objTheme.dbRecords[a]||this.objTheme.dbRecords[a].length<this.objTheme.dbFields.length)this.nWrongRecordLengthCount++;else if(!this.__fFilter||this.filterValues(a)){f=[];if("$item$"==this.szFieldsA[0])f[0]=
1;else if("$index$"==this.szFieldsA[0])f[0]=a+1;else for(d=0;d<this.szFieldsA.length;d++)b=this.objTheme.dbRecords[a][this.objTheme.nFieldIndexA[d]],this.__fExact?(b=this.valueMap?this.valueMap[String(b)]:b,b=this.getStringValueIndex(String(b))):b=this.__fScanValue?__scanValue(b):parseFloat(b),isNaN(b)||0===b&&!this.fNullIsValue||0>b&&!this.fNegativeValuePossible||(f[d]=b);f.length=this.szFieldsA.length;e="$item$"==this.szField100?1:0>this.objTheme.nField100Index?0:__scanValue(this.objTheme.dbRecords[a][this.objTheme.nField100Index]);
0!==e||this.fNullIsValue||(e=null);0>e&&!this.fNegativeValuePossible&&(e=null);var h=null;this.szSizeField&&(h=__scanValue(this.objTheme.dbRecords[a][this.objTheme.nSizeFieldIndex]));var p=null;this.szAlphaField&&(p=__scanValue(this.objTheme.dbRecords[a][this.objTheme.nAlphaFieldIndex]),isNaN(p)&&(p=0));this.szAlphaField100&&this.objTheme.nAlphaField100Index&&(p*=100/__scanValue(this.objTheme.dbRecords[a][this.objTheme.nAlphaField100Index]),isNaN(p)&&(p=0));if(b=d=this.getSelectionId(c,a)){0<=this.objTheme.nFieldItemIndex&&
this.objTheme.nFieldItemIndex!=this.objTheme.nFieldSelectionIndex&&(d=__mpap_decode_utf8(String(this.objTheme.dbRecords[a][this.objTheme.nFieldItemIndex])),this.fSelectionFieldToUpper&&(d=String(d).toUpperCase()),d=c+"::"+d);if(this.itemA[d]){if(this.szFlag.match(/DOT/))continue;d+="*"+Math.random();if(this.itemA[d])continue}this.addItemValues(d,f,e,h,p);this.itemA[d]&&(this.szColorField&&(this.itemA[d].szColor="$index$"==this.szColorField?a+1:__mpap_decode_utf8(this.objTheme.dbRecords[a][this.objTheme.nColorFieldIndex])),
this.szSymbolField&&(this.itemA[d].szSymbol="$index$"==this.szSymbolField?a+1:__mpap_decode_utf8(this.objTheme.dbRecords[a][this.objTheme.nSymbolFieldIndex])),this.szValueField&&(this.itemA[d].szValue="$index$"==this.szValueField?a+1:__mpap_decode_utf8(this.objTheme.dbRecords[a][this.objTheme.nValueFieldIndex])),this.szTimeField&&(this.itemA[d].szTime="$index$"==this.szTimeField?a+1:__mpap_decode_utf8(this.objTheme.dbRecords[a][this.objTheme.nTimeFieldIndex])),this.szLabelField&&(this.itemA[d].szLabel=
"$index$"==this.szLabelField?a+1:__mpap_decode_utf8(this.objTheme.dbRecords[a][this.objTheme.nLabelFieldIndex])),this.szTitleField&&(this.itemA[d].szTitle=__mpap_decode_utf8(this.objTheme.dbRecords[a][this.objTheme.nTitleFieldIndex])),this.szSnippetField&&(this.itemA[d].szSnippet=__mpap_decode_utf8(this.objTheme.dbRecords[a][this.objTheme.nSnippetFieldIndex])),this.itemA[d].szSelectionId=b?b:d,this.szAggregationField&&(this.itemA[d].szAggregation=__mpap_decode_utf8(this.objTheme.dbRecords[a][this.objTheme.nAggregationFieldIndex])),
this.szXField&&(this.itemA[d].nX=__scanValue(this.objTheme.dbRecords[a][this.objTheme.nXFieldIndex]),isNaN(this.itemA[d].nX)||(this.nMinX=Math.min(this.nMinX,this.itemA[d].nX),this.nMaxX=Math.max(this.nMaxX,this.itemA[d].nX),this.nSumX+=this.itemA[d].nXField)),this.szYField&&(this.itemA[d].nY=__scanValue(this.objTheme.dbRecords[a][this.objTheme.nYFieldIndex]),isNaN(this.itemA[d].nY)||(this.nMinY=Math.min(this.nMinY,this.itemA[d].nY),this.nMaxY=Math.max(this.nMaxY,this.itemA[d].nY),this.nSumY+=this.itemA[d].nYField)),
this.itemA[d].dbIndex=a)}else this.nMissingLookupCount++}}else l=!1;if(l)return this.fAnalyze=!0};
MapTheme.prototype.loadAndAggregateValuesOfTheme=function(c,a){var d,b,f,e,l,k,n,h;if(!a){console.log("*** F A S T ***");this.fNegativeValues=this.fField100=!1;this.__fMultiParts=this.szFlag.match(/CATEGORICAL/)&&!(this.szFlag.match(/PIE/)||this.szFlag.match(/BAR/)||this.szFlag.match(/SEQUENCE/)||this.szFlag.match(/PLOT/)||this.szFlag.match(/DOMINANT/)||this.szFlag.match(/COMPOSECOLOR/)||this.szFlag.match(/\bUSER\b/)||this.szFlag.match(/WAFFLE/));this.__fClipToGeoBounds=!1;(1E5<this.objTheme.dbRecords.length||
this.szFlag.match(/CLIPTOGEOBOUNDS/))&&map.Scale.nTrueMapScale*map.Scale.nZoomScale<(this.nClipUpper||15E3)&&(this.__fClipToGeoBounds=!0);this.szUnit=(this.szUnits?"."==this.szUnits.substr(0,1)?"":" ":"")+(this.szUnits||"");this.objTheme=this.objThemesA[c];0<this.objTheme.nField100Index&&(this.fField100=!0);if(!(this.objTheme.dbTable&&c&&c.length))return!1;if(this.coTable){try{eval("this.objTheme.dbRecords = "+this.coTable+".records")}catch(p){eval("this.objTheme.dbRecords = "+this.coTable+"_records")}if(!this.objTheme.dbRecords)return displayMessage("Data "+
this.coTable+" could not be loaded!",2E3,!0),!1}else try{eval("this.objTheme.dbRecords = "+c+".records")}catch(g){eval("this.objTheme.dbRecords = "+c+"_records")}this.objTheme.nFieldSelectionIndexA.length||delete this.objTheme.nFieldSelectionIndexA;if(this.szFlag.match(/ZOOMTO/)){this.getSelectionId(c,0);for(b=0;b<this.objTheme.dbRecords.length;b++)"UTM"==this.fSelection?x=map.Scale.getMapPositionOfUTM(parseFloat(String(this.objTheme.dbRecords[b][this.nSelection_0]).replace(/\,/g,".")),parseFloat(String(this.objTheme.dbRecords[b][this.nSelection_1]).replace(/\,/g,
".")),this.szCRSDatum,this.szCRSUTMZone):"LatLon"==this.fSelection?x=map.Scale.getMapPositionOfLatLon(parseFloat(String(this.objTheme.dbRecords[b][this.nSelection_0]).replace(/\,/g,".")),parseFloat(String(this.objTheme.dbRecords[b][this.nSelection_1]).replace(/\,/g,"."))):"Point"==this.fSelection||"MultiPoint"==this.fSelection||"LineString"==this.fSelection||"MultiLineString"==this.fSelection?(e=this.objTheme.dbRecords[b][this.objTheme.nFieldSelectionIndex],n=e.match(positionRegExp),x=map.Scale.getMapPositionOfLatLon(parseFloat(n[2]),
parseFloat(n[1]))):(e=this.objTheme.dbRecords[b][this.objTheme.nFieldSelectionIndex],this.fSelectionFieldToUpper&&(e=String(e).toUpperCase()),x=this.getNodePosition(c+"::"+e)),x&&(this.itemA[c+"::"+String(x.x)+","+String(x.y)]={ptPos:x});this.zoomTo();this.itemA=[];this.removeDefinitionFromFlag("ZOOMTO");d=map.Themes.getMapThemeDefinitionObj(this.szId);map.Themes.newThemeObjA=map.Themes.newThemeObjA||[];map.Themes.newThemeObjA.push(d);setTimeout(function(){map.Themes.newThemeByObj()},100);return}this.createChartGroup(map.Layer.objectGroup);
if("$item$"!=this.szFieldsA[0]&&!this.szFlag.match(/CATEGORICAL/)){var u=Math.min(40,this.objTheme.dbRecords.length);for(b=0;b<u;b++)if(this.objTheme.dbRecords[b])for(f=0;f<this.szFieldsA.length;f++){var r=this.objTheme.dbRecords[b][this.objTheme.nFieldIndexA[f]];if(__scanValue(r)!=parseFloat(r)){this.__fScanValue=!0;b=u;break}}}"$item$"==this.szSizeField&&(this.oldSizefield=this.szSizeField,this.szSizeField=null);this.nGridWidthPx&&(this.nGridWidth=b=map.Scale.getDistanceInMeter(1E3,1E3,1E3+map.Scale.normalX(this.nGridWidthPx),
1E3));this.nGridMatrix&&(b=map.Zoom.getBox(),b=map.Scale.getDistanceInMeter(1E3,1E3,1E3+b.width,1E3),this.nGridWidth=b/(this.nGridMatrix||20)/map.Scale.nZoomScale);this.nGridWidthMap=this.nGridWidth?Math.round(map.Scale.getDeltaXofDistanceInMeter(this.nGridWidth)/20)*map.Scale.nZoomScale*20:0;this.nGridWidth&&!this.nGridWidthMap&&(this.nGridWidthMap=this.nGridWidth?map.Scale.getDeltaXofDistanceInMeter(this.nGridWidth)*map.Scale.nZoomScale:0);this.dY=this.dX=0;this.szFlag.match(/FIXGRID/)&&(this.dX=
map.Scale.mapCenter.x*map.Scale.nZoomScale,this.dY=map.Scale.mapCenter.y*map.Scale.nZoomScale);this.nGridOffsetX&&(this.dX-=this.nGridWidthMap/100*this.nGridOffsetX);this.nGridOffsetY&&(this.dY+=this.nGridWidthMap/100*this.nGridOffsetY);this.nHexaWidth=1.15*this.nGridWidthMap;this.nHexaHalf=1.15*this.nGridWidthMap/2;this.nHexa4th=this.nGridWidthMap/4;this.getSelectionId(c,0);this.aggregationCount=0;this.nMin=Number.MAX_VALUE;this.nMax=-Number.MAX_VALUE;this.nMinSize=Number.MAX_VALUE;this.nMaxSize=
-Number.MAX_VALUE;this.nSumSize=0;this.nMinAlpha=Number.MAX_VALUE;this.nMaxAlpha=-Number.MAX_VALUE;this.nSumAlpha=0;if(this.__fExact)this.nMinA=[],this.nMaxA=[],this.nSumA=[],this.nOrigMinA=[],this.nOrigMaxA=[],this.nOrigSumA=[],this.nMedianA=[],this.nMeanA=[],this.nCountA=[];else for(b=0;b<this.szFieldsA.length;b++)this.nMinA[b]=Number.MAX_VALUE,this.nMaxA[b]=-Number.MAX_VALUE,this.nSumA[b]=0,this.nOrigMinA[b]=Number.MAX_VALUE,this.nOrigMaxA[b]=-Number.MAX_VALUE,this.nOrigSumA[b]=0,this.nMedianA[b]=
0,this.nMeanA[b]=0;this.nEmptyValuesA=[];for(var q in this.szValuesA)this.nEmptyValuesA.push(0);this.szFlag.match(/DUMP/)&&(this.nChartGroupScale=fObjectScaling?(this.nAutoScale||this.nScale)*map.Layer.nObjectScale*map.Scale.nObjectScaling:(this.nAutoScale||this.nScale)*map.Scale.nFeatureScaling*map.Scale.nObjectScaling,this.chartGroup=map.Dom.newGroup(map.Layer.objectGroup,this.szId+":chartgroup"));if(!this.szWeightsA)for(this.szWeightsA=[],b=0;b<this.szFieldsA.length;b++)this.szWeightsA.push(1);
else if(this.szWeightsA.length&&this.szWeightsA.length!=this.szFieldsA.length)for(q=this.szWeightsA[this.szWeightsA.length-1],b=this.szWeightsA.length;b<this.szFieldsA.length;b++)this.szWeightsA.push(q)}if(this.szAggregationUpper&&map.Scale.nTrueMapScale*map.Scale.nZoomScale>this.nAggregationUpper||this.szAggregationLower&&map.Scale.nTrueMapScale*map.Scale.nZoomScale<this.nAggregationLower)this.__fAggregate=!1;q=map.Zoom.getBoundsOfMapInGeoBounds();var u=map.Zoom.getBox(),t=2E5<this.objTheme.dbRecords.length;
for(b=a||0;b<this.objTheme.dbRecords.length;b++){if(t&&b>(a||0)&&0===b%5E4)return this.fContinueLoadAndAggregate=!0,this.continueIndex=b,this.szThemeLayer=c,displayMessage(__formatValue(b/this.objTheme.dbRecords.length*100,0)+"% "+map.Dictionary.getLocalText("aggregated")),displayProgressBar(b,this.objTheme.dbRecords.length,""),setTimeout(function(){map.Themes.executeContinue()},10),!0;if(!this.objTheme.dbRecords[b]||this.objTheme.dbRecords[b].length<this.objTheme.dbFields.length)this.nWrongRecordLengthCount++;
else if(!this.__fFilter||this.filterValues(b)){if(this.__fClipToGeoBounds&&"LatLon"==this.fSelection&&(x=parseFloat(String(this.objTheme.dbRecords[b][this.nSelection_0]).replace(/\,/g,".")),e=parseFloat(String(this.objTheme.dbRecords[b][this.nSelection_1]).replace(/\,/g,".")),e<q[0].x||e>q[1].x||x<q[0].y||x>q[1].y))continue;var x=null,E=null;"UTM"==this.fSelection?e=(x=map.Scale.getMapPositionOfUTM(parseFloat(String(this.objTheme.dbRecords[b][this.nSelection_0]).replace(/\,/g,".")),parseFloat(String(this.objTheme.dbRecords[b][this.nSelection_1]).replace(/\,/g,
".")),this.szCRSDatum,this.szCRSUTMZone))?String(x.x)+","+String(x.y):"":"LatLon"==this.fSelection?e=(x=map.Scale.getMapPositionOfLatLon(parseFloat(String(this.objTheme.dbRecords[b][this.nSelection_0]).replace(/\,/g,".")),parseFloat(String(this.objTheme.dbRecords[b][this.nSelection_1]).replace(/\,/g,"."))))?String(x.x)+","+String(x.y):"":"Point"==this.fSelection||"MultiPoint"==this.fSelection||"LineString"==this.fSelection||"MultiLineString"==this.fSelection?(e=this.objTheme.dbRecords[b][this.objTheme.nFieldSelectionIndex],
n=e.match(positionRegExp),x=map.Scale.getMapPositionOfLatLon(parseFloat(n[2]),parseFloat(n[1]))):(e=this.objTheme.dbRecords[b][this.objTheme.nFieldSelectionIndex],this.fSelectionFieldToUpper&&(e=String(e).toUpperCase()),this.nSelectionFieldDigits&&(e=("000000000000000"+e).slice(-this.nSelectionFieldDigits)),this.fSelectionFieldToNumber&&(e=String(Number(e))),x=this.getNodePosition(c+"::"+e));this.szFlag.match(/DUMP/)&&(n=map.Dom.newGroup(this.chartGroup,this.szId+":"+e+":chart"),n.fu.setMatrix([this.nChartGroupScale,
0,0,this.nChartGroupScale,x.x,x.y]),map.Dom.newShape("circle",n,0,0,map.Scale.normalX(3),"fill:blue;fill-opacity:0.2;stroke:none;"));if(!x||isNaN(x.x)||isNaN(x.y))this.fDataIncomplete=this.fRedraw=!0;else{var B=x,m=null;l=null;this.fSelection2&&("UTM"==this.fSelection2?l=(m=map.Scale.getMapPositionOfUTM(parseFloat(String(this.objTheme.dbRecords[b][this.nSelection2_0]).replace(/\,/g,".")),parseFloat(String(this.objTheme.dbRecords[b][this.nSelection2_1]).replace(/\,/g,".")),this.szCRSDatum,this.szCRSUTMZone))?
String(m.x)+","+String(m.y):"":"LatLon"==this.fSelection2?(m=map.Scale.getMapPositionOfLatLon(parseFloat(String(this.objTheme.dbRecords[b][this.nSelection2_0]).replace(/\,/g,".")),parseFloat(String(this.objTheme.dbRecords[b][this.nSelection2_1]).replace(/\,/g,"."))),l=x?String(x.x)+","+String(x.y):""):"Point"==this.fSelection||"MultiPoint"==this.fSelection||"LineString"==this.fSelection||"MultiLineString"==this.fSelection?(l=this.objTheme.dbRecords[b][this.objTheme.nFieldSelection2Index],n=e.match(positionRegExp),
m=map.Scale.getMapPositionOfLatLon(parseFloat(n[2]),parseFloat(n[1]))):(l=this.objTheme.dbRecords[b][this.objTheme.nFieldSelection2Index],this.nSelectionFieldDigits&&(l=("000000000000000"+e).slice(-this.nSelectionFieldDigits)),this.fSelectionFieldToUpper&&(l=String(l).toUpperCase()),m=this.getNodePosition(c+"::"+l)),l=__mpap_decode_utf8(String(this.objTheme.dbRecords[b][this.objTheme.nFieldIndexA[0]])),this.fSelectionFieldToUpper&&(l=String(l).toUpperCase()),k=l,l=c+"::"+l,this.themeNodesPosA[l]=
m);if(!m||x.x!=m.x||x.y!=m.y)if(!this.__fClipToGeoBounds||!(x.x<u.x||x.x>u.x+u.width||x.y<u.y||x.y>u.y+u.height)){var y=!1,A=[];if("$item$"==this.szFieldsA[0])A[0]=1;else if("$index$"==this.szFieldsA[0])A[0]=b+1;else for(f=0;f<this.szFieldsA.length;f++)r=this.objTheme.dbRecords[b][this.objTheme.nFieldIndexA[f]],r=this.valueMap?this.valueMap[String(r)]||r:r,this.__fExact?(r=this.getStringValueIndex(String(r)),this.exactCountA[r-1]=(this.exactCountA[r-1]||0)+1):r=this.__fScanValue?__scanValue(r)*(this.szWeightsA[f]||
1):parseFloat(r)*(this.szWeightsA[f]||1),isNaN(r)?y=!0:0!==r||this.fNullIsValue?0>r&&!this.fNegativeValuePossible?y=!0:A[f]=r:y=!0;A.length=this.szFieldsA.length;n=1;n="$item$"==this.szField100?1:0>this.objTheme.nField100Index?0:__scanValue(this.objTheme.dbRecords[b][this.objTheme.nField100Index]);0!==n||this.fNullIsValue||(n=null);0>n&&!this.fNegativeValuePossible&&(n=null);isNaN(n)&&(n=null);var z=null;if(this.szSizeField&&"$item$"!=this.szSizeField){z=this.objTheme.dbRecords[b][this.objTheme.nSizeFieldIndex];
z=this.valueMap?this.valueMap[String(z)]||__scanValue(z):__scanValue(z);z=isFinite(z)&&!isNaN(z)?z:0;if(0===z&&!this.fNullIsValue){y=!0;continue}if(0>z&&!this.fNegativeValuePossible){y=!0;continue}}else z=1;var v=null;this.szAlphaField&&(v=__scanValue(this.objTheme.dbRecords[b][this.objTheme.nAlphaFieldIndex]));var N=null;this.szTitleField&&(N=this.objTheme.dbRecords[b][this.objTheme.nTitleFieldIndex]);var R=null;this.szColorField&&(R="$index$"==this.szColorField?b+1:__mpap_decode_utf8(this.objTheme.dbRecords[b][this.objTheme.nColorFieldIndex]));
var Ca=null;this.szTimeField&&(Ca="$index$"==this.szTimeField?b+1:__mpap_decode_utf8(this.objTheme.dbRecords[b][this.objTheme.nTimeFieldIndex]));f=null;this.szXField&&(f=__scanValue(this.objTheme.dbRecords[b][this.objTheme.nXFieldIndex]));var vb=null;this.szYField&&(vb=__scanValue(this.objTheme.dbRecords[b][this.objTheme.nYFieldIndex]));if(this.__fAggregate&&this.nGridWidthMap)if(this.szFlag.match(/\bRECT\b/))x=this.dX||this.dY?new point(Math.round((x.x+this.dX)/this.nGridWidthMap)*this.nGridWidthMap-
this.dX,Math.round((x.y+this.dY)/this.nGridWidthMap)*this.nGridWidthMap-this.dY):new point(Math.round(x.x/this.nGridWidthMap)*this.nGridWidthMap,Math.round(x.y/this.nGridWidthMap)*this.nGridWidthMap);else{if(this.szFlag.match(/PLOTY/))var E=Math.round(x.y/this.nGridWidthMap),Z=E%2?this.nHexaHalf:0,E=new point(Math.round((x.x+Z)/this.nHexaWidth)*this.nHexaWidth-Z,E*this.nGridWidthMap);else var E=Math.round(x.x/this.nGridWidthMap),pa=E%2?this.nHexaHalf:0,E=new point(E*this.nGridWidthMap,Math.round((x.y+
pa)/this.nHexaWidth)*this.nHexaWidth-pa);if(Math.abs(E.x-x.x)>this.nHexa4th){var Z=[],Y=[],pa=0===pa?this.nHexaHalf:0;E.x>x.x?(Z[0]=new point(E.x-this.nGridWidthMap,E.y-this.nHexaHalf),Z[1]=new point(E.x-this.nGridWidthMap,E.y+this.nHexaHalf)):(Z[0]=new point(E.x+this.nGridWidthMap,E.y-this.nHexaHalf),Z[1]=new point(E.x+this.nGridWidthMap,E.y+this.nHexaHalf));Y[0]=Math.sqrt(Math.pow(Z[0].x-x.x,2)+Math.pow(Z[0].y-x.y,2));Y[1]=Math.sqrt(Math.pow(Z[1].x-x.x,2)+Math.pow(Z[1].y-x.y,2));Y[3]=Math.sqrt(Math.pow(E.x-
x.x,2)+Math.pow(E.y-x.y,2));Y[0]<Y[3]?E=new point(Math.round(Z[0].x/this.nGridWidthMap)*this.nGridWidthMap,Math.round((Z[0].y+pa)/this.nHexaWidth)*this.nHexaWidth-pa):Y[1]<Y[3]&&(E=new point(Math.round(Z[1].x/this.nGridWidthMap)*this.nGridWidthMap,Math.round((Z[1].y+pa)/this.nHexaWidth)*this.nHexaWidth-pa))}x=E}this.__fAggregate&&this.nGridWidthMap&&m&&!this.szFlag.match(/\bORIGIN\b/)&&(this.szFlag.match(/\bRECT\b/)?m=this.dX||this.dY?new point(Math.round((m.x+this.dX)/this.nGridWidthMap)*this.nGridWidthMap-
this.dX,Math.round((m.y+this.dY)/this.nGridWidthMap)*this.nGridWidthMap-this.dY):new point(Math.round(m.x/this.nGridWidthMap)*this.nGridWidthMap,Math.round(m.y/this.nGridWidthMap)*this.nGridWidthMap):(this.szFlag.match(/PLOTY/)?(E=Math.round(m.y/this.nGridWidthMap),Z=E%2?this.nHexaHalf:0,E=new point(Math.round((m.x+Z)/this.nHexaWidth)*this.nHexaWidth-Z,E*this.nGridWidthMap)):(E=Math.round(m.x/this.nGridWidthMap),pa=E%2?this.nHexaHalf:0,E=new point(E*this.nGridWidthMap,Math.round((m.y+pa)/this.nHexaWidth)*
this.nHexaWidth-pa)),Math.abs(E.x-m.x)>this.nHexa4th&&(Z=[],Y=[],pa=0===pa?this.nHexaHalf:0,E.x>m.x?(Z[0]=new point(E.x-this.nGridWidthMap,E.y-this.nHexaHalf),Z[1]=new point(E.x-this.nGridWidthMap,E.y+this.nHexaHalf)):(Z[0]=new point(E.x+this.nGridWidthMap,E.y-this.nHexaHalf),Z[1]=new point(E.x+this.nGridWidthMap,E.y+this.nHexaHalf)),Y[0]=Math.sqrt(Math.pow(Z[0].x-m.x,2)+Math.pow(Z[0].y-m.y,2)),Y[1]=Math.sqrt(Math.pow(Z[1].x-m.x,2)+Math.pow(Z[1].y-m.y,2)),Y[3]=Math.sqrt(Math.pow(E.x-m.x,2)+Math.pow(E.y-
m.y,2)),Y[0]<Y[3]?E=new point(Math.round(Z[0].x/this.nGridWidthMap)*this.nGridWidthMap,Math.round((Z[0].y+pa)/this.nHexaWidth)*this.nHexaWidth-pa):Y[1]<Y[3]&&(E=new point(Math.round(Z[1].x/this.nGridWidthMap)*this.nGridWidthMap,Math.round((Z[1].y+pa)/this.nHexaWidth)*this.nHexaWidth-pa))),m=E),this.themeNodesPosA[l]=m);l=e;this.szAggregationField?(e=__mpap_decode_utf8(this.objTheme.dbRecords[b][this.objTheme.nAggregationFieldIndex]),e=c+"::"+e):e=c+"::"+String(x.x)+","+String(x.y)+(this.__fMultiParts?
","+String(r):"");m&&this.szFlag.match(/VECTOR/)&&(e+="&"+String(m.x)+","+String(m.y));if(this.__fAggregate)if(!this.itemA[e]){if(!y){this.aggregationCount++;y=0;if(this.__fMultiParts)y=z;else if(this.__fExact)if(f=A[0]-1,isNaN(f))continue;else A=this.nEmptyValuesA.slice(0),y=A[f]=z,h=this.nEmptyValuesA.slice(0),h[f]=1;else for(f=0;f<this.szFieldsA.length;f++)y=Math.max(y,A[f]||0);this.itemA[e]={nOrigValuesA:[],nValuesA:A,nValue100:n,nValueSum:0,nCount:1,nCountA:h};this.itemA[e].szTitle=N;this.itemA[e].szSelectionId=
String(l);this.itemA[e].szSelectionId2=String(k);this.itemA[e].nSize=z||(this.objTheme.nSizeFieldIndex?0:y);this.itemA[e].nAlpha=v||1;this.itemA[e].szColor=R;this.itemA[e].szTime=Ca;this.itemA[e].dbIndexA=[b];this.itemA[e].ptPos=x;this.itemA[e].ptPos2=m;this.itemA[e].ptPosA=[B];this.nCount++}}else{if(!y){y=0;if(this.__fMultiParts)y=z;else if(this.__fExact)if(f=A[0]-1,isNaN(f))continue;else this.itemA[e].nValuesA[f]=this.__fMax?Math.max(this.itemA[e].nValuesA[f]||0,z):(this.itemA[e].nValuesA[f]||0)+
z,this.itemA[e].nCountA[f]=(this.itemA[e].nCountA[f]||0)+1,y=z;else for(f=0;f<this.szFieldsA.length;f++)this.itemA[e].nValuesA[f]+=A[f]||0,y=Math.max(y,A[f]||0);this.itemA[e].nSize+=z||(this.objTheme.nSizeFieldIndex?0:y);this.itemA[e].nAlpha+=v||1;this.itemA[e].nValue100+=n||0;this.itemA[e].nCount++;this.itemA[e].dbIndexA.push(b);this.itemA[e].ptPosA.push(B);N!=this.itemA[e].szTitle&&(this.itemA[e].szTitle="("+this.itemA[e].nCount+")")}}else this.itemA[e]&&(e+="*"+Math.random()),this.aggregationCount++,
this.itemA[e]={nOrigValuesA:[],nValuesA:A,nValue100:n,nValueSum:0},this.itemA[e].szSelectionId=String(l),this.itemA[e].szSelectionId2=String(k),this.itemA[e].nSize=z||0,this.itemA[e].ptPos=x,this.itemA[e].ptPos2=m,this.itemA[e].dbIndexA=[b],this.itemA[e].nX=f,this.itemA[e].nY=vb,this.itemA[e].szColor=R,this.itemA[e].szTime=Ca,this.nCount++}}}}if(0<=this.objTheme.nField100Index)if(this.fField100=!0,this.szFlag.match(/DIFFERENCE/)&&1==this.itemA[d].nValuesA.length&&!this.szFlag.match(/RELATIVE/))for(d in this.itemA)for(f=
0;f<this.itemA[d].nValuesA.length;f++)this.itemA[d].nValuesA[f]-=this.itemA[d].nValue100;else if(this.szFlag.match(/FRACTION/))for(d in this.itemA)for(f=0;f<this.itemA[d].nValuesA.length;f++)this.itemA[d].nValuesA[f]=this.itemA[d].nValuesA[f]/this.itemA[d].nValue100*(this.nFractionScale||1);else if(this.szFlag.match(/PRODUCT/))for(d in this.itemA)for(f=0;f<this.itemA[d].nValuesA.length;f++)this.itemA[d].nValuesA[f]*=this.itemA[d].nValue100;else if(this.szFlag.match(/CALCVAL/))for(d in this.itemA)for(f=
0;f<this.itemA[d].nValuesA.length;f++)this.itemA[d].nValuesA[f]=Math.round(this.itemA[d].nValuesA[f]*this.itemA[d].nValue100/100);else if(this.szFlag.match(/PERMILLE/))for(d in this.itemA)for(f=0;f<this.itemA[d].nValuesA.length;f++)this.itemA[d].nValuesA[f]*=1E3/this.itemA[d].nValue100;else for(d in this.itemA)for(f=0;f<this.itemA[d].nValuesA.length;f++)this.itemA[d].nValue100>(this.nField100Min||0)?(this.itemA[d].nValuesA[f]*=100/this.itemA[d].nValue100,0<this.itemA[d].nValuesA[f]&&this.szFlag.match(/RELATIVE/)?
this.itemA[d].nValuesA[f]-=100:0<this.itemA[d].nValuesA[f]&&this.szFlag.match(/INVERT/)&&(this.itemA[d].nValuesA[f]=100-r)):this.itemA[d].nValuesA[f]=0;else if(this.__fAggregate&&this.szFlag.match(/MEAN/))if(this.__fMultiParts)for(d in this.itemA)this.itemA[d].nSize/=this.itemA[d].nCount;else for(d in this.itemA){if(this.itemA[d].nCountA)for(f=0;f<this.itemA[d].nValuesA.length;f++)this.itemA[d].nValuesA[f]/=this.itemA[d].nCountA[f]||1;else for(f=0;f<this.itemA[d].nValuesA.length;f++)this.itemA[d].nValuesA[f]/=
this.itemA[d].nCount;this.szFlag.match(/SIZESUM/)||(this.itemA[d].nSize/=this.itemA[d].nCount)}if(this.szFlag.match(/DIFFERENCE/))for(d in this.itemA){for(b=0;b<this.itemA[d].nValuesA.length;b++)b<this.itemA[d].nValuesA.length-1?(k=this.itemA[d].nValuesA[b],this.itemA[d].nValuesA[b]=this.itemA[d].nValuesA[b+1]-this.itemA[d].nValuesA[b],this.szFlag.match(/RELATIVE/)&&(this.itemA[d].nValuesA[b]=k>(this.nField100Min||0)?100/k*this.itemA[d].nValuesA[b]:0)):this.szFlag.match(/STACKED/)||(this.itemA[d].nValuesA[b]=
0);this.itemA[d].nValuesA.pop()}if(this.szFlag.match(/AUTO100/))for(d in this.itemA){for(b=n=0;b<this.itemA[d].nValuesA.length;b++)n+=this.itemA[d].nValuesA[b]||0;this.itemA[d].nValue100=n;this.fField100=!0;for(b=0;b<this.itemA[d].nValuesA.length;b++)this.itemA[d].nValuesA[b]/=this.itemA[d].nValue100/100}if(this.szFlag.match(/RELOCATE/)||this.szAggregationField)for(d in this.itemA)if(this.itemA[d].ptPosA){for(k=x=e=0;k<this.itemA[d].ptPosA.length;k++)e+=this.itemA[d].ptPosA[k].x,x+=this.itemA[d].ptPosA[k].y;
this.itemA[d].ptPos={x:e/this.itemA[d].nCount,y:x/this.itemA[d].nCount}}if(this.szMinAggregation){h=k=0;for(d in this.itemA)h+=this.itemA[d].nCount,k++;h/=k;for(d in this.itemA)this.itemA[d].nCount&&this.itemA[d].nCount<(this.nMinAggregation||h/2)&&delete this.itemA[d]}this.nMin=Number.MAX_VALUE;this.nMax=-Number.MAX_VALUE;this.nMinA=[];this.nMaxA=[];if(this.__fExact||this.szSizeField)for(d in this.itemA)isFinite(this.itemA[d].nSize)&&!isNaN(this.itemA[d].nSize)&&(this.nMin=this.nMinSize=Math.min(this.nMinSize,
this.itemA[d].nSize),this.nMax=this.nMaxSize=Math.max(this.nMaxSize,this.itemA[d].nSize),this.nSumSize+=this.itemA[d].nSize);else for(d in this.itemA)for(q=0;q<this.itemA[d].nValuesA.length;q++)isFinite(this.itemA[d].nValuesA[q])&&!isNaN(this.itemA[d].nValuesA[q])&&(this.nMin=Math.min(this.itemA[d].nValuesA[q],this.nMin),this.nMax=Math.max(this.itemA[d].nValuesA[q],this.nMax));for(d in this.itemA)for(q=0;q<this.itemA[d].nValuesA.length;q++)isFinite(this.itemA[d].nValuesA[q])&&!isNaN(this.itemA[d].nValuesA[q])?
(this.nMinA[q]=Math.min(this.itemA[d].nValuesA[q],this.nMinA[q]||Number.MAX_VALUE),this.nMaxA[q]=Math.max(this.itemA[d].nValuesA[q],this.nMaxA[q]||-Number.MAX_VALUE),this.nSumA[q]+=this.itemA[d].nValuesA[q]):(this.nMinA[q]=this.nMinA[q]||Number.MAX_VALUE,this.nMaxA[q]=this.nMaxA[q]||-Number.MAX_VALUE);if(this.szAlphaField)for(d in this.itemA)isFinite(this.itemA[d].nAlpha)&&!isNaN(this.itemA[d].nAlpha)&&(this.nMinAlpha=Math.min(this.nMinAlpha,this.itemA[d].nAlpha),this.nMaxAlpha=Math.max(this.nMaxAlpha,
this.itemA[d].nAlpha),this.nSumAlpha+=this.itemA[d].nAlpha);if(this.szSizeField)for(d in this.itemA)isFinite(this.itemA[d].nSize)&&!isNaN(this.itemA[d].nSize)&&(this.nMinSize=Math.min(this.nMinSize,this.itemA[d].nSize),this.nMaxSize=Math.max(this.nMaxSize,this.itemA[d].nSize),this.nSumSize+=this.itemA[d].nSize);if(this.szXField)for(d in this.itemA)isNaN(this.itemA[d].nX)||(this.nMinX=Math.min(this.nMinX,this.itemA[d].nX),this.nMaxX=Math.max(this.nMaxX,this.itemA[d].nX),this.nSumX+=this.itemA[d].nX);
if(this.szYField)for(d in this.itemA)isNaN(this.itemA[d].nY)||(this.nMinY=Math.min(this.nMinY,this.itemA[d].nY),this.nMaxY=Math.max(this.nMaxY,this.itemA[d].nY),this.nSumY+=this.itemA[d].nY);if(this.szValueField&&this.szSizeField==this.szValueField)for(d in this.itemA)this.itemA[d].szValue=String(this.itemA[d].nSize);this.oldSizefield&&(this.szSizeField=this.oldSizefield,this.oldSizeField=null);return this.fAnalyze=!0};
MapTheme.prototype.loadTableFromMap=function(){var c,a,d,b={table:{fields:0,records:0},fields:[],records:[]},f=SVGDocument.getElementById(this.szThemesA[0]);if(null==f){var e=map.Tiles.getTileNodes(this.szThemesA[0]);e&&(f=e[0])}if(!f)return this.szThemes="",null;f=f.getAttributeNS(szMapNs,"info");if(null==f||""===f)return this.szThemes="",null;f=f.split("|");f.push("FeatureId");for(c in f)b.fields.push({id:f[c]}),b.table.fields++;var f=[],l=[];for(c=0;c<this.szThemesA.length;c++){this.objTheme=this.objThemesA[this.szThemesA[c]];
e=map.Layer.getLayerObj(this.szThemesA[c]);if(null==e)return alert("MapTheme error: no layer like '"+this.szThemesA[c]+"'"),!1;if(e.szFlag.match(/tiled/)){l[0]=map.Scale.canvasNode;l.length=1;this.fDataIncomplete=!map.Tiles.allTilesLoaded();break}else l[l.length]=SVGDocument.getElementById(e.szName)}e=!0;for(a=0;a<l.length;a++){d=l[a].getElementsByTagName("path");var k=l[a].getElementsByTagName("use"),n=l[a].getElementsByTagName("circle");for(c=0;c<d.length;c++)f[f.length]=d.item(c);for(c=0;c<k.length;c++)f[f.length]=
k.item(c);for(c=0;c<n.length;c++)f[f.length]=n.item(c)}if(0===f.length)for(e=!1,a=0;a<l.length;a++)for(d=l[a].getElementsByTagName("g"),c=0;c<d.length;c++)f[f.length]=d.item(c);for(c=0;c<f.length;c++)if(1==f[c].nodeType&&f[c].hasAttributeNS(szMapNs,"info")){d=e?f[c].parentNode.getAttributeNS(null,"id"):f[c].getAttributeNS(null,"id");l=-1;if(d&&0!==d.length)for(k=map.Tiles.getMasterId(d).split(":")[0],a=0;a<this.szThemesA.length;a++)k==this.szThemesA[a]&&(l=a);a=map.Tiles.getMasterId(d);!this.itemA[a]&&
0<=l&&(l=f[c].getAttributeNS(szMapNs,"info").split("|"),l.push(a.split("::")[1]),b.records.push(l),b.table.records++,this.itemA[a]=1)}this.itemA=[];return b};
MapTheme.prototype.aggregateValues=function(){if(!(this.__fAggregateOnLoad||!this.szFlag.match(/AGGREGATE/)&&!this.szFlag.match(/GROUP/)||this.szAggregationUpper&&map.Scale.nTrueMapScale*map.Scale.nZoomScale>this.nAggregationUpper||this.szAggregationLower&&map.Scale.nTrueMapScale*map.Scale.nZoomScale<this.nAggregationLower)){var c=[],a=[],d=[],b=[],f=[],e=null,l=0;this.nTopicsSkipedByZeroExclusion=0;this.nGridWidthPx&&(this.nGridWidth=e=map.Scale.getDistanceInMeter(1E3,1E3,1E3+map.Scale.normalX(this.nGridWidthPx),
1E3));this.nGridMatrix&&(e=map.Zoom.getBox(),e=map.Scale.getDistanceInMeter(1E3,1E3,1E3+e.width,1E3),this.nGridWidth=e/(this.nGridMatrix||20)/map.Scale.nZoomScale);var k=this.nGridWidth?Math.round(map.Scale.getDeltaXofDistanceInMeter(this.nGridWidth)/20)*map.Scale.nZoomScale*20:0,e=function(a){for(var b in a)return b}(this.itemA),n="undefined",h=this.itemA[e].szSelectionId.split("::")[0],p=null,g=1.15*k,u=1.15*k/2,r=k/4;if(this.szAggregationField)for(var q in this.itemA){n="undefined";e=e||q;n=this.itemA[q].szAggregation;
c[n]||(c[n]=[],b[n]=new point(0,0),a[n]=0,d[n]=0,l++);c[n][q]=this.itemA[q];c[n][q].nSize=this.itemA[q].nSize||1;c[n][q].szTitle=this.itemA[q].szTitle||n;d[n]+=c[n][q].nSize;var t=this.getNodePosition(this.itemA[q].szSelectionId);t&&(b[n].x+=t.x,b[n].y+=t.y,a[n]++)}else if(this.nGridWidth)for(q in this.itemA)if(t=this.getNodePosition(this.itemA[q].szSelectionId)){if(this.szFlag.match(/\bRECT\b/))this.szFlag.match(/FIXGRID/)?(p=map.Scale.mapCenter.x*map.Scale.nZoomScale,n=map.Scale.mapCenter.y*map.Scale.nZoomScale,
p=new point(Math.round((t.x+p)/k)*k-p,Math.round((t.y+n)/k)*k-n)):p=new point(Math.round(t.x/k)*k,Math.round(t.y/k)*k);else{if(this.szFlag.match(/PLOTY/))p=Math.round(t.y/k),n=p%2?u:0,p=new point(Math.round((t.x+n)/g)*g-n,p*k);else var p=Math.round(t.x/k),x=p%2?u:0,p=new point(p*k,Math.round((t.y+x)/g)*g-x);if(Math.abs(z-t.x)>r){var n=[],E=[],x=0===x?u:0;z>t.x?(n[0]=new point(p.x-k,p.y-u),n[1]=new point(p.x-k,p.y+u)):(n[0]=new point(p.x+k,p.y-u),n[1]=new point(p.x+k,p.y+u));E[0]=Math.sqrt(Math.pow(n[0].x-
t.x,2)+Math.pow(n[0].y-t.y,2));E[1]=Math.sqrt(Math.pow(n[1].x-t.x,2)+Math.pow(n[1].y-t.y,2));E[3]=Math.sqrt(Math.pow(p.x-t.x,2)+Math.pow(p.y-t.y,2));E[0]<E[3]?p=new point(Math.round(n[0].x/k)*k,Math.round((n[0].y+x)/g)*g-x):E[1]<E[3]&&(p=new point(Math.round(n[1].x/k)*k,Math.round((n[1].y+x)/g)*g-x))}}n=h+"::"+String(p.x)+","+String(p.y);this.themeNodesPosA[q]=p;this.themeNodesPosA[n]=p;c[n]||(c[n]=[],b[n]=new point(0,0),a[n]=0,l++);c[n][q]=this.itemA[q];c[n][q].nSize=this.itemA[q].nSize||1;b[n].x+=
t.x;b[n].y+=t.y;a[n]++}else c[n]||(c[n]=[],b[n]=new point(0,0),a[n]=0,this.fDataIncomplete=fTilesLoaded,l++),c[n][q]=this.itemA[q],c[n][q].nSize=this.itemA[q].nSize||1,a[n]++,this.fDataIncomplete=!0;else for(q in this.itemA)(t=this.getNodePosition(this.itemA[q].szSelectionId))?(n=this.itemA[q].szSelectionId,c[n]||(c[n]=[],b[n]=new point(0,0),a[n]=0,l++),c[n][q]=this.itemA[q],c[n][q].nSize=this.itemA[q].nSize||1,b[n].x+=t.x,b[n].y+=t.y,a[n]++):(c[n]||(c[n]=[],b[n]=new point(0,0),a[n]=0,this.fDataIncomplete=
fTilesLoaded,l++),c[n][q]=this.itemA[q],c[n][q].nSize=this.itemA[q].nSize||1,a[n]++,this.fDataIncomplete=!0);if(this.szFlag.match(/GROUP/)){this.itemA=[];for(var B in c){l=c[B];this.indexA=[];for(q in l)this.indexA.push(q);for(var a=[],m=0;m<this.indexA.length;m++)a.push({a:this.indexA[m],y:l[this.indexA[m]].nValuesA[0]});this.szFlag.match(/\bUP\b/)?a.sort(this.sortDownChartObjectsCompare):a.sort(this.sortUpChartObjectsCompare);for(m in a)l[a[m].a].szSelectionId=B,this.itemA[B+"*"+Math.random()]=
l[a[m].a]}}else{if(this.szFlag.match(/CATEGORICAL/))for(B in this.szSizeField||(this.szSizeField="$aggregation$"),c){l=c[B];f[B]=0;x=[];for(q in l)f[B]++,x[l[q].nValuesA[0]]||(x[l[q].nValuesA[0]]={itemA:[]}),x[l[q].nValuesA[0]].itemA[q]=l[q];c[B]=[];for(m in x)for(q in l=x[m].itemA,h=null,l)null==h?(h=c[B][q]=l[q],h.nCount=1,h.dbIndexA=h.dbIndexA||[],h.nSize=h.nSize||1,h.nAlpha=h.nAlpha||1):(h.nCount+=1,h.nValue100+=l[q].nValue100,h.nSize+=l[q].nSize||1,h.nAlpha+=l[q].nAlpha||1,h.szValue=String(h.nSize),
k&&!this.szAggregationField&&(!h.szTitle||3<h.nCount)&&(h.szTitle="("+h.nCount+")"),h.dbIndexA.push(l[q].dbIndex))}else for(B in c){l=c[B];if(!this.szFlag.match(/SUM/)&&!this.szFlag.match(/ZEROISVALUE/)){k=[];x=0;for(q in l)if(x++,l[q])for(m=0;m<l[q].nValuesA.length;m++)if(0===l[q].nOrigValuesA[m]){k[q]=q;break}if(1<x)for(q in k)delete l[q],this.nTopicsSkipedByZeroExclusion++}c[B]=[];h=null;for(q in l)if(null==h)h=c[B][q]=l[q],h.nCount=1,h.dbIndexA=h.dbIndexA||[],h.nSize=h.nSize||1,h.nAlpha=h.nAlpha||
1;else{for(m=0;m<l[q].nValuesA.length;m++)h.nValuesA[m]+=l[q].nValuesA[m]||0,h.nOrigValuesA[m]+=l[q].nOrigValuesA[m]||0;h.nCount+=1;h.nValue100+=l[q].nValue100;h.nSize+=l[q].nSize||1;h.nAlpha+=l[q].nAlpha||1;h.szValue=String(h.nSize);h.szTitle="("+this.formatValue(h.nCount,0)+")";h.dbIndexA.push(l[q].dbIndex)}}if(this.szAggregationField||this.szFlag.match(/RELOCATE/)){var y=new point(0,0),A=0,m=1E6,k=0;for(B in c)m=Math.min(m,b[B].x/a[B]),A=Math.max(A,b[B].y/a[B]),y.x+=b[B].x*(d[B]||1),y.y+=b[B].y*
(d[B]||1),k+=a[B]*(d[B]||1);y.x/=k;y.y/=k;new point(m,y.y);A=new point(y.x,A)}this.nMin=Number.MAX_VALUE;this.nMax=-Number.MAX_VALUE;this.nMinSize=Number.MAX_VALUE;this.nSumSize=this.nMaxSize=0;this.nMinAlpha=Number.MAX_VALUE;this.nSumAlpha=this.nMaxAlpha=0;this.szFlag.match(/CATEGORICAL/)&&(this.nMinA=[],this.nMaxA=[],this.nSumA=[],this.nOrigMinA=[],this.nOrigMaxA=[],this.nOrigSumA=[],this.nMedianA=[],this.nMeanA=[],this.nCountA=[]);d="[";k=this.nStringToValue-1;for(m=0;m<k;m++)d+="0,";d+="]";this.itemA=
[];k=0;x=Math.max(this.szRangesA?this.szRangesA.length:0,this.szExactA?this.szExactA.length:0)-(this.szFlag.match(/CATEGORICAL/)?0:1);h=this.szFlag.match(/CATEGORICAL/)&&(this.szFlag.match(/PIE/)||this.szFlag.match(/BAR/)||this.szFlag.match(/SEQUENCE/)||this.szFlag.match(/PLOT/)||this.szFlag.match(/DOMINANT/)||this.szFlag.match(/\bUSER\b/)||this.szFlag.match(/WAFFLE/));for(B in c)if(k++,"undefined"!=B){var l=c[B],z;if(h){for(q in l){z=q;break}this.itemA[z]={};m=[];eval("nValuesA = "+d+";");this.itemA[z].szSelectionId=
z;this.itemA[z].szTitle=l[z].szTitle;if(this.szAggregationField||this.szFlag.match(/RELOCATE/))this.szFlag.match(/ALIGN/)?(this.itemA[z].szSelectionId=e,this.szFlag.match(/\bUP\b/)?this.themeNodesPosA[z]=new point(A.x,A.y):this.themeNodesPosA[z]=new point(y.x,y.y)):this.themeNodesPosA[z]=new point(b[B].x/a[B],b[B].y/a[B]);this.itemA[z].dbIndexA=[];u=g=0;for(q in l){m[l[q].nValuesA[0]-1]=l[q].nSize/(this.szFlag.match(/SUM/)?1:l[q].nCount);g+=l[q].nSize;u+=l[q].nCount;this.itemA[z].dbIndexA.push(l[q].dbIndex);
for(var v in l[q].dbIndexA)this.itemA[z].dbIndexA.push(l[q].dbIndexA[v]);delete this.itemA[z].dbIndex}this.itemA[z].nValuesA=this.itemA[z].nOrigValuesA=m;this.itemA[z].nMinA=[];this.itemA[z].nMaxA=[];this.itemA[z].nSize=g/(this.szFlag.match(/SUM/)?1:u);this.itemA[z].nCount=u;this.itemA[z].nAlpha=l[q].nAlpha;this.itemA[z].szTitle=this.nGridWidth&&!this.szAggregationField&&1<f[B]?__formatValue(f[B],0)+" item(s) aggregated":this.itemA[z].szTitle||B;this.itemA[z].szValue=this.itemA[z].szTitle;this.itemA[z].szLabel=
this.itemA[z].szTitle;this.nMin=this.nMinSize=Math.min(this.nMinSize,this.itemA[z].nSize);this.nMax=this.nMaxSize=Math.max(this.nMaxSize,this.itemA[z].nSize);this.nSumSize+=g/(this.szFlag.match(/SUM/)?1:u);this.nMinAlpha=Math.min(this.nMinAlpha,this.itemA[z].nAlpha);this.nMaxAlpha=Math.max(this.nMaxAlpha,this.itemA[z].nAlpha);this.nSumAlpha+=this.itemA[z].nAlpha;if(this.szFlag.match(/AUTO100/)){for(m=u=0;m<this.itemA[z].nValuesA.length;m++)u+=this.itemA[z].nValuesA[m]||0;this.itemA[z].nValue100=u;
this.fField100=!0;for(m=0;m<this.itemA[z].nValuesA.length;m++)this.itemA[z].nValuesA[m]=this.itemA[z].nOrigValuesA[m]/this.itemA[z].nValue100*100}if(this.szFlag.match(/CATEGORICAL/)&&(this.szFlag.match(/CATEGORICAL/)||!this.nNormalSizeValue)){if(!this.nMinA.length)for(m=0;m<this.itemA[z].nValuesA.length;m++)this.nMinA[m]=null,this.nMaxA[m]=null,this.nSumA[m]=0,this.nOrigMinA[m]=null,this.nOrigMaxA[m]=null,this.nOrigSumA[m]=0,this.nMedianA[m]=0,this.nMeanA[m]=0,this.nCountA[m]=0;for(m=0;m<this.itemA[z].nValuesA.length;m++)this.nMinA[m]=
Math.min(this.nMinA[m]||this.itemA[z].nValuesA[m],this.itemA[z].nValuesA[m]),this.nMaxA[m]=Math.max(this.nMaxA[m]||this.itemA[z].nValuesA[m],this.itemA[z].nValuesA[m]),this.nSumA[m]+=this.itemA[z].nValuesA[m],this.nOrigMinA[m]=Math.min(this.nOrigMinA[m]||this.itemA[z].nOrigValuesA[m],this.itemA[z].nOrigValuesA[m]),this.nOrigMaxA[m]=Math.max(this.nOrigMaxA[m]||this.itemA[z].nOrigValuesA[m],this.itemA[z].nOrigValuesA[m]),this.nOrigSumA[m]+=this.itemA[z].nOrigValuesA[m],this.itemA[z].nValuesA[m]&&this.nCountA[m]++}this.nCount=
k*x}else for(q in l)if(l[q]){g=q;this.szAggregationField||(g=B,this.itemA[g]&&(g=g.split("*")[0]+"*"+Math.random()));this.itemA[g]=l[q];l[q].szValue=l[q].szValue||1;this.nMinSize=Math.min(this.nMinSize,this.itemA[g].nSize);this.nMaxSize=Math.max(this.nMaxSize,this.itemA[g].nSize);this.nSumSize+=this.itemA[g].nSize;this.nMinAlpha=Math.min(this.nMinAlpha,this.itemA[g].nAlpha);this.nMaxAlpha=Math.max(this.nMaxAlpha,this.itemA[g].nAlpha);this.nSumAlpha+=this.itemA[g].nAlpha;this.szFlag.match(/SUM/)||
(u=this.szFlag.match(/SUM/)?1:l[q].nCount,this.itemA[g].nSize/=u,this.itemA[g].szValue/=u,this.itemA[g].nValue100/=u);if(this.nGridWidth||this.szAggregationField)for(u=this.szFlag.match(/SUM/)||this.szFlag.match(/CATEGORICAL/)?1:l[q].nCount,this.itemA[g].szSelectionId=q,m=0;m<this.itemA[g].nValuesA.length;m++)this.itemA[g].nValuesA[m]/=u,this.itemA[g].nOrigValuesA[m]/=u,this.itemA[g].nValue100&&(this.itemA[g].nValuesA[m]=this.itemA[g].nOrigValuesA[m]/this.itemA[g].nValue100,this.szFlag.match(/FRACTION/)||
(this.itemA[g].nValuesA[m]*=this.szFlag.match(/PERMILLE/)?1E3:100),this.szFlag.match(/INVERT/)&&(this.itemA[g].nValuesA[m]=100-this.itemA[g].nValuesA[m])),this.nMin=Math.min(this.itemA[g].nValuesA[m]||Number.MAX_VALUE,this.nMin||Number.MAX_VALUE),this.nMax=Math.max(this.itemA[g].nValuesA[m]||-Number.MAX_VALUE,this.nMax||-Number.MAX_VALUE);else this.nMin=Math.min(this.itemA[g].nSize,this.nMin||Number.MAX_VALUE),this.nMax=Math.max(this.itemA[g].nSize,this.nMax||-Number.MAX_VALUE);if(this.szFlag.match(/AUTO100/)){for(m=
u=0;m<this.itemA[g].nValuesA.length;m++)u+=this.itemA[g].nValuesA[m]||0;this.itemA[g].nValue100=u;this.fField100=!0;for(m=0;m<this.itemA[g].nValuesA.length;m++)this.itemA[g].nValuesA[m]=this.itemA[g].nOrigValuesA[m]/this.itemA[g].nValue100*100}if(this.szAggregationField||this.szFlag.match(/RELOCATE/))this.szFlag.match(/ALIGN/)?this.szFlag.match(/\bUP\b/)?this.themeNodesPosA[g]=new point(A.x,A.y):this.themeNodesPosA[g]=new point(y.x,y.y):(this.themeNodesPosA[q]=new point(b[B].x/a[B],b[B].y/a[B]),this.themeNodesPosA[g]=
new point(b[B].x/a[B],b[B].y/a[B]))}}if(this.szMinAggregation){c=u=0;for(q in this.itemA)c+=this.itemA[q].nCount,u++;c/=u;for(q in this.itemA)this.itemA[q].nCount&&this.itemA[q].nCount<(this.nMinAggregation||c/2)&&delete this.itemA[q];this.nMin=Number.MAX_VALUE;this.nMax=-Number.MAX_VALUE;for(q in this.itemA)for(m=0;m<this.itemA[q].nValuesA.length;m++)this.nMin=Math.min(this.itemA[q].nValuesA[m],this.nMin),this.nMax=Math.max(this.itemA[q].nValuesA[m],this.nMax)}this.fSorted=!0}}};
MapTheme.prototype.distributeValues=function(){if(0===this.nCount)return!1;if(this.szFlag.match(/OUTLIER/)){var c=this.szFieldsA.length;this.getMeanMedianQuantile();for(var a=0;a<c;a++){var d=[],b;for(b in this.itemA)this.itemA[b].nValuesA[a]&&d.push(this.itemA[b].nValuesA[a]);this.nDeviationA[a]=this.parent.getDeviationOfArray(d)}for(a=0;a<c;a++)for(b in this.itemA)Math.abs(this.itemA[b].nValuesA[a]-this.nMeanA[a])>3*this.nDeviationA[a]?this.szFlag.match(/NOOUTLIER/)&&delete this.itemA[b]:this.szFlag.match(/NOOUTLIER/)||
delete this.itemA[b];this.nMin=Number.MAX_VALUE;this.nMax=-Number.MAX_VALUE;for(b in this.itemA)for(var f=0;f<this.itemA[b].nValuesA.length;f++)this.nMin=Math.min(this.itemA[b].nValuesA[f],this.nMin),this.nMax=Math.max(this.itemA[b].nValuesA[f],this.nMax)}(this.szFlag.match(/AGGREGATE/)||this.szFlag.match(/GROUP/))&&this.aggregateValues();"$aggregation$"==this.szSizeField&&(this.szSizeField=null);if(this.szFlag.match(/CATEGORICAL/)&&(!this.szExactA||!this.szExactA.length)&&(this.szExactA=this.szExactA||
[],this.nStringToValueA))for(b in this.nStringToValueA)this.szExactA.push(this.nStringToValueA[b]);!this.szFlag.match(/CATEGORICAL/)||this.szLabelA&&this.szLabelA.length||!this.szValuesA||(this.szLabelA=this.szValuesA);if(this.szColorField)if(this.colorFieldA=[],this.colorClassA=[],this.colorClassUsedA=[],this.szColorValuesA)for(a in this.szColorValuesA)this.colorFieldA[this.szColorValuesA[a]]=!0;else if(this.szValuesA)for(a in this.szValuesA)this.colorFieldA[this.szValuesA[a]]=!0;else for(b in this.itemA)this.colorFieldA[this.itemA[b].szColor]=
!0;if(this.szSymbolField)if(this.symbolFieldA=[],this.szSymbolValuesA)for(a in this.szSymbolValuesA)this.symbolFieldA[this.szSymbolValuesA[a]]=this.szSymbolsA[a];else for(b in this.itemA)this.symbolFieldA[this.itemA[b].szSymbol]=this.szSymbolsA[a];this.origColorScheme||(this.origColorScheme=this.colorScheme=this.defaultColorScheme);if(isNaN(Number(this.origColorScheme[0])))this.colorScheme=this.origColorScheme.slice(0);else{!this.szFlag.match(/SEQUENCE/)&&!this.szFlag.match(/CLIP/)&&this.szFieldsA.length>
this.origColorScheme[0]&&(this.origColorScheme[0]=this.szFieldsA.length);this.szFlag.match(/CATEGORICAL/)&&(this.origColorScheme[0]=this.szExactA.length||1);if(this.szColorField){a=0;for(b in this.colorFieldA)a++;this.origColorScheme[0]=a}try{this.colorScheme=ColorScheme.createColorScheme(this.origColorScheme[1],this.origColorScheme[2],this.origColorScheme[0],this.origColorScheme[3],this.origColorScheme[4])}catch(e){this.colorScheme=this.defaultColorScheme}if(this.szFlag.match(/CATEGORICAL/)&&this.szFlag.match(/ORDER/)){c=
this.colorScheme.slice();d=this.szValuesA?this.szValuesA.slice():this.szLabelA.slice();if(this.szColorField)for(b in d=[],this.colorFieldA)d.push(b),this.getStringValueIndex(b,"set");if(d.length&&c.length&&d.length==c.length)for(d.sort(),this.colorScheme=[],a=0;a<d.length;a++)this.colorScheme[this.nStringToValueA[d[a]]-1]=c[a]}}if(this.szColorField){a=0;for(b in this.colorFieldA)this.colorClassA[b]=a,this.colorFieldA[b]=this.colorScheme[a++];for(b in this.itemA)this.itemA[b].nClass=this.colorClassA[this.itemA[b].szColor],
this.itemA[b].szColor=this.colorFieldA[this.itemA[b].szColor]}if(this.szSymbolField)for(b in this.itemA)this.itemA[b].szSymbol=this.symbolFieldA[this.itemA[b].szSymbol];if(this.colorScheme[0].match(/user/i))try{HTMLWindow.ixmaps.htmlgui_colorScheme(this)}catch(l){}if(this.szFlag.match(/DOMINANT/))for(;this.colorScheme.length<this.szFieldsA.length;)this.colorScheme[this.colorScheme.length]="#dddddd";if(this.szFieldsA)if(this.colorScheme.length<this.szFieldsA.length&&this.nGridX)for(;this.colorScheme.length<
this.nGridX;)this.colorScheme[this.colorScheme.length]=this.colorScheme[this.colorScheme.length-1]||"#dddddd";else if(!this.szFlag.match(/CLIP/))for(;this.colorScheme.length<this.szFieldsA.length;)this.colorScheme[this.colorScheme.length]=this.colorScheme[this.colorScheme.length-1]||"#dddddd";if(this.szFlag.match(/NORMALIZE/)&&this.nMax){var k=this.nMax-this.nMin;for(b in this.itemA)this.itemA[b].nValuesA[0]=(this.itemA[b].nValuesA[0]-this.nMin)/k;this.nMin=0;this.nMax=1}if(this.szFlag.match(/HARMONIZE/)&&
this.nMax){if(this.nMaxA){this.nRangeA=[];for(f in this.nMaxA)this.nRangeA.push(this.nMaxA[f]-this.nMinA[f]);for(b in this.itemA)for(f in this.itemA[b].nValuesA)this.itemA[b].nValuesA[f]=(this.itemA[b].nValuesA[f]-this.nMinA[f])/this.nRangeA[f];for(f in this.nMaxA)this.nMinA[f]=0,this.nMaxA[f]=1}else{for(b in this.itemA)this.itemA[b].nValuesA[0]/=this.nMax;this.nMin/=this.nMax;this.nMax/=this.nMax}this.nMin=0;this.nMax=1}if(this.szFlag.match(/INVERTSIZE/)&&this.szSizeField){for(b in this.itemA)this.itemA[b].nSize=
this.nMaxSize-this.itemA[b].nSize;this.nNormalSizeValue=this.nNormalSizeValue||this.nMaxSize}this.szFlag.match(/CATEGORICAL/)||this.szFlag.match(/SEQUENCE/)||this.getMeanMedianQuantile();c=this.colorScheme.length;k=this.nMax-this.nMin;f=this.nMin;d=this.nMax;null==this.nRangeCenterValue||isNaN(this.nRangeCenterValue)||(a=Math.max(Math.abs(this.nRangeCenterValue-f),Math.abs(d-this.nRangeCenterValue)),f=this.nRangeCenterValue-a,d=this.nRangeCenterValue+a,k=d-f);if(this.szFlag.match(/INTEGER/))c>k?c=
k:c>k/2?c=Math.floor(k/2):k+=c-k%c;else{var n=1;for(this.szField100&&(n=.01);k>1E3*n;)n*=10;1<n?(f=Math.floor(f/n)*n,d=Math.ceil(d/n)*n):d+=d/1E5;k=d-f}if(this.szColorField)for(b in this.nRangesA=[],a=0,this.colorFieldA)this.nRangesA.push(a++);else this.nRangesA=this.szRangesA||this.szExactA;if(this.nRangesA&&this.nRangesA.length){c=this.nRangesA.length-(this.szFlag.match(/CATEGORICAL/)?0:1);if(this.szSymbolsA&&this.szSymbolsA.length)for(;this.szSymbolsA.length<c;)this.szSymbolsA[this.szSymbolsA.length]=
this.szSymbolsA[this.szSymbolsA.length-1];if(this.colorScheme&&this.colorScheme.length)for(;this.colorScheme.length<c;)this.colorScheme[this.colorScheme.length]=this.colorScheme[this.colorScheme.length-1]||"#dddddd";this.partsA=[];for(a=0;a<c;a++)f=Number(this.nRangesA[a]),d=Number(this.nRangesA[a+(this.szFlag.match(/CATEGORICAL/)?0:1)])+1E-9,this.partsA[this.partsA.length]={min:f,max:d,color:this.colorScheme[a],nCount:0,nSum:0};if(this.szFlag.match(/CATEGORICAL/)&&this.exactCountA)for(a=0;a<c;a++)this.partsA[a].nCount=
this.exactCountA[a];if(this.szFlag.match(/PLOTVAR/)||this.szFlag.match(/DOMINANT/))for(this.getMeanMedianQuantile(),a=0;a<c;a++){d=[];for(b in this.itemA)this.itemA[b].nValuesA[a]&&d.push(this.itemA[b].nValuesA[a]);this.nDeviationA[a]=this.parent.getDeviationOfArray(d);this.szDominantFilter=this.szDominantFilter||"min";this.nDominantDFilter=this.nDominantDFilter||0;this.szDominantFilter.match(/min/)?this.nFilterA[a]=this.nMinA[a]+(this.nMaxA[a]-this.nMinA[a])/100*this.nDominantDFilter:this.szDominantFilter.match(/max/)?
this.nFilterA[a]=this.nMinA[a]+(this.nMaxA[a]-this.nMinA[a])/100*this.nDominantDFilter:this.szDominantFilter.match(/mean/)?this.nFilterA[a]=this.nMeanA[a]+(this.nMaxA[a]-this.nMeanA[a])/100*this.nDominantDFilter:this.szDominantFilter.match(/median/)&&(this.nFilterA[a]=this.nMedianA[a]+(this.nMaxA[a]-this.nMedianA[a])/100*this.nDominantDFilter)}}else{k/=c;k>n&&(k=Math.floor(k/n)*n);this.nMin==this.nMax&&(c=1);this.partsA=[];for(a=0;a<c;a++)this.partsA[this.partsA.length]={min:f+a*k,max:f+(a+1)*k,color:this.colorScheme[a],
nCount:0,nSum:0};this.partsA[this.partsA.length-1].max=d;if(this.szFlag.match(/QUANTILE/)){this.getMeanMedianQuantile();n=Math.round(this.quantileA[0].length/c);for(a=0;a<this.partsA.length;a++)this.partsA[a].min=this.quantileA[0][a*n],this.partsA[a].max=this.quantileA[0][(a+1)*n];this.partsA[this.partsA.length-1].max=d}if(this.szFlag.match(/LOG/)){f=Math.log(this.nMin?this.nMin:Math.min(.1,this.nMax/10));k=Math.log(this.nMax?this.nMax:.1)-f;k/=c;this.partsA=[];for(a=0;a<c;a++)this.partsA[this.partsA.length]=
{min:Math.exp(f+a*k),max:Math.exp(f+(a+1)*k),color:this.colorScheme[a],nCount:0,nSum:0};this.partsA[this.partsA.length-1].max=this.nMax}else if(this.szFlag.match(/POW2/)){f=Math.pow(this.nMin?this.nMin:1,.5);k=Math.pow(this.nMax?this.nMax:1,.5)-Math.pow(this.nMin?this.nMin:1,.5);k/=c;this.partsA=[];for(a=0;a<c;a++)this.partsA[this.partsA.length]={min:Math.pow(f+a*k,2),max:Math.pow(f+(a+1)*k,2),color:this.colorScheme[a],nCount:0,nSum:0};this.partsA[this.partsA.length-1].max=this.nMax}else if(this.szFlag.match(/POW3/)){f=
Math.pow(this.nMin?this.nMin:1,1/3);k=Math.pow(this.nMax?this.nMax:1,1/3)-Math.pow(this.nMin?this.nMin:1,1/3);k/=c;this.partsA=[];for(a=0;a<c;a++)this.partsA[this.partsA.length]={min:Math.pow(f+a*k,3),max:Math.pow(f+(a+1)*k,3),color:this.colorScheme[a],nCount:0,nSum:0};this.partsA[this.partsA.length-1].max=this.nMax}if(this.szFlag.match(/DOMINANT/)||this.szFlag.match(/OFFSETMEAN/)||this.szFlag.match(/OFFSETMEDIAN/)||this.szFlag.match(/DEVIATION/)||this.szFlag.match(/PLOTVAR/)){this.getMeanMedianQuantile();
for(a=0;a<this.szFieldsA.length;a++){n=[];for(b in this.itemA)this.itemA[b].nValuesA[a]&&n.push(this.itemA[b].nValuesA[a]);"$item$"!=this.szFieldsA[a]&&n.sort(this.sortUp);this.nMedianA[a]=n[Math.round(n.length/2)];this.nSum100?this.szFlag.match(/DIFFERENCE/)?this.nMeanA[a]=this.nSumA[a]/this.nCount:(this.nMeanA[a]=this.nOrigSumA[a]/this.nSum100,this.szFlag.match(/FRACTION/)?this.nMeanA[a]*=this.nFractionScale||1:this.szFlag.match(/PERMILLE/)?this.nMeanA[a]*=1E3:(this.nMeanA[a]*=100,this.szFlag.match(/RELATIVE/)?
this.nMeanA[a]-=100:this.szFlag.match(/INVERT/)&&(this.nMeanA[a]=100-this.nMeanA[a]))):this.nMeanA[a]=this.nSumA[a]/this.nCount}for(a=0;a<this.partsA.length;a++)this.szDominantFilter=this.szDominantFilter||"min",this.nDominantDFilter=this.nDominantDFilter||0,this.szDominantFilter.match(/min/)?this.nFilterA[a]=this.nMinA[a]+(this.nMaxA[a]-this.nMinA[a])/100*this.nDominantDFilter:this.szDominantFilter.match(/max/)?this.nFilterA[a]=this.nMinA[a]+(this.nMaxA[a]-this.nMinA[a])/100*this.nDominantDFilter:
this.szDominantFilter.match(/mean/)?this.nFilterA[a]=this.nMeanA[a]+(this.nMaxA[a]-this.nMeanA[a])/100*this.nDominantDFilter:this.szDominantFilter.match(/median/)&&(this.nFilterA[a]=this.nMedianA[a]+(this.nMaxA[a]-this.nMedianA[a])/100*this.nDominantDFilter);if(this.szFlag.match(/DEVIATION/)||this.szFlag.match(/PLOTVAR/))for(a=0;a<this.szFieldsA.length;a++){d=[];for(b in this.itemA)this.itemA[b].nValuesA[a]&&d.push(this.itemA[b].nValuesA[a]);this.nDeviationA[a]=this.parent.getDeviationOfArray(d)}}}this.partsA[this.partsA.length-
1].max+=.001;this.szColorField&&(this.nRangesA=this.szRangesA||this.szExactA);this.szFlag.match(/COMPOSECOLOR/)&&__maptheme_initComposedColor(this.colorScheme.slice(0));return!0};MapTheme.prototype.sortUp=function(c,a){return c-a};MapTheme.prototype.sortIndexUp=function(c,a){return c.value-a.value};MapTheme.prototype.sortIndexDown=function(c,a){return a.value-c.value};MapTheme.prototype.sortPartsUp=function(c,a){return c.nCount-a.nCount};MapTheme.prototype.sortMeanUp=function(c,a){return c.mean-a.mean};
MapTheme.prototype.shuffleArray=function(c,a){for(var d=c.length-1;0<d;d--){var b=Math.floor((a&&a[d]?a[d]:Math.random())*d+1),f=c[d];c[d]=c[b];c[b]=f}};MapTheme.prototype.getRandomNumberArray=function(c){for(var a=[],d=0;d<c;d++)a.push(Math.random());return a};
var sum_composecolor_intensity=0,mean_composecolor_intensity=0,__maptheme_initComposedColor=function(c){for(var a=mean_composecolor_intensity=sum_composecolor_intensity=0;a<c.length;a++){var d=ColorScheme.getHexaColor(c[a]);mean_composecolor_intensity+=Math.max(Math.max(parseInt(d.substr(1,2),16),parseInt(d.substr(3,2),16)),parseInt(d.substr(5,2),16));sum_composecolor_intensity+=parseInt(d.substr(1,2),16)+parseInt(d.substr(3,2),16)+parseInt(d.substr(5,2),16)}sum_composecolor_intensity/=c.length;mean_composecolor_intensity/=
c.length},__maptheme_getComposedColor_additive=function(c,a,d,b){for(var f=0,e=0,l=0,k=0;k<c.length;k++)var n=ColorScheme.getHexaColor(a[k]),f=f+parseInt(n.substr(1,2),16)*((c[k]||0)/(d||1)),e=e+parseInt(n.substr(3,2),16)*((c[k]||0)/(d||1)),l=l+parseInt(n.substr(5,2),16)*((c[k]||0)/(d||1));c=Math.max(Math.max(f,e),l);f=Math.floor(f/c*(b||mean_composecolor_intensity));e=Math.floor(e/c*(b||mean_composecolor_intensity));l=Math.floor(l/c*(b||mean_composecolor_intensity));return ColorScheme.getHexaColor("rgb("+
f+","+e+","+l+")")},__maptheme_getComposedColor_subtractive=function(c,a,d,b){b=b||Math.min(Math.floor(sum_composecolor_intensity),300)||255;for(var f=0,e=0,l=0,k=0;k<c.length;k++)var n=ColorScheme.getHexaColor(a[k]),f=f+(255-parseInt(n.substr(1,2),16))*((c[k]||0)/(d||1)),e=e+(255-parseInt(n.substr(3,2),16))*((c[k]||0)/(d||1)),l=l+(255-parseInt(n.substr(5,2),16))*((c[k]||0)/(d||1));c=Math.max(Math.max(f,e),l);f=Math.min(255,b-Math.floor(f/c*mean_composecolor_intensity));e=Math.min(255,b-Math.floor(e/
c*mean_composecolor_intensity));l=Math.min(255,b-Math.floor(l/c*mean_composecolor_intensity));return ColorScheme.getHexaColor("rgb("+f+","+e+","+l+")")};
MapTheme.prototype.paintMap=function(c){if(this.nChartUpper&&map.Scale.nTrueMapScale*map.Scale.nZoomScale>this.nChartUpper)this.unpaintMap(),this.fVisible=!1,this.realizeDone();else if(this.nChartLower&&map.Scale.nTrueMapScale*map.Scale.nZoomScale<=this.nChartLower)this.unpaintMap(),this.fVisible=!1,this.realizeDone();else{this.beginDraw();this.mapSleep&&(this.mapSleep.checkSleepMessage="painting map");var a=0,d=0,b=0,f=0,e=0,l=0,k="",n="";map.Dictionary.getLocalText("of mean");map.Dictionary.getLocalText("of median");
var h=!1,p=0,g=b=k=0,f=null;this.fillOpacity=this.fillOpacity?this.fillOpacity:this.nOpacity;this.szStyle="fill-opacity:"+String(this.fillOpacity?this.fillOpacity:fTransparentMap?.6:1);this.autoOpacity&&(this.szStyle="fill-opacity:"+String(Math.max(.3,Math.min(1,.3+.7/Math.max(1,Math.log(map.Zoom.nZoom))))));this.szShapeType.match(/line/)&&(this.szStyle=this.fillOpacity?"stroke-opacity:"+this.fillOpacity+";":"stroke-opacity:1");if(!c||0===c){c=0;this.indexA=[];for(g in this.itemA)this.indexA[this.indexA.length]=
g,this.itemA[g].todo=!0;this.nDoneCount=0}for(;c<this.indexA.length;c++){if(this.mapSleep&&(this.mapSleep.nDoneCount=this.nDoneCount,this.mapSleep.checkSleep(c,10))){this.fContinue=!0;this.continueIndex=c;this.szItemFilter&&this.szItemFilter.length&&this.filterItems(this.szItemFilter,this.itemFilterOpt);return}g=this.indexA[c];this.nDoneCount++;h=!1;p=0;if(this.szFlag.match(/COMPOSECOLOR/)){a=this.szFlag.match(/SUBTRACTIVE/)?__maptheme_getComposedColor_subtractive(this.itemA[g].nValuesA,this.colorScheme,
this.nMax,Math.floor(255*this.nBrightness)):__maptheme_getComposedColor_additive(this.itemA[g].nValuesA,this.colorScheme,this.nMax,Math.floor(255*this.nBrightness));f=this.getItemNodes(g);for(b=0;b<f.length;b++)if(e=this.paintShape(f[b],a,-1,-1),this.szFlag.match(/DOPACITY/)){if(this.szAlphaField)l=0,"undefined"!=typeof this.itemA[g].nAlpha&&(l=1/(this.nDopacityPow||1),l=(this.nDopacityScale||1)/Math.pow(this.nMaxAlpha,l)*Math.pow(this.itemA[g].nAlpha,l));else var l=1/(this.nDopacityPow||1),p=(isNaN(this.itemA[g].nValueSum)?
0:this.itemA[g].nValueSum)/(this.itemA[g].nValue100/100||1),u=isNaN(this.nMax)?0:this.nMax,l=(this.nDopacityScale||1)*Math.pow(p,l)/Math.pow(u,l);e.style.setProperty("fill-opacity",String(l),"")}h=!0}else if(this.szFlag.match(/DOMINANT/)){for(var h=!0,r=-1,k=0;k<this.itemA[g].nValuesA.length;k++)a=this.itemA[g].nValuesA[k],d=100/this.nMeanA[k]*a,b=100/this.nMedianA[k]*a,f=(a-this.nMeanA[k])/this.nDeviationA[k],e=a,this.szFlag.match(/PERCENTOFMEAN/)&&(e=d),this.szFlag.match(/PERCENTOFMEDIAN/)&&(e=
b),this.szFlag.match(/DEVIATION/)&&(e=f),a>this.nFilterA[k]&&e>p&&(this.itemA[g].nClass=k,p=e,r=k);if(0<=r){this.itemA[g].nDominant=r;a=this.itemA[g].nValuesA[r];k=" "+this.szFieldsA[r]+" ";this.szLabelA&&this.szLabelA[r]&&(k=" "+this.szLabelA[r]+" ");if(this.szFlag.match(/PERCENTOFMEAN/)||this.szFlag.match(/DEVIATION/))n=map.Dictionary.getLocalText(" ( mean: ")+this.formatValue(this.nMeanA[r],1)+this.szUnit+")";this.szFlag.match(/PERCENTOFMEDIAN/)&&(n=map.Dictionary.getLocalText(" ( median: ")+this.formatValue(this.nMedianA[r],
1)+this.szUnit+")");this.itemA[g].nValue=this.itemA[g].nValuesA[r];this.itemA[g].szLabel=k;this.itemA[g].szColor=this.colorScheme[r];this.itemA[g].nClass=r;f=this.getItemNodes(g);for(b=0;b<f.length;b++)e=this.paintShape(f[b],this.colorScheme[r],this.itemA[g].nValue,r),e.setAttributeNS(szMapNs,"tooltip",this.formatValue(a,2)+this.szUnit+k+n),this.szFlag.match(/DOPACITY/)&&(l=u=p=0,p=isNaN(this.itemA[g].nValuesA[r])?0:this.itemA[g].nValuesA[r],u=isNaN(this.nMaxA[r])?0:this.nMaxA[r],this.szAlphaField?
(l=0,"undefined"!=typeof this.itemA[g].nAlpha&&(l=1/(this.nDopacityPow||1),l=(this.nDopacityScale||1)/Math.pow(this.nMaxAlpha,l)*Math.pow(this.itemA[g].nAlpha,l))):this.szFlag.match(/DOPACITYLOGMEAN/)?l=Math.log((this.nDopacityScale||1)*(d-100))/Math.log(100):this.szFlag.match(/DOPACITYPOWMEAN/)?(l=1/(this.nDopacityPow||1),l=Math.pow((this.nDopacityScale||1)*(d-100),l)/Math.pow(100,l)):this.szFlag.match(/DOPACITYMEAN/)?(l=1/(this.nDopacityPow||1),l=Math.pow((this.nDopacityScale||1)*(d-100),l)/Math.pow(100,
l)):this.szFlag.match(/DOPACITYLOGMAX/)?l=Math.log(p)/Math.log(u):this.szFlag.match(/DOPACITYPOWMAX/)?(l=1/(this.nDopacityPow||1),l=(this.nDopacityScale||1)*Math.pow(p,l)/Math.pow(u,l)):this.szFlag.match(/DOPACITYMAX/)?(l=1/(this.nDopacityPow||1),l=(this.nDopacityScale||1)*Math.pow(p,l)/Math.pow(u,l)):l=Math.log((this.nDopacityScale||1)*p)/Math.log(u),l=1E-4>l?0:l,l=Math.min(this.nOpacity||.9,l),this.autoOpacity&&(l*=Math.max(.3,Math.min(1,.3+.7/Math.max(1,Math.log(map.Zoom.nZoom))))),e.style.setProperty("fill-opacity",
String(l),""));this.partsA[r].nCount++}else for(f=this.getItemNodes(g),b=0;b<f.length;b++)this.unPaintShape(f[b]),f[b].removeAttributeNS(szMapNs,"tooltip")}else for(a=this.szFlag.match(/\bCLIP\b/)&&this.nClipFrames?this.nClipFrames==this.itemA[g].nValuesA.length?Number(this.itemA[g].nValuesA[this.nActualFrame]):this.itemA[g].nValuesA[0]*(this.nClipFrames-1-this.nActualFrame)/(this.nClipFrames-1)+this.itemA[g].nValuesA[1]*this.nActualFrame/(this.nClipFrames-1):this.itemA[g].nValuesA[0],k=0;k<this.partsA.length;k++)if(a<
this.partsA[k].max){this.itemA[g].nValue=a;this.itemA[g].szColor=this.partsA[k].color;this.itemA[g].nClass=k;if(this.itemA[g].todo){f=this.getItemNodes(g);for(b=0;b<f.length;b++)e=this.paintShape(f[b],this.partsA[k].color,a,k),this.szLabelA&&this.szLabelA[k]&&this.szFlag.match(/CATEGORICAL/)?e.setAttributeNS(szMapNs,"tooltip",this.szLabelA[k]):this.itemA[g].nValue100?e.setAttributeNS(szMapNs,"tooltip",this.formatValue(a,2)+this.szUnit):(e.setAttributeNS(szMapNs,"tooltip",this.formatValue(a,2)+this.szUnit),
e.setAttributeNS(szMapNs,"tooltip",this.itemA[g].szTitle+" "+this.formatValue(a,2)+this.szUnit)),this.szFlag.match(/DOPACITY/)&&(this.szAlphaField?(l=0,"undefined"!=typeof this.itemA[g].nAlpha&&(l=1/(this.nDopacityPow||1),l=(this.nDopacityScale||1)/Math.pow(this.nMaxAlpha,l)*Math.pow(this.itemA[g].nAlpha,l))):0>this.nMin&&0<this.nMax?(l=0,this.szFlag.match(/DOPACITYMAX/)?(l=1/(this.nDopacityPow||1),l=Math.pow(Math.abs(a),l)/Math.pow(this.nMedianA[0]-this.nMin,l)*(this.fillOpacity||1)*(this.nDopacityScale||
1)):l=this.szFlag.match(/DOPACITYLOG/)?Math.log(Math.abs(a))/Math.log(this.nMedianA[0]-this.nMin)*.5*(this.fillOpacity||1)*(this.nDopacityScale||1):Math.abs(a)/(this.nMedianA[0]-this.nMin)*.5*(this.fillOpacity||1)*(this.nDopacityScale||1)):this.szFlag.match(/BIPOLAR/)||this.szFlag.match(/DOPACITYMINMAX/)?(l=0,this.szFlag.match(/DOPACITYMAX/)?(l=1/(this.nDopacityPow||1),l=a>=this.nMeanA[0]?Math.pow(Math.abs(a-this.nMeanA[0]),l)/Math.pow(Math.abs(this.nMax-this.nMeanA[0]),l)*(this.fillOpacity||1)*(this.nDopacityScale||
1):Math.pow(Math.abs(this.nMeanA[0]-a),l)/Math.pow(Math.abs(this.nMeanA[0]-this.nMin),l)*(this.fillOpacity||1)*(this.nDopacityScale||1)):this.szFlag.match(/DOPACITYLOG/)?l=a>=this.nMedianA[0]?Math.log(Math.abs(a-this.nMedianA[0]))/Math.log(this.nMax-this.nMedianA[0])*(this.fillOpacity||1)*(this.nDopacityScale||1):Math.log(Math.abs(a-this.nMedianA[0]))/Math.log(this.nMedianA[0]-this.nMin)*(this.fillOpacity||1)*(this.nDopacityScale||1):(l=1/(this.nDopacityPow||1),l=a>=this.nMedianA[0]?Math.pow(Math.abs(a-
this.nMedianA[0]),l)/Math.pow(this.nMax-this.nMedianA[0],l)*(this.fillOpacity||1)*(this.nDopacityScale||1):Math.pow(Math.abs(a-this.nMedianA[0]),l)/Math.pow(this.nMedianA[0]-this.nMin,l)*(this.fillOpacity||1)*(this.nDopacityScale||1))):this.szFlag.match(/DOPACITYMIN/)?(l=1/(this.nDopacityPow||1),l=Math.pow(this.nMax-a,l)/Math.pow(this.nMax-this.nMin,l)*(this.fillOpacity||1)*(this.nDopacityScale||1)):this.szFlag.match(/DOPACITYMAX/)?(l=1/(this.nDopacityPow||1),l=Math.pow(a-this.nMin,l)/Math.pow(this.nMax-
this.nMin,l)*(this.fillOpacity||1)*(this.nDopacityScale||1)):this.szFlag.match(/DOPACITYLOG/)?l=Math.log(a-this.nMin)/Math.log(this.nMedianA[0]-this.nMin)*.5*(this.fillOpacity||1)*(this.nDopacityScale||1):this.szFlag.match(/DOPACITY/)&&(l=(a-this.nMin)/(this.nMedianA[0]-this.nMin)*.5*(this.fillOpacity||1)*(this.nDopacityScale||1)),l=1E-4>l?0:l,l=Math.min(this.nOpacity||.9,l),this.autoOpacity&&(l*=Math.max(.3,Math.min(1,.3+.7/Math.max(1,Math.log(map.Zoom.nZoom))))),e.style.setProperty("fill-opacity",
String(l),""));this.itemA[g].todo=!1}this.partsA[k].nCount++;this.partsA[k].nSum+=a;h=!0;break}if(!h)for(this.itemA[g].szColor=this.szNoDataColor?this.szNoDataColor:"white",f=this.getItemNodes(g),b=0;b<f.length;b++)e=this.paintShape(f[b],this.szNoDataColor?this.szNoDataColor:"white",-1,-1),e.setAttributeNS(szMapNs,"tooltip","no value"),this.szFlag.match(/DOPACITY/)&&e.style.setProperty("fill-opacity","0",""),this.nNoData++}this.isVisible=!0;this.realizeDone();this.fShowProgressBar=!1;this.showInfo();
this.endDraw();this.szItemFilter&&this.szItemFilter.length&&this.filterItems(this.szItemFilter,this.itemFilterOpt);this.szFlag.match(/\bCLIP\b/)?this.nClipFrames==this.itemA[g].nValuesA.length?this.szXaxisA&&this.szXaxisA[this.nActualFrame]?displayMessage(this.szXaxisA[this.nActualFrame],3E3,"big"):this.szLabelA&&this.szLabelA[this.nActualFrame]&&displayMessage(this.szLabelA[this.nActualFrame],3E3,"big"):(d=this.szXaxisA||this.szLabelA)&&(0===this.nActualFrame?displayMessage(d[0],3E3,"big"):this.nActualFrame==
this.nClipFrames-1?displayMessage(d[1],3E3,"big"):displayMessage(" ... ",3E3,"big")):this.ErrorMessage?(displayMessage(this.ErrorMessage,1E4,"notify"),this.ErrorMessage=null):clearMessage();this.szFlag.match(/VALUES/)&&(!this.szValueUpper||map.Scale.nTrueMapScale*map.Scale.nZoomScale<=this.nValueUpper)?(this.mapSleep&&this.mapSleep.initCheckSleep(25),this.fContinue=this.fMakeLabel=!0,this.nActualFrame=this.nMissingPositionCount=this.nMissingRangeCount=this.nZeroValueCount=this.nRealizedCount=this.nSkipCount=
this.nDoneCount=this.continueIndex=0,setTimeout(function(){map.Themes.executeContinue()},1E3)):this.unlabelMap()}};
MapTheme.prototype.unpaintMap=function(){if(this.szFlag.match(/FEATURE/))this.chartGroup&&map.Dom.clearGroup(this.chartGroup);else if(this.szFlag.match(/CHART/)){if(this.chartGroup){if(0===this.chartGroup.childNodes.length&&this.itemA){var c=null,a;for(a in this.itemA)(c=SVGDocument.getElementById(this.szId+":"+a+":chartgroup"))&&c.parentNode.removeChild(c)}map.Dom.clearGroup(this.chartGroup)}}else{this.beginDraw();for(c=0;c<this.paintedShapeNodesA.length;c++)this.unPaintShape(this.paintedShapeNodesA[c]),
this.paintedShapeNodesA[c].removeAttributeNS(szMapNs,"tooltip");this.paintedShapeNodesA.length=0;this.unlabelMap();this.endDraw();this.isVisible=!1;this.checkVisible();setTimeout(function(){map.Layer.adaptLabel(null)},10)}};
MapTheme.prototype.paintShape=function(c,a,d,b){this.paintedShapeNodesA.push(c);switch(this.szShapeType){case "line":c.setAttributeNS(null,"style","fill:none;stroke:"+a+";"+this.szStyle);break;case "line+buffer":var f=c.getAttributeNS(null,"id");if(!f.match(":paint")){var e=SVGDocument.getElementById(f+":paint");e||(e=c.cloneNode(1E3),c.parentNode.insertBefore(e,c),e.setAttributeNS(null,"id",f+":paint"));c=e}f=4;if(this.nBufferSize)if(this.nBufferSize.match(/\$value\$/)){d=this.nBufferSize.split("$value$");
f="";for(e=0;e<d.length;e++)f+=d[e],e<d.length-1&&(f+="nValue");f=eval(f)}else f=this.nBufferSize.match(/value/)?1E3<100/(this.nMin+1E-9)*(this.nMax-this.nMin)?6+Math.log(d/this.nMax):10*d/(this.nMax-this.nMin):this.nBufferSize;f*=Math.log(1+1/__featureScaling_lastScale);c.setAttributeNS(null,"style","stroke:"+a+";stroke-width:"+map.Scale.normalX(f)*map.Scale.nZoomScale+";"+this.szStyle+";stroke-linecap:butt;");break;default:c.setAttributeNS(null,"style","fill:"+a+";"+this.szStyle)}c.setAttributeNS(szMapNs,
"class",b);return c};MapTheme.prototype.unPaintShape=function(c){if("line+buffer"==this.szShapeType){var a=c.getAttributeNS(null,"id");(a=SVGDocument.getElementById(a+":paint"))&&a.parentNode.removeChild(a)}c.removeAttributeNS(null,"style");c.removeAttributeNS(szMapNs,"class")};
MapTheme.prototype.zoomToClass=function(c,a){var d=0;if(this.szFlag.match(/DOMINANT/))for(var b in this.itemA)this.itemA[b].nClass==c&&d++;else d=this.partsA[c].nCount;if(0===d)displayMessage("No members !");else{var f,e=null;if(this.szFlag.match(/CHART/))for(b=this.chartGroup.childNodes,f=0;f<b.length;f++)if(d=b.item(f),null==d.getAttributeNS(szMapNs,"class")||""===d.getAttributeNS(szMapNs,"class"))for(var d=d.firstChild.childNodes,l=0;l<d.length;l++)d.item(l).getAttributeNS(szMapNs,"class");else d.getAttributeNS(szMapNs,
"class");else if(this.szFlag.match(/DOMINANT/))for(b in this.itemA)if(this.itemA[b].nClass==c&&"highlight"==this.evidenceMode)for(e=this.getItemNodes(b),f=0;f<e.length;f++);else{if(this.itemA[b].nClass!=c&&"highlight"!=this.evidenceMode)for(e=this.getItemNodes(b),f=0;f<e.length;f++);}else{var d=new point(1E5,1E5),l=new point(-1E5,-1E5),k=this.partsA[c].min,n=this.partsA[c].max;for(f=1;f<a;f++)k=Math.min(k,this.partsA[c+f].min),n=Math.max(n,this.partsA[c+f].max);this.szFlag.match(/CATEGORICAL/)&&(k++,
n++);for(b in this.itemA)if(this.itemA[b].nValuesA[0]>k&&this.itemA[b].nValuesA[0]<n)for(e=this.getItemNodes(b),f=0;f<e.length;f++){var h=map.Dom.getBox(e[f]);if(0===h.width||0===h.height){var p=getMatrix(e[f]);h.x+=p[4];h.y+=p[5];h.width=map.Scale.viewBox.width/20;h.height=map.Scale.viewBox.height/20;h.x-=h.width/2;h.y-=h.height/2}p=map.Scale.getMapOffset(e[f]);h.x+=p.x;h.y+=p.y;d.x=Math.min(d.x,h.x);d.y=Math.min(d.y,h.y);l.x=Math.max(l.x,h.x+h.width);l.y=Math.max(l.y,h.y+h.height)}b=new box(d.x,
d.y,l.x-d.x,l.y-d.y);b.scale(1.2);b=map.Zoom.clipArea(b);map.Zoom.setNewArea(b)}}};
MapTheme.prototype.markClass=function(c,a){if(!1!==this.fMarkEnable)if(map.Themes.enableSubThemes&&this.szFlag.match(/DOMINANT|COMPOSE/)&&!this.szFlag.match(/CHART/))this.createSubTheme(c);else if(isNaN(c))displayMessage("no class!");else{var d=this.szItemFilter&&this.szItemFilter.length;if(!this.szFlag.match(/CHART/)||d)this.fUnmarkEnable=!0,this.unmarkClass(),this.fUnmarkEnable=!1;if(!1!==this.fMarkEnable){var b=0;if(this.szFlag.match(/DOMINANT/)&&!this.szFlag.match(/CHART/))for(var f in this.itemA)this.itemA[f].nClass==
c&&b++;else b=1==this.partsA.length&&this.szFlag.match(/DOPACITY/)?99:this.partsA[c].nCount;if(500<b&&"highlight"==this.evidenceMode)displayMessage("Sorry ! to many members");else if(0===b)displayMessage("No members !");else{clearMessage();highLightList.removeAll();var b=null,e=(this.fShadow?5:10)/this.nScale;if(this.szFlag.match(/CHART/)){f=this.chartGroup.childNodes;for(var l=[],b=0;b<f.length;b++){var k=f.item(b);if(null==k.getAttributeNS(szMapNs,"class")||""===k.getAttributeNS(szMapNs,"class"))for(var n=
k.getElementsByTagName("g"),h=0;h<n.length;h++)for(var p=n.item(h).childNodes,g=0;g<p.length;g++){var u=p.item(g);if(u.getAttributeNS&&u.getAttributeNS(szMapNs,"class")){if(this.szFlag.match(/SEQUENCE/)&&!this.szFlag.match(/PLOT/)&&"isolate_gray"!=this.evidenceMode){var r=u.getAttributeNS(null,"transform");r&&r.length&&(u.setAttributeNS(szMapNs,"orig-transform",r),u.setAttributeNS(null,"transform",""))}r=Number(u.getAttributeNS(szMapNs,"class"));this.szFlag.match(/BAR/)&&this.szFlag.match(/3D/)&&
!this.szFlag.match(/STACKED/)&&(1<this.szFieldsA.length||this.szFlag.match(/AGGREGATE/)&&this.szFlag.match(/CATEGORICAL/))?!0===this.markedClasses[r]?(u.setAttributeNS(null,"transform","matrix(1 0 0 1 -10 6.6)"),u.style.setProperty("fill-opacity","1","")):(u.setAttributeNS(null,"transform","matrix(1 0 0 1 0 0)"),u.style.setProperty("fill-opacity","0.85","")):!0===this.markedClasses[r]?d||(u.style.setProperty("display","inline",""),u.getAttributeNS(szMapNs,"save-style")&&u.setAttributeNS(null,"style",
u.getAttributeNS(szMapNs,"save-style")),l.push(k)):"isolate_gray"==this.evidenceMode?(u.getAttributeNS(szMapNs,"save-style")||u.setAttributeNS(szMapNs,"save-style",u.getAttributeNS(null,"style")),u.style.setProperty("fill","#bbbbbb",""),"none"!=u.style.getPropertyValue("stroke")&&u.style.setProperty("stroke","#888888",""),r=u.style.getPropertyValue("fill-opacity"),this.szFlag.match(/SEQUENCE/)||this.szFlag.match(/WAFFLE/)?(u.style.setProperty("fill-opacity","0",""),u.style.setProperty("stroke-opacity",
String(.9*r),""),u.style.setProperty("stroke-width",String(e),"")):u.style.setProperty("fill-opacity","0","")):u.style.setProperty("display","none","")}}else r=Number(k.getAttributeNS(szMapNs,"class")),!0===this.markedClasses[r]?d||(this.szFlag.match(/VECTOR/)?(k.firstChild.style.setProperty("stroke","",""),k.firstChild.style.setProperty("stroke-opacity","",""),k.firstChild.style.setProperty("marker-end","",""),k.style.setProperty("display","inline","")):(k.style.setProperty("display","inline",""),
(r=k.getAttributeNS(szMapNs,"fill"))&&k.style.setProperty("fill",r,"")),l.push(k)):"isolate_gray"==this.evidenceMode?this.szFlag.match(/VECTOR/)?(k.firstChild.style.setProperty("stroke","#888888",""),k.firstChild.style.setProperty("stroke-opacity","0.5",""),k.firstChild.style.setProperty("marker-end","none","")):(k.setAttributeNS(szMapNs,"fill",k.style.getPropertyValue("fill")),k.style.setProperty("fill","#bbbbbb",""),k.setAttributeNS(szMapNs,"stroke",k.style.getPropertyValue("fill")),k.style.setProperty("stroke",
"#888888",""),k.setAttributeNS(szMapNs,"fill-opacity",k.style.getPropertyValue("fill-opacity")),k.style.setProperty("fill-opacity","0.05","")):k.style.setProperty("display","none","")}l.forEach(function(a){a.parentNode.appendChild(a)})}else{this.beginDraw();if(this.szFlag.match(/DOMINANT/))for(f in this.itemA)if(this.itemA[f].nClass==c&&"highlight"==this.evidenceMode)for(b=this.getItemNodes(f),d=0;d<b.length;d++)highLightList.addItem(b[d]);else{if(this.itemA[f].nClass!=c&&"highlight"!=this.evidenceMode)for(b=
this.getItemNodes(f),d=0;d<b.length;d++)b[d].setAttributeNS(szMapNs,"themestyle",b[d].getAttributeNS(null,"style")),b[d].style.setProperty("display","none","")}else{d=this.partsA[c].min;e=this.partsA[c].max;for(b=1;b<a;b++)d=Math.min(d,this.partsA[c+b].min),e=Math.max(e,this.partsA[c+b].max);for(f in this.itemA)if(d=!1,this.markedClasses&&this.markedClasses[this.itemA[f].nClass]&&(d=!0),d){if("highlight"==this.evidenceMode)for(b=this.getItemNodes(f),d=0;d<b.length;d++)highLightList.addItem(b[d])}else if("highlight"!=
this.evidenceMode)for(b=this.getItemNodes(f),d=0;d<b.length;d++)if(this.szFlag.match(/BUFFER/))(e=SVGDocument.getElementById(b[d].getAttributeNS(null,"id")+":paint"))&&e.style.setProperty("display","none","");else{b[d].setAttributeNS(szMapNs,"themestyle",b[d].getAttributeNS(null,"style"));b[d].setAttributeNS(null,"style",b[d].getAttributeNS(szMapNs,"origthemestyle"));l=b[d].firstChild.nextSibling.getAttribute("id")||b[d].getAttribute("id");if(e=SVGDocument.getElementById(l+"L"))e.setAttributeNS(szMapNs,
"display",e.style.getPropertyValue("display")),e.style.setProperty("display","none","");if(e=SVGDocument.getElementById(l+"L:bg"))e.setAttributeNS(szMapNs,"display",e.style.getPropertyValue("display")),e.style.setProperty("display","none","");if(e=SVGDocument.getElementById(l+":::value"))e.setAttributeNS(szMapNs,"display",e.style.getPropertyValue("display")),e.style.setProperty("display","none","");if(e=SVGDocument.getElementById(l+":::value:bg"))e.setAttributeNS(szMapNs,"display",e.style.getPropertyValue("display")),
e.style.setProperty("display","none","")}}this.endDraw();this.fMarkClass=!0}}}}};
MapTheme.prototype.unmarkClass=function(c){if(!1!==this.fUnmarkEnable)if(this.subTheme)this.removeSubTheme();else if(this.szItemFilter&&this.szItemFilter.length)this.fMarkEnable=!0,this.filterItems(this.szItemFilter,this.itemFilterOpt);else if(clearMessage(),this.szFlag.match(/CHART/)){var a=this.chartGroup.childNodes;for(c=0;c<a.length;c++){var d=a.item(c);if(null==d.getAttributeNS(szMapNs,"class")||""===d.getAttributeNS(szMapNs,"class"))for(var d=d.getElementsByTagName("g"),b=0;b<d.length;b++)for(var f=
d.item(b).childNodes,e=0;e<f.length;e++){var l=f.item(e);if(l.getAttributeNS&&l.getAttributeNS(szMapNs,"class")){if(this.szFlag.match(/SEQUENCE/)){var k=l.getAttributeNS(szMapNs,"orig-transform");k&&k.length&&(l.removeAttributeNS(szMapNs,"orig-transform"),l.setAttributeNS(null,"transform",k))}this.szFlag.match(/BAR/)&&this.szFlag.match(/3D/)&&!this.szFlag.match(/STACKED/)&&(l.setAttributeNS(null,"transform","matrix(1 0 0 1 0 0)"),l.style.setProperty("fill-opacity","1",""));l.style&&(l.style.setProperty("display",
"inline",""),l.getAttributeNS(szMapNs,"save-style")&&l.setAttributeNS(null,"style",l.getAttributeNS(szMapNs,"save-style")))}}else this.szFlag.match(/VECTOR/)&&(d.firstChild.style.setProperty("stroke","",""),d.firstChild.style.setProperty("stroke-opacity","",""),d.firstChild.style.setProperty("marker-end","","")),d.style.setProperty("display","inline","")}this.szFlag.match(/TEXTONLY/)&&setTimeout(function(){map.Layer.adaptLabel()},10)}else{this.beginDraw();if("highlight"!=this.evidenceMode)for(a in this.itemA)for(c=
this.getItemNodes(a),d=0;d<c.length;d++)this.szFlag.match(/BUFFER/)?(b=SVGDocument.getElementById(c[d].getAttributeNS(null,"id")+":paint"))&&b.style.setProperty("display","inline",""):(b=c[d].getAttributeNS(szMapNs,"themestyle"))&&b.length&&"null"!=b&&(c[d].setAttributeNS(null,"style",b),c[d].removeAttributeNS(szMapNs,"themestyle"),f=c[d].firstChild.nextSibling.getAttribute("id")||c[d].getAttribute("id"),(b=SVGDocument.getElementById(f+"L"))&&b.style.setProperty("display",b.getAttributeNS(szMapNs,
"display"),""),(b=SVGDocument.getElementById(f+"L:bg"))&&b.style.setProperty("display",b.getAttributeNS(szMapNs,"display"),""),(b=SVGDocument.getElementById(f+":::value"))&&b.style.setProperty("display",b.getAttributeNS(szMapNs,"display"),""),(b=SVGDocument.getElementById(f+":::value:bg"))&&b.style.setProperty("display",b.getAttributeNS(szMapNs,"display"),""));else highLightList.removeAll();this.endDraw();this.fMarkClass=!1}};
MapTheme.prototype.showClass=function(c,a,d){var b=0;if(this.szFlag.match(/DOMINANT/))for(var f in this.itemA)this.itemA[f].nClass==c&&b++;clearMessage();var e=null,b=d?"inline":"none";if(this.szFlag.match(/CHART/))for(d=this.chartGroup.childNodes,e=0;e<d.length;e++){var l=d.item(e);if(null==l.getAttributeNS(szMapNs,"class")||""===l.getAttributeNS(szMapNs,"class"))for(var l=l.firstChild.childNodes,k=0;k<l.length;k++)a=l.item(k),f=Number(a.getAttributeNS(szMapNs,"class")),f==c&&a.style.setProperty("display",
b,"");else f=Number(l.getAttributeNS(szMapNs,"class")),f==c&&l.style.setProperty("display",b,"")}else{this.beginDraw();if(this.szFlag.match(/DOMINANT/))for(f in this.itemA){if(this.itemA[f].nClass==c)for(e=this.getItemNodes(f),a=0;a<e.length;a++)e[a].setAttributeNS(szMapNs,"themestyle",e[a].getAttributeNS(null,"style")),e[a].style.setProperty("display",b,"")}else{l=this.partsA[c].min;k=this.partsA[c].max;for(e=1;e<a;e++)l=Math.min(l,this.partsA[c+e].min),k=Math.max(k,this.partsA[c+e].max);this.szFlag.match(/CATEGORICAL/)&&
(l++,k++);for(f in this.itemA)if(this.szFlag.match(/CATEGORICAL/)&&this.itemA[f].nValuesA[0]==l||this.itemA[f].nValuesA[0]>l&&this.itemA[f].nValuesA[0]<k)for(e=this.getItemNodes(f),a=0;a<e.length;a++)this.szFlag.match(/BUFFER/)?(c=SVGDocument.getElementById(e[a].getAttributeNS(null,"id")+":paint"))&&c.style.setProperty("display",b,""):d?(c=e[a].getAttributeNS(szMapNs,"themestyle"))&&c.length&&"null"!=c&&(e[a].setAttributeNS(null,"style",c),e[a].removeAttributeNS(szMapNs,"themestyle")):(e[a].setAttributeNS(szMapNs,
"themestyle",e[a].getAttributeNS(null,"style")),e[a].setAttributeNS(null,"style",e[a].getAttributeNS(szMapNs,"origthemestyle")))}this.endDraw()}};
MapTheme.prototype.setTimeFrame=function(c,a){clearMessage();highLightList.removeAll();var d=this.szItemFilter&&this.szItemFilter.length,b=(this.fShadow?5:10)/this.nScale;if(this.szFlag.match(/CHART/)){for(var f=this.chartGroup.childNodes,e=[],l=0;l<f.length;l++){var k=f.item(l);if(null==k.getAttributeNS(szMapNs,"time")||""===k.getAttributeNS(szMapNs,"time"))for(var n=k.getElementsByTagName("g"),h=0;h<n.length;h++)for(var p=n.item(h).childNodes,g=0;g<p.length;g++){var u=p.item(g);if(u.getAttributeNS&&
u.getAttributeNS(szMapNs,"time")){var r=Number(u.getAttributeNS(szMapNs,"time"));this.szFlag.match(/BAR/)&&this.szFlag.match(/3D/)&&!this.szFlag.match(/STACKED/)&&(1<this.szFieldsA.length||this.szFlag.match(/AGGREGATE/)&&this.szFlag.match(/CATEGORICAL/))?r>=c&&r<=a?(u.setAttributeNS(null,"transform","matrix(1 0 0 1 -10 6.6)"),u.style.setProperty("fill-opacity","1","")):(u.setAttributeNS(null,"transform","matrix(1 0 0 1 0 0)"),u.style.setProperty("fill-opacity","0.85","")):r>=c&&r<=a?d||(u.style.setProperty("display",
"inline",""),u.getAttributeNS(szMapNs,"save-style")&&u.setAttributeNS(null,"style",u.getAttributeNS(szMapNs,"save-style")),e.push(k)):"isolate_gray"==this.evidenceMode?(u.getAttributeNS(szMapNs,"save-style")||u.setAttributeNS(szMapNs,"save-style",u.getAttributeNS(null,"style")),u.style.setProperty("fill","#bbbbbb",""),"none"!=u.style.getPropertyValue("stroke")&&u.style.setProperty("stroke","#888888",""),r=u.style.getPropertyValue("fill-opacity"),this.szFlag.match(/SEQUENCE/)||this.szFlag.match(/WAFFLE/)?
(u.style.setProperty("fill-opacity","0",""),u.style.setProperty("stroke-opacity",String(.9*r),""),u.style.setProperty("stroke-width",String(b),"")):u.style.setProperty("fill-opacity","0","")):u.style.setProperty("display","none","")}}else if(r=Number(k.getAttributeNS(szMapNs,"time")),r>=c&&r<=a){if(!d){if(this.szFlag.match(/VECTOR/))k.firstChild.style.setProperty("stroke","",""),k.firstChild.style.setProperty("stroke-opacity","",""),k.firstChild.style.setProperty("marker-end","",""),k.style.setProperty("display",
"inline","");else{k.style.setProperty("display","inline","");var q;(q=k.getAttributeNS(szMapNs,"fill"))&&k.style.setProperty("fill",q,"")}e.push(k)}}else"isolate_gray"==this.evidenceMode?this.szFlag.match(/VECTOR/)?(k.firstChild.style.setProperty("stroke","#888888",""),k.firstChild.style.setProperty("stroke-opacity","0.5",""),k.firstChild.style.setProperty("marker-end","none","")):(k.setAttributeNS(szMapNs,"fill",k.style.getPropertyValue("fill")),k.style.setProperty("fill","#bbbbbb",""),k.setAttributeNS(szMapNs,
"stroke",k.style.getPropertyValue("fill")),k.style.setProperty("stroke","#888888",""),k.setAttributeNS(szMapNs,"fill-opacity",k.style.getPropertyValue("fill-opacity")),k.style.setProperty("fill-opacity","0.05","")):k.style.setProperty("display","none","")}e.forEach(function(a){a.parentNode.appendChild(a)})}};
MapTheme.prototype.createSubTheme=function(c){this.subTheme&&this.removeSubTheme();var a="";this.coTable&&"undefined"!=typeof this.coTable&&(a+="dbtable:"+this.coTable+";");this.szSelectionField&&"undefined"!=typeof this.szSelectionField&&(a+="lookupfield:"+this.szSelectionField+";");this.szAlphaField&&"undefined"!=typeof this.szAlphaField&&(a+="alphafield:"+this.szAlphaField+";");this.szAlphaField100&&"undefined"!=typeof this.szAlphaField100&&(a+="alphafield100:"+this.szAlphaField100+";");this.nDopacityScale&&
"undefined"!=typeof this.nDopacityScale&&(a+="dopacityscale:"+this.nDopacityScale+";");this.nDopacityPow&&"undefined"!=typeof this.nDopacityPow&&(a+="dopacitypow:"+this.nDopacityPow+";");var d="lookuptoupper:"+(this.fSelectionFieldToUpper||null)+";",d=d+("lookupsuffix:"+(this.szSelectionFieldSuffix||null)+";"),d=d+("lookupprefix:"+(this.szSelectionFieldPrefix||null)+";"),d=d+("lookupdigits:"+(Number(this.nSelectionFieldDigits)||null)+";"),d=d+("lookuptonumber:"+(this.fSelectionFieldToNumber||null)+
";"),d=d+("lookuptoupper:"+(this.fSelectionFieldToUpper||null)+";"),a=a+d;this.szAggregationField&&"undefined"!=typeof this.szAggregationField&&(a+="aggregationfield:"+this.szAggregationField+";");this.szUnits&&"undefined"!=typeof this.szUnits&&(a+="units:"+this.szUnits+";");var b="";this.szFlag.match(/DOPACITY/)&&(b+="DOPACITYMAX|");this.szFlag.match(/AGGREGATE/)&&(b+="AGGREGATE|");this.szFlag.match(/GROUP/)&&(b+="GROUP|");this.szFlag.match(/SUM/)&&(b+="SUM|");this.szFlag.match(/ZEROISVALUE/)&&(b+=
"ZEROISVALUE|");this.szFlag.match(/VALUES/)&&(b+="VALUES|");map.Themes.enableMultiChoropleth=!0;if(this.szFlag.match(/CATEGORICAL/)&&this.szFlag.match(/AGGREGATE/)&&this.szLabelA){for(var f=[],e=[],d=0;d<this.markedClassesA.length;d++)f.push(this.szLabelA[this.markedClassesA[d]]),e.push(this.colorScheme[this.markedClassesA[d]]);this.markedClassesA&&1<this.markedClassesA.length?(c=this.getDefinitionObject(),c.style.type+="|NOINFO",c.style.values=f,c.style.colorscheme=e,this.subTheme=map.Themes.newThemeByObj(c)):
(a+='filter:WHERE "'+this.szFields+'" IN "('+f.join(",")+')";',this.subTheme=map.Themes.newTheme(this.szThemes,this.szFields,this.szField100,"type:CHOROPLETH|CATEGORICAL|NOINFO|NOLEGEND|SUBTHEME|"+b+";colorscheme:7|white|"+this.colorScheme[c]+";"+a,this.szLabelA[c],""))}else if(this.markedClassesA&&1<this.markedClassesA.length){f=this.szFields.split("|");b=e="";for(d=0;d<this.markedClassesA.length;d++)e+=(e.length?"|":"")+f[this.markedClassesA[d]],b+=(b.length?"|":"")+this.colorScheme[this.markedClassesA[d]];
this.subTheme=map.Themes.newTheme(this.szThemes,e,this.szField100,"type:"+this.szFlag+"|NOINFO;colorscheme:"+b+";"+a,this.szLabelA?this.szLabelA[c]:"","")}else c=this.markedClassesA[0]||c,this.subTheme=map.Themes.newTheme(this.szThemes,this.szFields.split("|")[c],this.szField100,"type:CHOROPLETH|QUANTILE|NOINFO|NOLEGEND|SUBTHEME|"+b+";colorscheme:7|white|"+this.colorScheme[c]+";"+a,this.szLabelA?this.szLabelA[c]:"","");map.Themes.subTheme=this};
MapTheme.prototype.removeSubTheme=function(){map.Themes.enableMultiChoropleth=!1;this.subTheme&&(map.Themes.subTheme=!1,map.Themes.removeTheme(null,this.subTheme.szId),this.subTheme=null,map.Themes.realizeDone(this))};
MapTheme.prototype.isItemInFilter=function(c,a,d,b){if(0===d.length&&("undefined"==typeof b||!b.field))return!0;if("undefined"!=typeof a.dbIndex||"undefined"!=typeof a.dbIndexA)if(a=a.dbIndex||a.dbIndexA[0],d.length){if(this.__szValue=c.dbRecords[a].join(" "),eval("this.__szValue.match(/"+d.replace(/\//gi,"\\/")+"/i)"))return!0}else if(b&&b.field){for(d=0;d<c.dbFields.length;d++)if(c.dbFields[d].id==b.field&&(b.min&&c.dbRecords[a][d]<b.min||b.max&&c.dbRecords[a][d]>b.max||b.txt&&c.dbRecords[a][d]!=
b.txt))return!1;return!0}return!1};
MapTheme.prototype.filterItems=function(c,a){if(!1!==this.fMarkEnable){this.szItemFilter=c;this.itemFilterOpt=a;this.filterNodesA=c.length||a&&a.field?[]:null;for(var d=null,b=0;b<this.szThemesA.length&&(!(d=this.objThemesA[this.szThemesA[b]])||!d.dbRecords);b++);if(d&&d.dbRecords){if(this.szFlag.match(/CHART/))for(var f=this.chartGroup.childNodes,b=0;b<f.length;b++){var e=[],l=f.item(b);e.push(l);for(var k=0;k<e.length;k++){var n=e[k].getAttributeNS(null,"id"),n=n.split(":")[1]+"::"+n.split(":")[3];
this.itemA[n]?this.isItemInFilter(d,this.itemA[n],c,a)?(l.style.setProperty("display","inline",""),this.filterNodesA&&this.filterNodesA.push(n)):l.style.setProperty("display","none",""):l.style.setProperty("display","inline","")}}else{this.beginDraw();for(f in this.itemA)if(this.itemA[f]&&"undefined"!=typeof this.itemA[f].dbIndex)if(this.isItemInFilter(d,this.itemA[f],c,a))for(this.filterNodesA&&this.filterNodesA.push(f),b=this.getItemNodes(f),e=0;e<b.length;e++)this.szFlag.match(/BUFFER/)?(l=SVGDocument.getElementById(b[e].getAttributeNS(null,
"id")+":paint"))&&l.style.setProperty("display","inline",""):(l=b[e].getAttributeNS(szMapNs,"themestyle"))&&l.length&&"null"!=l&&(b[e].setAttributeNS(null,"style",l),b[e].removeAttributeNS(szMapNs,"themestyle"),(l=SVGDocument.getElementById(b[e].firstChild.nextSibling.getAttribute("id")+"L"))&&l.style.setProperty("display",l.getAttributeNS(szMapNs,"display"),""),(l=SVGDocument.getElementById(b[e].firstChild.nextSibling.getAttribute("id")+"L:bg"))&&l.style.setProperty("display",l.getAttributeNS(szMapNs,
"display"),""));else for(b=this.getItemNodes(f),e=0;e<b.length;e++)if(this.szFlag.match(/BUFFER/))(l=SVGDocument.getElementById(b[e].getAttributeNS(null,"id")+":paint"))&&l.style.setProperty("display","none","");else{b[e].getAttributeNS(szMapNs,"themestyle")||b[e].setAttributeNS(szMapNs,"themestyle",b[e].getAttributeNS(null,"style"));b[e].setAttributeNS(null,"style",b[e].getAttributeNS(szMapNs,"origthemestyle"));if(l=SVGDocument.getElementById(b[e].firstChild.nextSibling.getAttribute("id")+"L"))l.setAttributeNS(szMapNs,
"display",l.style.getPropertyValue("display")),l.style.setProperty("display","none","");if(l=SVGDocument.getElementById(b[e].firstChild.nextSibling.getAttribute("id")+"L:bg"))l.setAttributeNS(szMapNs,"display",l.style.getPropertyValue("display")),l.style.setProperty("display","none","")}this.endDraw()}this.fMarkClass=!0}}};MapTheme.prototype.selectFilterItems=function(){map.Selections.newSelection("generic",this.filterNodesA,"type:queryresult",this.szItemFilter)};
MapTheme.prototype.highlightItems=function(c,a){if(""===c)this.clearHighlightItems();else{highLightList.removeAll();var d=this;c.split(a||",").forEach(function(a){if(d.szFlag.match(/CHART/)){var c=SVGDocument.getElementById(d.szId+":"+a+":chartgroup");c||(a=d.szThemesA[0]+"::"+a,c=SVGDocument.getElementById(d.szId+":"+a+":chartgroup"));highLightList.addItem(c.parentNode,"isolate");map.displayInfo(null,c.firstChild,"add|fix")}else{a=d.getItemNodes(a);for(c=0;c<a.length;c++)highLightList.addItem(a[c]);
map.displayInfo(null,a[0].firstChild.nextSibling,"add|fix")}})}};MapTheme.prototype.clearHighlightItems=function(){highLightList.removeAll();map.removeInfo()};
MapTheme.prototype.labelMap=function(c){var a=map.Zoom.getBox(),d=null;this.szValuesTextStyle="font-family:verdana;font-size:"+map.Scale.normalX(11)+"px;pointer-events:none";if(!c||0===c){var b=0;c=0;this.indexA=[];var f=0,e=0;if(this.fClipCharts)for(b in this.itemA){if(e++,this.itemA[b].nValuesA&&0<this.itemA[b].nValuesA.length&&(d=this.getNodePosition(this.itemA[b].szSelectionId)))if(d.x<a.x||d.x>a.x+a.width||d.y<a.y||d.y>a.y+a.height){if(this.nSkipCount++,d=SVGDocument.getElementById(this.szId+
":"+b+":chart"))d.parentNode.removeChild(d),this.chartPosA[this.itemA[b].szSelectionId]=null,this.posItemA[this.itemA[b].szSelectionId]=null}else this.indexA[this.indexA.length]=b,f++}else for(b in this.itemA)this.indexA[this.indexA.length]=b,e++,f++;f>this.nMaxThemeCharts&&(this.indexA.length=0,this.nSkipCount=f);this.mapSleep&&(this.mapSleep.nCount=f);this.fEnableProgressBar=!1}for(;c<this.indexA.length;c++){if(this.fCancel){displayMessage("Canceled by user",1E3,!0);this.fCancel=!1;return}if(this.mapSleep&&
(this.mapSleep.nDoneCount=this.nDoneCount,this.mapSleep.checkSleep(c,10))){this.fContinue=!0;this.continueIndex=c;return}b=this.indexA[c];this.nDoneCount++;if(this.itemA[b].nValuesA&&0<this.itemA[b].nValuesA.length)if(d=this.getNodePosition(this.itemA[b].szSelectionId))if(this.fClipCharts&&!this.szFlag.match(/BUFFER/)&&(d.x<a.x||d.x>a.x+a.width||d.y<a.y||d.y>a.y+a.height))this.nSkipCount++;else for(d=this.getItemNodes(b),f=0;f<d.length;f++)this.labelShape(d[f],this.itemA[b].szColor,this.itemA[b].szLabel?
this.itemA[b].szLabel:this.itemA[b].nValue);else this.nMissingPositionCount++}this.fMakeLabel=!1;setTimeout(function(){map.Layer.adaptLabel(null)},10)};MapTheme.prototype.unlabelMap=function(){for(var c in map.Layer.generatedLabelA)map.Dom.removeElementById(c),map.Layer.generatedLabelA[c]=null};
MapTheme.prototype.labelShape=function(c,a,d){if(this.szFlag.match(/VALUES/)&&"undefined"!=d&&"undefined"!=typeof d&&(!this.szFlag.match(/NOZERO/)||0!==d)){var b=c.parentNode.getAttributeNS(null,"id"),f=SVGDocument.getElementById(b+":label");if(f){var e=SVGDocument.getElementById(b+":values:bg");e||(e=map.Dom.newGroup(f.parentNode,b+":values:bg"),map.Layer.generatedLabelA[b+":values:bg"]=e);var l=SVGDocument.getElementById(b+":values");l||(l=map.Dom.newGroup(f.parentNode,b+":values"),map.Layer.generatedLabelA[b+
":values"]=l);try{var k=c.firstChild.nextSibling.getAttributeNS(null,"id").split("#"),n=k[0]+"L"+(k[1]?"#"+k[1]:"")}catch(h){n=c.getAttributeNS(null,"id")+":::value"}if(!SVGDocument.getElementById(n)){f=__maptheme_getChartColors(a);a="string"==typeof d?d:this.formatValue(d,this.nValueDecimals||0)+(this.szUnit.match(/\%/)?"%":"");var b="#ffffff",b=this.szTextColor||f.highColor,k=f.lowColor,p=1,f=Math.max(.3,c.style.getPropertyValue("fill-opacity")||"1");this.szFlag.match(/DTEXT/)&&(p=Math.max(.7,Math.min(1.5,
2/Math.sqrt(this.nMax)*Math.sqrt(d))));d=map.Scale.normalX(11)*map.Scale.nZoomScale*p*map.Scale.nLabelScaling*(this.nLabelScale||1);e=map.Dom.newText(e,0,0,"font-family:verdana;font-weight:normal;font-size:"+d+"px;text-anchor:middle;fill:none;stroke:"+k+";stroke-width:"+map.Scale.normalX(4)*map.Scale.nZoomScale+";stroke-opacity:0.5;pointer-events:none;display:none;stroke-linejoin:bevel;",a);l=map.Dom.newText(l,0,0,"font-family:verdana;font-weight:normal;font-size:"+d+"px;text-anchor:middle;fill:"+
b+";stroke:none;pointer-events:none;display:none;",a);l.setAttributeNS(null,"id",n);e.setAttributeNS(null,"id",n+":bg");this.szFlag.match(/DOPACITY/)&&(l.style.setProperty("fill-opacity",f,""),e.style.setProperty("stroke-opacity",f,""));(n=c.getAttributeNS(szMapNs,"center"))?(c=n.split(","),c=new point(Number(c[0].split(":")[1]),Number(c[1].split(":")[1]))):c=this.getNodePosition(c.getAttributeNS(null,"id"));c&&(l.fu.setPosition(c.x,c.y),e.fu.setPosition(c.x,c.y))}}}};
MapTheme.prototype.zoomTo=function(){var c=new point(1E5,1E5),a=new point(-1E5,-1E5);if(this.szFlag.match(/CHART/))for(var d in this.itemA){var b=this.itemA[d].ptPos||this.getNodePosition(this.itemA[d].szSelectionId);b&&b.x&&b.y&&(c.x=Math.min(c.x,b.x),c.y=Math.min(c.y,b.y),a.x=Math.max(a.x,b.x),a.y=Math.max(a.y,b.y))}else for(d in this.itemA)for(var b=this.getItemNodes(d),f=0;f<b.length;f++){var e=map.Dom.getBox(b[f]);if(0===e.width||0===e.height){var l=getMatrix(b[f]);e.x+=l[4];e.y+=l[5];e.width=
map.Scale.viewBox.width/20;e.height=map.Scale.viewBox.height/20;e.x-=e.width/2;e.y-=e.height/2}l=map.Scale.getMapOffset(b[f]);e.x+=l.x;e.y+=l.y;c.x=Math.min(c.x,e.x);c.y=Math.min(c.y,e.y);a.x=Math.max(a.x,e.x+e.width);a.y=Math.max(a.y,e.y+e.height)}c=new box(c.x,c.y,a.x-c.x,a.y-c.y);c.scale(1);c=map.Zoom.clipArea(c);map.Zoom.setNewArea(c)};
MapTheme.prototype.createChartGroup=function(c){if(!this.chartGroup&&(this.szFlag.match(/FEATURE/)?(this.chartGroup=map.Dom.newGroup(c,this.szId+":featuregroup"),map.Layer.listA[this.szThemesA[0]]=new Map.Layer.Item(null)):this.chartGroup=map.Dom.newGroup(c,this.szId+":chartgroup"),this.chartGroup.style.setProperty("opacity",String(this.nOpacity?this.nOpacity:1),""),this.szFlag.match(/VECTOR/)&&antiZoomAndPanList.addGroup(this.chartGroup),this.szFlag.match(/NOSCALE/)&&antiZoomAndPanList.addGroup(this.chartGroup),
this.szFlag.match(/AGGREGATE/)&&(this.szFlag.match(/AUTOSIZE/)||this.szFlag.match(/GRIDSIZE/))&&antiZoomAndPanList.addGroup(this.chartGroup),this.szFlag.match(/GRIDSIZE/)&&!this.szFlag.match(/AGGREGATE/)&&antiZoomAndPanList.addGroup(this.chartGroup),this.szFlag.match(/BUFFER/))){this.szFlag.match(/OVERLAY/)&&!this.szShapeType.match(/line/)&&this.chartGroup.style.setProperty("opacity","1","");map.Layer.getLayerObj(this.szThemesA[0]);this.chartGroup.style.setProperty("pointer-events","none","");antiZoomAndPanList.addGroup(this.chartGroup);
c=this.colorScheme[0];var a=this.colorScheme[1]?this.colorScheme[1]:"red";"undefined"!=typeof this.szBorderColor&&(a=this.szBorderColor);var d="stroke-width:0;";if("undefined"!=typeof this.szBorderStyle)switch(this.szBorderStyle){case "dotted":d="stroke-width:"+map.Scale.normalX(1)+";stroke-linecap:round;stroke-dasharray:1,50;";break;case "dashed":d="stroke-width:"+map.Scale.normalX(1)+";stroke-linecap:butt;stroke-dasharray:30,30;";break;case "solid":d="stroke-width:"+map.Scale.normalX(1)+";";break;
case "none":d="stroke-width:0;"}if("undefined"!=typeof this.szBorderWidth)switch(this.szBorderWidth){case "thin":d+="stroke-width:"+map.Scale.normalX(.5)+";";break;case "thick":d+="stroke-width:"+map.Scale.normalX(1.5)+";"}this.chartGroup.setAttributeNS(null,"style","fill:"+c+";fill-opacity:"+(this.fillOpacity?this.fillOpacity:this.nOpacity?this.nOpacity:0)+";stroke:"+a+";"+d+";")}};
MapTheme.prototype.chartMap=function(c){if(this.nChartUpper&&map.Scale.nTrueMapScale*map.Scale.nZoomScale>this.nChartUpper)this.chartGroup&&this.chartGroup.style.setProperty("display","none",""),this.fVisible=!1,this.realizeDone();else if(this.nChartLower&&map.Scale.nTrueMapScale*map.Scale.nZoomScale<=this.nChartLower)this.chartGroup&&this.chartGroup.style.setProperty("display","none",""),this.fVisible=!1,this.realizeDone();else{this.fVisible=!0;this.chartGroup&&this.chartGroup.style.setProperty("display",
this.chartGroup.display||"inline","");this.chartGroup&&!c&&(this.chartPosA=[]);var a=this.nChartSize?this.nChartSize:30,d=map.Zoom.getBox(),b=this.szFlag.match(/AGGREGATE/)&&this.nGridWidth?map.Scale.getDeltaXofDistanceInMeter(this.nGridWidth||0)*map.Scale.nZoomScale:map.Scale.normalX(30)*map.Scale.nZoomScale;d.x-=b/2;d.y-=b/2;d.width+=b;d.height+=b;var b=null,f=8;if(!c||0===c){if(!this.partsA)return;var e=0;c=0;this.indexA=[];this.szValuesLineStyle="stroke:white;stroke-width:"+map.Scale.normalX(1.5)+
";opacity:0.5;";this.szValuesLineBgStyle="stroke:#888888;stroke-width:"+map.Scale.normalX(.5)+";opacity:1;";this.szValuesTextStyle="font-family:"+(this.szTextFont||"arial")+";font-size:"+map.Scale.normalX(f)+"px;fill:#777777;pointer-events:none";var l=map.Layer.objectGroup;this.chartGroup||this.createChartGroup(l);this.blur(this.nBlur);this.autoOpacity&&(this.fillOpacity=1*Math.max(.1,Math.min(1,20/Math.max(1,Math.pow(map.Zoom.nZoom,.5)))));this.mapSleep&&(this.mapSleep.checkSleepMessage="creating charts");
l=getRotateAttributeValue(map.Scale.canvasNode);if(this.szFlag.match(/\bSORT\b/)&&!this.szFlag.match(/SEQUENCE/)&&!this.szFlag.match(/3D/)){this.indexA=[];for(e in this.itemA)this.indexA[this.indexA.length]=e;for(var f=[],k=0;k<this.indexA.length;k++){var n=this.itemA[this.indexA[k]].nValuesA[this.nActualFrame||0];this.itemA[this.indexA[k]].nSize?n=this.itemA[this.indexA[k]].nSize:this.szFlag.match(/SIZE/)&&this.itemA[this.indexA[k]].nValueSum&&(n=this.itemA[this.indexA[k]].nValueSum);isNaN(n)||f.push({a:this.indexA[k],
y:n})}this.szFlag.match(/\bUP\b/)?f.sort(this.sortDownChartObjectsCompare):f.sort(this.sortUpChartObjectsCompare);if(this.szValueField&&"$index$"==this.szValueField)for(k=0;k<f.length;k++)this.itemA[f[k].a].szValue=String(f.length-k);this.indexA=[]}if(this.szFlag.match(/CHART/)&&!this.szFlag.match(/CATEGORICAL/)){for(f=0;f<this.partsA.length;f++)this.partsA[f].nCount=0,this.partsA[f].nSum=0;this.fRedrawInfo=!0;this.szFlag.match(/SEQUENCE/)&&(this.nFadeNegative=this.nFadeNegative||1)}var h=n=f=0;if(!this.fClipCharts||
this.szFlag.match(/BUFFER/)||this.szFlag.match(/POSITION/)||this.szFlag.match(/FEATURE/))for(e in this.itemA){this.indexA[this.indexA.length]=e;if(this.szFlag.match(/CHART/)&&!this.szFlag.match(/CATEGORICAL/))for(k=0;k<this.partsA.length;k++)this.partsA[k].nCount++,this.partsA[k].nSum+=isNaN(this.itemA[e].nValuesA[k])?0:this.itemA[e].nValuesA[k];n++;f++}else{for(k=0;k<this.partsA.length;k++)this.partsA[k].nCount=0,this.partsA[k].nSum=0;for(e in this.itemA)if(n++,this.itemA[e].nValuesA&&0<this.itemA[e].nValuesA.length)if(b=
this.itemA[e].ptPos||this.getNodePosition(this.itemA[e].szSelectionId)){if(!this.szFlag.match(/NOCLIPTOVIEW/)&&(b.x<d.x||b.x>d.x+d.width||b.y<d.y||b.y>d.y+d.height))if(this.szFlag.match(/\b(VECTOR|BEZIER)\b/)){b=this.itemA[e].ptPos2||(this.szLabelA?this.getNodePosition(this.szThemesA[0]+"::"+this.szLabelA[this.itemA[e].nValuesA[0]-1]):null);if(!b)continue;if(b.x<d.x||b.x>d.x+d.width||b.y<d.y||b.y>d.y+d.height){this.nSkipCount++;(p=this.itemA[e].chartNode)&&p.parentNode&&(p.parentNode&&p.parentNode.removeChild(p),
this.itemA[e].chartNode=null,this.chartPosA[this.itemA[e].szSelectionId]=null,this.posItemA[this.itemA[e].szSelectionId]=null);continue}}else{this.nSkipCount++;var p;(p=this.itemA[e].chartNode)&&p.parentNode&&(p.parentNode&&p.parentNode.removeChild(p),this.itemA[e].chartNode=null,this.chartPosA[this.itemA[e].szSelectionId]=null,this.posItemA[this.itemA[e].szSelectionId]=null);continue}if(!this.itemA[e].ptPos||!this.itemA[e].ptPos2||this.itemA[e].ptPos.x!=this.itemA[e].ptPos2.x||this.itemA[e].ptPos.y!=
this.itemA[e].ptPos2.y){this.indexA[this.indexA.length]=e;if(this.szFlag.match(/CHART/))if(this.szFlag.match(/CATEGORICAL/))if(1<this.nMaxA.length)for(k=0;k<this.partsA.length;k++)this.partsA[k].nCount++,this.partsA[k].nSum+=this.itemA[e].nValuesA[k]&&!isNaN(this.itemA[e].nValuesA[k])?this.itemA[e].nValuesA[k]:0;else this.szAlphaField?this.szColorField&&this.partsA[this.itemA[e].nClass]?(this.partsA[this.itemA[e].nClass].nCount++,this.partsA[this.itemA[e].nClass].nSum+=isNaN(this.itemA[e].nAlpha)?
isNaN(this.itemA[e].nSize)?1:this.itemA[e].nSize:this.itemA[e].nAlpha):this.partsA[this.itemA[e].nValuesA[0]-1]&&(this.partsA[this.itemA[e].nValuesA[0]-1].nCount++,this.partsA[this.itemA[e].nValuesA[0]-1].nSum+=isNaN(this.itemA[e].nAlpha)?isNaN(this.itemA[e].nSize)?1:this.itemA[e].nSize:this.itemA[e].nAlpha):this.szColorField&&this.partsA[this.itemA[e].nClass]?(this.partsA[this.itemA[e].nClass].nCount++,this.partsA[this.itemA[e].nClass].nSum+=isNaN(this.itemA[e].nSize)?1:this.itemA[e].nSize):this.partsA[this.itemA[e].nValuesA[0]-
1]&&(this.partsA[this.itemA[e].nValuesA[0]-1].nCount++,this.partsA[this.itemA[e].nValuesA[0]-1].nSum+=isNaN(this.itemA[e].nSize)?1:this.itemA[e].nSize);else if(1<this.nMaxA.length)for(k=0;k<this.partsA.length;k++){if(!this.szFlag.match(/MEAN/)||this.itemA[e].nValuesA[k])this.partsA[k].nCount++,this.partsA[k].nSum+=isNaN(this.itemA[e].nValuesA[k])?0:this.itemA[e].nValuesA[k]}else for(k=0;k<this.partsA.length;k++)this.itemA[e].nValuesA[0]>=this.partsA[k].min&&this.itemA[e].nValuesA[0]<this.partsA[k].max&&
(this.partsA[k].nCount++,this.partsA[k].nSum+=isNaN(this.itemA[e].nValuesA[0])?0:this.itemA[e].nValuesA[0]);f++}}else this.missedA[e]=e,h++;if(n==h&&!map.Tiles.allTilesLoaded()){this.fRedraw=this.fDataIncomplete=!0;map.Tiles.switchScaleDependentTiles();setTimeout(function(){map.Themes.execute()},1);return}}if(f>this.nMaxThemeCharts)for(e in this.ErrorMessage="max charts ("+this.nMaxThemeCharts+") exceeded; please zoom in",this.indexA.length=0,this.nSkipCount=f,this.itemA)(p=SVGDocument.getElementById(this.szId+
":"+e+":chart"))&&p.parentNode.removeChild(p);this.fRedrawAllCharts=!1;f>this.nMaxShadowCharts?(this.fShadow&&(this.fRedrawAllCharts=!0),this.fShadow=!1):(this.fOrigShadow&&!this.fShadow&&(this.fRedrawAllCharts=!0),this.fShadow=this.fOrigShadow);this.szShadowUpper&&(map.Scale.nTrueMapScale*map.Scale.nZoomScale>this.nShadowUpper?(this.xOrigShadow=this.xOrigShadow||this.fOrigShadow,this.fShadow=this.fOrigShadow=!1):this.fOrigShadow=this.xOrigShadow||this.fOrigShadow);this.szShadowLower&&(map.Scale.nTrueMapScale*
map.Scale.nZoomScale<this.nShadowLower?(this.xOrigShadow=this.xOrigShadow||this.fOrigShadow,this.fShadow=this.fOrigShadow=!1):this.fOrigShadow=this.xOrigShadow||this.fOrigShadow);this.mapSleep&&(this.mapSleep.nCount=f);this.fSorted=!1;if(this.fSortBeforeDraw&&this.nMin!=this.nMax&&!this.szFlag.match(/NOSRT/)&&!this.szFlag.match(/DOT/)&&(!this.szFlag.match(/NOSIZE/)||this.szFlag.match(/3D/)||this.szFlag.match(/\bSORT\b/))&&(!this.szFlag.match(/CATEGORICAL/)||this.szFlag.match(/AGGREGATE/)||this.szSizeField||
this.szFlag.match(/\bSORT\b/))){d=[];if((this.szFlag.match(/3D/)||this.szFlag.match(/BOX/)||this.szFlag.match(/POINTER/)&&this.szFlag.match(/BAR/))&&(!this.szFlag.match(/MULTIPLE/)&&!this.szFlag.match(/MULTIGRID/)||this.szFlag.match(/AGGREGATE/)))for(k=0;k<this.indexA.length;k++)(b=this.itemA[this.indexA[k]].ptPos||this.getNodePosition(this.itemA[this.indexA[k]].szSelectionId))?d[k]=l?{a:this.indexA[k],y:b.x*Math.sin(l)+b.y*Math.cos(l)}:{a:this.indexA[k],y:b.y}:d[k]={a:this.indexA[k],y:0};else if(this.szSizeField||
this.szFlag.match(/AGGREGATE/)&&this.szFlag.match(/SUM/))for(k=0;k<this.indexA.length;k++)n=this.itemA[this.indexA[k]].nSize,isNaN(n)||d.push({a:this.indexA[k],y:n});else if(this.szSizeField||this.szFlag.match(/AGGREGATE/)&&this.szFlag.match(/MEAN/))for(k=0;k<this.indexA.length;k++)n=this.itemA[this.indexA[k]].nValuesA[this.nActualFrame||0],isNaN(n)||d.push({a:this.indexA[k],y:n});else if(this.szFlag.match(/SIZE/))for(k=0;k<this.indexA.length;k++)n=this.itemA[this.indexA[k]].nValueSum,isNaN(n)||d.push({a:this.indexA[k],
y:n});else for(k=0;k<this.indexA.length;k++)n=this.itemA[this.indexA[k]].nValuesA[this.nActualFrame||0],isNaN(n)||d.push({a:this.indexA[k],y:n});this.szFlag.match(/\bSORT\b/)&&this.szFlag.match(/\bUP\b/)&&!this.szFlag.match(/SEQUENCE/)&&!this.szFlag.match(/3D/)?d.sort(this.sortDownChartObjectsCompare):d.sort(this.sortUpChartObjectsCompare);for(k=0;k<d.length;k++)this.indexA[k]=d[k].a;this.fSorted=!0}if(this.nMaxCharts&&f>this.nMaxCharts){this.fContinue=!0;this.continueIndex=f-this.nMaxCharts;this.indexA.slice(f-
this.nMaxCharts-1,this.nMaxCharts);map.Themes.executeContinue();return}this.unpaintMap()}this.chart={szColor:this.colorScheme[0],szLineColor:this.colorScheme[1]?this.colorScheme[1]:"none",szTextColor:this.colorScheme[1]?this.colorScheme[1]:"none"};if(2<this.colorScheme.length||this.szFlag.match(/CATEGORICAL/))this.chart.szColor=this.colorScheme[this.colorScheme.length-1],this.chart.szLineColor=this.colorScheme[0];this.szFlag.match(/NOLINES/)?this.chart.szLineColor="none":"none"==this.chart.szLineColor&&
(d=__maptheme_getChartColors("#777777"),this.chart.szLineColor=d.textColor);this.nXLen=this.nMaxA.length/(this.nGridX||1);this.szFlag.match(/PLOT/)&&(this.szFlag.match(/GRIDSIZE/)||this.szFlag.match(/AUTOSIZE/))?(d=0,d=map.Layer.nDynamicObjectScale,p=this.szFlag.match(/GAP/)?1.2:1,d=this.nGridWidthPx?map.Scale.normalX(this.nGridWidthPx)/p*this.nScale/d:this.nGridWidth?map.Scale.getDeltaXofDistanceInMeter(this.nGridWidth)/p*this.nScale/d:map.Scale.normalX(a/3),this.nAutoScale=d/map.Scale.normalX((this.itemA[e]?
this.itemA[e].nValuesA.length:1)/(this.nGridX||1)*a),this.nGridSize=d):this.szFlag.match(/GRIDSIZE/)&&(d=map.Layer.nDynamicObjectScale,p=this.szFlag.match(/\bRECT\b/)||!this.szFlag.match(/AGGREGATE/)?this.szFlag.match(/GAP/)?1.15:1:this.szFlag.match(/GAP/)?.8:.75,this.nGridSize=this.nGridWidthPx?map.Scale.normalX(this.nGridWidthPx)/p/d:this.nGridWidth?map.Scale.getDeltaXofDistanceInMeter(this.nGridWidth)/p/d:map.Scale.normalX(a/3));this.szFlag.match(/PLOTXY/)&&(d=map.Layer.nDynamicObjectScale,p=1.15,
this.nChartWidth=this.nGridWidthPx?map.Scale.normalX(this.nGridWidthPx)/p/this.nScale/d:this.nGridWidth?map.Scale.getDeltaXofDistanceInMeter(this.nGridWidth)/p/this.nScale/d:map.Scale.normalX(a/3),this.nChartWidth-=2*map.Scale.normalX(this.nBoxMargin||0),this.nChartHeight=this.nChartWidth-map.Scale.normalY(this.szFlag.match(/TITLE/)?10:0),this.nGridSize=this.nChartWidth,this.nAutoScale=1,this.nRangeX=this.nMaxX-this.nMinX,this.nRangeY=this.nMaxY-this.nMinY);this.nChartGroupScaleX=this.nChartGroupScale=
fObjectScaling?(this.nAutoScale||this.nScale)*map.Layer.nObjectScale*map.Scale.nObjectScaling:(this.nAutoScale||this.nScale)*map.Scale.nFeatureScaling*map.Scale.nObjectScaling;this.nChartGroupScaleY=this.nChartGroupScale/map.Zoom.nZoomY*map.Zoom.nZoomX;this.fGlowInScale=!1;(!this.szGlowUpper||map.Scale.nTrueMapScale*map.Scale.nZoomScale<=this.nGlowUpper)&&(!this.szGlowLower||map.Scale.nTrueMapScale*map.Scale.nZoomScale>=this.nGlowLower)&&(this.fGlowInScale=!0);this.fDoRedraw=!1;if(1E3>this.indexA.length||
this.fRedraw||this.fRedrawAllCharts||this.szFlag.match(/BUFFER/)&&this.szShapeType.match(/line/))this.fDoRedraw=!0;this.fHideValues=this.szValueUpper&&map.Scale.nTrueMapScale*map.Scale.nZoomScale>this.nValueUpper;if(this.szFlag.match(/\bUSER\b/))try{var g={target:this.chartGroup,theme:this};this.userDraw?(this.opt=g,eval("HTMLWindow.ixmaps."+this.userDraw+"_init(SVGDocument,this.opt);"),delete this.opt):HTMLWindow.ixmaps.htmlgui_initChart(SVGDocument,g)}catch(u){displayMessage("'"+(this.userDraw||
"USER chart")+"' undefined!",5E3)}this.szFlag.match(/POSITION|FEATURE/)&&(this.chartGroup.style.setProperty("fill",this.chart.szColor||"white"),this.chartGroup.style.setProperty("fill-opacity",this.fillOpacity||.1),this.chartGroup.style.setProperty("stroke",this.szLineColor||"red"),this.chartGroup.style.setProperty("stroke-width",map.Scale.normalX(this.nLineWidth||1)*this.nChartGroupScaleY),this.chartGroup.style.setProperty("stroke-opacity","1"),this.chartGroup.style.setProperty("stroke-linecap",
"butt"),this.chartGroup.style.setProperty("stroke-linejoin","round"));d=map.Scale.getDeltaXofDistanceInMeter(this.nGridWidth)/2*20;for(d=d*map.Scale.nZoomScale*20;c<this.indexA.length;c++){if(this.fCancel){displayMessage("Canceled by user",1E3,!0);this.fCancel=!1;return}if(this.mapSleep&&(this.mapSleep.nDoneCount=this.nDoneCount,this.mapSleep.checkSleep(c,10))){this.fContinue=!0;this.continueIndex=c;this.szItemFilter&&this.szItemFilter.length&&this.filterItems(this.szItemFilter,this.itemFilterOpt);
null!=this.markedClass&&this.markClass(this.markedClass,1);return}g=null;e=this.indexA[c];this.nDoneCount++;if(this.itemA[e]&&this.itemA[e].nValuesA&&0!==this.itemA[e].nValuesA.length){var r=this.itemA[e].szSelectionId;if(!this.szFlag.match(/POSITION|FEATURE/)){if(b=this.itemA[e].ptPos||this.getNodePosition(r))b.x=isNaN(b.x)?0:b.x,b.y=isNaN(b.y)?0:b.y;if(!b||isNaN(b.x)||isNaN(b.y)){this.nMissingPositionCount++;continue}this.fRedraw&&(this.itemA[e].chartNode=this.itemA[e].chartNode||SVGDocument.getElementById(this.szId+
":"+e+":chart"));if(this.itemA[e].chartNode&&this.itemA[e].chartNode.parentNode)if(this.fDoRedraw)this.itemA[e].chartNode.parentNode.removeChild(this.itemA[e].chartNode),this.itemA[e].chartNode=null;else{this.nRealizedCount++;continue}}p=new point(0,0);if(this.szFlag.match(/POSITION|FEATURE/))if(g=map.Dom.newGroup(this.chartGroup,e),this.objTheme.dbRecords[this.itemA[e].dbIndex][this.objTheme.nFieldSelectionIndex]){if(f=JSON.parse(this.objTheme.dbRecords[this.itemA[e].dbIndex][this.objTheme.nFieldSelectionIndex])){if("Point"==
f.type){map.Layer.listA[this.szThemesA[0]].szType="point";g.fu.setMatrix([this.nChartGroupScaleX,0,0,this.nChartGroupScaleY,b.x,b.y]);var q=map.Dom.newShape("circle",g,0,0,map.Scale.normalX(1E-4))}if("LineString"==f.type){this.chartGroup.style.setProperty("fill","none");map.Layer.listA[this.szThemesA[0]].szType="line";n=f.coordinates;h=map.Scale.getMapPositionOfLatLon(n[0][1],n[0][0]);q="M"+h.x+","+h.y+" l";r=new point(h.x,h.y);for(k in n)h=map.Scale.getMapPositionOfLatLon(n[k][1],n[k][0]),q+=h.x-
r.x+","+(h.y-r.y)+" ",r=new point(h.x,h.y);q=map.Dom.newShape("path",g,q,"")}if("MultiLineString"==f.type)for(k in this.chartGroup.style.setProperty("fill","none"),map.Layer.listA[this.szThemesA[0]].szType="line",p=f.coordinates,p){n=p[k];r=null;h=map.Scale.getMapPositionOfLatLon(n[0][1],n[0][0]);q="M"+h.x+","+h.y+" l";r=new point(h.x,h.y);for(ii in n)h=map.Scale.getMapPositionOfLatLon(n[ii][1],n[ii][0]),q+=h.x-r.x+","+(h.y-r.y)+" ",r=new point(h.x,h.y);q=map.Dom.newShape("path",g,q,"")}if("Polygon"==
f.type){map.Layer.listA[this.szThemesA[0]].szType="polygon";p=f.coordinates;q="";for(k in p){n=p[k];r=null;h=map.Scale.getMapPositionOfLatLon(n[0][1],n[0][0]);q+="M"+h.x+","+h.y+" l";r=new point(h.x,h.y);for(ii in n)h=map.Scale.getMapPositionOfLatLon(n[ii][1],n[ii][0]),q+=h.x-r.x+","+(h.y-r.y)+" ",r=new point(h.x,h.y);q+=" z"}q=map.Dom.newShape("path",g,q,"")}if("MultiPolygon"==f.type){map.Layer.listA[this.szThemesA[0]].szType="polygon";var f=f.coordinates,t;for(t in f){p=f[t];q="";for(k in p){n=
p[k];r=null;h=map.Scale.getMapPositionOfLatLon(n[0][1],n[0][0]);q+="M"+h.x+","+h.y+" l";r=new point(h.x,h.y);for(ii in n)h=map.Scale.getMapPositionOfLatLon(n[ii][1],n[ii][0]),q+=h.x-r.x+","+(h.y-r.y)+" ",r=new point(h.x,h.y);q+=" z"}q=map.Dom.newShape("path",g,q,"")}}}}else(b=this.itemA[e].ptPos||this.getNodePosition(r))&&g.fu.setMatrix([this.nChartGroupScaleX,0,0,this.nChartGroupScaleY,b.x,b.y]);else if(this.szFlag.match(/DOT/)){g=map.Dom.newGroup(this.chartGroup,this.szId+":"+r+":chartgroup");g.fu.setMatrix([this.nChartGroupScaleX,
0,0,this.nChartGroupScaleY,b.x,b.y]);if(this.szFlag.match(/CATEGORICAL/))this.chart.szColor=this.colorScheme[this.itemA[e].nValuesA[0]-1];else if(1<this.partsA.length)for(k=0;k<this.partsA.length;k++)this.itemA[e].nValuesA[0]>=this.partsA[k].min&&this.itemA[e].nValuesA[0]<this.partsA[k].max&&(this.chart.szColor=this.colorScheme[k]);this.itemA[e].chartNode=map.Dom.newShape("circle",g,0,0,map.Scale.normalX(3),"fill:"+this.chart.szColor+";fill-opacity:"+(this.fillOpacity||1)+";stroke:none;")}else if(this.szFlag.match(/\bQUAD\b/)){g=
map.Dom.newGroup(this.chartGroup,this.szId+":"+r+":chart");g.fu.setMatrix([this.nChartGroupScaleX,0,0,this.nChartGroupScaleY,b.x,b.y]);if(this.szFlag.match(/CATEGORICAL/))this.chart.szColor=this.colorScheme[this.itemA[e].nValuesA[0]-1];else if(1<this.partsA.length)for(k=0;k<this.partsA.length;k++)this.itemA[e].nValuesA[0]>=this.partsA[k].min&&this.itemA[e].nValuesA[0]<this.partsA[k].max&&(this.chart.szColor=this.colorScheme[k]);this.itemA[e].chartNode=map.Dom.newShape("rect",g,-d,-d,2*d,2*d,"fill:"+
this.chart.szColor+";stroke:none;")}else if(this.szFlag.match(/\bBEZIER\b/)){if(!(this.nMinValue&&this.itemA[e].nSize<this.nMinValue)&&(p=this.itemA[e].ptPos,h=this.itemA[e].ptPos2||(this.szLabelA?this.getNodePosition(this.szThemesA[0]+"::"+this.szLabelA[this.itemA[e].nValuesA[0]-1]):null),p&&h&&p!=h)){g=this.itemA[e].chartNode=map.Dom.newGroup(this.chartGroup,this.szId+":"+e+(e?":chartgroup":":ochrtgroup"));this.chart.szColor=this.szLineColor||this.itemA[e].szColor||this.colorScheme[this.itemA[e].nValuesA[0]-
1]||this.szNoDataColor;var f=1/(this.nSizePow||1),n=this.nLineWidth||10/Math.pow(this.nNormalSizeValue||this.nMaxSize,f)*Math.pow(Math.abs(this.itemA[e].nSize),f),q=Number(this.nGapSize||20),x=n+(this.szFlag.match(/\bGAP\b/)?q:3),n=map.Scale.normalX(n)*this.nChartGroupScaleY*this.nScale;if(!(0>=n)){if(this.szFlag.match(/\bREVERSE\b/)||0>this.itemA[e].nSize)f=p,p=h,h=f;var r=Math.sqrt((h.y-p.y)*(h.y-p.y)+(h.x-p.x)*(h.x-p.x)),f=h.x-p.x,h=h.y-p.y,r=Math.sqrt(f*f+h*h),E=this.nRangeScale;this.szFlag.match(/\bRANDOM\b/)&&
(E-=.66*this.nRangeScale*Math.random());if(this.szFlag.match(/\bSHORT\b/))var B=h/r*(E||5)*100*this.nChartGroupScaleY,E=f/r*(E||5)*100*this.nChartGroupScaleY;else this.szFlag.match(/\bLONG\b/)?(B=h/5E4*Math.max(r,500)*(E||5),E=f/5E4*Math.max(r,500)*(E||5)):(B=h/50*(E||5),E=f/50*(E||5));this.szFlag.match(/\bPOINTER|ARROW\b/)&&(f-=f/r*map.Scale.normalX(x)*this.nChartGroupScaleY*this.nScale*(this.nMarkerSize||1),h-=h/r*map.Scale.normalX(x)*this.nChartGroupScaleY*this.nScale*(this.nMarkerSize||1));var m=
0,y=0;this.szFlag.match(/\bGAP\b/)&&(f+=B/500*x,h-=E/500*x,m=f/r*q*20*this.nChartGroupScaleY,y=h/r*q*20*this.nChartGroupScaleY);q="M"+m+","+y+" C"+(f/4+B)+","+(h/4-E)+" "+(f/2+B)+","+(h/2-E)+" "+f+","+h+"";q=map.Dom.newShape("path",g,q,"stroke-linecap:butt;fill:none;stroke:"+this.chart.szColor+";stroke-width:"+n+";stroke-opacity:"+(this.fillOpacity||.3)+";");if(this.szFlag.match(/\bDASH\b/)){var A=1E3*this.nChartGroupScaleY,z=100*this.nChartGroupScaleY+n;q.style.setProperty("stroke-dasharray",String(A)+
" "+String(z));q.style.setProperty("stroke-dashoffset","0");q.style.setProperty("stroke-linecap","round");x=Math.random()*A;A=x+A+z;map.Dom.constructNode("animate",q,{attributeType:"XML",attributeName:"stroke-dashoffset",from:String(A),to:String(x),dur:"2s",repeatCount:"indefinite"})}if(this.szFlag.match(/\bGRADIENT\b|\bFADEIN\b/)){x=this.szLineColorA?this.szLineColorA[0]:this.chart.szColor;A=this.szFlag.match(/\bFADEIN\b/)?.2:2;z="Gradient"+Math.random();if(Math.abs(h)>Math.abs(f)){var v=map.Dom.constructNode("linearGradient",
g,{id:z,x1:"0%",y1:"0%",x2:"0%",y2:"100%"});map.Dom.constructNode("stop",v,{offset:"0","stop-color":0>h?this.chart.szColor:x,"stop-opacity":0>h?"2":A});map.Dom.constructNode("stop",v,{offset:"1","stop-color":0>h?x:this.chart.szColor,"stop-opacity":0>h?A:"2"})}else v=map.Dom.constructNode("linearGradient",g,{id:z}),map.Dom.constructNode("stop",v,{offset:"0","stop-color":0>f?this.chart.szColor:x,"stop-opacity":0>f?"2":A}),map.Dom.constructNode("stop",v,{offset:"1","stop-color":0>f?x:this.chart.szColor,
"stop-opacity":0>f?A:"2"});q.style.setProperty("stroke","");q.style.setProperty("fill","none");q.setAttributeNS(null,"stroke","url(#"+z+")")}this.szFlag.match(/\bPOINTER|ARROW\b/)&&(x="ArrowMarker"+Math.random(),A=map.Dom.newNode("defs",g),z=Math.min(5,2.5+100/(n/this.nChartGroupScale))*(this.nMarkerSize||1),A=map.Dom.constructNode("marker",A,{id:x,markerWidth:z,markerHeight:z,refX:z/1.5,refY:z/2,orient:"auto",markerUnits:"strokeWidth"}),map.Dom.constructNode("path",A,{d:"M0,"+z+" L"+z+","+z/2+" L0,0 Z",
style:"fill:"+this.chart.szColor+";opacity:"+2*(this.fillOpacity||.3)+";stroke:#444444;stroke-width:0.01"}),q.setAttributeNS(null,"marker-end","url(#"+x+")"));this.szFlag.match(/\bVALUES\b/)&&!this.fHideValues&&(x="VectorPath"+Math.random(),0>f?(q="M"+f+","+h+" C"+(f/2+B)+","+(h/2-E)+" "+(f/4+B)+","+(h/4-E)+" "+m+","+y+"",map.Dom.newShape("path",g,q,"fill:none;stroke:none").setAttributeNS(null,"id",x)):q.setAttributeNS(null,"id",x),f=Math.min(r,Math.sqrt(this.itemA[e].nSize)/Math.sqrt(this.nNormalSizeValue||
this.nMaxSize)*this.nValueScale),f=24*map.Scale.normalX(f)*this.nChartGroupScaleY*this.nScale,h=this.formatValue(this.itemA[e].nSize,this.nValueDecimals||(1>this.itemA[e].nSize?2:0),"ROUND")+this.szUnit,map.Dom.newTextOnPath(g,x,h,"font-family:arial;font-size:"+f+"px;fill:"+this.chart.szColor+";stroke:#ffffff;stroke-width:"+n/10+"px;baseline-shift:-35%","40%"));g.setAttributeNS(szMapNs,"class","undefined"!=typeof this.itemA[e].nClass?this.itemA[e].nClass:String(this.itemA[e].nValuesA[0]-1));g.setAttributeNS(szMapNs,
"tooltip",this.formatValue(this.itemA[e].nSize,this.nValueDecimals||(1>this.itemA[e].nSize?2:0),"ROUND")+this.szUnit);this.szTimeField&&(f=(new Date(this.itemA[e].szTime)).getTime()||this.itemA[e].szTime,g.setAttributeNS(szMapNs,"time",f));g.fu.setMatrix([1,0,0,1,p.x,p.y])}}}else if(this.szFlag.match(/\bVECTOR\b/))this.nMinValue&&this.itemA[e].nSize<this.nMinValue||(p=this.itemA[e].ptPos,h=this.itemA[e].ptPos2||(this.szLabelA?this.getNodePosition(this.szThemesA[0]+"::"+this.szLabelA[this.itemA[e].nValuesA[0]-
1]):null),p&&h&&(g=this.itemA[e].chartNode=map.Dom.newGroup(this.chartGroup,this.szId+":"+e+(e?":chartgroup":":ochrtgroup")),this.chart.szColor=this.szLineColor||this.colorScheme[this.itemA[e].nValuesA[0]-1],n=this.nLineWidth||2/(this.nNormalSizeValue||1)/this.nMaxSize*this.itemA[e].nSize,q=map.Dom.newShape("line",g,0,0,h.x-p.x,h.y-p.y,"stroke:"+this.chart.szColor+";stroke-width:"+map.Scale.normalX((n||.1)*this.nChartGroupScaleY)+";stroke-opacity:"+(this.fillOpacity||.3)+";"),this.szFlag.match(/\bDASH\b/)&&
(A=1E3*this.nChartGroupScaleY,z=300*this.nChartGroupScaleY,q.style.setProperty("stroke-dasharray",String(A)+" "+String(z)),q.style.setProperty("stroke-dashoffset","0"),x=Math.random()*A,A=x+A+z,map.Dom.constructNode("animate",q,{attributeType:"XML",attributeName:"stroke-dashoffset",from:String(A),to:String(x),dur:"1s",repeatCount:"indefinite"})),this.szFlag.match(/\bPOINTER|ARROW\b/)&&(A=map.Dom.newNode("defs",g),A=map.Dom.constructNode("marker",A,{id:this.szId+":"+r+":chartgroup:ArrowMarker",markerWidth:"4",
markerHeight:"4",refX:"4",refY:"2",orient:"auto",markerUnits:"strokeWidth"}),map.Dom.constructNode("path",A,{d:"M0,4 L4,2 L0,0 Z",style:"fill:"+this.chart.szColor+";opacity:"+2*(this.fillOpacity||.3)+";stroke:white;stroke-width:0.1"}),q.setAttributeNS(null,"marker-end","url(#"+this.szId+":"+r+":chartgroup:ArrowMarker)")),g.setAttributeNS(szMapNs,"class","undefined"!=typeof this.itemA[e].nClass?this.itemA[e].nClass:String(this.itemA[e].nValuesA[0]-1)),g.setAttributeNS(szMapNs,"tooltip",this.formatValue(this.itemA[e].nSize,
this.nValueDecimals||(1>this.itemA[e].nSize?2:0),"ROUND")+this.szUnit),g.fu.setMatrix([1,0,0,1,p.x,p.y])));else{g=null;if(r)if(g=SVGDocument.getElementById(this.szId+":"+r+":chart"))g.fu=new Methods(g);else if(g=map.Dom.newGroup(this.chartGroup,this.szId+":"+r+":chart"),this.szFlag.match(/BOX/)){p="#bbbbbb";"undefined"!=typeof this.szBorderColor&&(p=this.szBorderColor);f="stroke-width:"+map.Scale.normalX(.5)+";stroke-opacity:0.3;";if("undefined"!=typeof this.szBorderStyle)switch(this.szBorderStyle){case "dotted":f=
"stroke-width:"+map.Scale.normalX(1)+";stroke-linecap:round;stroke-dasharray:1,50;";break;case "dashed":f="stroke-width:"+map.Scale.normalX(1)+";stroke-linecap:butt;stroke-dasharray:30,30;";break;case "solid":f="stroke-width:"+map.Scale.normalX(1)+";";break;case "none":f="stroke-width:0;"}if("undefined"!=typeof this.szBorderWidth)switch(this.szBorderWidth){case "thin":f+="stroke-width:"+map.Scale.normalX(.3)+";";break;case "thick":f+="stroke-width:"+map.Scale.normalX(1.5)+";"}map.Dom.newShape("rect",
g,0,0,1,1,"fill:"+(this.szBoxColor||"white")+";fill-opacity:"+(this.nBoxOpacity||1)+";stroke:"+p+";"+f).setAttributeNS(null,"id",this.szId+":"+r+":chart:box");switch(this.szSymbolBoxStyle){case "frame":this.boxShape.setAttributeNS(null,"fill-opacity",0);break;case "field":this.boxShape.setAttributeNS(null,"fill-opacity",1)}}this.itemA[e].chartNode=g;g.setAttributeNS(szMapNs,"value",String(this.itemA[e].nValuesA[0]));p=this.drawChart(g,e,a,this.szFlag+"|SILENT");f=this.nScale;this.nScale=this.nAutoScale||
this.nScale;n=1;"auto"==this.nMaxValue&&this.nMaxValuePlot&&(n=n/Math.pow(this.nMax,1/3)*Math.pow(this.nMaxValuePlot,1/3));p&&b&&g&&(this.szFlag.match(/PLOT/)&&this.nGridSize&&this.nAutoScale&&(p.x+=this.nGridSize/this.nAutoScale/2,p.y-=this.nGridSize/this.nAutoScale/2),this.szFlag.match(/NOSCALE/)?g.fu.setMatrix([this.nScale,0,0,this.nScale,b.x-p.x*this.nScale,b.y-p.y*this.nScale]):g.fu.setMatrix([this.nChartGroupScaleX*n,0,0,this.nChartGroupScaleY*n,b.x-p.x*map.Layer.nObjectScale*this.nScale,b.y-
p.y*map.Layer.nObjectScale*this.nScale]));this.nScale=f;if(p){r=r.split("*")[0];if((this.szFlag.match(/MULTIPLE/)||this.szFlag.match(/ALIGN/))&&g.lastChild.firstChild){p=map.Dom.getBox(g.lastChild);n=this.szFlag.match(/\bUP\b/)?p.height:p.width;if(this.chartPosA[r]){this.chartPosA[r]+=this.szFlag.match(/TEXTONLY/)?5:.5*n;var q=g.lastChild.fu.getPosition(),N=n*(this.nGridX||10);this.szFlag.match(/\bUP\b/)?g.lastChild.fu.setPosition(q.x+p.width*Math.floor(this.chartPosA[r]/N),q.y-p.y-p.height/2-this.chartPosA[r]%
N):g.lastChild.fu.setPosition(q.x+this.chartPosA[r]%N,q.y-p.height*Math.floor(this.chartPosA[r]/N));this.chartPosA[r]+=this.szFlag.match(/TEXTONLY/)?n:.5*n}else this.chartPosA[r]=this.szFlag.match(/TEXTONLY/)?n:-p.y;this.posItemA&&(this.posItemA[r]||(this.posItemA[r]=[]),this.posItemA[r].push(this.itemA[e]))}else if((this.szFlag.match(/MULTIFIX/)||this.szFlag.match(/MULTIGRID/))&&g.lastChild){if(n=1,p=map.Scale.normalX(this.nChartSizeDone),B=map.Scale.normalX(this.nChartSizeDone),b=this.getNodePosition(r)){r=
String(b.x)+String(b.y);if(this.chartPosA[r]){var q=g.lastChild.fu.getPosition(),R=this.chartPosA[r],N=this.nGridX||7;this.szFlag.match(/\bUP\b/)?g.lastChild.fu.setPosition(q.x+p*Math.floor(R/N),q.y-R%N*B):g.lastChild.fu.setPosition(q.x+R%N*p,q.y-B*Math.floor(R/N));this.chartPosA[r]+=n}else this.chartPosA[r]=n;this.posItemA&&(this.posItemA[r]||(this.posItemA[r]=[]),this.posItemA[r].push(this.itemA[e]));this.itemA[e].labelGroup&&R%N!=N-1&&this.itemA[e].labelGroup.style.setProperty("display","none",
"")}}else(this.szFlag.match(/MULTISQUARE/)||this.szFlag.match(/MULTIQUAD/))&&g.lastChild&&(n=1,p=map.Scale.normalX(this.nChartSizeDone*(this.nRangeScale||1)),B=map.Scale.normalX(this.nChartSizeDone*(this.nRangeScale||1)),b=this.getNodePosition(r))&&(r=String(b.x)+String(b.y),this.chartPosA[r]?(q=g.lastChild.fu.getPosition(),R=this.chartPosA[r],h=Math.floor(Math.sqrt(R)),h<(this.nGridX||1E7)?(N=R-h*h,f=N<=h?N:h,h=N<=h?h:h-(N-h),g.lastChild.fu.setPosition(q.x+f*p,q.y-h*B)):(q=g.lastChild.fu.getPosition(),
R=this.chartPosA[r],N=this.nGridX||7,this.szFlag.match(/\bUP\b/)?g.lastChild.fu.setPosition(q.x+p*Math.floor(R/N),q.y-R%N*B):g.lastChild.fu.setPosition(q.x+R%N*p,q.y-B*Math.floor(R/N))),this.chartPosA[r]+=n):this.chartPosA[r]=n,this.posItemA&&(this.posItemA[r]||(this.posItemA[r]=[]),this.posItemA[r].push(this.itemA[e])),this.itemA[e].labelGroup&&R%N!=N-1&&this.itemA[e].labelGroup.style.setProperty("display","none",""));this.szFlag.match(/TEXTONLY/)&&fCheckLabelOverlap&&(p=SVGDocument.getElementById(this.szId+
":"+e+":text"))&&new Map.Label.Item(p);l&&setRotate(g,-Number(l));!0===this.fShadow&&SVGDocument.getElementById(szShadowFilterId)?g.style.setProperty("filter","url(#"+szShadowFilterId+")",""):!0===this.fShadow&&(f=map.Dom.newNode("filter",this.chartGroup.parentNode),f.setAttributeNS(null,"id",szShadowFilterId),f.setAttributeNS(null,"filterUnits","objectBoundingBox"),f.setAttributeNS(null,"x","-50%"),f.setAttributeNS(null,"y","-50%"),f.setAttributeNS(null,"width","200%"),f.setAttributeNS(null,"height",
"200%"),p=map.Dom.newNode("feGaussianBlur",f),p.setAttributeNS(null,"stdDeviation","10"),p.setAttributeNS(null,"result","BlurAlpha"),p=map.Dom.newNode("feOffset",f),p.setAttributeNS(null,"in","BlurAlpha"),p.setAttributeNS(null,"dx","10"),p.setAttributeNS(null,"dy","10"),p.setAttributeNS(null,"result","OffsetBlurAlpha"),p=map.Dom.newNode("feColorMatrix",f),p.setAttributeNS(null,"in","OffsetBlurAlpha"),p.setAttributeNS(null,"type","matrix"),p.setAttributeNS(null,"values","0.1 0.1 0.1 0 0 0.1 0.1 0.1 0 0 0.1 0.1 0.1 0 0 0 0 0 1 0"),
p.setAttributeNS(null,"result","matrixOut"),p=map.Dom.newNode("feMerge",f),f=map.Dom.newNode("feMergeNode",p),f.setAttributeNS(null,"in","matrixOut"),f=map.Dom.newNode("feMergeNode",p),f.setAttributeNS(null,"in","SourceGraphic"),p=map.Dom.getBox(g.lastChild),p.width&&p.height&&g.style.setProperty("filter","url(#"+szShadowFilterId+")",""))}}}}if(this.szFlag.match(/BOX/))if(this.nBoxUpper&&map.Scale.nTrueMapScale*map.Scale.nZoomScale>this.nBoxUpper)(k=SVGDocument.getElementById(this.szId+":"+t+":chart:box"))&&
k.parentNode.removeChild(k);else for(c=0;c<this.indexA.length;c++)if(e=this.indexA[c],this.itemA[e].fDone&&(t=this.itemA[e].szSelectionId,g=SVGDocument.getElementById(this.szId+":"+t+":chart"),k=SVGDocument.getElementById(this.szId+":"+t+":chart:box"),g&&k&&!k.getAttributeNS(szMapNs,"boxed"))){this.szFlag.match(/\bPLOT\b/)&&SVGDocument.getElementById(this.szId+":"+e+":chartgroup").style.setProperty("display","none");p=map.Dom.getBox(g);t=map.Scale.normalX(this.nBoxMargin||2);t=Math.min(2*t,t*(p.width/
map.Scale.normalX(a)));if(this.szFlag.match(/TITLE/)&&this.szTitleField&&(!this.nTitleUpper||map.Scale.nTrueMapScale*map.Scale.nZoomScale<=this.nTitleUpper)){f=Math.max(map.Scale.normalX(.9),Math.min(p.width/10,map.Scale.normalX(100/this.nScale)));this.szFlag.match(/GRIDSIZE/)&&(f=Math.max(p.width/10,map.Scale.normalX(6)));f*=this.nTextScale||this.nValueScale||1;N=this.itemA[e].szTitle;try{N=HTMLWindow.ixmaps.htmlgui_onInfoTitle(this.itemA[e].szTitle,this.itemA[e])}catch(Ca){}R=this.szTextColor||
"#888888";N=this.szAlign&&this.szAlign.match(/right/)?map.Dom.newText(g,p.x+p.width,p.y-.7*f,"font-family:arial;font-size:"+f+"px;text-anchor:end;fill:"+R+";stroke:none;pointer-events:none;",String(N||" ")):map.Dom.newText(g,p.x,p.y-.7*f,"font-family:arial;font-size:"+f+"px;text-anchor:start;fill:"+R+";stroke:none;pointer-events:none;",String(N||" "));R=map.Dom.wrapText(N,p.width);N.fu.setPosition(N.fu.getPosition().x,N.fu.getPosition().y-1*f*(R-1));this.szFlag.match(/CLIPPEDTITLE/)?(R=p.height,p.height+=
1.8*f,p.y-=p.height-R,map.Dom.setClipRect(N,new box(p.x,p.y-10*f,p.width-f/3,20*f))):(p=map.Dom.getBox(g),p.y+=.1*f,p.height-=.1*f)}this.szFlag.match(/\bPLOTX\b/)?(R=p.height,p.height=map.Scale.normalX(a),p.y=-map.Scale.normalX(a/2),p.width=this.nMax*map.Scale.normalX(1.1*a)/this.nMax*5*(this.nRangeScale||1)):this.szFlag.match(/\bPLOTY\b/)&&(R=p.height,N=p.width,p.width=map.Scale.normalX(a),p.height=this.nMax*map.Scale.normalX(1.1*a)/this.nMax*5*(this.nRangeScale||1),p.x-=(p.width-N)/2,p.y-=(p.height-
R)/2);N=p.height+2*t;0<=p.width+2*t&&0<=N&&(k.setAttributeNS(null,"x",p.x-t),k.setAttributeNS(null,"y",p.y-t),k.setAttributeNS(null,"width",p.width+2*t),k.setAttributeNS(null,"height",p.height+2*t));(this.szFlag.match(/AUTOSIZE/)||this.szFlag.match(/GRIDSIZE/))&&p.width>p.height&&(k.setAttributeNS(null,"y",p.y-t-(p.width-p.height)),k.setAttributeNS(null,"height",p.width+2*t));"undefined"==typeof this.nBorderRadius||isNaN(this.nBorderRadius)||(t=Math.min(map.Scale.normalX(this.nBorderRadius),map.Scale.normalX(this.nBorderRadius*
(p.width/map.Scale.normalX(a)))),k.setAttributeNS(null,"rx",t),k.setAttributeNS(null,"ry",t));t=map.Scale.normalX(.2*(this.szBorderWidth||1)*(p.width/map.Scale.normalX(a)));k.style.setProperty("stroke-width",t);k.setAttributeNS(szMapNs,"boxed","1");SVGDocument.getElementById(this.szId+":"+e+":chartgroup").style.setProperty("display","inline")}this.szItemFilter&&this.szItemFilter.length&&this.filterItems(this.szItemFilter,this.itemFilterOpt);null!=this.markedClass&&this.markClass(this.markedClass,
1);this.isVisible=!0;this.realizeDone();this.fShowProgressBar=!1;displayProgressBar(1,1,"",1,"",1);this.showInfo();this.szFlag.match(/SHOWSTATISTIC/)&&this.showErrorInfo();this.szFlag.match(/\bCLIP\b/)?this.nClipFrames==this.itemA[e].nValuesA.length?this.szXaxisA&&this.szXaxisA[this.nActualFrame]?displayMessage(this.szXaxisA[this.nActualFrame],3E3,"big"):this.szLabelA&&this.szLabelA[this.nActualFrame]&&displayMessage(this.szLabelA[this.nActualFrame],3E3,"big"):(a=this.szXaxisA||this.szLabelA)&&(0===
this.nActualFrame?displayMessage(a[0],3E3,"big"):this.nActualFrame==this.nClipFrames-1?displayMessage(a[1],3E3,"big"):displayMessage(" ... ",3E3,"big")):this.ErrorMessage?(displayMessage(this.ErrorMessage,1E4,"notify"),this.ErrorMessage=null):clearMessage();this.fSorted||(this.fResort=!0,map.Themes.execute());this.szFlag.match(/DECLUTTER/)&&this.declutterCharts()}};
MapTheme.prototype.sortChartObjects=function(){if(!(!this.chartGroup||this.szFlag.match(/NOSRT/)||this.szFlag.match(/NOSIZE/)&&!this.szFlag.match(/3D/)||this.szFlag.match(/CATEGORICAL/)&&!this.szFlag.match(/AGGREGATE/)&&!this.szSizeField)){var c=null,a=[],d=this.chartGroup.childNodes;if(this.szFlag.match(/BUBBLE/)||this.szFlag.match(/SQUARE/)||this.szFlag.match(/BUFFER/)||this.szFlag.match(/TEXTONLY/))for(var b=0;b<d.length;b++)c=d.item(b),a[b]={node:c,y:Math.abs(Number(c.getAttributeNS(szMapNs,"value")))};
else for(var f=getRotateAttributeValue(map.Scale.canvasNode)/180*Math.PI,b=0;b<d.length;b++)c=d.item(b),a[b]=f?{node:c,y:getTranslate(c).x*Math.sin(f)+getTranslate(c).y*Math.cos(f)}:{node:c,y:getTranslate(c).y};this.szFlag.match(/\bSORT\b/)&&this.szFlag.match(/\bUP\b/)&&!this.szFlag.match(/SEQUENCE/)?a.sort(this.sortDownChartObjectsCompare):a.sort(this.sortUpChartObjectsCompare);for(b=0;b<a.length;b++)a[b].node.parentNode.appendChild(a[b].node);var e;(e=getMatrix(this.chartGroup))&&setMatrix(this.chartGroup,
e)}};MapTheme.prototype.sortUpChartObjectsCompare=function(c,a){return c.y-a.y};MapTheme.prototype.sortDownChartObjectsCompare=function(c,a){return a.y-c.y};
MapTheme.prototype.getChartSize=function(c,a,d,b){if(d.match(/NOSIZE/))return Math.max(5,a/4);b=Math.abs(b);var f=Math.max(5,a/2),e=this.nMax-this.nMin;this.nNormalSizeValue&&(e=this.nMaxSize=this.nNormalSizeValue);var l=this.itemA[c].nValue100;d.match(/SIZE/)&&!d.match(/NORMSIZE/)&&this.szSizeField&&c&&this.itemA[c]?f=d.match(/LINEAR/)||d.match(/SIZEP1/)?f/this.nMaxSize*this.itemA[c].nSize:d.match(/SIZELOG/)?Math.max(1,f/Math.log(this.nMaxSize)*Math.log(this.itemA[c].nSize)):d.match(/SIZEP4/)?f/
Math.pow(this.nMaxSize,.25)*Math.pow(this.itemA[c].nSize,.25):d.match(/3D/)||d.match(/SIZEP3/)||d.match(/SIZEVOLUME/)?f/Math.pow(this.nMaxSize,1/3)*Math.pow(this.itemA[c].nSize,1/3):f/Math.sqrt(this.nMaxSize)*Math.sqrt(this.itemA[c].nSize):d.match(/SIZE/)&&!d.match(/NORMSIZE/)&&(f=d.match(/LINEAR/)||d.match(/SIZEP1/)?f/e*b:d.match(/SIZELOG/)?Math.max(1,f/Math.log(e)*Math.log(b)):d.match(/SIZEP4/)?f/Math.pow(e,.25)*Math.pow(b,.25):d.match(/3D/)||d.match(/SIZEP3/)||d.match(/SIZEVOLUME/)?f/Math.pow(e,
1/3)*Math.pow(b,1/3):f/Math.sqrt(e)*Math.sqrt(b));map.Scale.normalX(10);d.match(/HEIGHT/)&&!d.match(/NORMSIZE/)&&(d.match(/SIZE/)?this.szSizeField&&c&&this.itemA[c]?Math.pow(10/e*this.itemA[c].nSize,1/3):Math.pow(10/e*b,1/3):l&&this.nMax100&&this.nMin100&&d.match(/FRACTION/));d.match(/ZOOM/)&&(this.origSize=f*=map.Scale.nObjectScaling,f=a/10+1*f/(Math.log(Math.abs(e))*Math.log(Math.abs(b))||1),f=Math.min(f,a),f=Math.max(f,a/5));return f};
MapTheme.prototype.checkChartSize=function(c,a,d,b){return this.nChartSizeMin&&!d.match(/ZOOM/)&&this.getChartSize(c,a,d,b)/map.Layer.nObjectScale<this.nChartSizeMin?!1:!0};
MapTheme.prototype.drawChart=function(c,a,d,b,f){var e=null,l=0,k=0;this.szChartFlag=b;if(a){if(!this.itemA[a])return null;this.itemA[a].fDone=!1;var e=this.itemA[a].nValuesA,l=this.itemA[a].nValue100,k=Math.max(this.nMax,Math.abs(this.nMin)),n=0;if(!this.szFlag.match(/BUFFER/))for(var h=0;h<e.length;h++)isNaN(e[h])&&(e[h]=0),n+=e[h];if(this.szFlag.match(/MORPH/)&&this.szFlag.match(/\bCLIP\b/)&&this.nClipFrames){for(var e=[],p=this.itemA[a].nValuesA,h=0;h<p.length/2;h++){var g=p[h]*(this.nClipFrames-
1-this.nActualFrame)/(this.nClipFrames-1)+p[h+p.length/2]*this.nActualFrame/(this.nClipFrames-1);e[h]=g}for(h=n=0;h<e.length;h++)isNaN(e[h])&&(e[h]=0),n+=e[h]}if(b.match(/NOPE/))return new point(0,0);if(b.match(/DOT/)){var u=1,g=e[0];if(b.match(/CATEGORICAL/))this.chart.szColor=this.colorScheme[g];else if(2<this.colorScheme.length||this.szRanges&&this.szRanges.length)for(pb=!1,h=0;h<this.partsA.length;h++)if(g<this.partsA[h].max){this.chart.szColor=this.colorScheme[h];var r=__maptheme_getChartColors(y);
b.match(/NOLINES/)?this.chart.szLineColor="none":this.chart.szLineColor=r.textColor;b.match(/RANGE/)&&!b.match(/RANGES/)&&(u=map.Scale.normalX(2+5*(h+1)/this.partsA.length));K=h;pb=!0;break}v=map.Dom.newShape("circle",c,0,0,map.Scale.normalX(3),"fill:"+this.chart.szColor+";stroke:none;");return new point(0,0)}}else{e=[];n=0;b=b||this.szFlag+"|XAXIS";if(this.szOrigFlag.match(/CATEGORICAL/))if(this.szOrigFlag.match(/SUM/))for(h=0;h<this.colorScheme.length;h++)this.partsA[h]&&(e[h]=this.partsA[h].nSum,
k=Math.max(k,this.partsA[h].nSum),n+=e[h]);else if(this.szOrigFlag.match(/COUNT/))for(h=0;h<this.colorScheme.length;h++)e[h]=100*this.partsA[h].nSum,k=Math.max(k,100*this.partsA[h].nSum),n+=e[h];else for(h=0;h<this.colorScheme.length;h++)e[h]=this.nOrigSumA[h]||this.exactCountA[h]||1,k=Math.max(k,this.nOrigSumA[h]||this.exactCountA[h]||1);else if(this.szOrigFlag.match(/COUNT/))for(h=0;h<this.colorScheme.length;h++)e[h]=this.partsA[h].nCount,k=Math.max(k,this.partsA[h].nCount),n+=e[h];else for(h=0;h<
this.colorScheme.length;h++)e[h]=this.partsA[h].nSum,k=Math.max(k,this.partsA[h].nSum),n+=e[h];if(l=this.nSum100){k=0;n=l;for(h=e.length-1;0<=h;h--)this.szFlag.match(/DIFFERENCE/)?l=0<h?e[h-1]:this.nSum100:this.szFlag.match(/CALCVAL/)||this.szFlag.match(/CALC100/)?e[h]=e[h]:this.szFlag.match(/PRODUCT/)?e[h]=e[h]:(e[h]/=l,k=Math.max(k,e[h]),this.szFlag.match(/PERMILLE/)?e[h]*=1E3:this.szFlag.match(/FRACTION/)||(e[h]*=100),this.szFlag.match(/RELATIVE/)&&(e[h]-=100),this.szFlag.match(/INVERT/)&&(e[h]=
100-e[h]));if(this.szFlag.match(/STACKED/)){if(k=100,this.szFlag.match(/NORMSIZE/)||b.match(/NORMSIZE/))for(h=k=0;h<e.length;h++)k+=e[h]}else k*=100,k+=k/10,k=this.nMax}else{if(this.szFlag.match(/DIFFERENCE/))for(h=e.length-1;0<=h;h--)0<h?e[h]-=e[h-1]:this.szFlag.match(/STACKED/)||(e[h]=0);if(a&&this.szAggregation&&this.szAggregation.match(/mean/)){for(h=0;h<e.length;h++)e[h]/=this.nCount;k=this.szFlag.match(/MENUSIZE/)?k/this.nCount:this.nMax}if(this.szFlag.match(/MEAN/))for(h=0;h<e.length;h++)e[h]/=
this.partsA[h].nCount;if(this.szFlag.match(/STACKED/)&&(this.szFlag.match(/NORMSIZE/)||b.match(/NORMSIZE/)||this.szFlag.match(/MENUSIZE/)||b.match(/MENUSIZE/)))for(h=k=0;h<e.length;h++)k+=e[h]}}u=a?this.getChartSize(a,d,b,n):1;if(this.nChartSizeMin&&!b.match(/ZOOM/)){if(u/map.Layer.nObjectScale<this.nChartSizeMin)return null}else if(!(this.szFlag.match(/MULTIFIX/)||this.szFlag.match(/MULTIGRID/)||this.szFlag.match(/MULTIQUAD/)||!isNaN(u)&&0!==u))return null;var q=new point(0,0);if(!b)b=this.szFlag;
else if(!b.match(/CHART/)&&b.match(/VALUES/)||b.match(/NORMSIZE/)||b.match(/MENUSIZE/))b=this.szFlag+"|"+b;b.match(/DOMINANT|COMPOSE/)&&!b.match(/CHART/)&&(b=b.match(/PERCENTOFMEAN/)?"BAR|OFFSETMEAN|POINTER|VALUES|ZOOM":b.match(/PERCENTOFMEDIAN/)?"BAR|OFFSETMEDIAN|POINTER|VALUES|ZOOM":b.match(/DEVIATION/)?"BAR|DEVIATION|POINTER|VALUES|ZOOM":"BAR|3D|VALUES|ZOOM");b.match(/ZOOM/)&&b.match(/BAR/)&&b.match(/POINTER/)&&1<e.length&&(b=this.removeDefinition(b,"SIZE")+"|COMPRESSMAX");if(1==e.length&&0===
e[0]&&!b.match(/ZEROISVALUE/)&&!b.match(/CATEGORICAL/))return this.nZeroValueCount++,null;b.match(/VALUES/)&&(this.fHideValues=this.szValueUpper&&map.Scale.nTrueMapScale*map.Scale.nZoomScale>this.nValueUpper,b.match(/ZOOM/)&&b.match(/PIE/)&&10<e.length&&(b=this.removeDefinition(b,"VALUES")));var t=map.Dom.newGroup(c,this.szId+":"+a+(a?":chartgroup":":ochrtgroup")),x=null,E=null;b.match(/MOVABLE/)&&(t.setAttributeNS(null,"id",t.getAttributeNS(null,"id")+":movable"),t.setAttributeNS(null,"onmousedown",
'map.Themes.initChartOffset(evt,"'+this.szId+'","'+this.szId+":"+a+':chartgroup:movable")'),t.setAttributeNS(null,"onmouseup",'map.Themes.endChartOffset(evt,"'+this.szId+'","'+this.szId+":"+a+':chartgroup:movable")'));if(b.match(/CHOROPLETH/)){var B=map.Scale.normalX(d/2),m=2*B/3,y=this.colorScheme[0],A=this.colorScheme[1]?this.colorScheme[1]:"none",z=map.Scale.normalX(.1)*map.Scale.nFeatureScaling*map.Scale.nObjectScaling,v=map.Dom.constructNode("use",t,{"xlink:href":"#choropleth_icon"});v.fu.scale(2,
2);d=2*m/map.Scale.normalX(1);q.x=0;q.y=m+map.Scale.normalY(5)}if(b.match(/BLANK/))return null;if(b.match(/\bUSER\b/))try{m=map.Scale.normalX(d);b.match(/GRIDSIZE/)&&(m=this.nGridSize);var N=this.objThemesA[this.szThemesA[0]],R={target:t,theme:this,item:this.itemA[a],values:e,maxSize:m,flag:b,mark:f,dbRecord:N.dbRecords?N.dbRecords[this.itemA[a].dbIndex]:null};this.ptNullUser=null;this.userDraw?(this.opt=R,eval("this.ptNullUser = HTMLWindow.ixmaps."+this.userDraw+"(SVGDocument,this.opt);"),delete this.opt):
this.ptNullUser=HTMLWindow.ixmaps.htmlgui_drawChart(SVGDocument,R);if(this.ptNullUser)return t.fu.setPosition(t.fu.getPosition().x-this.ptNullUser.x,t.fu.getPosition().y-this.ptNullUser.y),this.ptNullUser.x=0,this.ptNullUser.y=0,this.ptNullUser;this.userChartDrawError=(this.userChartDrawError||0)+1}catch(Ca){}if(b.match(/PIE/)){if(0===n&&!b.match(/AUTOCOMPLETE/))return null;if(b.match(/\bSORT\b/)){this.sortedIndex=[];for(h=0;h<e.length;h++)this.sortedIndex[h]={index:h,value:e[h]};this.sortedIndex.sort(this.sortIndexDown)}else this.sortedIndex=
null;if(b.match(/\bREVERSE\b/))for(this.sortedIndex=[],h=0;h<e.length;h++)this.sortedIndex[h]={index:e.length-h,value:e[h]};if(b.match(/CENTER/)){for(var vb=this.nCenter=0,Z=-Number.MAX_VALUE,pa=Number.MAX_VALUE,Y=0;Y<(this.nClipParts||e.length);Y++){var da=this.sortedIndex?this.sortedIndex[Y].index:Y,vb=vb+e[da];e[da]<pa&&(pa=e[da],this.nCenterMin=da);e[da]>Z&&(Z=e[da],this.nCenterMax=da)}this.szCenterPart=this.szCenterPart||"max","first"==this.szCenterPart?this.nCenter=0:"last"==this.szCenterPart?
this.nCenter=e.length-1:"min"==this.szCenterPart?this.nCenter=this.nCenterMin:"max"==this.szCenterPart?this.nCenter=this.nCenterMax:Number(this.szCenterPart)&&(this.nCenter=Number(this.szCenterPart));this.nCenterValue=e[this.nCenter];this.nCenterSize=this.nCenterValue/vb*100}var ra=0,u=Math.max(5,d/2),ya=this.nMax-this.nMin,Tb=this.nMax100-this.nMin100;this.nNormalSizeValue&&(ya=Tb=this.nNormalSizeValue);b.match(/GRIDSIZE/)&&!b.match(/NORMSIZE/)?u=this.nGridSize/d*(b.match(/\bRECT\b/)?.72:.6):b.match(/SIZE/)&&
!b.match(/NORMSIZE/)&&this.szSizeField&&a&&this.itemA[a]?u=b.match(/SIZELOG/)?Math.max(1,u/Math.log(this.nMaxSize)*Math.log(this.itemA[a].nSize)):b.match(/SIZEP4/)?u/Math.pow(this.nMaxSize,.25)*Math.pow(this.itemA[a].nSize,.25):b.match(/3D/)||b.match(/SIZEP3/)||b.match(/SIZEVOLUME/)?u/Math.pow(this.nMaxSize,1/3)*Math.pow(this.itemA[a].nSize,1/3):u/Math.sqrt(this.nMaxSize)*Math.sqrt(this.itemA[a].nSize):b.match(/SIZE/)&&!b.match(/NORMSIZE/)&&(u=b.match(/SIZELOG/)?Math.max(1,u/Math.log(ya)*Math.log(n)):
b.match(/SIZEP4/)?u/Math.pow(ya,.25)*Math.pow(n,.25):b.match(/3D/)||b.match(/SIZEP3/)||b.match(/SIZEVOLUME/)?u/Math.pow(ya,1/3)*Math.pow(n,1/3):u/Math.sqrt(ya)*Math.sqrt(n));ra=map.Scale.normalX(10);b.match(/HEIGHT/)&&!b.match(/NORMSIZE/)&&(ra=b.match(/SIZE/)?this.szSizeField&&a&&this.itemA[a]?ra*Math.pow(10/ya*this.itemA[a].nSize,1/3)*3:ra*Math.pow(10/ya*n,1/3)*3:l&&this.nMax100&&this.nMin100&&!b.match(/FRACTION/)?10*ra/Tb*l:10*ra/ya*n);b.match(/ZOOM/)&&(this.origSize=u*=map.Scale.nObjectScaling,
u=d/10+3*u/Math.log(ya)*Math.log(n)*map.Layer.nDynamicObjectScale,u=Math.min(u,1.2*d),u=Math.max(u,d/2));var M=DonutCharts.newChart(SVGDocument,t,0,0,map.Scale.normalX(u),0);q.x=0;q.y=map.Scale.normalY(u)+map.Scale.normalY(5);M.setStyle("flat");M.setLine("#555566");M.setLineWidth(map.Scale.normalX(this.nLineWidth||.1));b.match(/NOLINES/)&&M.setLine("none");b.match(/WHITELINES/)&&M.setLine("white");this.szLineColor&&M.setLine(this.szLineColor);if(b.match(/3D/)){M.setStyle("3D");var ha=.5;b.match(/P3/)?
ha=1/3:b.match(/P4/)&&(ha=.25);b.match(/SIZE/)&&!b.match(/NORMSIZE/)&&this.szSizeField&&a&&this.itemA[a]?ra=ra/Math.pow(this.nMaxSize,ha)*Math.pow(this.itemA[a].nSize,ha):b.match(/SIZE/)&&!b.match(/NORMSIZE/)&&(ra=ra/Math.pow(ya,ha)*Math.pow(n,ha));b.match(/ZOOM/)&&(ra*=map.Scale.nObjectScaling,ra=ra/this.origSize*u);q.y*=.7}b.match(/VOLUME/)&&M.addStyle("VOLUME");if(b.match(/DONUT/))b.match(/3D/)?M.setRadInner(map.Scale.normalX(.5*u)):b.match(/XTHIN/)?M.setRadInner(map.Scale.normalX(.95*u)):b.match(/THIN/)?
M.setRadInner(map.Scale.normalX(.66*u)):b.match(/THICK/)?M.setRadInner(map.Scale.normalX(.25*u)):M.setRadInner(map.Scale.normalX(.42*u));else if(b.match(/CENTER/)){var jd=Math.sqrt(Math.pow(map.Scale.normalX(u),2)/100*this.nCenterSize);M.setRadInner(jd)}b.match(/STARBURST/)&&(M.addStyle("STARBURST"),q.y*=.8);if(b.match(/XLFLOWER/)||b.match(/XLRAYS/))M.addStyle("XLRAYS"),q.y*=.8;else if(b.match(/LFLOWER/)||b.match(/LRAYS/))M.addStyle("LRAYS"),q.y*=.8;else if(b.match(/XSFLOWER/)||b.match(/XSRAYS/))M.addStyle("XSRAYS"),
q.y*=.8;else if(b.match(/SFLOWER/)||b.match(/SRAYS/))M.addStyle("SRAYS"),q.y*=.8;else if(b.match(/FLOWER/)||b.match(/RAYS/))M.addStyle("RAYS"),q.y*=.8;b.match(/SILENT/)&&M.addStyle("SILENT");b.match(/AUTOCOMPLETE/)&&(M.addStyle("AUTOCOMPLETE"),M.szNoDataColor=this.szNoDataColor||"#eeeeee");b.match(/BIGTOTOP/)&&M.addStyle("BIGTOTOP");b.match(/NOROTATE/)&&M.addStyle("NOROTATE");b.match(/ROTATE/)&&M.addStyle("ROTATE");b.match(/SYMMETRIC/)&&M.addStyle("SYMMETRIC");b.match(/HALF/)&&(M.addStyle("HALF"),
M.addStyle("NOROTATE"));b.match(/DIRECTION/)&&M.addStyle("DIRECTION");b.match(/POLAR/)&&M.addStyle("POLAR");var Ja=0,Nc=0,F=0;if(b.match(/DONUT/))for(h=0;h<e.length;h++)e[h]>e[Ja]&&(Ja=h),e[h]<e[Nc]&&(Nc=h);if(b.match(/STARBURST/)){for(h=0;h<e.length;h++)e[h]=Math.max(e[h],0),F=Math.max(F,this.nMaxA[h]);b.match(/\bSIZE\b/)?M.setMaxValue(this.nMaxValue||F):M.setMaxValue(this.nNormalSizeValue||this.nMaxValue||F)}for(h=0;h<(this.nClipParts?Math.min(this.nClipParts,e.length):e.length);h++){var la="",
da=h;this.sortedIndex&&(da=this.sortedIndex[da].index);if(!b.match(/CENTER/)||b.match(/DONUT/)||da!=this.nCenter){la=this.szLabelA&&this.szLabelA[da]?"  "+this.szLabelA[da]:"  "+this.szFieldsA[da];y=a?this.itemA[a].szColor||this.colorScheme[da]:this.colorScheme[da];if(1==e.length)for(wa=0;wa<this.partsA.length;wa++)if(b.match(/CATEGORICAL/)&&e[da]==this.partsA[wa].min||!b.match(/CATEGORICAL/)&&e[da]<this.partsA[wa].max){y=this.colorScheme[wa];c.setAttributeNS(szMapNs,"class",String(wa));break}var kd=
(b.match(/AUTOCOMPLETE/)&&!this.szUnit.match(/%/)?" % ":"")+this.szUnit;if(this.szShowParts){var ld=y,y="none";for(Y in this.szShowPartsA)this.szShowPartsA[Y]==da&&(y=ld)}if(0<e[da]||0===e[da]&&!b.match(/ZEROISNOTVALUE/)){var Oc=M.addPart(e[da],ra,y,0,(this.szAggregation&&this.szAggregation.match(/sum/),this.formatValue(e[da],this.nValueDecimals||(1>e[da]?2:0),"ROUND")+kd),la);Oc.nClass=da;if(b.match(/DIRECTION/)){var mc=this.itemA[a].ptPos,nc=this.getNodePosition(this.szThemesA[0]+"::"+this.szLabelA[da]);
if(mc&&nc){var md=Math.atan2(mc.y-nc.y,nc.x-mc.x)*(180/Math.PI);Oc.nAngle=(450-md)%360}}}"none"==this.colorScheme[h]&&M.setLine(this.szLineColor||"black")}}2>M.partsA.length&&1==this.itemA[a].nCount&&(M.nRadInner=0,M.nRadOuter*=.85);M.realize();if(b.match(/CENTER/)&&!b.match(/DONUT/)){var m=Math.sqrt(Math.pow(map.Scale.normalX(u),2)/100*this.nCenterSize),y=this.colorScheme[this.nCenter],oc=map.Dom.newShape("circle",t,0,0,.95*m,"fill:"+y+";");oc&&(oc.setAttributeNS(szMapNs,"class",String(this.nCenter)),
oc.setAttributeNS(szMapNs,"tooltip",this.szLabelA?this.szLabelA[this.nCenter]+": "+e[this.nCenter]+this.szUnit+"":e[this.nCenter]+this.szUnit));if(b.match(/CENTERVALUE/)||b.match(/ZOOM/)||b.match(/VALUES/)&&!this.fHideValues){var O=this.formatValue(this.nCenterValue,this.nValueDecimals||0,"ROUND")+(5>=this.szUnit.length?this.szUnit:""),r=__maptheme_getChartColors(y),ma=r.textColor,P=String(Math.min(.8*m,3.3/O.length*m)*this.nValueScale),Pc=map.Dom.newText(t,0,.33*P,"font-family:arial;font-size:"+
P+"px;font-weight:bold;text-anchor:middle;fill:"+ma+";opacity:"+String(this.nOpacity?this.nOpacity:1)+";stroke:none;pointer-events:none",O);Pc&&Pc.setAttributeNS(szMapNs,"class",String(this.nCenter))}}else if(b.match(/CENTERVALUE/)){var O=String(this.itemA[a].nCount||this.itemA[a].nSize),ma=this.szTextColor||"#888888",m=map.Scale.normalX(u),P=String(Math.min(.5*m,2/O.length*m)),qa=this.nValueSizeMin?P/map.Scale.normalX(5):1;map.Dom.newText(t,0,.35*P,"font-family:arial;font-size:"+P+"px;text-anchor:middle;fill:none;stroke:black;stroke-width:"+
P/40+";stroke-opacity:0.5;pointer-events:none;stroke-linejoin:bevel;",O);var D=map.Dom.newText(t,0,.35*P,"font-family:arial;font-size:"+P+"px;text-anchor:middle;fill:"+ma+";opacity:"+qa+";stroke:none;pointer-events:none",O)}b.match(/VALUES/)&&(b.match(/ZOOM/)||!this.szValueUpper||map.Scale.nTrueMapScale*map.Scale.nZoomScale<=this.nValueUpper)&&(P=Math.min(.8*u,3.4/(M.partsA[0]?M.partsA[0].szText.length:1)*u),1<e.length||b.match(/NOINLINETEXT/)||b.match(/ZOOM/)&&6>P?(P=b.match(/ZOOM/)||b.match(/NORMSIZE/)?
map.Scale.normalX(8):map.Scale.normalX(5*(this.nValueScale||1)),this.drawDonutText(M,P)):(O=M.partsA[0]?M.partsA[0].szText:"",r=__maptheme_getChartColors(y),ma=this.szTextColor||r.textColor,m=map.Scale.normalX(u),P=String(Math.min(.8*m,3.4/O.length*m)),qa=this.nValueSizeMin?P/map.Scale.normalX(5):1,b.match(/VOLUME/)&&(ra=M.donutPartsA[0].nHeight),b.match(/3D/)||(ra=.6*m),D=map.Dom.newText(t,0,-ra+m/2+.45*P,"font-family:arial;font-size:"+P+"px;text-anchor:middle;fill:"+ma+";opacity:"+qa+";stroke:none;pointer-events:none",
O),b.match(/3D/)&&(D.fu.setPosition(0,-m/2+P*(b.match(/VOLUME/)?.5:.25)),D.fu.scale(1,.5))));this.fillOpacity&&t.setAttributeNS(null,"fill-opacity",String(this.fillOpacity));this.nOpacity&&(t.setAttributeNS(null,"fill-opacity",String(this.nOpacity)),t.setAttributeNS(null,"stroke-opacity",String(this.nOpacity)));if(b.match(/FADEDEVIATION/)){var Ub=(e[0]-this.nMeanA[0])/this.nDeviationA[0];10<Ub&&(qa=Math.pow(10,.5)/Math.pow(Ub,.5),t.setAttributeNS(null,"opacity",String(qa)))}else b.match(/LIMITDEVIATION/)&&
(Ub=(e[0]-this.nMeanA[0])/this.nDeviationA[0],10<Ub&&t.setAttributeNS(null,"opacity","0"));b.match(/ZOOM/)&&b.match(/STARBURST/);if(1==e.length&&b.match(/CATEGORICAL/))M.donutPartsA[0]&&(M.donutPartsA[0].objNode.setAttributeNS(szMapNs,"class",c.getAttributeNS(szMapNs,"class")),M.donutPartsA[0].textNode&&M.donutPartsA[0].textNode.setAttributeNS(szMapNs,"class",c.getAttributeNS(szMapNs,"class")));else for(h=0;h<M.donutPartsA.length;h++)M.donutPartsA[h]&&(M.donutPartsA[h].objNode.setAttributeNS(szMapNs,
"class",String(M.partsA[h].nClass)),M.donutPartsA[h].textNode&&M.donutPartsA[h].textNode.setAttributeNS(szMapNs,"class",String(M.partsA[h].nClass)));this.nRealizedCount++}else if(b.match(/WAFFLE/)){var za=map.Scale.normalX(d);if(b.match(/GRIDSIZE/))za=1.05*this.nGridSize;else if(b.match(/AUTOSIZE/))var db=map.Layer.nDynamicObjectScale,eb=b.match(/\bRECT\b/)?b.match(/GAP/)?2.3:2:b.match(/GAP/)?1.7:1.6,F=Math.max(fb,this.nMax),za=this.nGridWidthPx?map.Scale.normalX(this.nGridWidthPx)/eb/db:this.nGridWidth?
map.Scale.getDeltaXofDistanceInMeter(this.nGridWidth)/eb/db:B,za=za/Math.sqrt(this.nMaxSize)*Math.sqrt(this.itemA[a].nSize);za*=.97;v=map.Dom.newShape("rect",t,-(za/2)+10,-(za/2)+10,za-20,za-20,"fill:"+(this.szBoxColor||"back")+";stroke:"+(this.szBorderColor||"none")+";stroke-width:"+(this.szBorderWidth||2)+";fill-opacity:"+(this.nBoxOpacity||.05)+";opacity:1;");za*=.9;if(b.match(/\bSORT\b/)){this.sortedIndex=[];for(h=0;h<e.length;h++)this.sortedIndex[h]={index:h,value:e[h]};this.sortedIndex.sort(this.sortIndexDown)}else this.sortedIndex=
null;var k=Math.max(this.nMax,Math.abs(this.nMin)),pc=this.nGridX||(b.match(/WAFFLE100/)?10:Math.max(5,Math.round(Math.sqrt(k))));b.match(/AUTO100/)&&(pc=10);var Gb=za/(1.1*pc),wa=-za/2,Ua=za/2,Qc=0,Vb=1E5;b.match(/WAFFLE100/)&&(Vb=100);for(h=0;h<e.length;h++){var Pa=this.sortedIndex?this.sortedIndex[h].index:h;e[Pa]=Math.round(e[Pa]);if(e[Pa])for(var nd=Math.min(e[Pa],Vb),Vb=Vb-e[Pa],ea=0;ea<nd;ea++)v=map.Dom.newShape("rect",t,wa,Ua-Gb,Gb,Gb,"fill:"+this.colorScheme[Pa]+";stroke:null;fill-opacity:"+
(this.fillOpacity||1)+";opacity:"+(this.nOpacity||1)+";"),v.setAttributeNS(szMapNs,"class",String(Pa)),v.setAttributeNS(szMapNs,"tooltip",this.szLabelA?this.szLabelA[Pa]+": "+e[Pa]+this.szUnit+"":e[Pa]+this.szUnit),wa+=1.1*Gb,++Qc>=pc&&(wa=-za/2,Ua-=1.1*Gb,Qc=0)}this.nRealizedCount++}else if(b.match(/BUBBLE/)||b.match(/SQUARE/)||b.match(/LABEL/)){B=map.Scale.normalX(d/2);b.match(/AUTOSIZE/)&&(db=map.Layer.nDynamicObjectScale,eb=b.match(/\bRECT\b/)?b.match(/GAP/)?2.3:2:b.match(/GAP/)?1.7:1.6,F=Math.max(fb,
this.nMax),B=this.nGridWidthPx?map.Scale.normalX(this.nGridWidthPx)/eb/db:this.nGridWidth?map.Scale.getDeltaXofDistanceInMeter(this.nGridWidth)/eb/db:B);F=Math.max(this.nMax,this.nMaxA[0]);this.nNormalSizeValue&&(this.nMaxSize=F=this.nNormalSizeValue);g=e[0];if(this.szFlag.match(/\bCLIP\b/)&&!this.szFlag.match(/MORPH/)&&this.nClipFrames&&(this.nClipFrames==e.length?(g=Number(e[this.nActualFrame]),F=this.nNormalSizeValue||this.nMaxA[this.nActualFrame]):g=e[0]*(this.nClipFrames-1-this.nActualFrame)/
(this.nClipFrames-1)+e[e.length-1]*this.nActualFrame/(this.nClipFrames-1),0===g&&!b.match(/ZEROISVALUE/))||b.match(/INVERTSIZE/)&&0===F-e[0]&&!b.match(/ZEROISVALUE/))return null;var gb=a&&this.itemA[a]&&this.szSizeField?this.itemA[a].nSize||0:g,wb=a&&this.itemA[a]&&this.szSizeField?this.nMaxSize:F;if(0===gb&&!b.match(/NOSIZE/)||this.nMinValue&&gb<this.nMinValue)return null;var m=b.match(/MENUSIZE/)?map.Scale.normalX(d/2.5):b.match(/LINEAR/)||b.match(/SIZEP1/)?B/wb*Math.abs(gb):b.match(/SIZEP3/)?B/
Math.pow(wb,1/3)*Math.pow(Math.abs(gb),1/3):b.match(/SIZEP4/)?B/Math.pow(wb,.25)*Math.pow(Math.abs(gb),.25):b.match(/SIZELOG/)?Math.max(20,B/Math.log(wb)*Math.log(Math.abs(gb))):b.match(/CATEGORICAL/)&&!this.szSizeField?B/3/(this.nNormalSizeValue||1):b.match(/NOSIZE/)?B/2:b.match(/FIXSIZE/)?B/2/(this.nNormalSizeValue||1):b.match(/ZOOM/)?3*B/3:b.match(/NORMSIZE/)?2*B/3/(b.match(/CATEGORICAL/)?1:Math.log(wb)*Math.log(Math.abs(gb))):b.match(/MENUSIZE/)||b.match(/SUM/)&&!a?2*B/3:B/Math.sqrt(wb)*Math.sqrt(Math.abs(gb)),
pb=!0,K=null,ia=v=null,Qa=null,qb=null,La=D=null,Va=null,y=this.colorScheme[0],A=this.colorScheme[1]?this.colorScheme[1]:"none",ma=this.colorScheme[1]?this.colorScheme[1]:"white";if(2<this.colorScheme.length||b.match(/CATEGORICAL/))y=this.colorScheme[this.colorScheme.length-1],A=this.colorScheme[0];b.match(/NOLINES/)?A="none":"none"==A&&(r=__maptheme_getChartColors(y),A=r.lowColor);if(b.match(/CATEGORICAL/))K=g-1,y=this.colorScheme[K]||this.colorScheme[0],r=__maptheme_getChartColors(y),ma=r.textColor,
A=b.match(/NOLINES/)?"none":r.lowColor,b.match(/RANGE/)&&!b.match(/RANGES/)&&(m=map.Scale.normalX(2+5*(h+1)/this.partsA.length)),pb=!0;else if(this.szFlag.match(/COMPOSECOLOR/))this.szFlag.match(/SUBTRACTIVE/)?this.itemA[a].szColor=__maptheme_getComposedColor_subtractive(this.itemA[a].nValuesA,this.colorScheme,this.nMax,Math.floor(255*this.nBrightness)):this.itemA[a].szColor=__maptheme_getComposedColor_additive(this.itemA[a].nValuesA,this.colorScheme,this.nMax,Math.floor(255*this.nBrightness));else if(2<
this.colorScheme.length||this.szRanges&&this.szRanges.length)if(pb=!1,this.szFlag.match(/DOMINANT/)){for(var Fa=0,Hb=0,H=-1,h=0;h<this.itemA[a].nValuesA.length;h++){var g=this.itemA[a].nValuesA[h],qc=100/this.nMeanA[h]*g,rc=100/this.nMedianA[h]*g,sc=(g-this.nMeanA[h])/this.nDeviationA[h],Fa=g;this.szFlag.match(/PERCENTOFMEAN/)&&(Fa=qc);this.szFlag.match(/PERCENTOFMEDIAN/)&&(Fa=rc);this.szFlag.match(/DEVIATION/)&&(Fa=sc);g>this.nFilterA[h]&&Fa>Hb&&(this.itemA[a].nClass=h,Hb=Fa,H=h)}0<=H&&(this.itemA[a].nDominant=
H,g=this.itemA[a].nValuesA[H],la=" "+this.szFieldsA[H]+" ",this.szLabelA&&this.szLabelA[H]&&(la=" "+this.szLabelA[H]+" "),this.itemA[a].nValue=this.itemA[a].nValuesA[H],this.itemA[a].szLabel=la,y=this.colorScheme[H],r=__maptheme_getChartColors(y),ma=r.textColor,A=b.match(/NOLINES/)?"none":r.lowColor,K=H,pb=!0)}else for(h=0;h<this.partsA.length;h++)if(g>=this.partsA[h].min&&g<this.partsA[h].max){y=this.colorScheme[h];r=__maptheme_getChartColors(y);ma=r.textColor;A=b.match(/NOLINES/)?"none":r.lowColor;
b.match(/RANGE/)&&!b.match(/RANGES/)&&(m=map.Scale.normalX(2+5*(h+1)/this.partsA.length));K=h;pb=!0;break}this.itemA[a]&&(this.itemA[a].szColor=y);ma=this.szTextColor||ma;A=this.szLineColor||A;if(pb){z=this.nLineWidth||.1;z=b.match(/OUTLINE/)?map.Scale.normalX(Math.min(1,1/B*m)):map.Scale.normalX(z/Math.sqrt(B)*Math.sqrt(m));if(b.match(/BUBBLE/)){var aa=null;"$item$"==this.szTimeField?aa=(new Date(this.szFieldsA[H].split(" ")[0])).getTime():a&&(aa=(new Date(this.itemA[a].szTime)).getTime());if(b.match(/GLOW/)&&
!b.match(/ZOOM/)&&this.fGlowInScale){if(v=map.Dom.newShape("circle",t,0,0,6*m,"fill:"+y+";stroke:none;fill-opacity:0.05;pointer-events:none;"))v.setAttributeNS(szMapNs,"class",String(K)),v.setAttributeNS(szMapNs,"time",aa);if(v=map.Dom.newShape("circle",t,0,0,2*m,"fill:"+y+";stroke:none;fill-opacity:0.1;pointer-events:none;"))v.setAttributeNS(szMapNs,"class",String(K)),v.setAttributeNS(szMapNs,"time",aa)}else b.match(/AURA/)&&!b.match(/ZOOM/)&&this.fGlowInScale&&(v=map.Dom.newShape("circle",t,0,0,
1.3*m,"fill:"+(this.szLineColor||y)+";stroke:none;fill-opacity:0.3;"))&&(v.setAttributeNS(szMapNs,"class",String(K)),v.setAttributeNS(szMapNs,"time",aa));v=map.Dom.newShape("circle",t,0,0,m,"fill:"+y+";stroke:"+A+";stroke-width:"+z+";")}else if(b.match(/SQUARE/))v=map.Dom.newShape("rect",t,-m,-m,2*m,2*m,"fill:"+y+";stroke:"+A+";stroke-width:"+z+";");else if(b.match(/TEXTONLY/))v=map.Dom.newShape("rect",t,-m,-8,2.05*m,8,"fill:none;stroke:none;");else if(b.match(/LABEL/)){O=this.formatValue(g,this.nValueDecimals||
(1>g||1>=F?1:0),"ROUND")+(5>=this.szUnit.length?this.szUnit:"");0===g&&(this.szFlag.match(/DIFFERENCE/)||this.szFlag.match(/RELATIVE/)||this.szFlag.match(/SIGN/))?O="+-"+O:0<g&&(this.szFlag.match(/DIFFERENCE/)||this.szFlag.match(/RELATIVE/)||this.szFlag.match(/SIGN/))&&(O="+"+O);var xb=Math.min(.8*m,3.4/O.length*m);if(!this.fShadow&&this.fOrigShadow&&m>map.Scale.normalX(5)){if(v=map.Dom.newShape("rect",t,-m+.02*m,.83*-xb+.02*m,2.05*m,1.6*xb,"fill:#000000;stroke:none;opacity:"+.4*(this.fillOpacity?
this.fillOpacity:1)))v.setAttributeNS(null,"rx",map.Scale.normalX(2*m/B)),v.setAttributeNS(null,"ry",map.Scale.normalX(2*m/B));if(v=map.Dom.newShape("rect",t,-m+.03*m,.83*-xb+.03*m,2.05*m,1.6*xb,"fill:"+y+";stroke:none;opacity:"+.2*(this.fillOpacity?this.fillOpacity:1)))v.setAttributeNS(null,"rx",map.Scale.normalX(2*m/B)),v.setAttributeNS(null,"ry",map.Scale.normalX(2*m/B))}if(v=map.Dom.newShape("rect",t,-m,.83*-xb,2.05*m,1.6*xb,"fill:"+y+";stroke:"+A+";stroke-width:"+z+";"))v.setAttributeNS(null,
"rx",map.Scale.normalX(2*m/B)),v.setAttributeNS(null,"ry",map.Scale.normalX(2*m/B))}if(v){b.match(/SILENT/)||(b.match(/CATEGORICAL/)&&this.szLabelA&&this.szLabelA[g-1]?v.setAttributeNS(szMapNs,"tooltip",this.szLabelA[g-1]+" "+this.szTitle+""):v.setAttributeNS(szMapNs,"tooltip",this.formatValue(g,2)+this.szUnit+" "+this.szTitle+""));D=null;if(b.match(/VALUES/)&&(!this.szValueUpper||map.Scale.nTrueMapScale*map.Scale.nZoomScale<=this.nValueUpper))if(O=null,this.szValueField&&this.itemA[a].szValue?(O=
this.formatValue(__scanValue(this.itemA[a].szValue),this.nValueDecimals||(1>this.itemA[a].szValue?1:0),"ROUND")+(5>=this.szUnit.length?this.szUnit:""),0===g&&(this.szFlag.match(/DIFFERENCE/)||this.szFlag.match(/RELATIVE/)||this.szFlag.match(/\bSIGN\b/))?O="+/-"+O:0<g&&(this.szFlag.match(/DIFFERENCE/)||this.szFlag.match(/RELATIVE/)||this.szFlag.match(/\bSIGN\b/))&&(O="+"+O)):b.match(/CATEGORICAL/)&&this.szLabelA?O=this.szLabelA[g-1]||"?":(O=this.formatValue(g,this.nValueDecimals||(1>g||1>=F?1:0),"ROUND")+
(5>=this.szUnit.length?this.szUnit:""),0===g&&(this.szFlag.match(/DIFFERENCE/)||this.szFlag.match(/RELATIVE/)||this.szFlag.match(/\bSIGN\b/))?O="+/-"+O:0<g&&(this.szFlag.match(/DIFFERENCE/)||this.szFlag.match(/RELATIVE/)||this.szFlag.match(/\bSIGN\b/))&&(O="+"+O)),P=String(Math.min(.8*m,3.3/O.length*m)*this.nValueScale),b.match(/TEXTONLY/)){r=__maptheme_getChartColors(y);ma=r.textColor;P=String(Math.max(Math.min(.8*m,map.Scale.normalX(500)),map.Scale.normalX(2)));if(this.nValueSizeMin&&!b.match(/ZOOM/)&&
P*map.Layer.nDynamicObjectScale<map.Scale.normalX(this.nValueSizeMin))return null;var Ib=this.szTextFont||"arial",La=map.Dom.newText(t,0,0,"font-family:"+Ib+";font-size:"+P+"px;font-weight:normal;text-anchor:middle;fill:none;stroke:"+y+";stroke-width:"+P/7+";stroke-opacity:0.5;pointer-events:none;stroke-linejoin:bevel;",O);La.setAttributeNS(null,"id",this.szId+":"+a+":text:bg");D=map.Dom.newText(t,0,0,"font-family:"+Ib+";font-size:"+P+"px;font-weight:normal;text-anchor:middle;fill:"+(this.szTextColor||
"#000000")+";opacity:"+qa+";stroke:none;",O);D.setAttributeNS(null,"id",this.szId+":"+a+":text");v.parentNode.removeChild(v)}else if(b.match(/ZOOM/)&&P<map.Scale.normalX(6))ma="black",D=map.Dom.newText(t,m+.1*B,-m/2,this.szValuesTextStyle,O);else if(b.match(/LABEL/)||P>map.Scale.normalX(1))qa=this.nValueSizeMin?P/map.Scale.normalX(5):1,D=map.Dom.newText(t,0,.33*P,"font-family:arial;font-size:"+P+"px;font-weight:bold;text-anchor:middle;fill:"+ma+";opacity:"+qa+";stroke:none;pointer-events:none",O);
if(b.match(/DTEXT/)&&a&&!b.match(/ZOOM/)){var Wa=Math.pow(Math.abs(m),1/3)/Math.pow(B,1/3);v.style.setProperty("fill-opacity",String(Wa),"");v.style.setProperty("stroke-opacity",String(Wa),"");D&&D.style.setProperty("fill-opacity",String(Wa),"")}else v.style.setProperty("fill-opacity",String(this.fillOpacity?this.fillOpacity:1),""),b.match(/OUTLINE/)||this.szLineColor?v.style.setProperty("stroke-opacity","1",""):v.style.setProperty("stroke-opacity",String(this.fillOpacity&&.5>this.fillOpacity?1:.3),
"")}null!=K&&(v&&(v.setAttributeNS(szMapNs,"value",String(g)),v.setAttributeNS(szMapNs,"class",String(K))),D&&(D.setAttributeNS(szMapNs,"value",String(g)),D.setAttributeNS(szMapNs,"class",String(K))),La&&(La.setAttributeNS(szMapNs,"value",String(g)),La.setAttributeNS(szMapNs,"class",String(K))));this.szTimeField&&(aa=null,aa="$item$"==this.szTimeField?(new Date(this.szFieldsA[H].split(" ")[0])).getTime():(new Date(this.itemA[a].szTime)).getTime(),v&&v.setAttributeNS(szMapNs,"time",aa),D&&D.setAttributeNS(szMapNs,
"time",aa),La&&La.setAttributeNS(szMapNs,"time",aa));d=2*m/map.Scale.normalX(1);q.x=0;q.y=m+map.Scale.normalY(5);this.nRealizedCount++}else return this.nMissingRangeCount++,null}else if(b.match(/SYMBOL/)){if("undefined"!=typeof this.szSymbolBoxStyle){A="#dddddd";"undefined"!=typeof this.szBorderColor&&(A=this.szBorderColor);var Jb="stroke-width:0;";if("undefined"!=typeof this.szBorderStyle)switch(this.szBorderStyle){case "dotted":Jb="stroke-width:"+map.Scale.normalX(1)+";stroke-linecap:round;stroke-dasharray:1,50;";
break;case "dashed":Jb="stroke-width:"+map.Scale.normalX(1)+";stroke-linecap:butt;stroke-dasharray:30,30;";break;case "solid":Jb="stroke-width:"+map.Scale.normalX(1)+";";break;case "none":Jb="stroke-width:0;"}var rb=map.Dom.newShape("rect",t,0,0,1,1,"fill:white;stroke:"+A+";"+Jb);switch(this.szSymbolBoxStyle){case "frame":rb.setAttributeNS(null,"fill-opacity",0);break;case "field":rb.setAttributeNS(null,"fill-opacity",1)}}if(!this.szSymbolsA)for(this.szSymbolsA=[],h=0;h<e.length;h++)this.szSymbolsA.push("circle");
else if(this.szSymbolsA.length<e.length)for(h=this.szSymbolsA.length;h<e.length;h++)this.szSymbolsA.push(this.szSymbolsA[this.szSymbolsA.length-1]);var Xa=null;b.match(/VALUES|AXIS/)&&(Xa=map.Dom.newGroup(t,this.szId+":"+a+":textgroup"));this.initAngle=0;if(b.match(/\bSORT\b/))if(b.match(/\bBYMEAN\b/)){this.sortedIndex=[];for(h=this.sortedMax=0;h<e.length;h++)this.sortedIndex[h]={index:h,value:e[h],tvalue:e[h],mean:this.nMeanA[h]},this.sortedMax=Math.max(this.sortedMax,e[h]);this.sortedIndex.sort(this.sortMeanUp);
this.initAngle=0}else if(b.match(/\bBYMEDIAN\b/)){this.sortedIndex=[];for(h=this.sortedMax=0;h<e.length;h++)this.sortedIndex[h]={index:h,value:e[h],tvalue:e[h],mean:this.nMedianA[h]},this.sortedMax=Math.max(this.sortedMax,e[h]);this.sortedIndex.sort(this.sortMeanUp);this.initAngle=0}else if(b.match(/\bUP\b/)){this.sortedIndex=[];for(h=this.sortedMax=0;h<e.length;h++)this.sortedIndex[h]={index:h,value:e[h],tvalue:e[h]},this.sortedMax=Math.max(this.sortedMax,e[h]);this.sortedIndex.sort(this.sortIndexUp);
this.initAngle=0}else if(b.match(/\bDOWN\b/)){this.sortedIndex=[];for(h=this.sortedMax=0;h<e.length;h++)this.sortedIndex[h]={index:h,value:e[h],tvalue:e[h]},this.sortedMax=Math.max(this.sortedMax,e[h]);this.sortedIndex.sort(this.sortIndexDown);this.initAngle=0}else{if(b.match(/\bRANDOM\b/)){this.sortedIndex=[];this.sortedMax=0;if(this.nClipParts&&this.nClipParts<e.length){for(var tc=[],h=0;h<e.length;h++)tc[h]={index:h,value:e[h],tvalue:e[h]};tc.sort(this.sortIndexDown);for(h=0;h<this.nClipParts;h++){var uc=
tc[h].index;this.sortedIndex[h]={index:uc,value:e[uc],tvalue:e[uc]};this.sortedMax=Math.max(this.sortedMax,e[h])}}else for(h=0;h<e.length;h++)this.sortedIndex[h]={index:h,value:e[h],tvalue:e[h]},this.sortedMax=Math.max(this.sortedMax,e[h]);a?(this.itemA[a].randomA||(this.itemA[a].randomA=this.getRandomNumberArray(e.length+1)),this.shuffleArray(this.sortedIndex,this.itemA[a].randomA),this.initAngle=Math.floor(360*this.itemA[a].randomA[0])):this.initAngle=0}}else this.sortedIndex=null;if(b.match(/RINGS/)){if(this.sortedIndex)for(var Kb=
0,h=0;h<this.sortedIndex.length;h++)this.sortedIndex[h].value&&(this.sortedIndex[h].value+=Kb,Kb=this.sortedIndex[h].value);else for(Kb=0,this.sortedIndex=[],h=0;h<e.length;h++)this.sortedIndex[h]={index:h,value:e[h],tvalue:e[h]},this.sortedIndex[h].value&&(this.sortedIndex[h].value+=Kb,Kb=this.sortedIndex[h].value);this.sortedIndex.sort(this.sortIndexDown)}var Wb=null,Xb=null,Yb=null,K=0,Ma="",Rc=0,Ga=0,ua=0,Ka=0,fb=-Number.MAX_VALUE,vc=Number.MAX_VALUE,Na=0,wc=0,Sc=0,Ya=!1,Ra=0,Ja=e.length;this.nClipParts&&
this.nClipParts<e.length&&(b.match(/\bUP\b/)?Ra=e.length-this.nClipParts:Ja=this.nClipParts);if(this.szFlag.match(/DOMINANT/)){for(var Hb=Fa=0,Zb=-1,h=0;h<this.itemA[a].nValuesA.length;h++)g=this.itemA[a].nValuesA[h],qc=100/this.nMeanA[h]*g,rc=100/this.nMedianA[h]*g,sc=(g-(this.nMeanA[h]||0))/this.nDeviationA[h],Fa=g,this.szFlag.match(/PERCENTOFMEAN/)&&(Fa=qc),this.szFlag.match(/PERCENTOFMEDIAN/)&&(Fa=rc),this.szFlag.match(/DEVIATION/)&&(Fa=sc),g>(this.nFilterA[h]||0)&&Fa>Hb&&(this.itemA[a].nClass=
h,Hb=Fa,Zb=h);0<=Zb&&(Ra=this.itemA[a].nDominant=Zb,Ja=Ra+1,K=Zb)}else this.szFlag.match(/COMPOSECOLOR/)&&(this.szFlag.match(/SUBTRACTIVE/)?this.itemA[a].szColor=__maptheme_getComposedColor_subtractive(this.itemA[a].nValuesA,this.colorScheme,this.nMax,Math.floor(255*this.nBrightness)):this.itemA[a].szColor=__maptheme_getComposedColor_additive(this.itemA[a].nValuesA,this.colorScheme,this.nMax,Math.floor(255*this.nBrightness)));this.szFlag.match(/CLIP/)&&(Ja=Ra+1);for(h=Ra;h<Ja;h++)wc+=0!==e[h],fb=
Math.max(fb||this.nMaxA[h],this.nMaxA[h]),vc=Math.min(vc||this.nMinA[h],this.nMinA[h]),Na=Math.max(Na,e[h]);if(this.szFlag.match(/STACKED/)&&this.nGridX)for(h=Ra;h<Ja;){for(var xc=0,ea=0;ea<this.nGridX;ea++)xc+=e[h++];Na=Math.max(Na,xc)}for(h=Ra;h<Ja;h++){var H=h,g=e[H],Ha=e[H];this.sortedIndex&&(g=this.sortedIndex[H].value,Ha=this.sortedIndex[H].tvalue,H=this.sortedIndex[H].index);this.szValueField&&this.itemA[a]&&(Ha=__scanValue(this.itemA[a].szValue));if(this.szShowParts){var Lb=!0;for(Y in this.szShowPartsA)this.szShowPartsA[Y]==
H%(this.nGridX||1E6)&&(Lb=!1);if(Lb)continue}if(!b.match(/ZOOM/)||!this.markedClasses||this.markedClasses[H]){K=H;this.nGridX&&b.match(/PLOT/)&&(K%=this.nGridX);if((b.match(/ZOOM/)||b.match(/NORMSIZE/))&&this.szLabelA)var va=this.formatValue(Ha,1>Ha?2:0),Ma=va+this.szUnit,Ma=Ma+(" "+this.szLabelA[H%(this.nGridX||1E7)]);else va=this.formatValue(Ha,2),Ma=" "+va+this.szUnit;aa=null;this.szTimeField&&(aa="$item$"==this.szTimeField?(new Date(this.szFieldsA[H].split(" ")[0])).getTime():(new Date(this.itemA[a].szTime)).getTime());
if(b.match(/CATEGORICAL/)&&!b.match(/AGGREGATE/)&&!b.match(/GROUP/)){var U="";if(this.nRangesA&&this.nRangesA.length)for(ea=0;ea<this.nRangesA.length;ea++)if(g==this.nRangesA[ea]||Number(g)==Number(this.nRangesA[ea])){U=this.szSymbolsA[ea]||this.szSymbolsA[0]||"circle";K=ea;break}U=this.itemA[a].szSymbol||U;Ma=String(g);la=String(g);this.szLabelA&&this.szLabelA[K]&&(Ma=this.szLabelA[K],la=this.szLabelA[K]);U.length||0!==H||(U="empty",Ma=la="no data",K=0);if(U.length){Rc++;v=null;K="undefined"!=typeof this.itemA[a].nClass?
this.itemA[a].nClass:K;y="undefined"!=typeof this.itemA[a].szColor?this.itemA[a].szColor:this.colorScheme[K];if(b.match(/NOLINES/))A="none";else if(A=this.itemA[a].szColor||this.colorScheme[K],"white"==y||"#ffffff"==y)A="gray";A=this.szLineColor||A;if("circle"==U||"square"==U||"label"==U||"carot"==U||"diamond"==U||"triangle"==U||"hexagon"==U||"cross"==U||"empty"==U){m=map.Scale.normalX(d/2);this.szSizeField&&a&&this.itemA[a]&&(m=m/Math.sqrt(this.nNormalSizeValue||this.nMaxSize)*Math.sqrt(this.itemA[a].nSize));
B=map.Scale.normalX(d/2);z=(this.nLineWidth||1)*map.Scale.normalX(Math.min(m/B,1));switch(U){case "empty":v=map.Dom.newShape("circle",t,0,0,m,"fill:#888888;fill-opacity:0;stroke:#888888;stroke-width:"+z+";");break;case "circle":v=map.Dom.newShape("circle",t,0,0,m,"fill:"+y+";stroke:"+A+";stroke-width:"+z+";");break;case "square":v=map.Dom.newShape("rect",t,.8*-m,.8*-m,1.6*m,1.6*m,"fill:"+y+";stroke:"+A+";stroke-width:"+z+";");break;case "cross":var Aa=.4*m,sa=.8*m,v=map.Dom.newShape("path",t,"M 0,-"+
(sa+Aa/2)+" l"+Aa/2+",0 0,"+sa+" "+sa+",0 0,"+Aa+" -"+sa+",0 0,"+sa+" -"+Aa+",0 0,-"+sa+" -"+sa+",0 0,-"+Aa+" "+sa+",0 0,-"+sa+" "+Aa/2+",0 z","fill:"+y+";stroke:"+A+";stroke-width:"+z+";");break;case "diamond":case "carot":(v=map.Dom.newShape("rect",t,.8*-m,.8*-m,1.6*m,1.6*m,"fill:"+y+";stroke:"+A+";stroke-width:"+z+";"))&&v.setAttributeNS(null,"transform","rotate(45)");break;case "triangle":v=map.Dom.newShape("path",t,"M 0,"+m+" l"+1.2*m+",-"+2*m+" -"+2.4*m+",0 "+1.2*m+","+2*m+"z","fill:"+y+";stroke:"+
A+";stroke-width:"+z+";");break;case "hexagon":var Aa=m/2,sa=m*Math.sin(60/180*Math.PI),Mb=m,v=map.Dom.newShape("path",t,"M -"+m+",0 l "+Aa+",-"+sa+" "+Mb+",0 "+Aa+","+sa+" -"+Aa+","+sa+" -"+Mb+",0 -"+Aa+",-"+sa+" z","fill:"+y+";stroke:"+A+";stroke-width:"+z+";");break;case "label":var yc=.8*m,v=map.Dom.newShape("rect",t,.8*-m,.4*-m,1.6*m,.8*m,"fill:"+y+";stroke:"+A+";stroke-width:"+z+";")}if(!v)continue;if(b.match(/HORZ/)){b.match(/VALUES/)&&(r=__maptheme_getChartColors(y),A=r.textColor,D=map.Dom.newText(Xa,
0,0,"font-family:arial;font-size:"+String(m/2)+"px;text-anchor:start;baseline-shift:-90%;fill:#bbbbbb;stroke:none;pointer-events:none",la),D.fu.setPosition(H*m*2,-m-map.Scale.normalX(5)),1<e.length&&setRotate(D,-45));if(b.match(/AXIS/)&&this.szXaxisA&&(!this.fHideValues||b.match(/ZOOM/))){var r=__maptheme_getChartColors(y),A=r.textColor,$b=this.szXaxisA[h],D=map.Dom.newText(Xa,0,0,"font-family:arial;font-size:"+String(m)+"px;text-anchor:start;baseline-shift:-90%;fill:#bbbbbb;stroke:none;pointer-events:none",
$b);D.fu.setPosition(H*m*2+map.Scale.normalX(2),m+map.Scale.normalX(1));1<e.length&&setRotate(D,45)}v.setAttributeNS(szMapNs,"tooltip",Ma);v.fu.setPosition(H*m*2,0)}else!b.match(/VALUES/)||this.fHideValues&&!b.match(/ZOOM/)||(r=__maptheme_getChartColors(y),A=r.textColor,D=map.Dom.newText(Xa,0,0,"font-family:arial;font-size:"+String(m/2)+"px;text-anchor:start;baseline-shift:-45%;fill:#bbbbbb;stroke:none;pointer-events:none",la),D.fu.setPosition(m+map.Scale.normalX(3),-H*(2*m-map.Scale.normalY(0)))),
v.setAttributeNS(szMapNs,"tooltip",Ma),v.fu.setPosition(0,-H*(2*m-map.Scale.normalY(0)));b.match(/OUTLINE/)?(v.style.setProperty("stroke-width",String(map.Scale.normalX(.5))),v.style.setProperty("stroke-opacity","1"),v.style.setProperty("fill-opacity","0.7")):b.match(/DOPACITY/)&&this.szAlphaField?a&&"undefined"!=typeof this.itemA[a].nAlpha&&(ha=1/(this.nDopacityPow||1),qa=(this.nDopacityScale||1)/Math.pow(this.nMaxAlpha,ha)*Math.pow(this.itemA[a].nAlpha,ha),v.style.setProperty("fill-opacity",String(qa),
"")):v.style.setProperty("fill-opacity",String(this.fillOpacity?this.fillOpacity:this.nOpacity?this.nOpacity:1),"")}else{m=map.Scale.normalX(.4*d);U.match(/.svg/)?(v=map.Dom.constructNode("image",t,{"xlink:href":U}),v.setAttributeNS(null,"x",String(map.Scale.normalX(-d/2))),v.setAttributeNS(null,"y",String(map.Scale.normalY(-d))),v.setAttributeNS(null,"width",String(map.Scale.normalX(d))),v.setAttributeNS(null,"height",String(map.Scale.normalY(d)))):v=map.Dom.constructNode("use",t,{"xlink:href":"#"+
U+":antizoomandpan"});v.setAttributeNS(null,"style","fill:"+y+";stroke:"+A);if(this.szSizeField&&a&&this.itemA[a]){var G=1/Math.sqrt(this.nMaxSize)*Math.sqrt(this.itemA[a].nSize);v.fu.scale(G,G)}v.fu.setPosition(map.Scale.normalX(0)+H*map.Scale.normalX(20),map.Scale.normalY(0));0<H&&(map.Dom.newText(t,map.Scale.normalX(-9)+H*map.Scale.normalX(20),0,"font-family:arial;font-size:360px;text-anchor:middle;baseline-shift:-50%;fill:none;stroke:black;stroke-width:60;pointer-events:none;opacity:0.3;","+"),
map.Dom.newText(t,map.Scale.normalX(-9)+H*map.Scale.normalX(20),0,"font-family:arial;font-size:360px;text-anchor:middle;baseline-shift:-50%;fill:white;stroke:none;pointer-events:none;opacity:0.8;","+"));b.match(/VALUES/)&&(r=__maptheme_getChartColors(y),A=r.textColor,D=map.Dom.newText(Xa,0,0,"font-family:arial;font-size:"+String(m/2)+"px;text-anchor:start;baseline-shift:-45%;fill:#bbbbbb;stroke:none;pointer-events:none",la),D.fu.setPosition(m/2+map.Scale.normalX(3),2*-H*m),b.match(/MULTILINE/)&&this.szSizeField&&
a&&this.itemA[a]&&(D=map.Dom.newText(Xa,0,0,"font-family:arial;font-size:"+String(m/2)+"px;text-anchor:start;baseline-shift:-45%;fill:#bbbbbb;stroke:none;pointer-events:none",String(this.itemA[a].nSize)+this.szSizeValueUnits),D.fu.setPosition(m/2+map.Scale.normalX(3),2*-H*m+m/2)))}v.setAttributeNS(szMapNs,"value",String(g));v.setAttributeNS(szMapNs,"class",String(K));v.setAttributeNS(szMapNs,"time",String(aa));this.nRealizedCount++}else this.nMissingRangeCount++}else if(g||b.match(/PLOT|NOSIZE/)){B=
map.Scale.normalX(d/2);F=this.nNormalSizeValue||fb;b.match(/MENUSIZE/)?F=5*Na:!this.nNormalSizeValue||b.match(/SEQUENCE/)&&this.szSizeField||(this.nMaxSize=F=this.nNormalSizeValue);Na&&b.match(/ZOOM/)&&b.match(/SEQUENCE/)&&(F=Na/2+Na/2*Math.pow(F,.5)/Math.pow(Na,.5));if(b.match(/INVERTSIZE/)&&0===F-g&&!b.match(/ZEROISVALUE/))return null;this.szFlag.match(/\bCLIP\b/)&&!this.szFlag.match(/MORPH/)&&this.nClipFrames&&(Ha=g=this.nClipFrames==e.length?Number(e[this.nActualFrame]):e[H]*(this.nClipFrames-
1-this.nActualFrame)/(this.nClipFrames-1)+e[e.length-1]*this.nActualFrame/(this.nClipFrames-1));m=0;b.match(/AUTOSIZE/)&&(db=map.Layer.nDynamicObjectScale,eb=b.match(/\bRECT\b/)?b.match(/GAP/)?2.3:2:b.match(/GAP/)?1.6:1.5,F=Math.max(fb,this.nMax),B=this.nGridWidthPx?map.Scale.normalX(this.nGridWidthPx)/eb/db:this.nGridWidth?map.Scale.getDeltaXofDistanceInMeter(this.nGridWidth)/eb/db:B);m=b.match(/GRIDSIZE/)&&!b.match(/PLOT/)?this.nGridSize/2:b.match(/NOSIZE/)?map.Scale.normalX(d/3):b.match(/FIXSIZE/)?
map.Scale.normalX(d/3)/(this.nNormalSizeValue||1):b.match(/LINEAR/)||b.match(/SIZEP1/)?B/F*g:b.match(/SIZELOG/)?Math.max(1,B/Math.log(F)*Math.log(g)):b.match(/SIZEP4/)?B/Math.pow(F,.25)*Math.pow(g,.25):b.match(/SIZEP3/)||b.match(/SIZEVOLUME/)?B/Math.pow(F,1/3)*Math.pow(g,1/3):B/Math.sqrt(F)*Math.sqrt(g);b.match(/SEQUENCE/)?b.match(/MENUSIZE/)||b.match(/SUM/)&&!a?m*=this.szField100?1:2:b.match(/ZOOM/)&&!b.match(/PLOT/)?m*=2:b.match(/AGGREGATE/)&&b.match(/CATEGORICAL/)||!this.szSizeField||!a||!this.itemA[a]||
(m=b.match(/SIZELOG/)?Math.max(1,m/Math.log(this.nMaxSize)*Math.log(this.itemA[a].nSize)):b.match(/SIZEP4/)?m/Math.pow(this.nMaxSize,.25)*Math.pow(this.itemA[a].nSize,.25):b.match(/SIZEP3/)||b.match(/SIZEVOLUME/)?m/Math.pow(this.nMaxSize,1/3)*Math.pow(this.itemA[a].nSize,1/3):m/Math.sqrt(this.nMaxSize)*Math.sqrt(this.itemA[a].nSize)):b.match(/MENUSIZE/)||b.match(/SUM/)&&!a?m=1.5*B:b.match(/ZOOM/)&&!b.match(/PLOT/)?m=Math.max(m,2*B/3):b.match(/NOSIZE/)?m=B/5:(!b.match(/GRIDSIZE/)&&this.szSizeField&&
a&&this.itemA[a]&&(m=B/Math.sqrt(this.nMaxSize)*Math.sqrt(this.itemA[a].nSize)),b.match(/PLOTXY/)&&(m/=5));if(isNaN(m)||!m)if(m=0,!b.match(/STAR/)&&!b.match(/STACKED/))continue;U=this.szSymbolsA[H];this.szValueField&&b.match(/CATEGORICAL/)&&this.szValuesA&&(Ha=this.szValuesA[H]);if(a&&this.itemA[a].szColor)y=this.itemA[a].szColor,K=this.itemA[a].nClass,this.colorClassUsedA&&(this.colorClassUsedA[K]=!0);else if((b.match(/SEQUENCE/)||b.match(/DOMINANT/))&&this.colorScheme.length==this.partsA.length)y=
this.colorScheme[H%(this.nGridX||1E4)],A=this.colorScheme[H];else if(y=this.colorScheme[0],A=this.colorScheme[1]?this.colorScheme[1]:"none",2<this.colorScheme.length&&(y=this.colorScheme[this.colorScheme.length-1],A=this.colorScheme[0]),b.match(/NOLINES/)?A="none":"none"==A&&(r=__maptheme_getChartColors(y),A=r.textColor),2<this.colorScheme.length||this.szRanges&&this.szRanges.length){for(ea=0;ea<this.partsA.length;ea++)if(b.match(/CATEGORICAL/)&&g==this.partsA[ea].min||!b.match(/CATEGORICAL/)&&g<
this.partsA[ea].max){y=this.colorScheme[ea];r=__maptheme_getChartColors(y);A=r.textColor;b.match(/RANGE/)&&!b.match(/RANGES/)&&(m=map.Scale.normalX(2+5*(ea+1)/this.partsA.length));K=ea;break}b.match(/NOLINES/)&&(A="none")}if("circle"==U||"square"==U||"carot"==U||"diamond"==U||"triangle"==U||"hexagon"==U||"empty"==U||"label"==U||"cross"==U){A=this.szLineColor||A;z=(this.nLineWidth||1)*map.Scale.normalX(Math.min(2*m/B,.2));switch(U){case "empty":v=map.Dom.newShape("circle",t,0,0,m,"fill:#888888;fill-opacity:0;stroke:#888888;stroke-width:"+
z+";");break;case "circle":!this.fShadow&&this.fOrigShadow&&(ia=map.Dom.newShape("circle",t,map.Scale.normalX(.5)+.02*m,map.Scale.normalX(.5)+.02*m,1.02*m,"fill:#000000;stroke:none;opacity:"+.6*(this.fillOpacity?this.fillOpacity:1)));if(b.match(/GLOW/)&&!b.match(/ZOOM/)&&(!this.szGlowUpper||map.Scale.nTrueMapScale*map.Scale.nZoomScale<=this.nGlowUpper)&&(!this.szGlowLower||map.Scale.nTrueMapScale*map.Scale.nZoomScale>=this.nGlowLower)){if(Qa=map.Dom.newShape("circle",t,0,0,6*m,"fill:"+y+";stroke:none;fill-opacity:0.05;pointer-events:none;"))Qa.setAttributeNS(szMapNs,
"class",String(K)),Qa.setAttributeNS(szMapNs,"time",aa);if(qb=map.Dom.newShape("circle",t,0,0,2*m,"fill:"+y+";stroke:none;fill-opacity:0.1;pointer-events:none;"))qb.setAttributeNS(szMapNs,"class",String(K)),qb.setAttributeNS(szMapNs,"time",String(aa))}else b.match(/AURA/)&&!b.match(/ZOOM/)&&(!this.szGlowUpper||map.Scale.nTrueMapScale*map.Scale.nZoomScale<=this.nGlowUpper)&(!this.szGlowLower||map.Scale.nTrueMapScale*map.Scale.nZoomScale>=this.nGlowLower)&&(Qa=map.Dom.newShape("circle",t,0,0,1.3*m,
"fill:"+(this.szLineColor||y)+";stroke:none;fill-opacity:0.3;"))&&(Qa.setAttributeNS(szMapNs,"class",String(K)),Qa.setAttributeNS(szMapNs,"time",String(aa)));v=map.Dom.newShape("circle",t,0,0,m,"fill:"+y+";stroke:"+A+";stroke-width:"+z+";");break;case "square":v=map.Dom.newShape("rect",t,-m,-m,2*m,2*m,"fill:"+y+";stroke:"+A+";stroke-width:"+z+";");break;case "cross":v=map.Dom.newShape("rect",t,1.6*-m,.4*-m,3.2*m,.8*m,"fill:"+y+";stroke:"+A+";stroke-width:"+map.Scale.nFeatureScaling*map.Scale.nObjectScaling+
";");v=map.Dom.newShape("rect",t,.4*-m,1.6*-m,.8*m,3.2*m,"fill:"+y+";stroke:"+A+";stroke-width:"+map.Scale.nFeatureScaling*map.Scale.nObjectScaling+";");break;case "carot":case "diamond":(v=map.Dom.newShape("rect",t,-m,-m,2*m,2*m,"fill:"+y+";stroke:"+A+";stroke-width:"+z+";"))&&v.setAttributeNS(null,"transform","rotate(45)");break;case "triangle":v=map.Dom.newShape("path",t,"M 0,"+m+" l"+1.2*m+",-"+2*m+" -"+2.4*m+",0 "+1.2*m+","+2*m+"z","fill:"+y+";stroke:"+A+";stroke-width:"+z+";");break;case "hexagon":Aa=
m/2;sa=m*Math.sin(60/180*Math.PI);Mb=m;v=map.Dom.newShape("path",t,"M -"+m+",0 l "+Aa+",-"+sa+" "+Mb+",0 "+Aa+","+sa+" -"+Aa+","+sa+" -"+Mb+",0 -"+Aa+",-"+sa+" z","fill:"+y+";stroke:"+A+";stroke-width:"+z+";");break;case "label":if(O=this.formatValue(Ha,this.nValueDecimals||(1>Ha||1>=F?1:0),"ROUND")+(5>=this.szUnit.length?this.szUnit:""),b.match(/TEXTONLY/)){ma=__maptheme_getChartColors(y).textColor;P=String(Math.max(Math.min(.8*m,map.Scale.normalX(500)),map.Scale.normalX(2)));if(this.nValueSizeMin&&
!b.match(/ZOOM/)&&P*map.Layer.nDynamicObjectScale<map.Scale.normalX(this.nValueSizeMin)){v=map.Dom.newShape("rect",t,0,0,0,0,"fill:none;");ia=map.Dom.newShape("rect",t,0,0,0,0,"fill:none;");break}Ib=this.szTextFont||"arial";ia=map.Dom.newText(t,0,0,"font-family:"+Ib+";font-size:"+P+"px;font-weight:bold;text-anchor:middle;fill:none;stroke:"+y+";stroke-width:"+P/7+";stroke-opacity:0.5;pointer-events:none;stroke-linejoin:bevel;",O);ia.setAttributeNS(null,"id",this.szId+":"+a+":text:bg");v=map.Dom.newText(t,
0,0,"font-family:"+Ib+";font-size:"+P+"px;font-weight:bold;text-anchor:middle;fill:#000000;opacity:"+qa+";stroke:none;",O);v.setAttributeNS(null,"id",this.szId+":"+a+":text")}else{P=String(Math.max(1,Math.min(.8*m,3.4/O.length*m)));if(this.nValueSizeMin&&!b.match(/ZOOM/)&&P*map.Layer.nDynamicObjectScale<map.Scale.normalX(this.nValueSizeMin)){v=map.Dom.newShape("rect",t,0,0,0,0,"fill:none;");break}yc=1.6*P;if(v=map.Dom.newShape("rect",t,-m,.83*-P,2.05*m,1.6*P,"fill:"+y+";stroke:"+A+";stroke-width:"+
z+";"))v.setAttributeNS(null,"rx",map.Scale.normalX(2*m/B)),v.setAttributeNS(null,"ry",map.Scale.normalX(2*m/B))}}v&&(b.match(/OUTLINE/)?(v.style.setProperty("stroke-width",String(map.Scale.normalX(.5))),v.style.setProperty("stroke-opacity","1"),v.style.setProperty("fill-opacity","0.7")):b.match(/RANDOM/)?(v.style.setProperty("stroke-opacity",String(this.nOpacity?this.nOpacity:1),""),v.style.setProperty("fill-opacity",String(this.fillOpacity?this.fillOpacity:this.nOpacity?this.nOpacity:1),""),b.match(/DOPACITY/)&&
(ha=1/(this.nDopacityPow||1),qa=Math.pow(g,ha)/Math.pow(this.sortedMax,ha)*(this.nOpacity||1)*(this.nDopacityScale||1),v.style.setProperty("fill-opacity",String(qa),""))):b.match(/\bSORT\b/)&&b.match(/DOPACITY/)?(v.style.setProperty("stroke-opacity",String(this.nOpacity?this.nOpacity:1),""),ha=1/(this.nDopacityPow||1),qa=Math.pow(g,ha)/Math.pow(this.sortedMax,ha)*(this.nOpacity||1)*(this.nDopacityScale||1),v.style.setProperty("fill-opacity",String(qa),"")):b.match(/DOPACITY/)&&this.szAlphaField?a&&
"undefined"!=typeof this.itemA[a].nAlpha&&(ha=1/(this.nDopacityPow||1),qa=(this.nDopacityScale||1)/Math.pow(this.nMaxAlpha,ha)*Math.pow(this.itemA[a].nAlpha,ha),v.style.setProperty("fill-opacity",String(qa),"")):b.match(/DOPACITY/)?(ha=1/(this.nDopacityPow||1),qa=Math.pow(g-this.nMin,ha)/Math.pow(this.nMax-this.nMin,ha)*(this.fillOpacity||1)*(this.nDopacityScale||1),v.style.setProperty("fill-opacity",String(qa),""),b.match(/CATEGORICAL/)||(K=Math.min(6,Math.ceil((g-this.nMin)/(this.nMax-this.nMin)*
7)),v.setAttributeNS(szMapNs,"class",String(K)),t.setAttributeNS(szMapNs,"class",String(K)),c.setAttributeNS(szMapNs,"class",String(K)))):v.style.setProperty("fill-opacity",String(this.fillOpacity?this.fillOpacity:this.nOpacity?this.nOpacity:1),""),this.chartGroup&&this.chartGroup.style.setProperty("opacity","1",""),v.setAttributeNS(szMapNs,"tooltip",Ma),v.setAttributeNS(szMapNs,"time",aa))}else if(!b.match(/MULTIPLE/)||b.match(/NORMSIZE/)||b.match(/MENUSIZE/))U.match(/.svg/)?(v=map.Dom.constructNode("image",
t,{"xlink:href":U}),v.setAttributeNS(null,"x",String(map.Scale.normalX(-d/2))),v.setAttributeNS(null,"y",String(map.Scale.normalY(-d/2))),v.setAttributeNS(null,"width",String(map.Scale.normalX(d))),v.setAttributeNS(null,"height",String(map.Scale.normalY(d)))):v=map.Dom.constructNode("use",t,{"xlink:href":"#"+U+":antizoomandpan"}),map.Dom.newShape("circle",t,0,0,.5*m,"fill:white;stroke:none;opacity:0"),v.fu.scale(m/B,m/B),v.setAttributeNS(null,"style","fill:"+y+";stroke:"+A);else for(var v=map.Dom.newGroup(t,
t.getAttributeNS(null,"id")+":multiple"),ac=0;ac<g;ac++){if(U.match(/.svg/)){var hb=map.Dom.constructNode("image",t,{"xlink:href":U});hb.setAttributeNS(null,"x",String(map.Scale.normalX(-d/2)));hb.setAttributeNS(null,"y",String(map.Scale.normalY(-d/2)));hb.setAttributeNS(null,"width",String(map.Scale.normalX(d)));hb.setAttributeNS(null,"height",String(map.Scale.normalY(d)))}else hb=map.Dom.constructNode("use",v,{"xlink:href":"#"+U+":antizoomandpan"});hb.fu.setPosition(ac*(B+map.Scale.normalX(1)),
0);hb.fu.scale(1,1);hb.setAttributeNS(null,"style","fill:"+y+";stroke:"+A);map.Dom.newShape("circle",v,ac*B,0,.5*m,"fill:white;stroke:none;opacity:0")}if(v&&b.match(/VALUES/)&&!b.match(/TEXTONLY/)&&(!this.fHideValues||b.match(/ZOOM/))){D=null;O=Ha;isNaN(Ha)||(O=this.formatValue(Ha,this.nValueDecimals||"")+(5>=this.szUnit.length?this.szUnit:""));var od=Math.max(fb,this.nMax),pd=this.formatValue(od,this.nValueDecimals||"")+(5>=this.szUnit.length?this.szUnit:""),qd=Math.max((Ha.length||0)+1,pd.length),
r=__maptheme_getChartColors(y),ma=this.szTextColor||r.textColor,P=String(Math.min(1*B,("hexagon"==U?2.7:3.2)/qd*B)),P=m/B*P*this.nValueScale;if(b.match(/ZOOM/)&&b.match(/LINES/)&&!b.match(/INLINETEXT/)&&(null==this.nGridX||1>=this.nGridX||b.match(/STACKED/))){var ma="black",E=E||map.Dom.newGroup(c,this.szId+":"+a+":textchartontop"),P=4+.5*e.length/(this.nGridX?2*this.nGridX:1),Tc=Math.log(e.length)/3,D=this.createTextLabel(SVGDocument,E,"",O,P*Tc,"","rgba(255,255,255,0.3)",r.lowColor,"GLOW");D.setAttributeNS(null,
"opacity","0.9");E.fu.setPosition(.7*-map.Scale.normalX(P*Tc),-map.Scale.normalY(5/(this.nGridX||1)))}else if(b.match(/ZOOM/)&&!b.match(/SEQUENCE/))ma="black",D=map.Dom.newText(t,.5*m+.2*B,-m/2,this.szValuesTextStyle,O);else if("circle"==U||"square"==U||"triangle"==U||"hexagon"==U||"label"==U||"empty"==U)if(b.match(/CENTERVALUES/))0===K&&(D=map.Dom.newText(t,0,.33*P,"font-family:arial;font-size:"+P+"px;text-anchor:middle;fill:"+ma+";stroke:none;pointer-events:none",O));else if((b.match(/CENTER/)||
b.match(/TOP/)||b.match(/BOTTOM/))&&!b.match(/DOMINANT/)){if(g){var J=6;this.szChartFlag+="|VALUEBACKGROUND";var x=x||map.Dom.newGroup(c,this.szId+":"+a+":chartontop"),Ka=Ka?Ka:m,Uc=-map.Scale.normalX(1),Vc=-map.Scale.normalX(1.33*J)*(wc-Sc-1),D=this.createTextLabel(SVGDocument,x,"",O,J,"",y,this.szTextColor);D.fu.setPosition(Uc,Vc);if(a&&(b.match(/ZOOM/)||b.match(/NORMSIZE/))&&this.szLabelA){var rd=D.fu.getBox().width,D=map.Dom.newText(x,0,0,this.szValuesTextStyle+";color:#000;",this.szLabelA[H]);
D.fu.setPosition(Uc+rd+map.Scale.normalX(6),Vc-map.Scale.normalX(-1));D.fu.scale(.6,.6)}D.setAttributeNS(szMapNs,"class",String(K%(this.nGridX||1E6)));D=null;Sc++}}else if(this.szValueField&&b.match(/2VALUES/))var D=map.Dom.newText(t,0,.2*-P,"font-family:arial;font-size:"+P+"px;text-anchor:middle;fill:"+ma+";stroke:none;pointer-events:none",O),Wc=Math.min(.8*P,120),va=this.formatValue(g,this.nValueDecimals||0)+this.szUnit,Va=map.Dom.newText(t,0,P-.2*Wc,"font-family:arial;font-size:"+Wc+"px;text-anchor:middle;fill:"+
ma+";stroke:none;pointer-events:none",va);else D=map.Dom.newText(t,0,.33*P,"font-family:arial;font-size:"+P+"px;text-anchor:middle;fill:"+ma+";stroke:none;pointer-events:none",O);else P=Math.max(.8*m,1),x=x||map.Dom.newGroup(c,this.szId+":"+a+":chartontop"),D=this.createTextLabel(SVGDocument,x,"",O,P/map.Scale.normalX(1),"",y),D.fu.setPosition(map.Scale.normalX(0)+Ga,map.Scale.normalY(0)+ua)}if(v&&(v.setAttributeNS(szMapNs,"class",String(K%(this.nGridX||1E6))),v.setAttributeNS(szMapNs,"time",aa),
D&&(D.setAttributeNS(szMapNs,"class",String(K%(this.nGridX||1E6))),D.setAttributeNS(szMapNs,"time",aa),D.setAttributeNS(szMapNs,"tooltip",Ma)),Va&&(Va.setAttributeNS(szMapNs,"class",String(K%(this.nGridX||1E6))),Va.setAttributeNS(szMapNs,"time",aa)),ia&&(ia.setAttributeNS(szMapNs,"class",String(K%(this.nGridX||1E6))),ia.setAttributeNS(szMapNs,"time",aa)),!b.match(/CENTER/))){var ka=null;if(b.match(/STAR/)){if(0===h&&(Wb=v,Xb=D,Yb=Va,Ka=m,b.match(/EXPAND/)&&b.match(/\bSORT\b/)&&b.match(/\bUP\b/)&&
(Ka=b.match(/LINEAR/)||b.match(/SIZEP1/)?(b.match(/EXPANDMAX/)?2:.5)*B/F*this.sortedIndex[e.length-1].value:(b.match(/EXPANDMAX/)?2:.5)*B/Math.sqrt(F)*Math.sqrt(this.sortedIndex[e.length-1].value)),b.match(/ZOOM/)&&b.match(/STAR/)&&b.match(/\bUP\b/)?Ka*=2:b.match(/COMPRESS/)&&(Ka*=b.match(/COMPRESSMAX/)?.25:.5)),(0<h||b.match(/\bUP\b/))&&m){var sd=this.nClipParts&&this.nClipParts<this.partsA.length?this.nClipParts:this.partsA.length,zc=m,Xc=Ka+m,td=Math.sqrt(Math.pow(Xc,2)-Math.pow(zc,2)),bc=90-Math.asin(zc*
td/Xc/zc)/Math.PI*180,ib=Ka+m;b.match(/\bUP\b/)&&(5<h&&(bc/=1+m/B*2),ib=Ka*(1+sd/5));b.match(/ZOOM/)||(ib=this.nRangeScale?ib*this.nRangeScale:b.match(/EXPANDMAX/)?2*ib:b.match(/EXPAND/)?1.5*ib:ib);this.initAngle+=bc;Ga=Math.cos(this.initAngle/180*Math.PI)*ib;ua=Math.sin(this.initAngle/180*Math.PI)*ib;this.initAngle+=bc;ka=new point(map.Scale.normalX(0)+Ga,map.Scale.normalY(0)+ua)}}else if(b.match(/RANDOM/)){var cc=b.match(/EXPANDMAX/)?2*m:b.match(/EXPAND/)?1.5*m:m;b.match(/ZOOM/)&&(B*=2,cc*=2);Ga=
Math.cos(this.initAngle+360/this.partsA.length*h/180*Math.PI)*Math.min(B,cc);ua=Math.sin(this.initAngle+360/this.partsA.length*h/180*Math.PI)*Math.min(B,cc);ka=new point(map.Scale.normalX(0)+Ga,map.Scale.normalY(0)+ua)}else b.match(/HORZ/)?(Ga+=m,ka=new point(map.Scale.normalX(0)+Ga,map.Scale.normalY(0)+ua),Ga+=m):b.match(/BOTTOM/)?ka=new point(map.Scale.normalX(0),-m):b.match(/TOP/)?ka=new point(.3*-m,.7*m-B):b.match(/CONE/)?ka=new point(map.Scale.normalY(.33*h),-map.Scale.normalY(1*h)):b.match(/BASE/)&&
(ka=new point(map.Scale.normalX(0),ua-m),ua-=m*(b.match(/VALUES/)?1.25:1));ka?(v.fu.setPosition(ka.x,ka.y),ia&&ia.fu.setPosition(ka.x,ka.y),Qa&&Qa.fu.setPosition(ka.x,ka.y),qb&&qb.fu.setPosition(ka.x,ka.y),D&&D.fu.setPosition(ka.x,ka.y),Va&&Va.fu.setPosition(ka.x,ka.y)):Va&&Va.fu.setPosition(0,0);if(b.match(/PLOT/)){0!==g||b.match(/STACKED/)||(v.parentNode.removeChild(v),ia&&ia.parentNode.removeChild(ia),D&&D.parentNode.removeChild(D));var C=map.Scale.normalX(d)*(b.match(/LINES/),1),T=h*C;this.nGridX&&
(T=b.match(/PLOTVAR/)?Math.floor(h%this.nGridX)*C:Math.floor(h/this.nGridX)*C);var F=fb||this.nMax,F=Math.max(Na,F),F=this.nMaxValuePlot="undefined"!==typeof this.nMaxValue?this.nMaxValue:F,na=this.nMinValuePlot="undefined"!==typeof this.nMinValue?this.nMinValue:Math.min(this.nMin,vc);if("inherit"==this.nMaxValue)for(var Nb=0;Nb<this.parent.themesA.length;Nb++)this.parent.themesA[Nb]!=this&&this.parent.themesA[Nb].nMaxValuePlot&&(F=this.parent.themesA[Nb].nMaxValuePlot);"auto"==this.nMaxValue&&(F=
this.nMaxValuePlot=Na);G=map.Scale.normalX(d)/(F-na)*(this.nGridX||e.length-1)*(this.nRangeScale||1);if(!Ya){var Yc=this.szId+":"+this.itemA[a].szSelectionId+":chartgrid",ba=SVGDocument.getElementById(Yc);if(!ba||b.match(/ZOOM/))x=x||map.Dom.newGroup(c,this.szId+":"+a+":chartontop"),ba=map.Dom.newGroup(x,Yc)}if(b.match(/PLOTXY/))Ya||(Ya=!0,b.match(/BOX/)&&b.match(/\bGRID\b/)&&!ba.childNodes.length&&(map.Dom.newShape("line",ba,0,0,this.nChartWidth+100,0,"stroke:#888888;stroke-width:"+map.Scale.normalX(.3)+
";"),map.Dom.newShape("line",ba,0,0,0,-this.nChartHeight-100,"stroke:#888888;stroke-width:"+map.Scale.normalX(.3)+";"),map.Dom.newText(ba,10,80,"font-family:arial;font-size:80px;text-anchor:start;fill:#444444;stroke:none;pointer-events:none;",String(this.nMinX)),map.Dom.newText(ba,this.nChartWidth+100,80,"font-family:arial;font-size:80px;text-anchor:end;fill:#444444;stroke:none;pointer-events:none;",String(this.nMaxX)),map.Dom.newText(ba,-10,10,"font-family:arial;font-size:80px;text-anchor:end;fill:#444444;stroke:none;pointer-events:none;",
String(this.nMinY)),map.Dom.newText(ba,-10,-this.nChartHeight-100+80,"font-family:arial;font-size:80px;text-anchor:end;fill:#444444;stroke:none;pointer-events:none;",String(this.nMaxY)))),wa=50+(this.itemA[a].nX-this.nMinX)*this.nChartWidth/this.nRangeX,Ua=-100-(this.itemA[a].nY-this.nMinY)*this.nChartHeight/this.nRangeY,v.fu.setPosition(wa,Ua),ia&&ia.fu.setPosition(wa,Ua),Qa&&Qa.fu.setPosition(wa,Ua),qb&&qb.fu.setPosition(wa,Ua),D&&D.fu.setPosition(wa,Ua);else if(b.match(/PLOTYX/))v.fu.setPosition((F+
Math.abs(F-g))*G,T),ia&&ia.fu.setPosition((F+Math.abs(F-g))*G,T),D&&D.fu.setPosition((F+Math.abs(F-g))*G,T);else if(b.match(/PLOTY/)){v.fu.setPosition(0,(-F+Math.abs(F-g))*G);ia&&ia.fu.setPosition(0,(-F+Math.abs(F-g))*G);D&&D.fu.setPosition(0,(-F+Math.abs(F-g))*G);var W=1,W=F/5,W=10*Math.ceil(W/(10*Math.floor(Math.log(W))))*Math.floor(Math.log(W))||1,F=Math.ceil(F/W)*W;if(!Ya&&(Ya=!0,b.match(/BOX/)&&b.match(/\bGRID\b/)))for(var X=map.Scale.normalX(d)/2;X<F*G;X+=G*W)map.Dom.newShape("line",ba,-20,
-X,20,-X,"stroke:#444444;stroke-width:"+map.Scale.normalX(1)+";")}else if(b.match(/PLOTX/)){if(v.fu.setPosition((F-Math.abs(F-g))*G,0),ia&&ia.fu.setPosition((F-Math.abs(F-g))*G,0),D&&D.fu.setPosition((F-Math.abs(F-g))*G,0),W=1,W=F/5,W=10*Math.ceil(W/(10*Math.floor(Math.log(W))))*Math.floor(Math.log(W))||1,F=Math.ceil(F/W)*W,!Ya&&(Ya=!0,b.match(/BOX/)&&b.match(/\bGRID\b/)))for(X=map.Scale.normalX(d);X<F*G+map.Scale.normalX(d);X+=G*W)map.Dom.newShape("line",ba,X,-20,X,20,"stroke:#444444;stroke-width:"+
map.Scale.normalX(1)+";")}else{W=1;W=Math.ceil(F-na)/5;.5>W&&(W=Math.ceil(F-na)/10);if(1<W)var Zc=Math.pow(10,Math.floor(Math.log10(W))),W=Math.ceil(W/Zc)*Zc||1;F=Math.ceil(F/W)*W;for(na=Math.floor(na/W)*W;5>(F-na)/W;)W/=2;5<(F-na)/W&&(W*=2);if(!Ya){Ya=!0;this.plot_last_last_position=[];this.plot_last_position=[];this.plot_last_value=[];this.plot_last_stacked_value=[];this.plot_last_shape=[];this.plot_last_mean=[];this.plot_last_areaValue=[];this.plot_area_points=[];this.plot_area_shapes=[];this.plot_area_shapes[0]=
map.Dom.newShape("path",t,"M0,0","fill:"+y+";fill-opacity:"+(this.fillOpacity||1)+";stroke:none");var dc=e.length/(this.nGridX||1),yb=map.Scale.normalX(Math.max(e.length/(this.nGridX||1),3)),yb=yb*(b.match(/ZOOM/),1),Ob=map.Dom.newGroup(t,"");Ob.parentNode.insertBefore(Ob,t.firstChild);if(b.match(/BOX/)&&b.match(/\bGRID\b/)&&!(!b.match(/ZOOM/)&&this.nBoxUpper&&map.Scale.nTrueMapScale*map.Scale.nZoomScale>this.nBoxUpper)){if(!b.match(/ZOOM/)){var zb=-C/(b.match(/LINES/)?3:1),Ab=C*(this.nGridX?e.length/
this.nGridX-1:e.length-1);map.Dom.newShape("rect",t,0,-(F-na)*G,Ab,(F-na)*G,"fill:#ffffff;fill-opacity:0;stroke:none;")}for(var Ac=.8,ud=0,X=0;X<=(F-na)*G;X+=G*W){var Bc=this.formatValue(Math.round(b.match(/INVERT/)?F-X/G+na:100*(X/G+na))/100,2);5<F&&(Bc=String(Math.round(b.match(/INVERT/)?F-X/G+na:X/G+na)));var Oa=X;b.match(/LOG/)&&(Oa=100*Math.pow(10,ud++),Oa>F&&(X=F*G),Bc=this.formatValue(Oa,0),Oa=Math.log10(Oa)*F/Math.ceil(Math.log10(F))*G);zb=-C/(b.match(/LINES/)?3:1);Ab=C*(this.nGridX?e.length/
this.nGridX-1:e.length-1);b.match(/PLOTVAR/)&&1<e.length/this.nGridX&&(Ab=C*this.nGridX);if(b.match(/GRADIENT/)&&0!==X)var $c=Ab+(b.match(/LINES/),0),I=map.Dom.newShape("path",t,"M"+zb+","+-X+" L "+$c+","+-X+" "+$c+","+(-X+G*W)+" "+zb+","+(-X+G*W)+" z","fill:#d8d8dd;fill-opacity:"+Ac+";stroke:none;"),Ac=Ac-.3;0===Oa?map.Dom.newShape("line",ba,zb,-Oa,Ab,-Oa,"stroke:#888888;stroke-opacity:0.5;stroke-width:"+map.Scale.normalX(.05*dc)+";"):map.Dom.newShape("line",ba,zb,-Oa,Ab,-Oa,"stroke:#888888;stroke-opacity:0.4;stroke-width:"+
map.Scale.normalX(.05*dc)+";stroke-dasharray:"+6*dc+" "+3*dc+";");map.Dom.newText(ba,1.1*zb,-Oa+.3*yb,"font-family:arial;font-size:"+yb+"px;text-anchor:end;fill:#888888;stroke:none;pointer-events:none;",Bc);this.nPlotHeight=X}map.Dom.newShape("line",ba,T,0,T,-(F-na)*G,"stroke:#aaaaaa;stroke-width:"+map.Scale.normalX(.1)+";");if(this.szXaxisA&&this.szXaxisA.length)for(X=0;X<this.szXaxisA.length;X++)if(this.szXaxisA[X].length&&" "!=this.szXaxisA[X]||0==X||X==this.szXaxisA.length-1)map.Dom.newShape("line",
ba,C*X,100,C*X,-(F-na)*G,"stroke:#888888;stroke-opacity:0.4;stroke-width:"+map.Scale.normalX(.05*this.szXaxisA.length)+";stroke-dasharray:"+6*this.szXaxisA.length+" "+3*this.szXaxisA.length+";"),map.Dom.newText(ba,C*X,1.5*yb,"font-family:arial;font-size:"+yb+"px;text-anchor:middle;fill:#888888;stroke:none;pointer-events:none;",this.szXaxisA[X])}map.Dom.setClipRect(t,{x:-100,y:-(F-na)*G,width:100+Ja/(this.nGridX||1)*C,height:100+(F-na)*G})}var Sa=this.nGridX?Math.floor(h/this.nGridX)+1:1,S=this.nGridX?
h%this.nGridX:1;b.match(/LOG/)&&g&&(g=Math.log10(g)*F/Math.ceil(Math.log10(F)));var oa=b.match(/INVERT/)?F-g:g,oa=oa-na,oa=oa+(b.match(/STACKED/)?this.plot_last_stacked_value[Sa]||0:0);v.fu.setPosition(T,-oa*G);ia&&ia.fu.setPosition(T,-oa*G);if(D&&D.parentNode){if(10<this.nXLen){var Bb=Math.floor(h/(this.nGridX||1));0!=Bb&&Bb!=this.nXLen-2&&(!this.szXaxisA||!this.szXaxisA.length||100<this.nXLen&&Bb>=this.nXLen-5?D.parentNode.removeChild(D):this.szXaxisA[Bb]&&this.szXaxisA[Bb].length&&" "!=this.szXaxisA[Bb]?
v.fu.scaleBy(4,4):D.parentNode.removeChild(D))}b.match(/\bINLINETEXT\b/)?D.fu.setPosition(T,-oa*G):b.match(/LINES/)&&(null==this.nGridX||1>=this.nGridX||b.match(/STACKED/))?(D.fu.setPosition(T-map.Scale.normalX(d/4),-oa*G+map.Scale.normalY(d/4)/(this.nGridX||1)),D.fu.scale(1.5,1.5)):(D.fu.scale(1.5,1.5),D.fu.setPosition(T,-oa*G))}if(b.match(/LINES/)){var I=null;if(b.match(/ZEROISVALUE/)&&this.plot_last_position[S]&&(g||this.plot_last_position[S].y)||g&&this.plot_last_position[S]&&this.plot_last_position[S].y)if(b.match(/AREA/)){if(I=
map.Dom.newShape("path",Ob,"M"+(this.plot_last_position[S].x-2)+","+this.plot_last_position[S].y+" L "+T+","+-oa*G+" "+T+","+(-oa+g-na)*G+" "+(this.plot_last_position[S].x-2)+","+(this.plot_last_last_position[S-1]?this.plot_last_last_position[S-1].y:0)+" z","fill:"+y+";fill-opacity:"+(this.fillOpacity||1)+";")){I.setAttributeNS(szMapNs,"value",String(g));I.setAttributeNS(szMapNs,"class",String(K%(this.nGridX||1E6)));var Cc=25>this.nXLen?this.formatValue(this.plot_last_areaValue[S],this.nValueDecimals||
2)+" ... "+this.formatValue(g,this.nValueDecimals||2):this.formatValue(g,this.nValueDecimals||2);I.setAttributeNS(szMapNs,"tooltip",Cc+this.szUnit+" "+(this.szLabelA?this.szLabelA[K%(this.nGridX||1E6)]:""));I.setAttributeNS(szMapNs,"time",String(aa));if(this.szFlag.match(/\bFADE\b/)){var ad="Gradient"+Math.random(),bd=map.Dom.constructNode("linearGradient",t,{id:ad,gradientTransform:"rotate(90)"});map.Dom.constructNode("stop",bd,{offset:"0","stop-color":y,"stop-opacity":"1"});map.Dom.constructNode("stop",
bd,{offset:"1","stop-color":y,"stop-opacity":"0.1"});I.style.setProperty("fill","url(#"+ad+")")}}var vd=1==h||h==Ja-1||2==Sa||Sa==Ja/(this.nGridX||1)?"but":"round";if(I=map.Dom.newShape("line",Ob,this.plot_last_position[S].x,this.plot_last_position[S].y,T,-oa*G,"stroke:"+y+";stroke-width:"+map.Scale.normalX(b.match(/STACKED/)?1:this.nLineWidth||3)+";stroke-linecap:"+vd+";"))I.setAttributeNS(szMapNs,"value",String(g)),I.setAttributeNS(szMapNs,"tooltip",this.formatValue(g,this.nValueDecimals||2)+this.szUnit+
" "+(this.szLabelA?this.szLabelA[K%(this.nGridX||1E6)]:""))}else{I=map.Dom.newShape("line",Ob,this.plot_last_position[S].x,this.plot_last_position[S].y,T,-oa*G,"stroke:"+(this.szLineColor||y)+";stroke-width:"+map.Scale.normalX(this.nLineWidth||3)+";stroke-linecap:round;");Cc=25>this.nXLen?this.formatValue(this.plot_last_areaValue[S],this.nValueDecimals||2)+" ... "+this.formatValue(g,this.nValueDecimals||2):this.formatValue(g,this.nValueDecimals||2);I&&(I.setAttributeNS(szMapNs,"value",String(g)),
I.setAttributeNS(szMapNs,"class",String(K%(this.nGridX||1E6))),I.setAttributeNS(szMapNs,"tooltip",Cc+this.szUnit+" "+(this.szLabelA?this.szLabelA[K%(this.nGridX||1E6)]:"")),I.setAttributeNS(szMapNs,"time",String(aa)));try{t.insertBefore(I,this.plot_last_shape[S])}catch(Dd){}}b.match(/LOLLIPOP/)&&g&&(I=map.Dom.newShape("line",ba,T,0,T,-oa*G,"stroke:"+y+";stroke-width:"+map.Scale.normalX(3)+";stroke-linecap:round;"))&&(I.setAttributeNS(szMapNs,"value",String(g)),I.setAttributeNS(szMapNs,"class",String(K%
(this.nGridX||1E6))),I.setAttributeNS(szMapNs,"time",String(aa)));if(b.match(/PLOTVAR/)){var ta=b.match(/MEDIAN/)?this.nMedianA[H]:this.nMeanA[H],ta=ta-na;this.plot_last_mean[S]&&((I=map.Dom.newShape("path",ba,"M"+this.plot_last_mean[S].x+","+(this.plot_last_mean[S].y-this.nDeviationA[H-1]*G)+" L "+T+","+(-ta-this.nDeviationA[H])*G+" "+T+","+(-ta+this.nDeviationA[H])*G+" "+this.plot_last_mean[S].x+","+(this.plot_last_mean[S].y+this.nDeviationA[H-1]*G)+" z","fill:#d8d8dd;fill-opacity:0.2;stroke:none;"))&&
I.setAttributeNS(szMapNs,"tooltip","standard deviation"),(I=map.Dom.newShape("line",t,this.plot_last_mean[S].x,this.plot_last_mean[S].y,T,-ta*G,"stroke:#888888;stroke-width:"+map.Scale.normalX(2)+";stroke-linecap:round;stroke-dasharray:10 80;"))&&I.setAttributeNS(szMapNs,"tooltip","mean"));this.plot_last_mean[S]=new point(T,-ta*G)}this.plot_last_last_position[S]=b.match(/STACKED/)?this.plot_last_position[S]||new point(0,0):new point(0,0);this.plot_last_position[S]=0<=oa?new point(T,-oa*G):new point(T,
0);this.plot_last_shape[S]=v;this.plot_last_areaValue[S]=g;this.plot_area_points.push(new point(T,-oa*G))}else if(b.match(/LOLLIPOP/)&&g){if(I=map.Dom.newShape("line",ba,T,0,T,-oa*G,"stroke:"+y+";stroke-width:"+map.Scale.normalX(3)+";stroke-linecap:round;"))I.setAttributeNS(szMapNs,"value",String(g)),I.setAttributeNS(szMapNs,"class",String(K%(this.nGridX||1E6))),I.setAttributeNS(szMapNs,"time",String(aa))}else 1<e.length/this.nGridX?b.match(/PLOTVAR/)?(v.style.setProperty("fill-opacity",Sa==e.length/
this.nGridX?"1":"0.2",""),v.style.setProperty("stroke-width",Sa==e.length/this.nGridX?"0":"3",""),I=null,this.plot_last_position[S]&&(b.match(/PLOTVAR/)?(I=map.Dom.newShape("line",t,this.plot_last_position[S].x,this.plot_last_position[S].y,T,-oa*G,"stroke:"+y+";stroke-width:"+map.Scale.normalX(2)+";"),I.setAttributeNS(szMapNs,"value",String(g)),I.setAttributeNS(szMapNs,"class",String(K%(this.nGridX||1E6))),I.setAttributeNS(szMapNs,"time",String(aa)),I.parentNode.insertBefore(I,I.parentNode.firstChild),
I=map.Dom.newShape("line",t,this.plot_last_position[S].x-40,this.plot_last_position[S].y,this.plot_last_position[S].x+40,this.plot_last_position[S].y,"stroke:"+y+";stroke-width:"+map.Scale.normalX(this.nLineWidth||3)+";"),I.setAttributeNS(szMapNs,"value",String(g)),I.setAttributeNS(szMapNs,"class",String(K%(this.nGridX||1E6))),I.setAttributeNS(szMapNs,"time",String(aa)),I.parentNode.insertBefore(I,I.parentNode.firstChild),I=map.Dom.newShape("line",t,T,0,T,-this.nPlotHeight,"stroke:#dddddd;stroke-width:"+
map.Scale.normalX(.25)+";"),I.setAttributeNS(szMapNs,"value",String(g)),I.setAttributeNS(szMapNs,"class",String(K%(this.nGridX||1E6))),I.setAttributeNS(szMapNs,"time",String(aa)),I.parentNode.insertBefore(I,I.parentNode.firstChild)):(I=map.Dom.newShape("line",t,this.plot_last_position[S].x,this.plot_last_position[S].y,T,-oa*G,"stroke:"+y+";stroke-width:"+map.Scale.normalX(this.nLineWidth||3)+";"),I.setAttributeNS(szMapNs,"value",String(g)),I.setAttributeNS(szMapNs,"class",String(K%(this.nGridX||1E6))),
I.setAttributeNS(szMapNs,"time",String(aa)),t.insertBefore(I,this.plot_last_shape[S]))),this.plot_last_last_position[S]=this.plot_last_position[S]||new point(0,0),this.plot_last_position[S]=new point(T,-oa*G),this.plot_last_shape[S]=v):b.match(/BOX/)&&map.Dom.newShape("line",ba,T,0,T,-this.nPlotHeight,"stroke:#dddddd;stroke-width:"+map.Scale.normalX(.25)+";"):b.match(/PLOTVAR/)?(I=null,ta=b.match(/MEDIAN/)?this.nMedianA[H]:this.nMeanA[H],ta-=na,I=map.Dom.newShape("line",ba,T,-(ta-this.nDeviationA[H])*
G,T,-(ta+this.nDeviationA[H])*G,"stroke:#aaaaaa;stroke-width:"+map.Scale.normalX(1)+";"),I.setAttributeNS(szMapNs,"value",String(g)),I.setAttributeNS(szMapNs,"class",String(K%(this.nGridX||1E6))),I.setAttributeNS(szMapNs,"time",String(aa)),I=map.Dom.newShape("line",ba,T-40,-ta*G,T+40,-ta*G,"stroke:#aaaaaa;stroke-width:"+map.Scale.normalX(2)+";"),I.setAttributeNS(szMapNs,"value",String(g)),I.setAttributeNS(szMapNs,"class",String(K%(this.nGridX||1E6))),I.setAttributeNS(szMapNs,"time",String(aa)),I=
map.Dom.newShape("line",ba,T-80,-(ta-this.nDeviationA[H])*G,T+80,-(ta-this.nDeviationA[H])*G,"stroke:#aaaaaa;stroke-width:"+map.Scale.normalX(1)+";"),I.setAttributeNS(szMapNs,"value",String(g)),I.setAttributeNS(szMapNs,"class",String(K%(this.nGridX||1E6))),I.setAttributeNS(szMapNs,"time",String(aa)),I=map.Dom.newShape("line",ba,T-80,-(ta+this.nDeviationA[H])*G,T+80,-(ta+this.nDeviationA[H])*G,"stroke:#aaaaaa;stroke-width:"+map.Scale.normalX(1)+";"),I.setAttributeNS(szMapNs,"value",String(g)),I.setAttributeNS(szMapNs,
"class",String(K%(this.nGridX||1E6))),I.setAttributeNS(szMapNs,"time",String(aa)),map.Dom.newShape("line",ba,T,0,T,-this.nPlotHeight,"stroke:#dddddd;stroke-width:"+map.Scale.normalX(.25)+";"),this.plot_last_position[S]&&(I=map.Dom.newShape("line",ba,this.plot_last_position[S].x,this.plot_last_position[S].y,T,-ta*G,"stroke:#888888;stroke-width:"+map.Scale.normalX(1)+";")),this.plot_last_last_position[S]=this.plot_last_position[S]||new point(0,0),this.plot_last_position[S]=new point(T,-ta*G)):b.match(/BOX/)&&
map.Dom.newShape("line",ba,T,0,T,-this.nPlotHeight,"stroke:#dddddd;stroke-width:"+map.Scale.normalX(.25)+";");this.plot_last_value[Sa]=g;this.plot_last_stacked_value[Sa]=oa}ua=0}else"label"==U&&(ua-=yc/1.95),v.fu.setPosition(map.Scale.normalX(0)+Ga,map.Scale.normalY(0)+ua),ia&&ia.fu.setPosition(map.Scale.normalX(0)+Ga,map.Scale.normalY(0)+ua),D&&D.fu.setPosition(Ga,map.Scale.normalY(0)+ua),ua="label"==U?ua-yc/1.95:ua-m}}}}Xa&&Xa.parentNode.appendChild(Xa);Wb&&Wb.parentNode.appendChild(Wb);Xb&&Xb.parentNode.appendChild(Xb);
Yb&&Yb.parentNode.appendChild(Yb);if(0&b.match(/AREA/)&&!this.nGridX&&this.plot_area_points&&this.plot_area_points.length){for(var cd=!0,Dc=this.plot_area_points.length,Y=0;Y<Dc;Y++)0===this.plot_area_points[Y].y&&(cd=!1);if(cd||b.match(/ZEROISVALUE/)){for(var Za="M"+this.plot_area_points[0].x+","+this.plot_area_points[0].y+" L ",Y=1;Y<Dc;Y++)Za+=this.plot_area_points[Y].x+","+this.plot_area_points[Y].y+" ";Za+=this.plot_area_points[Dc-1].x+",0 ";Za+="0,0 ";Za+="z ";this.plot_area_shapes[0].setAttributeNS(null,
"d",Za)}}if("undefined"!=typeof this.szSymbolBoxStyle){var dd=map.Dom.getBox(t);rb.setAttributeNS(null,"x",-map.Scale.normalX(15));rb.setAttributeNS(null,"y",-map.Scale.normalY(15));rb.setAttributeNS(null,"width",map.Scale.normalX(30*Rc));rb.setAttributeNS(null,"height",map.Scale.normalY(30));rb.setAttributeNS(null,"fill-opacity",1)}q.x=map.Scale.normalY(0);q.y=map.Scale.normalY(b.match(/ZOOM/)||b.match(/MENUSIZE/)?20:m/map.Scale.normalY(1)+5)}else if(b.match(/BUFFER/)){F=this.nMaxA[0];g=e[0];m=this.nBufferSize?
this.nBufferSize:1E3;this.szShapeType.match(/line/)&&(m*=this.nScale);m=map.Scale.getDeltaXofDistanceInMeter(m);y=this.colorScheme[0];if(this.szFields&&this.szFields.length&&this.nRangesA&&this.nRangesA.length&&(y=null,this.nRangesA.length==this.colorScheme.length))for(h=0;h<this.nRangesA.length;h++)if(g==this.nRangesA[h]||Number(g)==Number(this.nRangesA[h])){y=this.colorScheme[h];r=__maptheme_getChartColors(y);A="undefined"!=typeof this.szBorderColor?this.szBorderColor:.8>this.fillOpacity?"#888888":
r.textColor;break}if(this.szShapeType.match(/point/))if(y){d=2*m/map.Scale.normalX(1);q.x=0;q.y=m+map.Scale.normalY(5);this.szFlag.match(/OVERLAY/);v=map.Dom.newShape("circle",t,0,0,m,"");if(this.szFlag.match(/VALUE/))var jb="font-family:arial;font-size:"+map.Scale.normalX(5)+"px;fill:#222222;stroke-dasharray:none;pointer-events:none;",D=map.Dom.newText(t,m-map.Scale.normalX(5),0,jb,Map.Scale.prototype.formatDistanceString(this.nBufferSize));this.nRealizedCount++}else return new point(0,0);if(this.szShapeType.match(/line/)){var ec=
SVGDocument.getElementById(a),Ec=ec.getAttributeNS(null,"id");if(!Ec.match(":paint")){var Pb=SVGDocument.getElementById(Ec+":paint");Pb||(Pb=ec.cloneNode(1E3),t.appendChild(Pb),Pb.setAttributeNS(null,"id",Ec+":paint"));ec=Pb;this.nRealizedCount++}var wd=2*m/map.Scale.normalX(1);ec.setAttributeNS(null,"style","fill:none;stroke:"+y+";stroke-linejoin:round;stroke-linecap:round;stroke-width:"+map.Scale.normalX(wd)*map.Scale.nZoomScale+";stroke-opacity:"+String(this.fillOpacity?this.fillOpacity:this.nOpacity?
this.nOpacity:0)+"");return null}}else if(b.match(/BAR/)||b.match(/BARS/)){var L=0,fa=0,xd=d,Ba=1,ra=0,u=1,ya=this.nMax-this.nMin,Tb=this.nMax100-this.nMin100;this.nNormalSizeValue&&(ya=Tb=this.nMaxSize=this.nNormalSizeValue);if(b.match(/SIZE/)&&!b.match(/NORMSIZE/)&&this.szSizeField&&a&&this.itemA[a])Ba=b.match(/SIZELOG/)?1/Math.max(1,Math.log(this.nMaxSize)*Math.log(this.itemA[a].nSize)):b.match(/SIZEP4/)?1/Math.pow(this.nMaxSize,.25)*Math.pow(this.itemA[a].nSize,.25):b.match(/3D/)||b.match(/SIZEP3/)||
b.match(/SIZEVOLUME/)?1/Math.pow(this.nMaxSize,1/3)*Math.pow(this.itemA[a].nSize,1/3):1/Math.sqrt(this.nMaxSize)*Math.sqrt(this.itemA[a].nSize);else if(b.match(/SIZE/)&&!b.match(/NORMSIZE/)){var sb=n;b.match(/POINTER/)&&(sb/=e.length);Ba=b.match(/SIZELOG/)?1/Math.max(1,Math.log(ya)*Math.log(Math.abs(sb))):b.match(/SIZEP4/)?1/Math.pow(ya,.25)*Math.pow(Math.abs(sb),.25):b.match(/3D/)||b.match(/SIZEP3/)||b.match(/SIZEVOLUME/)?1/Math.pow(ya,1/3)*Math.pow(Math.abs(sb),1/3):1/Math.pow(ya,.5)*Math.pow(Math.abs(sb),
.5)}0===Ba&&0!==n&&(Ba=30/d);d*=Ba;var w=map.Scale.normalX(d/e.length*.66);b.match(/STACKED/)&&(w=map.Scale.normalX(d/3),this.nGridX&&!b.match(/MULTI/)&&(w/=2));b.match(/MENUSIZE/)&&1==e.length&&(w=map.Scale.normalX(d/2));J=w<map.Scale.normalX(5)?4*w/5:5*w/5;Wa=1;b.match(/COLUMN/)&&(w*=b.match(/THICK/)?2:b.match(/THIN/)?1:1.5);b.match(/THIN/)&&(w*=.6,J*=.75);b.match(/THICK/)&&(w*=1.5,J*=1.5);b.match(/STACKED/)?J=map.Scale.normalX(5):(b.match(/ZOOM/)||b.match(/NORMSIZE/))&&1==e.length&&(J*=2.5);b.match(/STACKED/)&&
!b.match(/ZOOM/)&&(J*=Ba);jb="font-family:arial;font-size:"+.95*J+"px;fill:#606060;pointer-events:none;";jb=map.Scale.tStyle.Values.szStyle+"font-size:"+.95*J+"px";b.match(/NORMSIZE/)||b.match(/MENUSIZE/)||this.szFlag.match(/NORMSIZE/)||this.szFlag.match(/MENUSIZE/)||!this.nNormalSizeValue||this.szField100&&!b.match(/POINTER/)||(k=this.nNormalSizeValue);this.nOverrideMax&&(k=this.nOverrideMax);C=map.Scale.normalX(xd)/k;if(b.match(/OFFSETMEAN/)||b.match(/OFFSETMEDIAN/)||b.match(/DEVIATION/))C=map.Scale.normalX(d)/
300;b.match(/SIZE/)&&b.match(/SEQUENCE/)&&a&&1<e.length&&!this.szSizeField&&!this.szField100?C=C*e.length/Ba:b.match(/SIZE/)&&a&&1<e.length&&!b.match(/EXPAND/)&&(C=this.szField100||b.match(/POINTER/)?C*Ba:C/(b.match(/SIZEP4/)?Ba*Ba:Ba));!this.nRangeScale||b.match(/ZOOM/)&&b.match(/HORZ/)||(C*=this.nRangeScale);b.match(/COMPRESSMAX/)?C/=4:b.match(/COMPRESSMORE/)?C/=3:b.match(/COMPRESS/)?C/=2:b.match(/EXPANDMAX/)?C*=4:b.match(/EXPANDMORE/)?C*=3:b.match(/EXPAND/)&&(C*=2);b.match(/POINTER/)&&!b.match(/NORMSIZE/)&&
(C*=1.2);var Fc=map.Dom.newGroup(t,"");if(b.match(/\bSORT\b/)){this.sortedIndex=[];for(h=0;h<e.length;h++)this.sortedIndex[h]={index:h,value:e[h]};this.sortedIndex.sort(b.match(/STACKED/)?this.sortIndexUp:this.sortIndexDown)}else this.sortedIndex=null;Ra=0;b.match(/\bUP\b/)&&(Ra=e.length-1);var ca=1;b.match(/CENTER/)&&(ca=2);for(var tb=new point(0,0),fc=null,Ta=null,$a=null,ab=null,Da=null,Gc=null,gc=sb=0,K=null,yd=C,h=this.nClipParts&&this.nClipParts<e.length?e.length-this.nClipParts:0;h<e.length;h++){if(this.szShowParts){Lb=
!0;for(Y in this.szShowPartsA)this.szShowPartsA[Y]==h&&(Lb=!1);if(Lb)continue}C=yd;H=Math.abs(Ra-h);this.sortedIndex&&(H=this.sortedIndex[H].index);g=e[H];this.szFlag.match(/\bCLIP\b/)&&!this.szFlag.match(/MORPH/)&&this.nClipFrames&&(g=this.nClipFrames==e.length?Number(e[this.nActualFrame]):e[0]*(this.nClipFrames-1-this.nActualFrame)/(this.nClipFrames-1)+e[e.length-1]*this.nActualFrame/(this.nClipFrames-1),H=this.nActualFrame,h=e.length);var Ea=g;b.match(/INVERT/)&&(0!==g||b.match(/ZEROISVALUE/))&&
(g=this.nMax-g);va=this.formatValue(g,this.nValueDecimals||2);b.match(/OFFSETMEAN/)||b.match(/OFFSETMEDIAN/)?(b.match(/OFFSETMEAN/)&&(g*=100/this.nMeanA[H]),b.match(/OFFSETMEDIAN/)&&(g*=100/this.nMedianA[H]),g-=100,Ea=g=isFinite(g)&&!isNaN(g)?g:0,k=100,va=this.formatValue(g,this.nValueDecimals||2),0<g&&(va="+"+va)):b.match(/DEVIATION/)&&(g=(g-this.nMeanA[H])/this.nDeviationA[H],Ea=g=isFinite(g)&&!isNaN(g)?g:0,g*=100,va=this.formatValue(g,this.nValueDecimals||2),0<g&&(va="+"+va));var ga=this.colorScheme[H%
(this.nGridX||1E6)],K=H%(this.nGridX||1E6);if((b.match(/SEQUENCE/)||1==e.length)&&2<=this.colorScheme.length)for(ga=this.colorScheme[this.partsA.length-1],ea=0;ea<this.partsA.length;ea++)if(g<this.partsA[ea].max){ga=this.colorScheme[ea];K=ea;break}b.match(/LEFT/)&&b.match(/HORZ/)&&(g=-g);0>g&&!b.match(/STACKED/)&&(fa=-g*C,g=-g);b.match(/VOLUME/)&&b.match(/3D/)?(C=1,g=this.szSizeField&&a?w=map.Scale.normalX(d/3*2)*Math.pow(1/this.nMaxSize*this.itemA[a].nSize,1/3):w=map.Scale.normalX(d/3*2)*Math.pow(1/
k*g,1/3)):(b.match(/POINTER/)&&b.match(/SIZE/)&&a&&(w=b.match(/WIDTH/)&&l&&(!(b.match(/DIFFERENCE/)||b.match(/RELATIVE/)||b.match(/FRACTION/))||b.match(/OFFSETMEAN/)||b.match(/OFFSETMEDIAN/)||b.match(/DEVIATION/))?map.Scale.normalX(d)*Math.pow(Math.abs(1/this.nMax100*l),.5):map.Scale.normalX(d)*Math.pow(Math.abs(1/k*g),1/3),J=.6*w,this.nValueSizeMin&&!b.match(/ZOOM/)&&(J=J*map.Layer.nDynamicObjectScale>map.Scale.normalX(this.nValueSizeMin)?J:0),b.match(/ZOOM|XAXIS/)||(Wa=Math.pow(Math.abs(g),.5)/
Math.pow(this.nMax,.5),this.szFadeValuePow&&Number(this.szFadeValuePow)&&(Wa=Math.pow(Math.abs(g),Number(this.szFadeValuePow))/Math.pow(k,Number(this.szFadeValuePow))))),b.match(/DTEXT/)&&a&&!b.match(/ZOOM/)?(J=map.Scale.normalX(d/3*2)*Math.pow(Math.abs(1/k*g),.5)*.75,this.nValueSizeMin&&!b.match(/ZOOM/)&&(J=J*map.Layer.nDynamicObjectScale>map.Scale.normalX(this.nValueSizeMin)?J:0),Wa=Math.pow(Math.abs(g),1/3)/Math.pow(k,1/3)):this.nValueSizeMin&&!b.match(/ZOOM/)&&(J=J*map.Layer.nDynamicObjectScale>
map.Scale.normalX(this.nValueSizeMin)?J:0));J*=this.nValueScale||1;g=isFinite(g)&&!isNaN(g)?g:0;if(0===g&&b.match(/NOZERO/))fa=0;else if(0>Ea&&b.match(/NONEGATIVE/))fa=0;else if(0<Ea&&b.match(/ONLYNEGATIVE/))fa=0;else{var Q=map.Dom.newGroup(Fc,"");this.szFlag.match(/MENUSIZE/)&&1==e.length&&!b.match(/VOLUME/)&&(w*=.8,g=w/C*1.7,map.Dom.newShape("rect",Q,0,-map.Scale.normalY(.75*d),map.Scale.normalX(.5*d),map.Scale.normalY(.75*d),"fill:red;stroke:none;fill-opacity:0"));var ja=g;if(b.match(/COLUMN/))0<
g*C&&(M=DonutCharts.newChart(SVGDocument,Q,L+w/2,0,w/2,0),M.setStyle("3D"),M.addStyle("SILENT"),M.addPart(100,g*C*2-(b.match(/SPACED/)?w/2:w/5),ga,0,(this.szAggregation&&this.szAggregation.match(/sum/),this.formatValue(e[da],this.nValueDecimals||(5>e[da]?1:0),"ROUND")+this.szUnit),this.formatValue(e[da],2)+this.szUnit+la),M.realize());else if(b.match(/3D/)){r=__maptheme_getChartColors(ga);if(b.match(/VOLUME/)&&Ta){var xa=(g*C-Ta)/15,fa=fa+xa,y="white",y="#444444",y=Gc.borderColor,ed=Gc.mainColor,
Hc=.3;Ta<g*C&&(Hc=.2);map.Dom.newShape("line",Q,$a+Da,ab-xa,L,fa-xa,"stroke:"+y+";stroke-width:"+map.Scale.normalX(.25)+";");map.Dom.newShape("line",Q,$a+Da,ab-Ta-xa,L,fa-g*C-xa,"stroke:"+y+";stroke-width:"+map.Scale.normalX(.25)+";");map.Dom.newShape("line",Q,$a+Da+Da/3,ab-Da/4-xa,L+w/3,fa-w/4-xa,"stroke:"+y+";stroke-width:"+map.Scale.normalX(.25)+";");map.Dom.newShape("line",Q,$a+Da+Da/3,ab-Ta-Da/4-xa,L+w/3,fa-g*C-w/4-xa,"stroke:"+y+";stroke-width:"+map.Scale.normalX(.25)+"");map.Dom.newShape("path",
Q,"M"+($a+Da)+","+(ab-xa)+" L "+L+","+(fa-xa)+" "+L+","+(fa-g*C-xa)+" "+($a+Da)+","+(ab-Ta-xa)+" z","fill:"+ed+";stroke:"+y+";stroke-width:"+map.Scale.normalX(.05)+";fill-opacity:"+Hc);Ta-g*C>-w/4&&map.Dom.newShape("path",Q,"M"+($a+Da)+","+(ab-Ta-xa)+" L "+L+","+(fa-g*C-xa)+" "+(L+w/3)+","+(fa-g*C-w/4-xa)+" "+($a+Da+Da/3)+","+(ab-Ta-Da/4-xa)+" z","fill:"+ed+";stroke:"+y+";stroke-width:"+map.Scale.normalX(.05)+";fill-opacity:"+Hc)}Ta=g*C;$a=L;ab=fa;Da=w;Gc=r;if(ja=this.nFilterA[H]){var Qb="fill:#FFFFFF;stroke:gray;stroke-width:"+
map.Scale.normalX(.5)+";fill-opacity:0.1;stroke-opacity:0.1";map.Dom.newShape("path",Q,"M"+L+",0 l "+w+",0 "+w/3+","+-w/4+" "+-w+" 0 z",Qb);map.Dom.newShape("rect",Q,L+w/3,-ja*C/ca-w/4,w,ja*C,Qb);map.Dom.newShape("path",Q,"M"+L+",0 l 0,"+-ja*C/ca+" "+w/3+","+-w/4+" 0,"+ja*C+" z",Qb);map.Dom.newShape("rect",Q,L,-ja*C/ca,w,ja*C,Qb);map.Dom.newShape("path",Q,"M"+(L+w)+",0 l 0,"+-ja*C/ca+" "+w/3+","+-w/4+" 0,"+ja*C+" z",Qb);r.highColor=ColorScheme.getDerivateColor(ga,.9)}0>=fa||b.match(/LEFT/)||b.match(/VOLUME/)?
(g&&(0===g&&(r=__maptheme_getChartColors("none")),map.Dom.newShape("rect",Q,L,-g*C/ca,w,g*C,"fill:"+r.mainColor+";stroke:"+r.borderColor+";stroke-width:"+map.Scale.normalX(.05)+";stroke-opacity:0.3"),map.Dom.newShape("path",Q,"M"+(L+w)+",0 l 0,"+-g*C/ca+" "+w/3+","+-w/4+" 0,"+g*C+" z","fill:"+r.lowColor+";stroke:"+r.borderColor+";stroke-width:"+map.Scale.normalX(.05)+""),r.highColor=ColorScheme.getDerivateColor(ga,.9)),map.Dom.newShape("path",Q,"M"+L+","+-g*C/ca+" l "+w+",0 "+w/3+","+-w/4+" "+-w+
" 0 z","fill:"+r.highColor+";stroke:"+r.borderColor+";stroke-width:"+map.Scale.normalX(.05)+";stroke-opacity:1")):(map.Dom.newShape("path",Q,"M"+L+",0 l "+w+",0 "+w/3+","+-w/4+" "+-w+" 0 z","fill:"+r.highColor+";stroke:"+r.borderColor+";stroke-width:"+map.Scale.normalX(.05)+";fill-opacity:0.2"),map.Dom.newShape("rect",Q,L+w/3,-g*C/ca-w/4,w,g*C,"fill:"+r.mainColor+";stroke:"+r.borderColor+";stroke-width:"+map.Scale.normalX(.05)+";fill-opacity:0.4"),map.Dom.newShape("path",Q,"M"+L+",0 l 0,"+-g*C/ca+
" "+w/3+","+-w/4+" 0,"+g*C+" z","fill:"+r.lowColor+";stroke:"+r.borderColor+";stroke-width:"+map.Scale.normalX(.05)+";fill-opacity:0.4"),r.highColor=ColorScheme.getDerivateColor(ga,.9),map.Dom.newShape("rect",Q,L,-g*C/ca,w,g*C,"fill:"+r.mainColor+";stroke:"+r.borderColor+";stroke-width:"+map.Scale.normalX(.05)+";fill-opacity:0.4"),map.Dom.newShape("path",Q,"M"+(L+w)+",0 l 0,"+-g*C/ca+" "+w/3+","+-w/4+" 0,"+g*C+" z","fill:"+r.lowColor+";stroke:"+r.borderColor+";stroke-width:"+map.Scale.normalX(.05)+
";fill-opacity:0.4"),r.highColor=ColorScheme.getDerivateColor(ga,.9));ja&&(map.Dom.newShape("rect",Q,L,-ja*C/ca,w,ja*C,"fill:#FFFFFF;stroke:none;stroke-width:"+map.Scale.normalX(.05)+";fill-opacity:0.25"),ja>g?map.Dom.newShape("path",Q,"M"+L+","+-ja*C/ca+" l "+w+",0 "+w/3+","+-w/4+" "+-w+" 0 z","fill:#8888FF;stroke:#444488;stroke-width:"+map.Scale.normalX(.1)+";fill-opacity:0.2"):map.Dom.newShape("path",Q,"M"+L+","+-ja*C/ca+" l "+w+",0 "+w/3+","+-w/4+" "+-w+" 0 z","fill:#8888FF;stroke:"+r.borderColor+
";stroke-width:"+map.Scale.normalX(.1)+";fill-opacity:0.1;stroke-opacity:0.4"))}else if(b.match(/Border/)){map.Dom.newShape("rect",Q,L,-g*C/ca,w,g*C,"fill:"+ga+";stroke:none;");var Cb=L+2,Db=L+w-2,Rb=2-g*C/ca,hc=Rb+g*C-2,r=__maptheme_getChartColors(ga);map.Dom.newShape("line",Q,Cb,Rb,Cb,hc,"stroke:white;stroke-width:"+map.Scale.normalX(.001)+";stroke-opacity:1.0");map.Dom.newShape("line",Q,Cb,Rb,Db,Rb,"stroke:white;stroke-width:"+map.Scale.normalX(.001)+";stroke-opacity:1.0");map.Dom.newShape("line",
Q,Cb,hc,Db,hc,"stroke:black;stroke-width:"+map.Scale.normalX(.001)+";stroke-opacity:0.9");map.Dom.newShape("line",Q,Db,Rb,Db,hc,"stroke:black;stroke-width:"+map.Scale.normalX(.001)+";stroke-opacity:0.9")}else if(b.match(/POINTER/)&&g){(b.match(/OFFSETMEAN/)||b.match(/OFFSETMEDIAN/)||b.match(/DEVIATION/))&&1E3<Math.abs(g*C)&&(C=(1E3+(Math.abs(g*C)-1E3)/10+Math.abs(g*C)%1E3)/Math.abs(g));var Sb="fill:"+ga+";fill-opacity:"+(this.fillOpacity||1)+";stroke:"+(this.szLineColor||"black")+";stroke-opacity:0.5;stroke-width:"+
map.Scale.normalX(this.nLineWidth)*Math.sqrt(Ba||1)+"";0>=fa?(!this.fShadow&&this.fOrigShadow&&map.Dom.newShape("path",Q,"M"+(L+w/7+10)+","+(-g*C/ca+10)+" l "+-w/7+",0 0,"+-w/15+" "+w/2+","+-w/3+" "+w/2+","+w/3+" 0,"+w/15+" "+-w/7+",0 0,"+g*C+" "+5*-w/7+",0 z","fill:000000;fill-opacity:0.5;stroke:none;"),map.Dom.newShape("path",Q,"M"+(L+w/7)+","+-g*C/ca+" l "+-w/7+",0 0,"+-w/15+" "+w/2+","+-w/3+" "+w/2+","+w/3+" 0,"+w/15+" "+-w/7+",0 0,"+g*C+" "+5*-w/7+",0 z",Sb)):b.match(/NONEGATIVE/)||(b.match(/LEFT/)||
(b.match(/ZOOM/)||b.match(/NORMSIZE/)?Sb="fill:"+ga+";stroke:"+ga+";stroke-width:"+map.Scale.normalX(.25)+";fill-opacity:0.5":2<this.partsA.length?(r=__maptheme_getChartColors(ga),Sb="fill:"+ga+";stroke:"+r.lowColor+";stroke-width:"+map.Scale.normalX(.25*this.nLineWidth*Ba||.25)+";fill-opacity:"+(this.nFadeNegative||.1)+";stroke-opacity:0.8"):(r=__maptheme_getChartColors(ga),Sb="fill:"+ga+";stroke:"+r.highColor+";stroke-width:"+map.Scale.normalX(.5*this.nLineWidth*Ba||.5)+";fill-opacity:"+(this.nFadeNegative||
.1)+";stroke-opacity:1")),map.Dom.newShape("path",Q,"M"+(L+w/7)+","+-g*C/ca+" l "+5*w/7+",0 0,"+g*C+" "+w/7+",0 "+-w/2+","+w/4+" "+-w/2+","+-w/4+" "+w/7+",0 z",Sb))}else 0>=fa||b.match(/LEFT/)?map.Dom.newShape("rect",Q,L,-g*C/ca,w,g*C,"fill:"+ga+";fill-opacity:"+(this.fillOpacity||1)+";stroke:"+(this.szLineColor||"black")+";stroke-width:"+map.Scale.normalX(.25*this.nLineWidth*Ba||.2)+";stroke-opacity:"+(this.nLineWidth?1:.1)+""):map.Dom.newShape("rect",Q,L,-g*C/ca,w,g*C,"fill:"+ga+";fill-opacity:"+
(this.fillOpacity||1)+";stroke:"+ga+";stroke-width:"+map.Scale.normalX(.25)+";fill-opacity:0.3"),(ja=this.nFilterA[H])&&(0>=fa||b.match(/LEFT/)?map.Dom.newShape("rect",Q,L,-ja*C/ca,w,ja*C,"fill:none;stroke:black;stroke-width:"+map.Scale.normalX(.5)+";stroke-opacity:0.1"):map.Dom.newShape("rect",Q,L,-ja*C/ca,w,ja*C,"fill:none;stroke:"+ga+";stroke-width:"+map.Scale.normalX(.5)+";fill-opacity:0.3"));if((b.match(/VALUES/)||this.szXaxisA)&&!(0<fa&&b.match(/NONEGATIVE/))&&(b.match(/ZOOM/)||!this.szValueUpper||
map.Scale.nTrueMapScale*map.Scale.nZoomScale<=this.nValueUpper)){g||(g=0);if(b.match(/AXIS/)&&!b.match(/STACKED/)&&(this.szLabelA||this.szXaxisA)){var Sa=H,$b=(this.szXaxisA?this.szXaxisA[Sa]:this.szLabelA?this.szLabelA[Sa]:" ")||" ",fd=.8*J;b.match(/\bUP\b/)&&(fd=.9*J);var D=map.Dom.newText(Q,0,0,jb+";fill:#666666;text-anchor:end;font-size:"+fd+"px"," "+$b+" "),V=new point(map.Scale.normalX(.8),w/2+J/5*2);this.fNegativeValues?D.setAttributeNS(null,"transform","translate("+(L+V.y)+","+(-V.x+.9*J+
10)+") rotate(270)"):b.match(/CENTER/)?D.setAttributeNS(null,"transform","translate("+(L+V.y)+","+(map.Scale.normalX(d/2)+.9*J)+") rotate(270)"):b.match(/HORZ/)?D.setAttributeNS(null,"transform","translate("+(L+V.y)+","+(-V.x+.9*J+10)+") rotate(270)"):(D.style.setProperty("text-anchor","end",""),1==e.length?D.setAttributeNS(null,"transform","translate("+(L+(b.match(/VOLUME/)?1.3*w:1.5*V.y))+","+-V.x+") "):1<$b.length?D.setAttributeNS(null,"transform","translate("+(L+V.y)+","+.8*J+") rotate(315)"):
D.setAttributeNS(null,"transform","translate("+(L+.1*V.y)+","+(-V.x+J)+")"))}if(b.match(/VALUES/)&&0<J&&!(this.nGridX&&2<this.partsA.length/this.nGridX)){O=this.formatValue(Ea,this.nValueDecimals||(1>=this.nMax?1:0));b.match(/POINTER/)&&0<Ea&&(0>this.nMin||b.match(/OFFSETMEAN/)||b.match(/OFFSETMEDIAN/)||this.szFlag.match(/\bSIGN\b/))&&(O="+"+O);b.match(/VOLUME/)||(O+=this.szUnit?" "+this.szUnit+" ":"");!b.match(/STACKED/)||0===Ea||l||this.nGridX||(O=O+" ("+Math.round(Ea/n*100)+"%)");b.match(/STACKED/)&&
(J=b.match(/ZOOM/)?map.Scale.normalX(18):map.Scale.normalX(5));var ic=O.length*J*4/8,D=this.createTextLabel(SVGDocument,Q,"",O,J/map.Scale.normalX(1),null,0<Ea&&(b.match(/CTEXT/)||b.match(/VALUEBACKGROUND/))?ga:null,this.szTextColor);D.style.setProperty("opacity",String(Wa),"");var Ic=La=null;this.szXaxisA&&b.match(/CATEGORICAL/)&&!b.match(/AXIS/)&&(Ic=map.Dom.newTSpan(D,"fill:fill:#444444;font-size:"+J+"px"," "+this.szXaxisA[h]));var Eb=D.fu.getBox().width,V=new point(map.Scale.normalX(-4),w/2+.15*
J),gd=!0;if(b.match(/DOINLINETEXT/)&&!b.match(/ZOOM/)&&!b.match(/NORMSIZE/)||!b.match(/VALUE/)||b.match(/VOLUME/)&&!b.match(/ZOOM/)||!(b.match(/THIN/)||b.match(/NOINLINETEXT/)||b.match(/DTEXT/)||b.match(/SIZE/)||Eb+map.Scale.normalX(1)>g*C/ca||b.match(/STACKED/)||b.match(/NORMSIZE/)||b.match(/ZOOM/))){r=__maptheme_getChartColors(ga);D.removeChild(D.firstChild);D.firstChild.style.setProperty("fill",r.textColor,"");Ic&&Ic.style.setProperty("fill",r.textColor,"");La&&La.parentNode.removeChild(La);var zd=
map.Scale.normalX(0),ub=map.Scale.normalY(.5);b.match(/VOLUME/)?(G=g*C/(Eb+map.Scale.normalX(2)),D.parentNode.removeChild(D),D=map.Dom.newText(Q,L+g*C/2,J*G/4-g*C/2,"font-family:arial;font-size:"+J*G+"px;text-anchor:middle;fill:"+r.textColor+";opacity:"+qa+";stroke:none;pointer-events:none",O)):(G=Math.min(1,g*C/Eb),.33>G?D.parentNode.removeChild(D):(0<Ea&&(V.x+=Math.max(map.Scale.normalX(1),g*C-(Eb+map.Scale.normalX(3))*G)),ub/=G,D.firstChild.style.setProperty("font-size",String(J*G)),D.firstChild.setAttributeNS(null,
"transform","translate("+(L+V.y-ub)+","+(-V.x-zd)+") rotate(270)\t")));tb.x=Math.max(0,tb.x-g*C)}else if(gd=!1,b.match(/STACKED/))if(0!==g||b.match(/ZEROISVALUE/))if(this.nGridX&&2<e.length/this.nGridX)D.parentNode.removeChild(D);else{V.x=0;b.match(/3D/)&&(V.x+=w/4,V.y+=w/3);var jc=g*C/(b.match(/SUM/),2);tb.x=Math.max(0,tb.x+(.75*J-jc));var kc=new point(tb.x+V.x+jc-J/3,0),bb=map.Scale.normalX(.5)*Ba,kb=L+V.y+w/3,lb=L+V.y+7*w/8,mb=-V.x-jc,nb=-kc.x-J/3;if(this.nGridX&&gc<this.nGridX){V.y-=2*w+D.fu.getBox().width;
var Ad=lb,lb=kb-(b.match(/3D/)?1.5*w:1.4*w),kb=Ad-(b.match(/3D/)?7*w/4:1.4*w);b.match(/3D/)&&(mb+=w/5,nb+=w/5,kc.x-=w/7);bb=-bb}D.setAttributeNS(null,"transform","translate("+(L+V.y+w+bb-J)+","+(-kc.x-.25*J)+") ");var Jc=map.Dom.newGroup(Q,""),Kc=map.Dom.newGroup(Q,"");map.Dom.newShape("line",Jc,kb,mb,kb+bb,mb,"stroke-width:"+map.Scale.normalX(.15)+";stroke:white;opacity:0.2;");map.Dom.newShape("line",Kc,kb,mb,kb+bb,mb,"stroke-width:"+map.Scale.normalX(.05)+";stroke:#888888;");map.Dom.newShape("line",
Jc,kb+bb,mb,lb,nb,"stroke-width:"+map.Scale.normalX(.15)+";stroke:white;opacity:0.2;stroke-linecap:round;");map.Dom.newShape("line",Kc,kb+bb,mb,lb,nb,"stroke-width:"+map.Scale.normalX(.05)+";stroke:#888888;");map.Dom.newShape("line",Jc,lb,nb,lb+bb,nb,"stroke-width:"+map.Scale.normalX(.15)+";stroke:white;opacity:0.2;");map.Dom.newShape("line",Kc,lb,nb,lb+bb,nb,"stroke-width:"+map.Scale.normalX(.05)+";stroke:#888888;");tb.x=Math.max(0,tb.x+(2*J/3-(g*C-jc)))}else D.parentNode.removeChild(D);else{V.x+=
w/4;b.match(/3D/)&&(V.x+=w/4,V.y=.3*w+J/2);b.match(/POINTER/)&&0<Ea&&(V.x+=.25*w);var ob=g;Eb+map.Scale.normalX(1)>(ja-g)*C/ca&&(ob=Math.max(g,ja),ja>g&&(ob+=w/C*.2,map.Dom.newShape("line",Q,L+.6*w,-V.x-g*C/ca+w/3,L+.6*w,-V.x-ja*C/ca-.4*w,"stroke:white;")));b.match(/VOLUME/)&&(ob+=w/5);if(1!=e.length||b.match(/HORZ/)||b.match(/VOLUME/))b.match(/VOLUME/)?D.setAttributeNS(null,"transform","translate("+(L+V.y)+","+(-V.x-ob*C/ca)+")  scale(0.9,0.9)"):D.setAttributeNS(null,"transform","translate("+(L+
V.y)+","+(-10-.25*w-ob*C/ca)+") rotate(270) scale(0.9,0.9)");else{if(b.match(/ZOOM/)||b.match(/NORMSIZE/)){V.y+=b.match(/3D/)?.75*w:.5*w;var Bd=Math.min(0,.55*J-g*C),hd=J;!b.match(/3D/)&&!b.match(/ZOOM/)||b.match(/SIZE/)||(hd=0);D.setAttributeNS(null,"transform","translate("+(L+hd)+","+(Bd-.5*J)+")")}else V.y+=b.match(/3D/)?b.match(/VOLUME/)?.75*w:.6*w:.2*w,D.setAttributeNS(null,"transform","translate("+(L-.8*w)+","+(-ob*C/ca-.8*J-(b.match(/POINTER/)&&0<Ea?.3*w:0))+")");0>Ea&&D.style.setProperty("opacity",
String(.75*Wa),"")}D.style.setProperty("fill","#404040","")}}}null!=f&&h==f&&(u=2*J,r=__maptheme_getChartColors(ga),map.Dom.newShape("path",Q,"M5,0 l 35,-45 -25,0 0,-30 -20,0 0,30 -25,0 35,45","fill:#404040;stroke:white;stroke-width:"+map.Scale.normalX(.2)+"").fu.setPosition(h*(w+1.5)+.5*w,-g*C+(gd?-map.Scale.normalX(3):-Eb-map.Scale.normalX(12))));if(b.match(/TRENDLINE/)){ub=Math.min(g*C/2,map.Scale.normalY(1.5));r=__maptheme_getChartColors(ga);y=r.lowColor;u=J/5;0<h&&(Cb=(h-1)*(w+(b.match(/SPACED/)?
w/5:1))+w/2,Db=h*(w+(b.match(/SPACED/)?w/5:1))+w/2,y="white",y=fc>g?"#CC3333":fc<g?"#22BB22":r.lowColor,map.Dom.newShape("line",Q,Cb,-fc*C+ub,Db,-g*C+ub,"stroke:#666666;stroke-width:"+map.Scale.normalX(1/e.length*1.2)+";opacity:0.8"));var id=map.Dom.newShape("circle",Q,0,0,u,"fill:"+y+";stroke:none;opacity:0.8");id&&id.fu.setPosition(h*(w+(b.match(/SPACED/)?w/5:0))+w/2,-g*C+ub)}b.match(/SILENT/)||(this.szFlag.match(/SEQUENCE/)?Q.setAttributeNS(szMapNs,"tooltip",va+" ("+(this.szLabelA?this.szLabelA[K]:
"")+") ["+this.szFieldsA[H]+"]"):(la=this.szFieldsA[H],this.szLabelA&&this.szLabelA[H]&&(la=this.szLabelA[H]),va+=this.szUnit,!n||this.nGridX||this.szField100&&!this.szFlag.match(/FRACTION/)||(va+=" ("+this.formatValue(100/n*g,2)+"%)"),Q.setAttributeNS(szMapNs,"tooltip",va+" "+la+"")));b.match(/FADEIN/)&&(2==e.length&&0===h?Q.style.setProperty("opacity","0.6",""):b.match(/NORMSIZE/)||(ha=b.match(/FADEINP4/)?10:3,Q.style.setProperty("opacity",String(.1+.9*Math.pow(h+1,ha)/Math.pow(e.length,ha)),"")));
b.match(/FADENEGATIVE/)&&0>Ea&&Q.style.setProperty("opacity","0.5","");Q.setAttributeNS(szMapNs,"class",String(K));Q.fu.setPosition(0,fa);b.match(/STACKED/)?fa-=g*C:(fa=0,L+=w,b.match(/VOLUME/)&&b.match(/SPACED/)?L+=w/(2==e.length?2:4):b.match(/SPACED/)?L+=w/5:b.match(/\bUP\b/)||(L+=1));gc++;b.match(/STACKED/)&&!b.match(/MULTI/)&&this.nGridX&&0===gc%this.nGridX&&(fa=0,L+=w+w/20);fc=g}}b.match(/HOR/)&&Fc.setAttributeNS(null,"transform","rotate(90) translate("+-L+",0)");q.y=0;q.x=0;b.match(/HOR/)?(q.y-=
1*w/2,b.match(/3D/)&&(q.y-=1*w/3)):b.match(/STACKED/)?q.x=w/2:b.match(/Up/)||b.match(/HOR/)?q.x=0:q.x=w*gc/2;b.match(/MENUSIZE/)&&(q.x+=w*(b.match(/HORZ/)?1:0),q.y+=w*(b.match(/HORZ/)?.3:0),q.y+=w*(b.match(/HORZ/)&&b.match(/3D/)?1:b.match(/VOLUME/)?.3:.6));this.nRealizedCount++;var Lc=map.Dom.newGroup(t,"");Lc.appendChild(Fc);b.match(/ZOOM/)&&(G=240/J/(1<e.length?2:1),Lc.fu.scale(G,G));Lc.fu.setPosition(t.fu.getPosition().x-q.x,-q.y);q.x=0;q.y=0;b.match(/HOR/)&&(q.y=1*w/2)}if(b.match(/EXTEND/)&&HTMLWindow.ixmaps.htmlgui_drawChartAfter)try{N=
this.objThemesA[this.szThemesA[0]],HTMLWindow.ixmaps.htmlgui_drawChartAfter(SVGDocument,{target:t,theme:this,item:a,values:e,maxSize:d,flag:b,mark:f,dbRecord:N.dbRecords?N.dbRecords[this.itemA[a].dbIndex]:null})}catch(Ed){}if(!b.match(/NORMSIZE/)){var Ia=new point(q.x,q.y);q.y=0;q.x=0;this.szAlign&&(b.match(/PLOT/)&&!b.match(/ZOOM/)?(this.szAlign.match(/center/)&&(q.x=map.Scale.normalX(d/2*e.length/(this.nGridX||1)),this.szAlign.match(/top/)||(q.y=-map.Scale.normalX(d/2*e.length/(this.nGridX||1)))),
this.szAlign.match(/right/)&&(q.x=map.Scale.normalX(d*e.length/(this.nGridX||1))),this.szAlign.match(/23right/)&&(q.x=map.Scale.normalX(.66*d*e.length/(this.nGridX||1))),this.szAlign.match(/10\%right/)&&(q.x=map.Scale.normalX(.9*d*e.length/(this.nGridX||1)))):this.nGridX&&!b.match(/ZOOM/)?(this.szAlign.match(/center/)&&(q.x=map.Scale.normalX(d/2/this.partsA.length*e.length/(this.nGridX||1))),this.szAlign.match(/right/)&&(q.x=map.Scale.normalX(d/this.partsA.length*e.length/(this.nGridX||1))),this.szAlign.match(/23right/)&&
(q.x=map.Scale.normalX(d/this.partsA.length*.66*e.length/(this.nGridX||1)))):(this.szAlign.match(/center/)&&(q.y=0),this.szAlign.match(/top/)&&(q.y=Ia.y?Ia.y:map.Scale.normalX(d/5)),this.szAlign.match(/above/)&&(q.y=Ia.y?Ia.y:map.Scale.normalX(d/2)),this.szAlign.match(/2above/)&&(q.y+=map.Scale.normalX(d/2)),this.szAlign.match(/below/)&&(q.y=-(Ia.y?Ia.y:map.Scale.normalX(d/2))),this.szAlign.match(/2below/)&&(q.y-=map.Scale.normalX(d/2)),this.szAlign.match(/bottom/)&&(q.y=-(Ia.y?Ia.y:map.Scale.normalX(d/
2))),this.szAlign.match(/2bottom/)&&(q.y-=map.Scale.normalX(d/2)),this.szAlign.match(/right/)&&(q.x=-(Ia.y?Ia.y:map.Scale.normalX(d/2))),this.szAlign.match(/2right/)&&(q.x-=map.Scale.normalX(d/2)),this.szAlign.match(/left/)&&(q.x=Ia.y?Ia.y:map.Scale.normalX(d/2)),this.szAlign.match(/2left/)&&(q.x+=map.Scale.normalX(d/2)),this.szAlign.match(/23left/)&&(q.x=map.Scale.normalX(d/3)),this.szAlign.match(/baseline/)&&(q.y+=map.Scale.normalY(d/5))))}if(a&&this.szLabelField&&!b.match(/NORMSIZE/)&&!b.match(/ZOOM/)&&
(!this.nLabelUpper||map.Scale.nTrueMapScale*map.Scale.nZoomScale<=this.nLabelUpper)){var la=(la=this.itemA[a].szLabel)?isNaN(__scanValue(la))?la+(this.szLabelUnits||""):this.formatValue(__scanValue(la),2)+(this.szLabelUnits||""):this.szLabelField+"?",J=map.Scale.normalX(6),jb="opacity:0.7;font-family:arial;font-size:"+J+"px;text-anchor:middle;fill:#000000;pointer-events:none",Cd="opacity:1;fill:white;fill-opacity:0.4;stroke:#000000;stroke-width:"+map.Scale.normalX(1)+"pointer-events:none;",ic=(la.length+
2)*J*.5,cb=map.Dom.newGroup(t,"");cb.parentNode.append(cb);b.match(/MULTI/)?jb+=";fill:#888888":cb.setAttributeNS(szMapNs,"class",String(K));var Fb=map.Dom.newShape("rect",cb,-ic/2,.95*-J,ic,1.2*J,Cd);Fb.setAttributeNS(null,"rx",.2*J);Fb.setAttributeNS(null,"ry",.2*J);D=map.Dom.newText(cb,0,0,jb,la);dd=D.fu.getBox();w=Math.max(dd.width,ic);Fb.setAttributeNS(null,"x",-w/2);Fb.setAttributeNS(null,"width",w);b.match(/MULTI/)?(cb.fu.setPosition(map.Scale.normalX(15)+.5*w,.77*J),cb.fu.scale(2,2),Fb.parentNode.removeChild(Fb)):
cb.fu.setPosition(w/3,J/3+Ia.y);this.itemA[a].labelGroup=cb}if(b.match(/MENU/)){var lc=t.fu.getBox();t.fu.setPosition(-lc.x-lc.width/2,-lc.y-lc.height/2-map.Scale.normalY(d/2)-map.Scale.normalY(2))}else b.match(/ZOOM/)||(t.fu.setPosition(t.fu.getPosition().x-q.x,t.fu.getPosition().y-q.y),ba&&ba.fu.setPosition(ba.fu.getPosition().x-q.x,ba.fu.getPosition().y-q.y));if(b.match(/ZOOM/)){var Mc=map.Dom.getBox(c);Mc.height>map.Scale.normalY(150)&&(G=Math.min(1,map.Scale.normalY(150)/Mc.height),G=Math.max(G,
map.Scale.normalY(30)/Mc.height),t.fu.scale(G,G),x&&x.fu.scale(G,G),E&&(E.fu.scale(G,G),ka=E.fu.getPosition(),E.fu.setPosition(ka.x*G,ka.y)))}q.x=0;q.y=0;a&&(this.itemA[a].fDone=!0);this.nChartSizeDone=d;return q};MapTheme.prototype.getShapes=function(){var c=map.Layer.getLayerObj(this.szThemesA[0]);if(!c||!c.szFlag.match(/tiled/))for(var a in this.itemA)this.parent.themeNodesA[a]||(this.parent.themeNodesA[a]=this.getShapeA(a))};
MapTheme.prototype.getItemNodes=function(c){this.parent.themeNodesA[c]&&this.parent.themeNodesA[c].length||(this.parent.themeNodesA[c]=this.getShapeA(c));return this.parent.themeNodesA[c]||[]};
MapTheme.prototype.getShapeA=function(c){c=__mpap_decode_utf8(c);var a=SVGDocument.getElementById(c.trim());if(a)return Array(a);if(c.match(/\,/))for(var d=c.split("::"),b=d[0].split(","),f=0;f<b.length;f++)if(a=SVGDocument.getElementById((b[f]+"::"+d[1]).trim()))return Array(a);this.nMissingLookupCount++;this.missedA[c]=c;return[]};MapTheme.prototype.getPositions=function(){for(var c in this.itemA)this.getNodePosition(this.itemA[c].szSelectionId)};
MapTheme.prototype.getNodePosition=function(c){if("undefined"==typeof c)return null;var a=this.themeNodesPosA;if(!a[c]){if(c.match(/:clone/))return null;if(c.match(/(-?[0-9\.]+) ?, ?(-?[0-9\.]+)/)){var d=this.getMapPosition(c);a[c]=new point(d.x,d.y);return a[c]}this.parent.themeNodesA[c]||(this.parent.themeNodesA[c]=this.getShapeA(c));d=this.parent.themeNodesA[c][0];if(1<this.parent.themeNodesA[c].length)for(var b=parseFloat(d.getAttributeNS(szMapNs,"area")),f=1;f<this.parent.themeNodesA[c].length;f++){var e=
this.parent.themeNodesA[c][f],l=parseFloat(e.getAttributeNS(szMapNs,"area"));l>b&&(b=l,d=e)}d&&(this.szShapeType.match(/line/)?((b=d.getAttributeNS(szMapNs,"center"))&&2<b.length?(b=b.split(","),b=new box(Number(b[0].split(":")[1]),Number(b[1].split(":")[1]),0,0)):map.Dom.getBox(d),b=map.Dom.getBox(d)):((b=d.getAttributeNS(szMapNs,"center"))||(b=d.parentNode.getAttributeNS(szMapNs,"center")),b&&2<b.length?(b=b.split(","),b=new box(Number(b[0].split(":")[1]),Number(b[1].split(":")[1]),0,0)):b=map.Dom.getBox(d)),
f=map.Scale.getMapOffset(d),a[c]=new point(f.x+b.x+b.width/2,f.y+b.y+b.height/2),d=getMatrix(d))&&(a[c].x+=d[4],a[c].y+=d[5])}if(a[c]&&"undefined"!=typeof a[c].x&&"undefined"!=typeof a[c].y)return a[c];this.missedA[c]=c;return null};
MapTheme.prototype.getNodeBox=function(c){if("undefined"==typeof c)return null;if(!this.parent.themeNodesBoxA[c]){if(c.match(/:clone/))return null;this.parent.themeNodesA[c]||(this.parent.themeNodesA[c]=this.getShapeA(c));var a=this.parent.themeNodesA[c][0];if(1<this.parent.themeNodesA[c].length)for(var d=parseFloat(a.getAttributeNS(szMapNs,"area")),b=1;b<this.parent.themeNodesA[c].length;b++){var f=this.parent.themeNodesA[c][b],e=parseFloat(f.getAttributeNS(szMapNs,"area"));e>d&&(d=e,a=f)}a&&(d=
map.Dom.getBox(a),a=map.Scale.getMapOffset(a),this.parent.themeNodesBoxA[c]=new box(a.x+d.x,a.y+d.y,d.width,d.height))}return this.parent.themeNodesBoxA[c]};MapTheme.prototype.getNodeArea=function(c){return(c=this.getItemNodes(c)[0])?Number(c.getAttributeNS(szMapNs,"area"))/1E6:0};var positionRegExp=/(-?[0-9\.]+) ?, ?(-?[0-9\.]+)/;
MapTheme.prototype.getMapPosition=function(c){if(c){var a=null;if(c&&(a=c.match(positionRegExp)))return 180<Math.abs(parseFloat(a[1]))||180<Math.abs(parseFloat(a[2]))?new point(0,0):map.Scale.getMapPositionOfLatLon(parseFloat(a[1]),parseFloat(a[2]))}return new point(0,0)};MapTheme.prototype.onClick=function(c){this.fRemove||(this.widgetNode&&this.enable(),this.fToFront=!0,executeWithMessage("map.Themes.execute()","... processing ..."),map.Themes.onclickInfo(c,this.szId))};
MapTheme.prototype.showErrorInfo=function(){if(0!==this.nMissingPositionCount){var c=this.szId+":errordisplay:widget",a=map.Dictionary.getLocalText("Chart statistic"),a=new InfoContainer(SVGDocument,this.widgetNode,c+":movable",new point(map.Scale.normalX(0),map.Scale.normalX(0)),new point(-map.Scale.normalX(15),map.Scale.normalX(80)),"fixed",a),d=a.workspaceNode,b=[map.Dictionary.getLocalText("total items"),map.Dictionary.getLocalText("charts drawn"),map.Dictionary.getLocalText("missing positions"),
map.Dictionary.getLocalText("missing value match"),map.Dictionary.getLocalText("zero values"),String(this.nCount),String(this.nRealizedCount),String(this.nMissingPositionCount),String(this.nMissingRangeCount),String(this.nZeroValueCount)],d=map.Dom.newGroup(d,"");d.fu.setPosition(0,map.Scale.normalY(3));createTextGrid(SVGDocument,d,c+":textgrid",b,2);a.reformat()}};
MapTheme.prototype.getDataGrid=function(c,a){if(this.szFlag.match(/AGGREGATE/)&&3<this.itemA[c].nCount)return null;var d=map.Themes.getDataRow(c,this);if(d&&d.length){for(var b=0;b<d.length;b++)d[b]=d[b]||"---";var f;(b=new ScrollArea(null,a,null,10,10,10))?(b.reformat(),f=b.workspaceNode):f=a;for(var e=[],l=map.Themes.getFieldIndexArray(this),k=0;k<l.length;k++)e[l[k]]="font-weight:bold;fill:#087BBB",e[l[k+d.length/2]]="font-weight:bold;fill:#087BBB";l=map.Scale.tStyle.Description.nFontHeight/map.Scale.normalX(1);
d=createTextGrid(SVGDocument,f,":textgrid",d,2,l,e);return b?(b.setWidth(Math.min(d.fu.getBox().width/map.Scale.normalX(1)+25,map.Scale.bBox.width/map.Scale.normalY(2.2))),b.setHeight(Math.min(d.fu.getBox().height/map.Scale.normalY(1)+25,map.Scale.bBox.height/map.Scale.normalY(1.5))),b.reformat(),b.hasScrollBars()&&b.setScrollPosition(new point(0,0)),b):d.fu}};function __sortYposUp(c,a){return c.y>a.y?1:-1}function __sortYposDown(c,a){return c.y<a.y?1:-1}
MapTheme.prototype.drawTextforOneQuadrant=function(c,a,d,b,f,e,l,k){var n=c.szStyle.match(/3D/)?2.4*d:1.2*d,h=n/2;k-=n*(a.length-2);for(var p=0;p<a.length;p++){var g=a[p].y/a[p].ly,u=Math.max(h,Math.min(a[p].y,k)),h=u+n;k+=d;var r=1.2*a[p].x,r=l+map.Scale.normalX(2);u>a[p].y&&(g=Math.max(g,u/a[p].y));var q=c.mX+a[p].lx*f,t=c.mY+a[p].ly*e,x=c.mX+a[p].x*f,E=c.mY+a[p].y*e,r=c.mX+r*f,u=c.mY+u*e,B=map.Dom.newGroup(c.frameGroup,"");c.donutPartsA[a[p].index].textNode=B;var m=map.Dom.newGroup(B,""),y=map.Dom.newGroup(B,
"");g&&(map.Dom.newShape("line",m,q,t,x,E,"stroke:white;stroke-width:"+map.Scale.normalX(1.5)+";opacity:0.2;"),map.Dom.newShape("line",y,q,t,x,E,"stroke:#888888;stroke-width:"+map.Scale.normalX(.5)+";opacity:1;"),q=x,t=E);a[p].x<l-map.Scale.normalX(3)&&(map.Dom.newShape("line",m,q,t,c.mX+(l-map.Scale.normalX(3))*f,t,"stroke:white;stroke-width:"+map.Scale.normalX(1.5)+";opacity:0.2;stroke-linecap:round;"),map.Dom.newShape("line",y,q,t,c.mX+(l-map.Scale.normalX(3))*f,t,"stroke:#888888;stroke-width:"+
map.Scale.normalX(.5)+";opacity:1;"),q=c.mX+(l-map.Scale.normalX(3))*f);map.Dom.newShape("line",m,q,t,r,u,"stroke:white;stroke-width:"+map.Scale.normalX(1.5)+";opacity:0.2;stroke-linecap:round;");map.Dom.newShape("line",y,q,t,r,u,"stroke:#888888;stroke-width:"+map.Scale.normalX(.5)+";opacity:1;");q=r;r+=map.Scale.normalX(2)*f;map.Dom.newShape("line",m,q,u,r,u,"stroke:white;stroke-width:"+map.Scale.normalX(1.5)+";opacity:0.2;");map.Dom.newShape("line",y,q,u,r,u,"stroke:#888888;stroke-width:"+map.Scale.normalX(.5)+
";opacity:1;");r+=map.Scale.normalX(1.5)*f;(g=c.partsA[a[p].index]&&c.partsA[a[p].index].szText?c.partsA[a[p].index].szText:null)||(g=c.partsA[a[p].index].szInfo?c.partsA[a[p].index].szInfo:Math.round(10*c.partsA[a[p].index].nInfoValue)/10+" % ");g=this.createTextLabel(SVGDocument,B,"",g,d/map.Scale.normalX(1),b,this.szFlag.match(/VALUEBACKGROUND/)?c.partsA[a[p].index].color:"white",this.szChartFlag.match(/ZOOM/)?null:this.szTextColor);g.fu.setPosition(r-d,u-0*d);g.setAttributeNS(szMapNs,"tooltip",
c.partsA[a[p].index].szInfo);c.szStyle.match(/3D/)&&g.fu.scale(1,2)}};
MapTheme.prototype.drawDonutText=function(c,a){for(var d=0,b=0,f=0,e=[],l=[],k=[],n=[],h=Math.min(10,this.partsA.length),p=0;p<h;p++){var g=c.getTextPosition(p);if(g){if(this.szShowPartsA){var u=!1,r;for(r in this.szShowPartsA)this.szShowPartsA[r]==p&&(u=!0);if(!u)continue}d=Math.max(d,Math.abs(g.y));b=Math.max(b,g.x);f=Math.min(f,g.x);c.szStyle.match(/STARBURST/)?(b=Math.max(b,g.x),f=Math.min(f,g.x)):(b=c.nRadOuter,f=-c.nRadOuter);0<g.x?0<g.y?l[l.length]={index:p,x:g.x,y:g.y,lx:g.lx,ly:g.ly}:e[e.length]=
{index:p,x:g.x,y:-g.y,lx:g.lx,ly:-g.ly}:0<g.y?k[k.length]={index:p,x:-g.x,y:g.y,lx:-g.lx,ly:g.ly}:n[n.length]={index:p,x:-g.x,y:-g.y,lx:-g.lx,ly:-g.ly}}}e.sort(__sortYposUp);l.sort(__sortYposUp);k.sort(__sortYposUp);n.sort(__sortYposUp);a||(a=map.Scale.normalX(12));this.drawTextforOneQuadrant(c,e,a,"text-anchor:start;",1,-1,b,d);this.drawTextforOneQuadrant(c,l,a,"text-anchor:start;",1,1,b,d);this.drawTextforOneQuadrant(c,k,a,"text-anchor:end;",-1,1,-f,d);this.drawTextforOneQuadrant(c,n,a,"text-anchor:end;",
-1,-1,-f,d)};
MapTheme.prototype.createTextLabel=function(c,a,d,b,f,e,l,k,n){var h="#555555",p=!0,g=!0,u=1,r=" "+this.szChartFlag+"|"+this.szFlag;if(r.match(/ZOOM/)||r.match(/MENUSIZE/)||r.match(/NORMSIZE/)||r.match(/INFOSIZE/)||r.match(/AXIS/)||r.match(/SELECTION/))p=l?p:!1,g=!1;r.match(/VALUEBACKGROUND/)&&(p=!0);r.match(/HORZ/)&&(p=!1);f||(f=14);e||(e="");l&&p?(h=k||ColorScheme.getTextColor(l),u=r.match(/ZOOM/)?.9:.5):(l="#fefeff",h=0>parseFloat(b)?"#ee3333":k);if(c&&a)return c=map.Dom.newGroup(a,d),a=null,g&&
!this.fShadow&&this.fOrigShadow&&(a=map.Dom.newShape("rect",c,1,1,1,1,"fill:#444444;fill-opacity:0.4;stroke:none;")),l=map.Dom.newShape("rect",c,1,1,1,1,"fill:"+l+";fill-opacity:"+u+";stroke:none;stroke-width:"+map.Scale.normalX(.05*f)+""),e=map.Scale.tStyle.Values.szStyle+(this.szTextFont?"font-family:"+this.szTextFont:"")+";font-size:"+map.Scale.normalY(f)+"px;fill:"+h+";fill-opacity:1;"+e,n&&n.match(/\bGLOW\b/)&&map.Dom.newText(c,map.Scale.normalX(f),map.Scale.normalY(.25*f),e+";font-size:"+map.Scale.normalY(f)+
"px;font-weight:normal;fill:none;stroke:white;stroke-width:"+map.Scale.normalY(f)/5+";stroke-opacity:0.3;pointer-events:none;stroke-linejoin:bevel;",b),map.Dom.newText(c,map.Scale.normalX(f),map.Scale.normalY(.25*f),e,b),b=map.Dom.newText(SVGHiddenGroup,map.Scale.normalX(f),map.Scale.normalY(.25*f),e,b),n=b.fu.getBox(),SVGHiddenGroup.removeChild(b),l.setAttributeNS(null,"rx",map.Scale.normalX(.1*f)),l.setAttributeNS(null,"ry",map.Scale.normalX(.1*f)),l.setAttributeNS(null,"x",n.x-map.Scale.normalX(.3*
f)),l.setAttributeNS(null,"y",n.y-map.Scale.normalY(0*f)),l.setAttributeNS(null,"width",n.width+map.Scale.normalX(.7*f)),l.setAttributeNS(null,"height",n.height+.1*map.Scale.normalY(f)),a&&(a.setAttributeNS(null,"rx",map.Scale.normalX(.1*f)),a.setAttributeNS(null,"ry",map.Scale.normalX(.1*f)),a.setAttributeNS(null,"x",n.x-map.Scale.normalX(.3*f)+map.Scale.normalX(.12*f)),a.setAttributeNS(null,"y",n.y+map.Scale.normalY(0*f)+map.Scale.normalY(.12*f)),a.setAttributeNS(null,"width",n.width+map.Scale.normalX(.7*
f)),a.setAttributeNS(null,"height",n.height+.1*map.Scale.normalY(f))),p||(l.style.setProperty("display","none",""),a&&a.style.setProperty("display","none","")),c};
MapTheme.prototype.getOverviewChart=function(c,a){c.fu=new Methods(c);var d=30;this.szChartFlag+="|MENUSIZE";if(this.szOverviewChart&&"NONE"!=this.szOverviewChart&&this.nCount){var d=map.Scale.normalX(100),b=map.Scale.normalY(100),f=map.Scale.normalX(75),e=map.Scale.normalX(50);if("undefined"!=typeof DonutCharts){var l=map.Dom.newGroup(c),d=DonutCharts.newChart(SVGDocument,l,d,b,f,e);this.szOverviewChart.match(/PIE/)&&(d.setStyle("flat"),d.setRadInner(0),d.setRadOuter(map.Scale.normalX(55)),d.setCenter(map.Scale.normalX(80),
map.Scale.normalY(55)));if(this.szOverviewChart.match(/DONUT/)||this.szOverviewChart.match(/3D/))d.setStyle("3D"),d.setCenter(map.Scale.normalX(80),map.Scale.normalY(100));d.setLine("white");d.setLineWidth(map.Scale.normalX(.1));b=map.Scale.normalY(20);for(f=0;f<this.partsA.length;f++){e=this.partsA[f].nCount/this.nCount*100;l=100/this.nSum*this.partsA[f].nSum;this.nRealizedCount&&this.szFlag.match(/CHART/)&&(e=this.partsA[f].nCount/this.nRealizedCount*100);this.nExactCount&&this.exactSizeA&&(e=this.partsA[f].nCount/
this.nExactCount*100,l=this.exactSizeA[f]);this.szOverviewChart.match(/DONUT/)&&(b=map.Scale.normalY(this.partsA[f].nSum/this.nSum*80));var k=String(this.partsA[f].nCount),n=e?String(" = "+this.formatValue(e,1)+" %"):"",h=l?String(", "+this.szLabelA[f]+" => "+this.formatValue(l,1)+""+this.szUnit):"";this.szOverviewChart.match(/PERCENTOFVALUE/)?(e=l,n="",k=this.nExactCount&&this.exactSizeA?String(this.formatValue(e,0)):String(this.formatValue(e,1)+(this.szFlag.match(/CHART/)?this.szUnit:" %"))):this.szOverviewChart.match(/DONUT/)||
(h="");this.szFlag.match(/CATEGORICAL/)?(n+=" ("+this.szLabelA[f]+")",h=""):this.szLegendLabelA&&this.szLegendLabelA.length&&(n+=" ["+this.szLegendLabelA[f]+"])");d.addPart(e,b,this.partsA[f].color,0,k,String(this.partsA[f].nCount)+" member(s)"+n+h,"map.Themes.markClass(evt,'"+this.szId+"','"+f+"')","map.Themes.unmarkClass(evt,'"+this.szId+"')")}d.realize();this.drawDonutText(d);d=map.Dom.getBox(c);if(0<d.width&&0<d.height){h=c.fu.getPosition();l=this.szOverviewChart.match(/PERCENTOFVALUE/)?"*  value / class":
"*  members / class";b=map.Scale.normalY(10);if(this.szOverviewChart.match(/DONUT/)||this.szOverviewChart.match(/3D/))b=map.Scale.normalY(15);map.Dom.newText(c,map.Scale.normalX(80),d.y+d.height+b,map.Scale.tStyle.Note.szStyle+";text-anchor:middle;",l)}}}else{if((this.szFlag.match(/BUBBLE/)||this.szFlag.match(/SQUARE/)||this.szFlag.match(/SYMBOL/))&&(!this.szFlag.match(/CATEGORICAL/)||!this.szFlag.match(/SYMBOL/))){f=this.nMinA[0];k=this.nMaxA[0];this.szSizeField&&(f=this.nMinSize,k=this.nMaxSize);
b=map.Scale.normalX(d/2);e=b/Math.sqrt(k)*Math.sqrt(f);if(this.szFlag.match(/LINEAR/)||this.szFlag.match(/SIZEP1/))e=b/k*f;l=this.szFlag.match(/SUM/)?"sum":"mean";n=5;n=map.Dom.newGroup(c);if(!this.szFlag.match(/CATEGORICAL/)){var p=map.Dom.newGroup(n);this.drawChart(p,null,1.5*d,"VALUES|ZOOM|NORMSIZE");if(this.szFlag.match(/SEQUENCE/)){var g=map.Dom.getBox(p),h=p.fu.getPosition();p.fu.setPosition(g.width/1.5+h.x,-g.height/2+h.y);h=map.Scale.normalX(7*d)/g.height;p.fu.scale(h,h);d*=7}map.Dom.newText(n,
map.Scale.normalX(0),map.Scale.normalY(5),map.Scale.tStyle.Note.szStyle+";text-anchor:left;",map.Dictionary.getLocalText(l));n.fu.setPosition(map.Scale.normalX(20),map.Scale.normalY(d))}this.szFlag.match(/SEQUENCE/)||(l=map.Dom.newGroup(c),n=map.Dom.getBox(n),l.fu.setPosition(n.x+n.width+map.Scale.normalX(.66*d),map.Scale.normalY(-5)),n=0,h="fill:none;stroke:black;stroke-width:"+map.Scale.normalX(.25)+"px",p=map.Dom.newGroup(l),this.szFlag.match(/BUBBLE/)?map.Dom.newShape("circle",p,0,0,b,h):this.szFlag.match(/SQUARE/)&&
map.Dom.newShape("rect",p,-b,-b,2*b,2*b,h),map.Dom.newShape("line",p,0,-b,1.1*b,-b,h),map.Dom.newText(p,1.1*b+map.Scale.normalX(2),-b,"font-family:arial;font-size:"+map.Scale.normalX(10)+"px;text-anchor:left;baseline-shift:-10%;fill:black;stroke:none;pointer-events:none",this.formatValue(k,1)+this.szUnit),p.fu.setPosition(map.Scale.normalX(20),map.Scale.normalY(n+d/2)),0<e&&e!=b&&(k=map.Dom.newGroup(l),this.szFlag.match(/BUBBLE/)?map.Dom.newShape("circle",k,0,0,e,h):this.szFlag.match(/SQUARE/)&&map.Dom.newShape("rect",
k,-e,-e,2*e,2*e,h),map.Dom.newShape("line",k,0,-e,1.1*b,-e,h),map.Dom.newText(k,1.1*b+map.Scale.normalX(2),-e,"font-family:arial;font-size:"+map.Scale.normalX(10)+"px;text-anchor:left;baseline-shift:-60%;fill:black;stroke:none;pointer-events:none",this.formatValue(f,1)+this.szUnit),k.fu.setPosition(map.Scale.normalX(20),map.Scale.normalY(n)+2*b-e)),map.Dom.newText(l,map.Scale.normalX(20),map.Scale.normalY(n+d+15),map.Scale.tStyle.Note.szStyle+";text-anchor:left;",map.Dictionary.getLocalText("min / max size-values")));
c.fu.scale(1,1)}this.szFlag.match(/CHART/)&&this.szFlag.match(/BUFFER/)&&(b=map.Scale.normalX(d/2),f=map.Dom.getBox(c.parentNode),f=0<f.width?f.width/map.Scale.normalX(1)+10:10,p=map.Dom.newGroup(c.parentNode),map.Dom.newShape("circle",p,0,0,b,"fill:none;stroke:black;"),h="fill:none;stroke:black;stroke-width:"+map.Scale.normalX(1)+";",map.Dom.newShape("line",p,0,0,b,0,h),map.Dom.newShape("line",p,0,map.Scale.normalY(-2),0,map.Scale.normalY(2.5),h),map.Dom.newShape("line",p,b,0,b+map.Scale.normalX(-3),
map.Scale.normalY(-3),h),map.Dom.newShape("line",p,b,0,b+map.Scale.normalX(-3),map.Scale.normalY(3),h),map.Dom.newText(p,1.1*b+map.Scale.normalX(2),map.Scale.normalX(-10),"font-family:arial;font-size:"+map.Scale.normalX(10)+"px;text-anchor:left;baseline-shift:-10%;fill:black;stroke:none;pointer-events:none",Map.Scale.prototype.formatDistanceString(this.nBufferSize*this.nScale)),p.fu.setPosition(map.Scale.normalX(d/2+f),map.Scale.normalY(d/2)),b=new Button(c.parentNode,a+":bufferselectbutton","BUTTON",
"#bufferselect_button","map.Selections.newSelection('activeLayer','activeBuffer','type:BUFFER;buffersize:200','test');","","select active layer with this buffer"),b.setPosition(map.Scale.normalX(d+f+10),map.Scale.normalY(d)),b.scale(1.4,1.4),_activeTheme&&map.Dom.newText(c.parentNode,map.Scale.normalX(d+f+20),map.Scale.normalY(d+6),"font-family:arial;font-size:"+map.Scale.normalX(8)+"px;text-anchor:left;baseline-shift:-10%;fill:gray;stroke:none;pointer-events:none","... "+_activeTheme+""));if(!(!this.szFlag.match(/CHART/)||
this.szFlag.match(/BUBBLE/)||this.szFlag.match(/SQUARE/)||this.szFlag.match(/CATEGORICAL/)||this.szFlag.match(/BUFFER/)||this.szFlag.match(/SYMBOL/))){f=map.Dom.getBox(c.parentNode);0>f.width&&(f=new box(0,0,0,0));d=30;this.szFlag.match(/BAR/)&&5<this.nOrigSumA.length&&!this.szFlag.match(/STACKED/)&&(d=15*this.nOrigSumA.length/Math.log(this.nOrigSumA.length));this.drawChart(c,null,d,"VALUES|NORMSIZE"+(this.szFlag.match(/STACKED/)?"|EXPANDMAX":""));d=map.Dom.getBox(c);e=1;e=Math.min(2.5,Math.max(f.height/
d.height,map.Scale.normalX(100)/d.height));c.fu=new Methods(c);c.fu.scale(e,e);b=map.Dom.newGroup(c,"textGroup");b.fu.scale(1/e,1/e);d=c.fu.getBox();this.szFlag.match(/BAR/)?c.fu.setPosition(f.width-d.x+map.Scale.normalX(10),-d.y+Math.max(10,.95*f.height-d.height)):c.fu.setPosition(f.width-d.x+map.Scale.normalX(10),-d.y+Math.max(10,f.height/2-d.height/2));l=" * overall sum";this.szAggregation&&this.szAggregation.match(/mean/)&&(l=" * arithmetic mean");f="middle";if(this.szFlag.match(/RIGHT/)||this.szFlag.match(/STACKED/)||
this.szFlag.match(/CENTER/)||this.szFlag.match(/POINTER/)||2>=this.partsA.length)f="start";map.Dom.newText(b,0,d.height+d.y+map.Scale.normalY(5),map.Scale.tStyle.Note.szStyle+"baseline-shift:-100%;text-anchor:"+f+";",l)}}};
MapTheme.prototype.drawColorSchemeLegend=function(c,a){var d=null,b=map.Scale.nButtonSize?.66*map.Scale.nButtonSize:12,f=map.Scale.nButtonSize||12,e=map.Scale.nButtonSize?1.2*map.Scale.nButtonSize:18,l=e,k="font-family:arial;font-size:"+map.Scale.normalY(b)+"px;fill:#666666;pointer-events:none;",n=1.2*f;this.szFlag.match(/BAR/)&&this.szFlag.match(/\bUP\b/)&&(n=f);var h=1.15*b,p=0*n,g=0;this.szFlag.match(/BAR/)&&(this.szFlag.match(/\bUP\b/)||this.szFlag.match(/STACKED/))&&(g=this.partsA.length-1);
this.showInfoMore||this.szFlag.match(/CATEGORICAL/)||this.szFlag.match(/\bUP\b/)||this.szFlag.match(/SYMBOL/)||this.szLabelA&&!this.szFlag.match(/\bCLIP\b/)||2>=this.partsA.length?this.szLegendStyle="large":this.szLegendStyle="compact";var u=new ScrollArea(null,c,null,10,10,10);u?(u.reformat(),d=u.workspaceNode):d=map.Dom.newGroup(c,a+":legend");for(var r=1,q=0;q<this.partsA.length;q++)this.partsA[q].min&&(this.partsA[q].min.toFixed(0)!=this.partsA[q].min&&(r=Math.min(r,.1)),this.partsA[q].min.toFixed(1)!=
this.partsA[q].min&&(r=Math.min(r,.01)));for(var t=[],q=0;q<this.partsA.length;q++)t[q]={},t[q].i=q,t[q].value=this.partsA[q].nCount;this.szFlag.match(/SYMBOL/)&&this.szFlag.match(/CATEGORICAL/)&&this.szFlag.match(/SORTDOWN/)&&t.sort(this.sortIndexDown);!this.szFlag.match(/POINTER/)&&!this.szFlag.match(/INVERT/)||this.szLegendStyle.match(/compact/)||t.reverse();var x=1;!this.szLabelA&&15<t.length&&(x=Math.floor(t.length/10),f*=1.5);var E=this.showInfoMore&&this.isMarkable?18:10,B=!1;if(this.szFlag.match(/CHART/)&&
1<this.szFieldsA.length&&!this.szFlag.match(/OFFSET/)&&!this.szFlag.match(/DEVIATION/)){for(var m=B=0;m<this.nOrigSumA.length;m++)this.partsA[m]&&"undefined"!=typeof this.partsA[m].nSum&&B++;B=B==this.nOrigSumA.length}for(var y=0;y<t.length;y+=x){var q=t[y].i,A=Math.min(Math.abs(g-q),this.partsA.length-x),z=null,m=null;if(this.szFlag.match(/SYMBOL/)&&this.szFlag.match(/CATEGORICAL/))e=0===this.nSkipCount?3*this.partsA[q].nCount/this.nCount*100:30/this.nCount*10*this.partsA[q].nCount;else if(B){m=
e=0;if(this.szFlag.match(/MORPH/)){for(m=0;m<this.nOrigSumA.length/2;m++)e=Math.max(e,this.nOrigSumA[m]*(this.nClipFrames-1-this.nActualFrame)/(this.nClipFrames-1)+this.nOrigSumA[m+this.nOrigSumA.length/2]*this.nActualFrame/(this.nClipFrames-1));m=(this.nOrigSumA[A]*(this.nClipFrames-1-this.nActualFrame)/(this.nClipFrames-1)+this.nOrigSumA[A+this.nOrigSumA.length/2]*this.nActualFrame/(this.nClipFrames-1))/e}else{for(m=0;m<this.nOrigSumA.length;m++)e=Math.max(e,this.partsA[m].nSum);m=this.partsA[A].nSum/
e}e=60*m}e=isNaN(e)?l:e;if(this.szFlag.match(/BUBBLE/))m=this.szFlag.match(/CATEGORICAL/)||this.szSizeField?f/2:f/4+f/4*(q+1)/this.partsA.length,m=map.Dom.newShape("circle",d,map.Scale.normalX(E+f/2),map.Scale.normalY(p+f/2),map.Scale.normalY(m),"fill:"+this.colorScheme[A]+";stroke:#eeeeee;stroke-width:"+map.Scale.normalX(.1)+";");else if(1<x)for(var m=map.Dom.newGroup(d,""),v=0;v<x;v++)map.Dom.newShape("rect",m,map.Scale.normalX(E),map.Scale.normalY(p+f/x*v),map.Scale.normalX(e),map.Scale.normalY(f/
x),"fill:"+this.colorScheme[A+v]+";stroke:none;");else m=map.Dom.newShape("rect",d,map.Scale.normalX(E),map.Scale.normalY(p),map.Scale.normalX(e),map.Scale.normalY(f),"fill:"+this.colorScheme[A]+";stroke:#eeeeee;stroke-width:"+map.Scale.normalX(.1)+";");if(m){for(var N=this.partsA[A].nCount,v=1;v<x;v++)N+=this.partsA[A+v].nCount;this.isMarkable&&this.showInfoMore&&(map.Dom.newShape("rect",d,map.Scale.normalX(-5),map.Scale.normalY(p-2),map.Scale.normalX(e),map.Scale.normalY(f+4),"fill:white;stroke:none;opacity:0;").setAttributeNS(null,
"id",this.szId+":widget:background:"+A),v=new Button(d,this.szId+":class:"+A,"CHECKBOX|SELECTED","","map.Themes.showClass(evt,'"+this.szId+"','"+A+"','"+x+"')","map.Themes.hideClass(evt,'"+this.szId+"','"+A+"','"+x+"')","show/hide class"),v.setPosition(map.Scale.normalX(map.Scale.nButtonSize/2-1),map.Scale.normalY(p+map.Scale.nButtonSize/2-1)),v.scale(.75,.75));var z=this.partsA[A].min+(y?r:0),v=this.partsA[A+x-1].max,R=100<v-z?0:2,z=this.formatValue(z,R),R=this.formatValue(v,R),Ca="";this.szFlag.match(/SHOWMEMBERS/)&&
(Ca="  ["+N+"]");v="";v=z!=R?z+"..."+R+(this.szLegendUnits?this.szLegendUnits:"")+this.szUnit+Ca:z+(this.szLegendUnits?this.szLegendUnits:"")+this.szUnit+Ca;(!this.szFlag.match(/\bCLIP\b/)||this.szFlag.match(/MORPH/))&&this.szLabelA&&this.szLabelA[A]&&(v=this.szLabelA[A]);this.szLegendLabelA[A]=v;if(this.szLegendStyle.match(/compact/))this.fGrayNoMember&&0===N&&this.szFlag.match(/CHOROPLETH/)&&this.szFlag.match(/DOMINANT/)&&(m.style.setProperty("fill-opacity","0.03",""),m.style.getPropertyValue("fill"),
m.style.setProperty("stroke-opacity","0.2",""),m.style.setProperty("stroke","black",""),m.style.setProperty("stroke-width",map.Scale.normalX(.3),"")),this.szFlag.match(/CATEGORICAL/)||this.szFlag.match(/DOMINANT/)&&15<v.length||(Ca=";font-size:"+map.Scale.normalX(.9*b)+"px;",0===y?(v=0<v.length?z+this.szUnit:v,map.Dom.newText(d,map.Scale.normalX(E+2),map.Scale.normalY(p+h*(x+1.5)),k+Ca,v)):y==t.length-x&&(v=0<v.length?R+this.szUnit:v,map.Dom.newText(d,map.Scale.normalX(E+2),map.Scale.normalY(p+h*
(x+1.5)),k+Ca,v)));else if(this.szFlag.match(/SYMBOL/)&&this.szFlag.match(/CATEGORICAL/))z=e+2,R=String(this.partsA[q].nCount),0===this.nSkipCount&&(R=String(Math.round(100/this.nCount*this.partsA[q].nCount))+"%"),Ca=5*R.length/7*b,"dynamic"==this.szTextPlacement&&Ca<e&&(z-=5*String(this.partsA[q].nCount).length/7*b),map.Dom.newText(d,map.Scale.normalX(E+z),map.Scale.normalY(p+h+1),k,R),z+=Ca,this.szSymbolsA[q]&&this.szSymbolsA[q].match(/symbol/)&&(R=map.Dom.constructNode("use",d,{"xlink:href":"#"+
this.szSymbolsA[q]+":antizoomandpan"}),R.setAttributeNS(null,"style","fill:"+this.colorScheme[A]),R.fu.scale(.5,.5),R.fu.setPosition(map.Scale.normalX(E+z+10),map.Scale.normalY(p+h-3)),z+=20),z=map.Dom.newText(d,map.Scale.normalX(E+z),map.Scale.normalY(p+h),k,"("+v+")"),z.style.setProperty("fill","#bbbbdd","");else{z=e+4;if(B){R=this.partsA[A].nSum;this.szFlag.match(/MORPH/)&&(R=this.nOrigSumA[A]*(this.nClipFrames-1-this.nActualFrame)/(this.nClipFrames-1)+this.nOrigSumA[A+this.nOrigSumA.length/2]*
this.nActualFrame/(this.nClipFrames-1));if(this.szField100&&!this.szFlag.match(/SUM/)||this.szAggregation&&!this.szAggregation.match(/sum/))R/=this.partsA[A].nCount;v=v+"  ("+this.formatValue(R,1)+this.szUnit+")"}z=map.Dom.newText(d,map.Scale.normalX(E+z),map.Scale.normalY(p+h),k,v);this.fGrayNoMember&&0===N&&this.szFlag.match(/CHOROPLETH/)&&(z.style.setProperty("fill","#bbbbdd",""),m.style.setProperty("opacity","0.1",""))}this.szFlag.match(/BUFFER/)&&m.style.setProperty("fill-opacity",this.fillOpacity?
this.fillOpacity:this.nOpacity?this.nOpacity:0,"");1==this.szFieldsA.length||!this.szFlag.match(/CHART/)||this.szFlag.match(/SYMBOL/)&&this.szFlag.match(/CATEGORICAL/)?(this.szLegendStyle.match(/compact/)?m.setAttributeNS(szMapNs,"tooltip",v+" ("+N+" member(s))"):m.setAttributeNS(szMapNs,"tooltip",N+" member(s)"),q=m.getAttributeNS(null,"style"),m.setAttributeNS(szMapNs,"onoverstyle",q+";stroke:black;stroke-width:"+map.Scale.normalX(.5)+";"),m.setAttributeNS(null,"onmouseover","map.Themes.markClass(evt,'"+
this.szId+"','"+A+"','"+x+"')"),m.setAttributeNS(null,"onmouseout","map.Themes.unmarkClass(evt,'"+this.szId+"')"),m.setAttributeNS(null,"onclick","map.Themes.zoomToClass(evt,'"+this.szId+"','"+A+"','"+x+"')"),m.setAttributeNS(null,"id",a+":widget:classrect:"+A)):this.szFlag.match(/SYMBOL/)?this.szFlag.match(/CATEGORICAL/)?m.setAttributeNS(szMapNs,"tooltip",this.partsA[q].nCount+" ("+this.formatValue(this.partsA[q].nCount/this.nCount*100,1)+" %)"):this.szFlag.match(/SEQUENCE/)&&m.setAttributeNS(szMapNs,
"tooltip",this.nOrigSumA[q]+" ("+this.formatValue(this.nOrigSumA[q]/this.nSum*100,1)+" %)"):1<this.szFieldsA.length&&!this.szFlag.match(/SEQUENCE/)&&(this.nSum100?m.setAttributeNS(szMapNs,"tooltip",this.formatValue(100/this.nSum100*this.nOrigSumA[A],1)+" %"):this.nSum&&m.setAttributeNS(szMapNs,"tooltip",this.nOrigSumA[A]+" ("+this.formatValue(100/this.nSum*this.nOrigSumA[A],1)+" %)"),m.setAttributeNS(null,"onmouseover","map.Themes.markClass(evt,'"+this.szId+"','"+A+"','"+x+"')"),m.setAttributeNS(null,
"onmouseout","map.Themes.unmarkClass(evt,'"+this.szId+"')"))}this.szLegendStyle.match(/compact/)?E+=e:p+=9*n/10}this.szLegendStyle.match(/compact/)?p+=n*x*2:this.nNoData&&(p+=1.5*n/10,m=map.Dom.newShape("rect",d,0,map.Scale.normalY(p),map.Scale.normalX(e),map.Scale.normalY(f),"fill:"+(this.szNoDataColor?this.szNoDataColor:"#ffffff")+";stroke:#000000;stroke-width:"+map.Scale.normalX(.1)+";"),m.setAttributeNS(szMapNs,"tooltip",this.nNoData+" member(s)"),m.setAttributeNS(null,"onmouseover","map.Themes.markClass(evt,'"+
this.szId+"','"+A+"')"),m.setAttributeNS(null,"onmouseout","map.Themes.unmarkClass(evt,'"+this.szId+"')"),map.Dom.newText(d,map.Scale.normalX(22),map.Scale.normalY(p+h),k,map.Dictionary.getLocalText("no data")),p+=9*n/10);u&&(u.setWidth(-1),u.setHeight(Math.min(p+n,map.Scale.bBox.height/map.Scale.normalY(2.2))),this.nClipColorLegend&&u.setHeight(this.nClipColorLegend),u.reformat(),u.hasScrollBars()&&(d.style.setProperty("display","none",""),map.Dom.newShape("rect",c,0,0,map.Scale.normalX(u.getWidth()),
map.Scale.normalY(u.getHeight()),"fill:none;stroke:none;")));return d};MapTheme.prototype.showInfo=function(){};
MapTheme.prototype.chartButton=function(c,a,d){c=map.Dom.newGroup(c,"chartvari"+String(Math.random()));var b=this.szFlag;"2D"==d&&this.removeDefinitionFromFlag("3D");this.szFlag+="|NORMSIZE|SILENT|MENUSIZE|"+d;this.drawChart(c,null,a);this.szFlag=b;b=map.Dom.getBox(c);this.addChartTypeSign(c,d);d=Math.min(map.Scale.normalX(a)/b.width,map.Scale.normalY(a)/b.height);c.fu.scale(d,d);c.fu.setPosition(map.Scale.normalX(a+10),map.Scale.normalY(a)*d);return c};
MapTheme.prototype.addDefinitionToFlag=function(c){return this.szFlag=this.szFlag+"|"+c};MapTheme.prototype.removeDefinitionFromFlag=function(c){for(var a="",d=this.szFlag.split("|"),b=0;b<d.length;b++)d[b]!=c&&(a+=(a.length?"|":"")+d[b]);return this.szFlag=a};MapTheme.prototype.removeDefinition=function(c,a){for(var d="",b=c.split("|"),f=0;f<b.length;f++)b[f]!=a&&(d+=(d.length?"|":"")+b[f]);return d};
MapTheme.prototype.addChartTypeSign=function(c,a){var d="M0,0 l"+map.Scale.normalX(1.5)+",-"+map.Scale.normalX(1.5)+" 0,"+map.Scale.normalX(3)+" -"+map.Scale.normalX(1.5)+",-"+map.Scale.normalX(1.5)+" M"+map.Scale.normalX(2.5)+",0 l"+map.Scale.normalX(17.5)+",0 M"+map.Scale.normalX(22.5)+",0 l-"+map.Scale.normalX(1.5)+",-"+map.Scale.normalX(1.5)+" 0,"+map.Scale.normalX(3)+" "+map.Scale.normalX(1.5)+",-"+map.Scale.normalX(1.5)+"";if(a.match(/SIZE/)){var b=map.Dom.newGroup(c,"");map.Dom.newShape("path",
b,d,"stroke:white;stroke-width:"+map.Scale.normalX(4)+";stroke-opacity:0.5;stroke-linejoin:miter;stroke-linecap:square;");map.Dom.newShape("path",b,d,"stroke:#666666;stroke-width:"+map.Scale.normalX(1.5)+";stroke-linejoin:miter;stroke-linecap:square;");b.fu.setPosition(-map.Scale.normalX(10),map.Scale.normalX(-5))}a.match(/HEIGHT/)&&(b=map.Dom.newGroup(c,""),map.Dom.newShape("path",b,d,"stroke:white;stroke-width:"+map.Scale.normalX(4)+";stroke-opacity:0.5;stroke-linejoin:miter;stroke-linecap:square;"),
map.Dom.newShape("path",b,d,"stroke:#666666;stroke-width:"+map.Scale.normalX(1.5)+";stroke-linejoin:miter;stroke-linecap:square;"),b.setAttributeNS(null,"transform","translate(0,"+-map.Scale.normalX(25)+") rotate(90)"))};
MapTheme.prototype.getChartTypeMenu=function(c,a,d){if("undefined"==typeof b)var b="CHART|BAR CHART|BAR|3D CHART|BAR|3D|SORT CHART|BAR|HORZ|LEFT|UP CHART|BAR|HORZ|RIGHT|UP CHART|BAR|HORZ|LEFT|UP|COMPRESS CHART|BAR|HORZ|RIGHT|UP|COMPRESS CHART|BAR|HORZ|LEFT|UP|3D CHART|BAR|HORZ|RIGHT|UP|3D CHART|BAR|HORZ|LEFT|UP|COMPRESS|3D CHART|BAR|HORZ|RIGHT|UP|COMPRESS|3D CHART|BAR|HORZ|CENTER|UP CHART|BAR|STACKED CHART|BAR|STACKED|3D CHART|BAR|SORT|3D|COLUMNS|STACKED CHART|BAR|SORT|3D|COLUMNS|STACKED|SIZE CHART|PIE CHART|PIE|SIZE CHART|PIE|3D CHART|PIE|3D|SIZE CHART|PIE|3D|HEIGHT CHART|PIE|3D|VOLUME CHART|PIE|DONUT CHART|PIE|DONUT|SIZE CHART|PIE|DONUT|3D CHART|PIE|DONUT|3D|SIZE CHART|PIE|DONUT|3D|HEIGHT CHART|PIE|DONUT|3D|VOLUME CHART|PIE|STARBURST CHART|PIE|STARBURST|SIZE CHART|PIE|STARBURST|3D CHART|PIE|STARBURST|3D|SIZE CHART|PIE|STARBURST|3D|HEIGHT CHART|PIE|STARBURST|3D|VOLUME CHART|PIE|DONUT|STARBURST CHART|PIE|DONUT|STARBURST|SIZE CHART|PIE|DONUT|STARBURST|3D CHART|PIE|DONUT|STARBURST|3D|SIZE CHART|PIE|DONUT|STARBURST|3D|HEIGHT CHART|PIE|DONUT|STARBURST|3D|VOLUME".split(" ");if("undefined"==
typeof f)var f="CHART|BAR CHART|BAR|VALUES CHART|BAR|3D CHART|BAR|3D|VALUES CHART|BAR|3D|VOLUME CHART|BAR|3D|VOLUME|VALUES CHART|BAR|HORZ|RIGHT|UP CHART|BAR|HORZ|RIGHT|UP|VALUES CHART|BAR|HORZ|RIGHT|UP|3D CHART|BAR|HORZ|RIGHT|UP|VALUES|3D CHART|BAR|POINTER CHART|BAR|POINTER|VALUES CHART|BUBBLE|SURFACE CHART|BUBBLE|SURFACE|VALUES CHART|SQUARE|SURFACE CHART|SQUARE|SURFACE|VALUES".split(" ");if("undefined"==typeof e)var e="CHOROPLETH CHART|BUBBLE CHART|SQUARE CHART|PIE|3D|SIZE CHART|PIE|3D|HEIGHT CHART|PIE|3D|SIZE|HEIGHT CHART|BAR|3D|VOLUME CHART|BAR CHART|BAR|3D CHART|BAR|3D|SIZE CHART|BAR|HORZ|RIGHT|UP CHART|BAR|HORZ|RIGHT|UP|3D CHART|BAR|POINTER CHART|BAR|POINTER|SIZE CHART|BAR|HORZ|RIGHT|UP|POINTER CHART|LABEL".split(" ");
a=this.szOrigFlag;if(1<this.szFieldsA.length||this.szFlag.match(/CATEGORICAL/)&&this.szFlag.match(/AGGREGATE/))e=b;d=d?d/60:3;for(b=0;b<e.length;b++){var f=this.szFlag,l=map.Dom.constructNode("a",c,{});map.Dom.newShape("rect",l,map.Scale.normalX(b%d*60),map.Scale.normalY(60*Math.floor(b/d)),map.Scale.normalX(60),map.Scale.normalY(60),"fill:#f8f8ff;stroke:lightgray;stroke-dasharray:50 50;stroke-width:"+map.Scale.normalX(1)+";");var k=map.Dom.newGroup(l,"szDisplayId:chart:"+String(Math.random()));map.Dom.setClipRect(k,
new box(-map.Scale.normalX(25),-map.Scale.normalX(60),map.Scale.normalX(60),map.Scale.normalX(60)));this.szFlag=e[b]+"|NORMSIZE|SILENT|MENUSIZE";f.match(/CATEGORICAL/)&&(this.szFlag+="|CATEGORICAL");f.match(/GROUP/)&&(this.szFlag+="|GROUP");f.match(/AGGREGATE/)&&(this.szFlag+="|AGGREGATE");f.match(/COMPATIBLE/)&&(this.szFlag+="|COMPATIBLE");f.match(/FAST/)&&(this.szFlag+="|FAST");f.match(/RELOCATE/)&&(this.szFlag+="|RELOCATE");f.match(/DIFFERENCE/)&&(this.szFlag+="|DIFFERENCE");f.match(/FRACTION/)&&
(this.szFlag+="|FRACTION");f.match(/INVERT/)&&(this.szFlag+="|INVERT");f.match(/INVERTSIZE/)&&(this.szFlag+="|INVERTSIZE");f.match(/RELATIVE/)&&(this.szFlag+="|RELATIVE");f.match(/DENSITY/)&&(this.szFlag+="|DENSITY");f.match(/DOPACITYMAX/)?this.szFlag+="|DOPACITYMAX":f.match(/DOPACITYLOGMAX/)?this.szFlag+="|DOPACITYLOGMAX":f.match(/DOPACITYPOWMAX/)?this.szFlag+="|DOPACITYPOWMAX":f.match(/DOPACITYMEAN/)?this.szFlag+="|DOPACITYMEAN":f.match(/DOPACITYLOGMEAN/)?this.szFlag+="|DOPACITYLOGMEAN":f.match(/DOPACITYPOWMEAN/)?
this.szFlag+="|DOPACITYPOWMEAN":f.match(/DOPACITYLOG/)?this.szFlag+="|DOPACITYLOG":f.match(/DOPACITY/)&&(this.szFlag+="|DOPACITY");f.match(/AUTO100/)&&(this.szFlag+="|AUTO100");f.match(/AUTOCOMPLETE/)&&(this.szFlag+="|AUTOCOMPLETE");var n=this.szAggregation,h=this.nClipParts;this.nClipParts=10;var p=this.drawChart(k,null,40);"undefined"===typeof h?delete this.nClipParts:this.nClipParts=h;this.szAggregation=n;if(p){this.szFlag=f;var g=map.Scale.normalX(10);p.x-=map.Scale.normalX(60/d);k.fu.setPosition(g-
p.x+b%d*map.Scale.normalX(60),map.Scale.normalY(40)+g+p.y+Math.floor(b/d)*map.Scale.normalY(60));k.setAttributeNS(null,"clip-path","");g=900/Math.max(k.fu.getBox().width,k.fu.getBox().height);1>g&&k.fu.scale(g,g);g="";a.match(/UNDEFINEDISVALUE/)&&(g+="|UNDEFINEDISVALUE");a.match(/ZEROISVALUE/)&&(g+="|ZEROISVALUE");a.match(/NEGATIVEISVALUE/)&&(g+="|NEGATIVEISVALUE");a.match(/NONEGATIVE/)&&(g+="|NEGATIVEISVALUE");a.match(/GROUP/)&&(g+="|GROUP");a.match(/AGGREGATE/)&&(g+="|AGGREGATE");a.match(/COMPATIBLE/)&&
(g+="|COMPATIBLE");a.match(/FAST/)&&(g+="|FAST");a.match(/\bRECT\b/)&&(g+="|RECT");a.match(/HEX/)&&(g+="|HEX");a.match(/RELOCATE/)&&(g+="|RELOCATE");a.match(/CATEGORICAL/)&&(g+="|CATEGORICAL");a.match(/SUM/)&&(g+="|SUM");a.match(/MEAN/)&&(g+="|MEAN");a.match(/DIFFERENCE/)&&(g+="|DIFFERENCE");a.match(/RELATIVE/)&&(g+="|RELATIVE");a.match(/INVERT/)&&(g+="|INVERT");a.match(/INVERTSIZE/)&&(g+="|INVERTSIZE");a.match(/CALCMEAN/)&&(g+="|CALCMEAN");a.match(/CALC100/)&&(g+="|CALC100");a.match(/PRODUCT/)&&
(g+="|PRODUCT");a.match(/AUTOCOMPLETE/)&&(g+="|AUTOCOMPLETE");a.match(/AUTO100/)&&(g+="|AUTO100");a.match(/QUANTILE/)&&(g+="|QUANTILE");a.match(/DENSITY/)&&(g+="|DENSITY");a.match(/DOPACITY/)&&(g+="|DOPACITY");if(a.match(/VALUES/)||f.match(/VALUES/))g+="|VALUES";a.match(/VALUEBACKGROUND/)&&(g+="|VALUEBACKGROUND");e[b].match(/SIZE/)&&(f.match(/SIZELOG/)?g+="|SIZELOG":f.match(/SIZEP4/)?g+="|SIZEP4":f.match(/SIZEP3/)?g+="|SIZEP3":f.match(/SIZE/)&&(g+="|SIZE"));f.match(/SPACED/)&&(g+="|SPACED");l.setAttributeNS(null,
"onclick","map.Themes.changeThemeStyle(evt,'"+this.szId+"','type:"+e[b]+g+"')");this.addChartTypeSign(k,e[b])}}c=[];for(var u in e)c.push(e[u]+g);return c};MapTheme.prototype.formatValue=function(c,a,d){return isNaN(c)?c:999<this.nMin&&3E3>this.nMax?__formatValue(c,a,d+"|NOBREAKS"):__formatValue(c,a,d)};MapTheme.prototype.remove=function(c){this.parent.removeTheme(c,this.szId)};
MapTheme.prototype.removeElements=function(c){this.widgetNode&&(widgetList.removeWidget(this.widgetNode),this.widgetNode.parentNode.removeChild(this.widgetNode),this.widgetNode=null);this.clipTimeout&&clearTimeout(this.clipTimeout);this.unpaintMap();if(this.onremove)try{eval(this.onremove)}catch(a){}try{HTMLWindow.ixmaps.htmlgui_onRemoveTheme(this.szId)}catch(d){}};
MapTheme.prototype.removeMapThemeStyles=function(c){c=c.split("|");for(var a=SVGRootElement.getElementsByTagName("path"),d=0;d<a.length;d++)if(1==a.item(d).nodeType){var b=a.item(d).parentNode.getAttributeNS(null,"id"),f=!1;if(b&&0!==b.length)for(var b=map.Tiles.getMasterId(b).split(":")[0],e=0;e<c.length;e++)b==c[e]&&(f=!0);f&&a.item(d).parentNode.removeAttributeNS(null,"style")}};
MapTheme.prototype.disable=function(){if(!this.szFlag.match(/CHART/)&&this.widgetNode)for(var c=this.widgetNode.getElementsByTagName("g"),a=0;a<c.length;a++)c.item(a).setAttributeNS(null,"opacity","0.9")};MapTheme.prototype.enable=function(){if(this.widgetNode){for(var c=this.widgetNode.getElementsByTagName("g"),a=0;a<c.length;a++)c.item(a).setAttributeNS(null,"opacity","1.0");this.widgetNode.parentNode.appendChild(this.widgetNode)}map.Themes.setActive(this)};
MapTheme.prototype.makeVisible=function(){for(var c=0;c<this.szThemesA.length;c++)map.Layer.isLayerOn(this.szThemesA[c])||map.Layer.isScaleDependentLayer(this.szThemesA[c])||(map.Themes.switchedLayerA[this.szThemesA[c]]=!0,map.Api.switchMapTheme(this.szThemesA[c],"on")),map.Tiles.switchScaleDependentTiles()};
MapTheme.prototype.checkVisible=function(){for(var c=0;c<this.szThemesA.length;c++)map.Themes.isThemeLayerUsed(this.szThemesA[c])&&this.isVisible||!map.Themes.switchedLayerA[this.szThemesA[c]]||(map.Api.switchMapTheme(this.szThemesA[c],"off"),map.Themes.switchedLayerA[this.szThemesA[c]]=null)};
MapTheme.prototype.resize=function(c){999!=c&&(this.nScale*=c);if(this.szFlag.match(/BUFFER/)&&this.szShapeType.match(/line/))this.fRedrawInfo=this.fRedraw=!0,this.nSkipCount=1,map.Themes.execute();else{map.Layer.changeObjectScaling(null,c,this.chartGroup);this.szFlag.match(/DECLUTTER/)&&this.declutterCharts();if(this.szFlag.match(/BUFFER/))for(var a=this.chartGroup.getElementsByTagName("circle"),d=0;d<a.length;d++){var b=a.item(d).getAttributeNS(null,"style");b&&b.length&&(b=__scaleStyleString(b,
1/c),a.item(d).setAttributeNS(null,"style",b))}this.f=!0;this.showInfo()}};MapTheme.prototype.offset=function(c){var a=this.chartGroup.fu.getPosition();this.chartGroup.fu.setPosition(a.x+c.x,a.y+c.y)};
MapTheme.prototype.opacity=function(c){this.fillOpacity=(this.fillOpacity?this.fillOpacity:1)*c;this.fillOpacity=Math.min(1,this.fillOpacity);this.fillOpacity=Math.max(0,this.fillOpacity);this.nOpacity=(this.nOpacity?this.nOpacity:1)*c;this.nOpacity=Math.min(1,this.nOpacity);this.nOpacity=Math.max(0,this.nOpacity);if(this.chartGroup)for(var a=this.chartGroup.childNodes,d=0;d<a.length;d++)map.Layer.changeNodeOpacity(a.item(d),c);else if(this.szShapeType.match(/line/))for(d=0;d<this.szThemesA.length;d++)map.Layer.changeLayerOpacity(this.szThemesA[d],
c);else for(a in this.itemA)for(var d=this.getItemNodes(a),b=0;b<d.length;b++)map.Layer.changeNodeOpacity(d[b],c,"fill-opacity")};
MapTheme.prototype.blur=function(c){if(this.chartGroup)if(this.nBlur){var a="blur-3",d=SVGDocument.getElementById(a);d?d.firstChild.setAttributeNS(null,"stdDeviation",map.Scale.normalX(c)):(d=map.Dom.newNode("filter",this.chartGroup.parentNode),d.setAttributeNS(null,"id",a),d=map.Dom.newNode("feGaussianBlur",d),d.setAttributeNS(null,"stdDeviation",map.Scale.normalX(c)));this.chartGroup.style.setProperty("filter","url(#"+a+")","")}else this.chartGroup.style.removeProperty("filter");else if(this.szThemesA[0]){var b=
SVGDocument.getElementById("maplayer");b&&(this.nBlur?(a="blur-map",(d=SVGDocument.getElementById(a))?d.firstChild.setAttributeNS(null,"stdDeviation",map.Scale.normalX(c)/map.Zoom.nZoom):(d=map.Dom.newNode("filter",b.parentNode),d.setAttributeNS(null,"id",a),d.setAttributeNS(null,"x",0),d.setAttributeNS(null,"y",0),d.setAttributeNS(null,"width","100%"),d.setAttributeNS(null,"height","100%"),d=map.Dom.newNode("feGaussianBlur",d),d.setAttributeNS(null,"stdDeviation",map.Scale.normalX(c)/map.Zoom.nZoom)),
b.style.setProperty("filter","url(#"+a+")","")):b.style.removeProperty("filter"))}};
MapTheme.prototype.toggle=function(c){this.chartGroup?!0===c||"undefined"==typeof c&&"none"==this.chartGroup.style.getPropertyValue("display")?(this.chartGroup.style.setProperty("display","inline",""),this.chartGroup.display="inline"):(this.chartGroup.style.setProperty("display","none",""),this.chartGroup.display="none"):this.isChecked?(this.unpaintMap(),this.isChecked=!1,map.Themes.activateNextPaint(this)&&(this.fToggle=!1,map.Themes.execute(),this.widgetNode&&(this.widgetNode.setAttributeNS(null,
"opacity","1.0"),this.widgetNode.parentNode.appendChild(this.widgetNode)))):(this.fRedraw=this.isChecked=!0,this.fToggle=!1,map.Themes.execute())};MapTheme.prototype.getHistogram=function(c,a,d){map.Themes.getHistogram(c,a,d,this)};var __maptheme_chartcolors=[];function __maptheme_getChartColors(c){__maptheme_chartcolors[c]||(__maptheme_chartcolors[c]=new ChartColors(c));return __maptheme_chartcolors[c]}
function ChartColors(c){"string"!=typeof c&&(c="#ffffff");this.mainColor=c;this.lowColor=ColorScheme.getDerivateColor(c,.7);this.highColor=ColorScheme.getDerivateColor(c,1.3);this.borderColor=ColorScheme.getBorderColor(c);this.textColor=ColorScheme.getTextColor(c)}function __mpap_hex2dec(c){return parseInt(c,16)}
function __mpap_decode_utf8(c){if("string"==typeof c&&c.match(/&#x/)){var a="";c=c.split("&#x");for(var a=c[0],d=1;d<c.length;d++)a+=String.fromCharCode(__mpap_hex2dec(c[d].substr(0,2))),a+=c[d].substr(3,c[d].length-3);return a}return c};
