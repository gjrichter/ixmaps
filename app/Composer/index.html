<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <meta name="description" content="" />
    <meta name="author" content="" />
    <title>Data-Krauti</title>
    <!-- Favicon-->
    <link rel="icon" type="image/x-icon" href="https://gjrichter.github.io/ixmaps/ui/resources/images/ixmaps_logo.png" />

    <!-- Bootstrap icons-->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.5.0/font/bootstrap-icons.css" rel="stylesheet" />
    <!-- Core theme CSS (includes Bootstrap)-->
    <link href="css/styles.css" rel="stylesheet" />

    <link href="css/messagebox.css" rel="stylesheet" />

    <style>
        th {
            position: sticky;
            background-color: white;
            z-index: 2;
            top: 0;
            padding: 0.2em 0;
        }

        tr {
            xxborder: solid #dddddd 1px;
        }

        .td_yellow {
            background: rgba(255, 255, 0, 0.1);
        }

        .td_red {
            background: rgba(255, 0, 0, 0.1);
        }

        .td_blue {
            background: rgba(0, 0, 255, 0.05);
        }

        .td_green {
            background: rgba(0, 255, 0, 0.05);
        }

        .td_right {
            text-align: end;
        }

        .even {
            background: #EDF2FA;
            background: #ffffff;
            background: #F4F5F6;
        }

        a {
            text-decoration: none;
        }

        .wrapword {
            white-space: -moz-pre-wrap !important;
            /* Mozilla, since 1999 */
            white-space: -pre-wrap;
            /* Opera 4-6 */
            white-space: -o-pre-wrap;
            /* Opera 7 */
            white-space: pre-wrap;
            /* css-3 */
            word-wrap: break-word;
            /* Internet Explorer 5.5+ */
            white-space: -webkit-pre-wrap;
            /* Newer versions of Chrome/Safari*/
            word-break: break-all;
            white-space: normal;
        }

    </style>

    <style>
        #tooltip {
            font-family: arial, system;
            font-size: 14px;
            background: white;
            border: 0.5px solid black;
            border-radius: 5px;
            padding: 0.5em 1em 0.5em 1em;
            max-width: 300px;
            box-shadow: 1px 1px 9px rgba(0, 0, 0, .275);
        }

        #tooltip p {
            font-size: 14px;
        }

        #tooltip table {
            font-size: 14px;
        }

    </style>

    <style>
        /* Table styles */
.data-table {
    border-collapse: collapse;
    width: 100%;
}

.data-table th,
.data-table td {
    border: 1px solid #dddddd;
    text-align: left;
    padding: 8px;
}

.data-table th {
    background-color: #f2f2f2;
}

.data-table tr.even {
    background-color: #f9f9f9;
}

/* Card styles */
.card-container {
    display: flex;
    flex-wrap: wrap;
    gap: 1em;
}

.card {
    border: 1px solid #ddd;
    border-radius: 4px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    padding: 1em;
    flex-basis: calc(33.33% - 1em); /* Adjust as needed */
    background-color: white;
}
.card-item{
  display: flex;
  align-items: center;
  margin:0.5em 0;
}
.card-header{
   font-weight: bold;
   margin-right: 1em;
}
.card-value {
  
}

/* sort styles */
.sort-icon {
    font-size: 0.8em;
    margin: 0 0.2em;
    display:inline-block;
}
.sort-icon:hover{
    color: #0d6efd;
}

    </style>
 

</head>

<body>
    <!-- Navigation-->
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
        <div class="container px-4 px-lg-5">
            <a class="navbar-brand" href="#!"><img src="img/cabbage.png" style="height:36px;vertical-align:-32%;margin-right:1.2em"><span style="font-size:0.9em;vertical-align:2px">DATA-KRAUTI</span> </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button>
            <div class="collapse navbar-collapse" id="navbarSupportedContent">
                <ul class="navbar-nav me-auto mb-2 mb-lg-0 ">
                    <li class="nav-item"><a class="nav-link" href="https://gjrichter.github.io/docs/Data-Krauti/docs/" target="blank">About <i class='bi-info-circle me-1'></i></a></li>
                </ul>
                <ul class="navbar-nav right" style="margin-right:1.2em">
                    <li class="nav-item"><a class="nav-link" href="javascript:void()" onclick="__projectShareDialog()">Share <i class='bi-box-arrow-up me-1'></i></a></li>
                </ul>
                <button class="btn btn-outline-dark" onclick="__dataLoadDialog()">
                    add data
                    <span id="nData" class="badge bg-dark text-white ms-1 rounded-pill">0</span>
                </button>
            </div>
        </div>
    </nav>

    <div id="load-param-spinner" style="display:none">
        <center>
            <img src="./resources/images/loading_blue.gif" style="height:64px;margin:-0.4em 0 0 -2em;"> loading data ...
        </center>
    </div>


    <!-- data tables section-->
    <section>
        <div class="container px-4 px-lg-5 mt-5">
            <div id="Input-table"></div>
        </div>
    </section>

    <!-- footer section-->
    <section style="position:relative;bottom:10px;display:block;width:100%">
        <div class="container px-4 px-lg-5 mt-5">
            <div id="load-data-button" class="text-left" style="margin:3em 0;display:none;">
                <a class="btn btn-outline-dark mt-auto" href="javascript:__dataLoadDialog()">add data</a>
            </div>
        </div>
        <div class="container px-4 px-lg-5 mt-5" style="font-size:14px;color:#888888;text-align:center">
            <p>View and explorev data with tables and on a map - Version: <span style="font-size:0.8em">0.92</span></p>
        </div>
    </section>

    <!-- div to host dialog overlays -->
    <div id="composer-dialog-pos" class="container" style="position:absolute;top:100px;left:0px;width:100%;display:none;z-index:9999;background-color:rgba(255,255,255,0.7)">
        <div id="composer-dialog" style="display:none;">
        </div>
    </div>

    <!-- div to host dialog overlays -->
    <div id="tooltip" style="position: absolute; display: none;z-index:9999"></div>
    <div id="tooltips" style="display: none;"></div>

    <!-- Bootstrap core JS-->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- JQuery core JS-->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>


    <!-- Core theme JS-->
    <script src="js/scripts.js"></script>
    <script src="js/format.js"></script>
    <script src="js/facets.js"></script>

    <script src="libs/messagebox.js"></script>

    <script src="../../ui/js/htmlgui_api.js"></script>
    <script src="../../../data.js/data.js"></script>

    <!-- must load papaparse here, elsewise .import non funziona -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/4.1.2/papaparse.min.js"></script>
    <script src="https://unpkg.com/topojson-client@3.1.0/dist/topojson-client.min.js"></script>

    <script type="text/javascript" charset="utf-8">
    </script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/default.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>

    <script src="./js/json_config.js"></script>
    <script src="./js/json_config_html.js"></script>

    <script src="./js/dataprocess.js"></script>
    <script src="./js/format.js"></script>
    <script src="./js/facets.js"></script>

    <script type="text/javascript" charset="utf-8">
        // ----------------------------------------------------------
        // ----------------------------------------------------------
        //
        // d a t a   h a n d l i n g   
        //
        // ----------------------------------------------------------
        // ----------------------------------------------------------

        /**
         * Namespace for the ixmaps application.
         * @namespace ixmaps
         */
        ixmaps = ixmaps || {};

        /**
         * Namespace for data handling within the ixmaps application.
         * @namespace ixmaps.data
         */
        ixmaps.data = ixmaps.data || {};

        /**
         * @namespace ixmaps.editor
         * @description This namespace represents the ixmaps editor.
         */
        ixmaps.editor = ixmaps.editor || {};

        /**
         * Counter for the number of data objects.
         * @type {number}
         */
        var nData = 0;

        /**
         * Object to store data objects.
         * @type {Object}
         */
        const dataA = {};



        // -------------------------------------
        //
        // handle the data (add, remove, ...) 
        //
        // -------------------------------------

        /**
         * Adds data to the composer.
         *
         * @param {object} data - The data to be added.  Expected to be in a format that `Data.import` can handle (e.g., JSON).
         * @returns {string} dataName - the generated unique data name to reference the data later
         * @private
         */
        const __addData = (data) => {

            // Constants for reusability and maintainability
            const BUTTON_CLASSES = 'btn btn-outline-dark mt-auto';
            const DEFAULT_TABLE_HEIGHT = '400px';
            const DEFAULT_MIN_HEIGHT = '0px';

            // Import and validate data
            const importedData = Data.import({
                source: data,
                type: 'jsonDB'
            });

            if (!importedData) {
                console.error('Failed to import data');
                return;
            }

            // Generate unique ID using a more reliable method
            const dataName = `data_${Date.now()}_${Math.floor(Math.random() * 1000)}`;

            // Store data with proper type checking

            let sink = new DataSink(importedData);
            sink.url = ixmaps.editor.dbtableUrl || '';
            sink.type = ixmaps.editor.dbtableType || 'default';
            dataA[dataName] = sink;

            // Update data counter with safety check
            const dataCounter = document.getElementById('nData');
            if (dataCounter) {
                nData = (nData || 0) + 1;
                dataCounter.textContent = nData;
            }

            // Helper function to create buttons
            const createButton = (id, onClick, icon, text, additionalStyle = '') => {
                return `
                    <a id="input-table-header-${dataName}-${id}" 
                       class="${BUTTON_CLASSES}" 
                       href="javascript:${onClick}('${dataName}')"
                       style="${additionalStyle}">
                       ${icon ? `<i class="bi-${icon} me-1"></i>` : ''}${text}
                    </a>`;
            };

            // Create header with buttons
            const headerButtons = [{
                    id: 'facets',
                    onClick: '__dataFacets',
                    icon: 'funnel',
                    text: 'facets'
                },
                {
                    id: 'analytics',
                    onClick: '__dataAnalytics',
                    icon: '',
                    text: 'analyze'
                },
                {
                    id: 'filter',
                    onClick: '__dataFilter',
                    icon: '',
                    text: 'filter'
                },
                {
                    id: 'process',
                    onClick: '__dataProcess',
                    icon: '',
                    text: 'process'
                },
                {
                    id: 'map',
                    onClick: '__dataToMap',
                    icon: 'map',
                    text: 'map'
                },
                {
                    id: 'theme',
                    onClick: '__mapTheme',
                    icon: 'layout-text-sidebar',
                    text: 'config. map',
                    style: 'display:none'
                },
                {
                    id: 'theme-edit',
                    onClick: '__mapThemeEdit',
                    icon: 'pencil',
                    text: 'edit theme',
                    style: 'display:none'
                },
                {
                    id: 'remove-map',
                    onClick: '__removeMap',
                    icon: 'x-circle',
                    text: 'remove map',
                    style: 'display:none'
                },
                {
                    id: 'map-inline',
                    onClick: 'fullscreen',
                    icon: 'arrows-angle-contract',
                    text: 'inline map',
                    style: 'display:none'
                },
                {
                    id: 'remove',
                    onClick: '__removeData',
                    icon: 'x-circle',
                    text: 'remove',
                    style: 'float:right;margin-left:0.3em'
                },
                {
                    id: 'toggle-map',
                    onClick: '__hideMap',
                    icon: 'eye',
                    text: 'map',
                    style: 'display:none;float:right;margin-left:0.3em'
                },
                {
                    id: 'toggle-data',
                    onClick: '__hideData',
                    icon: 'eye',
                    text: 'data',
                    style: 'display:none;float:right'
                }
            ];

            const header = `
                <div id="input-table-header-${dataName}" style="margin-bottom:0.5em;">
                    ${headerButtons.map(btn => createButton(btn.id, btn.onClick, btn.icon, btn.text, btn.style)).join('\n')}
                </div>
            `;

            // Create workspace structure
            const workspace = `
                <div id="input-table-frame-${dataName}" style="width:100%;">
                    <div id="input-table-sidebar-${dataName}" style="width:0%;height:100%;overflow:hidden;float:left;"></div>
                    <div id="input-table-workspace-${dataName}" style="width:100%;display:inline-block">
                        <div id="input-table-table-${dataName}" 
                             style="resize:vertical;min-height:${DEFAULT_MIN_HEIGHT};height:${DEFAULT_TABLE_HEIGHT};overflow:auto" onscroll="__onScroll(event,'${dataName}')">
                            ${__makeDataTable(importedData, dataName, 450)}
                        </div>
                        <p id="input-table-info-${dataName}">
                            records: ${dataA[dataName].data.table.records} <a href="javascript:saveAsCSV('${dataName}')">export</a> <a class="${BUTTON_CLASSES}" style="float:right;padding:0.2em 0.5em;border:none" href="javascript:__toggleCards('${dataName}')">table <i class="bi-arrow-left-right me-1"></i> cards</a>
                        </p>
                        <div id="input-table-map-${dataName}" style="width:100%"></div>
                    </div>
                </div>
            `;

            // Combine all elements
            const container = `
                <div id="input-table-${dataName}" style="margin-bottom:3em;clear:both">
                    ${header}
                    ${workspace}
                </div>
            `;

            // Append to DOM safely
            $('#Input-table').append(container);

            $("#load-data-button").show();

            // Return the dataName for potential future reference
            return dataName;
        };

        /**
         * Removes data from the composer.
         * @param {string} dataName - The unique data name.
         * @private
         */
        __removeData = function(dataName) {

            __confirm("do you really want to remove this data?", () => {

                if ($("#input-table-header-" + dataName + "-theme").hasClass("active")) {
                    $(".colpick").remove();
                }

                if (dataA[dataName].map) {
                    delete ixmaps.embeddedApiA[dataName];
                }

                $("#" + "input-table-" + dataName).remove();
                $("#" + "input-table-footer-" + dataName).remove();
                $("#" + "input-table-header-" + dataName).remove();

                delete dataA[dataName].data;
                dataA[dataName] = null;

                $("#nData").html(--nData);

                return;
            });
        };


        // ----------------------------------------------------------
        // ----------------------------------------------------------
        // t o o l s  
        // ----------------------------------------------------------
        // ----------------------------------------------------------

        /**
         * Opens the facets sidebar for the given data.
         * @param {string} dataName - The unique name of the data for which to display facets.
         * @private
         */
        __dataFacets = function(dataName) {

            if ($("#input-table-header-" + dataName + "-facets").hasClass("active")) {
                $("#input-table-sidebar-" + dataName).html("");
                $("#input-table-sidebar-" + dataName).css("width", "0%");
                $("#input-table-workspace-" + dataName).css("width", "100%");
                $("#input-table-header-" + dataName + "-facets").removeClass("active");
                return;
            }

            $("#input-table-header-" + dataName + "-process").removeClass("active");
            $("#input-table-header-" + dataName + "-theme").removeClass("active");
            $("#input-table-header-" + dataName + "-theme-edit").removeClass("active");
            $("#input-table-header-" + dataName + "-facets").addClass("active");

            $("#input-table-sidebar-" + dataName).css("width", "30%");
            $("#input-table-workspace-" + dataName).css("width", "70%");

            $("#input-table-sidebar-" + dataName).height($("#input-table-workspace-" + dataName).height() - 20);

            ixmaps.data = ixmaps.data || {};
            ixmaps.data.fShowFacetValues = true;
            ixmaps.data.facetsObj = dataA[dataName].data;
            ixmaps.data.facetsDataName = dataName;
            ixmaps.data.facetsFilter = dataA[dataName].facetsFilter;
            ixmaps.data.facetsCallback = __dataFacetsSetFilter;

            $("#input-table-sidebar-" + dataName).css("overflow", "hidden");
            __openSidebar(dataName, './theme_facets.html');

        };

        /**
         * Sets the filter for the given data.
         * Given as callback when opening the facet tool in the sidebar (see above)
         * Updates the data table and map
         * @param {string} dataName - The unique data name.
         * @param {string} sFilter - The filter string.
         * @private
         */
        __dataFacetsSetFilter = function(dataName, sFilter) {

            const dataObj = dataA[dataName];
            const $table = $("#input-table-table-" + dataName);
            const $tableInfo = $("#input-table-info-" + dataName);

            if (!dataObj || !dataObj.data) {
                console.warn(`No data found for dataName: ${dataName}`);
                return;
            }

            let selectedData = dataObj.data;

            if (sFilter && sFilter.length) {
                selectedData = dataObj.data.select(sFilter);
                dataObj.facetsFilter = sFilter;
            } else {
                dataObj.facetsFilter = "";
            }

            ixmaps.data.facetsObj = selectedData;
            ixmaps.data.facetsFilter = dataObj.facetsFilter;

            const height = $table.height();
            const offset = $table.children(":first").scrollLeft();

            // redraw table with filtered data
            $table.html(__makeDataTable(selectedData, dataName, height));
            $table.children(":first").scrollLeft(offset);

            // update table info below table
            const totalRecords = dataObj.data.table.records;
            const selectedRecords = selectedData.table.records;
            if (dataObj.facetsFilter && dataObj.facetsFilter.length) {
                $tableInfo.html(`records: <b>${selectedRecords}</b> (${totalRecords}) <a href='javascript:saveAsCSV("${dataName}")'>export</a>`);
            } else {
                $tableInfo.html(`records: ${selectedRecords} <a href='javascript:saveAsCSV("${dataName}")'>export</a>`);
            }
            // redraw facets in sidebar
            var facetsA = ixmaps.data.getFacets(selectedData, sFilter);
            try {
                ixmaps.data.showFacets(sFilter, "facetDiv-" + dataName, facetsA, selectedData, dataName);
            } catch (e) {
                console.error("Error in showFacets:", e);
            }
            // update map if present
            if (dataObj.map) {
                if (sFilter && sFilter.length) {
                    dataObj.map.changeThemeStyle(dataName, "filter:" + sFilter, "set");
                } else {
                    dataObj.map.changeThemeStyle(dataName, "filter", "remove");
                }
            }
        };

        /**
        * helper function to update the table view
        * @param {string} dataName - The name of the data to filter.
        * @param {object} data - The data to display.
        * @private
        */
        function __setActiveHeaderButton(dataName, buttonName) {
            // Deactivate other buttons
            $(`#input-table-header-${dataName}-facets`).removeClass("active");
            $(`#input-table-header-${dataName}-process`).removeClass("active");
            $(`#input-table-header-${dataName}-theme`).removeClass("active");
            $(`#input-table-header-${dataName}-theme-edit`).removeClass("active");

            // Activate theme sidebar
            $(`#input-table-header-${dataName}-${buttonName}`).addClass("active");
        };
        
        /**
        * helper function to update the table view
        * @param {string} dataName - The name of the data to filter.
        * @param {object} data - The data to display.
        * @private
        */
        function __updateDataTable(dataName, data) {
            const $table = $(`#input-table-table-${dataName}`);
            const height = $table.height();
            const offset = $table.children(":first").scrollLeft();
            $table.html(__makeDataTable(data, dataName, height));
            $table.children(":first").scrollLeft(offset);
        };

       /**
         * Sorts the data in the table based on the given column and direction.
         *
         * @param {string} dataName - The name of the data to sort.
         * @param {string} szColumn - The column to sort by.
         * @param {string} [szDir] - The sort direction ("UP" or "DOWN"). If not provided, toggles the current direction.
         * @function __dataSort
         * @private
         */
         __dataSort = function (dataName, szColumn, szDir) {
            const dataObj = dataA[dataName];
            if (!dataObj || !dataObj.data) {
                console.warn(`No data found for dataName: ${dataName}`);
                return;
            }

            let data = dataObj.data;

            // Apply Facet Filter if exists and not a pivot table
            if (dataObj.facetsFilter && !dataObj.fPivot) {
                data = data.select(dataObj.facetsFilter);
            }

            // Determine Sort Direction
            const currentSortDir = dataObj.sortDir;
            szDir = szDir || (currentSortDir ? (currentSortDir.includes("DOWN") ? "UP" : "DOWN") : "UP");

            // Sort Data
            data.sort(szColumn, szDir);

            // Update Sort Direction in Data Object
            dataObj.sortDir = `${szColumn}-${szDir}`;

            // Update Table
            __updateDataTable(dataName, data);
        };

        /**
         * Shows/hides the filter inputs for each column in the data table.
         *
         * @param {string} dataName - The name of the data to filter.
         * @function __dataFilter
         * @private
         */
        __dataFilter = function (dataName) {
            const dataObj = dataA[dataName];
            if (!dataObj || !dataObj.data) {
                console.warn(`No data found for dataName: ${dataName}`);
                return;
            }
            
            const headerButton = $(`#input-table-header-${dataName}-filter`);
            dataObj.fShowFilter = !headerButton.hasClass("active");
            headerButton.toggleClass("active", dataObj.fShowFilter);

            if (dataObj.fShowFilter) {
                dataObj.filterA = dataObj.filterA || {};

                if (dataObj.facetsFilter) {
                    // get filter parts
                    // ----------------
                    const filterParts = dataObj.facetsFilter.split('WHERE ')[1]?.split('AND') || [];
                    const refinedFilterParts = [];
                    for (let i = 0; i < filterParts.length; i++) {
                        if (filterParts[i].match(/BETWEEN/)) {
                            refinedFilterParts.push(filterParts[i] + "AND" + filterParts[i + 1]);
                            i++; // Skip the next element since it's already included.
                        } else {
                            refinedFilterParts.push(filterParts[i]);
                        }
                    }

                    dataObj.filterA = {};
                    refinedFilterParts.forEach(part => {
                        const [key, , value] = part.trim().split(/\s+/);
                        dataObj.filterA[key.replace(/"/g, "")] = value.replace(/"/g, "");
                    });
                    
                    ixmaps.data.facetsObj = dataObj.data.select(dataObj.facetsFilter);
                }
             }
             __updateDataTable(dataName, ixmaps.data.facetsObj||dataObj.data);
        };
        
        /**
         * Applies a filter to the data based on keyup events in the filter input fields.
         *
         * @param {string} dataName - The name of the data to filter.
         * @param {string} szColumn - The column to filter.
         * @param {string} szSelect - The filter string entered by the user.
         * @param {Event} event - The keyup event.
         * @function __dataKeyupSelect
         * @private
         */
        __dataKeyupSelect = function (dataName, szColumn, szSelect, event) {
            if (!["ArrowLeft", "ArrowRight", "Enter"].includes(event.key)) return;
            if (event.key !== "Enter") return;

            const dataObj = dataA[dataName];
            if (!dataObj || !dataObj.data) {
                console.warn("No data found for dataName: "+dataName);
                return;
            }

            let data = dataObj.data;
            dataObj.filterA = dataObj.filterA || {};
            delete dataObj.filterA[szColumn];

            if (szSelect && szSelect.length) {
                dataObj.filterA[szColumn] = szSelect;
            }

            let filterParts = [];
            for (const column in dataObj.filterA) {
                let filterValue = dataObj.filterA[column];
                 if (!filterValue || (filterValue[0].match(/[<>]/) && filterValue.length < 2)) {
                    continue;
                }
                const operator = filterValue[0].match(/[<>]/) ? filterValue[0] : "like";
                const value = filterValue.startsWith("<") || filterValue.startsWith(">")
                 ? (filterValue.startsWith("< ") || filterValue.startsWith("> ") ? filterValue.slice(1).trim() : filterValue.slice(1)) 
                : (filterValue.match(/BETWEEN/) ? filterValue : `"${filterValue}"`);

                let filterPart;
                if (operator === "like") {
                    filterPart = `"${column}" ${operator} ${value}`;
                } else {
                    filterPart = `"${column}" ${operator} ${value}`;
                }
                filterParts.push(filterPart);
            }

            const newFilter = filterParts.length ? `WHERE ${filterParts.join(" AND ")}` : "";
            if (newFilter) {
              data = data.select(newFilter);
            }
            if (dataObj.map) {
                dataObj.map.changeThemeStyle(null, newFilter ? `filter:${newFilter}` : "filter", newFilter ? "set" : "remove");
            }

            dataObj.facetsFilter = newFilter;

            __updateDataTable(dataName, data);
           
            const $info = $(`#input-table-info-${dataName}`);
            const totalRecords = dataObj.data.table.records;
            if(newFilter){
                $info.html(`records: <b>${data.table.records}</b> / ${totalRecords} +<small><i class='bi-funnel me-1'></i>${newFilter}</small>  <a href='javascript:saveAsCSV("${dataName}")'>export</a>`);
            } else{
                 $info.html(`records: ${data.table.records} <a href='javascript:saveAsCSV("${dataName}")'>export</a>`);
            }

            const szSafeId = (`input-table-table-${dataName}-filter-${szColumn}`).replace(/ |\W/g, "_");
            const $input = $(`#${szSafeId}`);
            const len = $input.val().length;
            $input.focus().prop('selectionStart', len).prop('selectionEnd', len);
        };

        /**
         * Toggles analytics display for the data.
         * @function __dataAnalytics
         * @param {string} dataName - The name of the data.
         * @private
         */
        __dataAnalytics = function (dataName) {
           const dataObj = dataA[dataName];
            if (!dataObj || !dataObj.data) {
                console.warn(`No data found for dataName: ${dataName}`);
                return;
            }
            const headerButton = $(`#input-table-header-${dataName}-analytics`);
            dataObj.fShowAnalytics = !headerButton.hasClass("active");
            headerButton.toggleClass("active", dataObj.fShowAnalytics);

            let data = dataObj.data;
            if (dataObj.facetsFilter) {
              //data = data.select(dataObj.facetsFilter);
            }

            __updateDataTable(dataName, data);
        };

        /**
         * Processes data to make a pivot table.
         * @function __dataProcessMakePivot
         * @param {string} dataName - The name of the data.
         * @param {object} pivotJson - The pivot configuration in JSON format.
         * @private
         */
        __dataProcessMakePivot = function (dataName, pivotJson) {
            const dataObj = dataA[dataName];
            if (!dataObj || !dataObj.data) {
                console.warn(`No data found for dataName: ${dataName}`);
                return;
            }
            dataObj.data = dataObj.origdata || dataObj.data;
            let data = dataObj.data;
            dataObj.fPivot = null;

            const pivotButton = $(`#input-table-header-${dataName}-pivot`);

            if (pivotButton.hasClass("active")) {
                 dataObj.origdata = dataObj.data;
                if (dataObj.facetsFilter) {
                    data = data.select(dataObj.facetsFilter);
                 }

                data = data.pivot(pivotJson);

                dataObj.data = data;
                dataObj.fPivot = true;
                dataObj.pivot = pivotJson;
            }
            __updateDataTable(dataName, data);

            $(`#input-table-info-${dataName}`).html(`records: ${data.table.records} (${dataObj.data.table.records}) <a href='javascript:saveAsCSV("${dataName}")'>export</a>`);
        };

        /**
         * Processes data to condense it.
         * @function __dataProcessMakeCondense
         * @param {string} dataName - The name of the data.
         * @param {object} pivotJson - The pivot configuration in JSON format.  Seems misnamed, should likely be condenseJson.
         * @private
         */
        __dataProcessMakeCondense = function (dataName, condenseJson) {
            const dataObj = dataA[dataName];
            if (!dataObj || !dataObj.data) {
                console.warn(`No data found for dataName: ${dataName}`);
                return;
            }
            dataObj.data = dataObj.origdata || dataObj.data;
            let data = dataObj.data;

            const condenseButton = $(`#input-table-header-${dataName}-condense`);

            if (condenseButton.hasClass("active")) {
                dataObj.origdata = dataObj.data;

                data = data.condense(condenseJson);
                dataObj.data = data;

                if (dataObj.facetsFilter) {
                    data = data.select(dataObj.facetsFilter);
                }
            }
          __updateDataTable(dataName, data);
        };

        /**
         * Opens the data processing sidebar.
         * @function __dataProcess
         * @param {string} dataName - The name of the data.
         * @private
         */
         __dataProcess = function (dataName) {
            const $headerButton = $(`#input-table-header-${dataName}-process`);
            const $sidebar = $(`#input-table-sidebar-${dataName}`);
            const $workspace = $(`#input-table-workspace-${dataName}`);

            const isActive = $headerButton.hasClass("active");

            // Toggle Sidebar and Workspace Visibility
            if (isActive) {
                $sidebar.html("").css("width", "0%");
                $workspace.css("width", "100%");
                $headerButton.removeClass("active");
                return;
            }

            // Activate current sidebar
            __setActiveHeaderButton(dataName,"process");

            // Set Sidebar and Workspace Width
            $sidebar.css("width", "30%");
            $workspace.css("width", "70%");

            // Set Sidebar Height
            $sidebar.height($workspace.height() - 20);

            // Setup Data for Sidebar
            ixmaps.data = ixmaps.data || {};
            ixmaps.data.processObj = dataA[dataName].data;
            ixmaps.data.processDataName = dataName;

            // Open the Sidebar
            $sidebar.css("overflow", "hidden");
            __openSidebar(dataName, './data_process.html');
        };

        /**
         * Opens the map theme configuration sidebar.
         * @function __mapTheme
         * @param {string} dataName - The name of the data.
         * @private
         */
         let act_dataName = null;
        __mapTheme = function (dataName) {
            const $activeSidebar = act_dataName ? $(`#input-table-sidebar-${act_dataName}`) : null;
            const $activeWorkspace = act_dataName ? $(`#input-table-workspace-${act_dataName}`) : null;
            const $activeHeader = act_dataName ? $(`#input-table-header-${act_dataName}-theme`) : null;

            // If another theme is active, close it
            if (act_dataName) {
                $activeSidebar.html("").css("width", "0%");
                $activeWorkspace.css("width", "100%");
                $activeHeader.removeClass("active");

                // Remove color picker elements
                $(".colpick").remove();

                ixmaps.editor = {};

                // If the same theme is clicked again, close and reset
                if (dataName === act_dataName) {
                    act_dataName = null;
                    return;
                }
            }

            // Set current theme as active
            act_dataName = dataName;

            // Activate current sidebar
            __setActiveHeaderButton(dataName,"theme");

            // Set sidebar and workspace dimensions
            const $sidebar = $(`#input-table-sidebar-${dataName}`);
            const $workspace = $(`#input-table-workspace-${dataName}`);
            $sidebar.css({
                "width": "35%",
                "overflow": "auto"
            }).height($workspace.height());
            $workspace.css("width", "65%");

            // Set editor theme ID and open the sidebar
            ixmaps.editor.themeId = dataName;
            __openSidebar(dataName, './theme_configurator.html');
        };

        /**
         * Opens the map theme editor sidebar.
         * @function __mapThemeEdit
         * @param {string} dataName - The name of the data.
         * @private
         */
         __mapThemeEdit = function (dataName) {
            const $headerButton = $(`#input-table-header-${dataName}-theme-edit`);
            const $sidebar = $(`#input-table-sidebar-${dataName}`);
            const $workspace = $(`#input-table-workspace-${dataName}`);

            const isActive = $headerButton.hasClass("active");

            // Toggle Sidebar and Workspace Visibility
            if (isActive) {
                $sidebar.html("").css("width", "0%");
                $workspace.css("width", "100%");
                $headerButton.removeClass("active");
                return;
            }

            // Activate current sidebar
            __setActiveHeaderButton(dataName,"theme-edit");

            // Set Sidebar and Workspace Dimensions
            $sidebar.css({
                "width": "35%",
                "overflow": "auto"
            }).height($workspace.height());
            $workspace.css("width", "65%");

            // Open the sidebar
            __openSidebar(dataName, './theme_editor.html');
        };

        /**
         * Show the data as HTML table (wrapper)
         * @function __makeDataTable
         * @param {object} data - The data to display in the table.
         * @param {string} dataName - The name of the data.
         * @param {number} height - The height of the table.
         * @returns {string} - html with the data table
         * @private
         */
        __makeDataTable = function(data, dataName, height) {
            return dataA[dataName].makeDataTable(data, dataName, height);
        };

        /**
         * check scroll and add data rows if scroll at end 
         * @function __onScroll
         * @param {object} a - The scroll event.
         * @param {string} dataName - The name of the data.
         * @returns {void}
         * @private
         */
        __onScroll = function(event, dataName) {
            let rest = 1000;
            for (var i in event.target.childNodes) {
                if (event.target.childNodes.item(i).tagName == "DIV") {
                    rest = event.target.childNodes.item(i).clientHeight - event.target.scrollTop - event.target.clientHeight;
                }
            }
            if (rest < 100) {
                dataA[dataName].addToDataTable(dataName);
            }
        };


        // ---------------------------------------------------
        // ---------------------------------------------------
        //
        // h e l p e r  
        //
        // ---------------------------------------------------
        // ---------------------------------------------------

        /**
         * Displays a confirmation dialog with a given message.
         * If `MessageBox.show` fails, it falls back to using the browser's built-in `confirm`.
         * @function __confirm
         * @param {string} szText - The text to display in the confirmation dialog.
         * @param {function} callOk - The function to call if confirmed.
         * @param {function} callCancel - The function to call if canceled.
         * @private
         */
        __confirm = function(szText, callOk, callCancel) {
            try {
                MessageBox.show(MESSAGE_TYPE.Confirmation, " ", szText.replace(/\n+/g, '<br>'), callOk, callCancel);
            } catch (e) {
                if (confirm(szText)) {
                    callOk();
                } else {
                    callCancel();
                }
            }
        };

        /**
         * Displays an informational message box with a given text.
         * If `MessageBox.show` fails, it falls back to using the browser's built-in `alert`.
         * @function __message
         * @param {string} szText - The text to display in the message box.
         * @private
         */
        __message = function(szText) {
            try {
                MessageBox.show(MESSAGE_TYPE.Information, " ", szText.replace(/\n+/g, '<br>'));
            } catch (e) {
                alert(szText);
            }
        };

        /**
         * Displays an error message box with a given text.
         * If `MessageBox.show` fails, it falls back to using the browser's built-in `alert`.
         * @function __error
         * @param {string} szText - The text to display in the error message box.
         * @private
         */
        __error = function(szText) {
            try {
                MessageBox.show(MESSAGE_TYPE.Error, " ", szText.replace(/\n+/g, '<br>'));
            } catch (e) {
                alert(szText);
            }
        };

        /**
         * Toggles visibility of data table for a specific data set and adjusts map height accordingly.
         * Updates icons on toggle buttons based on visibility state.
         * @function __hideData
         * @param {string} dataName - Name of the dataset whose table is being toggled
         * @private
         */
        __hideData = function(dataName) {

            $("#" + "input-table-table-" + dataName).toggle();
            let visible = ($("#input-table-table-" + dataName).css("display") != "none");
            $("#input-table-header-" + dataName + "-toggle-data").children().first().removeClass("bi-eye bi-eye-slash")
                .addClass(visible ? "bi-eye" : "bi-eye-slash");

            let height = !visible ? "600" : "450";
            $("#" + "input-table-map-" + dataName).height(height);
        };

        /**
         * Toggles visibility of map for a specific dataset and adjusts table height accordingly.
         * Updates icons on toggle buttons based on visibility state.
         * @function __hideMap
         * @param {string} dataName Name of the dataset whose map is being toggled
         * @private
         */
        __hideMap = function(dataName) {

            $("#" + "input-table-map-" + dataName).toggle();
            let visible = ($("#input-table-map-" + dataName).css("display") != "none");
            $("#input-table-header-" + dataName + "-toggle-map").children().first().removeClass("bi-eye bi-eye-slash")
                .addClass(visible ? "bi-eye" : "bi-eye-slash");

            let height = !visible ? "600" : "150";
            $("#" + "input-table-table-" + dataName).height(height);
            $("#input-table-table-" + dataName).html(__makeDataTable(dataA[dataName].data, dataName, height));
        };

        /**
         * Toggles visibility of data table for a specific data set and adjusts map height accordingly.
         * Updates icons on toggle buttons based on visibility state.
         * @function __hideData
         * @param {string} dataName - Name of the dataset whose table is being toggled
         * @private
         */
        __toggleCards = function(dataName) {

            dataA[dataName].fShowCards = !dataA[dataName].fShowCards;

            let height = $("#input-table-table-" + dataName).height();
            let offset = $("#input-table-table-" + dataName).children(":first").scrollLeft();
            $("#input-table-table-" + dataName).html(__makeDataTable(data, dataName, height));
            $("#input-table-table-" + dataName).children(":first").scrollLeft(offset)
        };

    </script>

    <script type="text/javascript" charset="utf-8">
        // ----------------------------------------------------------
        // d i a l o g     
        // ----------------------------------------------------------

        /**
         * open/close the data input dialog 
         * @param flag 'show' or 'hide'
         * @type void
         */
        const __openDialog = (url) => {

            const $dialog = $("#composer-dialog");
            const $dialogPos = $("#composer-dialog-pos");

            if ($dialog.is(":visible")) {
                $dialog.empty().hide();
                $dialogPos.hide();
            } else {
                $dialog.html("------").show();
                $dialogPos.show();

                $dialog.load(url, (response, status, xhr) => {
                    if (status === "error") {
                        alert(`Sorry but there was an error: ${xhr.status}\n${xhr.statusText}`);
                    }

                    $dialog.css({
                        "width": "100%",
                        "height": "150%",
                        "position": "relative",
                        "margin-left": "auto",
                        "max-width": "1024px"
                    });

                    $dialog.append(`
                        <div style="position:absolute;top:15px;left:87%;">
                            <a href="javascript:void(0)" onclick="__killDialog()">close</a>
                        </div>
                    `);
                });
            }
        };

        /**
         * close the data input dialog 
         * @param flag 'show' or 'hide'
         * @type void
         */
        __killDialog = function() {
            $("#composer-dialog").hide();
            $("#composer-dialog-pos").hide();
        };

        // ----------------------------------------------------------
        // s i d e b a r     
        // ----------------------------------------------------------

        const __openSidebar = (name, url) => {

            const $sidebar = $("#input-table-sidebar-" + name);

            $sidebar.load(url, (response, status, xhr) => {
                if (status === "error") {
                    alert(`Sorry but there was an error: ${xhr.status}\n${xhr.statusText}`);
                }
            });
        };

        /**
         * open/close the project load dialog 
         * @param flag 'show' or 'hide'
         * @type void
         */
        ixmaps.__projectLoadDialog = function(flag) {
            __openDialog('dialog_project_load.html');
        };
        /**
         * open/close the project save dialog 
         * @param flag 'show' or 'hide'
         * @type void
         */
        ixmaps.__projectSaveDialog = function(flag) {
            __openDialog('dialog_project_save.html');
        };

        /**
         * open/close the data load dialog 
         * @param flag 'show' or 'hide'
         * @type void
         */
        const __dataLoadDialog = () => {
            const dialog = $("#composer-dialog-pos");

            // Set the top position 100 pixels below the current scroll position
            dialog.css("top", ($(document).scrollTop() + 100) + "px");

            // Align the dialog to the left
            dialog.css("left", "-50px");

            __openDialog('./dialog_data_load.html');
        };

        /**
         * open/close the project share dialog 
         * @param flag 'show' or 'hide'
         * @type void
         */
        const __projectShareDialog = () => {
            const dialog = $("#composer-dialog-pos");

            // Set the top position 100 pixels below the current scroll position
            dialog.css("top", ($(document).scrollTop() + 100) + "px");

            // Align the dialog to the left
            dialog.css("left", "-50px");

            __openDialog('./dialog_project_share.html');
        };

        // ---------------------------------------------------
        // ---------------------------------------------------
        //
        // t h e   m a p 
        //
        // ---------------------------------------------------
        // ---------------------------------------------------


        // make shure that multiple maps are no synchronized
        ixmaps.fSyncMaps = false;

        /**
         * @const {string} attribution - The attribution string for the map, linking to iXMaps.
         */
        const attribution =
            "powered by <a href=\"http://ixmaps.com\" target=\"_blank\">iXMaps</a>";

        // ---------------------------------------------------
        // c r e a t e   a   m a p   w i t h   1   t h e m e
        // ---------------------------------------------------

        /**
         * Creates a map with a single theme.
         * @function __createMap
         * @param {object} theme - The theme configuration object.
         * @param {object} data - The data object for the map.
         * @param {string} name - The name of the map.
         * @returns {void}
         */
        const __createMap = (theme, data, name) => {

            const mapConfig = {
                mapService: "leaflet_vt",
                mapType: "VT_VOYAGER_LIGHT",
                map: "../../maps/svg/maps/generic/mercator.svg",
                name: name,
                mode: "pan",
                legend: "true",
                tools: "true",
                search: "true",
                about: "test"
            };

            const mapOptions = {
                featurescaling: "true",
                objectscaling: "true",
                normalSizeScale: "500000",
                flushChartDraw: "1000000",
                basemapopacity: "0.5",
                worksilent: "true",
                loadsilent: "true",
                freezeOnPan: "false",
                hideOnPan: "false"
            };

            //$('#input-table-map-' + name).append(
            ixmaps.embed('input-table-map-' + name, mapConfig, map => {
                ixmaps.embeddedApiA[map.szMap].embeddedSVG.window[name] = data;

                dataA[name].map = map;
                $("#input-table-header-" + name + "-theme").show();
                $("#input-table-header-" + name + "-theme-edit").show();

                //map.data(data, {
                //    type: "jsonDB",
                //    name: name
                //});
                map.options(mapOptions)
                    .local("aggregated", "")
                    .local("loading data ...", "...")
                    .local("working ...", "")
                    .require("../../ui/js/tools/tooltip_mustache.js")
                    .attribution(attribution);
                map.layer(theme);
            })
            //);

            let szCodeDiv = "";
            szCodeDiv += '<div class="text-left" style="margin:0.3em 0 0.5em 0">';
            szCodeDiv += '<a id="map_code_div-' + name + '-showcode" class="btn btn-outline-dark mt-auto" href="javascript:__showCode(\'' + name + '\')">show map project (JSON)</a> ';
            szCodeDiv += '<a id="map_code_div-' + name + '-showhtml" class="btn btn-outline-dark mt-auto" href="javascript:__showHTML(\'' + name + '\')">show embeding code (HTML)</a>';
            szCodeDiv += '<a class="btn btn-outline-dark mt-auto" style="float:right" href="javascript:fullscreen(\'' + name + '\')"><i class="bi-arrows-angle-expand me-1"></i> fullscreen</a> ';
            szCodeDiv += '</div>';
            szCodeDiv += '<div id="map_code_div-' + name + '"></div>';
            szCodeDiv += '<div id="map_code_div-' + name + '_save" class="text-left" style="margin-top:0em;display:none">';
            szCodeDiv += '<a class="btn btn-outline-dark mt-auto" href="javascript:__saveProjectFile(\'' + name + '\')">save code</a> ';
            szCodeDiv += '</div>';
            $('#input-table-map-' + name).append(szCodeDiv);

        };

        // ---------------------------------------------------
        // c r e a t e   a   m a p   w i t h   2   t h e m e s
        // ---------------------------------------------------

        /**
         * Creates a map with two themes.
         * @function __createMap2
         * @param {Array<object>} theme - An array containing the two theme configuration objects.
         * @param {Array<object>} data - An array containing the two data objects for the map.
         * @param {Array<string>} name - An array containing the names of the two maps.
         * @returns {void}
         */
        const __createMap2 = (theme, data, name) => {

            const mapConfig = {
                mapService: "leaflet_vt",
                mapType: "VT_OPENSTREETMAP",
                map: "../../maps/svg/maps/generic/mercator.svg",
                name: name[0],
                height: "500px",
                mode: "pan",
                legend: "true",
                tools: "true",
                search: "true",
                about: "test"
            };

            const mapOptions = {
                featurescaling: "true",
                objectscaling: "dynamic",
                normalSizeScale: "10000000",
                flushChartDraw: "1000000",
                basemapopacity: "0.5",
                worksilent: "true",
                loadsilent: "true",
                freezeOnPan: "false",
                hideOnPan: "false"
            };

            $('#input-table-map-' + name[1]).append(
                ixmaps.embed(name[1], mapConfig, map => {
                    for (var i in data) {
                        map.data(data[i], {
                            type: "jsonDB",
                            name: name[i]
                        });
                    }
                    map.options(mapOptions)
                        .local("aggregated", "")
                        .local("loading data ...", "...")
                        .local("working ...", "")
                        .require("../../ui/js/tools/tooltip_mustache.js")
                        .attribution(attribution);
                    for (var i in theme) {
                        map.layer(theme[i]);
                    }
                })
            );

            let szCodeDiv = "";
            szCodeDiv += '<div class="text-left" style="margin-top:0.3em">';
            szCodeDiv += '<a class="btn btn-outline-dark mt-auto" href="javascript:__showCode(\'' + name + '\')">show code</a> ';
            szCodeDiv += '<a class="btn btn-outline-dark mt-auto" href="javascript:__showHTML(\'' + name + '\')">show html</a>';
            szCodeDiv += '<a class="btn btn-outline-dark mt-auto" style="float:right" href="javascript:fullscreen(\'' + name + '\')">fullscreen</a> ';
            szCodeDiv += '</div>';
            szCodeDiv += '<div id="map_code_div-' + name + '"></div>';
            szCodeDiv += '<div id="map_code_div-' + name + '"_save" class="text-left" style="margin-top:0em;display:none">';
            szCodeDiv += '<a class="btn btn-outline-dark mt-auto" href="javascript:__saveProjectFile(\'' + name + '\')">save code</a> ';
            szCodeDiv += '</div>';
            $('#input-table-map' + name).append(szCodeDiv);

        };

        /**
         **
         ** window size handling
         **
         **/

        $(window).resize(function() {
            $("#" + ixmaps.szMap).css("height", (window.innerHeight - 5) + "px");
        });

        /**
         * @global
         * @type {null|string}
         * @description Stores the ID of the map currently in fullscreen mode. Null if no map is in fullscreen.
         */
        var fullscreenMapId = null;
        /**
         * @global
         * @type {number}
         * @description Stores the vertical scroll position before entering fullscreen mode.
         */
        var pageY = 0;
        /**
         * @global
         * @type {null|string}
         * @description Stores the original style of the map container before entering fullscreen mode. Null if not in fullscreen.
         */
        var fullscreenMapIdStyle = null;

        /**
         * Sets fullscreen mode for a map.
         * @function fullscreen
         * @param {string} szFrameId - The ID of the map container.
         * @returns {void}
         */
        fullscreen = function(szFrameId) {

            if (fullscreenMapId) {
                $("#input-table-map-" + szFrameId).attr("style", fullscreenMapIdStyle);
                $("#input-table-header-" + fullscreenMapId + "-map-inline").hide();

                $("#input-table-map-contract-" + fullscreenMapId).remove();

                window.scrollTo({
                    top: -pageY
                });
                fullscreenMapId = null;
                fullscreenMapIdStyle = null;

                return;
            }

            fullscreenMapId = szFrameId;
            pageY = document.body.getBoundingClientRect().top;

            scroll = $("#input-table-map-" + szFrameId).offset().top;

            fullscreenMapIdStyle = $("#input-table-map-" + szFrameId).attr("style");
            $("#input-table-map-" + szFrameId).attr("style", "position:absolute;width:100% !important;left:0 !important;height:" + (window.innerHeight - 5) + "px;border:0;z-index:999999;background:white");

            window.scrollTo({
                top: scroll
            });

            $("#input-table-header-" + szFrameId + "-map-inline").show();

            $("#input-table-map-" + szFrameId).append('<div id="input-table-map-contract-' + szFrameId + '" style="position:absolute;bottom:2em;right:2em;"><a class="btn btn-outline-dark mt-auto" style="float:right" href="javascript:fullscreen(\'' + szFrameId + '\')"><i class="bi-arrows-angle-contract me-1"></i></a></div>');
        };

        /**
         * Exits fullscreen mode for a map.
         *
         * @function inline
         * @param {string} szFrameId - The ID of the map container.
         */
        inline = function(szFrameId) {};


        /**
         * Creates a map from a given data source.
         * @function __dataToMap
         * @param {string} dataName - The name of the data source.
         * @returns {void}
         */
        __dataToMap = function(dataName) {

            let themeObj = __makeDefaultTheme(dataName);
            themeObj.style.filter = dataA[dataName].facetsFilter;

            console.log("^^^^^^^^^^^^^^^^^^^^^^^^");
            console.log("^^^^^^^^^^^^^^^^^^^^^^^^");
            console.log(themeObj);
            console.log("^^^^^^^^^^^^^^^^^^^^^^^^");
            console.log("^^^^^^^^^^^^^^^^^^^^^^^^");

            if (1 || themeObj.style.lookupfield) {
                $("#" + "input-table-map-" + dataName).css("height", "450px");
                $("#" + "input-table-map-" + dataName).css("width", "100%");
                __createMap(themeObj, dataA[dataName].data, dataName);
            } else {

                alert("no geometry reference found in data");

                for (var name2 in dataA) {
                    if (__getDefaultLookup(themeObj, dataA[name2].data)) {
                        alert("but geometry reference found in data: " + name2);

                        const dialog = $("#composer-dialog-pos");

                        // Set the top position 100 pixels below the current scroll position
                        dialog.css("top", ($(document).scrollTop() + 100) + "px");

                        // Align the dialog to the left
                        dialog.css("left", "-50px");

                        ixmaps.data.connectA = [];
                        ixmaps.data.connectA.push(dataName);
                        ixmaps.data.connectA.push(name2);

                        //__openDialog('../../app/Composer/dialog_connect_data_to_map.html');

                        matchesA = ixmaps.editor.matchTwoDataByFields(dataA[dataName].data, dataA[name2].data);
                        alert(matchesA);
                        console.log(matchesA);
                        let bestMatch = null;
                        matchesA.forEach((match) => {
                            console.log(match);
                            if (!bestMatch || (match.matches > bestMatch.matches)) {
                                bestMatch = match;
                            }
                        })
                        if (bestMatch) {
                            console.log(bestMatch);
                            alert("best match found with '" + bestMatch.field1 + "' and '" + bestMatch.field2 + "'");
                            ixmaps.editor.dbtableUrl = "file";
                            ixmaps.editor.dbtableType = "csv";
                            ixmaps.editor.dbtable = dataA[dataName].data;
                            ixmaps.editor.dataObj = dataA[dataName].data;

                            let themeObjMap = __makeDefaultTheme(name2);
                            themeObjMap.style.itemfield = bestMatch.field2;
                            themeObjMap.layer = "layer_1";

                            themeObj.style.lookupfield = bestMatch.field1;
                            themeObj.layer = "layer_1";

                            $("#" + "input-table-map-" + dataName).css("height", "450px");
                            $("#" + "input-table-map-" + dataName).css("width", "100%");

                            __createMap2([themeObjMap, themeObj], [dataA[name2].data, dataA[dataName].data], [dataName, dataName]);
                        }
                    }
                }
            }

            $("#" + "input-table-table-" + dataName).css("height", "150px");
            $("#input-table-table-" + dataName).html(__makeDataTable(dataA[dataName].data, dataName, 150));

            $("#input-table-sidebar-" + dataName).height($("#input-table-workspace-" + dataName).height());
            $("#facetDiv-" + dataName).height($("#input-table-workspace-" + dataName).height());

            $("#input-table-header-" + dataName + "-map").hide();
            $("#input-table-header-" + dataName + "-remove-map").show();
            $("#input-table-header-" + dataName + "-toggle-data").show();
            $("#input-table-header-" + dataName + "-toggle-map").show();

        };

        /**
         * Handles zoom and pan events on the map.
         * @function ixmaps.htmlgui_onZoomAndPan
         * @returns {void}
         */
        ixmaps.htmlgui_onZoomAndPan = function() {

            console.log("=======================");
            console.log("=== on zoom and pan ===");
            console.log("=======================");

            for (var dataName in dataA) {

                if (dataA[dataName].map) {

                    let themesA = dataA[dataName].map.getThemes();
                    let objTheme = themesA[0];
                    let dataObj = new Data.Table(dataA[dataName].data);
                    //alert(dataA[dataName].data.table.records);

                    // take only rows which are on the map
                    // -------------------------------------------------
                    let records = [];
                    try {
                        for (i in objTheme.indexA) {
                            if (objTheme.itemA[objTheme.indexA[i]].dbIndex) {
                                records.push(dataObj.records[objTheme.itemA[objTheme.indexA[i]].dbIndex]);
                            }
                            if (objTheme.itemA[objTheme.indexA[i]].dbIndexA) {
                                for (a in objTheme.itemA[objTheme.indexA[i]].dbIndexA) {
                                    records.push(dataObj.records[objTheme.itemA[objTheme.indexA[i]].dbIndexA[a]]);
                                }
                            }
                        }
                    } catch (e) {}
                    dataObj.records = records.slice();
                    dataObj.table.records = records.length;
                    let height = $("#input-table-table-" + dataName).height();
                    $("#input-table-table-" + dataName).html(__makeDataTable(dataObj, dataName, height));

                    $("#input-table-info-" + dataName).html("records: " + dataObj.table.records + " (" + dataA[dataName].data.table.records + ") filtered by map view <a href='javascript:saveAsCSV(\"" + dataName + "\")'>export</a>");
                }
            }
        };

        /**
         * Removes the map from a data workspace
         * @param {string} dataName - The unique data name.
         * @private
         */
        __removeMap = function(dataName) {

            __confirm("do you really want to remove the map?", () => {
                
                $("#" + "input-table-table-" + dataName).css("height", "450px");
                $("#input-table-table-" + dataName).html(__makeDataTable(dataA[dataName].data, dataName, 450));

                $("#input-table-sidebar-" + dataName).height($("#input-table-workspace-" + dataName).height());
                $("#facetDiv-" + dataName).height($("#input-table-workspace-" + dataName).height());

                $("#input-table-header-" + dataName + "-map").show();
                $("#input-table-header-" + dataName + "-remove-map").hide();
                $("#input-table-header-" + dataName + "-theme").hide();
                $("#input-table-header-" + dataName + "-theme-edit").hide();
                $("#input-table-header-" + dataName + "-toggle-data").hide();
                $("#input-table-header-" + dataName + "-toggle-map").hide();
                
                if ($("#input-table-header-" + dataName + "-theme").hasClass("active")) {
                    $(".colpick").remove();
                }

                $("#input-table-map-" + dataName).html("");
                
                if (dataA[dataName].map) {
                    delete ixmaps.embeddedApiA[dataName];
                    dataA[dataName].map = null;
                }
                
                const $activeSidebar = dataName ? $(`#input-table-sidebar-${dataName}`) : null;
                const $activeWorkspace = dataName ? $(`#input-table-workspace-${dataName}`) : null;
                const $activeHeader = dataName ? $(`#input-table-header-${dataName}-theme`) : null;

                // If another theme is active, close it
                if (dataName) {
                    $activeSidebar.html("").css("width", "0%");
                    $activeWorkspace.css("width", "100%");
                    $activeHeader.removeClass("active");

                    // Remove color picker elements
                    $(".colpick").remove();
                }
 
                return;
            });
        };


        // ----------------------------------------------------------
        // d a t a   - - >  t h e m e        
        // ----------------------------------------------------------

        /**
         * Creates a default theme object for a given data source.
         * @function __makeDefaultTheme
         * @param {string} dataName - The name of the data source.
         * @returns {object} The default theme object.
         */
        __makeDefaultTheme = function(dataName) {

            objTheme = {
                layer: "generic",
                field: "$item$"
            };
            objTheme.style = {};
            objTheme.style.dbtableUrl = dataA[dataName].url || "";
            objTheme.style.dbtableType = dataA[dataName].type || "";
            objTheme.style.dbtable = dataName;
            objTheme.style.lookupfield = " ";
            objTheme.style.title = "[title]";
            objTheme.style.colorscheme = [1, "#eeeeff", "#0000dd"];
            objTheme.style.showdata = true;
            objTheme.style.tooltip = "{{theme.item.chart}}{{theme.item.data}}";
            objTheme.style.editor = true;
            objTheme.style.name = dataName;

            dataTable = dataA[dataName].data;

            var x = String(dataTable.records[0][dataTable.table.fields - 1]);
            if (x.match(/Polygon/)) {
                objTheme.layer = "FEATURE";
                $('#map-layer-select').append($('<option>', {
                    value: "FEATURE",
                    text: 'FEATURE'
                }));
                $("#map-layer-select").val("FEATURE");
                objTheme.style.type = "FEATURE|SHOW";
                objTheme.style.colorscheme = "#eeeeee";
                objTheme.style.fillopacity = "0.1";
                objTheme.style.linecolor = "#0088dd";
                objTheme.style.linewidth = "0.5";
            } else
            if (x.match(/Line/)) {
                objTheme.layer = "FEATURE";
                $('#map-layer-select').append($('<option>', {
                    value: "FEATURE",
                    text: 'FEATURE'
                }));
                $("#map-layer-select").val("FEATURE");
                objTheme.style.type = "FEATURE|SHOW";
                objTheme.style.colorscheme = "#0088dd";
                objTheme.style.fillopacity = "1";
                objTheme.style.linecolor = "#0088dd";
                objTheme.style.linewidth = "1";
            } else
            if (dataTable && dataTable.table && (dataTable.table.records > 250000)) {
                objTheme.style.type = "CHART|SYMBOL|GRIDSIZE|DOPACITY|AGGREGATE|SUM|SHOW";
                //objTheme.style.type = "CHART|SYMBOL|AUTOSIZE|AGGREGATE|SUM|SHOW";
                objTheme.style.gridwidth = "10px";
                objTheme.style.symbols = ["hexagon"];
                objTheme.style.dopacitypow = 2;
                objTheme.style.dopacityscale = 2;
            } else
            if (dataTable && dataTable.table && (dataTable.table.records > 100000)) {
                objTheme.style.type = "CHART|BUBBLE|AGGREGATE|SUM|SHOW";
                objTheme.style.gridwidth = "2px";
                objTheme.style.fillopacity = "0.3";
            } else {
                //objTheme.style.type = "CHART|DOT|RAW";
                objTheme.style.type = "CHART|DOT|RAW|SHOW";
                objTheme.style.fillopacity = "0.2";
            }

            objTheme.style.lookupfield = __getDefaultLookup(objTheme, dataA[dataName].data);

            return objTheme;

        };

        /**
         * Gets the default lookup field for a given theme and data.
         *
         * @function __getDefaultLookup
         * @param {Object} objTheme - The theme object.
         * @param {Object} data - The data object.
         * @returns {string} The default lookup field.
         */
        __getDefaultLookup = function(objTheme, data) {

            let szLookup = "";

            // 1. look for fields that contain both, latitude and longitude

            let fields = data.fields;

            //szLookup = fields[0].id + "|" + fields[0].id;

            for (var i in fields) {

                var x = String(data.records[0][i]);
                // identify by content
                if (x && x.match(/Polygon|Line/)) {
                    szLookup = fields[i].id;
                } else
                    // identify by name
                    if (fields[i].id.match(/latitud/i) && fields[i].id.match(/longitud/i)) {
                        szLookup = fields[i].id;
                    } else {
                        // identify by value (like 13.3568,45.34567)
                        valuesA = __getFieldValues(data, fields[i].id, 10);
                        for (x in valuesA) {
                            if (!String(valuesA[x]).match(/\'/)) {
                                var matchA = String(valuesA[x]).match(/(-?[0-9\.]+) ?, ?(-?[0-9\.]+)/)
                                if (matchA &&
                                    (matchA.length == 3) &&
                                    (Number(matchA[1]) < 80) && (Number(matchA[1]) > -80) &&
                                    (Number(matchA[2]) < 180) && (Number(matchA[2]) > -180) &&
                                    matchA[1] % 1 &&
                                    matchA[2] % 1
                                ) {
                                    szLookup = fields[i].id;
                                    break;
                                }
                                if (matchA &&
                                    (matchA.length == 3) &&
                                    (Number(matchA[1]) < 180) && (Number(matchA[1]) > -180) &&
                                    (Number(matchA[2]) < 80) && (Number(matchA[2]) > -80) &&
                                    matchA[1] % 1 &&
                                    matchA[2] % 1
                                ) {
                                    szLookup = fields[i].id;
                                    break;
                                }
                            }
                        }
                    }
            }

            // 2. look for 2 fields that contain latitude or longitude

            let szLat = "";
            let szLon = "";
            for (var i in fields) {
                if (fields[i].id.match(/latitud/i) ||
                    (fields[i].id == "lat") ||
                    (fields[i].id == "Lat") ||
                    (fields[i].id == "LAT") ||
                    (fields[i].id == "Y")) {
                    szLat = fields[i].id;
                }
                if (fields[i].id.match(/longitud/i) ||
                    (fields[i].id == "lon") ||
                    (fields[i].id == "Lon") ||
                    (fields[i].id == "LON") ||
                    (fields[i].id == "long") ||
                    (fields[i].id == "Long") ||
                    (fields[i].id == "LONG") ||
                    (fields[i].id == "lng") ||
                    (fields[i].id == "Lng") ||
                    (fields[i].id == "LNG") ||
                    (fields[i].id == "X")) {
                    szLon = fields[i].id;
                }
            }
            if (szLat.length && szLon.length) {
                szLookup = szLat + "|" + szLon;
            }

            if (szLookup == "") {
                szLookup = fields[0].id + "|" + fields[0].id;
                __error("No column with coordinate values found!\nPlease select coordinates manually !");
            }

            return szLookup;
        };

        /**
         * Gets the values for a given field from a data object.
         *
         * @function __getFieldValues
         * @param {Object} data - The data object.
         * @param {string|Array<string>} szField - The field to get values from. If an array, the first element is used.
         * @param {number} nMax - The maximum number of values to return.
         * @returns {Array<any>} An array of values for the given field.
         */
        __getFieldValues = function(data, szField, nMax) {

            // szField may be string or array of strings
            // if array, take first string !
            if ($.isArray(szField)) {
                szField = szField[0];
            }

            var valuesA = null;
            if (data) {
                var valuesA = new Array();
                if (szField == "$item$") {
                    for (i = 0; i < 20; i++) {
                        valuesA.push(1);
                    }
                } else {
                    var fields = data.fields;
                    var index = 0;
                    for (i = 0; i < fields.length; i++) {
                        if (fields[i].id == szField) {
                            index = i;
                        }
                    }
                    var nCount = Math.min(nMax || data.records.length, data.records.length);
                    for (i = 0; i < nCount; i++) {
                        valuesA.push(data.records[i][index]);
                    }
                }
            }
            return valuesA;
        };

        /**
         * Matches two data objects by their fields, counting the number of matching unique values.
         *
         * @function ixmaps.editor.matchTwoDataByFields
         * @param {Object} data1 - The first data object.
         * @param {Object} data2 - The second data object.
         * @returns {Array<Object>} An array of objects, each containing the matching fields and the number of matches.
         * Each object in the array has the structure: `{field1: string, field2: string, matches: number}`.
         */
        ixmaps.editor.matchTwoDataByFields = function(data1, data2) {

            let result = [];
            for (var i in data1.fields) {
                let values1A = data1.column(data1.fields[i].id).uniqueValues().sort();
                for (var ii in data2.fields) {
                    if (data2.fields[ii].id == 'geometry') {
                        continue;
                    }
                    let nMatch = 0;
                    let values2 = data2.column(data2.fields[ii].id).uniqueValues().sort().join(',');
                    for (v in values1A) {
                        if (values2.match(values1A[v])) {
                            nMatch++;
                        }
                    }
                    if (nMatch > 0) {
                        console.log(data1.fields[i].id + '|' + data2.fields[ii].id)
                        console.log(nMatch + " ");
                        let item = {
                            field1: data1.fields[i].id,
                            field2: data2.fields[ii].id,
                            matches: nMatch
                        };
                        result.push(item);
                    }

                }
            }
            return result;
        };

        /**
         * Shows the code for a given data name by fetching and displaying the project string.
         *
         * @function __showCode
         * @param {string} dataName - The name of the data.
         */
        __showCode = function(dataName) {
            $("#map_code_div-" + dataName).html("");
            $("#map_code_div-" + dataName + "_save").hide();
            $("#map_code_div-" + dataName + "-showhtml").removeClass("active");

            if ($("#map_code_div-" + dataName + "-showcode").hasClass("active")) {
                $("#map_code_div-" + dataName + "-showcode").removeClass("active");
            } else {
                $("#map_code_div-" + dataName + "-showcode").addClass("active");
                __showProjectString(dataA[dataName].map.getProjectString(), 1, 1, dataName);
            }
        };

        /**
         * Shows the HTML for a given data name by fetching and displaying the project HTML.
         *
         * @function __showHTML
         * @param {string} dataName - The name of the data.
         */
        __showHTML = function(dataName) {
            $("#map_code_div-" + dataName).html("");
            $("#map_code_div-" + dataName + "_save").hide();
            $("#map_code_div-" + dataName + "-showcode").removeClass("active");

            if ($("#map_code_div-" + dataName + "-showhtml").hasClass("active")) {
                $("#map_code_div-" + dataName + "-showhtml").removeClass("active");
            } else {
                $("#map_code_div-" + dataName + "-showhtml").addClass("active");
                __showProjectHTML(ixmaps.map(dataName).getProjectString(), 1, 1, dataName);
            }
        };

        /**
         * Shows the project string with syntax highlighting.
         *
         * @function __showProjectString
         * @param {string} szProject - The project string in JSON format.
         * @param {number} n - A number.  Purpose unclear from the provided code.
         * @param {number} all - A number.  Purpose unclear from the provided code.
         * @param {string} dataName - The name of the data.
         */
        __showProjectString = function(szProject, n, all, dataName) {

            $.when(
                $.getScript("./js/json_config.js"),
                $.Deferred(function(deferred) {
                    $(deferred.resolve);
                })
            ).done(function() {

                // make object to handle project definition and get string or json from it
                // 
                var project = new Config(szProject);

                // get JSON and formatted string
                //
                szProject = project.getPrettyString();
                project = project.obj;

                // make the HTML

                var list = "";
                var id = "source-" + dataName;

                list += '<div class="source" >';
                list += '<pre id="' + id + '" class="prettyprint language-JSON">';
                list += '</pre>';
                list += '</div>';

                $("#map_code_div-" + dataName).append(list);

                $("#" + id + "").text(String(szProject));
                hljs.highlightBlock($("#" + id)[0]);

                $(".hljs-attr").attr("onMouseOver", "showTooltip(event,$(this).text())");
                $(".hljs-attr").attr("onMouseOut", "hideTooltip()");

                $("#map_code_div-" + dataName + "_save").show();
            });

        };

        /**
         * Shows the project HTML with syntax highlighting.
         *
         * @function __showProjectHTML
         * @param {string} sProject - The project string.
         * @param {number} n - A number.  Purpose unclear from the provided code.
         * @param {number} all - A number.  Purpose unclear from the provided code.
         * @param {string} dataName - The name of the data.
         */
        __showProjectHTML = function(sProject, n, all, dataName) {

            $.when(
                $.getScript("./js/json_config.js"),
                $.getScript("./js/json_config_html.js"),
                $.Deferred(function(deferred) {
                    $(deferred.resolve);
                })
            ).done(function() {

                // make object to handle project definition and get embedding HTML code
                // 
                let sHtml = new Config(sProject).getProjectHTML();

                // show the HTML

                let sPretty = "";
                let sId = "source-" + dataName;

                sPretty += '<div class="source" style="padding:0.2em 0 0.2em 1em;background:#f3f3f3">';
                sPretty += '<pre id="' + sId + '" class="prettyprint language-HTML">';
                sPretty += '</pre>';
                sPretty += '</div>';

                $("#map_code_div-" + dataName).append(sPretty);

                $("#" + sId + "").text(String(sHtml));
                hljs.highlightBlock($("#" + sId)[0]);

                $(".hljs-attr").attr("onMouseOver", "showTooltip(event,$(this).text())");
                $(".hljs-attr").attr("onMouseOut", "hideTooltip()");

                $("#map_code_div-" + dataName + "_save").show();
            });
        };

        // -------------------------------------       
        // s a v e    t o    d o w n l o a d
        // -------------------------------------

        /**
         * isAPIAvailable  
         *
         * checks the browser support for the HTML5 File API
         * displays a warning if the browser doesn't support it
         * @type boolean
         * @return true,false
         */
        function isAPIAvailable() {
            // Check for the various File API support.
            if (window.File && window.FileReader && window.FileList && window.Blob) {
                // Great success! All the File APIs are supported.
                return true;
            } else {
                alert("The browser you're using does not currently support\nthe HTML5 File API. As a result the file loading demo\nwon't work properly.");
                return false;
            }
        }

        /**
         * Saves text as a file, triggering a download in the browser.
         *
         * @function saveTextAsFile
         * @param {string} szText - The text content to be saved.
         * @param {string} szFilename - The desired filename for the downloaded file.
         */
        function saveTextAsFile(szText, szFilename) {
            var textToWrite = szText;
            var textFileAsBlob = new Blob([textToWrite], {
                type: 'text/plain'
            });
            var fileNameToSaveAs = szFilename || "project.json";

            var downloadLink = document.createElement("a");
            downloadLink.download = fileNameToSaveAs;
            downloadLink.innerHTML = "Download File";
            if (window.URL != null) {
                // Chrome allows the link to be clicked
                // without actually adding it to the DOM.
                downloadLink.href = window.URL.createObjectURL(textFileAsBlob);
            } else {
                // Firefox requires the link to be added to the DOM
                // before it can be clicked.
                downloadLink.href = window.URL.createObjectURL(textFileAsBlob);
                downloadLink.onclick = destroyClickedElement;
                downloadLink.style.display = "none";
                document.body.appendChild(downloadLink);
            }

            downloadLink.click();
        }

        /**
         * Saves the project file by retrieving the project string from the editor and triggering a download.
         *
         * @function __saveProjectFile
         * @param {string} dataName - The name of the data.
         */
        __saveProjectFile = function(dataName) {

            if (isAPIAvailable()) {
                szText = $("#source-" + dataName).text();
                if (szText.match(/\<html\>/)) {
                    saveTextAsFile(szText, "map.html");
                } else {
                    saveTextAsFile(szText, "map.json");
                }
            }
        };

        // ----------------------------------------------------------
        // ----------------------------------------------------------
        // l o a d   a n d   p r o c e s s   d a t a 
        // ----------------------------------------------------------
        // ----------------------------------------------------------

        /**
         * Process loaded data (text string) and create data table object.
         * Apply query parameter to filter or process the data.
         *
         * @function processTextData
         * @param {string} text - the data as text.
         * @param {string} szUrl - the data url.
         * @type void
         */
        function processTextData(text, szSource) {

            let sType = "";

            if (text.match(/\<xml/) && text.match(/feed/)) {
                sType = "rss";
            } else
            if (text.match(/\<xml/) && text.match(/www.opengis.net\/kml/)) {
                sType = "kml";
            } else
            if (text.match(/created by dbf2xml/)) {
                sType = "jsonDB";
            } else
            if (text.match(/\"type\"/) && text.match(/\"FeatureCollection\"/)) {
                sType = "geojson";
            } else
            if (text.match(/\"type\"/) && text.match(/\"Topology\"/)) {
                sType = "topojson";
            } else
            if ((text[0] == "{") || (text[0] == "[")) {
                sType = "json";
            } else {
                sType = "csv";
            }

            $("#load-param-spinner").hide();

            data = Data.import({
                source: text,
                type: sType
            });

            const dataName = __addData(data);

            if (params.analyze) {
                dataA[dataName].fShowAnalytics = true;
                $("#input-table-header-" + dataName + "-analytics").addClass("active");
            }

            if (params.filter) {
                if (!params.pivot) {
                    __dataFacets(dataName);
                }
                __dataFacetsSetFilter(dataName, params.filter);
            }
            if (params.pivot) {
                dataA[dataName].pivot = JSON.parse(params.pivot);
                __dataProcess(dataName);
                setTimeout(() => {
                    $("#input-table-header-" + dataName + "-pivot").addClass("active");
                    __dataProcessMakePivot(dataName, dataA[dataName].pivot);
                }, 100);
            }
            if (params.sort) {
                setTimeout(() => {
                    __dataSort(dataName, params.sort.split("-")[0], params.sort.split("-")[1]);
                }, 1000);
            }

        };

        /**
         * Load data from given URL as text and calls a processing function on success.
         *
         * @function 
         * @param {string} szUrl - the data url.
         * @type void
         */
        function doDataUrl(szUrl) {
            $("#load-param-spinner").show();

            ixmaps.editor.dbtableUrl = szUrl;
            $.ajax({
                type: "GET",
                url: szUrl,
                dataType: "text",
                success: function(data) {
                    processTextData(data, szUrl);
                },
                error: function() {
                    alert("\"" + szUrl + "\" could not be loaded!");
                }
            });
        }

        // ----------------------------------------------------------
        // ----------------------------------------------------------
        // i n i t   a l l 
        // ----------------------------------------------------------
        // ----------------------------------------------------------

        $("#Input-table").css("min-height", (window.innerHeight - 200) + "px");

        // get query as parameter object
        // ------------------------------
        const params = new Proxy(new URLSearchParams(window.location.search), {
            get: (searchParams, prop) => searchParams.get(prop),
        });

        // ----------------------------------------------------------------------------
        // a) if we have data or project defined in query parameter, load and process data
        // ----------------------------------------------------------------------------

        if (params.project) {
            alert(params.project);
        } else
        if (params.data) {
            doDataUrl(params.data);
        }
        // ---------------------------------
        // b) if not, show data loading dialog
        // ---------------------------------
        else {
            __dataLoadDialog();
        }

    </script>

</body>

</html>
