<!DOCTYPE html>
<html>

<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<title>Project Viewer - ixmaps story</title>
	<meta name="author" content="ixmaps" />
	<meta name="description" content="ixmaps story" />
	<meta name="keywords" content="ixmaps,corruption,map" />
	<meta name="Resource-type" content="Document" />

	<link rel="stylesheet" type="text/css" href="assets/css/bootstrap.min.css" />
	<link rel="stylesheet" type="text/css" href="assets/css/jquery.fullPage.css" />
	<link rel="stylesheet" type="text/css" href="index.css" />
	<link href="assets/css/font-awesome.min.css" rel="stylesheet">
	<link href="assets/css/icomoon.css" rel="stylesheet" />

	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.13.1/styles/github-gist.min.css">
	<link rel="stylesheet" href="./test.css">

	<style>
		#tooltip {
			font-family: arial, system;
			font-size: 14px;
			background: white;
			border: 0.5px solid black;
			border-radius: 5px;
			padding: 0.5em 1em 0.5em 1em;
			max-width: 300px;
			box-shadow: 1px 1px 9px rgba(0, 0, 0, .275);
		}

		#tooltip p {
			font-size: 14px;
		}

		#tooltip table {
			font-size: 14px;
		}

		table {
			border: none;
			margin-left: -0.5em;
		}

		td {
			border: none;
			vertical-align: top;
			padding: 0.5em;
		}

		tr {
			margin-top: -0.5em;
		}

		p {
			margin-top: 0em;
			margin-bottom: 0.5em;
			line-height: 1.2em;
		}

		#filelist {
			font-size: 1.2em;
			width: 50%;

		}

		#filelist p {
			font-size: 1.2em;
			width: 50%;

		}

		#filelist h2 {
			font-size: 1.5em;
			width: 50%;

		}

		#filelist h3 {
			font-size: 1.3em;
			width: 50%;

		}

	</style>
	<style>
		.read-md {
			max-width: 800px;
			margin: 0em 0em 0em 0em;
		}

		.avatar {
			position: absolute;
			top: 0;
			right: 100%;
			border-radius: 4px;
		}

		.gist-readme {
			line-height: 1.5em;
			max-width: 720px;
			max-height: 1000000vh;
		}

		.gist-id,
		pre,
		code,
		textarea {
			font-family: "Menlo", monospace;
			line-height: normal;
		}

		.gist-id {
			line-height: 0;
		}

		.title {
			margin-bottom: 2.5em;
		}

		.gist {
			float: left;
			margin-right: 1em;
		}

		.source {
			border-left: solid #ddd 2px;
			padding-left: 2em;
		}

	</style>

	<style>
		code {
			background-color: rgba(148, 144, 146, 0.2);
		}

		pre {
			white-space: pre-wrap;
			/* css-3 */
			white-space: -moz-pre-wrap;
			/* Mozilla, since 1999 */
			white-space: -pre-wrap;
			/* Opera 4-6 */
			white-space: -o-pre-wrap;
			/* Opera 7 */
			word-wrap: break-word;
			/* Internet Explorer 5.5+ */
			xxbackground-color: #f8f8f8;
			margin-top: 1.5em;
			margin-bottom: 1.5em;
			padding: 0.5rem 0.3125rem;
		}

		pre code {
			background-color: transparent;
			border: 0;
			padding: 0;
		}

		pre code.hljs {
			display: block;
			padding: 1em;
		}

		code.hljs {
			display: inline;
			padding: 0 0.5em;
			border: solid #ddd 0.5px;
			border-radius: 0.1em;
			font-size: 1.1em;
			xxbackground-color: rgba(148, 144, 146, 0.2);
		}

		blockquote {
			color: #aaa;
			font-size: 1em;
			font-weight: normal;
			font-style: italic;
			margin-left: 0em;
			padding-left: 1em;
			border-left: solid #ddd 4px;
		}

	</style>
	<style>
		h1 {
			font-size: 46px;
			font-weight: 500;
			letter-spacing: -1px;
			margin: 0.2em 0em 0em 0em;
		}

		h2 {
			font-weight: 700;
			margin-top: 1.5em;
			margin-bottom: 0.5em;
		}

		h3 {
			font-weight: 700;
			margin-top: 1.5em;
			margin-bottom: 0.5em;
		}

		h1,
		h2 {
			text-rendering: optimizeLegibility;
		}

		h1,
		iframe {
			width: 960px;
		}

		iframe {
			border: none;
		}

		a {
			color: #2980B9;
			text-decoration: none;
			cursor: pointer
		}

		a:hover {
			color: #3091d1
		}

		a:visited {
			color: #9B59B6
		}

		p {
			line-height: 1.5em;
			margin: 0;
			font-size: 1em;
			margin: 1em 0em;
		}

		.read-md {
			max-width: 800px;
			margin: 0em 0em 0em 0em;
		}

		.avatar {
			position: absolute;
			top: 0;
			right: 100%;
			border-radius: 4px;
		}

		.gist-readme {
			line-height: 1.5em;
			max-width: 720px;
			max-height: 1000000vh;
		}

		.gist-id,
		pre,
		code,
		textarea {
			font-family: "Menlo", monospace;
			line-height: normal;
		}

		.gist-id {
			line-height: 0;
		}

		.title {
			margin-bottom: 2.5em;
		}

		.gist {
			float: left;
			margin-right: 1em;
		}

		.source {
			border-left: solid #ddd 2px;
			padding-left: 1em;
		}

		.prettyprint {
			font-size: 0.9em;
		}

		code {
			xxcolor: #a66;
		}

	</style>

	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.13.1/styles/github-gist.min.css">

	<style>
		pre {
			white-space: pre-wrap;
			/* css-3 */
			white-space: -moz-pre-wrap;
			/* Mozilla, since 1999 */
			white-space: -pre-wrap;
			/* Opera 4-6 */
			white-space: -o-pre-wrap;
			/* Opera 7 */
			word-wrap: break-word;
			/* Internet Explorer 5.5+ */
			xxbackground-color: #f8f8f8;
			margin-top: 1.5em;
			margin-bottom: 1.5em;
			padding: 0.5rem 0.3125rem;
		}

		pre code {
			background-color: transparent;
			border: 0;
			padding: 0;
		}

		pre code.hljs {
			display: block;
			padding: 1em;
		}

		code.hljs {
			display: inline;
			padding: 0 0.5em;
			border: solid #ddd 0px;
			border-radius: 0.1em;
			xxbackground-color: rgba(155, 155, 155, 0.1);
		}

		blockquote {
			color: #aaa;
			font-size: 1em;
			font-weight: normal;
			font-style: italic;
			margin-left: 0em;
			padding-left: 1em;
			border-left: solid #ddd 4px;
		}

		ol {
			list-style: disc;
			margin: 0;
			padding: 1em;
		}

		ul {
			list-style: circle;
			margin: 0;
			padding-left: 1em;
		}

	</style>

</head>

<body class="story-body">

	<div id="header" class="navbar-fixed-top" style="position:fixed;top:0;left:0.5em;width:100%;height:40px;padding:0px 0px 50px 0px;background:#ffffff;z-index:9999">
		<div class="container" style="margin-top:1.2em">
			<div class="row">
				<div class="col-lg-8 col-lg-offset-2">
					<div class="header" aria-hidden="true">
						<div class="linkSocialContainer" style="float:left">
							<span class="linkContainer"></span>
							<span class="shareBtns" style="font-size:24px">
								<a href="javascript:ixmaps.popupShare()">
									<i class="icon shareIcon blackHover share_facebook icon-facebook-squared" title="Share on Facebook" tabindex="-1"></i></a>
								<a href="javascript:ixmaps.popupShare()">
									<i class="icon shareIcon blackHover share_bitly icon-share" title="Share a short link" tabindex="-1" style="margin-left:0.1em"></i></a>
								<a href="javascript:ixmaps.loadStoryTool('./filter.html',{frame:true})">
									<i class="icon shareIcon blackHover share_bitly icon-filter" title="Filter" tabindex="-1" style="margin-left:0em"></i></a>
								<a href="javascript:ixmaps.loadStoryTool('./layer.html')">
									<i class="icon shareIcon blackHover share_bitly icon-map" title="Layer" tabindex="-1" style="margin-left:0.2em"></i></a>
								<a href="javascript:ixmaps.loadStoryTool('./about.html')">
									<i class="icon shareIcon blackHover share_bitly icon-info" title="About" tabindex="-1" style="margin-left:0.2em"></i></a>
								<a href="javascript:ixmaps.loadStoryTool('./menu.html')">
									<i class="icon shareIcon blackHover share_bitly icon-list2" title="Menu" tabindex="-1" style="margin-left:0.1em"></i></a>
								<a href="javascript:ixmaps.loadStoryTool('./table.html',{frame:true})">
									<i class="icon shareIcon blackHover share_bitly icon-table2" title="Menu" tabindex="-1" style="margin-left:0.2em"></i></a>
								<a href="javascript:ixmaps.loadStoryTool('../../../../ui/html/tools/theme_editor.html',{frame:true})">
									<i class="icon shareIcon blackHover share_bitly icon-pencil" title="Menu" tabindex="-1" style="margin-left:0.2em"></i></a>
								<a href="javascript:ixmaps.loadStoryTool('../../../../ui/html/tools/theme_configurator.html',{frame:true})">
									<i class="icon shareIcon blackHover share_bitly icon-equalizer" title="Menu" tabindex="-1" style="margin-left:0.1em"></i></a>
							</span>
						</div>
						<div class="linkSocialContainer" style="float:right;margin-right:-0.5em;margin-top:0.2em;">
							<span class="linkContainer"></span>
							<span class="shareBtns" style="font-size:18px">
								<a href="javascript:ixmaps.fullScreen()">
									<i class="shareIcon blackHover share_bitly icon-close" title="Info" tabindex="-1" style="margin-left:0.2em"></i></a>
							</span>
						</div>
						<div class="logoContainer" style="float:right;margin-right:-10px;display:none">
							<table>
								<tr>
									<td class="logoWrapper">
										<a class="logoLink" target="_blank" tabindex="-1">
											<img class="logoImg" src="" height="60px" style="opacity:0.8" />
										</a>
									</td>
								</tr>
							</table>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>

	<div id="fullpage" style="display:none">

		<div class="section">

			<!-- show the project -->

			<div class="slide">
				<div class="intro down">
					<div>
						<form id="upload" action="index.html" method="POST" enctype="multipart/form-data">
							<fieldset>
								<legend id="legend"><br>
									<span id="loadProjectButton" style="display:none">
										<a href="javascript:$('#loadProject').show();$('#loadProjectButton').hide();$('#loadProjectHideButton').show()" title="load project">[+]</a></span>
									<span id="loadProjectHideButton" style="display:none">
										<a href="javascript:$('#loadProject').hide();$('#loadProjectButton').show();$('#loadProjectHideButton').hide()" title="load project">[-]</a></span>
									<span id="saveProjectButton" style="display:none">
										<a href="javascript:ixmaps.popupProject()" title="save project">[->]</a></span>
								</legend>
								<input type="hidden" id="MAX_FILE_SIZE" name="MAX_FILE_SIZE" value="300000" />
								<div id="loadProject" style="margin-top:0.5em;background:rgba(0,0,0,0);">
									<input type="file" id="fileselect" name="fileselect[]" multiple="multiple" style="display:none" />
									<div id="filedrag" style="clear:both;height:10em;width:100%;border:dashed #dddddd 2px;">drop files here</div>
									<label class="fileContainer" for="fileselect" style="position:relative;top:-6em;left:30%">or select project</label>
								</div>

							</fieldset>

						</form>
					</div>
					<div id="messages">
					</div>
					<h3 id="title" class="title" style="margin-left:10px;margin-top:0.3em;margin-bottom:0em;"></h3>
				</div>
				<div style="clear:both">
					<div id="description">
					</div>
					<div id="filelist" style="width:1160px;height:100000px">
					</div>
				</div>

				<div id="tooltip" style="position: absolute; display: none;"></div>
				<div id="tooltips" style="display: none;"></div>

			</div>

		</div>

		<div class="section">

			<!-- legend -->

			<div class="slide">
				<div class="intro up down">
					<div id="legendTabs" style="display:none">
						<ul id="legendTabsList" class="nav nav-tabs">
							<li id="lastLegendTab"><a href="#" onclick="activateTab($(this))">Map Layer</a></li>
						</ul>
					</div>

					<div id='themeLegendDiv' style="margin-top:-2.5em;clear:both;display:none"></div>
				</div>
			</div>

		</div>


		<div class="section">
			<div class="intro footer up">
				<br>
				<h2>Info & Attribution</h2>
				<br>
				<br>
				<p>
					This is a iXMaps Project analyse tool.</p>
				<p>
					Its scope is to show the cofiguration (json) and other relevant files of a iXMaps visualization project.</p>
				<p>
					To edit the configuration the 'edit' tool is recommended.</p>
				<br>
				<p>Visualization:<br>
					created by <a href="http://ixmaps.com">iXmaps</a> - CC BY</p>
				<p> <span class="icon icon-envelop"></span> <a href="#"> info@ixmaps.com</a> <br />
					<span class="icon icon-twitter"></span> <a href="#"> @grichter </a> <br />
				</p>
				<br>
				<p>credits</p>
				<p>
					<a href="http://alvarotrigo.com/fullPage/">alvarotrigo.com</a> - for the scrolling
					<br><a href="http://icomoon.io">icomoon.io</a> - for the nice icons
				</p>

			</div>
		</div>

	</div>


	<!-- ==== MODAL DIALOG ==== -->
	<div id="modal-dialog-1" class="modal fade bs-example-modal-lg" tabindex="-1" role="dialog" aria-labelledby="myLargeModalLabel" aria-hidden="true" style="z-index:9999">
		<div class="modal-dialog modal-lg">
			<div class="modal-content">
				...
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
			</div>
		</div>
	</div>
	<div id="modal-dialog-2" class="modal fade bs-example-modal-lg" tabindex="-1" role="dialog" aria-labelledby="myLargeModalLabel" aria-hidden="true" style="z-index:9999">
		<div class="modal-dialog modal-lg">
			<div class="modal-content">
				...
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
			</div>
		</div>
	</div>
	<div id="modal-dialog-3" class="modal fade bs-example-modal-lg" tabindex="-1" role="dialog" aria-labelledby="myLargeModalLabel" aria-hidden="true" style="white;z-index:9999">
		<div class="modal-dialog modal-lg">
			<div class="modal-content">
				...
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
			</div>
		</div>
	</div>

	<!--[if IE]>
		<script type="text/javascript">
			 var console = { log: function() {} };
		</script>
	<![endif]-->

	<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
	<script type="text/javascript" src="assets/js/bootstrap.min.js"></script>
	<script type="text/javascript" src="assets/js/main.js"></script>
	<script type="text/javascript" src="assets/js/masonry.pkgd.min.js"></script>
	<script type="text/javascript" src="assets/js/imagesloaded.js"></script>
	<script type="text/javascript" src="assets/js/classie.js"></script>
	<script type="text/javascript" src="assets/js/AnimOnScroll.js"></script>

	<script type="text/javascript" src="assets/plugins/scrolloverflow.js"></script>

	<script type="text/javascript" src="assets/plugins/jquery.fullPage.min.js"></script>
	<script src="https://cdn.rawgit.com/showdownjs/showdown/1.8.6/dist/showdown.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>


	<script type="text/javascript">
		infuseHTML = function(szElement, szUrl, szDiv) {

			if (typeof($("#" + szElement)[0]) == "undefined") {
				return;
			}
			$("#" + szElement).load(szUrl + ' #' + szDiv, function(response, status, xhr) {
				if (status == "error") {
					var msg = "Sorry but there was an error: ";
					$("#story").html(msg + xhr.status + "<br><br> '" + szUrl + "'<br><br> " + xhr.statusText);
				}
			});
		};

		var language = window.navigator.userLanguage || window.navigator.language;
		if (0 && language == "it-IT") {
			infuseHTML("tooltips", "./tooltips_it.html", "tooltips");
		} else {
			infuseHTML("tooltips", "./tooltips.html", "tooltips");
		}

		// --------------------------------
		// p a g e 
		// --------------------------------

		// enumerate sections, slides and theme
		// and create the right id's for fullpage slide handling
		// -----------------------------------------------------
		var section = 0;
		$(".section").each(function() {
			$(this).attr("id", "section" + (++section));
			var slide = 0;
			$(this).find(".slide").each(function() {
				$(this).attr("id", "section" + section + "slide" + (++slide));
				$(this).find(".theme").each(function() {
					$(this).attr("id", "theme_" + section + "" + slide);
				});
			});
		});

		// CUSTOM SCROLL SCRIPT FUNCTION FOR NAVBAR
		$(function() {
			$('.scrollclass a').bind('click', function(event) { //just pass scrollclass in design and start scrolling
				var $anchor = $(this);
				$('html, body').stop().animate({
					scrollTop: $($anchor.attr('href')).offset().top
				}, 1000, 'easeInOutQuad');
				event.preventDefault();
			});
		});
		//ADD REMOVE PADDING CLASS ON SCROLL
		$(window).scroll(function() {
			if ($(document).scrollTop() > 40) {
				$(".navbar-fixed-top").addClass("navbar-pad-original");
			} else {
				$(".navbar-fixed-top").removeClass("navbar-pad-original");
			}
		});

		var html = '<a href="javascript:$.fn.fullpage.moveSectionDown();"><div class="row scrollclass fp-controlArrow fp-down" style="left:' + (window.innerWidth / 2 - 33) + 'px;text-align:center;margin-top:-0.7em;margin-bottom:1em;"></div></a>';
		$('.down').append(html);

		var html = '<a href="javascript:$.fn.fullpage.moveSectionUp();"><div class="row scrollclass fp-controlArrow fp-up" style="left:' + (window.innerWidth / 2 - 33) + 'px;text-align:center;margin-top:-2.2em;margin-bottom:3em;margin-left:1em"></div></a>';
		$('.up').append(html);

		init_fullpage = function() {

			$('#fullpage').fullpage({
				'scrollOverflow': true,
				'scrollOverflowOptions': {
					scrollbars: false
				},
				'verticalCentered': false,
				'css3': true,
				//'sectionsColor': ['#888888', '#4A6F81', '#B14A4A'],
				'navigation': true,
				'navigationPosition': 'right',
				'navigationTooltips': ['Incidenti', 'Analisi temporali', 'Pericolosità', 'Natura del incidente', 'Attribuzioni'],

				'afterLoad': function(a, index, c, d) {
					__section = index;
					__slide = 0;
					$.fn.fullpage.silentMoveTo(index, __slide);
				},
				'afterSlideLoad': function(a, index, c, d) {
					__slide = d;
					__onChange();
				},

				'onLeave': function(index, nextIndex, direction) {}
			});
			$('#fullpage').fadeIn("slow");
		};

		/**************************************************************** 
		 *
		 * Config 
		 *
		 ****************************************************************/

		/**
		 * This is the Config class.  
		 * It realizes an object to configure and realize a map theme 
		 * @constructor
		 * @throws 
		 * @return A new Config object
		 */
		function Config(definition) {
			this.obj = null;
			this.szConfig = null;

			if (typeof(definition) == "string") {
				this.szConfig = definition;
				this.parse(definition);
			} else {
				this.obj = definition;
				//this.szConfig = JSON.stringify(definition);
			}
		}
		Config.prototype.parse = function(szConfigDef) {
			var szRaw = szConfigDef.replace(/\n\t+/g, '');
			try {
				this.obj = JSON.parse(szRaw);
			} catch (e) {
				ixmaps.parentApi.error("Code: " + e);
			}
		};
		Config.prototype.getString = function() {
			if (!this.szConfig) {
				this.szConfig = JSON.stringify(this.obj);
			}
			return this.szConfig;
		};
		Config.prototype.getObj = function() {
			if (!this.obj) {
				this.parse(definition);
			}
			return this.obj;
		};
		Config.prototype.getPrettyString = function() {
			this.szPrettyString = "";
			this.tab = 1;
			this.recurs = 0;
			this.formatObj(this.obj);
			return this.szPrettyString;
		};
		Config.prototype.isArray = function(obj) {
			return Object.prototype.toString.call(obj) === '[object Array]';
		};
		Config.prototype.formatObj = function(obj) {

			if (++this.recurs > 10) {
				return;
			}
			if (this.isArray(obj)) {

				this.szPrettyString += '[';
				var n = 0;
				for (var a in obj) {
					if (obj[a]) {
						if (typeof(obj[a]) == "object") {
							this.szPrettyString += (n ? ',' : '');
							this.tab++;
							this.formatObj(obj[a]);
							this.tab--;
						} else {
							this.szPrettyString += (n ? ',\n' : '\n') + (this.getIndent()) + '"' + String(obj[a]).replace(/\"/g, "\\\"") + '"';
						}
						n++;
					}
				}
				this.szPrettyString += ']';

			} else {

				this.szPrettyString += '{';

				var n = 0;
				for (var a in obj) {
					if (a == "parent" || a == "listItem" || a == "gOverlayObject" || a == "gOverlayObjectPartsA" || a == "setLine" || a == "setPolygon" || a == "setPosition") {
						continue;
					}
					if (obj[a] == null) {
						continue;
					}
					if (typeof(obj[a]) == "object") {
						this.szPrettyString += (n ? ',\n' : '\n') + (this.getIndent()) + '"' + a + '": ';
						this.tab++;
						this.formatObj(obj[a]);
						this.tab--;
						n++;
					} else {
						this.szPrettyString += (n ? ',\n' : '\n') + (this.getIndent()) + '"' + a + '": "' + String(obj[a]).replace(/\"/g, "\\\"") + '"';
						n++;
					}
				}
				this.szPrettyString += '\n' + (this.getIndent()) + '}';
			}

			this.recurs--;
		};
		Config.prototype.getIndent = function() {
			var szTab = "";
			for (var i = 0; i < this.tab; i++) {
				szTab += "\t";
			}
			return szTab;
		};

		$(document).ready(function() {

			var __section = null;
			var __slide = null;
			var __fMoveActive = false;

			var __onChange = function() {

				if (!ixmaps.initialized) {
					return;
				}
				if (ixmaps.fMoveToSection) {
					ixmaps.fMoveToSection = false;
					return;
				}
				__doTheme("theme_" + __section + (__slide + 1));
			};

			$('#fullpage').fullpage({
				'scrollOverflow': true,
				'scrollOverflowOptions': {
					scrollbars: false
				},
				'verticalCentered': false,
				'css3': true,
				//'sectionsColor': ['#888888', '#4A6F81', '#B14A4A'],
				'navigation': true,
				'navigationPosition': 'right',
				'navigationTooltips': ['Incidenti', 'Analisi temporali', 'Pericolosità', 'Natura del incidente', 'Attribuzioni'],

				'afterLoad': function(a, index, c, d) {
					__section = index;
					__slide = 0;
					$.fn.fullpage.silentMoveTo(index, __slide);
				},
				'afterSlideLoad': function(a, index, c, d) {
					__slide = d;
					__onChange();
				},

				'onLeave': function(index, nextIndex, direction) {}
			});
			$('#fullpage').fadeIn("slow");
		});

		__doThemeOldTheme = null;
		__doThemeTimeout = null;
		__doTheme = function(szName) {
			if (szName == __doThemeOldTheme) {
				return;
			}
			__doThemeOldTheme = szName;
			if (__doThemeTimeout) {
				clearTimeout(__doThemeTimeout);
			}
			__doThemeTimeout = setTimeout("__doThemeOnTimeout('" + szName + "')", 100);
		}
		__doThemeOnTimeout = function(szName) {
			$("#" + szName).click();
			eval($("#" + szName).attr("href"));
		}

		// ------------------------------
		// set resize handler
		// ------------------------------
		$(window).resize(function() {
			// refresh scrollspy !!!
			$('[data-spy="scroll"]').each(function() {
				var $spy = $(this).scrollspy('refresh')
			});
		});

		var ixmaps = null;
		if (window.opener) {
			ixmaps = window.opener.ixmaps;
		} else
		if (parent) {
			ixmaps = parent.window.ixmaps;
		} else {
			alert("error: missing parent window for themes !");
		}

		ixmaps.initialized = false;

		// don't synchronise multiple map frames
		ixmaps.setSyncMultiMaps(false);

		var nLegendDiv = 0;
		var legendA = Array(0);
		ixmaps.setLegendDiv = function(n) {
			nLegendDiv = n;
		};

		ixmaps.setLoading = function() {
			ixmaps.showLoading("... caricando ...");
		};

		// ------------------------------
		// if map ready, make first theme
		// ------------------------------
		ixmaps.myMapReady = function(map) {

			ixmaps.initialized = true;

			// define some helper for the sidebar menu

			ixmaps.moveSectionsDown = function(nr) {
				nr = nr || 1;
				for (var i = 0; i < nr; i++) {
					setTimeout("$.fn.fullpage.moveSectionDown();", i * 100);
				}
			};

			ixmaps.moveToSection = function(nr, slide) {
				ixmaps.fMoveToSection = true;
				$.fn.fullpage.silentMoveTo(nr, slide);
			};

			ixmaps.moveSlideRight = function(nr) {
				nr = nr || 1;
				for (var i = 0; i < nr; i++) {
					setTimeout("$.fn.fullpage.moveSlideRight();", i * 100);
				}
			};
		};

		ixmaps.htmlgui_onItemClick = function(szId) {

			console.log(szId);

			if (szId.match(/theme/)) {
				var data = ixmaps.getData('map', szId);
				var szTitle = data.title;
				ixmaps.szMapItemId = szId;
				ixmaps.loadStoryTool('./item.html');
				return true;
			} else {
				if (szId.match(/mapbackground/)) {
					ixmaps.hideStoryTool();
					return false;
				}
				ixmaps.szMapItemId = szId;
				ixmaps.loadStoryTool('./item.html');
				//ixmaps.embeddedSVG.window.map.Api.highlightItem(szId);
				return true;
			}
			return false;
		};


		// --------------------------------------------------------------
		// define click extension to
		// check/highlight the theme button 
		// --------------------------------------------------------------

		// array to store the clicked objects for onRemoveTheme callback
		var clickA = new Array(0);

		// store the last clicked object for onNewTheme callback
		var lastClicked = null;
		$("a").click(function() {
			if (String($(this).attr("href")).match(/newtheme/i)) {
				lastClicked = $(this);
			}
		});

		// -----------------------------------
		// adapt legend background to map type
		// -----------------------------------

		/**
		 * set legend background on map type change
		 * @type void
		 */
		__changeCss = function(className, classValue) {

			var cssMainContainer = $('#css-modifier-container');
			if (cssMainContainer.length == 0) {
				var cssMainContainer = $('<style id="css-modifier-container"></style>');
				cssMainContainer.appendTo($('head'));
			}
			cssMainContainer.append(className + " {" + classValue + "}\n");
		};

		ixmaps.htmlgui_setMapTypeBG = function(szId) {
			return true;

			$("#css-modifier-container").remove();

			if (szId.match(/dark/i) || szId.match(/black/i)) {
				$(".story-body").css("color", "#888");
				__changeCss(".story-body", "background-color:rgba(0,0,0,1)");
				__changeCss(".inline-legend", "background-color:rgba(25,25,25,0.7)");
				__changeCss(".title", "background-color:rgba(25,25,25,0.7)");
			} else {
				__changeCss(".body-story", "background-color:rgba(255,255,255,1)");
				__changeCss(".inline-legend", "background-color:rgba(255,255,255,0.5)");
				__changeCss(".title", "background-color:rgba(255,255,255,0.5)");
			}
		};

		__hideTimeout = null;
		showTooltip = function(evt, text) {
			console.log(evt);
			setTimeout("doShowTooltip(" + evt.pageX + "," + (evt.target.offsetTop) + ",'" + text + "')", 250);
		}
		doShowTooltip = function(x, y, text) {
			if (text && text.length) {
				
				var html = $("#t_" + text.replace(/"/g, ""));
				
				$(".tooltip").each(function(i,val){
					var szId = $(val).attr('id').split("_").pop();
					if (szId == text.replace(/"/g, "")){
							html = $(val);
					}
				});


				if (html[0]) {
					text = html.html();
				}
				var tooltip = document.getElementById("tooltip");
				var sidebar = document.getElementById("sidebar");
				tooltip.innerHTML = text;
				tooltip.style.display = "block";
				tooltip.style.left = x + 15 + 'px';
				tooltip.style.top = y + 5 + 'px';
				tooltip.setAttribute("onMouseOver", "clearTimeout(__hideTimeout)");
				tooltip.setAttribute("onMouseOut", "hideTooltip()");
			}
		}

		hideTooltip = function() {
			__hideTimeout = setTimeout("doHideTooltip()", 250);
		}
		doHideTooltip = function() {
			var tooltip = document.getElementById("tooltip");
			tooltip.style.display = "none";
		}

		__showProjectString = function(szProject, n, all) {
			
			// make object to handle project definition and get string or json from it
			// 
			var project = new Config(szProject);
			
			// get JSON and formatted string
			//
 			szProject = project.getPrettyString();
			project   = project.obj;
			
			// make the HTML

			$("#title").html(project.themes[0].style.title);
			$("#count").html(n + "/" + all);

			var list = "";
			var id = "source";

			list += '<h2><span style="color:#ddd">#</span> ' + 'project ' + '<a href="javascript:ixmaps.loadStoryTool(\'../../../../ui/html/tools/project_editor.html\',{frame:true})"> [edit]</a><a href="javascript:ixmaps.loadStoryTool(\'../../../../ui/html/tools/theme_configurator.html\',{frame:true})"> [config]</a></h2>';

			list += '<div class="source" >';
			list += '<pre id="' + id + '" class="prettyprint">';
			list += '</pre>';
			list += '</div>';

			$("#filelist").append(list);

			$("#" + id + "").text(String(szProject));
			hljs.highlightBlock($("#" + id)[0]);

			$(".hljs-attr").attr("onMouseOver", "showTooltip(event,$(this).text())");
			$(".hljs-attr").attr("onMouseOut", "hideTooltip()");
			
			for ( i in project.themes ){
				if (project.themes[i].style.dbtableExt) {

					$("#filelist").append("<p style='margin-left:1em;margin-right:-2em'>with:</p>");

					$("#filelist").append("<p style='margin-left:2em;margin-right:-2em'><code>"+
									"\"dbtable\":\""+project.themes[i].style.dbtable+"\"</br>"+
									"\"dbtableType\":\""+project.themes[i].style.dbtableType+"\"</br>"+
									"\"dbtableExt\":\""+project.themes[i].style.dbtableExt+"\"</br>");
					$("#filelist").append("</code></p>");

					$("#filelist").append("<p style='margin-left:1em;margin-right:-2em'>The project refers to the <b>data provider function:</b>");
					$("#filelist").append("<p style='margin-left:2em;margin-right:-2em'>ixmaps.<b><span style='background-color:yellow'>"+project.themes[i].style.dbtable+"</span></b></p>");

					$("#filelist").append("<p style='margin-left:1em;margin-right:-2em'><b>defined</b> in the following <b>JavaScript file</b> and marked in <span style='background-color:yellow'>yellow</span>:</p>");

					__showFile((project.themes[i].style.dbtableExt.match(/http/) ? "" : "../../") + project.themes[i].style.dbtableExt,project.themes[i].style.dbtable);
				}
			}

		};

		__showProject = function(szUrl, n, all) {

			$.ajax({
					// The URL for the request
					url: szUrl,

					// The data to send (will be converted to a query string)
					data: {
						id: 123
					},

					// Whether this is a POST or GET request
					type: "GET",

					// The type of data we expect back
					dataType: "text",
				})
				// Code to run if the request succeeds (is done);
				// The response is passed to the function
				.done(function(result) {

					__showProjectString(result, n, all);

				});
		};

		__showMD = function(szUrl) {
			
			$.ajax({
					// The URL for the request
					url: szUrl,

					// The data to send (will be converted to a query string)
					data: {
						id: 123
					},

					// Whether this is a POST or GET request
					type: "GET",

					// The type of data we expect back
					dataType: "text",
				})
				// Code to run if the request succeeds (is done);
				// The response is passed to the function
				.done(function(result) {

					var converter = new showdown.Converter();
					var mdhtml = converter.makeHtml(result);

					var szHtml = "<div style='margin-left:11px;margin-right:-2em'>" + mdhtml + "</div>";;
					$("#filelist").append(szHtml);

					$("pre code").each(function() {
						hljs.highlightBlock(this);
					});

					// Table Of Content
					// ----------------
					$("p").each(function() {
						if ($(this).text() == "[TOC]") {
							console.log($(this).text())
							var toc = "<ol style='margin-top:-1em;margin-bottom:2em'>";
							$("h3").each(function() {
								if ($(this).attr("id") && $(this).text()) {
									toc += "<li>" + $(this).text() + "</li>";
								}
							});
							toc += "</ol>";
							$(this).html(toc);
						}
					});
					__showProject(szUrl.split(".md")[0] + ".json", 1, 1);
				})
				.error(function(result) {
					__showProject(szUrl.split(".md")[0] + ".json", 1, 1);
				});

		};

		__showFile = function(szUrl,szTitle) {
			$.ajax({
					// The URL for the request
					url: szUrl,

					// The data to send (will be converted to a query string)
					data: {
						id: 123
					},

					// Whether this is a POST or GET request
					type: "GET",

					// The type of data we expect back
					dataType: "text",
				})
				// Code to run if the request succeeds (is done);
				// The response is passed to the function
				.done(function(result) {

					var list = "";
					var id = "source1";

					list += '<h5><span style="color:#ddd">#&nbsp;</span><a href="' + szUrl + '" target="_blank">' + szUrl + '</a></h5>';
					//list += '<h2><span style="color:#ddd">#</span> ' + (szTitle||'script') + '</h2>';
					list += '<div class="source" >';
					list += '<pre id="' + id + '" class="prettyprint">';
					list += '</pre>';
					list += '</div>';

					$("#filelist").append(list);

					$("#" + id + "").text(String(result));
					hljs.highlightBlock($("#" + id)[0]);
				
					highlightSearch(id,szTitle);					

				});
		};

		$("#filelist").html("");


		setTimeout('$("#filelist").css("height","100%")', 1000);
		
		
		// load themes script
		// and initialize map if all loaded
		//
		$.when(
			$.getScript("./index.js"),
			$.getScript("./inline_legend.js"),
			$.getScript("../../../../ui/js/tools/layer_legend.js"),
			$.Deferred(function(deferred) {
				$(deferred.resolve);
			})
		).done(function() {
			ixmaps.initialized = true;
			// detect project or bookmark to execute
			//
			var szProject = ixmaps.parentApi.project || 
							ixmaps.parentApi.parentApi.project || 
							null;

			var szBookmark = ixmaps.parentApi.bookmark ||
							 ixmaps.parentApi.embeddedApi.bookmark ||
							 ixmaps.parentApi.embeddedApi.embeddedApi.bookmark ||
							 null;

			// show or hide project selection 
			//
			if ( szProject || szBookmark ) {
				$("#loadProject").hide();
				$("#legend").hide();
				$("#loadProjectButton").show();
			}else{
				$("#loadProject").fadeIn("slow");
			}
			
			// adapt iframe height in parent
			// ----------------------------------------------------------------------
			ixmaps.resizeStoryFrame = function() {
				var the_height = window.parent.window.document.getElementById('embed-story').contentWindow.document.body.scrollHeight;
				if (the_height > 100) {
					window.parent.window.document.getElementById('story-board').style.height = the_height + "px";
				}
			};

			ixmaps.legend.maxwidth = window.innerWidth - 20;

			ixmaps.htmlgui_setMapTypeBG(ixmaps.getMapTypeId());
			/*
			 * listen on Zoom and Pan  
			 * to make the mapo layer legend 
			 */
			ixmaps.htmlgui_onZoomAndPan = function(nZoom) {
				ixmaps.viewer_makeLayerLegend();
				ixmaps.resizeStoryFrame();
			};

			// GR 09.01.2019 trigger change on story (body) to adapt iframe height in parent
			// ----------------------------------------------------------------------
			var myElement = $("body")[0];
			if (window.addEventListener) {
				// Normal browsers
				myElement.addEventListener('DOMSubtreeModified', ixmaps.resizeStoryFrame, false);
			} else
			if (window.attachEvent) {
				// IE
				myElement.attachEvent('DOMSubtreeModified', ixmaps.resizeStoryFrame);
			}
			
			// execute project, if defined in URL (?project=...)
			// ----------------------------------------------------------------------
			if ( szProject ){
				ixmaps.loadProject("map",szProject.replace("layout","xlayout"));
				if (decodeURIComponent(szProject).match(/{/)){
					__showProjectString(decodeURIComponent(szProject), 1, 1);
				}else{
					if (szProject.match(/http/)){
						__showMD(szProject.split(".json")[0] + ".md");
						//__showProject((szProject), 1, 1);
					}else{
						__showProject(("../../"+szProject), 1, 1);
					}
				}
			}
			//__showMD("../../" + (ixmaps.parentApi.project.split(".json")[0] + ".md"));

		}).fail(function() {
			alert("script loading " + arguments[2].toString());
		});
		
		
		function highlightSearch(szTextId,szSearch) { 
			var e = document.getElementById(szTextId).innerHTML;
			var x = e.split(szSearch);
			e = x.join("<span style='background-color:yellow'>"+szSearch+"</span>");
			document.getElementById(szTextId).innerHTML = e;
		}		
		

	</script>

	<script src="filedrag.js"></script>

	<script>
		ixmaps.loadExample = function(file) {
			alert(file);
		}

	</script>


</body>

</html>
